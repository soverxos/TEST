============================== PROJECT STRUCTURE ==============================
TEST/
    ‚îú‚îÄ‚îÄ .git/ [EXCLUDED_DIR]
    ‚îú‚îÄ‚îÄ .github/
    ‚îÇ       ‚îî‚îÄ‚îÄ workflows/
    ‚îÇ               ‚îú‚îÄ‚îÄ ci.yml
    ‚îÇ               ‚îî‚îÄ‚îÄ docker.yml
    ‚îú‚îÄ‚îÄ .venv/ [EXCLUDED_DIR]
    ‚îú‚îÄ‚îÄ config/
    ‚îÇ       ‚îú‚îÄ‚îÄ cloud_password_7847397229.txt
    ‚îÇ       ‚îî‚îÄ‚îÄ security_keys.json
    ‚îú‚îÄ‚îÄ Data/
    ‚îÇ       ‚îú‚îÄ‚îÄ Config/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ modules_settings/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ai_chat.yaml
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ broadcast.yaml
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ universal_template.yaml
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ core_settings.yaml
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ enabled_modules.json
    ‚îÇ       ‚îú‚îÄ‚îÄ Database_files/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sdb_clean_test.db [EXCLUDED_FILE]
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ swiftdevbot.db [EXCLUDED_FILE]
    ‚îÇ       ‚îú‚îÄ‚îÄ Logs/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ 2025/
    ‚îÇ       ‚îÇ               ‚îî‚îÄ‚îÄ 11-November/
    ‚îÇ       ‚îÇ                       ‚îî‚îÄ‚îÄ 20/
    ‚îÇ       ‚îÇ                               ‚îú‚îÄ‚îÄ 16_sdb.log [EXCLUDED_FILE]
    ‚îÇ       ‚îÇ                               ‚îú‚îÄ‚îÄ 18_sdb.log [EXCLUDED_FILE]
    ‚îÇ       ‚îÇ                               ‚îî‚îÄ‚îÄ 19_sdb.log [EXCLUDED_FILE]
    ‚îÇ       ‚îî‚îÄ‚îÄ Security/
    ‚îÇ               ‚îú‚îÄ‚îÄ anomaly_detection/
    ‚îÇ               ‚îú‚îÄ‚îÄ audit_logs/
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ audit_2025-11-20.jsonl
    ‚îÇ               ‚îú‚îÄ‚îÄ crypto_keys/
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ .master_password
    ‚îÇ               ‚îú‚îÄ‚îÄ jwt_keys/
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ jwt_private_key.pem
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ jwt_public_key.pem
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ jwt_secret.key
    ‚îÇ               ‚îú‚îÄ‚îÄ levels/
    ‚îÇ               ‚îú‚îÄ‚îÄ reputation/
    ‚îÇ               ‚îú‚îÄ‚îÄ sandbox/
    ‚îÇ               ‚îú‚îÄ‚îÄ signatures/
    ‚îÇ               ‚îî‚îÄ‚îÄ trusted_keys/
    ‚îÇ                       ‚îî‚îÄ‚îÄ trusted_signers.json
    ‚îú‚îÄ‚îÄ Modules/ [EXCLUDED_DIR]
    ‚îú‚îÄ‚îÄ Scripts/
    ‚îÇ       ‚îú‚îÄ‚îÄ clean_cache.py
    ‚îÇ       ‚îî‚îÄ‚îÄ snapshot_generator.py
    ‚îú‚îÄ‚îÄ Systems/
    ‚îÇ       ‚îú‚îÄ‚îÄ cli/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ api.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ backup.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ bot.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ cache.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ config.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ db.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ dev.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ module.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ monitor.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ notifications.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ process.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ run.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ security.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ system.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ tasks.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ user.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ utils.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ web.py
    ‚îÇ       ‚îú‚îÄ‚îÄ core/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ admin/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ entry/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ handlers_entry.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ logs_viewer/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_logs.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ keyboards_logs.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_modules.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ modules_mgmt/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_modules.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_modules.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ roles/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_crud_fsm.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_details.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_list.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_role_perms.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_roles.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sys_info/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_sys_info.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_sys_info.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ users/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_details.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_direct_perms.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_list.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_roles_assign.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_users.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ filters_admin.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_log_viewer.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_module_management.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_admin_common.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ cache/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ strategies.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ database/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ base.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ core_models.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ db_utils.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ errors/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ handler.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ events/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ dispatcher.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ http_client/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ retry.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ i18n/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ middleware.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ translator.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ logging/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ structured.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ module_loader/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ migrations.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ monitoring/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ health.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ metrics.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ rbac/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ service.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ schemas/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ module_manifest.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ security/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ anomaly_detection.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ audit_logger.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ code_scanner.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ crypto_manager.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ input_validator.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ rate_limiter.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ reputation_system.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sandbox_manager.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ security_levels.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ signature_manager.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sys_modules/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ui/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ callback_data_factories.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_core_ui.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ keyboards_core.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ navigation_core.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ registry_ui.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ users/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ middleware.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ service.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ app_settings.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ bot_entrypoint.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ logging_manager.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ module_loader.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ services_provider.py
    ‚îÇ       ‚îú‚îÄ‚îÄ locales/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ en.yaml
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ru.yaml
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ua.yaml
    ‚îÇ       ‚îú‚îÄ‚îÄ migration/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ versions/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ d10040ec2cb7_initial_migration_for_core_tables.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ env.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ script.py.mako
    ‚îÇ       ‚îî‚îÄ‚îÄ web/
    ‚îÇ               ‚îú‚îÄ‚îÄ auth/
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ jwt_handler.py
    ‚îÇ               ‚îú‚îÄ‚îÄ dist/ [EXCLUDED_DIR]
    ‚îÇ               ‚îú‚îÄ‚îÄ node_modules/ [EXCLUDED_DIR]
    ‚îÇ               ‚îú‚îÄ‚îÄ src/
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ components/
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sections/
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Config.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Docs.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Home.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Logs.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Modules.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Monitoring.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Services.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Settings.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Statistics.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ Users.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ui/
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ GlassButton.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ GlassCard.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ GlassInput.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ AnimatedBackground.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Header.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ Sidebar.tsx
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ contexts/
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ AuthContext.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ThemeContext.tsx
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ lib/
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ pages/
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ CloudPasswordPrompt.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ CloudPasswordSetup.tsx
    ‚îÇ               ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ Dashboard.tsx
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ api.ts
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ App.tsx
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ index.css
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ main.tsx
    ‚îÇ               ‚îÇ       ‚îú‚îÄ‚îÄ package.json
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ vite-env.d.ts
    ‚îÇ               ‚îú‚îÄ‚îÄ supabasex/
    ‚îÇ               ‚îÇ       ‚îî‚îÄ‚îÄ migrations/
    ‚îÇ               ‚îÇ               ‚îî‚îÄ‚îÄ 20251104203347_create_swiftdevbot_schema.sql
    ‚îÇ               ‚îú‚îÄ‚îÄ .gitignore
    ‚îÇ               ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ               ‚îú‚îÄ‚îÄ app.py
    ‚îÇ               ‚îú‚îÄ‚îÄ eslint.config.js
    ‚îÇ               ‚îú‚îÄ‚îÄ index.html
    ‚îÇ               ‚îú‚îÄ‚îÄ package-lock.json
    ‚îÇ               ‚îú‚îÄ‚îÄ package.json
    ‚îÇ               ‚îú‚îÄ‚îÄ postcss.config.js
    ‚îÇ               ‚îú‚îÄ‚îÄ README.md
    ‚îÇ               ‚îú‚îÄ‚îÄ tailwind.config.js
    ‚îÇ               ‚îú‚îÄ‚îÄ tsconfig.app.json
    ‚îÇ               ‚îú‚îÄ‚îÄ tsconfig.json
    ‚îÇ               ‚îú‚îÄ‚îÄ tsconfig.node.json
    ‚îÇ               ‚îî‚îÄ‚îÄ vite.config.ts
    ‚îú‚îÄ‚îÄ tests/
    ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îú‚îÄ‚îÄ conftest.py
    ‚îÇ       ‚îú‚îÄ‚îÄ test_error_handler.py
    ‚îÇ       ‚îú‚îÄ‚îÄ test_health.py
    ‚îÇ       ‚îú‚îÄ‚îÄ test_input_validator.py
    ‚îÇ       ‚îú‚îÄ‚îÄ test_metrics.py
    ‚îÇ       ‚îî‚îÄ‚îÄ test_rate_limiter.py
    ‚îú‚îÄ‚îÄ .dockerignore
    ‚îú‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ .gitignore
    ‚îú‚îÄ‚îÄ alembic.ini
    ‚îú‚îÄ‚îÄ commit
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ env.example
    ‚îú‚îÄ‚îÄ Makefile
    ‚îú‚îÄ‚îÄ prometheus.yml
    ‚îú‚îÄ‚îÄ pytest.ini
    ‚îú‚îÄ‚îÄ README.md
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îú‚îÄ‚îÄ run_bot.py
    ‚îú‚îÄ‚îÄ sdb
    ‚îú‚îÄ‚îÄ sdb.py
    ‚îî‚îÄ‚îÄ sdb_setup.py

======================================================================

------------------------------ FILE: commit ------------------------------



======================================================================

------------------------------ FILE: sdb_setup.py ------------------------------
#!/usr/bin/env python3
"""
SwiftDevBot Setup Wizard
–ú–∞—Å—Ç–µ—Ä –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SwiftDevBot
"""

import sys
import os
import venv
import subprocess
import yaml
from pathlib import Path

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT = Path(__file__).resolve().parent
VENV_PATH = PROJECT_ROOT / ".venv"

def create_and_activate_venv():
    """–°–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –µ–≥–æ"""
    if not VENV_PATH.exists():
        print("\n‚ö†Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")
        print("\nüöÄ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...")
        venv.create(VENV_PATH, with_pip=True)
        print(f"‚úì –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –≤ {VENV_PATH}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä—É Python –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
    if sys.platform == "win32":
        python_path = VENV_PATH / "Scripts" / "python.exe"
        pip_path = VENV_PATH / "Scripts" / "pip.exe"
    else:
        python_path = VENV_PATH / "bin" / "python"
        pip_path = VENV_PATH / "bin" / "pip"
        
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if not hasattr(sys, 'real_prefix') and not (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
        print("\nüîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞...")
        os.environ["VIRTUAL_ENV"] = str(VENV_PATH)
        os.environ["PATH"] = str(VENV_PATH / "bin") + os.pathsep + os.environ["PATH"]
        os.execv(str(python_path), [str(python_path), __file__])

def install_dependencies():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"""
    print("\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...")
    pip_cmd = str(VENV_PATH / "bin" / "pip") if sys.platform != "win32" else str(VENV_PATH / "Scripts" / "pip.exe")
    requirements_file = PROJECT_ROOT / "requirements.txt"
    
    try:
        subprocess.run([pip_cmd, "install", "-r", str(requirements_file)], check=True)
        print("‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: {e}")
        return False

def validate_bot_token(token: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞"""
    import re
    pattern = r'^\d+:[\w-]{35}$'
    return bool(re.match(pattern, token))

def get_admin_id(prompt_text: str) -> int:
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    while True:
        try:
            admin_id = int(input(prompt_text))
            if admin_id > 0:
                return admin_id
            print("‚ùå ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        except ValueError:
            print("‚ùå ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")

def setup_database():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    print("\nüóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
    db_types = {
        "1": "sqlite",
        "2": "postgresql",
        "3": "mysql"
    }
    
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö:")
    print("1. SQLite (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)")
    print("2. PostgreSQL")
    print("3. MySQL")
    
    while True:
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [1-3] (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1): ").strip() or "1"
        if choice in db_types:
            db_type = db_types[choice]
            break
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ 1, 2 –∏–ª–∏ 3")
    
    if db_type == "sqlite":
        return {
            "type": "sqlite",
            "url": "sqlite+aiosqlite:///Data/Database_files/sdb.db"
        }
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ë–î
    config = {"type": db_type}
    config["host"] = input("–•–æ—Å—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: localhost): ").strip() or "localhost"
    config["port"] = input(f"–ü–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {5432 if db_type == 'postgresql' else 3306}): ").strip()
    config["port"] = int(config["port"]) if config["port"].isdigit() else (5432 if db_type == 'postgresql' else 3306)
    config["database"] = input("–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ").strip()
    config["user"] = input("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ").strip()
    config["password"] = input("–ü–∞—Ä–æ–ª—å: ").strip()
    
    return config

def setup_cache():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("\nüíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print("1. Memory (–≤ –ø–∞–º—è—Ç–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)")
    print("2. Redis")
    
    while True:
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è [1-2] (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1): ").strip() or "1"
        if choice == "1":
            return {
                "type": "memory",
                "ttl": 3600  # 1 —á–∞—Å
            }
        elif choice == "2":
            config = {
                "type": "redis",
                "ttl": 3600  # 1 —á–∞—Å
            }
            config["host"] = input("Redis —Ö–æ—Å—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: localhost): ").strip() or "localhost"
            config["port"] = int(input("Redis –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6379): ").strip() or "6379")
            config["db"] = int(input("Redis –Ω–æ–º–µ—Ä –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0): ").strip() or "0")
            return config
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ 1 –∏–ª–∏ 2")

def create_env_file(bot_token: str, admin_id: int, db_config: dict, cache_config: dict):
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª .env —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
    # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥
    env_content = [
        "# --- Telegram Bot ---",
        f"BOT_TOKEN={bot_token}",
        f'SDB_CORE_SUPER_ADMINS="{admin_id}"', # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        "",
        "# --- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö ---"
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
    env_content.append(f'SDB_DB_TYPE="{db_config["type"]}"')
    if db_config["type"] == "sqlite":
        # –î–ª—è SQLite –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç Data
        sqlite_relative_path = "Database_files/swiftdevbot.db"
        env_content.append(f'SDB_DB_SQLITE_PATH="{sqlite_relative_path}"')
    else:
        # –î–ª—è PostgreSQL –∏ MySQL —Ñ–æ—Ä–º–∏—Ä—É–µ–º DSN
        driver = "psycopg" if db_config["type"] == "postgresql" else "aiomysql"
        db_url = f"{db_config['type']}+{driver}://{db_config['user']}:{db_config['password']}@"
        db_url += f"{db_config['host']}:{db_config['port']}/{db_config['database']}"
        if db_config["type"] == "mysql":
            db_url += "?charset=utf8mb4"
        
        dsn_var_name = "SDB_DB_PG_DSN" if db_config["type"] == "postgresql" else "SDB_DB_MYSQL_DSN"
        env_content.append(f'{dsn_var_name}="{db_url}"')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞
    env_content.extend([
        "",
        "# --- –ö—ç—à ---",
        f'SDB_CACHE_TYPE="{cache_config["type"]}"'
    ])
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –î–õ–Ø REDIS
    if cache_config["type"] == "redis":
        redis_url = f"redis://{cache_config['host']}:{cache_config['port']}/{cache_config['db']}"
        env_content.append(f'SDB_CACHE_REDIS_URL="{redis_url}"')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    env_content.extend([
        "",
        "# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞ (Core) ---",
        "# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ./Data)",
        "# SDB_CORE_PROJECT_DATA_PATH=\"./Data\"",
        "",
        "# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ø–¥—Ä–∞ ---",
        'SDB_CORE_LOG_LEVEL="INFO"'
    ])
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
    env_file_path = PROJECT_ROOT / ".env"
    with open(env_file_path, "w", encoding="utf-8") as f:
        f.write("\n".join(env_content))
    print(f"‚úì –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω: {env_file_path}")

def _convert_to_serializable(data):
    """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç—ã –≤ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–µ —Ç–∏–ø—ã –¥–ª—è YAML."""
    from pathlib import Path
    
    if isinstance(data, dict):
        return {key: _convert_to_serializable(value) for key, value in data.items()}
    elif isinstance(data, list):
        return [_convert_to_serializable(item) for item in data]
    elif isinstance(data, Path):
        return str(data)
    elif hasattr(data, "__class__") and data.__class__.__name__ in ("HttpUrl", "Url"):
        return str(data)
    else:
        return data

def create_core_settings_file():
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª core_settings.yaml —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    print("\nüìù –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ core_settings.yaml...")
    
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º Systems –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
        sys.path.insert(0, str(PROJECT_ROOT))
        sys.path.insert(0, str(PROJECT_ROOT / "Systems"))
        
        from Systems.core.app_settings import AppSettings
        
        # –°–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        default_settings = AppSettings(telegram={"token": "dummy"}).model_dump(exclude_defaults=False)
        
        # –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env
        if "telegram" in default_settings:
            del default_settings["telegram"]
        if "db" in default_settings:
            del default_settings["db"]
        if "core" in default_settings and "super_admins" in default_settings["core"]:
            del default_settings["core"]["super_admins"]
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–µ —Ç–∏–ø—ã
        serializable_data = _convert_to_serializable(default_settings)
        
        # –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        config_file_path = PROJECT_ROOT / "Data" / "Config" / "core_settings.yaml"
        config_file_path.parent.mkdir(parents=True, exist_ok=True)
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º YAML —Ñ–∞–π–ª
        with open(config_file_path, "w", encoding="utf-8") as f:
            yaml.dump(serializable_data, f, indent=2, sort_keys=False, allow_unicode=True)
        
        print(f"‚úì –§–∞–π–ª core_settings.yaml —Å–æ–∑–¥–∞–Ω: {config_file_path}")
        return True
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å core_settings.yaml: {e}")
        print("   –§–∞–π–ª –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω - —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –∏ .env")
        return False

def create_project_structure():
    """–°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞"""
    print("\nüìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞...")
    directories = [
        "Data/Config",
        "Data/Database_files",
        "Data/Logs",
        "Modules"
    ]
    
    for directory in directories:
        Path(PROJECT_ROOT / directory).mkdir(parents=True, exist_ok=True)
    print("‚úì –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞")

def initialize_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    print("\nüóÉÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    try:
        import alembic.config  # type: ignore[import-untyped]
        alembic_args = [
            '--raiseerr',
            'upgrade', 'head'
        ]
        alembic.config.main(argv=alembic_args)
        print("‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
    print("üöÄ –ú–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SwiftDevBot\n")
    
    try:
        # –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        create_and_activate_venv()
        
        # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        if not install_dependencies():
            sys.exit(1)
        
        # –®–∞–≥ 3: –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ –∏ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        while True:
            bot_token = input("\n–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @BotFather): ")
            if validate_bot_token(bot_token):
                break
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –ü—Ä–∏–º–µ—Ä: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz")
        
        admin_id = get_admin_id("\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID (–ø–æ–ª—É—á–∏—Ç—å —É @userinfobot): ")
        
        # –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
        create_project_structure()
        
        # –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        db_config = setup_database()
        
        # –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        cache_config = setup_cache()
        
        # –®–∞–≥ 7: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        create_env_file(bot_token, admin_id, db_config, cache_config)
        
        # –®–∞–≥ 8: –°–æ–∑–¥–∞–Ω–∏–µ core_settings.yaml
        create_core_settings_file()
        
        # –®–∞–≥ 9: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if not initialize_database():
            if input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫–∏? [y/N]: ").lower() != 'y':
                sys.exit(1)
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        print("""
‚ú® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SwiftDevBot –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ‚ú®

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º:
1. –ó–∞–ø—É—Å–∫:    ./sdb start
2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./sdb stop
3. –°—Ç–∞—Ç—É—Å:    ./sdb status

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- ./sdb --help   # –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- ./sdb db       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- ./sdb module   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏
- ./sdb config   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- ./sdb backup   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏

–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –≤ Telegram:
/start  - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
/help   - –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
/admin  - –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://github.com/soverxos/SwiftDevBot-Project/blob/main/README.md
""")
        
    except KeyboardInterrupt:
        print("\n\n‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(1)
    except Exception as e:
        print(f"\n\n‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()


======================================================================

------------------------------ FILE: run_bot.py ------------------------------
# run_bot.py
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Telegram-–±–æ—Ç–∞ SwiftDevBot.

import asyncio
import sys
from pathlib import Path
import os

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sys.path –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ 'core' –∏ –¥—Ä—É–≥–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ ---
current_script_dir = Path(__file__).resolve().parent
systems_path = current_script_dir / "Systems"
if str(current_script_dir) not in sys.path:
    sys.path.insert(0, str(current_script_dir))
if str(systems_path) not in sys.path:
    sys.path.insert(0, str(systems_path))

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏–∑ —è–¥—Ä–∞
try:
    from Systems.core.bot_entrypoint import run_sdb_bot 
except ImportError as e:
    print(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ 'core.bot_entrypoint'.", file=sys.stderr)
    print(f"–û—à–∏–±–∫–∞: {e}", file=sys.stderr)
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤–µ—Ä–Ω–∞ –∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —è–¥—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.", file=sys.stderr)
    print(f"–¢–µ–∫—É—â–∏–π sys.path: {sys.path}", file=sys.stderr)
    sys.exit(2)

if __name__ == "__main__":
    exit_code: int = 1 

    try:
        exit_code = asyncio.run(run_sdb_bot())
        
        if exit_code == 0:
            if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
                print("üéØ SDB Core - –°–∏—Å—Ç–µ–º–∞ —à—Ç–∞—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        else:
            if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
                print(f"‚ùå SDB Core - –°–∏—Å—Ç–µ–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: {exit_code})", file=sys.stderr)

    except KeyboardInterrupt:
        if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
            print("\nüîÑ SDB Core - –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C). –í—ã—Ö–æ–¥...", file=sys.stderr)
        exit_code = 0 
    except ImportError as e_runtime_import:
        print(f"–û–®–ò–ë–ö–ê –ò–ú–ü–û–†–¢–ê –í–û –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø: {e_runtime_import}", file=sys.stderr)
        print("–í–æ–∑–º–æ–∂–Ω–æ, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.", file=sys.stderr)
        exit_code = 3
    except Exception as e_global:
        print(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ï–û–ë–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê –ù–ê –í–ï–†–•–ù–ï–ú –£–†–û–í–ù–ï: {type(e_global).__name__}: {e_global}", file=sys.stderr)
        print("–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–±–µ–∫–∞ –æ—à–∏–±–∫–∏.", file=sys.stderr)
        exit_code = 1
    finally:
        pass

    sys.exit(exit_code)


======================================================================

------------------------------ FILE: pytest.ini ------------------------------
[pytest]
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest –¥–ª—è SwiftDevBot

# –ü—É—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
testpaths = tests

# –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
asyncio_mode = auto

# –û–ø—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
addopts = 
    -v
    --strict-markers
    --tb=short
    --disable-warnings

# –ú–∞—Ä–∫–µ—Ä—ã
markers =
    unit: Unit —Ç–µ—Å—Ç—ã
    integration: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    slow: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    security: –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    performance: –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Python
minversion = 3.12

# –§–∏–ª—å—Ç—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning




======================================================================

------------------------------ FILE: requirements.txt ------------------------------

aiogram
python-dotenv
setuptools
typer>=0.9.0
pydantic
pydantic-settings
pydantic-extra-types
PyYAML>=6.0
ruamel.yaml
aioredis
redis
cryptography>=41.0.0
pip-audit

SQLAlchemy[asyncio] 
alembic

aiosqlite                
psycopg[binary]   
# asyncpg>=0.27.0           
aiomysql           

loguru
parsedatetime
apscheduler

typer[all] 

aiohttp
requests

packaging

cachetools
rich

psutil
uvicorn[standard]

# Web panel dependencies
fastapi
starlette
itsdangerous
jinja2
PyJWT>=2.8.0
python-multipart
websockets

pytest 
pylint 
sphinx 
coverage 
black 
isort 
mypy


======================================================================

------------------------------ FILE: alembic.ini ------------------------------
# alembic.ini
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Alembic –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot (SDB)

[alembic]
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ –º–∏–≥—Ä–∞—Ü–∏–π (env.py, versions/)
# –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —ç—Ç–æ–≥–æ .ini —Ñ–∞–π–ª–∞.
script_location = Systems/migration

# –®–∞–±–ª–æ–Ω –¥–ª—è –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Ä–µ–≤–∏–∑–∏–π.
# %%(rev)s - ID —Ä–µ–≤–∏–∑–∏–∏, %%(slug)s - —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (message) —Ä–µ–≤–∏–∑–∏–∏.
file_template = %%(rev)s_%%(slug)s

# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
# –í–ê–ñ–ù–û: –≠—Ç–æ—Ç URL –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ alembic_migrations/env.py
# –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ core.app_settings.settings.
# –ü–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –ø—É—Å—Ç—ã–º –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
# sqlalchemy.url = driver://user:pass@localhost/dbname
#sqlalchemy.url = sqlite:///./default_sdb_for_alembic_init.db # –ü—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è `alembic init`

# --- –û–ø—Ü–∏–∏, –≤–∞–∂–Ω—ã–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å SDB ---

# –ì–æ–≤–æ—Ä–∏—Ç Alembic –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å env.py –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–≤–∏–∑–∏–∏.
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ env.py –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª–∏ –∏ URL –ë–î.
revision_environment = true

# –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º .pyc —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö .py –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π.
# –û–±—ã—á–Ω–æ False. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ True –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞—è—Ö,
# –Ω–æ –¥–ª—è SDB –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–æ–π. –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª.
sourceless = true 

# –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é UTF-8 –æ–±—ã—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç.
# file_encoding = utf-8

# --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---

# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è version_locations (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ script_location –æ–¥–∏–Ω)
# version_path_separator = os # (–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω—É–∂–Ω–æ)

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –Ω–∞—à —Å–ª—É—á–∞–π –¥–ª—è –æ–¥–Ω–æ–≥–æ Alembic –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# [alembic:engine_myapp]
# sqlalchemy.url = ...

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Alembic.
# –ú–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å –∏–ª–∏ –¥–æ–ø–æ–ª–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Loguru, –µ—Å–ª–∏ SDB –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.
# –û–±—ã—á–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–¥–µ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç Alembic.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è SQLAlchemy (–Ω–∞–ø—Ä–∏–º–µ—Ä, WARN, INFO, DEBUG –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤)
level = WARN 
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–∞–º–æ–≥–æ Alembic
level = INFO 
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


======================================================================

------------------------------ FILE: Dockerfile ------------------------------
# Dockerfile –¥–ª—è SwiftDevBot
FROM python:3.12-slim

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="SwiftDevBot Team"
LABEL description="SwiftDevBot - –ú–æ–¥—É–ª—å–Ω—ã–π Telegram Bot Framework"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    make \
    libpq-dev \
    default-libmysqlclient-dev \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
COPY . .

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p Data/Config Data/Database_files Data/Logs Data/Security

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
RUN chmod +x sdb sdb.py run_bot.py sdb_setup.py

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONUNBUFFERED=1
ENV SDB_CLI_MODE=false
ENV SDB_VERBOSE=false

# –û–±—ä–µ–º—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
VOLUME ["/app/Data"]

# –ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python3 -c "import requests; requests.get('http://localhost:8000/api/health', timeout=5)" || exit 1

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["python3", "run_bot.py"]




======================================================================

------------------------------ FILE: Makefile ------------------------------
# Makefile –¥–ª—è SwiftDevBot

.PHONY: help install dev test lint format type-check docker-build docker-up docker-down clean

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "SwiftDevBot - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	pip install -r requirements.txt

dev: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	pip install -r requirements.txt
	pip install pytest pytest-cov pytest-asyncio pylint black isort mypy

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
	pytest tests/ -v

test-cov: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
	pytest tests/ --cov=Systems/core --cov-report=html --cov-report=term

lint: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–æ–º
	pylint Systems/core --disable=all --enable=E,F,W

format: ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
	black Systems/
	isort Systems/

format-check: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
	black --check Systems/
	isort --check Systems/

type-check: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã
	mypy Systems/core --ignore-missing-imports

docker-build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
	docker build -t swiftdevbot:latest .

docker-up: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker Compose
	docker-compose up -d

docker-down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker Compose
	docker-compose down

docker-logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Docker
	docker-compose logs -f

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
	find . -type d -name __pycache__ -exec rm -r {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name ".pytest_cache" -exec rm -r {} +
	find . -type d -name ".mypy_cache" -exec rm -r {} +
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf dist/
	rm -rf build/
	rm -rf *.egg-info

setup: ## –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
	python3 sdb_setup.py

run: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
	python3 sdb.py run

run-verbose: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
	python3 sdb.py run -v

run-debug: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏
	python3 sdb.py run -d

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
	python3 sdb.py status

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
	python3 sdb.py stop

restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
	python3 sdb.py restart

db-init: ## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
	python3 sdb.py db init

db-migrate: ## –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
	python3 sdb.py db migrate

db-upgrade: ## –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î
	python3 sdb.py db upgrade

all: format lint type-check test ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏




======================================================================

------------------------------ FILE: README.md ------------------------------
# üöÄ SwiftDevBot (SDB) - –ú–æ–¥—É–ª—å–Ω—ã–π Telegram Bot Framework

[![Python Version](https://img.shields.io/badge/python-3.12+-blue.svg)](https://python.org)
[![Aiogram](https://img.shields.io/badge/aiogram-3.22.0-green.svg)](https://aiogram.dev)
[![License](https://img.shields.io/badge/license-MIT-yellow.svg)](LICENSE)
[![GitHub Stars](https://img.shields.io/github/stars/soverxos/SwiftDevBot-Project.svg)](https://github.com/soverxos/SwiftDevBot-Project/stargazers)

**SwiftDevBot** - —ç—Ç–æ –º–æ—â–Ω—ã–π –º–æ–¥—É–ª—å–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram –±–æ—Ç–æ–≤ —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, RBAC, –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ –±–æ–≥–∞—Ç—ã–º –Ω–∞–±–æ—Ä–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [üåü –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏](#-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
- [‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#Ô∏è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#Ô∏è-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- [üß© –ú–æ–¥—É–ª–∏](#-–º–æ–¥—É–ª–∏)
- [üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#Ô∏è-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- [üë• RBAC —Å–∏—Å—Ç–µ–º–∞](#-rbac-—Å–∏—Å—Ç–µ–º–∞)
- [üìä CLI –∫–æ–º–∞–Ω–¥—ã](#-cli-–∫–æ–º–∞–Ω–¥—ã)
- [üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#Ô∏è-–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
- [üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- [üî® –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
- [üìö API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#-api-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- [ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç](#-–≤–∫–ª–∞–¥-–≤-–ø—Ä–æ–µ–∫—Ç)
- [üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è](#-–ª–∏—Ü–µ–Ω–∑–∏—è)

## üåü –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–ª–∞–≥–∏–Ω–æ–≤
- **RBAC —Å–∏—Å—Ç–µ–º–∞** - —Ä–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
- **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏, –ø–µ—Å–æ—á–Ω–∏—Ü–∞, –∞—É–¥–∏—Ç
- **–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ i18n –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ async/await
- **CLI —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –±–æ–≥–∞—Ç—ã–π –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Redis –∏ Memory –∫—ç—à–∞
- **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Alembic

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª–µ–π** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
- **–ü–µ—Å–æ—á–Ω–∏—Ü–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –∏–∑–æ–ª—è—Ü–∏—è –º–æ–¥—É–ª–µ–π
- **–°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏** - –æ—Ü–µ–Ω–∫–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π
- **–ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π** - –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–≥—Ä–æ–∑
- **–î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π** - –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### üß© –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å
- **–ì–æ—Ä—è—á–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- **–®–∞–±–ª–æ–Ω—ã –º–æ–¥—É–ª–µ–π** - –≥–æ—Ç–æ–≤—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**SwiftDevBot** –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è —É–¥–æ–±–Ω—ã–π –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å—é –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/soverxos/SwiftDevBot-Project.git
cd SwiftDevBot-Project

# 2. –ó–∞–ø—É—Å–∫ –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
python3 sdb_setup.py
```

–ú–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (SQLite/PostgreSQL/MySQL)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Memory/Redis)
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `.env`

**–í–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ:**
- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç [@BotFather](https://t.me/BotFather)
- –í–∞—à Telegram ID (–ø–æ–ª—É—á–∏—Ç—å —É [@userinfobot](https://t.me/userinfobot))

### üîß –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ï—Å–ª–∏ –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ —Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –¥–µ—Ç–∞–ª—å–Ω–æ:

#### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```bash
git clone https://github.com/soverxos/SwiftDevBot-Project.git
cd SwiftDevBot-Project
```

#### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
python3 -m venv .venv
source .venv/bin/activate  # Linux/Mac
# –∏–ª–∏
.venv\Scripts\activate     # Windows
```

#### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

#### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
cp env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª, –¥–æ–±–∞–≤–∏–≤ –≤–∞—à BOT_TOKEN
```

#### 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
python3 sdb.py db init
python3 sdb.py db migrate
```

### 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
python3 sdb.py run
```

### 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
python3 sdb.py status
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
SwiftDevBot/
‚îú‚îÄ‚îÄ core/                    # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ app_settings.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ bot_entrypoint.py    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ services_provider.py # –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ module_loader.py     # –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ database/            # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ security/            # –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ rbac/                # –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ users/               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ cache/               # –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ events/              # –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ ui/                  # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ cli/                     # CLI –∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ run.py              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ module.py           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ user.py             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ security.py         # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ Modules/                 # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ sys_status/         # –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å —Å—Ç–∞—Ç—É—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ example_module/     # –ü—Ä–∏–º–µ—Ä –º–æ–¥—É–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ project_data/            # –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ Database_files/      # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ Config/              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ Security/            # –ö–ª—é—á–∏ –∏ –∞—É–¥–∏—Ç
‚îÇ   ‚îî‚îÄ‚îÄ Logs/                # –õ–æ–≥–∏
‚îú‚îÄ‚îÄ Docs/                    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ locales/                 # –ü–µ—Ä–µ–≤–æ–¥—ã
‚îî‚îÄ‚îÄ alembic/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
```

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.12+
- SQLite/PostgreSQL/MySQL
- Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –º–∞—Å—Ç–µ—Ä–∞
git clone https://github.com/soverxos/SwiftDevBot-Project.git
cd SwiftDevBot-Project
python3 sdb_setup.py
```

–ú–∞—Å—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –°–æ–∑–¥–∞—Å—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ `requirements.txt`
- –ù–∞—Å—Ç—Ä–æ–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### üì¶ –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

#### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
```bash
pip install aiogram python-dotenv typer pydantic pydantic-settings
pip install PyYAML ruamel.yaml loguru aiohttp requests
pip install SQLAlchemy[asyncio] alembic aiosqlite psycopg[binary] aiomysql
pip install cachetools rich psutil uvicorn
```

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
pip install pytest pylint sphinx coverage black isort mypy
pip install cryptography aioredis redis packaging parsedatetime apscheduler
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`**:
```env
# Telegram Bot
BOT_TOKEN=your_bot_token_here
SDB_CORE_SUPER_ADMINS="your_telegram_id"

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
SDB_DB_TYPE="sqlite"
SDB_DB_SQLITE_PATH="Database_files/swiftdevbot.db"

# –ö—ç—à
SDB_CACHE_TYPE="memory"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
SDB_CORE_LOG_LEVEL="INFO"
```

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**:
```bash
python3 sdb.py db init
python3 sdb.py db migrate
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** `sdb_setup.py` –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
python3 sdb_setup.py
```

–ú–∞—Å—Ç–µ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç:
- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (SQLite/PostgreSQL/MySQL)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (Memory/Redis)
- –°—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `.env`

### üîß –†—É—á–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### Telegram Bot
```env
BOT_TOKEN=your_bot_token_here
SDB_TELEGRAM_POLLING_TIMEOUT=30
```

#### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```env
# SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
SDB_DB_TYPE="sqlite"
SDB_DB_SQLITE_PATH="Database_files/swiftdevbot.db"

# PostgreSQL
SDB_DB_TYPE="postgresql"
SDB_DB_POSTGRES_HOST="localhost"
SDB_DB_POSTGRES_PORT="5432"
SDB_DB_POSTGRES_DB="swiftdevbot"
SDB_DB_POSTGRES_USER="user"
SDB_DB_POSTGRES_PASSWORD="password"

# MySQL
SDB_DB_TYPE="mysql"
SDB_DB_MYSQL_HOST="localhost"
SDB_DB_MYSQL_PORT="3306"
SDB_DB_MYSQL_DB="swiftdevbot"
SDB_DB_MYSQL_USER="user"
SDB_DB_MYSQL_PASSWORD="password"
```

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```env
# Memory –∫—ç—à (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
SDB_CACHE_TYPE="memory"

# Redis –∫—ç—à
SDB_CACHE_TYPE="redis"
SDB_CACHE_REDIS_HOST="localhost"
SDB_CACHE_REDIS_PORT="6379"
SDB_CACHE_REDIS_DB="0"
SDB_CACHE_REDIS_PASSWORD=""
```

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```env
SDB_SECURITY_LEVEL="moderate"  # strict, moderate, permissive
SDB_SECURITY_SIGNATURE_REQUIRED="true"
SDB_SECURITY_SANDBOX_ENABLED="true"
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `project_data/Config/core_settings.yaml` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```yaml
core:
  sdb_version: "0.1.0"
  project_data_path: "./project_data"
  log_level: "INFO"
  super_admins: [123456789]
  
telegram:
  token: "your_bot_token"
  polling_timeout: 30
  
database:
  type: "sqlite"
  sqlite_path: "Database_files/swiftdevbot.db"
  
cache:
  type: "memory"
  default_ttl: 300
  
security:
  level: "moderate"
  signature_required: true
  sandbox_enabled: true
```

## üß© –ú–æ–¥—É–ª–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è

1. **–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –º–æ–¥—É–ª—è**:
```bash
mkdir Modules/my_module
cd Modules/my_module
```

2. **–°–æ–∑–¥–∞–π—Ç–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç –º–æ–¥—É–ª—è** (`manifest.yaml`):
```yaml
name: "my_module"
version: "1.0.0"
display_name: "–ú–æ–π –ú–æ–¥—É–ª—å"
description: "–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è"
author: "–í–∞—à–µ –ò–º—è"
license: "MIT"

permissions:
  - name: "my_module.access"
    description: "–î–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—é"
    default_roles: ["User"]

settings:
  - name: "enabled"
    type: "boolean"
    default: true
    description: "–í–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å"
```

3. **–°–æ–∑–¥–∞–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –º–æ–¥—É–ª—è** (`__init__.py`):
```python
from aiogram import Router, types
from aiogram.filters import Command
from core.schemas.module_manifest import ModuleManifest

router = Router()

@router.message(Command("mymodule"))
async def my_module_handler(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç –∏–∑ –º–æ–µ–≥–æ –º–æ–¥—É–ª—è!")

async def setup_module(dp, bot, manifest: ModuleManifest):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª—è"""
    dp.include_router(router)
    print(f"–ú–æ–¥—É–ª—å {manifest.name} –∑–∞–≥—Ä—É–∂–µ–Ω!")
```

### –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–æ–¥—É–ª—è

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–æ–¥—É–ª–∏
python3 sdb.py module list

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module enable my_module

# –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module disable my_module

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module reload my_module
```

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

- **sys_status** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **example_module** - –ø—Ä–∏–º–µ—Ä –º–æ–¥—É–ª—è —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
- **universal_module_template** - —à–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¶–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏

–í—Å–µ –º–æ–¥—É–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω—ã —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å—å—é:

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
python3 sdb.py security generate-key

# –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è
python3 sdb.py security sign-module my_module

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
python3 sdb.py security verify-module my_module
```

### –ü–µ—Å–æ—á–Ω–∏—Ü–∞

–ú–æ–¥—É–ª–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏:

- **–£—Ä–æ–≤–µ–Ω—å 1**: –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (—Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏)
- **–£—Ä–æ–≤–µ–Ω—å 2**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
- **–£—Ä–æ–≤–µ–Ω—å 3**: –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **–£—Ä–æ–≤–µ–Ω—å 4**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ê—É–¥–∏—Ç

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–æ–¥—É–ª–µ–π –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞
python3 sdb.py security audit-logs

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python3 sdb.py security audit-logs --user 123456789
```

## üë• RBAC —Å–∏—Å—Ç–µ–º–∞

### –†–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

- **Admin** - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º
- **Moderator** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –º–æ–¥—É–ª—è–º–∏
- **User** - –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏
python3 sdb.py user create-role "CustomRole"

# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
python3 sdb.py user assign-permission CustomRole my_module.access

# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
python3 sdb.py user assign-role 123456789 CustomRole
```

### –†–∞–∑—Ä–µ—à–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:

- `core.admin.*` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `core.modules.*` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏
- `core.users.*` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `module_name.action` - –¥–µ–π—Å—Ç–≤–∏—è –º–æ–¥—É–ª—è

## üìä CLI –∫–æ–º–∞–Ω–¥—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º
```bash
python3 sdb.py run              # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 sdb.py start            # –ü—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è run
python3 sdb.py stop             # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
python3 sdb.py restart          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 sdb.py status           # –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```bash
python3 sdb.py config init      # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
python3 sdb.py config get        # –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
python3 sdb.py config set key value  # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
python3 sdb.py db init          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
python3 sdb.py db migrate        # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
python3 sdb.py db upgrade        # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É
python3 sdb.py db downgrade      # –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

### –ú–æ–¥—É–ª–∏
```bash
python3 sdb.py module list       # –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π
python3 sdb.py module enable name    # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module disable name   # –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module reload name     # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å
python3 sdb.py module install path   # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```bash
python3 sdb.py user list         # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
python3 sdb.py user create       # –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python3 sdb.py user delete id    # –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python3 sdb.py user assign-role user_id role  # –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```bash
python3 sdb.py security status   # –°—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
python3 sdb.py security scan     # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
python3 sdb.py security audit-logs  # –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞
python3 sdb.py security generate-key  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
python3 sdb.py monitor stats     # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
python3 sdb.py monitor logs      # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
python3 sdb.py monitor performance  # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```

### –ë—ç–∫–∞–ø—ã
```bash
python3 sdb.py backup create     # –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
python3 sdb.py backup list       # –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
python3 sdb.py backup restore id # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—ç–∫–∞–ø
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –°–£–ë–î

- **SQLite** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- **PostgreSQL** - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- **MySQL** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ PostgreSQL

### –ú–∏–≥—Ä–∞—Ü–∏–∏

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Alembic –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
python3 sdb.py db create-migration "description"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
python3 sdb.py db migrate

# –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
python3 sdb.py db downgrade
```

### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- `sdb_users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `sdb_roles` - —Ä–æ–ª–∏
- `sdb_permissions` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- `sdb_user_roles` - —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π
- `sdb_role_permissions` - —Å–≤—è–∑–∏ —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- `alembic_version` - –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
python3 sdb.py monitor stats

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
python3 sdb.py monitor performance

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
python3 sdb.py monitor resources
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Loguru –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

- **–ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏** - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **–§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏** - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏

–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## üî® –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**:
```bash
git clone https://github.com/soverxos/SwiftDevBot-Project.git
cd SwiftDevBot-Project
python3 sdb_setup.py  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```

2. **–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**:
```bash
python3 sdb.py run --debug
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
core/
‚îú‚îÄ‚îÄ app_settings.py      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ bot_entrypoint.py    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ services_provider.py # –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ module_loader.py     # –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π
‚îú‚îÄ‚îÄ database/            # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ manager.py       # –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ models.py        # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ security/            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ signature_manager.py  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ sandbox_manager.py    # –ü–µ—Å–æ—á–Ω–∏—Ü–∞
‚îÇ   ‚îî‚îÄ‚îÄ audit_logger.py       # –ê—É–¥–∏—Ç
‚îî‚îÄ‚îÄ ...
```

### –°–æ–∑–¥–∞–Ω–∏–µ CLI –∫–æ–º–∞–Ω–¥—ã

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –∫–æ–º–∞–Ω–¥—ã** –≤ `cli/`:
```python
import typer
from core.app_settings import load_app_settings

app = typer.Typer(name="mycommand", help="–ú–æ—è –∫–æ–º–∞–Ω–¥–∞")

@app.command()
def my_action():
    """–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è"""
    settings = load_app_settings()
    print("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ...")

if __name__ == "__main__":
    app()
```

2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É** –≤ `sdb.py`:
```python
from cli.mycommand import app as mycommand_app
cli_main_app.add_typer(mycommand_app, name="mycommand")
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
python3 -m pytest

# –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
python3 -m pytest --cov=core

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
python3 -m pytest tests/test_module_loader.py
```

### –õ–∏–Ω—Ç–∏–Ω–≥

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
python3 -m pylint core/
python3 -m black core/
python3 -m isort core/
python3 -m mypy core/
```

## üìö API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã

#### BotServicesProvider
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏:
```python
from core.services_provider import BotServicesProvider
from core.app_settings import load_app_settings

settings = load_app_settings()
services = BotServicesProvider(settings)
await services.setup_services()

# –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º
db_manager = services._db_manager
module_loader = services._module_loader
```

#### ModuleLoader
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏:
```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ
module_info = module_loader.get_module_info("module_name")

# –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
all_modules = module_loader.get_all_modules_info()

# –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
loaded_modules = module_loader.get_loaded_modules_info()
```

#### AppSettings
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
```python
from core.app_settings import load_app_settings

settings = load_app_settings()
print(settings.telegram.token)
print(settings.db.type)
print(settings.core.super_admins)
```

### –°–æ–±—ã—Ç–∏—è

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π:

```python
from core.events.dispatcher import EventDispatcher

# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
@event_dispatcher.on("user_registered")
async def on_user_registered(user_id: int):
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è
await event_dispatcher.emit("user_registered", user_id=123456789)
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from core.cache.manager import CacheManager

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
await cache_manager.set("key", "value", ttl=300)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞
value = await cache_manager.get("key")

# –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞
await cache_manager.delete("key")
```

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

–ú—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞! –í–æ—Ç –∫–∞–∫ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–º–æ—á—å:

### üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**:
```bash
git clone https://github.com/soverxos/SwiftDevBot-Project.git
cd SwiftDevBot-Project
python3 sdb_setup.py  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```

2. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤**:
```bash
python3 sdb.py test
```

### –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–∞—Ö
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ issues
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π issue —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
3. –£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é Python, –û–° –∏ —à–∞–≥–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π
1. –°–æ–∑–¥–∞–π—Ç–µ issue —Å —Ç–µ–≥–æ–º "enhancement"
2. –û–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ
3. –û–±–æ—Å–Ω—É–π—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Pull Request
1. –§–æ—Ä–∫–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É –¥–ª—è –≤–∞—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –°–¥–µ–ª–∞–π—Ç–µ –∫–æ–º–º–∏—Ç—ã —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
4. –°–æ–∑–¥–∞–π—Ç–µ Pull Request

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞
- –°–ª–µ–¥—É–π—Ç–µ PEP 8
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ type hints
- –ü–æ–∫—Ä—ã–≤–∞–π—Ç–µ –∫–æ–¥ —Ç–µ—Å—Ç–∞–º–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–µ API

### –ö–æ–º–º–∏—Ç—ã
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤:
```
feat: –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É CLI
fix: –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª–µ–π
docs: –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API
test: –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è ModuleLoader
```

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT. –°–º. —Ñ–∞–π–ª [LICENSE](LICENSE) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

## üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

- [aiogram](https://aiogram.dev) - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Telegram Bot API
- [SQLAlchemy](https://sqlalchemy.org) - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- [Typer](https://typer.tiangolo.com) - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è CLI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- [Pydantic](https://pydantic.dev) - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- [Loguru](https://loguru.readthedocs.io) - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **GitHub Issues**: [–°–æ–∑–¥–∞—Ç—å issue](https://github.com/soverxos/SwiftDevBot-Project/issues)
- **Discussions**: [–û–±—Å—É–∂–¥–µ–Ω–∏—è](https://github.com/soverxos/SwiftDevBot-Project/discussions)
- **Telegram**: [@soverxos](https://t.me/soverxos)

## üöÄ Roadmap

### –í–µ—Ä—Å–∏—è 0.2.0
- [ ] Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ü–ª–∞–≥–∏–Ω —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è CLI
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API

### –í–µ—Ä—Å–∏—è 0.3.0
- [ ] –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [ ] Kubernetes –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] GraphQL API
- [ ] –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π

---

**SwiftDevBot** - —Å–æ–∑–¥–∞–Ω —Å ‚ù§Ô∏è –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram –±–æ—Ç–æ–≤.

‚≠ê –ü–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è!



======================================================================

------------------------------ FILE: sdb.py ------------------------------
#!/usr/bin/env python3

import sys
from pathlib import Path

# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path
current_script_path = Path(__file__).resolve()
project_root = current_script_path.parent
systems_path = project_root / "Systems"
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))
if str(systems_path) not in sys.path:
    sys.path.insert(0, str(systems_path))

try:
    import typer
    from rich.console import Console
except ImportError as e:
    print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Typer –∏–ª–∏ Rich –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. {e}", file=sys.stderr)
    print(f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install -r requirements.txt", file=sys.stderr)
    sys.exit(1)

# –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—ã–π CLI-–æ–±—ä–µ–∫—Ç
# –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º CLI, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ BOT_TOKEN
import os as _os
import sys as _sys
_os.environ.setdefault("SDB_CLI_MODE", "true")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ -v/--verbose –î–û –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
_argv = _sys.argv[1:]
_verbose_flag = "-v" in _argv or "--verbose" in _argv
if _verbose_flag:
    _os.environ["SDB_VERBOSE"] = "true"
else:
    _os.environ["SDB_VERBOSE"] = "false"
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –î–û –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
    # —á—Ç–æ–±—ã –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –±—ã–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏
    try:
        from loguru import logger as _early_logger
        _early_logger.remove()  # –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π handler
        # –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        _early_logger.add(
            _sys.stderr,
            level="INFO",
            format="<green>{time:HH:mm:ss}</green> <level>{message}</level>",
            colorize=True
        )
    except ImportError:
        pass  # –ï—Å–ª–∏ loguru –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ CLI-—Ä–µ–∂–∏–º –Ω–µ –º–µ—à–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
_bot_commands = {"start", "run", "bot"}
if _argv and _argv[0] in _bot_commands:
    if _os.environ.get("SDB_CLI_MODE") == "true":
        del _os.environ["SDB_CLI_MODE"]
cli_main_app = typer.Typer(
    name="sdb",
    help="üöÄ [bold cyan]SwiftDevBot CLI[/] - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º SDB!",
    rich_markup_mode="rich",
    no_args_is_help=True,
    context_settings={"help_option_names": ["-h", "--help"]}
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏ –≥—Ä—É–ø–ø—ã
try:
    # –ì—Ä—É–ø–ø—ã –∫–æ–º–∞–Ω–¥ (Typer-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
    from Systems.cli.config import config_app
    from Systems.cli.db import db_app
    from Systems.cli.module import module_app
    from Systems.cli.user import user_app
    from Systems.cli.backup import backup_app
    from Systems.cli.system import system_app
    from Systems.cli.bot import bot_app
    from Systems.cli.monitor import monitor_app
    from Systems.cli.utils import utils_app
    from Systems.cli.security import security_app
    from Systems.cli.notifications import notifications_app
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–æ–¥—É–ª–∏
    from Systems.cli.dev import dev_app
    from Systems.cli.api import api_app
    from Systems.cli.cache import cache_app
    from Systems.cli.tasks import tasks_app
    
    cli_main_app.add_typer(config_app, name="config", help="üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.")
    cli_main_app.add_typer(db_app, name="db", help="üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.")
    cli_main_app.add_typer(module_app, name="module", help="üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏.")
    cli_main_app.add_typer(user_app, name="user", help="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.")
    cli_main_app.add_typer(backup_app, name="backup", help="üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏.")
    cli_main_app.add_typer(system_app, name="system", help="üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.")
    cli_main_app.add_typer(bot_app, name="bot", help="ü§ñ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Bot API.")
    cli_main_app.add_typer(monitor_app, name="monitor", help="üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.")
    cli_main_app.add_typer(utils_app, name="utils", help="üõ†Ô∏è –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.")
    cli_main_app.add_typer(security_app, name="security", help="üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é.")
    cli_main_app.add_typer(notifications_app, name="notifications", help="üîî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
    cli_main_app.add_typer(dev_app, name="dev", help="üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.")
    cli_main_app.add_typer(api_app, name="api", help="üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API.")
    cli_main_app.add_typer(cache_app, name="cache", help="üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º —Å–∏—Å—Ç–µ–º—ã.")
    cli_main_app.add_typer(tasks_app, name="tasks", help="üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã.")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ–±-–ø–∞–Ω–µ–ª—å
    try:
        from Systems.cli.web import web_app
        cli_main_app.add_typer(web_app, name="web", help="üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±-–ø–∞–Ω–µ–ª—å—é.")
    except Exception as web_error:
        # –í–µ–±-–ø–∞–Ω–µ–ª—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        import os
        import traceback
        if os.environ.get("SDB_DEBUG"):
            console = Console()
            console.print(f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í–µ–±-–ø–∞–Ω–µ–ª—å –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞: {web_error}[/]")
            console.print(f"[dim]{traceback.format_exc()}[/]")
        # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–µ–±-–ø–∞–Ω–µ–ª–∏
        pass

    # –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    from Systems.cli.run import run_command
    from Systems.cli.process import stop_command, status_command, restart_command

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
    cli_main_app.command("run")(run_command)
    cli_main_app.command("start", help="üöÄ –ü—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è 'run'.")(run_command)
    cli_main_app.command("stop", help="üö¶ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞.")(stop_command)
    cli_main_app.command("status", help="üö¶ –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞.")(status_command)
    cli_main_app.command("restart", help="üö¶ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞.")(restart_command)

except ImportError as e:
    console = Console()
    console.print(f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CLI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:[/]\n {e}")
    console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ 'cli/' –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –∏ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ.")
    sys.exit(1)


if __name__ == "__main__":
    cli_main_app()
# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê sdb.py (–∏ sdb) ---


======================================================================

------------------------------ FILE: .dockerignore ------------------------------
# Git
.git
.gitignore
.gitattributes

# Python
__pycache__
*.py[cod]
*$py.class
*.so
.Python
*.egg-info
dist
build
.venv
venv
env

# IDE
.vscode
.idea
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Project specific
Data/Database_files/*.db
Data/Logs/*.log
Data/Security/*
*.pid

# Tests
.pytest_cache
.coverage
htmlcov

# Documentation
docs/_build

# Docker
Dockerfile
docker-compose.yml
.dockerignore

# CI/CD
.github




======================================================================

------------------------------ FILE: .gitignore ------------------------------
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py,cover
.hypothesis/
.pytest_cache/

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/

# PyBuilder
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
.python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# PEP 582; used by e.g. github.com/David-OConnor/pyflow
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# SwiftDevBot specific
project_data/Database_files/*.db
Data/Database_files/*.sqlite
Data/Database_files/*.sqlite3
Data/Logs/*.log
Data/Security/crypto_keys/*
Data/Security/audit_logs/*
Data/Security/anomaly_detection/*
Data/Security/reputation/*
Data/Security/sandbox/*
Data/Security/signatures/*
Data/sdb_bot.pid
*.pid

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Temporary files
*.tmp
*.temp
*.bak
*.backup
TOKEN-ID.txt
!Systems/web/src/lib/


======================================================================

------------------------------ FILE: .env ------------------------------
# .env.example
# –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SwiftDevBot.
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
# –°—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #, —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

# --- Telegram Bot ---
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞. –ü–æ–ª—É—á–∏—Ç—å —É @BotFather.
BOT_TOKEN=8146110559:AAHyOYDtx8s7MAZm5_t7CMIpJjAu6RQRUQ0
SDB_TELEGRAM_POLLING_TIMEOUT=30

# –°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
# –ü—Ä–∏–º–µ—Ä: SDB_CORE_SUPER_ADMINS="12345678,98765432"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∏–∑ AppSettings)
SDB_CORE_SUPER_ADMINS="7847397229"

# --- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö ---
# –¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: "sqlite", "postgresql", "mysql"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "sqlite" (–∏–∑ AppSettings)

SDB_DB_TYPE="sqlite"
SDB_DB_SQLITE_PATH="Database_files/swiftdevbot.db" 

# –î–ª—è SQLite:
# SDB_DB_TYPE="sqlite"
# –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Database_files/swiftdevbot.db" (–∏–∑ AppSettings)
# SDB_DB_SQLITE_PATH="Database_files/sdb_prod.db"

# –î–ª—è PostgreSQL:
# SDB_DB_TYPE="postgresql"
# DSN (Data Source Name) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.
# –§–æ—Ä–º–∞—Ç: postgresql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: asyncpg, psycopg (–¥–ª—è psycopg SQLAlchemy 2.0 –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å psycopg[binary])
# –ü—Ä–∏–º–µ—Ä: SDB_DB_PG_DSN="postgresql+psycopg://sdb_user:sdb_pass@localhost:5432/sdb_pg_database"
# SDB_DB_PG_DSN="postgresql+psycopg://soverx:Sova3568@192.168.31.3:2345/sdb_database"

# –î–ª—è MySQL:
# SDB_DB_TYPE="mysql"
# DSN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL.
# –§–æ—Ä–º–∞—Ç: mysql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: aiomysql, asyncmy
# –ü—Ä–∏–º–µ—Ä: SDB_DB_MYSQL_DSN="mysql+aiomysql://sdb_user:sdb_pass@localhost:3306/sdb_mysql_database?charset=utf8mb4"
# SDB_DB_MYSQL_DSN="mysql+aiomysql://root:Sova3568@192.168.31.3:33066/swiftdevbot?charset=utf8mb4"

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG). true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: false (–∏–∑ AppSettings)
# SDB_DB_ECHO_SQL="false"


# --- –ö—ç—à ---
# –¢–∏–ø –∫—ç—à–∞: "memory", "redis"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "memory" (–∏–∑ AppSettings)
SDB_CACHE_TYPE="memory"

# –î–ª—è Redis:
# SDB_CACHE_TYPE="redis"
# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis.
# –§–æ—Ä–º–∞—Ç: redis://[:<password>@]<host>:<port>/<db_number>
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "redis://localhost:6379/0" (–∏–∑ AppSettings)
# SDB_CACHE_REDIS_URL="redis://192.168.31.3:6379/0"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞ (Core) ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–ª–æ–≥–∏, –ë–î, –∫–æ–Ω—Ñ–∏–≥–∏ –º–æ–¥—É–ª–µ–π).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "./Data" (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∏–∑ AppSettings)
# SDB_CORE_PROJECT_DATA_PATH="./Data"

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Config/enabled_modules.json" (–∏–∑ AppSettings)
# SDB_CORE_ENABLED_MODULES_CONFIG_PATH="Config/active_plugins.json"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ø–¥—Ä–∞ ---
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "INFO" (–∏–∑ AppSettings)
SDB_CORE_LOG_LEVEL="INFO"

# –ü–∏—Å–∞—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª. true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: true (–∏–∑ AppSettings)
# SDB_CORE_LOG_TO_FILE="true"

# –®–∞–±–ª–æ–Ω –ø—É—Ç–∏ –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# {time} - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–ª—è Loguru.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Logs/sdb_{time:YYYY-MM-DD_HH-mm-ss_SSSSSS}.log" (–∏–∑ AppSettings)
# SDB_CORE_LOG_FILE_PATH_TEMPLATE="MyLogs/bot_{time}.log"

# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (—Ä–∞–∑–º–µ—Ä –∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª). –ü—Ä–∏–º–µ—Ä—ã: "500 MB", "1 week", "00:00" (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "10 MB" (–∏–∑ AppSettings)
# SDB_CORE_LOG_ROTATION="100 MB"

# –•—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ (–∫–∞–∫ –¥–æ–ª–≥–æ –∏–ª–∏ —Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤). –ü—Ä–∏–º–µ—Ä—ã: "1 month", "10 files".
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "7 days" (–∏–∑ AppSettings)
# SDB_CORE_LOG_RETENTION="30 days"

# –í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SDB (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –æ–±—ã—á–Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "0.1.0" (–∏–∑ AppSettings)
# SDB_CORE_SDB_VERSION="0.1.1-beta"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ "–ú–∞–≥–∞–∑–∏–Ω–∞" –ú–æ–¥—É–ª–µ–π ---
# URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json" (–∏–∑ AppSettings)
# SDB_MODULE_REPO_INDEX_URL="https://my.private.repo/modules_index.json"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (i18n) –Ø–¥—Ä–∞ ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Systems/locales" (–∏–∑ AppSettings)
# SDB_I18N_LOCALES_DIR="Systems/locales"

# –ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è gettext (–æ–±—ã—á–Ω–æ –∏–º—è .po/.mo —Ñ–∞–π–ª–æ–≤).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "bot" (–∏–∑ AppSettings)
# SDB_I18N_DOMAIN="sdb_core"

# –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en" (–∏–∑ AppSettings)
# SDB_I18N_DEFAULT_LOCALE="en"

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "en,uk,de").
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en,uk" (–∏–∑ AppSettings)
# SDB_I18N_AVAILABLE_LOCALES="en,uk,ru"

# –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ JWT —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60 –º–∏–Ω—É—Ç (1 —á–∞—Å)
SDB_WEB_TOKEN_LIFETIME_MINUTES=60



======================================================================

------------------------------ FILE: sdb ------------------------------
#!/usr/bin/env python3
"""
SwiftDevBot CLI - –≥–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
"""

import sys
from pathlib import Path

# –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ sdb.py –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
current_script_path = Path(__file__).resolve()
sdb_py_path = current_script_path.parent / "sdb.py"

# –ó–∞–ø—É—Å–∫–∞–µ–º sdb.py —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
sys.argv[0] = str(sdb_py_path)
exec(open(sdb_py_path).read())



======================================================================

------------------------------ FILE: docker-compose.yml ------------------------------
version: '3.8'

services:
  bot:
    build: .
    container_name: swiftdevbot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SDB_DB_TYPE=postgresql
      - SDB_DB_PG_DSN=postgresql+psycopg://sdb_user:sdb_password@sdb_db:5432/swiftdevbot
      - SDB_CACHE_TYPE=redis
      - SDB_CACHE_REDIS_URL=redis://sdb_redis:6379/0
    volumes:
      - ./Data:/app/Data
      - ./Modules:/app/Modules
    depends_on:
      - db
      - redis
    networks:
      - sdb_network
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  web:
    build: .
    container_name: swiftdevbot-web
    restart: unless-stopped
    command: python3 -m Systems.cli.web start --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - SDB_DB_TYPE=postgresql
      - SDB_DB_PG_DSN=postgresql+psycopg://sdb_user:sdb_password@sdb_db:5432/swiftdevbot
      - SDB_CACHE_TYPE=redis
      - SDB_CACHE_REDIS_URL=redis://sdb_redis:6379/0
    volumes:
      - ./Data:/app/Data
    depends_on:
      - bot
      - db
      - redis
    networks:
      - sdb_network

  db:
    image: postgres:16-alpine
    container_name: swiftdevbot-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sdb_user
      - POSTGRES_PASSWORD=sdb_password
      - POSTGRES_DB=swiftdevbot
    volumes:
      - sdb_db_data:/var/lib/postgresql/data
    networks:
      - sdb_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sdb_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: swiftdevbot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - sdb_redis_data:/data
    networks:
      - sdb_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: swiftdevbot-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - sdb_prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    networks:
      - sdb_network

  grafana:
    image: grafana/grafana:latest
    container_name: swiftdevbot-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - sdb_grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - sdb_network

volumes:
  sdb_db_data:
  sdb_redis_data:
  sdb_prometheus_data:
  sdb_grafana_data:

networks:
  sdb_network:
    driver: bridge




======================================================================

------------------------------ FILE: prometheus.yml ------------------------------
# Prometheus –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è SwiftDevBot
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'swiftdevbot'
    static_configs:
      - targets: ['web:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']




======================================================================

------------------------------ FILE: env.example ------------------------------
# .env.example
# –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SwiftDevBot.
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
# –°—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #, —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

# --- Telegram Bot ---
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞. –ü–æ–ª—É—á–∏—Ç—å —É @BotFather.
BOT_TOKEN=<TOKEN HERE>
SDB_TELEGRAM_POLLING_TIMEOUT=30

# –°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
# –ü—Ä–∏–º–µ—Ä: SDB_CORE_SUPER_ADMINS="12345678,98765432"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∏–∑ AppSettings)
SDB_CORE_SUPER_ADMINS="ID ADMIN"

# --- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö ---
# –¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: "sqlite", "postgresql", "mysql"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "sqlite" (–∏–∑ AppSettings)

SDB_DB_TYPE="sqlite"
SDB_DB_SQLITE_PATH="Database_files/swiftdevbot.db" 

# –î–ª—è SQLite:
# SDB_DB_TYPE="sqlite"
# –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Database_files/swiftdevbot.db" (–∏–∑ AppSettings)
# SDB_DB_SQLITE_PATH="Database_files/sdb_prod.db"

# –î–ª—è PostgreSQL:
# SDB_DB_TYPE="postgresql"
# DSN (Data Source Name) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.
# –§–æ—Ä–º–∞—Ç: postgresql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: asyncpg, psycopg (–¥–ª—è psycopg SQLAlchemy 2.0 –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å psycopg[binary])
# –ü—Ä–∏–º–µ—Ä: SDB_DB_PG_DSN="postgresql+psycopg://sdb_user:sdb_pass@localhost:5432/sdb_pg_database"
# SDB_DB_PG_DSN="postgresql+psycopg://soverx:Sova3568@192.168.31.3:2345/sdb_database"

# –î–ª—è MySQL:
# SDB_DB_TYPE="mysql"
# DSN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL.
# –§–æ—Ä–º–∞—Ç: mysql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: aiomysql, asyncmy
# –ü—Ä–∏–º–µ—Ä: SDB_DB_MYSQL_DSN="mysql+aiomysql://sdb_user:sdb_pass@localhost:3306/sdb_mysql_database?charset=utf8mb4"
# SDB_DB_MYSQL_DSN="mysql+aiomysql://root:Sova3568@192.168.31.3:33066/swiftdevbot?charset=utf8mb4"

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG). true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: false (–∏–∑ AppSettings)
# SDB_DB_ECHO_SQL="false"


# --- –ö—ç—à ---
# –¢–∏–ø –∫—ç—à–∞: "memory", "redis"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "memory" (–∏–∑ AppSettings)
SDB_CACHE_TYPE="memory"

# –î–ª—è Redis:
# SDB_CACHE_TYPE="redis"
# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis.
# –§–æ—Ä–º–∞—Ç: redis://[:<password>@]<host>:<port>/<db_number>
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "redis://localhost:6379/0" (–∏–∑ AppSettings)
# SDB_CACHE_REDIS_URL="redis://192.168.31.3:6379/0"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞ (Core) ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–ª–æ–≥–∏, –ë–î, –∫–æ–Ω—Ñ–∏–≥–∏ –º–æ–¥—É–ª–µ–π).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "./Data" (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∏–∑ AppSettings)
# SDB_CORE_PROJECT_DATA_PATH="./Data"

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Config/enabled_modules.json" (–∏–∑ AppSettings)
# SDB_CORE_ENABLED_MODULES_CONFIG_PATH="Config/active_plugins.json"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ø–¥—Ä–∞ ---
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "INFO" (–∏–∑ AppSettings)
SDB_CORE_LOG_LEVEL="INFO"

# –ü–∏—Å–∞—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª. true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: true (–∏–∑ AppSettings)
# SDB_CORE_LOG_TO_FILE="true"

# –®–∞–±–ª–æ–Ω –ø—É—Ç–∏ –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# {time} - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–ª—è Loguru.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Logs/sdb_{time:YYYY-MM-DD_HH-mm-ss_SSSSSS}.log" (–∏–∑ AppSettings)
# SDB_CORE_LOG_FILE_PATH_TEMPLATE="MyLogs/bot_{time}.log"

# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (—Ä–∞–∑–º–µ—Ä –∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª). –ü—Ä–∏–º–µ—Ä—ã: "500 MB", "1 week", "00:00" (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "10 MB" (–∏–∑ AppSettings)
# SDB_CORE_LOG_ROTATION="100 MB"

# –•—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ (–∫–∞–∫ –¥–æ–ª–≥–æ –∏–ª–∏ —Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤). –ü—Ä–∏–º–µ—Ä—ã: "1 month", "10 files".
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "7 days" (–∏–∑ AppSettings)
# SDB_CORE_LOG_RETENTION="30 days"

# –í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SDB (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –æ–±—ã—á–Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "0.1.0" (–∏–∑ AppSettings)
# SDB_CORE_SDB_VERSION="0.1.1-beta"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ "–ú–∞–≥–∞–∑–∏–Ω–∞" –ú–æ–¥—É–ª–µ–π ---
# URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json" (–∏–∑ AppSettings)
# SDB_MODULE_REPO_INDEX_URL="https://my.private.repo/modules_index.json"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (i18n) –Ø–¥—Ä–∞ ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Systems/locales" (–∏–∑ AppSettings)
# SDB_I18N_LOCALES_DIR="Systems/locales"

# –ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è gettext (–æ–±—ã—á–Ω–æ –∏–º—è .po/.mo —Ñ–∞–π–ª–æ–≤).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "bot" (–∏–∑ AppSettings)
# SDB_I18N_DOMAIN="sdb_core"

# –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en" (–∏–∑ AppSettings)
# SDB_I18N_DEFAULT_LOCALE="en"

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "en,uk,de").
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en,uk" (–∏–∑ AppSettings)
# SDB_I18N_AVAILABLE_LOCALES="en,uk,ru"


======================================================================

------------------------------ FILE: config/cloud_password_7847397229.txt ------------------------------
7e071fd9b023ed8f18458a73613a0834f6220bd5cc50357ba3493c6040a9ea8c


======================================================================

------------------------------ FILE: config/security_keys.json ------------------------------
{
  "jwt_secret": "Kt4wtXW-tbX64ymkzooxi_-GNNk0QwhUdkzrXSdbPuQ"
}


======================================================================

------------------------------ FILE: tests/conftest.py ------------------------------
"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest –¥–ª—è —Ç–µ—Å—Ç–æ–≤ SwiftDevBot
"""

import pytest
import asyncio
from pathlib import Path
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path
project_root = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / "Systems"))

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
os.environ.setdefault("SDB_CLI_MODE", "true")
os.environ.setdefault("SDB_VERBOSE", "false")
os.environ.setdefault("SDB_ALLOW_MISSING_BOT_TOKEN", "true")


@pytest.fixture(scope="session")
def event_loop():
    """–°–æ–∑–¥–∞–µ—Ç event loop –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()


@pytest.fixture
def test_data_dir(tmp_path):
    """–°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    test_dir = tmp_path / "test_data"
    test_dir.mkdir()
    (test_dir / "Config").mkdir()
    (test_dir / "Database_files").mkdir()
    (test_dir / "Logs").mkdir()
    return test_dir




======================================================================

------------------------------ FILE: tests/test_metrics.py ------------------------------
"""
–¢–µ—Å—Ç—ã –¥–ª—è Metrics Collector
"""

import pytest
from Systems.core.monitoring.metrics import MetricsCollector


class TestMetricsCollector:
    """–¢–µ—Å—Ç—ã –¥–ª—è MetricsCollector"""
    
    def test_initialization(self):
        """–¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MetricsCollector"""
        collector = MetricsCollector()
        assert collector._counters == {}
        assert collector._gauges == {}
        assert collector._histograms == {}
    
    def test_increment_counter(self):
        """–¢–µ—Å—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞"""
        collector = MetricsCollector()
        collector.increment_counter("test_counter")
        assert collector._counters["test_counter"] == 1
        
        collector.increment_counter("test_counter", value=5)
        assert collector._counters["test_counter"] == 6
    
    def test_increment_counter_with_labels(self):
        """–¢–µ—Å—Ç —Å—á–µ—Ç—á–∏–∫–∞ —Å –º–µ—Ç–∫–∞–º–∏"""
        collector = MetricsCollector()
        collector.increment_counter("test_counter", labels={"type": "test"})
        key = collector._format_key("test_counter", {"type": "test"})
        assert collector._counters[key] == 1
    
    def test_set_gauge(self):
        """–¢–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ gauge"""
        collector = MetricsCollector()
        collector.set_gauge("test_gauge", 42.5)
        assert collector._gauges["test_gauge"] == 42.5
        
        collector.set_gauge("test_gauge", 100.0)
        assert collector._gauges["test_gauge"] == 100.0
    
    def test_record_histogram(self):
        """–¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É"""
        collector = MetricsCollector()
        collector.record_histogram("test_histogram", 1.5)
        collector.record_histogram("test_histogram", 2.5)
        collector.record_histogram("test_histogram", 3.5)
        
        assert len(collector._histograms["test_histogram"]) == 3
        assert collector._histograms["test_histogram"] == [1.5, 2.5, 3.5]
    
    def test_get_prometheus_format(self):
        """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ Prometheus"""
        collector = MetricsCollector()
        collector.increment_counter("test_counter")
        collector.set_gauge("test_gauge", 42.0)
        collector.record_histogram("test_histogram", 1.0)
        
        prometheus_output = collector.get_prometheus_format()
        assert "test_counter" in prometheus_output
        assert "test_gauge" in prometheus_output
        assert "test_histogram" in prometheus_output
        assert "# TYPE" in prometheus_output
    
    def test_get_metrics_dict(self):
        """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è"""
        collector = MetricsCollector()
        collector.increment_counter("test_counter")
        collector.set_gauge("test_gauge", 42.0)
        collector.record_histogram("test_histogram", 1.0)
        
        metrics_dict = collector.get_metrics_dict()
        assert "counters" in metrics_dict
        assert "gauges" in metrics_dict
        assert "histograms" in metrics_dict
        assert "test_counter" in metrics_dict["counters"]
        assert "test_gauge" in metrics_dict["gauges"]




======================================================================

------------------------------ FILE: tests/__init__.py ------------------------------
# Tests package




======================================================================

------------------------------ FILE: tests/test_input_validator.py ------------------------------
"""
–¢–µ—Å—Ç—ã –¥–ª—è Input Validator
"""

import pytest
from Systems.core.security.input_validator import InputValidator, InputValidationMiddleware


class TestInputValidator:
    """–¢–µ—Å—Ç—ã –¥–ª—è –∫–ª–∞—Å—Å–∞ InputValidator"""
    
    def test_initialization(self):
        """–¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ InputValidator"""
        validator = InputValidator()
        assert validator.MAX_MESSAGE_LENGTH == 4096
        assert validator.MAX_COMMAND_LENGTH == 100
    
    def test_validate_message_valid(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        validator = InputValidator()
        is_valid, error = validator.validate_message("–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!")
        assert is_valid is True
        assert error is None
    
    def test_validate_message_too_long(self):
        """–¢–µ—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        validator = InputValidator()
        long_message = "a" * 5000
        is_valid, error = validator.validate_message(long_message)
        assert is_valid is False
        assert "—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ" in error.lower()
    
    def test_validate_message_xss_pattern(self):
        """–¢–µ—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è XSS –ø–∞—Ç—Ç–µ—Ä–Ω–∞"""
        validator = InputValidator()
        xss_message = "<script>alert('XSS')</script>"
        is_valid, error = validator.validate_message(xss_message)
        assert is_valid is False
        assert "–æ–ø–∞—Å–Ω—ã–π" in error.lower() or "xss" in error.lower()
    
    def test_validate_message_flood_pattern(self):
        """–¢–µ—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ñ–ª—É–¥-–ø–∞—Ç—Ç–µ—Ä–Ω–∞"""
        validator = InputValidator()
        flood_message = "aaaaaa"  # –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
        is_valid, error = validator.validate_message(flood_message)
        # –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º, –µ—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω
        # –≠—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ _check_flood_pattern
    
    def test_validate_command_valid(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        validator = InputValidator()
        is_valid, error = validator.validate_command("/start")
        assert is_valid is True
        assert error is None
    
    def test_validate_command_invalid_format(self):
        """–¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        validator = InputValidator()
        is_valid, error = validator.validate_command("start")  # –ë–µ–∑ /
        assert is_valid is False
        assert error is not None
    
    def test_validate_command_too_long(self):
        """–¢–µ—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        validator = InputValidator()
        long_command = "/" + "a" * 200
        is_valid, error = validator.validate_command(long_command)
        assert is_valid is False
        assert "—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è" in error.lower()
    
    def test_validate_callback_data_valid(self):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö callback data"""
        validator = InputValidator()
        is_valid, error = validator.validate_callback_data("action:123")
        assert is_valid is True
        assert error is None
    
    def test_validate_callback_data_too_long(self):
        """–¢–µ—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö callback data"""
        validator = InputValidator()
        long_data = "a" * 100
        is_valid, error = validator.validate_callback_data(long_data)
        assert is_valid is False
        assert "—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ" in error.lower()
    
    def test_validate_callback_data_dangerous_chars(self):
        """–¢–µ—Å—Ç –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ callback data"""
        validator = InputValidator()
        dangerous_data = "action<script>"
        is_valid, error = validator.validate_callback_data(dangerous_data)
        assert is_valid is False
        assert "–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ" in error.lower()
    
    def test_sanitize_text(self):
        """–¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞"""
        validator = InputValidator()
        dirty_text = "<script>alert('XSS')</script>Hello"
        clean_text = validator.sanitize_text(dirty_text)
        assert "<script>" not in clean_text
        assert "Hello" in clean_text




======================================================================

------------------------------ FILE: tests/test_rate_limiter.py ------------------------------
"""
–¢–µ—Å—Ç—ã –¥–ª—è Rate Limiter
"""

import pytest
import time
from Systems.core.security.rate_limiter import RateLimiter, RateLimitMiddleware


class TestRateLimiter:
    """–¢–µ—Å—Ç—ã –¥–ª—è –∫–ª–∞—Å—Å–∞ RateLimiter"""
    
    def test_initialization(self):
        """–¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RateLimiter"""
        limiter = RateLimiter(default_limit=10, default_window=60)
        assert limiter.default_limit == 10
        assert limiter.default_window == 60
    
    def test_check_rate_limit_allowed(self):
        """–¢–µ—Å—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        limiter = RateLimiter(default_limit=5, default_window=60)
        user_id = 123456
        
        # –ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
        for i in range(5):
            is_allowed, retry_after = limiter.check_rate_limit(user_id, "message")
            assert is_allowed is True
            assert retry_after == 0
    
    def test_check_rate_limit_exceeded(self):
        """–¢–µ—Å—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞"""
        limiter = RateLimiter(default_limit=2, default_window=60)
        user_id = 123456
        
        # –ü–µ—Ä–≤—ã–µ 2 –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
        assert limiter.check_rate_limit(user_id, "message")[0] is True
        assert limiter.check_rate_limit(user_id, "message")[0] is True
        
        # –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
        is_allowed, retry_after = limiter.check_rate_limit(user_id, "message")
        assert is_allowed is False
        assert retry_after > 0
    
    def test_different_action_types(self):
        """–¢–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π"""
        limiter = RateLimiter(default_limit=10, default_window=60)
        limiter.set_limit("command", limit=3, window=60)
        user_id = 123456
        
        # –ö–æ–º–∞–Ω–¥—ã –∏–º–µ—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç
        assert limiter.check_rate_limit(user_id, "command")[0] is True
        assert limiter.check_rate_limit(user_id, "command")[0] is True
        assert limiter.check_rate_limit(user_id, "command")[0] is True
        assert limiter.check_rate_limit(user_id, "command")[0] is False
        
        # –°–æ–æ–±—â–µ–Ω–∏—è –∏–º–µ—é—Ç –¥—Ä—É–≥–æ–π –ª–∏–º–∏—Ç
        assert limiter.check_rate_limit(user_id, "message")[0] is True
    
    def test_reset_user(self):
        """–¢–µ—Å—Ç —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        limiter = RateLimiter(default_limit=2, default_window=60)
        user_id = 123456
        
        # –ü—Ä–µ–≤—ã—à–∞–µ–º –ª–∏–º–∏—Ç
        limiter.check_rate_limit(user_id, "message")
        limiter.check_rate_limit(user_id, "message")
        assert limiter.check_rate_limit(user_id, "message")[0] is False
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º
        limiter.reset_user(user_id)
        
        # –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å—ã —Å–Ω–æ–≤–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
        assert limiter.check_rate_limit(user_id, "message")[0] is True
    
    def test_get_user_stats(self):
        """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        limiter = RateLimiter(default_limit=10, default_window=60)
        user_id = 123456
        
        limiter.check_rate_limit(user_id, "message")
        limiter.check_rate_limit(user_id, "command")
        
        stats = limiter.get_user_stats(user_id)
        assert "message" in stats
        assert "command" in stats
        assert stats["message"]["count"] >= 1




======================================================================

------------------------------ FILE: tests/test_health.py ------------------------------
"""
–¢–µ—Å—Ç—ã –¥–ª—è Health Checker
"""

import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from Systems.core.monitoring.health import HealthChecker, HealthStatus


class TestHealthStatus:
    """–¢–µ—Å—Ç—ã –¥–ª—è HealthStatus"""
    
    def test_health_status_creation(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è HealthStatus"""
        status = HealthStatus(
            name="test",
            status="healthy",
            message="Test message",
            details={"key": "value"}
        )
        assert status.name == "test"
        assert status.status == "healthy"
        assert status.message == "Test message"
        assert status.details == {"key": "value"}
    
    def test_health_status_to_dict(self):
        """–¢–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ —Å–ª–æ–≤–∞—Ä—å"""
        status = HealthStatus(
            name="test",
            status="healthy",
            message="Test message"
        )
        status_dict = status.to_dict()
        assert status_dict["name"] == "test"
        assert status_dict["status"] == "healthy"
        assert status_dict["message"] == "Test message"
        assert "timestamp" in status_dict


class TestHealthChecker:
    """–¢–µ—Å—Ç—ã –¥–ª—è HealthChecker"""
    
    @pytest.fixture
    def mock_services(self):
        """–ú–æ–∫ –¥–ª—è BotServicesProvider"""
        services = MagicMock()
        services.db = MagicMock()
        services.cache = MagicMock()
        services.bot = MagicMock()
        services.modules = MagicMock()
        return services
    
    @pytest.mark.asyncio
    async def test_check_database_healthy(self, mock_services):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î (–∑–¥–æ—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)"""
        checker = HealthChecker(mock_services)
        
        # –ú–æ–∫–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        mock_session = AsyncMock()
        mock_services.db.get_session.return_value.__aenter__.return_value = mock_session
        mock_result = MagicMock()
        mock_result.scalar.return_value = 1
        mock_session.execute = AsyncMock(return_value=mock_result)
        
        status = await checker.check_database()
        assert status.status == "healthy"
        assert "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞" in status.message
    
    @pytest.mark.asyncio
    async def test_check_database_unhealthy(self, mock_services):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î (–Ω–µ–∑–¥–æ—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)"""
        checker = HealthChecker(mock_services)
        
        # –ú–æ–∫–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        mock_services.db.get_session.side_effect = Exception("Connection failed")
        
        status = await checker.check_database()
        assert status.status == "unhealthy"
        assert "–û—à–∏–±–∫–∞" in status.message
    
    @pytest.mark.asyncio
    async def test_check_cache_healthy(self, mock_services):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞ (–∑–¥–æ—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)"""
        checker = HealthChecker(mock_services)
        
        mock_services.cache.is_available.return_value = True
        mock_services.cache.set = AsyncMock()
        mock_services.cache.get = AsyncMock(return_value="test")
        mock_services.cache.delete = AsyncMock()
        
        status = await checker.check_cache()
        assert status.status == "healthy"
        assert "–ö—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç" in status.message
    
    @pytest.mark.asyncio
    async def test_check_cache_unavailable(self, mock_services):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞ (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"""
        checker = HealthChecker(mock_services)
        
        mock_services.cache.is_available.return_value = False
        
        status = await checker.check_cache()
        assert status.status == "unhealthy"
        assert "–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" in status.message.lower()
    
    @pytest.mark.asyncio
    async def test_check_all(self, mock_services):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        checker = HealthChecker(mock_services)
        
        # –ú–æ–∫–∞–µ–º –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∫ —É—Å–ø–µ—à–Ω—ã–µ
        with patch.object(checker, 'check_database', return_value=HealthStatus("database", "healthy", "")), \
             patch.object(checker, 'check_cache', return_value=HealthStatus("cache", "healthy", "")), \
             patch.object(checker, 'check_telegram_api', return_value=HealthStatus("telegram_api", "healthy", "")), \
             patch.object(checker, 'check_modules', return_value=HealthStatus("modules", "healthy", "")):
            
            result = await checker.check_all()
            assert result["status"] == "healthy"
            assert "checks" in result
            assert len(result["checks"]) == 4




======================================================================

------------------------------ FILE: tests/test_error_handler.py ------------------------------
"""
–¢–µ—Å—Ç—ã –¥–ª—è Error Handler
"""

import pytest
from unittest.mock import AsyncMock, MagicMock
from Systems.core.errors.exceptions import (
    RateLimitError,
    PermissionError,
    ValidationError,
    DatabaseError,
    ModuleError
)
from Systems.core.errors.handler import ErrorHandlerMiddleware


class TestCustomExceptions:
    """–¢–µ—Å—Ç—ã –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""
    
    def test_rate_limit_error(self):
        """–¢–µ—Å—Ç RateLimitError"""
        error = RateLimitError("Too many requests", retry_after=60)
        assert error.message == "Too many requests"
        assert error.error_code == "RATE_LIMIT_ERROR"
        assert error.retry_after == 60
    
    def test_permission_error(self):
        """–¢–µ—Å—Ç PermissionError"""
        error = PermissionError("Access denied", permission="module.action")
        assert error.message == "Access denied"
        assert error.error_code == "PERMISSION_ERROR"
        assert error.permission == "module.action"
    
    def test_validation_error(self):
        """–¢–µ—Å—Ç ValidationError"""
        error = ValidationError("Invalid input", field="username")
        assert error.message == "Invalid input"
        assert error.error_code == "VALIDATION_ERROR"
        assert error.field == "username"
    
    def test_database_error(self):
        """–¢–µ—Å—Ç DatabaseError"""
        error = DatabaseError("Connection failed")
        assert error.message == "Connection failed"
        assert error.error_code == "DATABASE_ERROR"
    
    def test_module_error(self):
        """–¢–µ—Å—Ç ModuleError"""
        error = ModuleError("Module failed", module_name="test_module")
        assert error.message == "Module failed"
        assert error.error_code == "MODULE_ERROR"
        assert error.module_name == "test_module"




======================================================================

------------------------------ FILE: Scripts/snapshot_generator.py ------------------------------
import os
from pathlib import Path

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
OUTPUT_FILENAME = "project_snapshot.txt"
EXCLUDE_DIRS = {
    ".venv", "venv", "__pycache__", ".git", ".idea", ".vscode",
    "build", "dist", "*.egg-info", "node_modules",
    "Data/Cache", "Data/LogsBot", "Data/Temp", "Data/Uploads", # –ò–∑ —Ç–≤–æ–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Data/
    "logs", # –û–±—â–∞—è –ø–∞–ø–∫–∞ –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å
    "Modules", # –ü–∞–ø–∫–∞ —Å –º–æ–¥—É–ª—è–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
}
EXCLUDE_FILES = {
    OUTPUT_FILENAME,  # –ù–µ –≤–∫–ª—é—á–∞—Ç—å —Å–∞–º —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∞
    ".DS_Store",
    "*.pyc",
    "*.swp",
    "*.swo",
    # –î–æ–±–∞–≤—å —Å—é–¥–∞ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ–ª—å—à–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏
    "project_snapshot.txt"
    "TEST.md"
}
EXCLUDE_EXTENSIONS = {
    ".sqlite", ".db", ".db-journal", # –§–∞–π–ª—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (–º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏)
    ".log", # –£–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è EXCLUDE_DIRS, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    # –î–æ–±–∞–≤—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å
    # ".zip", ".tar.gz"
}
MAX_FILE_SIZE_MB = 2  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–≤ –ú–ë)
MAX_TOTAL_OUTPUT_SIZE_MB = 50 # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º)

# –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
FILE_ENCODING = "utf-8"
# --- –ö–æ–Ω–µ—Ü –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---

def should_exclude_dir(dir_name, exclude_set):
    return dir_name in exclude_set

def should_exclude_file(file_name, file_path, exclude_files_set, exclude_ext_set):
    if file_name in exclude_files_set:
        return True
    if file_path.suffix.lower() in exclude_ext_set:
        return True
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –º–∞—Å–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # import fnmatch
    # for pattern in exclude_files_set:
    #     if fnmatch.fnmatch(file_name, pattern):
    #         return True
    return False

def get_dir_tree(start_path, indent_char="    ", max_depth=10):
    tree_lines = []
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≥–ª—É–±–∏–Ω—É —Ä–µ–∫—É—Ä—Å–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ –¥–µ—Ä–µ–≤–∞
    if max_depth < 0:
        return ["... (Max depth reached)"]

    try:
        items = sorted(list(start_path.iterdir()), key=lambda p: (p.is_file(), p.name.lower()))
    except PermissionError:
        return [f"... (Permission denied: {start_path})"]
    except FileNotFoundError:
        return [f"... (Not found: {start_path})"]


    for i, item in enumerate(items):
        is_last = i == (len(items) - 1)
        prefix = indent_char + ("‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ ")

        if item.is_dir():
            if should_exclude_dir(item.name, EXCLUDE_DIRS):
                tree_lines.append(f"{prefix}{item.name}/ [EXCLUDED_DIR]")
                continue
            tree_lines.append(f"{prefix}{item.name}/")
            # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            # –£–º–µ–Ω—å—à–∞–µ–º max_depth –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            sub_indent = indent_char + ("    " if is_last else "‚îÇ   ")
            tree_lines.extend([sub_indent + line for line in get_dir_tree(item, indent_char, max_depth -1)])
        else:
            if should_exclude_file(item.name, item, EXCLUDE_FILES, EXCLUDE_EXTENSIONS):
                tree_lines.append(f"{prefix}{item.name} [EXCLUDED_FILE]")
                continue
            tree_lines.append(f"{prefix}{item.name}")
            
    return tree_lines


def main():
    project_root = Path(".") # –ó–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
    snapshot_content = []
    current_total_size = 0
    max_total_bytes = MAX_TOTAL_OUTPUT_SIZE_MB * 1024 * 1024

    # 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
    snapshot_content.append("=" * 30 + " PROJECT STRUCTURE " + "=" * 30)
    snapshot_content.append(f"{project_root.resolve().name}/")
    tree_str = "\n".join(get_dir_tree(project_root))
    snapshot_content.append(tree_str)
    snapshot_content.append("\n" + "=" * 70 + "\n")
    current_total_size += len(tree_str.encode(FILE_ENCODING, errors='ignore'))


    # 2. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
    for item_path in project_root.rglob("*"): # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫
        if current_total_size > max_total_bytes:
            snapshot_content.append("\n... (Total output size limit reached, stopping file content inclusion) ...\n")
            print(f"Warning: Total output size limit ({MAX_TOTAL_OUTPUT_SIZE_MB}MB) reached. Some file contents might be omitted.")
            break

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ rglob
        is_in_excluded_dir = False
        for part in item_path.relative_to(project_root).parts:
            if part in EXCLUDE_DIRS:
                is_in_excluded_dir = True
                break
        if is_in_excluded_dir and item_path.is_dir(): # –ï—Å–ª–∏ —Å–∞–º–∞ –ø–∞–ø–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–µ rglob
            continue
        if item_path.is_dir(): # –ï—Å–ª–∏ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤ –¥–µ—Ä–µ–≤–µ)
            if item_path.name in EXCLUDE_DIRS: # –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞
                 continue
            continue


        relative_path_str = str(item_path.relative_to(project_root))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        # –≠—Ç–æ –Ω—É–∂–Ω–æ, —Ç.–∫. rglob –º–æ–∂–µ—Ç –¥–∞—Ç—å —Ñ–∞–π–ª—ã –∏–∑ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ö–æ—Ç–∏–º –∏—Å–∫–ª—é—á–∏—Ç—å —Ü–µ–ª–∏–∫–æ–º
        parent_excluded = False
        for parent in item_path.parents:
            if parent.name in EXCLUDE_DIRS:
                parent_excluded = True
                break
        if parent_excluded:
            # print(f"Skipping (parent excluded): {relative_path_str}")
            continue
            
        if item_path.name in EXCLUDE_DIRS: # –ï—Å–ª–∏ —Å–∞–º —Ñ–∞–π–ª - —ç—Ç–æ –∏–º—è –∏—Å–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã)
            # print(f"Skipping (matches excluded dir name): {relative_path_str}")
            continue

        if should_exclude_file(item_path.name, item_path, EXCLUDE_FILES, EXCLUDE_EXTENSIONS):
            # print(f"Skipping (excluded file/ext): {relative_path_str}")
            continue
        
        snapshot_content.append("-" * 30 + f" FILE: {relative_path_str} " + "-" * 30)
        try:
            file_size = item_path.stat().st_size
            if file_size > MAX_FILE_SIZE_MB * 1024 * 1024:
                snapshot_content.append(f"[CONTENT OMITTED - File size ({file_size / (1024*1024):.2f} MB) > {MAX_FILE_SIZE_MB} MB]\n")
                print(f"Skipping content of large file: {relative_path_str}")
            else:
                with open(item_path, "r", encoding=FILE_ENCODING, errors="ignore") as f:
                    content = f.read()
                snapshot_content.append(content + "\n")
                current_total_size += len(content.encode(FILE_ENCODING, errors='ignore'))

        except Exception as e:
            snapshot_content.append(f"[ERROR READING FILE: {e}]\n")
            print(f"Error reading file {relative_path_str}: {e}")
        snapshot_content.append("\n" + "=" * 70 + "\n")


    # 3. –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
    try:
        with open(OUTPUT_FILENAME, "w", encoding=FILE_ENCODING) as f:
            f.write("\n".join(snapshot_content))
        print(f"Project snapshot saved to: {OUTPUT_FILENAME}")
        print(f"Approximate total output size: {current_total_size / (1024*1024):.2f} MB")

    except Exception as e:
        print(f"Error writing snapshot file: {e}")

if __name__ == "__main__":
    main()


======================================================================

------------------------------ FILE: Scripts/clean_cache.py ------------------------------
import os
import shutil
from pathlib import Path

def clean_pycache(start_path: str = "."):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ __pycache__ –∏ .pyc —Ñ–∞–π–ª—ã."""
    
    counter = {"dirs": 0, "files": 0}
    
    for root, dirs, files in os.walk(start_path):
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é .venv –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if ".venv" in root:
            continue
            
        # –£–¥–∞–ª—è–µ–º __pycache__ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if "__pycache__" in dirs:
            cache_path = Path(root) / "__pycache__"
            shutil.rmtree(cache_path)
            print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {cache_path}")
            counter["dirs"] += 1
            
        # –£–¥–∞–ª—è–µ–º .pyc —Ñ–∞–π–ª—ã
        for file in files:
            if file.endswith(".pyc"):
                file_path = Path(root) / file
                os.remove(file_path)
                print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª: {file_path}")
                counter["files"] += 1
    
    return counter

if __name__ == "__main__":
    # –ò–∑–º–µ–Ω—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    project_root = str(Path(__file__).parent.parent)
    print(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {project_root}")
    results = clean_pycache(project_root)
    
    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏:")
    print(f"- –£–¥–∞–ª–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π __pycache__: {results['dirs']}")
    print(f"- –£–¥–∞–ª–µ–Ω–æ .pyc —Ñ–∞–π–ª–æ–≤: {results['files']}")


======================================================================

------------------------------ FILE: .github/workflows/docker.yml ------------------------------
name: Docker Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          swiftdevbot:latest
          swiftdevbot:${{ github.sha }}
          swiftdevbot:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max




======================================================================

------------------------------ FILE: .github/workflows/ci.yml ------------------------------
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
    
    - name: Lint with pylint
      run: |
        pip install pylint
        pylint Systems/core Modules --disable=all --enable=E,F --exit-zero || true
    
    - name: Format check with black
      run: |
        pip install black
        black --check Systems/core Modules || true
    
    - name: Type check with mypy
      run: |
        pip install mypy
        mypy Systems/core Modules --ignore-missing-imports || true
    
    - name: Test with pytest
      run: |
        pytest --cov=Systems/core --cov=Modules --cov-report=xml --cov-report=term-missing || true
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  docker:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: swiftdevbot:test
        cache-from: type=gha
        cache-to: type=gha,mode=max




======================================================================

------------------------------ FILE: Systems/locales/ua.yaml ------------------------------
# Ukrainian translations for SwiftDevBot
# Format: key: value (YAML dictionary format)

# ========== MAIN MENU ==========
main_menu_title: "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é SwiftDevBot"
main_menu_reply_modules: "üóÇ –ú–æ–¥—É–ª—ñ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó"
main_menu_reply_profile: "üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å"
main_menu_reply_feedback: "‚úçÔ∏è –ó–≤'—è–∑–∞—Ç–∏—Å—è –∑ –Ω–∞–º–∏"
main_menu_reply_admin_panel: "üõ† –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è"
main_menu_inline_modules: "üóÇ –ú–æ–¥—É–ª—ñ"
main_menu_inline_profile: "üë§ –ü—Ä–æ—Ñ—ñ–ª—å"
main_menu_inline_feedback: "‚úçÔ∏è –ó–≤–æ—Ä–æ—Ç–Ω–∏–π –∑–≤'—è–∑–æ–∫"
main_menu_inline_admin_panel: "üõ† –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å"

# ========== MODULES LIST ==========
modules_list_no_modules: "ü§∑ –ú–æ–¥—É–ª—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ"
modules_list_title_template: "–î–æ—Å—Ç—É–ø–Ω—ñ –º–æ–¥—É–ª—ñ (–°—Ç–æ—Ä—ñ–Ω–∫–∞ {current_page}/{total_pages}):"
pagination_prev: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
pagination_next: "–î–∞–ª—ñ ‚û°Ô∏è"
navigation_back_to_main: "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é"
service_delete_message: "‚ùå –ó–∞–∫—Ä–∏—Ç–∏ —Ü–µ –º–µ–Ω—é"
confirm_yes: "‚úÖ –¢–∞–∫"
confirm_no: "‚ùå –ù—ñ"

# ========== WELCOME MESSAGE ==========
welcome_message_title: "üéâ –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ SwiftDevBot!"
welcome_message_body: "–Ø ‚Äî –≤–∞—à –º–æ–¥—É–ª—å–Ω–∏–π Telegram-–ø–æ–º—ñ—á–Ω–∏–∫, —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –∑–∞–≤–¥–∞–Ω—å.\n\nüîç **–©–æ —è –º–æ–∂—É?**\n–ú–æ—ó –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤. –¶–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏, —É—Ç–∏–ª—ñ—Ç–∏, —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ —Ç–∞ –±–∞–≥–∞—Ç–æ —ñ–Ω—à–æ–≥–æ.\n\nüîí **–ö–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å:**\n–Ø –æ–±—Ä–æ–±–ª—è—é –ª–∏—à–µ —Ç—ñ –¥–∞–Ω—ñ, —è–∫—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–ª—è –º–æ—î—ó —Ä–æ–±–æ—Ç–∏ —Ç–∞ —Ä–æ–±–æ—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤. –ú–∏ —Ü—ñ–Ω—É—î–º–æ –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å. –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤–∏ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ—Ç–µ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ—Ç–∞.\n\n–ù–∞—Ç–∏—Å–∫–∞—é—á–∏ ¬´–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏¬ª, –≤–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—è –∑ —Ç–∏–º, —â–æ –±–æ—Ç –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤–∞—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –Ω–∞–¥–∞–Ω–Ω—è —Å–≤–æ—ó—Ö —Ñ—É–Ω–∫—Ü—ñ–π."
welcome_button_continue: "‚úÖ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏"
welcome_button_cancel: "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏"
registration_cancelled_message: "–î—É–∂–µ —à–∫–æ–¥–∞, —â–æ –≤–∏ –ø–µ—Ä–µ–¥—É–º–∞–ª–∏. –Ø–∫—â–æ –Ω–∞–¥—É–º–∞—î—Ç–µ –∑–Ω–æ–≤—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å /start."
user_middleware_please_register: "üëã –°—Ö–æ–∂–µ, –≤–∏ —â–µ –Ω–µ –∑–Ω–∞–π–æ–º—ñ –∑—ñ –º–Ω–æ—é! –©–æ–± –ø–æ—á–∞—Ç–∏, –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å /start –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É /start."

# ========== PROFILE ==========
profile_title: "üë§ –í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å"
profile_info_template: "üÜî –í–∞—à Telegram ID: {user_id}\nüìù –Ü–º'—è: {full_name}\nüë§ Username: @{username}\nüìÖ –î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: {registration_date}\nüó£ –ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É: {current_language}"
profile_no_username: "–Ω–µ –≤–∫–∞–∑–∞–Ω–æ"
profile_no_reg_date: "–Ω–µ–≤—ñ–¥–æ–º–æ"
profile_button_change_language: "üåê –ó–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É"
profile_select_language_title: "–í–∏–±–µ—Ä—ñ—Ç—å –º–æ–≤—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É:"
profile_language_changed: "–ú–æ–≤—É –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ {lang}"
profile_language_change_error: "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–æ–≤–∏."
profile_language_already_set: "–ú–æ–≤–∞ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {lang}."
profile_language_user_not_found: "–ü–æ–º–∏–ª–∫–∞: –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–æ–≤–∏."

# ========== COMMON MESSAGES ==========
main_menu_greeting: "–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º, {user_name}! –í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é:"
main_menu_text: "–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:"
feedback_request: "‚úçÔ∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É.\n*–î–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –≤–≤–µ–¥—ñ—Ç—å /cancel_feedback*"
feedback_cancelled: "–í–≤–µ–¥–µ–Ω–Ω—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ."
feedback_thanks: "–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à –≤—ñ–¥–≥—É–∫! –ú–∏ –π–æ–≥–æ –æ—Ç—Ä–∏–º–∞–ª–∏."
feedback_sent: "–ó–≤–æ—Ä–æ—Ç–Ω–∏–π –∑–≤'—è–∑–æ–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ."
error_general: "‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
error_no_access: "‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É"
error_permission_denied: "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ"

# ========== HELP COMMAND ==========
help_title: "‚ùì –î–æ–≤—ñ–¥–∫–∞ —Ç–∞ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞"
help_main_commands: "üìã –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
help_module_commands: "üß© –ö–æ–º–∞–Ω–¥–∏ –º–æ–¥—É–ª—ñ–≤:"
help_tip_menu: "üí° –ü–æ—Ä–∞–¥–∞: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ñ—É–Ω–∫—Ü—ñ–π."
help_tip_start: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /start, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é."

# ========== LANGUAGE NAMES ==========
language_en: "English"
language_ua: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞"
language_ru: "–†–æ—Å—ñ–π—Å—å–∫–∞"

# ========== ADMIN PANEL ==========
admin_panel_title: "üõ† –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å SwiftDevBot"
admin_panel_select_section: "–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è:"
admin_no_access: "üö´ –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ.\n\n–Ø–∫—â–æ –≤–∏ –≤–≤–∞–∂–∞—î—Ç–µ, —â–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ—Ç–∞."
admin_modules_in_development: "–†–æ–∑–¥—ñ–ª '–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–æ–¥—É–ª—è–º–∏' –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ."

# ========== ADMIN COMMON TEXTS ==========
admin_back_to_main_menu_sdb: "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é SDB"
admin_back_to_admin_menu_main: "‚¨ÖÔ∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å (–ì–æ–ª–æ–≤–Ω–∞)"
admin_pagination_prev: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
admin_pagination_next: "–î–∞–ª—ñ ‚û°Ô∏è"
admin_confirm_yes: "‚úÖ –¢–∞–∫"
admin_confirm_no: "‚ùå –ù—ñ"
admin_close_message: "‚ùå –ó–∞–∫—Ä–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
admin_error_general: "–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
admin_access_denied: "–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó."
admin_not_found_generic: "–ó–∞–ø–∏—Ç–∞–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."

# ========== ADMIN MENU BUTTONS ==========
admin_system_info: "‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É"
admin_manage_modules: "üß© –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–æ–¥—É–ª—è–º–∏"
admin_manage_users: "üë• –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏"
admin_manage_roles: "üõ°Ô∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–ª—è–º–∏"

# ========== ADMIN PERMISSIONS ==========
admin_perm_category_core: "–î–æ–∑–≤–æ–ª–∏ –Ø–¥—Ä–∞"
admin_perm_category_modules: "–î–æ–∑–≤–æ–ª–∏ –ú–æ–¥—É–ª—ñ–≤"
admin_perm_core_group_users: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–Ø–¥—Ä–æ)"
admin_perm_core_group_roles: "–†–æ–ª—ñ (–Ø–¥—Ä–æ)"
admin_perm_core_group_modules_core: "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–æ–¥—É–ª—è–º–∏ (–Ø–¥—Ä–æ)"
admin_perm_core_group_system: "–°–∏—Å—Ç–µ–º–∞ (–Ø–¥—Ä–æ)"
admin_perm_core_group_settings_core: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ø–¥—Ä–∞"
admin_perm_core_group_other: "–Ü–Ω—à—ñ (–Ø–¥—Ä–æ)"
admin_back_to_perm_categories: "‚¨ÖÔ∏è –î–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–æ–∑–≤–æ–ª—ñ–≤"
admin_back_to_core_perm_groups: "‚¨ÖÔ∏è –î–æ –≥—Ä—É–ø –Ø–¥—Ä–∞"
admin_back_to_module_list_for_perms: "‚¨ÖÔ∏è –î–æ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª—ñ–≤ (–¥–ª—è –ø—Ä–∞–≤)"
admin_no_modules_with_perms: "–ù–µ–º–∞—î –º–æ–¥—É–ª—ñ–≤ –∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º–∏ –ø—Ä–∞–≤"
admin_no_permissions_in_group: "–£ —Ü—ñ–π –≥—Ä—É–ø—ñ –Ω–µ–º–∞—î –¥–æ–∑–≤–æ–ª—ñ–≤"

# ========== ADMIN FSM ROLE CREATION ==========
admin_fsm_enter_role_name: "–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –Ω–æ–≤–æ—ó —Ä–æ–ª—ñ:"
admin_fsm_role_name_empty: "–Ü–º'—è —Ä–æ–ª—ñ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º."
admin_fsm_role_name_taken: "–†–æ–ª—å –∑ —ñ–º'—è–º \"{role_name}\" –≤–∂–µ —ñ—Å–Ω—É—î."
admin_fsm_enter_role_description: "–í–≤–µ–¥—ñ—Ç—å –æ–ø–∏—Å –¥–ª—è —Ä–æ–ª—ñ {role_name}:"
admin_fsm_command_skip_description: "/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏"
admin_fsm_command_cancel_role_creation: "/cancel_role_creation - –°–∫–∞—Å—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è"
admin_fsm_role_created_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∞!"
admin_fsm_role_creation_cancelled: "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–ª—ñ —Å–∫–∞—Å–æ–≤–∞–Ω–æ."

# ========== ADMIN FSM ROLE EDITING ==========
admin_fsm_edit_role_title: "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–ª—ñ: {role_name}"
admin_fsm_edit_role_name_not_allowed: "–Ü–º'—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó —Ä–æ–ª—ñ {role_name} –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞."
admin_fsm_enter_new_role_description: "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –æ–ø–∏—Å –¥–ª—è —Ä–æ–ª—ñ {role_name} (–ø–æ—Ç–æ—á–Ω–∏–π: {current_description}):"
admin_fsm_enter_new_role_name: "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ —ñ–º'—è –¥–ª—è —Ä–æ–ª—ñ (–ø–æ—Ç–æ—á–Ω–µ: {current_name}):"
admin_fsm_command_skip_name: "/skip_name - –ó–∞–ª–∏—à–∏—Ç–∏ —è–∫ —î"
admin_fsm_command_cancel_role_edit: "/cancel_role_edit - –°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è"
admin_fsm_role_updated_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–∞!"
admin_fsm_role_update_cancelled: "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–ª—ñ —Å–∫–∞—Å–æ–≤–∞–Ω–æ."

# ========== ADMIN ROLE DELETION ==========
admin_delete_role_confirm_text: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞!"
admin_role_is_standard_cant_delete: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —Ä–æ–ª—å \"{role_name}\" –≤–∏–¥–∞–ª—è—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞."
admin_role_delete_failed: "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å \"{role_name}\"."
admin_role_deleted_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–∞."

# ========== ADMIN USERS MANAGEMENT ==========
admin_user_list_title_template: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–°—Ç—Ä. {current_page}/{total_pages})"
admin_user_details_title: "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
admin_user_action_change_roles: "–ó–º—ñ–Ω–∏—Ç–∏ —Ä–æ–ª—ñ"
admin_user_action_toggle_active: "–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: {status}"
admin_user_action_toggle_blocked: "–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è: {status}"
admin_edit_roles_for_user: "–ó–º—ñ–Ω–∞ —Ä–æ–ª–µ–π –¥–ª—è: {user_name}"
admin_back_to_user_details: "‚¨ÖÔ∏è –î–æ –¥–µ—Ç–∞–ª–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
admin_user_is_owner_text: "üëë –í–ª–∞—Å–Ω–∏–∫ —Å–∏—Å—Ç–µ–º–∏ (–Ω–µ–∑–º—ñ–Ω–Ω–∏–π)"
admin_user_action_direct_perms: "üíé –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏"
admin_edit_direct_perms_for_user: "üíé –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è: {user_name}"
admin_perm_status_direct: "‚úÖ (–ø—Ä—è–º–∏–π)"
admin_perm_status_role: "‚òëÔ∏è (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)"
admin_perm_status_none: "‚¨ú (–Ω–µ–º–∞—î)"
admin_back_to_direct_perm_categories: "‚¨ÖÔ∏è –î–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–æ–∑–≤–æ–ª—ñ–≤ (–¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)"
admin_back_to_direct_perm_core_groups: "‚¨ÖÔ∏è –î–æ –≥—Ä—É–ø –Ø–¥—Ä–∞ (–¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)"
admin_back_to_direct_perm_module_list: "‚¨ÖÔ∏è –î–æ –º–æ–¥—É–ª—ñ–≤ (–¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)"
admin_no_users_to_display: "–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è"
admin_user_active_yes: "–¢–∞–∫ ‚úÖ"
admin_user_active_no: "–ù—ñ üí§"
admin_user_blocked_yes: "–¢–∞–∫ üö´"
admin_user_blocked_no: "–ù—ñ ‚úÖ"
admin_user_no_roles: "–Ω–µ–º–∞—î"
admin_user_telegram_id: "Telegram ID"
admin_user_db_id: "DB ID"
admin_user_username: "Username"
admin_user_first_name: "–Ü–º'—è"
admin_user_last_name: "–ü—Ä—ñ–∑–≤–∏—â–µ"
admin_user_language: "–ú–æ–≤–∞"
admin_user_active: "–ê–∫—Ç–∏–≤–Ω–∏–π"
admin_user_bot_blocked: "–ë–æ—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π"
admin_user_roles_status: "–†–æ–ª—ñ/–°—Ç–∞—Ç—É—Å"
admin_user_registration: "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è"
admin_user_last_activity: "–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å"

# ========== ADMIN USERS ERRORS ==========
admin_error_invalid_user_id_format: "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞."
admin_error_user_id_not_specified: "–ü–æ–º–∏–ª–∫–∞: ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ."
admin_error_user_id_for_roles_not_specified: "–ü–æ–º–∏–ª–∫–∞: ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–ª–µ–π –Ω–µ –≤–∫–∞–∑–∞–Ω–æ."
admin_error_invalid_user_id: "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ—Ä–Ω–∏–π ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞."
admin_error_cannot_change_owner_roles: "–†–æ–ª—ñ –í–ª–∞—Å–Ω–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏ –Ω–µ –∑–º—ñ–Ω—é—é—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ü–µ–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å."
admin_error_cannot_modify_owner_roles: "–ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–æ–ª—ñ –í–ª–∞—Å–Ω–∏–∫–∞."
admin_error_cannot_remove_last_role: "–ù–µ –º–æ–∂–Ω–∞ –∑–Ω—è—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é —Ä–æ–ª—å '{role_name}'."
admin_error_invalid_role_data: "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –∑–º—ñ–Ω–∏ —Ä–æ–ª—ñ."
admin_error_cannot_manage_owner_direct_perms: "–ù–µ –º–æ–∂–Ω–∞ –∫–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä—è–º–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –í–ª–∞—Å–Ω–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏."
admin_error_cannot_modify_owner_direct_perms: "–ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø—Ä—è–º—ñ –¥–æ–∑–≤–æ–ª–∏ –í–ª–∞—Å–Ω–∏–∫–∞."
admin_error_fsm_state: "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞–Ω—É FSM. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–π—Ç–∏ —Ç–∞ —É–≤—ñ–π—Ç–∏ –∑–Ω–æ–≤—É."
admin_error_fsm_state_user_id: "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞–Ω—É FSM (ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)."
admin_error_fsm_state_role_id: "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞–Ω—É FSM (ID —Ä–æ–ª—ñ)."
admin_error_invalid_permission_data: "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–æ–∑–≤–æ–ª—É."
admin_error_getting_users_data: "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤."
admin_error_display: "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è."
admin_error_cannot_change_owner_status: "–ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –í–ª–∞—Å–Ω–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏."
admin_error_cannot_change_owner_block_status: "–ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –í–ª–∞—Å–Ω–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏."
admin_error_saving: "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è."
admin_role_removed: "–†–æ–ª—å '{role_name}' –∑–Ω—è—Ç–æ."
admin_role_failed_to_remove: "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω—è—Ç–∏ —Ä–æ–ª—å '{role_name}'."
admin_role_assigned: "–†–æ–ª—å '{role_name}' –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ."
admin_role_failed_to_assign: "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–æ–ª—å '{role_name}'."
admin_direct_perm_removed: "–ü—Ä—è–º–∏–π –¥–æ–∑–≤—ñ–ª '{permission_name}' –∑–Ω—è—Ç–æ."
admin_direct_perm_failed_to_remove: "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω—è—Ç–∏ –ø—Ä—è–º–∏–π –¥–æ–∑–≤—ñ–ª '{permission_name}'."
admin_direct_perm_assigned: "–ü—Ä—è–º–∏–π –¥–æ–∑–≤—ñ–ª '{permission_name}' –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ."
admin_direct_perm_failed_to_assign: "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä—è–º–∏–π –¥–æ–∑–≤—ñ–ª '{permission_name}'."
admin_user_status_active_changed: "–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ {user_name} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: {status}"
admin_user_status_active_not_changed: "–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–µ –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ."
admin_user_block_status_changed: "–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –¥–ª—è {user_name} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: {status}"
admin_user_block_status_not_changed: "–°—Ç–∞—Ç—É—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–µ –∑–º—ñ–Ω–µ–Ω–æ."

# ========== ADMIN ROLES MANAGEMENT ==========
admin_role_list_title: "üõ°Ô∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–ª—è–º–∏"
admin_role_list_select_action: "–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∞–±–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è:"
admin_role_list_no_roles: "–ù–µ–º–∞—î —Ä–æ–ª–µ–π –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è"
admin_role_details_title: "üõ°Ô∏è –î–µ—Ç–∞–ª—ñ —Ä–æ–ª—ñ"
admin_role_action_edit_permissions: "–ó–º—ñ–Ω–∏—Ç–∏ –¥–æ–∑–≤–æ–ª–∏"
admin_role_action_edit_role: "‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ä–æ–ª—å"
admin_role_action_delete_role: "üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å"
admin_back_to_roles_list: "‚¨ÖÔ∏è –î–æ —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π"
admin_edit_permissions_for_role: "–î–æ–∑–≤–æ–ª–∏ –¥–ª—è —Ä–æ–ª—ñ: {role_name}"
admin_role_action_create_role: "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–æ–ª—å"
admin_error_role_id_not_specified: "–ü–æ–º–∏–ª–∫–∞: ID —Ä–æ–ª—ñ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ."
admin_error_role_id_invalid: "–ü–æ–º–∏–ª–∫–∞: ID —Ä–æ–ª—ñ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π."
admin_error_no_permission_to_view_roles: "–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π."
admin_error_checking_permissions: "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∞–≤."
admin_error_displaying_role_list: "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π."
admin_error_displaying_list: "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É."
admin_permission_removed_from_role: "–î–æ–∑–≤—ñ–ª '{permission_name}' –∑–Ω—è—Ç–æ –∑ —Ä–æ–ª—ñ."
admin_permission_failed_to_remove_from_role: "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω—è—Ç–∏ –¥–æ–∑–≤—ñ–ª '{permission_name}'."

# ========== ADMIN MODULES MANAGEMENT ==========
admin_modules_back_to_admin_panel: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å"
admin_modules_back_to_modules_list: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª—ñ–≤"
admin_modules_back_to_module_info: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó"
admin_modules_toggle_disable: "‚ùå –í–∏–º–∫–Ω—É—Ç–∏"
admin_modules_toggle_enable: "‚úÖ –£–≤—ñ–º–∫–Ω—É—Ç–∏"
admin_modules_actions: "üîß –î—ñ—ó"
admin_modules_clean_tables: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ"
admin_modules_error_no_module_loader: "–ü–æ–º–∏–ª–∫–∞: –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á –º–æ–¥—É–ª—ñ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π."

# ========== ADMIN LOGS VIEWER ==========
admin_logs_back_to_admin_panel: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å"
admin_logs_back_to_files_list: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª—ñ–≤"
admin_logs_back_to_file_info: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ñ–∞–π–ª"
admin_logs_view_content: "üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤–º—ñ—Å—Ç"
admin_logs_download_file: "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª"

# ========== ADMIN SYSTEM INFO ==========
admin_sys_info_title: "üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è SwiftDevBot"
admin_sys_info_general: "‚ÑπÔ∏è –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"
admin_sys_info_bot_process: "ü§ñ –ü—Ä–æ—Ü–µ—Å –±–æ—Ç–∞"
admin_sys_info_sdb_core: "SDB Core"
admin_sys_info_python: "Python"
admin_sys_info_aiogram: "Aiogram"
admin_sys_info_os: "–û–°"
admin_sys_info_uptime: "–ß–∞—Å —Ä–æ–±–æ—Ç–∏"
admin_sys_info_pid: "PID"
admin_sys_info_cpu_percent: "CPU"
admin_sys_info_memory: "–ü–∞–º'—è—Ç—å"
admin_sys_info_database: "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö"
admin_sys_info_db_type: "–¢–∏–ø –ë–î"
admin_sys_info_db_status: "–°—Ç–∞—Ç—É—Å"
admin_sys_info_users: "üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ"
admin_sys_info_total_users: "–í—Å—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤"
admin_sys_info_modules: "üß© –ú–æ–¥—É–ª—ñ"
admin_sys_info_total_modules: "–í—Å—å–æ–≥–æ –º–æ–¥—É–ª—ñ–≤"
admin_sys_info_enabled_modules: "–ê–∫—Ç–∏–≤–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤"
admin_sys_info_process_not_found: "–ü—Ä–æ—Ü–µ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
admin_sys_info_na: "–ù/–î"



======================================================================

------------------------------ FILE: Systems/locales/en.yaml ------------------------------
# English translations for SwiftDevBot
# Format: key: value (YAML dictionary format)

# ========== MAIN MENU ==========
main_menu_title: "üè† Main Menu SwiftDevBot"
main_menu_reply_modules: "üóÇ Modules and Features"
main_menu_reply_profile: "üë§ My Profile"
main_menu_reply_feedback: "‚úçÔ∏è Contact Us"
main_menu_reply_admin_panel: "üõ† Administration"
main_menu_inline_modules: "üóÇ Modules"
main_menu_inline_profile: "üë§ Profile"
main_menu_inline_feedback: "‚úçÔ∏è Feedback"
main_menu_inline_admin_panel: "üõ† Admin Panel"

# ========== MODULES LIST ==========
modules_list_no_modules: "ü§∑ No modules available"
modules_list_title_template: "Available Modules (Page {current_page}/{total_pages}):"
pagination_prev: "‚¨ÖÔ∏è Prev"
pagination_next: "Next ‚û°Ô∏è"
navigation_back_to_main: "üè† Main Menu"
service_delete_message: "‚ùå Close this menu"
confirm_yes: "‚úÖ Yes"
confirm_no: "‚ùå No"

# ========== WELCOME MESSAGE ==========
welcome_message_title: "üéâ Welcome to SwiftDevBot!"
welcome_message_body: "I am your modular Telegram assistant, created to extend functionality and automate tasks.\n\nüîç **What can I do?**\nMy capabilities depend on the connected modules. These can be development tools, utilities, information services, and much more.\n\nüîí **Privacy:**\nI process only the data necessary for my work and the work of active modules. We value your privacy. For more information, you can always contact the bot administrator.\n\nBy clicking \"Continue\", you agree that the bot will process your messages to provide its functions."
welcome_button_continue: "‚úÖ Continue"
welcome_button_cancel: "‚ùå Cancel"
registration_cancelled_message: "We're sorry you changed your mind. If you change your mind again, just type /start."
user_middleware_please_register: "üëã It seems you haven't met me yet! To get started, please press /start or type the /start command."

# ========== PROFILE ==========
profile_title: "üë§ Your Profile"
profile_info_template: "üÜî Your Telegram ID: {user_id}\nüìù Name: {full_name}\nüë§ Username: @{username}\nüìÖ Registration date: {registration_date}\nüó£ Interface language: {current_language}"
profile_no_username: "not specified"
profile_no_reg_date: "unknown"
profile_button_change_language: "üåê Change Language"
profile_select_language_title: "Select interface language:"
profile_language_changed: "Language changed to {lang}"
profile_language_change_error: "Error saving language."
profile_language_already_set: "Language is already set to {lang}."
profile_language_user_not_found: "Error: user not found for language update."

# ========== COMMON MESSAGES ==========
main_menu_greeting: "Welcome back, {user_name}! Choose an action:"
main_menu_text: "Main Menu:"
feedback_request: "‚úçÔ∏è Please write your message for feedback.\n*To cancel, enter /cancel_feedback*"
feedback_cancelled: "Feedback input cancelled."
feedback_thanks: "Thank you for your feedback! We received it."
feedback_sent: "Feedback sent successfully."
error_general: "‚ùå An error occurred. Please try again later."
error_no_access: "‚ùå You don't have access"
error_permission_denied: "‚ùå Permission denied"

# ========== HELP COMMAND ==========
help_title: "‚ùì Help and Bot Commands"
help_main_commands: "üìã Main Commands:"
help_module_commands: "üß© Module Commands:"
help_tip_menu: "üí° Tip: Use the main menu buttons for quick access to functions."
help_tip_start: "Press /start to open the main menu."

# ========== LANGUAGE NAMES ==========
language_en: "English"
language_ua: "Ukrainian"
language_ru: "Russian"

# ========== ADMIN PANEL ==========
admin_panel_title: "üõ† SwiftDevBot Administrative Panel"
admin_panel_select_section: "Select a section to manage:"
admin_no_access: "üö´ You do not have access to the administrative panel.\n\nIf you believe this is an error, please contact the bot administrator."
admin_modules_in_development: "The 'Module Management' section is under development."

# ========== ADMIN COMMON TEXTS ==========
admin_back_to_main_menu_sdb: "üè† SDB Main Menu"
admin_back_to_admin_menu_main: "‚¨ÖÔ∏è Admin Panel (Main)"
admin_pagination_prev: "‚¨ÖÔ∏è Prev"
admin_pagination_next: "Next ‚û°Ô∏è"
admin_confirm_yes: "‚úÖ Yes"
admin_confirm_no: "‚ùå No"
admin_close_message: "‚ùå Close this message"
admin_error_general: "An error occurred. Please try again later."
admin_access_denied: "You do not have permission for this action."
admin_not_found_generic: "The requested item was not found."

# ========== ADMIN MENU BUTTONS ==========
admin_system_info: "‚ÑπÔ∏è System Information"
admin_manage_modules: "üß© Module Management"
admin_manage_users: "üë• User Management"
admin_manage_roles: "üõ°Ô∏è Role Management"

# ========== ADMIN PERMISSIONS ==========
admin_perm_category_core: "Core Permissions"
admin_perm_category_modules: "Module Permissions"
admin_perm_core_group_users: "Users (Core)"
admin_perm_core_group_roles: "Roles (Core)"
admin_perm_core_group_modules_core: "Module Management (Core)"
admin_perm_core_group_system: "System (Core)"
admin_perm_core_group_settings_core: "Core Settings"
admin_perm_core_group_other: "Other (Core)"
admin_back_to_perm_categories: "‚¨ÖÔ∏è To Permission Categories"
admin_back_to_core_perm_groups: "‚¨ÖÔ∏è To Core Groups"
admin_back_to_module_list_for_perms: "‚¨ÖÔ∏è To Module List (for permissions)"
admin_no_modules_with_perms: "No modules with permission declarations"
admin_no_permissions_in_group: "This group has no permissions"

# ========== ADMIN FSM ROLE CREATION ==========
admin_fsm_enter_role_name: "Enter the name of the new role:"
admin_fsm_role_name_empty: "Role name cannot be empty."
admin_fsm_role_name_taken: "A role with the name \"{role_name}\" already exists."
admin_fsm_enter_role_description: "Enter a description for role {role_name}:"
admin_fsm_command_skip_description: "/skip_description - Skip"
admin_fsm_command_cancel_role_creation: "/cancel_role_creation - Cancel creation"
admin_fsm_role_created_successfully: "Role \"{role_name}\" created successfully!"
admin_fsm_role_creation_cancelled: "Role creation cancelled."

# ========== ADMIN FSM ROLE EDITING ==========
admin_fsm_edit_role_title: "Editing role: {role_name}"
admin_fsm_edit_role_name_not_allowed: "Cannot change the name of standard role {role_name}."
admin_fsm_enter_new_role_description: "Enter a new description for role {role_name} (current: {current_description}):"
admin_fsm_enter_new_role_name: "Enter a new name for the role (current: {current_name}):"
admin_fsm_command_skip_name: "/skip_name - Leave as is"
admin_fsm_command_cancel_role_edit: "/cancel_role_edit - Cancel editing"
admin_fsm_role_updated_successfully: "Role \"{role_name}\" updated successfully!"
admin_fsm_role_update_cancelled: "Role editing cancelled."

# ========== ADMIN ROLE DELETION ==========
admin_delete_role_confirm_text: "Are you sure you want to delete role {role_name}?\n{warning_if_users}\nThis action is irreversible!"
admin_role_is_standard_cant_delete: "Cannot delete standard role \"{role_name}\"."
admin_role_delete_failed: "Failed to delete role \"{role_name}\"."
admin_role_deleted_successfully: "Role \"{role_name}\" deleted successfully."

# ========== ADMIN USERS MANAGEMENT ==========
admin_user_list_title_template: "Users (Page {current_page}/{total_pages})"
admin_user_details_title: "User Information"
admin_user_action_change_roles: "Change Roles"
admin_user_action_toggle_active: "Active: {status}"
admin_user_action_toggle_blocked: "Blocked: {status}"
admin_edit_roles_for_user: "Changing roles for: {user_name}"
admin_back_to_user_details: "‚¨ÖÔ∏è To User Details"
admin_user_is_owner_text: "üëë System Owner (immutable)"
admin_user_action_direct_perms: "üíé Direct Permissions"
admin_edit_direct_perms_for_user: "üíé Direct Permissions for: {user_name}"
admin_perm_status_direct: "‚úÖ (direct)"
admin_perm_status_role: "‚òëÔ∏è (via role)"
admin_perm_status_none: "‚¨ú (none)"
admin_back_to_direct_perm_categories: "‚¨ÖÔ∏è To Permission Categories (for user)"
admin_back_to_direct_perm_core_groups: "‚¨ÖÔ∏è To Core Groups (for user)"
admin_back_to_direct_perm_module_list: "‚¨ÖÔ∏è To Modules (for user)"
admin_no_users_to_display: "No users to display"
admin_user_active_yes: "Yes ‚úÖ"
admin_user_active_no: "No üí§"
admin_user_blocked_yes: "Yes üö´"
admin_user_blocked_no: "No ‚úÖ"
admin_user_no_roles: "none"
admin_user_telegram_id: "Telegram ID"
admin_user_db_id: "DB ID"
admin_user_username: "Username"
admin_user_first_name: "First Name"
admin_user_last_name: "Last Name"
admin_user_language: "Language"
admin_user_active: "Active"
admin_user_bot_blocked: "Bot Blocked"
admin_user_roles_status: "Roles/Status"
admin_user_registration: "Registration"
admin_user_last_activity: "Last Activity"

# ========== ADMIN USERS ERRORS ==========
admin_error_invalid_user_id_format: "Error: invalid user ID format."
admin_error_user_id_not_specified: "Error: user ID not specified."
admin_error_user_id_for_roles_not_specified: "Error: user ID for editing roles not specified."
admin_error_invalid_user_id: "Error: invalid user ID."
admin_error_cannot_change_owner_roles: "System Owner roles cannot be changed through this interface."
admin_error_cannot_modify_owner_roles: "Cannot modify Owner roles."
admin_error_cannot_remove_last_role: "Cannot remove the last role '{role_name}'."
admin_error_invalid_role_data: "Error: invalid data for changing role."
admin_error_cannot_manage_owner_direct_perms: "Cannot manage System Owner direct permissions."
admin_error_cannot_modify_owner_direct_perms: "Cannot modify Owner direct permissions."
admin_error_fsm_state: "FSM state error. Please exit and enter again."
admin_error_fsm_state_user_id: "FSM state error (user ID)."
admin_error_fsm_state_role_id: "FSM state error (role ID)."
admin_error_invalid_permission_data: "Error: invalid data for changing permission."
admin_error_getting_users_data: "Error getting user data."
admin_error_display: "Display error."
admin_error_cannot_change_owner_status: "Cannot change System Owner status."
admin_error_cannot_change_owner_block_status: "Cannot change System Owner block status."
admin_error_saving: "Error saving."
admin_role_removed: "Role '{role_name}' removed."
admin_role_failed_to_remove: "Failed to remove role '{role_name}'."
admin_role_assigned: "Role '{role_name}' assigned."
admin_role_failed_to_assign: "Failed to assign role '{role_name}'."
admin_direct_perm_removed: "Direct permission '{permission_name}' removed."
admin_direct_perm_failed_to_remove: "Failed to remove direct permission '{permission_name}'."
admin_direct_perm_assigned: "Direct permission '{permission_name}' assigned."
admin_direct_perm_failed_to_assign: "Failed to assign direct permission '{permission_name}'."
admin_user_status_active_changed: "Active status for {user_name} changed to: {status}"
admin_user_status_active_not_changed: "Active status was not changed."
admin_user_block_status_changed: "Block status for {user_name} changed to: {status}"
admin_user_block_status_not_changed: "Block status not changed."

# ========== ADMIN ROLES MANAGEMENT ==========
admin_role_list_title: "üõ°Ô∏è Role Management"
admin_role_list_select_action: "Select a role to view or manage:"
admin_role_list_no_roles: "No roles to display"
admin_role_details_title: "üõ°Ô∏è Role Details"
admin_role_action_edit_permissions: "Edit Permissions"
admin_role_action_edit_role: "‚úèÔ∏è Edit Role"
admin_role_action_delete_role: "üóëÔ∏è Delete Role"
admin_back_to_roles_list: "‚¨ÖÔ∏è To Roles List"
admin_edit_permissions_for_role: "Permissions for role: {role_name}"
admin_role_action_create_role: "‚ûï Create Role"
admin_error_role_id_not_specified: "Error: role ID not specified."
admin_error_role_id_invalid: "Error: role ID not specified or invalid."
admin_error_no_permission_to_view_roles: "You do not have permission to view the roles list."
admin_error_checking_permissions: "Error checking permissions."
admin_error_displaying_role_list: "Error displaying roles list."
admin_error_displaying_list: "Error displaying list."
admin_permission_removed_from_role: "Permission '{permission_name}' removed from role."
admin_permission_failed_to_remove_from_role: "Failed to remove permission '{permission_name}'."

# ========== ADMIN MODULES MANAGEMENT ==========
admin_modules_back_to_admin_panel: "‚¨ÖÔ∏è Back to Admin Panel"
admin_modules_back_to_modules_list: "‚¨ÖÔ∏è Back to Modules List"
admin_modules_back_to_module_info: "‚¨ÖÔ∏è Back to Information"
admin_modules_toggle_disable: "‚ùå Disable"
admin_modules_toggle_enable: "‚úÖ Enable"
admin_modules_actions: "üîß Actions"
admin_modules_clean_tables: "üóëÔ∏è Clean Tables"
admin_modules_error_no_module_loader: "Error: Module loader unavailable."

# ========== ADMIN LOGS VIEWER ==========
admin_logs_back_to_admin_panel: "‚¨ÖÔ∏è Back to Admin Panel"
admin_logs_back_to_files_list: "‚¨ÖÔ∏è Back to Files List"
admin_logs_back_to_file_info: "‚¨ÖÔ∏è Back to File Information"
admin_logs_view_content: "üëÅÔ∏è View Content"
admin_logs_download_file: "üì• Download File"

# ========== ADMIN SYSTEM INFO ==========
admin_sys_info_title: "üñ•Ô∏è SwiftDevBot System Information"
admin_sys_info_general: "‚ÑπÔ∏è General Information"
admin_sys_info_bot_process: "ü§ñ Bot Process"
admin_sys_info_sdb_core: "SDB Core"
admin_sys_info_python: "Python"
admin_sys_info_aiogram: "Aiogram"
admin_sys_info_os: "OS"
admin_sys_info_uptime: "Uptime"
admin_sys_info_pid: "PID"
admin_sys_info_cpu_percent: "CPU"
admin_sys_info_memory: "Memory"
admin_sys_info_database: "üóÑÔ∏è Database"
admin_sys_info_db_type: "DB Type"
admin_sys_info_db_status: "Status"
admin_sys_info_users: "üë• Users"
admin_sys_info_total_users: "Total Users"
admin_sys_info_modules: "üß© Modules"
admin_sys_info_total_modules: "Total Modules"
admin_sys_info_enabled_modules: "Enabled Modules"
admin_sys_info_process_not_found: "Process not found"
admin_sys_info_na: "N/A"



======================================================================

------------------------------ FILE: Systems/locales/ru.yaml ------------------------------
# Russian translations for SwiftDevBot (default)
# Format: key: value (YAML dictionary format)

# ========== MAIN MENU ==========
main_menu_title: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SwiftDevBot"
main_menu_reply_modules: "üóÇ –ú–æ–¥—É–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏"
main_menu_reply_profile: "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"
main_menu_reply_feedback: "‚úçÔ∏è –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏"
main_menu_reply_admin_panel: "üõ† –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ"
main_menu_inline_modules: "üóÇ –ú–æ–¥—É–ª–∏"
main_menu_inline_profile: "üë§ –ü—Ä–æ—Ñ–∏–ª—å"
main_menu_inline_feedback: "‚úçÔ∏è –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
main_menu_inline_admin_panel: "üõ† –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å"

# ========== MODULES LIST ==========
modules_list_no_modules: "ü§∑ –ú–æ–¥—É–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
modules_list_title_template: "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏ (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page}/{total_pages}):"
pagination_prev: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
pagination_next: "–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è"
navigation_back_to_main: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
service_delete_message: "‚ùå –ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –º–µ–Ω—é"
confirm_yes: "‚úÖ –î–∞"
confirm_no: "‚ùå –ù–µ—Ç"

# ========== WELCOME MESSAGE ==========
welcome_message_title: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SwiftDevBot!"
welcome_message_body: "–Ø ‚Äî –≤–∞—à –º–æ–¥—É–ª—å–Ω—ã–π Telegram-–ø–æ–º–æ—â–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á.\n\nüîç **–ß—Ç–æ —è –º–æ–≥—É?**\n–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. –≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —É—Ç–∏–ª–∏—Ç—ã, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n\nüîí **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:**\n–Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –º–æ–µ–π —Ä–∞–±–æ—Ç—ã –∏ —Ä–∞–±–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. –ú—ã —Ü–µ–Ω–∏–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–æ—Ç–∞.\n\n–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º, —á—Ç–æ –±–æ—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π."
welcome_button_continue: "‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
welcome_button_cancel: "‚ùå –û—Ç–º–µ–Ω–∞"
registration_cancelled_message: "–û—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏. –ï—Å–ª–∏ –Ω–∞–¥—É–º–∞–µ—Ç–µ —Å–Ω–æ–≤–∞, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /start."
user_middleware_please_register: "üëã –ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –∑–Ω–∞–∫–æ–º—ã —Å–æ –º–Ω–æ–π! –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ /start –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start."

# ========== PROFILE ==========
profile_title: "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å"
profile_info_template: "üÜî –í–∞—à Telegram ID: {user_id}\nüìù –ò–º—è: {full_name}\nüë§ Username: @{username}\nüìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {registration_date}\nüó£ –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {current_language}"
profile_no_username: "–Ω–µ —É–∫–∞–∑–∞–Ω"
profile_no_reg_date: "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
profile_button_change_language: "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫"
profile_select_language_title: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:"
profile_language_changed: "–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {lang}"
profile_language_change_error: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞."
profile_language_already_set: "–Ø–∑—ã–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {lang}."
profile_language_user_not_found: "–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞."

# ========== COMMON MESSAGES ==========
main_menu_greeting: "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user_name}! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
main_menu_text: "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:"
feedback_request: "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n*–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel_feedback*"
feedback_cancelled: "–í–≤–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç–º–µ–Ω–µ–Ω."
feedback_thanks: "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –ú—ã –µ–≥–æ –ø–æ–ª—É—á–∏–ª–∏."
feedback_sent: "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞."
error_general: "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
error_no_access: "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞"
error_permission_denied: "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"

# ========== HELP COMMAND ==========
help_title: "‚ùì –ü–æ–º–æ—â—å –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞"
help_main_commands: "üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
help_module_commands: "üß© –ö–æ–º–∞–Ω–¥—ã –º–æ–¥—É–ª–µ–π:"
help_tip_menu: "üí° –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º."
help_tip_start: "–ù–∞–∂–º–∏—Ç–µ /start, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."

# ========== LANGUAGE NAMES ==========
language_en: "English"
language_ua: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞"
language_ru: "–†—É—Å—Å–∫–∏–π"

# ========== ADMIN PANEL ==========
admin_panel_title: "üõ† –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å SwiftDevBot"
admin_panel_select_section: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
admin_no_access: "üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.\n\n–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–æ—Ç–∞."
admin_modules_in_development: "–†–∞–∑–¥–µ–ª '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."

# ========== ADMIN COMMON TEXTS ==========
admin_back_to_main_menu_sdb: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB"
admin_back_to_admin_menu_main: "‚¨ÖÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–ì–ª–∞–≤–Ω–∞—è)"
admin_pagination_prev: "‚¨ÖÔ∏è –ü—Ä–µ–¥."
admin_pagination_next: "–°–ª–µ–¥. ‚û°Ô∏è"
admin_confirm_yes: "‚úÖ –î–∞"
admin_confirm_no: "‚ùå –ù–µ—Ç"
admin_close_message: "‚ùå –ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
admin_error_general: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
admin_access_denied: "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è."
admin_not_found_generic: "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω."

# ========== ADMIN MENU BUTTONS ==========
admin_system_info: "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"
admin_manage_modules: "üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏"
admin_manage_users: "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
admin_manage_roles: "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏"

# ========== ADMIN PERMISSIONS ==========
admin_perm_category_core: "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ø–¥—Ä–∞"
admin_perm_category_modules: "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –ú–æ–¥—É–ª–µ–π"
admin_perm_core_group_users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–Ø–¥—Ä–æ)"
admin_perm_core_group_roles: "–†–æ–ª–∏ (–Ø–¥—Ä–æ)"
admin_perm_core_group_modules_core: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–Ø–¥—Ä–æ)"
admin_perm_core_group_system: "–°–∏—Å—Ç–µ–º–∞ (–Ø–¥—Ä–æ)"
admin_perm_core_group_settings_core: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞"
admin_perm_core_group_other: "–ü—Ä–æ—á–∏–µ (–Ø–¥—Ä–æ)"
admin_back_to_perm_categories: "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π"
admin_back_to_core_perm_groups: "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞"
admin_back_to_module_list_for_perms: "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π (–¥–ª—è –ø—Ä–∞–≤)"
admin_no_modules_with_perms: "–ù–µ—Ç –º–æ–¥—É–ª–µ–π —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∞–≤"
admin_no_permissions_in_group: "–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π"

# ========== ADMIN FSM ROLE CREATION ==========
admin_fsm_enter_role_name: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏:"
admin_fsm_role_name_empty: "–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
admin_fsm_role_name_taken: "–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º \"{role_name}\" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
admin_fsm_enter_role_description: "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name}:"
admin_fsm_command_skip_description: "/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
admin_fsm_command_cancel_role_creation: "/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ"
admin_fsm_role_created_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!"
admin_fsm_role_creation_cancelled: "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."

# ========== ADMIN FSM ROLE EDITING ==========
admin_fsm_edit_role_title: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}"
admin_fsm_edit_role_name_not_allowed: "–ò–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ {role_name} –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è."
admin_fsm_enter_new_role_description: "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):"
admin_fsm_enter_new_role_name: "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):"
admin_fsm_command_skip_name: "/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å"
admin_fsm_command_cancel_role_edit: "/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
admin_fsm_role_updated_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
admin_fsm_role_update_cancelled: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."

# ========== ADMIN ROLE DELETION ==========
admin_delete_role_confirm_text: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!"
admin_role_is_standard_cant_delete: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å \"{role_name}\" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è."
admin_role_delete_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å \"{role_name}\"."
admin_role_deleted_successfully: "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞."

# ========== ADMIN USERS MANAGEMENT ==========
admin_user_list_title_template: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–°—Ç—Ä. {current_page}/{total_pages})"
admin_user_details_title: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"
admin_user_action_change_roles: "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª–∏"
admin_user_action_toggle_active: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {status}"
admin_user_action_toggle_blocked: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: {status}"
admin_edit_roles_for_user: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π –¥–ª—è: {user_name}"
admin_back_to_user_details: "‚¨ÖÔ∏è –ö –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
admin_user_is_owner_text: "üëë –í–ª–∞–¥–µ–ª–µ—Ü —Å–∏—Å—Ç–µ–º—ã (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)"
admin_user_action_direct_perms: "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"
admin_edit_direct_perms_for_user: "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è: {user_name}"
admin_perm_status_direct: "‚úÖ (–ø—Ä—è–º–æ–µ)"
admin_perm_status_role: "‚òëÔ∏è (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)"
admin_perm_status_none: "‚¨ú (–Ω–µ—Ç)"
admin_back_to_direct_perm_categories: "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–ª—è —é–∑–µ—Ä–∞)"
admin_back_to_direct_perm_core_groups: "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞ (–¥–ª—è —é–∑–µ—Ä–∞)"
admin_back_to_direct_perm_module_list: "‚¨ÖÔ∏è –ö –º–æ–¥—É–ª—è–º (–¥–ª—è —é–∑–µ—Ä–∞)"
admin_no_users_to_display: "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"
admin_user_active_yes: "–î–∞ ‚úÖ"
admin_user_active_no: "–ù–µ—Ç üí§"
admin_user_blocked_yes: "–î–∞ üö´"
admin_user_blocked_no: "–ù–µ—Ç ‚úÖ"
admin_user_no_roles: "–Ω–µ—Ç"
admin_user_telegram_id: "Telegram ID"
admin_user_db_id: "DB ID"
admin_user_username: "Username"
admin_user_first_name: "–ò–º—è"
admin_user_last_name: "–§–∞–º–∏–ª–∏—è"
admin_user_language: "–Ø–∑—ã–∫"
admin_user_active: "–ê–∫—Ç–∏–≤–µ–Ω"
admin_user_bot_blocked: "–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
admin_user_roles_status: "–†–æ–ª–∏/–°—Ç–∞—Ç—É—Å"
admin_user_registration: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"
admin_user_last_activity: "–ü–æ—Å–ª. –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"

# ========== ADMIN USERS ERRORS ==========
admin_error_invalid_user_id_format: "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
admin_error_user_id_not_specified: "–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω."
admin_error_user_id_for_roles_not_specified: "–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π –Ω–µ —É–∫–∞–∑–∞–Ω."
admin_error_invalid_user_id: "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
admin_error_cannot_change_owner_roles: "–†–æ–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å."
admin_error_cannot_modify_owner_roles: "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞."
admin_error_cannot_remove_last_role: "–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–æ–ª—å '{role_name}'."
admin_error_invalid_role_data: "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏."
admin_error_cannot_manage_owner_direct_perms: "–ù–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã."
admin_error_cannot_modify_owner_direct_perms: "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –í–ª–∞–¥–µ–ª—å—Ü–∞."
admin_error_fsm_state: "–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞."
admin_error_fsm_state_user_id: "–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)."
admin_error_fsm_state_role_id: "–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM (ID —Ä–æ–ª–∏)."
admin_error_invalid_permission_data: "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è."
admin_error_getting_users_data: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö."
admin_error_display: "–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."
admin_error_cannot_change_owner_status: "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã."
admin_error_cannot_change_owner_block_status: "–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã."
admin_error_saving: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
admin_role_removed: "–†–æ–ª—å '{role_name}' —Å–Ω—è—Ç–∞."
admin_role_failed_to_remove: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–æ–ª—å '{role_name}'."
admin_role_assigned: "–†–æ–ª—å '{role_name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–∞."
admin_role_failed_to_assign: "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å '{role_name}'."
admin_direct_perm_removed: "–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ."
admin_direct_perm_failed_to_remove: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}'."
admin_direct_perm_assigned: "–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–æ."
admin_direct_perm_failed_to_assign: "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}'."
admin_user_status_active_changed: "–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ {user_name} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {status}"
admin_user_status_active_not_changed: "–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω."
admin_user_block_status_changed: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è {user_name} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: {status}"
admin_user_block_status_not_changed: "–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω."

# ========== ADMIN ROLES MANAGEMENT ==========
admin_role_list_title: "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏"
admin_role_list_select_action: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
admin_role_list_no_roles: "–ù–µ—Ç —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"
admin_role_details_title: "üõ°Ô∏è –î–µ—Ç–∞–ª–∏ —Ä–æ–ª–∏"
admin_role_action_edit_permissions: "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"
admin_role_action_edit_role: "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å"
admin_role_action_delete_role: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å"
admin_back_to_roles_list: "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π"
admin_edit_permissions_for_role: "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏: {role_name}"
admin_role_action_create_role: "‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å"
admin_error_role_id_not_specified: "–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω."
admin_error_role_id_invalid: "–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω."
admin_error_no_permission_to_view_roles: "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π."
admin_error_checking_permissions: "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤."
admin_error_displaying_role_list: "–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π."
admin_error_displaying_list: "–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞."
admin_permission_removed_from_role: "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å —Ä–æ–ª–∏."
admin_permission_failed_to_remove_from_role: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}'."

# ========== ADMIN MODULES MANAGEMENT ==========
admin_modules_back_to_admin_panel: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"
admin_modules_back_to_modules_list: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π"
admin_modules_back_to_module_info: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
admin_modules_toggle_disable: "‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å"
admin_modules_toggle_enable: "‚úÖ –í–∫–ª—é—á–∏—Ç—å"
admin_modules_actions: "üîß –î–µ–π—Å—Ç–≤–∏—è"
admin_modules_clean_tables: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã"
admin_modules_error_no_module_loader: "–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."

# ========== ADMIN LOGS VIEWER ==========
admin_logs_back_to_admin_panel: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"
admin_logs_back_to_files_list: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤"
admin_logs_back_to_file_info: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ"
admin_logs_view_content: "üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ"
admin_logs_download_file: "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"

# ========== ADMIN SYSTEM INFO ==========
admin_sys_info_title: "üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot"
admin_sys_info_general: "‚ÑπÔ∏è –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
admin_sys_info_bot_process: "ü§ñ –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞"
admin_sys_info_sdb_core: "SDB Core"
admin_sys_info_python: "Python"
admin_sys_info_aiogram: "Aiogram"
admin_sys_info_os: "–û–°"
admin_sys_info_uptime: "–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã"
admin_sys_info_pid: "PID"
admin_sys_info_cpu_percent: "CPU"
admin_sys_info_memory: "–ü–∞–º—è—Ç—å"
admin_sys_info_database: "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
admin_sys_info_db_type: "–¢–∏–ø –ë–î"
admin_sys_info_db_status: "–°—Ç–∞—Ç—É—Å"
admin_sys_info_users: "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
admin_sys_info_total_users: "–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
admin_sys_info_modules: "üß© –ú–æ–¥—É–ª–∏"
admin_sys_info_total_modules: "–í—Å–µ–≥–æ –º–æ–¥—É–ª–µ–π"
admin_sys_info_enabled_modules: "–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π"
admin_sys_info_process_not_found: "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
admin_sys_info_na: "–ù/–î"



======================================================================

------------------------------ FILE: Systems/core/app_settings.py ------------------------------
# core/app_settings.py

import os
import sys
import warnings
import yaml
from pathlib import Path
from typing import List, Optional, Literal, Any, Dict 
from pydantic import BaseModel, Field, field_validator, HttpUrl, ValidationInfo, AliasChoices

# –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ urllib3 –æ LibreSSL/OpenSSL (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
warnings.filterwarnings("ignore", message="urllib3 v2 only supports OpenSSL 1.1.1+")

try:
    from loguru import logger as global_logger 
except ImportError:
    import logging
    global_logger = logging.getLogger("sdb_app_settings_fallback")
    global_logger.warning("Loguru –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π logging. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Loguru.")

from dotenv import load_dotenv, find_dotenv
from pydantic.networks import PostgresDsn, MySQLDsn, AnyUrl 
from pydantic_settings import BaseSettings, SettingsConfigDict

PROJECT_ROOT_DIR = Path(__file__).resolve().parent.parent.parent
print(f"DEBUG: PROJECT_ROOT_DIR = {PROJECT_ROOT_DIR}")
ENV_FILENAME = ".env"
DEFAULT_PROJECT_DATA_DIR_NAME = "Data" 
USER_CONFIG_DIR_NAME = "Config" 
USER_CONFIG_FILENAME = "core_settings.yaml"
ENABLED_MODULES_FILENAME = "enabled_modules.json" 
ROOT_CONFIG_TEMPLATE_FILENAME = "config.yaml" 
STRUCTURED_LOGS_ROOT_DIR_NAME = "Logs" 

CLI_MODE = os.environ.get("SDB_CLI_MODE", "false").lower() == "true"
VERBOSE_MODE = os.environ.get("SDB_VERBOSE", "false").lower() == "true"
env_file_path_for_dotenv = None
BOT_TOKEN_FROM_DOTENV: Optional[str] = None
if not CLI_MODE:
    env_file_path_for_dotenv = find_dotenv(filename=ENV_FILENAME, usecwd=True, raise_error_if_not_found=False)
    if env_file_path_for_dotenv and Path(env_file_path_for_dotenv).exists():
        global_logger.info(f"–ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª –¥–ª—è python-dotenv: {env_file_path_for_dotenv}")
        load_dotenv(dotenv_path=env_file_path_for_dotenv, override=True)
        BOT_TOKEN_FROM_DOTENV = os.getenv("BOT_TOKEN")
        if BOT_TOKEN_FROM_DOTENV:
            global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ .env —Ñ–∞–π–ª–∞.")
        else:
            global_logger.warning(f"BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {env_file_path_for_dotenv} –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ python-dotenv/os.getenv.")
    else:
        env_file_at_root = PROJECT_ROOT_DIR / ENV_FILENAME
        if env_file_at_root.exists() and env_file_at_root.is_file():
            global_logger.info(f"–ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª –¥–ª—è python-dotenv (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞): {env_file_at_root}")
            load_dotenv(dotenv_path=env_file_at_root, override=True)
            BOT_TOKEN_FROM_DOTENV = os.getenv("BOT_TOKEN")
            if BOT_TOKEN_FROM_DOTENV:
                global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞).")
            else:
                global_logger.warning(f"BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {env_file_at_root} (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞).")
        else:
            global_logger.warning(f".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω python-dotenv. BOT_TOKEN –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ YAML –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.")

class DBSettings(BaseModel):
    type: Literal["sqlite", "postgresql", "mysql"] = Field(default="sqlite", description="–¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
    sqlite_path: str = Field(
        default=f"Database_files/swiftdevbot.db", 
        description="–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path)."
    )
    pg_dsn: Optional[PostgresDsn] = Field(default=None, description="DSN –¥–ª—è PostgreSQL.")
    mysql_dsn: Optional[MySQLDsn] = Field(default=None, description="DSN –¥–ª—è MySQL.")
    echo_sql: bool = Field(default=False, description="–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG).")

    @field_validator('pg_dsn', mode='before')
    @classmethod
    def check_pg_dsn(cls, v: Optional[PostgresDsn], info: ValidationInfo) -> Optional[PostgresDsn]:
        if info.data.get('type') == "postgresql" and not v:
            raise ValueError("pg_dsn –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î 'postgresql'.")
        return v

    @field_validator('mysql_dsn', mode='before')
    @classmethod
    def check_mysql_dsn(cls, v: Optional[MySQLDsn], info: ValidationInfo) -> Optional[MySQLDsn]:
        if info.data.get('type') == "mysql" and not v:
            raise ValueError("mysql_dsn –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î 'mysql'.")
        return v

class CacheSettings(BaseModel):
    type: Literal["memory", "redis"] = Field(default="memory", description="–¢–∏–ø –∫—ç—à–∞.")
    redis_url: Optional[str] = Field(default="redis://localhost:6379/0", description="URL –¥–ª—è Redis.")

    @field_validator('redis_url', mode='before')
    @classmethod
    def check_redis_url(cls, v: Optional[str], info: ValidationInfo) -> Optional[str]:
        cache_type = info.data.get('type') if info.data else None
        if cache_type == "redis" and not v:
            raise ValueError("redis_url –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –∫—ç—à–∞ 'redis'.")
        return v

class TelegramSettings(BaseModel):
    token: str = Field(description="–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ .env).")
    polling_timeout: int = Field(default=30, ge=1, description="–¢–∞–π–º–∞—É—Ç long polling (—Å–µ–∫—É–Ω–¥—ã).")

class ModuleRepoSettings(BaseModel):
    index_url: Optional[HttpUrl] = Field(
        default=HttpUrl("https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json"),
        description="URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB."
    )

class I18nSettings(BaseModel):
    locales_dir: Path = Field(default=PROJECT_ROOT_DIR / "Systems" / "locales", description="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤.")
    domain: str = Field(default="bot", description="–ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.")
    default_locale: str = Field(default="ru", description="–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.")
    available_locales: List[str] = Field(default_factory=lambda: ["ru", "en", "ua"], description="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤.")

class CoreAppSettings(BaseModel):
    project_data_path: Path = Field(
        default=PROJECT_ROOT_DIR / DEFAULT_PROJECT_DATA_DIR_NAME,
        description="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞."
    )
    super_admins: List[int] = Field(default_factory=list, description="–°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.")
    enabled_modules_config_path: Path = Field(
        default=Path(f"{USER_CONFIG_DIR_NAME}/{ENABLED_MODULES_FILENAME}"), 
        description="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö)."
    )
    
    log_level: Literal["TRACE", "DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"] = Field(default="INFO")
    log_to_file: bool = Field(default=True)
    log_structured_dir: str = Field(
        default=STRUCTURED_LOGS_ROOT_DIR_NAME, 
        description="–ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ project_data_path)."
    )
    log_rotation_size: str = Field(
        default="100 MB", 
        description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π (e.g., '100 MB')."
    ) 
    log_retention_period_structured: str = Field(
        default="3 months", 
        description="–ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '30 days', '3 months', '1 year'). "
                    "–†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π –æ—á–∏—Å—Ç–∫–∏."
    )
    
    sdb_version: str = Field(default="0.1.0", pattern=r"^\d+\.\d+\.\d+([\w.-]*[\w])?(\+[\w.-]+)?$",
                             description="–í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SwiftDevBot (SemVer-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è).")
    
    setup_bot_commands_on_startup: bool = Field(default=True, description="–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.")
    enable_startup_shutdown_notifications: bool = Field(default=True, description="–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞.")
    i18n: I18nSettings = Field(default_factory=I18nSettings)

class EnvironmentSettings(BaseSettings):
    CORE_PROJECT_DATA_PATH: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_PROJECT_DATA_PATH', 'CORE_PROJECT_DATA_PATH'))
    CORE_SUPER_ADMINS: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_SUPER_ADMINS', 'CORE_SUPER_ADMINS'))
    CORE_ENABLED_MODULES_CONFIG_PATH: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_ENABLED_MODULES_CONFIG_PATH', 'CORE_ENABLED_MODULES_CONFIG_PATH'))
    CORE_LOG_LEVEL: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_LOG_LEVEL', 'CORE_LOG_LEVEL'))
    CORE_LOG_TO_FILE: Optional[bool] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_LOG_TO_FILE', 'CORE_LOG_TO_FILE'))
    
    SDB_CORE_LOG_STRUCTURED_DIR: Optional[str] = Field(default=None)
    SDB_CORE_LOG_ROTATION_SIZE: Optional[str] = Field(default=None)
    SDB_CORE_LOG_RETENTION_PERIOD_STRUCTURED: Optional[str] = Field(default=None)

    CORE_SDB_VERSION: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_SDB_VERSION', 'CORE_SDB_VERSION'))
    CORE_ENABLE_STARTUP_SHUTDOWN_NOTIFICATIONS: Optional[bool] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_ENABLE_STARTUP_SHUTDOWN_NOTIFICATIONS', 'CORE_ENABLE_STARTUP_SHUTDOWN_NOTIFICATIONS'))
    
    DB_TYPE: Optional[Literal["sqlite", "postgresql", "mysql"]] = Field(default=None, validation_alias=AliasChoices('SDB_DB_TYPE', 'DB_TYPE'))
    DB_SQLITE_PATH: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_SQLITE_PATH', 'DB_SQLITE_PATH'))
    DB_PG_DSN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_PG_DSN', 'DB_PG_DSN')) 
    DB_MYSQL_DSN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_MYSQL_DSN', 'DB_MYSQL_DSN')) 
    DB_ECHO_SQL: Optional[bool] = Field(default=None, validation_alias=AliasChoices('SDB_DB_ECHO_SQL', 'DB_ECHO_SQL'))

    CACHE_TYPE: Optional[Literal["memory", "redis"]] = Field(default=None, validation_alias=AliasChoices('SDB_CACHE_TYPE', 'CACHE_TYPE'))
    CACHE_REDIS_URL: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CACHE_REDIS_URL', 'CACHE_REDIS_URL'))
    
    TELEGRAM_POLLING_TIMEOUT: Optional[int] = Field(default=None, validation_alias=AliasChoices('SDB_TELEGRAM_POLLING_TIMEOUT', 'TELEGRAM_POLLING_TIMEOUT'))
    MODULE_REPO_INDEX_URL: Optional[HttpUrl] = Field(default=None, validation_alias=AliasChoices('SDB_MODULE_REPO_INDEX_URL', 'MODULE_REPO_INDEX_URL'))

    SDB_I18N_LOCALES_DIR: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_LOCALES_DIR', 'I18N_LOCALES_DIR'))
    SDB_I18N_DOMAIN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_DOMAIN', 'I18N_DOMAIN'))
    SDB_I18N_DEFAULT_LOCALE: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_DEFAULT_LOCALE', 'I18N_DEFAULT_LOCALE'))
    SDB_I18N_AVAILABLE_LOCALES: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_AVAILABLE_LOCALES', 'I18N_AVAILABLE_LOCALES'))

    model_config = SettingsConfigDict(
        env_file=None, 
        extra='ignore',
    )

class AppSettings(BaseModel):
    db: DBSettings = Field(default_factory=DBSettings)
    cache: CacheSettings = Field(default_factory=CacheSettings)
    telegram: TelegramSettings
    module_repo: ModuleRepoSettings = Field(default_factory=ModuleRepoSettings)
    core: CoreAppSettings = Field(default_factory=CoreAppSettings)
    project_root: Path = Field(default_factory=lambda: PROJECT_ROOT_DIR)
    model_config = {"validate_assignment": True}

_loaded_settings_cache: Optional[AppSettings] = None
_loguru_console_configured_flag = False

def load_app_settings() -> AppSettings:
    global _loaded_settings_cache, _loguru_console_configured_flag
    if _loaded_settings_cache is not None:
        return _loaded_settings_cache

    # DEBUG –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ verbose —Ä–µ–∂–∏–º–µ
    if VERBOSE_MODE:
        global_logger.debug(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SDB. –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {PROJECT_ROOT_DIR}")
    
    env_s = EnvironmentSettings()
    
    if not CLI_MODE:
        if BOT_TOKEN_FROM_DOTENV:
            global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') –±—ã–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.")
        else:
            global_logger.warning("BOT_TOKEN –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ .env. –ë—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ YAML.")
    
    pdp_val_from_env = env_s.CORE_PROJECT_DATA_PATH
    core_app_defaults = CoreAppSettings.model_fields
    
    if pdp_val_from_env:
        effective_project_data_path = Path(pdp_val_from_env)
        if not effective_project_data_path.is_absolute():
            effective_project_data_path = (PROJECT_ROOT_DIR / effective_project_data_path).resolve()
    else: 
        default_pdp_model = core_app_defaults["project_data_path"].default
        effective_project_data_path = Path(default_pdp_model) if default_pdp_model else (PROJECT_ROOT_DIR / DEFAULT_PROJECT_DATA_DIR_NAME)
        if not effective_project_data_path.is_absolute():
             effective_project_data_path = (PROJECT_ROOT_DIR / effective_project_data_path).resolve()

    user_config_file_path = effective_project_data_path / USER_CONFIG_DIR_NAME / USER_CONFIG_FILENAME
    yaml_data: Dict[str, Any] = {}
    if user_config_file_path.is_file():
        try:
            with open(user_config_file_path, 'r', encoding='utf-8') as f: yaml_data = yaml.safe_load(f) or {}
            # INFO –ª–æ–≥–∏ –æ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ verbose —Ä–µ–∂–∏–º–µ
            if VERBOSE_MODE:
                global_logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ YAML: {user_config_file_path}")
        except Exception as e_yaml: global_logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ YAML –∏–∑ {user_config_file_path}: {e_yaml}.")
    else:
        # INFO –ª–æ–≥–∏ –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ verbose —Ä–µ–∂–∏–º–µ
        if VERBOSE_MODE:
            global_logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π YAML –∫–æ–Ω—Ñ–∏–≥ {user_config_file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç—ã –∏ .env.")

    tg_token_from_yaml = yaml_data.get("telegram", {}).get("token")
    final_tg_token = BOT_TOKEN_FROM_DOTENV or tg_token_from_yaml
    allow_missing_token_env = os.environ.get("SDB_ALLOW_MISSING_BOT_TOKEN", "false").lower() == "true"
    if not final_tg_token and not (allow_missing_token_env or CLI_MODE):
        raise ValueError(f"–ö–†–ò–¢–ò–ß–ù–û: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env –∏ YAML ({user_config_file_path}).")
    if not final_tg_token and (allow_missing_token_env or CLI_MODE):
        if not CLI_MODE:
            global_logger.warning("BOT_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑-–∑–∞ SDB_ALLOW_MISSING_BOT_TOKEN=true. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ —É–∫–∞–∑–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.")
        final_tg_token = ""
    
    telegram_s = TelegramSettings(
        token=final_tg_token,
        polling_timeout=env_s.TELEGRAM_POLLING_TIMEOUT or \
                        yaml_data.get("telegram", {}).get("polling_timeout", TelegramSettings.model_fields["polling_timeout"].default)
    )

    db_yaml = yaml_data.get("db", {})
    db_s = DBSettings(
        type=env_s.DB_TYPE or db_yaml.get("type", DBSettings.model_fields["type"].default),
        sqlite_path=env_s.DB_SQLITE_PATH or db_yaml.get("sqlite_path", DBSettings.model_fields["sqlite_path"].default),
        pg_dsn=env_s.DB_PG_DSN or db_yaml.get("pg_dsn"),
        mysql_dsn=env_s.DB_MYSQL_DSN or db_yaml.get("mysql_dsn"),
        echo_sql=env_s.DB_ECHO_SQL if env_s.DB_ECHO_SQL is not None else \
                 db_yaml.get("echo_sql", DBSettings.model_fields["echo_sql"].default)
    )

    cache_yaml = yaml_data.get("cache", {})
    cache_s = CacheSettings(
        type=env_s.CACHE_TYPE or cache_yaml.get("type", CacheSettings.model_fields["type"].default),
        redis_url=env_s.CACHE_REDIS_URL or cache_yaml.get("redis_url", CacheSettings.model_fields["redis_url"].default)
    )

    module_repo_yaml = yaml_data.get("module_repo", {})
    module_repo_s = ModuleRepoSettings(
        index_url=env_s.MODULE_REPO_INDEX_URL or \
                  HttpUrl(str(module_repo_yaml.get("index_url") or ModuleRepoSettings.model_fields["index_url"].default))
    )
    
    core_yaml = yaml_data.get("core", {})
    
    s_admins_str_env = env_s.CORE_SUPER_ADMINS
    s_admins_list_yaml = core_yaml.get("super_admins")
    s_admins_final_list: List[int] = []
    if s_admins_str_env:
        try:
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å (python-dotenv –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –∏—Ö)
            s_admins_str_clean = s_admins_str_env.strip().strip('"').strip("'")
            # –ü–∞—Ä—Å–∏–º —Å–ø–∏—Å–æ–∫ ID, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—è—Ç–æ–π
            s_admins_final_list = []
            for x in s_admins_str_clean.split(','):
                x_clean = x.strip().strip('"').strip("'")
                if x_clean.isdigit():
                    s_admins_final_list.append(int(x_clean))
            global_logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏–∑ SDB_CORE_SUPER_ADMINS: {s_admins_final_list}")
        except ValueError as e: 
            global_logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ CORE_SUPER_ADMINS –∏–∑ env: '{s_admins_str_env}': {e}")
    elif isinstance(s_admins_list_yaml, list):
        s_admins_final_list = [int(x) for x in s_admins_list_yaml if isinstance(x, (int, str)) and str(x).isdigit()]

    emcp_from_env_val = env_s.CORE_ENABLED_MODULES_CONFIG_PATH
    emcp_from_yaml_val = core_yaml.get("enabled_modules_config_path")
    emcp_default_relative = CoreAppSettings.model_fields["enabled_modules_config_path"].default 
    
    emcp_to_resolve = emcp_from_env_val or (Path(emcp_from_yaml_val) if emcp_from_yaml_val else emcp_default_relative)
    emcp_path_resolved = (effective_project_data_path / emcp_to_resolve).resolve() if not Path(emcp_to_resolve).is_absolute() else Path(emcp_to_resolve).resolve()

    log_structured_dir_final = env_s.SDB_CORE_LOG_STRUCTURED_DIR or core_yaml.get("log_structured_dir", CoreAppSettings.model_fields["log_structured_dir"].default)
    log_rotation_size_final = env_s.SDB_CORE_LOG_ROTATION_SIZE or core_yaml.get("log_rotation_size", CoreAppSettings.model_fields["log_rotation_size"].default)
    log_retention_period_structured_final = env_s.SDB_CORE_LOG_RETENTION_PERIOD_STRUCTURED or core_yaml.get("log_retention_period_structured", CoreAppSettings.model_fields["log_retention_period_structured"].default)

    i18n_yaml = core_yaml.get("i18n", {})
    i18n_model_defaults = I18nSettings.model_fields
    
    available_locales_env_str = env_s.SDB_I18N_AVAILABLE_LOCALES
    available_locales_yaml = i18n_yaml.get("available_locales")
    final_available_locales: List[str]
    if available_locales_env_str:
        final_available_locales = [loc.strip() for loc in available_locales_env_str.split(',')]
    elif isinstance(available_locales_yaml, list):
        final_available_locales = available_locales_yaml
    else:
        final_available_locales = i18n_model_defaults["available_locales"].default_factory() # type: ignore

    locales_dir_env = env_s.SDB_I18N_LOCALES_DIR
    locales_dir_yaml = i18n_yaml.get("locales_dir")
    locales_dir_default = i18n_model_defaults["locales_dir"].default
    
    locales_dir_to_resolve = locales_dir_env or (Path(locales_dir_yaml) if locales_dir_yaml else locales_dir_default)
    resolved_locales_dir = Path(locales_dir_to_resolve)
    if not resolved_locales_dir.is_absolute():
        resolved_locales_dir = (PROJECT_ROOT_DIR / resolved_locales_dir).resolve()

    i18n_s = I18nSettings(
        locales_dir=resolved_locales_dir,
        domain=env_s.SDB_I18N_DOMAIN or i18n_yaml.get("domain", i18n_model_defaults["domain"].default),
        default_locale=env_s.SDB_I18N_DEFAULT_LOCALE or i18n_yaml.get("default_locale", i18n_model_defaults["default_locale"].default),
        available_locales=final_available_locales
    )

    core_s = CoreAppSettings(
        project_data_path=effective_project_data_path,
        super_admins=s_admins_final_list,
        enabled_modules_config_path=emcp_path_resolved,
        log_level=(env_s.CORE_LOG_LEVEL or core_yaml.get("log_level", CoreAppSettings.model_fields["log_level"].default)).upper(), # type: ignore
        log_to_file=env_s.CORE_LOG_TO_FILE if env_s.CORE_LOG_TO_FILE is not None \
                    else core_yaml.get("log_to_file", CoreAppSettings.model_fields["log_to_file"].default),
        log_structured_dir=log_structured_dir_final,
        log_rotation_size=log_rotation_size_final,
        log_retention_period_structured=log_retention_period_structured_final,
        sdb_version=env_s.CORE_SDB_VERSION or core_yaml.get("sdb_version", CoreAppSettings.model_fields["sdb_version"].default),
        setup_bot_commands_on_startup=core_yaml.get("setup_bot_commands_on_startup", CoreAppSettings.model_fields["setup_bot_commands_on_startup"].default), # type: ignore
        enable_startup_shutdown_notifications=env_s.CORE_ENABLE_STARTUP_SHUTDOWN_NOTIFICATIONS if env_s.CORE_ENABLE_STARTUP_SHUTDOWN_NOTIFICATIONS is not None \
                    else core_yaml.get("enable_startup_shutdown_notifications", CoreAppSettings.model_fields["enable_startup_shutdown_notifications"].default),
        i18n=i18n_s
    )
    
    final_settings = AppSettings(db=db_s, cache=cache_s, telegram=telegram_s, module_repo=module_repo_s, core=core_s)

    final_settings.core.project_data_path.mkdir(parents=True, exist_ok=True)
    final_settings.core.enabled_modules_config_path.parent.mkdir(parents=True, exist_ok=True)
    
    structured_logs_root_abs_path = final_settings.core.project_data_path / final_settings.core.log_structured_dir
    structured_logs_root_abs_path.mkdir(parents=True, exist_ok=True)
    
    final_settings.core.i18n.locales_dir.mkdir(parents=True, exist_ok=True)
    
    if final_settings.db.type == "sqlite":
        sqlite_file_abs = Path(final_settings.db.sqlite_path)
        if not sqlite_file_abs.is_absolute():
            if DEFAULT_PROJECT_DATA_DIR_NAME in sqlite_file_abs.parts:
                 sqlite_file_abs = (PROJECT_ROOT_DIR / sqlite_file_abs).resolve()
            else:
                 sqlite_file_abs = (final_settings.core.project_data_path / sqlite_file_abs).resolve()
        final_settings.db.sqlite_path = str(sqlite_file_abs)
        sqlite_file_abs.parent.mkdir(parents=True, exist_ok=True)

    if not _loguru_console_configured_flag:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π handler (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ sdb.py)
            has_existing_handler = (
                hasattr(global_logger, '_core') and 
                global_logger._core.handlers and 
                len(global_logger._core.handlers) > 0
            )
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é VERBOSE_MODE
            if VERBOSE_MODE:
                # –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –º–æ–¥—É–ª–µ–º, —Ñ—É–Ω–∫—Ü–∏–µ–π –∏ —Å—Ç—Ä–æ–∫–æ–π
                log_format_console = ("<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | <level>{level: <8}</level> | "
                                      "<cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>")
                # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ handlers —Ç–æ–ª—å–∫–æ –≤ verbose —Ä–µ–∂–∏–º–µ
                if has_existing_handler:
                    for handler_id_to_remove in list(global_logger._core.handlers.keys()):
                        try: global_logger.remove(handler_id_to_remove)
                        except ValueError: pass
            else:
                # –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                log_format_console = "<green>{time:HH:mm:ss}</green> <level>{message}</level>"
                # –í –ø—Ä–æ—Å—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ —É–¥–∞–ª—è–µ–º handlers, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ sdb.py)
                # –ï—Å–ª–∏ handler —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            
            # –î–æ–±–∞–≤–ª—è–µ–º handler —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç (–≤ –ø—Ä–æ—Å—Ç–æ–º —Ä–µ–∂–∏–º–µ) –∏–ª–∏ –≤—Å–µ–≥–¥–∞ (–≤ verbose —Ä–µ–∂–∏–º–µ)
            if VERBOSE_MODE or not has_existing_handler:
                console_log_level_str = final_settings.core.log_level.upper()
                
                cli_debug_env_var = os.environ.get("SDB_CLI_DEBUG_MODE_FOR_LOGGING", "false").lower()
                if cli_debug_env_var == "true":
                    console_log_level_str = "DEBUG"
                    if not VERBOSE_MODE:
                        global_logger.info("Loguru (app_settings): –£—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ DEBUG –∏–∑-–∑–∞ SDB_CLI_DEBUG_MODE_FOR_LOGGING.")

                global_logger.add(sys.stderr, level=console_log_level_str, format=log_format_console, colorize=True)
                if VERBOSE_MODE:
                    global_logger.info(f"Loguru (app_settings): –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω (verbose mode). –£—Ä–æ–≤–µ–Ω—å: {console_log_level_str}")
            _loguru_console_configured_flag = True
        except Exception as e_log_setup_console:
            print(f"CRITICAL ERROR in app_settings during Loguru console setup: {e_log_setup_console}", file=sys.stderr)

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –Ω–æ –≤ –ø—Ä–æ—Å—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–µ—Å–ª–∏ –Ω–µ verbose)
    if VERBOSE_MODE:
        global_logger.success("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SDB —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã!")
    else:
        # –í –ø—Ä–æ—Å—Ç–æ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º info –≤–º–µ—Å—Ç–æ success, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        global_logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SDB —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã!")
    _loaded_settings_cache = final_settings
    return final_settings

try:
    settings: AppSettings = load_app_settings()
except (ImportError, ValueError) as e: 
    print(f"CRITICAL ERROR during SDB settings load/validation: {e}", file=sys.stderr)
    if hasattr(global_logger, 'opt') and callable(global_logger.opt): 
        global_logger.opt(exception=True).critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê Pydantic/SDB –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
    sys.exit(1)
except Exception as e:
    print(f"UNEXPECTED CRITICAL ERROR during initial settings load: {e}", file=sys.stderr)
    if hasattr(global_logger, 'opt') and callable(global_logger.opt):
        global_logger.opt(exception=True).critical(f"–ù–ï–ü–†–ï–î–í–ò–î–ï–ù–ù–ê–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
    sys.exit(1)


======================================================================

------------------------------ FILE: Systems/core/services_provider.py ------------------------------
# core/services_provider.py

from typing import Optional, TYPE_CHECKING

from loguru import logger as global_logger 

if TYPE_CHECKING:
    from Systems.core.app_settings import AppSettings
    from Systems.core.database.manager import DBManager
    from Systems.core.cache.manager import CacheManager
    from Systems.core.http_client.manager import HTTPClientManager
    from Systems.core.module_loader import ModuleLoader
    from Systems.core.events.dispatcher import EventDispatcher
    from Systems.core.ui.registry_ui import UIRegistry
    from Systems.core.rbac.service import RBACService
    from Systems.core.users.service import UserService
    from Systems.core.security.signature_manager import ModuleSignatureManager
    from Systems.core.security.sandbox_manager import ModuleSandboxManager
    from Systems.core.security.audit_logger import SecurityAuditLogger
    from Systems.core.security.reputation_system import ModuleReputationSystem
    from Systems.core.security.code_scanner import ModuleCodeScanner
    from Systems.core.security.security_levels import SecurityLevelManager
    from Systems.core.security.anomaly_detection import AnomalyDetector


class BotServicesProvider:
    def __init__(self, settings: 'AppSettings'):
        self._settings: 'AppSettings' = settings
        self._logger = global_logger.bind(service="BotServicesProvider")

        self._db_manager: Optional['DBManager'] = None
        self._cache_manager: Optional['CacheManager'] = None
        self._http_client_manager: Optional['HTTPClientManager'] = None
        self._module_loader: Optional['ModuleLoader'] = None
        self._event_dispatcher: Optional['EventDispatcher'] = None
        self._ui_registry: Optional['UIRegistry'] = None
        self._rbac_service: Optional['RBACService'] = None
        self._user_service: Optional['UserService'] = None
        
        # Security services
        self._signature_manager: Optional['ModuleSignatureManager'] = None
        self._sandbox_manager: Optional['ModuleSandboxManager'] = None
        self._audit_logger: Optional['SecurityAuditLogger'] = None
        self._reputation_system: Optional['ModuleReputationSystem'] = None
        self._code_scanner: Optional['ModuleCodeScanner'] = None
        self._security_level_manager: Optional['SecurityLevelManager'] = None
        self._anomaly_detector: Optional['AnomalyDetector'] = None

        self._logger.info(f"BotServicesProvider —Å–æ–∑–¥–∞–Ω (–≤–µ—Ä—Å–∏—è SDB: {settings.core.sdb_version}). –û–∂–∏–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.")

    async def setup_services(self) -> None:
        self._logger.info("–ù–∞—á–∞–ª–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB...")
        
        from Systems.core.database.manager import DBManager 
        try:
            self._db_manager = DBManager(db_settings=self._settings.db, app_settings=self._settings)
            await self._db_manager.initialize() 
            self._logger.success("–°–µ—Ä–≤–∏—Å DBManager —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e:
            self._logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DBManager: {e}", exc_info=True)
            raise

        # –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ModuleLoader, —Ç–∞–∫ –∫–∞–∫ RBACService –º–æ–∂–µ—Ç –æ—Ç –Ω–µ–≥–æ –∑–∞–≤–∏—Å–µ—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π
        from Systems.core.module_loader import ModuleLoader 
        try:
            self._module_loader = ModuleLoader(settings=self._settings, services_provider=self)
            self._module_loader.scan_all_available_modules() 
            self._module_loader._load_enabled_plugin_names() 
            self._logger.success(f"–°–µ—Ä–≤–∏—Å ModuleLoader –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–∞–π–¥–µ–Ω–æ {len(self._module_loader.available_modules)} –º–æ–¥—É–ª–µ–π, "
                                 f"–∞–∫—Ç–∏–≤–Ω–æ –ø–ª–∞–≥–∏–Ω–æ–≤ {len(self._module_loader.enabled_plugin_names)}).")
        except Exception as e_mod_load:
            self._logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleLoader: {e_mod_load}", exc_info=True)
            raise 

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        try:
            from sqlalchemy import inspect, text
            from Systems.core.database import core_models
            
            existing_tables = []
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞
            if self._settings.db.type == "sqlite":
                # –î–ª—è SQLite –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ sqlite_master
                async with self._db_manager._engine.begin() as conn:
                    result = await conn.execute(text("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'sdb_%'"))
                    existing_tables = [row[0] for row in result.fetchall()]
            else:
                # –î–ª—è PostgreSQL/MySQL –∏—Å–ø–æ–ª—å–∑—É–µ–º inspect —á–µ—Ä–µ–∑ sync_engine
                inspector = inspect(self._db_manager._engine.sync_engine)
                existing_tables = inspector.get_table_names()
            
            core_table_names = [
                f"{core_models.SDB_CORE_TABLE_PREFIX}users",
                f"{core_models.SDB_CORE_TABLE_PREFIX}roles",
                f"{core_models.SDB_CORE_TABLE_PREFIX}permissions",
            ]
            
            tables_exist = any(table in existing_tables for table in core_table_names)
            
            if not tables_exist:
                self._logger.warning("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü...")
                await self._db_manager.create_all_core_tables()
                self._logger.success("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
            else:
                self._logger.debug("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.")
        except Exception as e_tables_check:
            self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞: {e_tables_check}. –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü...")
            try:
                await self._db_manager.create_all_core_tables()
                self._logger.success("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏).")
            except Exception as e_create_tables:
                self._logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞: {e_create_tables}", exc_info=True)
                raise

        from Systems.core.rbac.service import RBACService 
        try:
            # –ü–µ—Ä–µ–¥–∞–µ–º self (BotServicesProvider) –≤ RBACService
            self._rbac_service = RBACService(services=self) # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
            if self._db_manager and self._rbac_service:
                try:
                    async with self._db_manager.get_session() as db_session:
                        # –í—ã–∑—ã–≤–∞–µ–º ensure_default_entities_exist
                        roles_c, core_perms_c, mod_perms_c = await self._rbac_service.ensure_default_entities_exist(db_session) # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
                        await db_session.commit()
                        self._logger.info(f"RBACService.ensure_default_entities_exist –æ—Ç—Ä–∞–±–æ—Ç–∞–ª. "
                                          f"–†–æ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ: {roles_c}, –†–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞: {core_perms_c}, –†–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π: {mod_perms_c}")
                except Exception as e_roles:
                    self._logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö RBAC —Å—É—â–Ω–æ—Å—Ç–µ–π: {e_roles}", exc_info=True)
            self._logger.success("–°–µ—Ä–≤–∏—Å RBACService —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except ValueError as e_rbac_val: # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ DBManager –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RBACService (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å DBManager –∏–ª–∏ ModuleLoader): {e_rbac_val}")
            self._rbac_service = None
        except Exception as e_rbac:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RBACService: {e_rbac}", exc_info=True)
            self._rbac_service = None 

        from Systems.core.users.service import UserService
        try:
            self._user_service = UserService(services_provider=self) 
            self._logger.success("–°–µ—Ä–≤–∏—Å UserService —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e_user_svc:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å UserService: {e_user_svc}", exc_info=True)
            self._user_service = None
        
        from Systems.core.cache.manager import CacheManager 
        try:
            self._cache_manager = CacheManager(cache_settings=self._settings.cache)
            await self._cache_manager.initialize()
            if self._cache_manager.is_available():
                 self._logger.success(f"–°–µ—Ä–≤–∏—Å CacheManager ({self._settings.cache.type}) —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
            else:
                 self._logger.warning(f"CacheManager ({self._settings.cache.type}) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
        except ImportError as e_cache_imp: 
             self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å CacheManager: {e_cache_imp}")
        except Exception as e_cache:
            self._logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CacheManager: {e_cache}", exc_info=True)
            self._cache_manager = None

        from Systems.core.http_client.manager import HTTPClientManager 
        try:
            self._http_client_manager = HTTPClientManager(app_settings=self._settings) 
            await self._http_client_manager.initialize()
            if self._http_client_manager.is_available():
                self._logger.success("–°–µ—Ä–≤–∏—Å HTTPClientManager —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
            else:
                self._logger.warning("HTTPClientManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ HTTP-–∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
        except ImportError as e_http_imp: 
            self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å HTTPClientManager: {e_http_imp}")
        except Exception as e_http:
            self._logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTPClientManager: {e_http}", exc_info=True)
            self._http_client_manager = None

        from Systems.core.events.dispatcher import EventDispatcher 
        try:
            self._event_dispatcher = EventDispatcher()
            self._logger.success("–°–µ—Ä–≤–∏—Å EventDispatcher —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_event:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ EventDispatcher: {e_event}", exc_info=True)
            self._event_dispatcher = None

        from Systems.core.ui.registry_ui import UIRegistry 
        try:
            self._ui_registry = UIRegistry()
            self._logger.success("–°–µ—Ä–≤–∏—Å UIRegistry —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_ui_reg:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UIRegistry: {e_ui_reg}", exc_info=True)
            self._ui_registry = None
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        from Systems.core.security.signature_manager import ModuleSignatureManager
        try:
            self._signature_manager = ModuleSignatureManager(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å ModuleSignatureManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_sig:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleSignatureManager: {e_sig}", exc_info=True)
            self._signature_manager = None
        
        from Systems.core.security.sandbox_manager import ModuleSandboxManager
        try:
            self._sandbox_manager = ModuleSandboxManager(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å ModuleSandboxManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_sandbox:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleSandboxManager: {e_sandbox}", exc_info=True)
            self._sandbox_manager = None
        
        from Systems.core.security.audit_logger import SecurityAuditLogger
        try:
            self._audit_logger = SecurityAuditLogger(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å SecurityAuditLogger —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_audit:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SecurityAuditLogger: {e_audit}", exc_info=True)
            self._audit_logger = None
        
        from Systems.core.security.reputation_system import ModuleReputationSystem
        try:
            self._reputation_system = ModuleReputationSystem(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å ModuleReputationSystem —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_reputation:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleReputationSystem: {e_reputation}", exc_info=True)
            self._reputation_system = None
        
        from Systems.core.security.code_scanner import ModuleCodeScanner
        try:
            self._code_scanner = ModuleCodeScanner(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å ModuleCodeScanner —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_scanner:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleCodeScanner: {e_scanner}", exc_info=True)
            self._code_scanner = None
        
        from Systems.core.security.security_levels import SecurityLevelManager
        try:
            self._security_level_manager = SecurityLevelManager(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å SecurityLevelManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_security:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SecurityLevelManager: {e_security}", exc_info=True)
            self._security_level_manager = None
        
        from Systems.core.security.anomaly_detection import AnomalyDetector
        try:
            self._anomaly_detector = AnomalyDetector(self._settings)
            self._logger.success("–°–µ—Ä–≤–∏—Å AnomalyDetector —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_anomaly:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AnomalyDetector: {e_anomaly}", exc_info=True)
            self._anomaly_detector = None
        
        # ModuleLoader —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤—ã—à–µ

        self._logger.info("‚úÖ –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


    async def close_services(self) -> None:
        self._logger.info("–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–∫—Ä—ã—Ç–∏—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ SDB...")
        
        if self._module_loader: self._logger.debug("ModuleLoader –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._ui_registry:
            try: await self._ui_registry.dispose(); self._logger.info("UIRegistry —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ UIRegistry: {e}", exc_info=True)
        if self._event_dispatcher:
            try: await self._event_dispatcher.dispose(); self._logger.info("EventDispatcher —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ EventDispatcher: {e}", exc_info=True)
        if self._http_client_manager:
            try: await self._http_client_manager.dispose(); self._logger.info("HTTPClientManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ HTTPClientManager: {e}", exc_info=True)
        if self._cache_manager:
            try: await self._cache_manager.dispose(); self._logger.info("CacheManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ CacheManager: {e}", exc_info=True)
        
        if self._user_service: self._logger.debug("UserService –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._rbac_service: self._logger.debug("RBACService –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        
        # –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if self._audit_logger:
            try: self._audit_logger.force_flush(); self._logger.info("SecurityAuditLogger –±—É—Ñ–µ—Ä –∑–∞–ø–∏—Å–∞–Ω.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –±—É—Ñ–µ—Ä–∞ SecurityAuditLogger: {e}", exc_info=True)
        
        if self._signature_manager: self._logger.debug("ModuleSignatureManager –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._sandbox_manager: self._logger.debug("ModuleSandboxManager –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._reputation_system: self._logger.debug("ModuleReputationSystem –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._code_scanner: self._logger.debug("ModuleCodeScanner –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._security_level_manager: self._logger.debug("SecurityLevelManager –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._anomaly_detector: self._logger.debug("AnomalyDetector –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        
        if self._db_manager:
            try: await self._db_manager.dispose(); self._logger.info("DBManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ DBManager: {e}", exc_info=True)
        
        self._logger.info("üèÅ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    
    @property
    def config(self) -> 'AppSettings':
        return self._settings

    @property
    def logger(self):
        return global_logger 

    @property
    def db(self) -> 'DBManager':
        if self._db_manager is None:
            msg = "DBManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ë–î –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ."
            self._logger.critical(msg)
            raise RuntimeError(msg)
        return self._db_manager

    @property
    def rbac(self) -> 'RBACService':
        if self._rbac_service is None:
            msg = "RBACService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –§—É–Ω–∫—Ü–∏–∏ RBAC –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            self._logger.error(msg) 
            raise AttributeError(msg) 
        return self._rbac_service
    
    @property
    def user_service(self) -> 'UserService':
        if self._user_service is None:
            msg = "UserService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._user_service

    @property
    def cache(self) -> 'CacheManager':
        if self._cache_manager is None or not self._cache_manager.is_available():
            # msg = "CacheManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!" # –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å, –µ—Å–ª–∏ –∫—ç—à –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
            # self._logger.warning(msg)
            raise AttributeError("CacheManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—ç—à.")
        return self._cache_manager

    @property
    def http(self) -> 'HTTPClientManager': 
        if self._http_client_manager is None or not self._http_client_manager.is_available():
            raise AttributeError("HTTPClientManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ HTTP-–∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π HTTP-–∫–ª–∏–µ–Ω—Ç.")
        return self._http_client_manager

    @property
    def modules(self) -> 'ModuleLoader': 
        if self._module_loader is None:
            msg = "ModuleLoader –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!" 
            self._logger.critical(msg)
            raise RuntimeError(msg)
        return self._module_loader

    # Security services properties
    @property
    def signature_manager(self) -> 'ModuleSignatureManager':
        if self._signature_manager is None:
            msg = "ModuleSignatureManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._signature_manager
    
    @property
    def sandbox_manager(self) -> 'ModuleSandboxManager':
        if self._sandbox_manager is None:
            msg = "ModuleSandboxManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._sandbox_manager
    
    @property
    def audit_logger(self) -> 'SecurityAuditLogger':
        if self._audit_logger is None:
            msg = "SecurityAuditLogger –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._audit_logger
    
    @property
    def reputation_system(self) -> 'ModuleReputationSystem':
        if self._reputation_system is None:
            msg = "ModuleReputationSystem –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._reputation_system
    
    @property
    def code_scanner(self) -> 'ModuleCodeScanner':
        if self._code_scanner is None:
            msg = "ModuleCodeScanner –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._code_scanner
    
    @property
    def security_level_manager(self) -> 'SecurityLevelManager':
        if self._security_level_manager is None:
            msg = "SecurityLevelManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._security_level_manager
    
    @property
    def anomaly_detector(self) -> 'AnomalyDetector':
        if self._anomaly_detector is None:
            msg = "AnomalyDetector –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._anomaly_detector

    @property
    def events(self) -> 'EventDispatcher':
        if self._event_dispatcher is None:
            msg = "EventDispatcher –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg) 
            raise AttributeError(msg)
        return self._event_dispatcher
    
    @property
    def ui_registry(self) -> 'UIRegistry':
        if self._ui_registry is None:
            msg = "UIRegistry –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._ui_registry


======================================================================

------------------------------ FILE: Systems/core/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/bot_entrypoint.py ------------------------------
# core/bot_entrypoint.py

import asyncio
import sys
import os
from pathlib import Path
from typing import Optional, Union, List, Dict, Any, TYPE_CHECKING
from datetime import datetime, timezone

from loguru import logger as global_logger

if not (hasattr(global_logger, '_core') and hasattr(global_logger._core, 'handlers') and global_logger._core.handlers):
    try:
        global_logger.remove()
        global_logger.add(sys.stderr, level="DEBUG")
        print("!!! [SDB bot_entrypoint WARNING] Loguru handlers –±—ã–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –¥–æ–±–∞–≤–ª–µ–Ω stderr –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. !!!", file=sys.stderr)
    except Exception as e_loguru_init_fallback_entry:
        print(f"!!! [SDB bot_entrypoint CRITICAL] Loguru handlers –ø—É—Å—Ç –∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å stderr: {e_loguru_init_fallback_entry} !!!", file=sys.stderr)


from aiogram import Bot, Dispatcher, __version__ as aiogram_version
from aiogram.types import BotCommand
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage
# <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–î–ê–õ–ï–ù –ò–ú–ü–û–†–¢ RedisStorage –û–¢–°–Æ–î–ê ---
# from aiogram.fsm.storage.redis import RedisStorage
from aiogram.exceptions import TelegramRetryAfter

from Systems.core.app_settings import settings
from Systems.core.services_provider import BotServicesProvider
from Systems.core.module_loader import ModuleLoader
from Systems.core.ui.handlers_core_ui import core_ui_router
from Systems.core.i18n.middleware import I18nMiddleware
from Systems.core.i18n.translator import Translator
from Systems.core.users.middleware import UserStatusMiddleware
from Systems.core.logging_manager import LoggingManager

if TYPE_CHECKING:
    from aiogram.fsm.storage.redis import RedisStorage # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç –¥–ª—è type hinting

PID_FILENAME = "sdb_bot.pid"
CORE_COMMANDS_DESCRIPTIONS = {
    "start": "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ / –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
    "help": "‚ùì –ü–æ–º–æ—â—å –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞",
    "login": "üåê –í–æ–π—Ç–∏ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å",
    "reset_password": "üîê –°–±—Ä–æ—Å–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å",
}

try:
    from Systems.core.admin import admin_router
    ADMIN_ROUTER_AVAILABLE = True
    global_logger.info("–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä (Systems.core.admin.admin_router) —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.")
except ImportError:
    admin_router = None
    ADMIN_ROUTER_AVAILABLE = False
    global_logger.info("–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞.")


async def _setup_bot_commands(bot: Bot, services: 'BotServicesProvider', admin_router_available: bool):
    module_name_for_log = "CoreBotSetup"
    global_logger.debug(f"[{module_name_for_log}] –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –≤ Telegram...")

    final_commands_dict: Dict[str, str] = {}

    for cmd_name, cmd_desc in CORE_COMMANDS_DESCRIPTIONS.items():
        if cmd_name not in final_commands_dict:
            final_commands_dict[cmd_name] = cmd_desc
    global_logger.trace(f"[{module_name_for_log}] –î–æ–±–∞–≤–ª–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —è–¥—Ä–∞: {list(CORE_COMMANDS_DESCRIPTIONS.keys())}")

    all_loaded_plugin_modules_info = services.modules.get_loaded_modules_info(include_system=False, include_plugins=True)
    for module_info in all_loaded_plugin_modules_info:
        if module_info.manifest and module_info.manifest.commands:
            global_logger.trace(f"[{module_name_for_log}] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞: {module_info.name}")
            for cmd_manifest in module_info.manifest.commands:
                if not cmd_manifest.admin_only:
                    if cmd_manifest.command not in final_commands_dict:
                        final_commands_dict[cmd_manifest.command] = cmd_manifest.description

    # –ö–æ–º–∞–Ω–¥–∞ /admin —É–±—Ä–∞–Ω–∞ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    # –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
    # –∏ —Å–∫—Ä—ã—Ç—É—é –∫–æ–º–∞–Ω–¥—É /admin_cp –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    if admin_router_available:
        global_logger.trace(f"[{module_name_for_log}] –ê–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –∫–æ–º–∞–Ω–¥–∞ /admin –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)")

    final_bot_commands = [
        BotCommand(command=name, description=desc) for name, desc in final_commands_dict.items()
    ]

    if final_bot_commands:
        try:
            await bot.set_my_commands(final_bot_commands)
            global_logger.success(f"[{module_name_for_log}] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(final_bot_commands)} –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –≤ Telegram: "
                                  f"{[cmd.command for cmd in final_bot_commands]}")
        except Exception as e:
            global_logger.error(f"[{module_name_for_log}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞: {e}", exc_info=True)
    else:
        global_logger.warning(f"[{module_name_for_log}] –ù–µ—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Telegram.")


async def run_sdb_bot() -> int:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    from dotenv import load_dotenv
    load_dotenv('.env')
    
    from Systems.core.app_settings import load_app_settings
    settings = load_app_settings()
    
    current_process_start_time = datetime.now(timezone.utc)
    sdb_version = settings.core.sdb_version

    logging_manager = LoggingManager(app_settings=settings)
    await logging_manager.initialize_logging()

    global_logger.info(f"–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. "
                       f"–£—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞: {settings.core.log_level.upper()} (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω SDB_CLI_DEBUG_MODE_FOR_LOGGING). "
                       f"–£—Ä–æ–≤–µ–Ω—å —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–∞ –≤—Å–µ–≥–¥–∞ DEBUG (–∏–ª–∏ TRACE, –µ—Å–ª–∏ —Ç–∞–∫ –∑–∞–¥–∞–Ω–æ –≤ LoggingManager).")

    global_logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ SwiftDevBot (SDB) v{sdb_version} –≤ {current_process_start_time.strftime('%Y-%m-%d %H:%M:%S %Z')}...")
    global_logger.info(f"üêç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Python v{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")
    global_logger.info(f"ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Aiogram v{aiogram_version}")
    global_logger.debug(f"–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–ø—É—Å–∫–∞ (CWD): {Path.cwd()}")
    global_logger.debug(f"–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {settings.core.project_data_path.parent}")
    global_logger.debug(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞: {settings.core.project_data_path}")

    pid_file_actual_path = settings.core.project_data_path / PID_FILENAME
    bot: Optional[Bot] = None
    services: Optional[BotServicesProvider] = None
    exit_code_internal = 1

    if pid_file_actual_path.exists():
        try:
            old_pid = int(pid_file_actual_path.read_text().strip())
            if sys.platform != "win32":
                os.kill(old_pid, 0)
                global_logger.error(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π PID-—Ñ–∞–π–ª ({pid_file_actual_path}) –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ PID {old_pid}. "
                                   f"–ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫ SDB (PID: {os.getpid()}) –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä.")
                if logging_manager: await logging_manager.shutdown_logging()
                return 1
        except (OSError, ValueError):
            global_logger.info(f"–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ PID-—Ñ–∞–π–ª–∞: {pid_file_actual_path}")
            pid_file_actual_path.unlink(missing_ok=True)
        except Exception as e_pid_precheck:
             global_logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ PID-—Ñ–∞–π–ª–∞: {e_pid_precheck}")

    try:
        pid_file_actual_path.parent.mkdir(parents=True, exist_ok=True)
        with open(pid_file_actual_path, "w") as f:
            f.write(str(os.getpid()))
        global_logger.info(f"PID {os.getpid()} –∑–∞–ø–∏—Å–∞–Ω –≤ {pid_file_actual_path}")
    except Exception as e_pid_write:
        global_logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–∑–∞–ø–∏—Å–∞—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path}: {e_pid_write}. "
                           "–ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PID-—Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω–æ.")
    try:
        services = BotServicesProvider(settings=settings)
        await services.setup_services()
        global_logger.success("‚úÖ BotServicesProvider –∏ –≤—Å–µ –µ–≥–æ –±–∞–∑–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–æ—Ç–∞
        if not services.config.telegram.token:
            global_logger.critical("BOT_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –£–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env –∏–ª–∏ YAML –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±–æ—Ç–∞.")
            if logging_manager:
                await logging_manager.shutdown_logging()
            return 1

        bot = Bot(
            token=services.config.telegram.token,
            default=DefaultBotProperties(parse_mode=ParseMode.HTML)
        )
        me = await bot.get_me()
        global_logger.info(f"ü§ñ –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram Bot —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: @{me.username} (ID: {me.id})")

        # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–°–õ–û–í–ù–´–ô –ò–ú–ü–û–†–¢ –ò –°–û–ó–î–ê–ù–ò–ï –•–†–ê–ù–ò–õ–ò–©–ê ---
        storage: Union[MemoryStorage, "RedisStorage"]

        if services.config.cache.type == "redis" and services.cache.is_available():
            try:
                # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º RedisStorage —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
                from aiogram.fsm.storage.redis import RedisStorage
                
                redis_client_instance = await services.cache.get_redis_client_instance()
                if redis_client_instance:
                    storage = RedisStorage(redis=redis_client_instance)
                    global_logger.info("FSM Storage: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RedisStorage.")
                else:
                    global_logger.warning("Redis —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –∫–ª–∏–µ–Ω—Ç Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è FSM. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage.")
                    storage = MemoryStorage()
            except ImportError:
                global_logger.critical("–í—ã–±—Ä–∞–Ω —Ç–∏–ø –∫—ç—à–∞/FSM 'redis', –Ω–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ: pip install redis")
                global_logger.warning("FSM Storage: –§–æ–ª–ª–±—ç–∫ –Ω–∞ MemoryStorage –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ redis.")
                storage = MemoryStorage()
        else:
            storage = MemoryStorage()
            if services.config.cache.type == "redis":
                global_logger.warning("Redis –±—ã–ª –≤—ã–±—Ä–∞–Ω –¥–ª—è –∫—ç—à–∞, –Ω–æ CacheManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage –¥–ª—è FSM.")
            global_logger.info("FSM Storage: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage.")
        # <--- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        dp = Dispatcher(storage=storage, services_provider=services)
        global_logger.info("üö¶ Dispatcher –∏ FSM Storage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")

        translator = Translator(
            locales_dir=settings.core.i18n.locales_dir,
            domain=settings.core.i18n.domain,
            default_locale=settings.core.i18n.default_locale,
            available_locales=settings.core.i18n.available_locales
        )
        dp.update.outer_middleware(I18nMiddleware(translator))
        global_logger.info("I18nMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        # Rate Limiting Middleware
        from Systems.core.security.rate_limiter import RateLimitMiddleware, RateLimiter
        rate_limiter = RateLimiter(default_limit=10, default_window=60)
        rate_limiter_middleware = RateLimitMiddleware(rate_limiter)
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤ –∏–∑ rate limiting
        for admin_id in services.config.core.super_admins:
            rate_limiter_middleware.exempt_user(admin_id)
        dp.update.outer_middleware(rate_limiter_middleware)
        global_logger.info("RateLimitMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        # Input Validation Middleware
        from Systems.core.security.input_validator import InputValidationMiddleware
        input_validator_middleware = InputValidationMiddleware()
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤ –∏–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        for admin_id in services.config.core.super_admins:
            input_validator_middleware.exempt_user(admin_id)
        dp.update.outer_middleware(input_validator_middleware)
        global_logger.info("InputValidationMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        # Error Handler Middleware
        from Systems.core.errors.handler import ErrorHandlerMiddleware
        dp.update.outer_middleware(ErrorHandlerMiddleware())
        global_logger.info("ErrorHandlerMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        # Metrics Middleware
        from Systems.core.monitoring.metrics import MetricsMiddleware, get_metrics_collector
        metrics_collector = get_metrics_collector()
        dp.update.outer_middleware(MetricsMiddleware(metrics_collector))
        global_logger.info("MetricsMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        dp.update.outer_middleware(UserStatusMiddleware())
        global_logger.info("UserStatusMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        dp.include_router(core_ui_router)
        global_logger.info(f"–ë–∞–∑–æ–≤—ã–π UI-—Ä–æ—É—Ç–µ—Ä —è–¥—Ä–∞ '{core_ui_router.name}' –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")

        if ADMIN_ROUTER_AVAILABLE and admin_router:
            try:
                dp.include_router(admin_router)
                global_logger.critical(f"‚úÖ –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä '{admin_router.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                global_logger.critical(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä–∞: {e}", exc_info=True)
        else:
            global_logger.critical(f"‚ùå –ê–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ADMIN_ROUTER_AVAILABLE={ADMIN_ROUTER_AVAILABLE}, admin_router={'—Å—É—â–µ—Å—Ç–≤—É–µ—Ç' if admin_router else '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")

        module_loader: ModuleLoader = services.modules
        await module_loader.initialize_and_setup_modules(dp=dp, bot=bot)

        num_enabled_plugins = len(module_loader.enabled_plugin_names)
        num_loaded_plugins = sum(1 for mi in module_loader.get_loaded_modules_info(include_system=False, include_plugins=True) if mi.is_enabled)

        global_logger.info(
            f"üß© –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ 'Modules/': {num_loaded_plugins} –∏–∑ {num_enabled_plugins} –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ."
        )
        if num_loaded_plugins < num_enabled_plugins:
            global_logger.warning("‚ö†Ô∏è –ù–µ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ.")

        global_logger.debug("–í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã (—è–¥—Ä–∞, —Å–∏—Å—Ç–µ–º–Ω—ã–µ, –ø–ª–∞–≥–∏–Ω—ã) –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ Dispatcher.")

        if settings.core.setup_bot_commands_on_startup:
            await _setup_bot_commands(bot, services, admin_router_available=ADMIN_ROUTER_AVAILABLE)
        else:
            global_logger.info("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")

        @dp.startup()
        async def on_bot_startup():
            nonlocal sdb_version
            bot_info = await bot.get_me()
            services.logger.info(f"üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SDB Core - Dispatcher startup –¥–ª—è @{bot_info.username}...")
            try:
                await bot.delete_webhook(drop_pending_updates=True)
                services.logger.info("Webhook —É–¥–∞–ª–µ–Ω, –æ–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã.")
            except Exception as e_startup_hook:
                services.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ startup –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞: {e_startup_hook}", exc_info=True)

            services.logger.success(f"‚ö° SDB Core v{sdb_version} - –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! @{bot_info.username} –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
            if services.config.core.super_admins and services.config.core.enable_startup_shutdown_notifications:
                for admin_id in services.config.core.super_admins:
                    try:
                        await bot.send_message(admin_id, f"üöÄ **SDB Core v{sdb_version}**\n\n‚ö° –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞\nüîß –ú–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã\nüåê API –ø–æ–¥–∫–ª—é—á–µ–Ω\n\n@{bot_info.username} –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! üéØ")
                    except Exception as e_send:
                        services.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –∞–¥–º–∏–Ω—É {admin_id}: {e_send}")
            elif not services.config.core.enable_startup_shutdown_notifications:
                services.logger.info("üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")

        @dp.shutdown()
        async def on_bot_shutdown():
            nonlocal logging_manager
            bot_info = await bot.get_me()
            services.logger.info(f"üîÑ SDB Core shutdown - –ù–∞—á–∞–ª–æ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã @{bot_info.username}...")

            if services and services.config.core.super_admins and services.config.core.enable_startup_shutdown_notifications:
                for admin_id in services.config.core.super_admins:
                    try:
                        await bot.send_message(admin_id, f"üîÑ **SDB Core v{sdb_version}**\n\n‚è≥ –°–∏—Å—Ç–µ–º–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è\nüõ°Ô∏è –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\nüíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\n\n@{bot_info.username} –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è...")
                    except Exception as e_send:
                         services.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–¥–º–∏–Ω—É {admin_id}: {e_send}")
            elif services and not services.config.core.enable_startup_shutdown_notifications:
                services.logger.info("üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")

            if logging_manager:
                await logging_manager.shutdown_logging()

            if pid_file_actual_path.exists():
                try:
                    pid_in_file = int(pid_file_actual_path.read_text().strip())
                    if pid_in_file == os.getpid():
                        pid_file_actual_path.unlink(missing_ok=True)
                        global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} —É–¥–∞–ª–µ–Ω –ø—Ä–∏ —à—Ç–∞—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (on_bot_shutdown).")
                    else:
                         global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} (PID: {pid_in_file}) –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É (PID: {os.getpid()}). –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ –≤ on_bot_shutdown.")
                except Exception as e_unlink_pid_shutdown:
                    global_logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path} –≤ on_bot_shutdown: {e_unlink_pid_shutdown}")

            global_logger.info(f"‚úÖ SDB Core shutdown –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è @{bot_info.username} (—Å–µ—Ä–≤–∏—Å—ã –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã –≤ finally).")

        bot_username_for_log = (await bot.get_me()).username
        global_logger.info(f"üåê SDB Core - –ó–∞–ø—É—Å–∫ Telegram Bot Polling –¥–ª—è @{bot_username_for_log}...")

        await dp.start_polling(bot)
        exit_code_internal = 0

    except (KeyboardInterrupt, SystemExit) as e_exit:
        global_logger.info(f"üö® –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ({type(e_exit).__name__}). –ü–æ–ª–ª–∏–Ω–≥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è...")
        exit_code_internal = 0
    except Exception as e_main_run:
        global_logger.critical(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ run_sdb_bot: {e_main_run}", exc_info=True)
        exit_code_internal = 1
    finally:
        global_logger.info("–ë–ª–æ–∫ finally –≤ run_sdb_bot.")

        if bot:
            try:
                global_logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –±–æ—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ Aiogram –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ Dispatcher.start_polling.")
            except TelegramRetryAfter as e_retry:
                global_logger.warning(f"TelegramRetryAfter –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é –±–æ—Ç–∞ (–∏–ª–∏ —É–∂–µ –≤–æ –≤—Ä–µ–º—è –µ–µ –∑–∞–∫—Ä—ã—Ç–∏—è Aiogram): {e_retry}")
            except Exception as e_bot_close:
                global_logger.warning(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –æ–±—ä–µ–∫—Ç–æ–º –±–æ—Ç–∞ –≤ finally: {type(e_bot_close).__name__} - {e_bot_close}", exc_info=True)

        if services:
            try:
                await services.close_services()
                global_logger.info("–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã BotServicesProvider –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –±–ª–æ–∫–µ finally.")
            except Exception as e_services_close:
                global_logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –±–ª–æ–∫–µ finally: {e_services_close}", exc_info=True)

        if logging_manager and logging_manager._is_initialized:
            await logging_manager.shutdown_logging()

        if pid_file_actual_path.exists():
            try:
                pid_in_file = int(pid_file_actual_path.read_text().strip())
                if pid_in_file == os.getpid():
                    pid_file_actual_path.unlink(missing_ok=True)
                    global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} —É–¥–∞–ª–µ–Ω/–ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ –±–ª–æ–∫–µ finally.")
            except Exception as e_final_pid_unlink:
                global_logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path}: {e_final_pid_unlink}")

        bot_name_display = getattr(bot, 'id', 'N/A') if bot else 'N/A'
        if bot and hasattr(bot, 'username') and bot.username:
            bot_name_display = f"@{bot.username} (ID: {bot.id})"

        global_logger.info(f"üéØ SDB Core –∑–∞–≤–µ—Ä—à–µ–Ω ({bot_name_display}) - –ö–æ–¥ –≤—ã—Ö–æ–¥–∞: {exit_code_internal}")
        return exit_code_internal


======================================================================

------------------------------ FILE: Systems/core/logging_manager.py ------------------------------
# core/logging_manager.py
import asyncio
import shutil
from pathlib import Path
from datetime import datetime, timedelta, timezone
from typing import Optional, Any, TYPE_CHECKING

from loguru import logger as global_logger 
import parsedatetime as pdt 
from apscheduler.schedulers.asyncio import AsyncIOScheduler 
from apscheduler.triggers.cron import CronTrigger

if TYPE_CHECKING:
    from Systems.core.app_settings import AppSettings

class LoggingManager:
    def __init__(self, app_settings: 'AppSettings'):
        self._settings = app_settings.core
        self._app_settings_ref = app_settings 
        self._current_log_handler_id: Optional[int] = None
        self._current_log_file_path: Optional[Path] = None
        self._scheduler: Optional[AsyncIOScheduler] = None
        self._is_initialized = False

        self._logger = global_logger.bind(service="LoggingManager")
        self._logger.info("LoggingManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def _get_log_file_path_for_current_hour(self) -> Path:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ –ª–æ–≥-—Ñ–∞–π–ª—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏."""
        now = datetime.now(timezone.utc)
        year_str = now.strftime("%Y")
        month_num_str = now.strftime("%m")
        month_name_str = now.strftime("%B") # –ò–º—è –º–µ—Å—è—Ü–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–∫–∞–ª–∏ —Å–∏—Å—Ç–µ–º—ã
        day_str = now.strftime("%d")
        hour_str = now.strftime("%H")

        base_logs_dir = self._app_settings_ref.core.project_data_path / self._settings.log_structured_dir
        
        target_dir = base_logs_dir / year_str / f"{month_num_str}-{month_name_str}" / day_str
        target_dir.mkdir(parents=True, exist_ok=True)
        
        return target_dir / f"{hour_str}_sdb.log"

    def _setup_loguru_file_sink(self) -> None: 
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç (–∏–ª–∏ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç) —Ñ–∞–π–ª–æ–≤—ã–π sink –¥–ª—è Loguru."""
        if self._current_log_handler_id is not None:
            try:
                global_logger.remove(self._current_log_handler_id)
                self._logger.trace(f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä (ID: {self._current_log_handler_id}) —É–¥–∞–ª–µ–Ω.")
            except ValueError:
                self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä ID: {self._current_log_handler_id} (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω).")
            self._current_log_handler_id = None
            self._current_log_file_path = None

        if not self._settings.log_to_file:
            self._logger.info("–ó–∞–ø–∏—Å—å –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")
            return

        new_log_file_path = self._get_log_file_path_for_current_hour()
        
        # --- –ñ–ï–°–¢–ö–û –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –£–†–û–í–ï–ù–¨ –î–õ–Ø –§–ê–ô–õ–û–í–û–ì–û –õ–û–ì–ê ---
        log_level_for_file = "DEBUG"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º DEBUG –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω TRACE, –∏–∑–º–µ–Ω–∏ –∑–¥–µ—Å—å:
        # log_level_for_file = "TRACE" 
        # ---------------------------------------------------------
        
        try:
            handler_id = global_logger.add(
                sink=str(new_log_file_path),
                level=log_level_for_file, 
                rotation=self._settings.log_rotation_size, 
                compression="zip",
                format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | {name}:{function}:{line} - {message}",
                encoding="utf-8",
                enqueue=True,
                backtrace=True,
                diagnose=True 
            )
            self._current_log_handler_id = handler_id
            self._current_log_file_path = new_log_file_path
            self._logger.success(f"–§–∞–π–ª–æ–≤—ã–π –ª–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£—Ä–æ–≤–µ–Ω—å: {log_level_for_file}. –§–∞–π–ª: {new_log_file_path}")
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è '{new_log_file_path}': {e}", exc_info=True)
            self._current_log_handler_id = None
            self._current_log_file_path = None

    async def _hourly_log_rotation_check(self) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥-—Ñ–∞–π–ª (–Ω–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π —á–∞—Å)."""
        self._logger.trace("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ—á–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤...")
        if not self._is_initialized or not self._settings.log_to_file:
            self._logger.trace("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–æ.")
            return

        expected_log_file = self._get_log_file_path_for_current_hour()
        if self._current_log_file_path != expected_log_file:
            self._logger.info(f"–ù–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π —á–∞—Å. –ü–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ –Ω–∞: {expected_log_file}")
            self._setup_loguru_file_sink() 
        else:
            self._logger.trace(f"–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥-—Ñ–∞–π–ª–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª: {self._current_log_file_path}")

    async def _cleanup_old_logs(self) -> None:
        """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ log_retention_period_structured."""
        self._logger.info("–ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤...")
        if not self._settings.log_to_file:
            self._logger.info("–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–∞: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–æ.")
            return

        retention_str = self._settings.log_retention_period_structured
        cal = pdt.Calendar()
        
        now_dt = datetime.now(timezone.utc)
        past_target_dt, parse_status = cal.parseDT(f"{retention_str} ago", sourceTime=now_dt) # type: ignore
        
        if parse_status == 0 or not past_target_dt:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤: '{retention_str}'. –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
            return
        
        cutoff_date = past_target_dt 
        self._logger.info(f"–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ {cutoff_date.strftime('%Y-%m-%d %H:%M:%S %Z')} (–ø–µ—Ä–∏–æ–¥: '{retention_str}').")

        structured_logs_root = self._app_settings_ref.core.project_data_path / self._settings.log_structured_dir
        if not structured_logs_root.is_dir():
            return

        deleted_dirs_count = 0
        for year_dir in structured_logs_root.iterdir():
            if year_dir.is_dir() and year_dir.name.isdigit():
                if int(year_dir.name) < cutoff_date.year:
                    try:
                        shutil.rmtree(year_dir)
                        self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–≥–æ–¥): {year_dir}")
                        deleted_dirs_count += 1
                    except Exception as e_rm_year:
                        self._logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ '{year_dir}': {e_rm_year}")
                    continue 

                if int(year_dir.name) == cutoff_date.year:
                    for month_dir in year_dir.iterdir():
                        if month_dir.is_dir() and "-" in month_dir.name:
                            try:
                                month_num_str = month_dir.name.split("-")[0]
                                if month_num_str.isdigit() and int(month_num_str) < cutoff_date.month:
                                    shutil.rmtree(month_dir)
                                    self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–º–µ—Å—è—Ü): {month_dir}")
                                    deleted_dirs_count +=1
                                    continue
                                
                                if int(month_num_str) == cutoff_date.month:
                                    for day_dir in month_dir.iterdir():
                                        if day_dir.is_dir() and day_dir.name.isdigit():
                                            if int(day_dir.name) < cutoff_date.day:
                                                shutil.rmtree(day_dir)
                                                self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–¥–µ–Ω—å): {day_dir}")
                                                deleted_dirs_count += 1
                            except Exception as e_rm_month_day:
                                self._logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ '{month_dir}' –∏–ª–∏ –µ–µ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {e_rm_month_day}")
        if deleted_dirs_count > 0:
            self._logger.success(f"–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π: {deleted_dirs_count}.")
        else:
            self._logger.info("–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")


    async def initialize_logging(self) -> None: 
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—è —Ñ–∞–π–ª–æ–≤—ã–π sink –∏ –∑–∞–¥–∞—á–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é."""
        if self._is_initialized:
            self._logger.info("LoggingManager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return

        self._logger.info("–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LoggingManager...")
        
        self._setup_loguru_file_sink() 
        
        self._scheduler = AsyncIOScheduler(timezone=str(timezone.utc))
        self._scheduler.add_job(self._hourly_log_rotation_check, CronTrigger(minute=0)) 
        self._logger.info("–ó–∞–¥–∞—á–∞ _hourly_log_rotation_check –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–µ–∂–µ—á–∞—Å–Ω–æ).")
        self._scheduler.add_job(self._cleanup_old_logs, CronTrigger(hour=3, minute=30)) 
        self._logger.info("–ó–∞–¥–∞—á–∞ _cleanup_old_logs –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:30 UTC).")
        
        try:
            self._scheduler.start()
            self._logger.success("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")
        except Exception as e_scheduler_start:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager: {e_scheduler_start}", exc_info=True)
            self._scheduler = None 

        self._is_initialized = True
        self._logger.info("LoggingManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def shutdown_logging(self) -> None:
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É."""
        self._logger.info("–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ LoggingManager...")
        if self._scheduler and self._scheduler.running:
            try:
                self._scheduler.shutdown(wait=False) 
                self._logger.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
            except Exception as e_scheduler_shutdown:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ LoggingManager: {e_scheduler_shutdown}", exc_info=True)
        
        if self._current_log_handler_id is not None:
            try:
                global_logger.remove(self._current_log_handler_id)
                self._logger.info(f"–§–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä (ID: {self._current_log_handler_id}) —É–¥–∞–ª–µ–Ω –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.")
            except ValueError:
                pass 
        
        self._is_initialized = False
        self._logger.info("LoggingManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")


======================================================================

------------------------------ FILE: Systems/core/module_loader.py ------------------------------
# core/module_loader.py

import asyncio
import importlib
import importlib.util
import json
import re
import shutil
import sys
from pathlib import Path
from typing import (TYPE_CHECKING, Any, Callable, Dict, List, Optional, Tuple,
                    Type)

import yaml  # type: ignore
from aiogram import Bot, Dispatcher
from loguru import logger
from pydantic import BaseModel as PydanticBaseModel
from pydantic import ValidationError

# –î–æ–±–∞–≤–ª—è–µ–º PermissionManifest –≤ –∏–º–ø–æ—Ä—Ç—ã
from .schemas.module_manifest import (ModuleManifest, PermissionManifest,
                                      SettingManifest)

if TYPE_CHECKING:
    from .app_settings import AppSettings, CoreAppSettings
    from .services_provider import BotServicesProvider

MANIFEST_YAML_NAME = "manifest.yaml"
MANIFEST_JSON_NAME = "manifest.json"
MODULE_ENTRY_POINT_FILENAME = "__init__.py"
SETUP_FUNCTION_NAME = "setup_module"
USER_MODULES_SETTINGS_DIR_NAME = "modules_settings"
MODULE_DEFAULT_SETTINGS_FILENAME = "module_settings.yaml"


class ModuleInfo:
    def __init__(
        self,
        name: str,
        path: Path,
        manifest: Optional[ModuleManifest] = None,
        is_enabled: bool = False,
        error: Optional[str] = None,
        is_system_module: bool = False,
    ):
        self.name: str = name
        self.path: Path = path
        self.manifest: Optional[ModuleManifest] = manifest
        self.is_enabled: bool = is_enabled
        self.is_loaded_successfully: bool = False
        self.error: Optional[str] = error
        self.imported_py_module: Optional[Any] = None
        self.is_system_module: bool = is_system_module
        self.current_settings: Dict[str, Any] = {}

    def __repr__(self) -> str:
        status_parts = []
        if self.is_system_module:
            status_parts.append("system")
        if self.is_enabled or self.is_system_module:
            status_parts.append("active_target")
        if self.is_loaded_successfully:
            status_parts.append("loaded")
        if self.current_settings:
            status_parts.append("settings_loaded")
        if self.error:
            status_parts.append(f"error='{self.error[:30]}...'")
        status_str = ", ".join(status_parts) if status_parts else "discovered"
        return f"<ModuleInfo name='{self.name}' ({status_str})>"


class ModuleLoader:
    def __init__(self, settings: "AppSettings", services_provider: "BotServicesProvider"):
        self._settings: "AppSettings" = settings
        self._services: "BotServicesProvider" = services_provider
        self._core_settings: "CoreAppSettings" = self._settings.core

        self.plugins_root_dir: Path = settings.core.project_data_path.parent / "Modules"
        self.core_sys_modules_root_dir: Path = settings.core.project_data_path.parent / "Systems" / "core" / "sys_modules"

        self.user_module_settings_base_path: Path = (
            self._core_settings.project_data_path / "Config" / USER_MODULES_SETTINGS_DIR_NAME
        )
        self.user_module_settings_base_path.mkdir(parents=True, exist_ok=True)

        self.available_modules: Dict[str, ModuleInfo] = {}
        self.enabled_plugin_names: List[str] = []

        self._logger = logger.bind(service="ModuleLoader")
        self._logger.info(
            f"ModuleLoader –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. "
            f"–ü–ª–∞–≥–∏–Ω—ã: {self.plugins_root_dir.resolve()}, "
            f"–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏: {self.core_sys_modules_root_dir.resolve()}, "
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª–µ–π: {self.user_module_settings_base_path.resolve()}"
        )

    def _parse_manifest_file(
        self, module_path: Path, module_name_override: Optional[str] = None
    ) -> Optional[ModuleManifest]:
        yaml_manifest_path = module_path / MANIFEST_YAML_NAME
        json_manifest_path = module_path / MANIFEST_JSON_NAME
        manifest_file_to_parse: Optional[Path] = None
        parser_type: Optional[str] = None

        if yaml_manifest_path.is_file():
            manifest_file_to_parse = yaml_manifest_path
            parser_type = "yaml"
            if json_manifest_path.is_file():
                self._logger.warning(
                    f"–í –º–æ–¥—É–ª–µ '{module_path.name}' –Ω–∞–π–¥–µ–Ω—ã –∏ YAML, –∏ JSON –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è YAML."
                )
        elif json_manifest_path.is_file():
            manifest_file_to_parse = json_manifest_path
            parser_type = "json"

        if not manifest_file_to_parse:
            is_plugin = not (module_path.parent.name == "sys_modules" and module_path.parent.parent.name == "core")
            log_func = self._logger.warning if is_plugin else self._logger.debug
            log_func(f"–ú–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –º–æ–¥—É–ª—è '{module_path.name}'.")
            return None
        try:
            with open(manifest_file_to_parse, "r", encoding="utf-8") as f:
                data = yaml.safe_load(f) if parser_type == "yaml" else json.load(f)
            if not data:
                self._logger.error(f"–ú–∞–Ω–∏—Ñ–µ—Å—Ç {manifest_file_to_parse.name} –≤ –º–æ–¥—É–ª–µ {module_path.name} –ø—É—Å—Ç.")
                return None

            if module_name_override and "name" not in data:
                data["name"] = module_name_override
            elif "name" in data and module_name_override and data["name"] != module_name_override:
                self._logger.warning(
                    f"–ò–º—è –º–æ–¥—É–ª—è –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ ('{data['name']}') –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ –ø–∞–ø–∫–∏ ('{module_name_override}') "
                    f"–¥–ª—è {manifest_file_to_parse.name}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–º—è –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: '{data['name']}'."
                )

            manifest = ModuleManifest(**data)
            return manifest
        except Exception as e:
            self._logger.error(
                f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞/–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ {manifest_file_to_parse.name} –≤ {module_path.name}: {e}",
                exc_info=True,
            )
        return None

    def _scan_directory_for_modules(self, directory: Path, is_system_dir: bool) -> None:
        if not directory.is_dir():
            self._logger.warning(
                f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {'—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π' if is_system_dir else '–ø–ª–∞–≥–∏–Ω–æ–≤'} {directory} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
            )
            return

        for module_dir_path in directory.iterdir():
            if module_dir_path.is_dir() and not module_dir_path.name.startswith((".", "_")):
                module_name_from_path = module_dir_path.name
                manifest = self._parse_manifest_file(
                    module_dir_path, module_name_override=module_name_from_path if is_system_dir else None
                )

                actual_module_name = manifest.name if manifest and manifest.name else module_name_from_path

                if actual_module_name in self.available_modules:
                    self._logger.warning(
                        f"–î—É–±–ª–∏—Ä—É—é—â–µ–µ—Å—è –∏–º—è –º–æ–¥—É–ª—è '{actual_module_name}' (–∏–∑ –ø–∞–ø–∫–∏ '{module_dir_path.name}', "
                        f"—Ç–∏–ø: {'—Å–∏—Å—Ç–µ–º–Ω—ã–π' if is_system_dir else '–ø–ª–∞–≥–∏–Ω'}). "
                        f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥—É–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö."
                    )

                module_info = ModuleInfo(
                    name=actual_module_name,
                    path=module_dir_path,
                    manifest=manifest,
                    is_system_module=is_system_dir,
                    is_enabled=is_system_dir,
                )

                if manifest and manifest.settings:
                    self._load_and_validate_module_settings(module_info)

                self.available_modules[actual_module_name] = module_info
                log_msg_type = "—Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å" if is_system_dir else "–ø–ª–∞–≥–∏–Ω"
                log_msg_details = f"v{manifest.version}" if manifest and manifest.version else "–±–µ–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞/–≤–µ—Ä—Å–∏–∏"
                self._logger.info(
                    f"–ù–∞–π–¥–µ–Ω {log_msg_type} '{actual_module_name}' ({log_msg_details}) –≤ '{module_dir_path.name}'."
                )

    def _load_and_validate_module_settings(self, module_info: ModuleInfo) -> None:
        module_name = module_info.name
        manifest = module_info.manifest
        module_info.current_settings = {}

        if not manifest or not manifest.settings:
            return

        module_default_config_file = module_info.path / MODULE_DEFAULT_SETTINGS_FILENAME
        user_module_config_file = self.user_module_settings_base_path / f"{module_name}.yaml"

        final_settings: Dict[str, Any] = {}
        for key, setting_mft_def in manifest.settings.items():
            final_settings[key] = setting_mft_def.default

        module_defaults_from_file: Dict[str, Any] = {}
        if module_default_config_file.is_file():
            try:
                with open(module_default_config_file, "r", encoding="utf-8") as f:
                    module_defaults_from_file = yaml.safe_load(f) or {}
                final_settings.update(module_defaults_from_file)
                self._logger.trace(
                    f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ —Ñ–∞–π–ª–∞ –º–æ–¥—É–ª—è '{module_name}': {module_default_config_file}"
                )
            except Exception as e:
                self._logger.warning(
                    f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{module_default_config_file}' –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}."
                )

        if not user_module_config_file.exists():
            self._logger.info(
                f"–§–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω ({user_module_config_file})."
            )
            source_for_user_config = final_settings.copy()

            if source_for_user_config:
                try:
                    user_module_config_file.parent.mkdir(parents=True, exist_ok=True)
                    with open(user_module_config_file, "w", encoding="utf-8") as f:
                        yaml.dump(source_for_user_config, f, indent=2, sort_keys=False, allow_unicode=True)
                    self._logger.info(
                        f"–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è '{module_name}' –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ñ–æ–ª—Ç–æ–≤: {user_module_config_file}"
                    )
                except Exception as e_create_user_cfg:
                    self._logger.error(
                        f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è '{module_name}': {e_create_user_cfg}."
                    )
            else:
                self._logger.info(
                    f"–î–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞. –§–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω."
                )
        else:
            try:
                with open(user_module_config_file, "r", encoding="utf-8") as f:
                    user_settings_from_file = yaml.safe_load(f) or {}
                self._logger.info(
                    f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –∏–∑: {user_module_config_file}"
                )
                final_settings.update(user_settings_from_file)
            except Exception as e_load_user:
                self._logger.error(
                    f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ '{user_module_config_file}' –¥–ª—è '{module_name}': {e_load_user}."
                )

        validated_settings: Dict[str, Any] = {}
        validation_errors: List[str] = []

        for key, setting_mft_def in manifest.settings.items():
            value_to_validate = final_settings.get(key)

            if value_to_validate is None:
                if setting_mft_def.required:
                    validation_errors.append(
                        f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{setting_mft_def.label}' ({key}) –º–æ–¥—É–ª—è '{module_name}'."
                    )
                    continue
                else:
                    validated_settings[key] = None
                    continue

            try:
                validated_value = value_to_validate
                if setting_mft_def.type == "bool":
                    if isinstance(value_to_validate, str):
                        validated_value = value_to_validate.lower() in ["true", "1", "yes", "on", "t"]
                    else:
                        validated_value = bool(value_to_validate)
                elif setting_mft_def.type == "int":
                    validated_value = int(value_to_validate)
                elif setting_mft_def.type == "float":
                    validated_value = float(value_to_validate)
                elif setting_mft_def.type in ["string", "text"]:
                    validated_value = str(value_to_validate)

                key_specific_errors = False
                if setting_mft_def.type == "string" and setting_mft_def.regex_validator:
                    if not re.fullmatch(setting_mft_def.regex_validator, str(validated_value)):
                        validation_errors.append(
                            f"–ó–Ω–∞—á–µ–Ω–∏–µ '{validated_value}' –¥–ª—è '{key}' –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç regex: {setting_mft_def.regex_validator}"
                        )
                        key_specific_errors = True
                if setting_mft_def.type in ["int", "float"]:
                    if setting_mft_def.min_value is not None and validated_value < setting_mft_def.min_value:  # type: ignore
                        validation_errors.append(
                            f"–ó–Ω–∞—á–µ–Ω–∏–µ {validated_value} –¥–ª—è '{key}' < min ({setting_mft_def.min_value})"
                        )
                        key_specific_errors = True
                    if setting_mft_def.max_value is not None and validated_value > setting_mft_def.max_value:  # type: ignore
                        validation_errors.append(
                            f"–ó–Ω–∞—á–µ–Ω–∏–µ {validated_value} –¥–ª—è '{key}' > max ({setting_mft_def.max_value})"
                        )
                        key_specific_errors = True
                if setting_mft_def.type == "choice" and setting_mft_def.options:
                    option_values = [
                        opt.value if isinstance(opt, PydanticBaseModel) else opt for opt in setting_mft_def.options
                    ]
                    if validated_value not in option_values:
                        validation_errors.append(
                            f"–ó–Ω–∞—á–µ–Ω–∏–µ '{validated_value}' –¥–ª—è '{key}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º ({option_values})."
                        )
                        key_specific_errors = True

                if not key_specific_errors:
                    validated_settings[key] = validated_value

            except (ValueError, TypeError) as e_val:
                validation_errors.append(
                    f"–û—à–∏–±–∫–∞ —Ç–∏–ø–∞/–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è '{key}' ('{value_to_validate}'): –æ–∂–∏–¥–∞–ª—Å—è {setting_mft_def.type}. {e_val}"
                )
            except Exception as e_unknown_val:
                validation_errors.append(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è '{key}': {e_unknown_val}")

        if validation_errors:
            error_message = f"–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥—É–ª—è '{module_name}': {'; '.join(validation_errors)}"
            if module_info.error:
                module_info.error += f"; {error_message}"
            else:
                module_info.error = error_message
            self._logger.error(error_message)

        module_info.current_settings = validated_settings
        if validated_settings or not manifest.settings:
            self._logger.info(f"–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã.")
            if validated_settings:
                self._logger.debug(f"–ò—Ç–æ–≥–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è '{module_name}': {validated_settings}")
        else:
            self._logger.warning(
                f"–î–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å/–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Ö–æ—Ç—è –æ–Ω–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ."
            )

    def scan_all_available_modules(self) -> None:
        self.available_modules.clear()
        self._logger.info("–ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π...")
        self._scan_directory_for_modules(self.plugins_root_dir, is_system_dir=False)
        self._scan_directory_for_modules(self.core_sys_modules_root_dir, is_system_dir=True)
        self._logger.info(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {len(self.available_modules)}")

    def _load_enabled_plugin_names(self) -> None:
        config_file = self._core_settings.enabled_modules_config_path
        self.enabled_plugin_names.clear()
        if config_file.is_file():
            try:
                with open(config_file, "r", encoding="utf-8") as f:
                    data = json.load(f)
                if isinstance(data, list):
                    self.enabled_plugin_names = [m_name for m_name in data if isinstance(m_name, str)]
                elif isinstance(data, dict) and "active_modules" in data and isinstance(data["active_modules"], list):
                    self.enabled_plugin_names = [m_name for m_name in data["active_modules"] if isinstance(m_name, str)]
                else:
                    self._logger.error(
                        f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ {config_file}. –û–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ –∏–ª–∏ {{'active_modules': [...]}}."
                    )

                for name, module_info in self.available_modules.items():
                    if not module_info.is_system_module:
                        module_info.is_enabled = name in self.enabled_plugin_names
                self._logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ {config_file}: {self.enabled_plugin_names}")
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ {config_file}: {e}", exc_info=True)
        else:
            self._logger.warning(f"–§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ {config_file} –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    def _check_module_dependencies(self, module_info: ModuleInfo) -> bool:
        if not module_info.manifest:
            return True
        if module_info.manifest.metadata and module_info.manifest.metadata.min_sdb_core_version:
            from packaging.version import parse as parse_version

            current_sdb_version_str = self._settings.core.sdb_version
            try:
                if parse_version(current_sdb_version_str) < parse_version(
                    module_info.manifest.metadata.min_sdb_core_version
                ):
                    module_info.error = (
                        f"–¢—Ä–µ–±—É–µ—Ç—Å—è —è–¥—Ä–æ SDB v >= {module_info.manifest.metadata.min_sdb_core_version}, "
                        f"—Ç–µ–∫—É—â–∞—è: {current_sdb_version_str}."
                    )
                    self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}")
                    return False
            except Exception as e_ver:
                self._logger.error(f"–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —è–¥—Ä–∞ –¥–ª—è '{module_info.name}': {e_ver}")
                module_info.error = "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞."
                return False

        if module_info.manifest.sdb_module_dependencies:
            for dep_name in module_info.manifest.sdb_module_dependencies:
                dep_info = self.available_modules.get(dep_name)
                if (
                    not dep_info
                    or not (dep_info.is_enabled or dep_info.is_system_module)
                    or not dep_info.is_loaded_successfully
                ):
                    new_error_msg = f"–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–π –∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å '{dep_name}'."
                    module_info.error = (module_info.error + "; " if module_info.error else "") + new_error_msg
                    self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {new_error_msg}")
                    return False
        return True

    async def _setup_single_module(
        self, module_info: ModuleInfo, dp: Dispatcher, bot: Bot, import_base_path: str
    ) -> None:
        if not module_info.manifest and not module_info.is_system_module:
            module_info.error = "–ú–∞–Ω–∏—Ñ–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
            self._logger.error(f"–ü–ª–∞–≥–∏–Ω '{module_info.name}': {module_info.error}")
            return

        if module_info.error:
            self._logger.error(
                f"–ú–æ–¥—É–ª—å '{module_info.name}' –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}"
            )
            return

        if not self._check_module_dependencies(module_info):
            return

        entry_point_py_file = module_info.path / MODULE_ENTRY_POINT_FILENAME
        if not entry_point_py_file.is_file():
            module_info.error = f"–§–∞–π–ª —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ '{MODULE_ENTRY_POINT_FILENAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
            self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}")
            return
        try:
            import_path_str = f"{import_base_path}.{module_info.path.name}"
            self._logger.debug(f"–ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è '{module_info.name}' —á–µ—Ä–µ–∑ '{import_path_str}'...")
            loaded_py_module = importlib.import_module(import_path_str)
            module_info.imported_py_module = loaded_py_module
            if not hasattr(loaded_py_module, SETUP_FUNCTION_NAME):
                module_info.error = f"–§—É–Ω–∫—Ü–∏—è '{SETUP_FUNCTION_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
                self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}")
                return

            setup_function: Callable = getattr(loaded_py_module, SETUP_FUNCTION_NAME)
            self._logger.info(f"–í—ã–∑–æ–≤ {SETUP_FUNCTION_NAME}() –¥–ª—è –º–æ–¥—É–ª—è '{module_info.name}'...")
            if asyncio.iscoroutinefunction(setup_function):
                await setup_function(dp=dp, bot=bot, services=self._services)
            else:
                setup_function(dp=dp, bot=bot, services=self._services)
            module_info.is_loaded_successfully = True
            self._logger.success(f"‚úÖ –ú–æ–¥—É–ª—å '{module_info.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e:
            module_info.error = f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}"
            self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}", exc_info=True)

    async def initialize_and_setup_modules(self, dp: Dispatcher, bot: Bot) -> None:
        self.scan_all_available_modules()
        self._load_enabled_plugin_names()

        # –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ —è–¥—Ä–∞
        self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞...")
        for module_name, module_info in self.available_modules.items():
            if module_info.is_system_module:
                if module_info.error:
                    self._logger.error(
                        f"–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å '{module_name}' –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}"
                    )
                    continue
                await self._setup_single_module(
                    module_info,
                    dp,
                    bot,
                    import_base_path="Systems." + self.core_sys_modules_root_dir.parent.name
                    + "."
                    + self.core_sys_modules_root_dir.name,
                )
        self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

        if not self.enabled_plugin_names:
            self._logger.info("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")
        else:
            self._logger.info(f"–ù–∞—Å—Ç—Ä–æ–π–∫–∞ {len(self.enabled_plugin_names)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤...")
            for plugin_name in self.enabled_plugin_names:
                module_info = self.available_modules.get(plugin_name)
                if not module_info:
                    self._logger.error(f"–ê–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–≥–∏–Ω '{plugin_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫.")
                    continue
                if module_info.is_system_module:
                    self._logger.warning(f"–ú–æ–¥—É–ª—å '{plugin_name}' —Å–∏—Å—Ç–µ–º–Ω—ã–π, –Ω–æ –≤ —Å–ø–∏—Å–∫–µ –ø–ª–∞–≥–∏–Ω–æ–≤. –ü—Ä–æ–ø—É—Å–∫.")
                    continue
                if module_info.error:
                    self._logger.error(
                        f"–ú–æ–¥—É–ª—å '{plugin_name}' –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}"
                    )
                    continue
                await self._setup_single_module(module_info, dp, bot, import_base_path="Modules")
            self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

    def get_module_info(self, module_name: str) -> Optional[ModuleInfo]:
        return self.available_modules.get(module_name)

    def get_all_modules_info(self) -> List[ModuleInfo]:
        return list(self.available_modules.values())

    def get_loaded_modules_info(self, include_system: bool = True, include_plugins: bool = True) -> List[ModuleInfo]:
        loaded = []
        for info in self.available_modules.values():
            if info.is_loaded_successfully:
                if (info.is_system_module and include_system) or (not info.is_system_module and include_plugins):
                    loaded.append(info)
        return loaded

    def get_module_settings(self, module_name: str) -> Optional[Dict[str, Any]]:
        module_info = self.get_module_info(module_name)
        if module_info:
            if module_info.current_settings:
                return module_info.current_settings
            elif module_info.manifest and module_info.manifest.settings:
                manifest_defaults = {
                    k: v.default for k, v in module_info.manifest.settings.items() if v.default is not None
                }
                if manifest_defaults:
                    self._logger.debug(
                        f"current_settings –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –ø—É—Å—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç—ã –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞."
                    )
                    return manifest_defaults
                else:
                    self._logger.debug(
                        f"–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ."
                    )
                    return {}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ current_settings, –Ω–∏ –¥–µ—Ñ–æ–ª—Ç–æ–≤ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
            else:
                self._logger.debug(f"–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")
                return {}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
        self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è '{module_name}'.")
        return None

    def get_all_declared_permissions_from_active_modules(self) -> List[PermissionManifest]:
        """
        –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö
        (enabled) –ø–ª–∞–≥–∏–Ω–æ–≤, –∞ —Ç–∞–∫–∂–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.
        –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–æ–¥—É–ª–∏ –±–µ–∑ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
        """
        all_perms: Dict[str, PermissionManifest] = {}

        modules_to_check: List[ModuleInfo] = []
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã
        for module_name in self.enabled_plugin_names:
            module_info = self.available_modules.get(module_name)
            if module_info and not module_info.is_system_module and not module_info.error:
                modules_to_check.append(module_info)

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏
        for module_info in self.available_modules.values():
            if module_info.is_system_module and not module_info.error:
                if (
                    module_info not in modules_to_check
                ):  # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å –∫–∞–∫-—Ç–æ –ø–æ–ø–∞–ª –≤ enabled_plugin_names
                    modules_to_check.append(module_info)

        for module_info in modules_to_check:
            if module_info.manifest and module_info.manifest.declared_permissions:
                for perm_mft in module_info.manifest.declared_permissions:
                    if perm_mft.name not in all_perms:
                        all_perms[perm_mft.name] = perm_mft
                    else:
                        self._logger.warning(
                            f"–î—É–±–ª–∏—Ä—É—é—â–µ–µ—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{perm_mft.name}' "
                            f"–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ (–º–æ–¥—É–ª—å: '{module_info.name}'). –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–µ—Ä–≤–æ–µ –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω–æ–µ."
                        )

        num_perms = len(all_perms)
        if num_perms > 0:
            self._logger.info(f"–°–æ–±—Ä–∞–Ω–æ {num_perms} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã–º–∏/—Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –º–æ–¥—É–ª—è–º–∏.")
        else:
            self._logger.info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö/—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.")
        return list(all_perms.values())



======================================================================

------------------------------ FILE: Systems/core/ui/callback_data_factories.py ------------------------------
# SwiftDevBot/core/ui/callback_data_factories.py
from typing import Optional, Literal, Union 
from aiogram.filters.callback_data import CallbackData

CORE_CALLBACK_PREFIX = "sdb_core"
ADMIN_CALLBACK_PREFIX = "sdb_admin" 

# --- –§–∞–±—Ä–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —è–¥—Ä–∞ ---
class CoreMenuNavigate(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_nav"):
    target_menu: str 
    page: Optional[int] = None
    action: Optional[str] = None 
    # –î–æ–±–∞–≤–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–¥–∞ —è–∑—ã–∫–∞
    payload: Optional[str] = None 

class ModuleMenuEntry(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_module_entry"):
    module_name: str

class CoreServiceAction(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_service"):
    action: Literal[
        "delete_this_message", 
        "close_menu_silently",
        "confirm_registration", 
        "cancel_registration",
        "confirm_reset_password",
        "cancel_reset_password",
    ]

# --- –§–∞–±—Ä–∏–∫–∏ –¥–ª—è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ---
# ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
ADMIN_MAIN_MENU_PREFIX = "sdb_admin_main"
class AdminMainMenuNavigate(CallbackData, prefix=ADMIN_MAIN_MENU_PREFIX):
    target_section: str 

ADMIN_USERS_PREFIX = "sdb_admin_users"
class AdminUsersPanelNavigate(CallbackData, prefix=ADMIN_USERS_PREFIX):
    action: str 
    item_id: Optional[int] = None       
    page: Optional[int] = None          
    role_id: Optional[int] = None       
    permission_id: Optional[int] = None 
    
    category_key: Optional[str] = None 
    entity_name: Optional[str] = None  


ADMIN_ROLES_PREFIX = "sdb_admin_roles"
class AdminRolesPanelNavigate(CallbackData, prefix=ADMIN_ROLES_PREFIX):
    action: str 
    item_id: Optional[int] = None       
    permission_id: Optional[int] = None 
    category_key: Optional[str] = None  
    entity_name: Optional[str] = None   
    page: Optional[int] = None          

ADMIN_SYSINFO_PREFIX = "sdb_admin_sysinfo"
class AdminSysInfoPanelNavigate(CallbackData, prefix=ADMIN_SYSINFO_PREFIX):
    action: str 

ADMIN_MODULES_PREFIX = "sdb_admin_modules"
class AdminModulesPanelNavigate(CallbackData, prefix=ADMIN_MODULES_PREFIX):
    action: str 
    item_id: Optional[str] = None 
    page: Optional[int] = None

ADMIN_LOGS_PREFIX = "sdb_admin_logs"
class AdminLogsPanelNavigate(CallbackData, prefix=ADMIN_LOGS_PREFIX):
    action: str 
    item_id: Optional[str] = None 
    page: Optional[int] = None

# –ù–æ–≤—ã–π callback data –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
ADMIN_LOGS_VIEWER_PREFIX = "sdb_admin_logs_viewer"
class AdminLogsViewerNavigate(CallbackData, prefix=ADMIN_LOGS_VIEWER_PREFIX):
    action: str 
    payload: Optional[str] = None  # –î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞

class AdminPanelNavigate(CallbackData, prefix=ADMIN_CALLBACK_PREFIX): 
    section: str 
    action: Optional[str] = None
    item_id: Optional[Union[int, str]] = None 
    page: Optional[int] = None
    role_id: Optional[int] = None 
    permission_name: Optional[str] = None


======================================================================

------------------------------ FILE: Systems/core/ui/navigation_core.py ------------------------------
# core/ui/navigation_core.py

from aiogram import Router, F, types, Bot
from aiogram.exceptions import TelegramBadRequest
from aiogram.utils.markdown import hbold, hitalic
from loguru import logger

from Systems.core.ui.callback_data_factories import CoreMenuNavigate, CoreServiceAction
from Systems.core.ui.keyboards_core import (
    get_main_menu_reply_keyboard, 
    get_modules_list_keyboard,
    # get_close_button_keyboard, # –ï—Å–ª–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —è–≤–Ω–æ
    TEXTS_CORE_KEYBOARDS_EN 
)

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

core_navigation_router = Router(name="sdb_core_navigation_handlers")
MODULE_NAME_FOR_LOG = "CoreNavigation"

@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "main"))
async def cq_nav_to_main_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    logger.debug(f"User {user_id} requested main menu.")
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    from Systems.core.i18n.translator import Translator
    translator = Translator(
        locales_dir=services_provider.config.core.i18n.locales_dir,
        domain=services_provider.config.core.i18n.domain,
        default_locale=services_provider.config.core.i18n.default_locale,
        available_locales=services_provider.config.core.i18n.available_locales
    )
    
    text = translator.gettext("main_menu_title", user_locale)
    keyboard = await get_main_menu_reply_keyboard(services_provider=services_provider, user_telegram_id=user_id, locale=user_locale)
    
    try:
        if query.message:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
        await query.answer()
    except TelegramBadRequest as e:
        if "message is not modified" in str(e).lower():
            logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            await query.answer()
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (user: {user_id}): {e}")
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é.", show_alert=True)
    except Exception as e:
        logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (user: {user_id}): {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –æ—à–∏–±–∫–∞.", show_alert=True)

@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "modules_list"))
async def cq_nav_to_modules_list(
    query: types.CallbackQuery, 
    callback_data: CoreMenuNavigate, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    page = callback_data.page if callback_data.page is not None else 1
    logger.debug(f"User {user_id} requested modules list, page: {page}")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    from Systems.core.i18n.translator import Translator
    translator = Translator(
        locales_dir=services_provider.config.core.i18n.locales_dir,
        domain=services_provider.config.core.i18n.domain,
        default_locale=services_provider.config.core.i18n.default_locale,
        available_locales=services_provider.config.core.i18n.available_locales
    )
    
    module_ui_entries = services_provider.ui_registry.get_all_module_entries()
    items_per_page = 5 
    total_pages = (len(module_ui_entries) + items_per_page - 1) // items_per_page
    total_pages = max(1, total_pages) 

    text = translator.gettext("modules_list_title_template", user_locale, current_page=page, total_pages=total_pages)
    
    keyboard = await get_modules_list_keyboard(
        services_provider=services_provider, 
        user_telegram_id=user_id, 
        current_page=page,
        items_per_page=items_per_page,
        locale=user_locale
    )
    
    try:
        if query.message:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
        await query.answer()
    except TelegramBadRequest as e:
        if "message is not modified" in str(e).lower():
            logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            await query.answer()
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π (user: {user_id}): {e}")
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.", show_alert=True)
    except Exception as e:
        logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π (user: {user_id}): {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –æ—à–∏–±–∫–∞.", show_alert=True)

# –£–¥–∞–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ cq_nav_to_admin_panel, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª
# —Å —Ä–∞–±–æ—á–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –≤ core/admin/handlers_admin_entry.py

@core_navigation_router.callback_query(CoreServiceAction.filter(F.action == "delete_this_message"))
async def cq_service_action_delete_message(query: types.CallbackQuery):
    user_id = query.from_user.id
    message_id = query.message.message_id if query.message else "N/A"
    logger.debug(f"User {user_id} requested to delete message_id: {message_id}")
    
    try:
        if query.message:
            await query.bot.delete_message(chat_id=query.message.chat.id, message_id=query.message.message_id)
            await query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.") 
        else:
            logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç user {user_id}.")
            await query.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except TelegramBadRequest as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –¥–ª—è user {user_id}: {e}")
        await query.answer()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è {message_id} –¥–ª—è user {user_id}: {e}", exc_info=True)
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.", show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/ui/registry_ui.py ------------------------------
# core/ui/registry_ui.py

from typing import List, Dict, Optional, Callable, Any
from pydantic import BaseModel, Field, field_validator, ValidationError
from loguru import logger


class ModuleUIEntry(BaseModel):
    module_name: str = Field(description="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥—É–ª—è (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å manifest.name)")
    display_name: str = Field(description="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é")
    entry_callback_data: str = Field(description="–°—Ç—Ä–æ–∫–∞ callback_data –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ –≤ –º–æ–¥—É–ª—å")
    
    icon: Optional[str] = Field(default=None, description="–≠–º–æ–¥–∑–∏-–∏–∫–æ–Ω–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
    description: Optional[str] = Field(
        default=None, 
        description="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è, –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ UI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å–ø–∏—Å–∫–µ –º–æ–¥—É–ª–µ–π)"
    )
    order: int = Field(
        default=100, 
        description="–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –º–µ–Ω—é (–º–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç/–ø–æ–ª–æ–∂–µ–Ω–∏–µ)"
    )
    # –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏ –≤ –æ–±—â–µ–º –º–µ–Ω—é
    required_permission_to_view: Optional[str] = Field(
        default=None,
        description="–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —ç—Ç–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    )

    @field_validator('module_name', 'display_name', 'entry_callback_data')
    @classmethod 
    def names_must_not_be_empty(cls, v: str) -> str: 
        if not v or not v.strip():
            raise ValueError("–ò–º—è –º–æ–¥—É–ª—è, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏ entry_callback_data –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏")
        return v

    class Config:
        validate_assignment = True 
        extra = 'forbid' 


class UIRegistry:
    def __init__(self):
        self._module_entries: Dict[str, ModuleUIEntry] = {}
        self._logger = logger.bind(service="UIRegistry")
        self._logger.info("UIRegistry –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def register_module_entry(
        self,
        module_name: str,
        display_name: str,
        entry_callback_data: str,
        icon: Optional[str] = None,
        description: Optional[str] = None,
        order: int = 100,
        required_permission_to_view: Optional[str] = None # <--- –ù–æ–≤–æ–µ –ø–æ–ª–µ
    ) -> bool:
        if module_name in self._module_entries:
            self._logger.warning(
                f"–ú–æ–¥—É–ª—å '{module_name}' —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª —Å–≤–æ—é UI-—Ç–æ—á–∫—É –≤—Ö–æ–¥–∞. "
                f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–ø–∏—Å—å."
            )
        
        try:
            entry = ModuleUIEntry(
                module_name=module_name,
                display_name=display_name,
                entry_callback_data=entry_callback_data,
                icon=icon,
                description=description,
                order=order,
                required_permission_to_view=required_permission_to_view # <--- –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
            )
            self._module_entries[module_name] = entry
            self._logger.info(f"UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' ('{display_name}') —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞. "
                              f"–¢—Ä–µ–±—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: '{required_permission_to_view or '–Ω–µ—Ç'}'.")
            return True
        except ValidationError as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}")
            return False
        except Exception as e:
            self._logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}", exc_info=True)
            return False

    def unregister_module_entry(self, module_name: str) -> bool:
        if module_name in self._module_entries:
            del self._module_entries[module_name]
            self._logger.info(f"UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (—É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞).")
            return True
        else:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è '{module_name}'.")
            return False

    def get_all_module_entries(self) -> List[ModuleUIEntry]: # –£–±—Ä–∞–ª for_admin_status, –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å required_permission_to_view
        entries = list(self._module_entries.values())
        entries.sort(key=lambda x: (x.order, x.display_name.lower()))
        self._logger.trace(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –í–°–ï–• UI-—Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ: {len(entries)}")
        return entries

    def get_module_entry(self, module_name: str) -> Optional[ModuleUIEntry]:
        return self._module_entries.get(module_name)

    async def dispose(self) -> None: 
        self._module_entries.clear()
        self._logger.info("UIRegistry –æ—á–∏—â–µ–Ω (–≤—Å–µ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª–µ–π —É–¥–∞–ª–µ–Ω—ã).")


======================================================================

------------------------------ FILE: Systems/core/ui/keyboards_core.py ------------------------------
# SwiftDevBot/core/ui/keyboards_core.py

from typing import List, Dict, Optional, TYPE_CHECKING, Callable
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton 
from aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder # –î–æ–±–∞–≤–ª—è–µ–º ReplyKeyboardBuilder
from loguru import logger 

from .callback_data_factories import CoreMenuNavigate, ModuleMenuEntry, CoreServiceAction
from Systems.core.rbac.service import PERMISSION_CORE_VIEW_ADMIN_PANEL 
from Systems.core.database.core_models import User as DBUser

if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.ui.registry_ui import ModuleUIEntry
    from sqlalchemy.ext.asyncio import AsyncSession

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è translator (—Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
_translator_cache: Optional['Translator'] = None

def _get_translator(services_provider: 'BotServicesProvider') -> 'Translator':
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç translator –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞—Ö"""
    global _translator_cache
    if _translator_cache is None:
        from Systems.core.i18n.translator import Translator
        _translator_cache = Translator(
            locales_dir=services_provider.config.core.i18n.locales_dir,
            domain=services_provider.config.core.i18n.domain,
            default_locale=services_provider.config.core.i18n.default_locale,
            available_locales=services_provider.config.core.i18n.available_locales
        )
    return _translator_cache 

# –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
TEXTS_CORE_KEYBOARDS_EN = {
    # –î–ª—è Reply Keyboard (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é) - –±–æ–ª–µ–µ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
    "main_menu_reply_modules": "üóÇ –ú–æ–¥—É–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏", # –ë–æ–ª–µ–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    "main_menu_reply_profile": "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
    "main_menu_reply_feedback": "‚úçÔ∏è –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏", # –ë–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    "main_menu_reply_admin_panel": "üõ† –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ",

    # –î–ª—è Inline Keyboard (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ–Ω—é)
    "main_menu_inline_modules": "üóÇ Modules", # –û—Å—Ç–∞–≤–∏–º —Å—Ç–∞—Ä—ã–µ –¥–ª—è –∏–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è
    "main_menu_inline_profile": "üë§ Profile",
    "main_menu_inline_feedback": "‚úçÔ∏è Feedback",
    "main_menu_inline_admin_panel": "üõ† Admin Panel",

    "modules_list_no_modules": "ü§∑ No modules available",
    "modules_list_title_template": "Available Modules (Page {current_page}/{total_pages}):",
    "pagination_prev": "‚¨ÖÔ∏è Prev",
    "pagination_next": "Next ‚û°Ô∏è",
    "navigation_back_to_main": "üè† Main Menu", # –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏ –¥–ª—è –∏–Ω–ª–∞–π–Ω, –∏ –¥–ª—è reply (–∫–∞–∫ /start)
    "service_delete_message": "‚ùå Close this menu",
    "confirm_yes": "‚úÖ Yes",
    "confirm_no": "‚ùå No",
    "welcome_message_title": "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SwiftDevBot!",
    "welcome_message_body": (
        "–Ø ‚Äî –≤–∞—à –º–æ–¥—É–ª—å–Ω—ã–π Telegram-–ø–æ–º–æ—â–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á.\n\n"
        "üîç **–ß—Ç–æ —è –º–æ–≥—É?**\n"
        "–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. –≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —É—Ç–∏–ª–∏—Ç—ã, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n\n"
        "üîí **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:**\n"
        "–Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –º–æ–µ–π —Ä–∞–±–æ—Ç—ã –∏ —Ä–∞–±–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. "
        "–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–æ—Ç–∞.\n\n"
        "–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º, —á—Ç–æ –±–æ—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π."
    ),
    "welcome_button_continue": "‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
    "welcome_button_cancel": "‚ùå –û—Ç–º–µ–Ω–∞",
    "registration_cancelled_message": "–û—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏. –ï—Å–ª–∏ –Ω–∞–¥—É–º–∞–µ—Ç–µ —Å–Ω–æ–≤–∞, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /start.",
    "user_middleware_please_register": (
        "üëã –ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –∑–Ω–∞–∫–æ–º—ã —Å–æ –º–Ω–æ–π! "
        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ /start –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start."
    ),
    "profile_title": "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å",
    "profile_info_template": (
        "üÜî –í–∞—à Telegram ID: {user_id}\n"
        "üìù –ò–º—è: {full_name}\n"
        "üë§ Username: @{username}\n"
        "üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {registration_date}\n"
        "üó£ –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {current_language}"
    ),
    "profile_no_username": "–Ω–µ —É–∫–∞–∑–∞–Ω",
    "profile_no_reg_date": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
    "profile_button_change_language": "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫", # –≠—Ç–æ –±—É–¥–µ—Ç –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
    "profile_select_language_title": "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:",
}

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø REPLY KEYBOARD –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ ---
async def get_main_menu_reply_keyboard( 
    services_provider: 'BotServicesProvider', 
    user_telegram_id: int,
    locale: Optional[str] = None
) -> ReplyKeyboardMarkup:
    builder = ReplyKeyboardBuilder() # –ò—Å–ø–æ–ª—å–∑—É–µ–º ReplyKeyboardBuilder
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not locale:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –∏–∑ –ë–î
        try:
            async with services_provider.db.get_session() as session:
                from Systems.core.database.core_models import User as DBUser
                from sqlalchemy import select
                result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_telegram_id))
                db_user = result.scalar_one_or_none()
                if db_user and db_user.preferred_language_code:
                    locale = db_user.preferred_language_code
        except Exception:
            pass
        
        # –ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        if not locale:
            locale = services_provider.config.core.i18n.default_locale
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã —á–µ—Ä–µ–∑ translator
    translator = _get_translator(services_provider)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –≤–º–µ—Å—Ç–æ TEXTS_CORE_KEYBOARDS_EN
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    texts = {
        "main_menu_reply_modules": t("main_menu_reply_modules"),
        "main_menu_reply_profile": t("main_menu_reply_profile"),
        "main_menu_reply_feedback": t("main_menu_reply_feedback"),
        "main_menu_reply_admin_panel": t("main_menu_reply_admin_panel"),
    } 
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - –ø–µ—Ä–≤—ã–π —Ä—è–¥
    builder.button(text=texts["main_menu_reply_modules"])
    builder.button(text=texts["main_menu_reply_profile"])
    
    show_admin_button = False
    is_super_admin = user_telegram_id in services_provider.config.core.super_admins
    
    if is_super_admin:
        show_admin_button = True
    else:
        try:
            async with services_provider.db.get_session() as session: 
                if await services_provider.rbac.user_has_permission(session, user_telegram_id, PERMISSION_CORE_VIEW_ADMIN_PANEL):
                    show_admin_button = True
        except Exception as e: 
            logger.error(f"[MainMenuReplyKeyboard] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' –¥–ª—è {user_telegram_id}: {e}")
    
    # –õ–æ–≥–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏:
    # –†—è–¥ 1: –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ú–æ–¥—É–ª–∏, –ü—Ä–æ—Ñ–∏–ª—å) 
    # –†—è–¥ 2: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å) –∏–ª–∏ —Å–ª—É–∂–µ–±–Ω—ã–µ (–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å)
    if show_admin_button:
        # –î–ª—è –∞–¥–º–∏–Ω–æ–≤: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä—è–¥—É –∫–∞–∫ –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        builder.button(text=texts["main_menu_reply_admin_panel"])
        
        # –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤ –º–µ–Ω–µ–µ –≤–∞–∂–Ω–∞ (–æ–Ω–∏ —Å–∞–º–∏ –ø–æ–ª—É—á–∞—é—Ç –æ—Ç–∑—ã–≤—ã)
        # –ù–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π
        if not is_super_admin:
            builder.button(text=texts["main_menu_reply_feedback"])
            # –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤: [–ú–æ–¥—É–ª–∏][–ü—Ä–æ—Ñ–∏–ª—å] / [–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å][–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å]
            builder.adjust(2, 2)
        else:
            # –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤: [–ú–æ–¥—É–ª–∏][–ü—Ä–æ—Ñ–∏–ª—å] / [–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å]
            builder.adjust(2, 1)
    else:
        # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä—è–¥—É
        builder.button(text=texts["main_menu_reply_feedback"])
        # –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: [–ú–æ–¥—É–ª–∏][–ü—Ä–æ—Ñ–∏–ª—å] / [–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å]
        builder.adjust(2, 1)
    
    return builder.as_markup(
        resize_keyboard=True, 
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é..." # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    )# –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ –∏–ª–∏ –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å)
async def get_main_menu_inline_keyboard( # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    services_provider: 'BotServicesProvider', 
    user_telegram_id: int
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN 
    
    builder.button(
        text=texts["main_menu_inline_modules"], # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∏–Ω–ª–∞–π–Ω
        callback_data=CoreMenuNavigate(target_menu="modules_list", page=1).pack()
    )
    builder.button(
        text=texts["main_menu_inline_profile"],
        callback_data=CoreMenuNavigate(target_menu="profile").pack()
    )
    # ... (–ª–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∫–∏ –∫–∞–∫ –±—ã–ª–∞) ...
    show_admin_button = False
    if user_telegram_id in services_provider.config.core.super_admins:
        show_admin_button = True
    else:
        try:
            async with services_provider.db.get_session() as session: 
                if await services_provider.rbac.user_has_permission(session, user_telegram_id, PERMISSION_CORE_VIEW_ADMIN_PANEL):
                    show_admin_button = True
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_telegram_id}: {e}")
            
    if show_admin_button:
        builder.button(
            text=texts["main_menu_inline_admin_panel"],
            callback_data=CoreMenuNavigate(target_menu="admin_panel_main").pack()
        )
    builder.button(
        text=texts["main_menu_inline_feedback"],
        callback_data=CoreMenuNavigate(target_menu="feedback").pack()
    )
    builder.adjust(2) 
    return builder.as_markup()


async def get_modules_list_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    services_provider: 'BotServicesProvider',
    user_telegram_id: int, 
    current_page: int = 1,
    items_per_page: int = 5,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not locale:
        try:
            async with services_provider.db.get_session() as session:
                from sqlalchemy import select
                result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_telegram_id))
                db_user = result.scalar_one_or_none()
                if db_user and db_user.preferred_language_code:
                    locale = db_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services_provider.config.core.i18n.default_locale
    
    translator = _get_translator(services_provider)
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    texts = {
        "modules_list_no_modules": t("modules_list_no_modules"),
        "pagination_prev": t("pagination_prev"),
        "pagination_next": t("pagination_next"),
        "navigation_back_to_main": t("navigation_back_to_main"),
    }
    
    all_module_ui_entries: List['ModuleUIEntry'] = services_provider.ui_registry.get_all_module_entries()
    
    accessible_module_entries: List['ModuleUIEntry'] = []
    if all_module_ui_entries:
        async with services_provider.db.get_session() as session: 
            for entry in all_module_ui_entries:
                if entry.required_permission_to_view:
                    if await services_provider.rbac.user_has_permission(session, user_telegram_id, entry.required_permission_to_view):
                        accessible_module_entries.append(entry)
                else:
                    accessible_module_entries.append(entry)

    if not accessible_module_entries:
        builder.button(
            text=texts["modules_list_no_modules"],
            callback_data="core:dummy_no_modules"
        )
    else:
        # ... (–ª–æ–≥–∏–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ –∫–Ω–æ–ø–æ–∫ –º–æ–¥—É–ª–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        total_items = len(accessible_module_entries)
        total_pages = (total_items + items_per_page - 1) // items_per_page
        current_page = max(1, min(current_page, total_pages if total_pages > 0 else 1))

        start_index = (current_page - 1) * items_per_page
        end_index = start_index + items_per_page
        paginated_entries = accessible_module_entries[start_index:end_index]

        for entry in paginated_entries:
            button_text = f"{entry.icon} {entry.display_name}" if entry.icon else entry.display_name
            builder.button(
                text=button_text,
                callback_data=entry.entry_callback_data
            )
        builder.adjust(1)

        if total_pages > 1:
            pagination_buttons_row: List[InlineKeyboardButton] = []
            if current_page > 1:
                pagination_buttons_row.append(InlineKeyboardButton(text=texts["pagination_prev"], callback_data=CoreMenuNavigate(target_menu="modules_list", page=current_page - 1).pack()))
            pagination_buttons_row.append(InlineKeyboardButton(text=f"{current_page}/{total_pages}", callback_data="core:dummy_page_indicator"))
            if current_page < total_pages:
                pagination_buttons_row.append(InlineKeyboardButton(text=texts["pagination_next"], callback_data=CoreMenuNavigate(target_menu="modules_list", page=current_page + 1).pack()))
            if pagination_buttons_row:
                 builder.row(*pagination_buttons_row)
    builder.row(
        InlineKeyboardButton(
            text=texts["navigation_back_to_main"], 
            callback_data=CoreMenuNavigate(target_menu="main_reply").pack() # <--- –ò–ó–ú–ï–ù–ï–ù–û: –≤–æ–∑–≤—Ä–∞—Ç –∫ reply-–º–µ–Ω—é
        )
    )
    return builder.as_markup()


def get_welcome_confirmation_keyboard(locale: Optional[str] = None, services_provider: Optional['BotServicesProvider'] = None) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏"""
    builder = InlineKeyboardBuilder()
    
    # –ï—Å–ª–∏ services_provider –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        if not locale:
            locale = services_provider.config.core.i18n.default_locale
        translator = _get_translator(services_provider)
        def t(key: str, **kwargs) -> str:
            return translator.gettext(key, locale, **kwargs)
        texts = {
            "welcome_button_continue": t("welcome_button_continue"),
            "welcome_button_cancel": t("welcome_button_cancel"),
        }
    else:
        # Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–µ —Ç–µ–∫—Å—Ç—ã, –µ—Å–ª–∏ services_provider –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
        texts = TEXTS_CORE_KEYBOARDS_EN
    
    builder.button(
        text=texts["welcome_button_continue"],
        callback_data=CoreServiceAction(action="confirm_registration").pack()
    )
    builder.button(
        text=texts["welcome_button_cancel"],
        callback_data=CoreServiceAction(action="cancel_registration").pack()
    )
    builder.adjust(2)
    return builder.as_markup()

async def get_profile_menu_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    db_user: DBUser, 
    services_provider: 'BotServicesProvider',
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not locale:
        locale = db_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    
    translator = _get_translator(services_provider)
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    texts = {
        "profile_button_change_language": t("profile_button_change_language"),
        "navigation_back_to_main": t("navigation_back_to_main"),
    }
    
    available_langs = services_provider.config.core.i18n.available_locales
    if len(available_langs) > 1:
        builder.button(
            text=texts["profile_button_change_language"],
            callback_data=CoreMenuNavigate(target_menu="profile_change_lang_list").pack()
        )
    if not builder.export():
        builder.button(text="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ", callback_data="core_profile:dummy_no_actions")
    builder.row(
        InlineKeyboardButton(
            text=texts["navigation_back_to_main"],
            callback_data=CoreMenuNavigate(target_menu="main_reply").pack() # <--- –ò–ó–ú–ï–ù–ï–ù–û: –≤–æ–∑–≤—Ä–∞—Ç –∫ reply-–º–µ–Ω—é
        )
    )
    builder.adjust(1)
    return builder.as_markup()

async def get_language_selection_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    current_lang_code: Optional[str],
    available_locales: List[str],
    services_provider: Optional['BotServicesProvider'] = None,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π —è–∑—ã–∫–æ–≤
    if services_provider:
        if not locale:
            locale = current_lang_code or services_provider.config.core.i18n.default_locale
        translator = _get_translator(services_provider)
        
        for lang_code in available_locales:
            prefix = "‚úÖ " if lang_code == current_lang_code else "‚ñ´Ô∏è "
            lang_key = f"language_{lang_code}"
            display_name = translator.gettext(lang_key, locale) if lang_key in translator._translations.get(locale, {}) else lang_code.upper()
            builder.button(
                text=f"{prefix}{display_name}",
                callback_data=CoreMenuNavigate(target_menu="profile_set_lang", payload=lang_code).pack()
            )
    else:
        # Fallback –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        for lang_code in available_locales:
            prefix = "‚úÖ " if lang_code == current_lang_code else "‚ñ´Ô∏è "
            display_name = lang_code.upper() 
            builder.button(
                text=f"{prefix}{display_name}",
                callback_data=CoreMenuNavigate(target_menu="profile_set_lang", payload=lang_code).pack()
            )
    builder.adjust(1) 
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å", 
            callback_data=CoreMenuNavigate(target_menu="profile").pack()
        )
    )
    return builder.as_markup()

# ... (get_confirm_action_keyboard, get_close_button_keyboard –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç.–∫. –æ–Ω–∏ –∏–Ω–ª–∞–π–Ω)
def get_confirm_action_keyboard(
    confirm_callback_data: str,
    cancel_callback_data: str,
    confirm_text_key: str = "confirm_yes",
    cancel_text_key: str = "confirm_no"
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    
    builder.button(text=texts[confirm_text_key], callback_data=confirm_callback_data)
    builder.button(text=texts[cancel_text_key], callback_data=cancel_callback_data)
    builder.adjust(2)
    return builder.as_markup()

def get_close_button_keyboard(
    close_text_key: str = "service_delete_message"
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    builder.button(
        text=texts[close_text_key],
        callback_data=CoreServiceAction(action="delete_this_message").pack()
    )
    return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/ui/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/ui/handlers_core_ui.py ------------------------------
# SwiftDevBot/core/ui/handlers_core_ui.py
from aiogram import Router, F, types, Bot
from aiogram.filters import CommandStart, Command, StateFilter 
from aiogram.fsm.context import FSMContext 
from aiogram.fsm.state import State, StatesGroup 
from aiogram.utils.markdown import hbold, hitalic, hcode 
import html # <--- –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –°–¢–ê–ù–î–ê–†–¢–ù–´–ô –ú–û–î–£–õ–¨ html
from loguru import logger
from aiogram.exceptions import TelegramBadRequest 
from aiogram.types import ReplyKeyboardRemove 

from .callback_data_factories import CoreMenuNavigate, ModuleMenuEntry, CoreServiceAction 
from .keyboards_core import (
    get_main_menu_reply_keyboard,
    get_modules_list_keyboard, 
    get_welcome_confirmation_keyboard, 
    get_profile_menu_keyboard,         
    get_language_selection_keyboard, 
    TEXTS_CORE_KEYBOARDS_EN 
)
from Systems.core.database.core_models import User as DBUser 
from Systems.core.ui.registry_ui import ModuleUIEntry 
from sqlalchemy import select 
from Systems.core.i18n.translator import Translator 

from typing import TYPE_CHECKING, Optional, List, Union
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

core_ui_router = Router(name="sdb_core_ui_handlers")
MODULE_NAME_FOR_LOG = "CoreUI"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è translator
_translator_cache: Optional['Translator'] = None

def _get_translator_for_handler(services_provider: 'BotServicesProvider') -> 'Translator':
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç translator –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handlers"""
    global _translator_cache
    if _translator_cache is None:
        from Systems.core.i18n.translator import Translator
        _translator_cache = Translator(
            locales_dir=services_provider.config.core.i18n.locales_dir,
            domain=services_provider.config.core.i18n.domain,
            default_locale=services_provider.config.core.i18n.default_locale,
            available_locales=services_provider.config.core.i18n.available_locales
        )
    return _translator_cache

class FSMFeedback(StatesGroup):
    waiting_for_feedback_message = State()

async def show_main_menu_reply(
    message_or_query: Union[types.Message, types.CallbackQuery], 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    text_override: Optional[str] = None,
    state: Optional[FSMContext] = None 
):
    if state: 
        current_fsm_state = await state.get_state()
        if current_fsm_state is not None:
            logger.info(f"[{MODULE_NAME_FOR_LOG}] –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM ({current_fsm_state}) –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {sdb_user.telegram_id}.")
            await state.clear()

    user_id = sdb_user.telegram_id
    
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —è–∑—ã–∫–∞
    async with services_provider.db.get_session() as session:
        updated_user = await session.get(DBUser, sdb_user.id)
        if updated_user:
            sdb_user.preferred_language_code = updated_user.preferred_language_code
            user_display_name = updated_user.full_name
        else:
            user_display_name = sdb_user.full_name
    
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} ({user_display_name}) showing main reply menu.")
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    if text_override:
        text_to_send = text_override
    else:
        default_text = f"üè† {hbold(t('main_menu_title'))}\n{t('main_menu_greeting', user_name=user_display_name)}"
        text_to_send = default_text
    
    keyboard = await get_main_menu_reply_keyboard(services_provider=services_provider, user_telegram_id=user_id, locale=user_locale)
    
    target_chat_id = message_or_query.chat.id if isinstance(message_or_query, types.Message) else message_or_query.message.chat.id # type: ignore

    if isinstance(message_or_query, types.CallbackQuery) and message_or_query.message:
        try:
            if message_or_query.message.reply_markup: 
                 await message_or_query.message.edit_reply_markup(reply_markup=None)
        except Exception as e_del_edit:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º reply menu: {e_del_edit}")
    
    await bot.send_message(target_chat_id, text_to_send, reply_markup=keyboard)
    
    if isinstance(message_or_query, types.CallbackQuery):
        await message_or_query.answer()


@core_ui_router.message(CommandStart())
async def handle_start_command(
    message: types.Message,
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser, 
    state: FSMContext, 
    user_was_just_created: Optional[bool] = False 
):
    user_tg = message.from_user 
    if not user_tg: return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_tg.id} (@{user_tg.username or 'N/A'}) –≤—ã–∑–≤–∞–ª /start. "
                f"SDB_User DB ID: {sdb_user.id}. –ë—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω (–≤ middleware): {user_was_just_created}.")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    is_owner_from_config = sdb_user.telegram_id in services_provider.config.core.super_admins
    user_display_name = sdb_user.full_name 

    if is_owner_from_config or not user_was_just_created: 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} ({'–í–ª–∞–¥–µ–ª–µ—Ü' if is_owner_from_config else '—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π'}). –ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é.")
        await show_main_menu_reply(message, bot, services_provider, sdb_user, state=state) 
    else: 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–æ–≤—ã–π. –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.")
        welcome_title = t("welcome_message_title")
        welcome_body = t("welcome_message_body")
        full_welcome_text = f"{hbold(welcome_title)}\n\n{welcome_body}"
        welcome_keyboard = get_welcome_confirmation_keyboard(locale=user_locale, services_provider=services_provider)
        await message.answer(full_welcome_text, reply_markup=welcome_keyboard)


@core_ui_router.message(Command("help"))
async def handle_help_command(
    message: types.Message,
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."""
    user_tg = message.from_user
    if not user_tg:
        return
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_tg.id} (@{user_tg.username or 'N/A'}) –≤—ã–∑–≤–∞–ª /help.")
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    try:
        from Systems.core.bot_entrypoint import CORE_COMMANDS_DESCRIPTIONS
        
        # –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
        help_text_parts = [
            f"{hbold(t('help_title'))}\n",
            f"{hbold(t('help_main_commands'))}\n"
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
        for cmd_name, cmd_desc in CORE_COMMANDS_DESCRIPTIONS.items():
            if cmd_name != "help":  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É help –≤ —Å–ø–∏—Å–∫–µ
                help_text_parts.append(f"/{cmd_name} - {cmd_desc}")
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–æ–¥—É–ª–µ–π
        module_commands = []
        all_loaded_modules_info = services_provider.modules.get_loaded_modules_info(include_system=False, include_plugins=True)
        
        async with services_provider.db.get_session() as session:
            for module_info in all_loaded_modules_info:
                if module_info.manifest and module_info.manifest.commands:
                    for cmd_manifest in module_info.manifest.commands:
                        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∞–≤
                        if cmd_manifest.admin_only:
                            is_super_admin = sdb_user.telegram_id in services_provider.config.core.super_admins
                            if not is_super_admin:
                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ RBAC
                                has_admin_permission = await services_provider.rbac.user_has_permission(
                                    session, 
                                    sdb_user.telegram_id, 
                                    "core.view_admin_panel"
                                )
                                if not has_admin_permission:
                                    continue
                        
                        cmd_name = cmd_manifest.command.lstrip("/")
                        cmd_desc = cmd_manifest.description or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
                        
                        # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                        if not any(cmd["name"] == cmd_name for cmd in module_commands):
                            module_commands.append({
                                "name": cmd_name,
                                "description": cmd_desc,
                                "module": module_info.name
                            })
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –º–æ–¥—É–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if module_commands:
            help_text_parts.append(f"\n{hbold(t('help_module_commands'))}\n")
            for cmd in module_commands:
                help_text_parts.append(f"/{cmd['name']} - {cmd['description']}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
        help_text_parts.append(f"\n{hitalic(t('help_tip_menu'))}")
        help_text_parts.append(f"{hitalic(t('help_tip_start'))}")
        
        help_text = "\n".join(help_text_parts)
        
        await message.answer(help_text)
        logger.debug(f"[{MODULE_NAME_FOR_LOG}] –ö–æ–º–∞–Ω–¥–∞ /help —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_tg.id}.")
        
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã /help –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_tg.id}: {e}", exc_info=True)
        await message.answer(
            f"{hbold('‚ùå –û—à–∏–±–∫–∞')}\n\n"
            f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )


@core_ui_router.message(Command("login"))
async def handle_login_command(
    message: types.Message,
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /login - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å."""
    user_tg = message.from_user
    if not user_tg:
        return
    
    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º JWT handler
        from Systems.web.auth.jwt_handler import get_jwt_handler
        from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
        from datetime import timedelta
        import os
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º –∏–∑ .env
        is_super_admin = sdb_user.telegram_id in services_provider.config.core.super_admins
        
        primary_role = None
        if is_super_admin:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–º–∏–Ω
            primary_role = "admin"
            logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.")
        elif sdb_user.roles:
            # –ï—Å–ª–∏ –Ω–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –∏–∑ –ë–î
            role_names = [role.name for role in sdb_user.roles]
            if "Admin" in role_names:
                primary_role = "admin"  # lowercase –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
            elif "Moderator" in role_names:
                primary_role = "moderator"
            elif role_names:
                primary_role = role_names[0].lower()
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 –º–∏–Ω—É—Ç)
        token_lifetime_minutes = int(os.environ.get("SDB_WEB_TOKEN_LIFETIME_MINUTES", "60"))
        
        # –°–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω
        jwt_handler = get_jwt_handler()
        login_token = await jwt_handler.create_access_token(
            user_id=sdb_user.telegram_id,
            username=sdb_user.username or sdb_user.full_name,
            role=primary_role or "user",  # lowercase –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            expires_in=timedelta(minutes=token_lifetime_minutes)
        )
        
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –°–æ–∑–¥–∞–Ω JWT —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {sdb_user.telegram_id} —Å —Ä–æ–ª—å—é: {primary_role or 'user'}")
        
        # –ü–æ–ª—É—á–∞–µ–º URL –≤–µ–±-–ø–∞–Ω–µ–ª–∏
        # Telegram –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç localhost –≤ –∫–Ω–æ–ø–∫–∞—Ö, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω/IP
        web_url = os.environ.get("SDB_WEB_URL")  # –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —è–≤–Ω–æ –≤ .env
        
        if not web_url:
            # –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω —è–≤–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            web_host = os.environ.get("SDB_WEB_HOST", "0.0.0.0")
            web_port = os.environ.get("SDB_WEB_PORT", "80")
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π IP —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ localhost)
            import socket
            try:
                # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP
                hostname = socket.gethostname()
                local_ip = socket.gethostbyname(hostname)
                
                # –ï—Å–ª–∏ —ç—Ç–æ localhost, –∏—Å–ø–æ–ª—å–∑—É–µ–º IP –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
                if local_ip in ["127.0.0.1", "127.0.1.1"] or web_host in ["0.0.0.0", "127.0.0.1"]:
                    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å IP –∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    import subprocess
                    try:
                        result = subprocess.run(['hostname', '-I'], capture_output=True, text=True, timeout=2)
                        if result.returncode == 0 and result.stdout.strip():
                            ips = result.stdout.strip().split()
                            if ips:
                                local_ip = ips[0]
                    except:
                        pass
                    
                    # –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ localhost, –∏—Å–ø–æ–ª—å–∑—É–µ–º IP –∏–∑ .env –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω —Ç–µ–∫—Å—Ç–æ–º
                    if local_ip in ["127.0.0.1", "127.0.1.1"]:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω —Ç–µ–∫—Å—Ç–æ–º –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏
                        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞
                        if token_lifetime_minutes >= 60:
                            time_str = f"{token_lifetime_minutes // 60} —á–∞—Å" + ("–∞" if token_lifetime_minutes // 60 > 1 else "")
                        else:
                            time_str = f"{token_lifetime_minutes} –º–∏–Ω—É—Ç"
                        
                        login_text = (
                            f"{hbold('üåê –í—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å')}\n\n"
                            f"–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n\n"
                            f"{hcode(f'http://localhost:{web_port}/?token={login_token}')}\n\n"
                            f"{hitalic(f'–°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ {time_str}.')}"
                        )
                        await message.answer(login_text)
                        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –∑–∞–ø—Ä–æ—Å–∏–ª –≤—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å. –¢–æ–∫–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç–æ–º (localhost).")
                        return
                    
                web_url = f"http://{local_ip}:{web_port}" if web_port != "80" else f"http://{local_ip}"
            except Exception as e:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP –¥–ª—è URL: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç.")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω —Ç–µ–∫—Å—Ç–æ–º
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞
                if token_lifetime_minutes >= 60:
                    time_str = f"{token_lifetime_minutes // 60} —á–∞—Å" + ("–∞" if token_lifetime_minutes // 60 > 1 else "")
                else:
                    time_str = f"{token_lifetime_minutes} –º–∏–Ω—É—Ç"
                
                login_text = (
                    f"{hbold('üåê –í—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å')}\n\n"
                    f"–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n\n"
                    f"{hcode(f'http://localhost:{web_port}/login?token={login_token}')}\n\n"
                    f"{hitalic(f'–°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ {time_str}.')}"
                )
                await message.answer(login_text)
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –∑–∞–ø—Ä–æ—Å–∏–ª –≤—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å. –¢–æ–∫–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç–æ–º (–æ—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è IP).")
                return
        
        # Use root path for better compatibility
        login_url = f"{web_url}/?token={login_token}"
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å —Å—Å—ã–ª–∫–æ–π
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üåê –û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–ø–∞–Ω–µ–ª—å", url=login_url)]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞
        if token_lifetime_minutes >= 60:
            time_str = f"{token_lifetime_minutes // 60} —á–∞—Å" + ("–∞" if token_lifetime_minutes // 60 > 1 else "")
        else:
            time_str = f"{token_lifetime_minutes} –º–∏–Ω—É—Ç"
        
        login_text = (
            f"{hbold('üåê –í—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å')}\n\n"
            f"–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å.\n"
            f"{hitalic(f'–°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ {time_str}.')}"
        )
        
        await message.answer(login_text, reply_markup=keyboard)
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –∑–∞–ø—Ä–æ—Å–∏–ª –≤—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å. –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω.")
        
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {sdb_user.telegram_id}: {e}", exc_info=True)
        await message.answer(
            f"{hbold('‚ùå –û—à–∏–±–∫–∞')}\n\n"
            f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


@core_ui_router.message(Command("reset_password"))
async def handle_reset_password_command(
    message: types.Message,
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /reset_password - —Å–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è."""
    user_tg = message.from_user
    if not user_tg:
        return
    
    try:
        from pathlib import Path
        from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å
        config_dir = Path(__file__).parent.parent.parent.parent / "config"
        cloud_password_file = config_dir / f"cloud_password_{sdb_user.telegram_id}.txt"
        
        if not cloud_password_file.exists():
            await message.answer(
                f"{hbold('‚ÑπÔ∏è –û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')}\\n\\n"
                f"–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è. –í–æ–π–¥–∏—Ç–µ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ /login, "
                f"–∏ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∞–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å."
            )
            logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è —Å–±—Ä–æ—Å–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä–æ–ª—å.")
            return
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚úÖ –î–∞, —Å–±—Ä–æ—Å–∏—Ç—å",
                    callback_data=CoreServiceAction(action="confirm_reset_password").pack()
                ),
                InlineKeyboardButton(
                    text="‚ùå –û—Ç–º–µ–Ω–∞",
                    callback_data=CoreServiceAction(action="cancel_reset_password").pack()
                )
            ]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
        reset_text = (
            f"{hbold('üîê –°–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è')}\\n\\n"
            f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å?\\n\\n"
            f"{hitalic('–ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å.')}"
        )
        
        await message.answer(reset_text, reply_markup=keyboard)
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è.")
        
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã /reset_password –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {sdb_user.telegram_id}: {e}", exc_info=True)
        await message.answer(
            f"{hbold('‚ùå –û—à–∏–±–∫–∞')}\\n\\n"
            f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "confirm_reset_password"))
async def cq_confirm_reset_password(
    query: types.CallbackQuery,
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è."""
    user_id = sdb_user.telegram_id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è.")
    
    try:
        from pathlib import Path
        import os
        
        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å –ø–∞—Ä–æ–ª–µ–º
        config_dir = Path(__file__).parent.parent.parent.parent / "config"
        cloud_password_file = config_dir / f"cloud_password_{user_id}.txt"
        
        if cloud_password_file.exists():
            os.remove(cloud_password_file)
            logger.success(f"[{MODULE_NAME_FOR_LOG}] –û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.")
            
            success_text = (
                f"{hbold('‚úÖ –ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω')}\\n\\n"
                f"–û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.\\n\\n"
                f"–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ /login "
                f"–≤–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å."
            )
            
            if query.message:
                try:
                    await query.message.edit_text(success_text)
                except Exception:
                    await bot.send_message(user_id, success_text)
            else:
                await bot.send_message(user_id, success_text)
                
            await query.answer("–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω", show_alert=False)
        else:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –§–∞–π–ª –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–µ–Ω–∏—è.")
            await query.answer("–ü–∞—Ä–æ–ª—å —É–∂–µ –±—ã–ª —É–¥–∞–ª—ë–Ω", show_alert=True)
            
            if query.message:
                try:
                    await query.message.delete()
                except Exception:
                    pass
                    
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}", exc_info=True)
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è", show_alert=True)


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "cancel_reset_password"))
async def cq_cancel_reset_password(
    query: types.CallbackQuery,
    bot: Bot,
):
    """–û—Ç–º–µ–Ω–∞ —Å–±—Ä–æ—Å–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è."""
    user_id = query.from_user.id if query.from_user else 0
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–º–µ–Ω–∏–ª —Å–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è.")
    
    cancel_text = (
        f"{hbold('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ')}\\n\\n"
        f"–°–±—Ä–æ—Å –æ–±–ª–∞—á–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –æ—Ç–º–µ–Ω—ë–Ω. –í–∞—à —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
    )
    
    if query.message:
        try:
            await query.message.edit_text(cancel_text)
        except Exception:
            await bot.send_message(user_id, cancel_text)
    else:
        await bot.send_message(user_id, cancel_text)
        
    await query.answer()



@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "confirm_registration"))
async def cq_confirm_registration_and_show_main_menu(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext 
):
    user_id = sdb_user.telegram_id 
    user_full_name = sdb_user.full_name
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({user_full_name}) –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –ø–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é.")
    
    if query.message:
        try:
            await query.message.delete()
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º: {e}")
            
    await show_main_menu_reply(query, bot, services_provider, sdb_user, 
                               text_override=f"–û—Ç–ª–∏—á–Ω–æ, {hbold(user_full_name)}! –í–æ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
                               state=state) 


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "cancel_registration"))
async def cq_cancel_registration(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext 
):
    user_id = query.from_user.id 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–º–µ–Ω–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.")
    await state.clear() 
    
    texts = TEXTS_CORE_KEYBOARDS_EN
    cancel_text = texts.get("registration_cancelled_message", "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

    if query.message:
        try:
            await query.message.delete()
        except Exception as e_delete:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (user: {user_id}): {e_delete}")
    
    await bot.send_message(user_id, cancel_text, reply_markup=ReplyKeyboardRemove())
    await query.answer()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è reply-–∫–Ω–æ–ø–æ–∫
# –ò—Å–ø–æ–ª—å–∑—É–µ–º F.text —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤
@core_ui_router.message(F.text.in_([
    "üóÇ –ú–æ–¥—É–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏",  # ru
    "üóÇ Modules and Features",  # en
    "üóÇ –ú–æ–¥—É–ª—ñ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó",  # ua
]))
async def handle_text_modules_list(message: types.Message, services_provider: 'BotServicesProvider', sdb_user: DBUser):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ú–æ–¥—É–ª–∏'")
    await send_modules_list_message(message.chat.id, message.bot, services_provider, sdb_user, page=1)

@core_ui_router.message(F.text.in_([
    "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å",  # ru
    "üë§ My Profile",  # en
    "üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å",  # ua
]))
async def handle_text_profile(message: types.Message, services_provider: 'BotServicesProvider', sdb_user: DBUser):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ü—Ä–æ—Ñ–∏–ª—å'")
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —è–∑—ã–∫–∞
    async with services_provider.db.get_session() as session:
        updated_user = await session.get(DBUser, sdb_user.id)
        if updated_user:
            sdb_user.preferred_language_code = updated_user.preferred_language_code
    await send_profile_message(message.chat.id, message.bot, services_provider, sdb_user)

@core_ui_router.message(F.text.in_([
    "‚úçÔ∏è –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏",  # ru
    "‚úçÔ∏è Contact Us",  # en
    "‚úçÔ∏è –ó–≤'—è–∑–∞—Ç–∏—Å—è –∑ –Ω–∞–º–∏",  # ua
]), StateFilter(None))
async def handle_text_feedback_start_fsm(
    message: types.Message, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', –≤—Ö–æ–¥ –≤ FSM.")
    
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    text = t("feedback_request")
    await state.set_state(FSMFeedback.waiting_for_feedback_message)
    await message.answer(text) 

@core_ui_router.message(StateFilter(FSMFeedback.waiting_for_feedback_message), F.text)
async def process_feedback_message(
    message: types.Message, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    feedback_text = message.text
    user_id = sdb_user.telegram_id
    
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    # –ò–°–ü–û–õ–¨–ó–£–ï–ú html.escape
    user_full_name_escaped = html.escape(sdb_user.full_name) 
    username_escaped = f"@{html.escape(sdb_user.username)}" if sdb_user.username else "(–Ω–µ—Ç username)"
    
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç {user_id} ({username_escaped}): '{feedback_text[:100]}...'")

    admin_message_header = (
        f"üì¨ {hbold('–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!')}\n\n"
        f"üë§ –û—Ç: {user_full_name_escaped}\n"
        f"üÜî Telegram ID: {hcode(str(user_id))}\n"
        f"üîó Username: {username_escaped}\n"
        f"üïí –í—Ä–µ–º—è: {message.date.strftime('%Y-%m-%d %H:%M:%S %Z') if message.date else 'N/A'}\n"
    )
    admin_message_body = f"\nüìù {hbold('–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞:')}\n{html.escape(feedback_text)}" # –ò–°–ü–û–õ–¨–ó–£–ï–ú html.escape
    full_admin_message = admin_message_header + admin_message_body
    
    sent_to_admins_count = 0
    if services_provider.config.core.super_admins:
        for admin_tg_id in services_provider.config.core.super_admins:
            try:
                await message.bot.send_message(admin_tg_id, full_admin_message)
                sent_to_admins_count += 1
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∞–¥–º–∏–Ω—É {admin_tg_id}: {e}")
        if sent_to_admins_count > 0:
            logger.info(f"–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {sent_to_admins_count} —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        else:
            logger.warning("–û—Ç–∑—ã–≤ –Ω–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∏ –æ–¥–Ω–æ–º—É —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –æ—à–∏–±–∫–∏).")
    else:
        logger.warning("–°–ø–∏—Å–æ–∫ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—É—Å—Ç. –û—Ç–∑—ã–≤ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")
    
    await message.reply(t("feedback_thanks"))
    await show_main_menu_reply(message, message.bot, services_provider, sdb_user, text_override=t("main_menu_text"), state=state)

@core_ui_router.message(Command("cancel_feedback"), StateFilter(FSMFeedback.waiting_for_feedback_message))
async def cancel_feedback_fsm(
    message: types.Message, 
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext
):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –æ—Ç–º–µ–Ω–∏–ª –≤–≤–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.")
    
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    await message.reply(t("feedback_cancelled"))
    await show_main_menu_reply(message, bot, services_provider, sdb_user, text_override=t("main_menu_text"), state=state)


@core_ui_router.message(F.text.in_([
    "üõ† –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ",  # ru
    "üõ† Administration",  # en
    "üõ† –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è",  # ua
]))
async def handle_text_admin_panel(message: types.Message, services_provider: 'BotServicesProvider', sdb_user: DBUser, state: FSMContext): 
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å'")
    await state.clear() 
    from Systems.core.admin.entry.handlers_entry import send_admin_main_menu 
    await send_admin_main_menu(message, services_provider) 


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "main_reply"))
async def cq_nav_to_main_menu_reply(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext 
):
    await show_main_menu_reply(query, bot, services_provider, sdb_user, state=state) 


async def send_modules_list_message(
    chat_id: int, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    page: int = 1,
    message_to_edit: Optional[types.Message] = None 
):
    user_id = sdb_user.telegram_id
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    items_per_page = 5
    keyboard = await get_modules_list_keyboard(services_provider, user_id, page, items_per_page, locale=user_locale)
    
    num_module_buttons = 0; total_accessible_items = 0
    if keyboard.inline_keyboard: 
        for row in keyboard.inline_keyboard:
            for button in row:
                if button.callback_data and button.callback_data.startswith(ModuleMenuEntry.__prefix__):
                    num_module_buttons +=1

    all_module_ui_entries_temp = services_provider.ui_registry.get_all_module_entries()
    if all_module_ui_entries_temp:
        async with services_provider.db.get_session() as session:
            for entry_temp in all_module_ui_entries_temp:
                if entry_temp.required_permission_to_view:
                    if await services_provider.rbac.user_has_permission(session, user_id, entry_temp.required_permission_to_view):
                        total_accessible_items +=1
                else: total_accessible_items +=1
    
    total_pages = (total_accessible_items + items_per_page - 1) // items_per_page
    total_pages = max(1, total_pages)

    if num_module_buttons == 0 and page == 1: 
        text = t("modules_list_no_modules")
    else: 
        text = t("modules_list_title_template", current_page=page, total_pages=total_pages)
    
    if message_to_edit: 
        try:
            if message_to_edit.text != text or message_to_edit.reply_markup != keyboard:
                await message_to_edit.edit_text(text, reply_markup=keyboard)
            return 
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å edit modules list (inline pagination): {e}")
            return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ send_modules_list_message (edit): {e}", exc_info=True)
            return
    
    await bot.send_message(chat_id, text, reply_markup=keyboard)


async def send_profile_message(
    chat_id: int, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser,
    message_to_edit: Optional[types.Message] = None
):
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —è–∑—ã–∫–∞
    async with services_provider.db.get_session() as session:
        updated_user = await session.get(DBUser, sdb_user.id)
        if updated_user:
            sdb_user.preferred_language_code = updated_user.preferred_language_code
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if not sdb_user.created_at and updated_user.created_at:
                sdb_user.created_at = updated_user.created_at
            if not sdb_user.username and updated_user.username:
                sdb_user.username = updated_user.username
            if not sdb_user.full_name and updated_user.full_name:
                sdb_user.full_name = updated_user.full_name
    
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    reg_date_str = sdb_user.created_at.strftime('%d.%m.%Y %H:%M') if sdb_user.created_at else t("profile_no_reg_date")
    username_str = f"@{sdb_user.username}" if sdb_user.username else t("profile_no_username")
    current_lang = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —è–∑—ã–∫–∞ –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    lang_key = f"language_{current_lang}"
    lang_display_name = t(lang_key)

    profile_text = t("profile_info_template",
        user_id=str(sdb_user.telegram_id),
        full_name=sdb_user.full_name,
        username=username_str.replace("@", ""),
        registration_date=reg_date_str,
        current_language=lang_display_name
    )
    final_text = f"{hbold(t('profile_title'))}\n\n{profile_text}"
    keyboard = await get_profile_menu_keyboard(sdb_user, services_provider, locale=user_locale)
    
    if message_to_edit:
        try:
            if message_to_edit.text != final_text or message_to_edit.reply_markup != keyboard:
                await message_to_edit.edit_text(final_text, reply_markup=keyboard)
            return
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å edit profile (inline nav): {e}")
            return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ send_profile_message (edit): {e}", exc_info=True)
            return
            
    await bot.send_message(chat_id, final_text, reply_markup=keyboard)


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "modules_list"))
async def cq_nav_to_modules_list(
    query: types.CallbackQuery, 
    callback_data: CoreMenuNavigate, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser
):
    user_id = sdb_user.telegram_id
    page = callback_data.page if callback_data.page is not None else 1
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested modules list (inline nav), page: {page}")
    
    if query.message:
        await send_modules_list_message(query.message.chat.id, bot, services_provider, sdb_user, page, message_to_edit=query.message)
    await query.answer()


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile"))
async def cq_nav_to_profile( 
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser 
):
    if query.message:
        await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
    await query.answer()


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile_change_lang_list"))
async def cq_profile_show_language_list(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser
):
    user_id = sdb_user.telegram_id
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested language selection list.")
    
    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    translator = _get_translator_for_handler(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, user_locale, **kwargs)
    
    i18n_settings = services_provider.config.core.i18n
    
    current_lang = sdb_user.preferred_language_code or i18n_settings.default_locale
    available_langs = i18n_settings.available_locales
    
    text = t("profile_select_language_title")
    keyboard = await get_language_selection_keyboard(current_lang, available_langs, services_provider=services_provider, locale=user_locale)
    
    if query.message:
        try:
            if query.message.text != text or query.message.reply_markup != keyboard: 
                await query.message.edit_text(text, reply_markup=keyboard)
            await query.answer()
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                 logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text –≤ cq_profile_show_language_list: {e}")
            await query.answer() 
        except Exception as e:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –≤ cq_profile_show_language_list: {e}", exc_info=True)
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.")

@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile_set_lang"))
async def cq_profile_set_language(
    query: types.CallbackQuery,
    callback_data: CoreMenuNavigate,
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    translator: Translator 
):
    new_lang_code = callback_data.payload
    user_id = sdb_user.telegram_id
    
    if not new_lang_code or new_lang_code not in services_provider.config.core.i18n.available_locales:
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] User {user_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —è–∑—ã–∫: {new_lang_code}")
        await query.answer("–í—ã–±—Ä–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —è–∑—ã–∫.", show_alert=True)
        if query.message: 
            await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
        return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] User {user_id} —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —è–∑—ã–∫: {new_lang_code}")
    
    user_service = services_provider.user_service 
    language_updated = False
    async with services_provider.db.get_session() as session: 
        user_in_session = await session.get(DBUser, sdb_user.id) 
        if user_in_session:
            old_lang = user_in_session.preferred_language_code
            logger.debug(f"[{MODULE_NAME_FOR_LOG}] –¢–µ–∫—É—â–∏–π —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –ë–î: {old_lang}, –Ω–æ–≤—ã–π: {new_lang_code}")
            
            if await user_service.update_user_language(user_in_session, new_lang_code, session):
                try:
                    await session.commit()
                    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î –ø–æ—Å–ª–µ commit
                    await session.refresh(user_in_session)
                    saved_lang = user_in_session.preferred_language_code
                    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ—Å–ª–µ commit —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –ë–î: {saved_lang}")
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç sdb_user
                    sdb_user.preferred_language_code = saved_lang
                    language_updated = True
                    
                    logger.success(f"[{MODULE_NAME_FOR_LOG}] –Ø–∑—ã–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {new_lang_code} –≤ –ë–î (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: {saved_lang}).")
                    
                    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ
                    user_locale = new_lang_code
                    translator = _get_translator_for_handler(services_provider)
                    def t(key: str, **kwargs) -> str:
                        return translator.gettext(key, user_locale, **kwargs)
                    
                    await query.answer(t("profile_language_changed").format(lang=new_lang_code.upper()), show_alert=False)
                except Exception as e_commit:
                    await session.rollback()
                    logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ –¥–ª—è {user_id}: {e_commit}", exc_info=True)
                    
                    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
                    user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
                    translator = _get_translator_for_handler(services_provider)
                    def t(key: str, **kwargs) -> str:
                        return translator.gettext(key, user_locale, **kwargs)
                    
                    await query.answer(t("profile_language_change_error"), show_alert=True)
            else:
                # –Ø–∑—ã–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                logger.debug(f"[{MODULE_NAME_FOR_LOG}] –Ø–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {new_lang_code}")
                user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
                translator = _get_translator_for_handler(services_provider)
                def t(key: str, **kwargs) -> str:
                    return translator.gettext(key, user_locale, **kwargs)
                
                await query.answer(t("profile_language_already_set").format(lang=new_lang_code.upper()), show_alert=False)
        else: 
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (DB ID: {sdb_user.id}) –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞")
            user_locale = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
            translator = _get_translator_for_handler(services_provider)
            def t(key: str, **kwargs) -> str:
                return translator.gettext(key, user_locale, **kwargs)
            
            await query.answer(t("profile_language_user_not_found"), show_alert=True)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–∑—ã–∫ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω
    if query.message and language_updated:
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async with services_provider.db.get_session() as session:
            updated_user = await session.get(DBUser, sdb_user.id)
            if updated_user:
                final_lang = updated_user.preferred_language_code
                logger.debug(f"[{MODULE_NAME_FOR_LOG}] –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –ë–î –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: {final_lang}")
                sdb_user.preferred_language_code = final_lang
        await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
    elif query.message:
        # –ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
    

@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "feedback_fsm_start"))
async def cq_nav_to_feedback_fsm_start( 
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    user_id = query.from_user.id
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å (FSM —á–µ—Ä–µ–∑ callback).")
    text = (
        "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n"
        f"{hitalic('–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel_feedback')}"
    )
    await state.set_state(FSMFeedback.waiting_for_feedback_message)
    
    if query.message:
        try: 
            await query.message.edit_text(text, reply_markup=None) 
        except TelegramBadRequest as e:
             if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º feedback (callback): {e}")
                await bot.send_message(user_id, text) 
        except Exception as e_edit_fb:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º feedback (callback): {e_edit_fb}")
            await bot.send_message(user_id, text)
    else: 
        await bot.send_message(user_id, text)
    await query.answer()


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "delete_this_message"))
async def cq_service_action_delete_message(query: types.CallbackQuery):
    user_id = query.from_user.id
    message_id = query.message.message_id if query.message else "N/A"
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested to delete message_id: {message_id}")
    
    try:
        if query.message:
            await query.bot.delete_message(chat_id=query.message.chat.id, message_id=query.message.message_id)
            await query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.") 
        else:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç user {user_id}.")
            await query.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except TelegramBadRequest as e: 
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –¥–ª—è user {user_id}: {e} (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤).")
        await query.answer() 
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è {message_id} –¥–ª—è user {user_id}: {e}", exc_info=True)
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.", show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/sys_modules/__init__.py ------------------------------
# core/sys_modules/__init__.py
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–µ–ª–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'sys_modules' –ø–∞–∫–µ—Ç–æ–º Python.
# –°—é–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–º–µ—â–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ —è–¥—Ä–∞.

# –ü—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±—ã –∑–¥–µ—Å—å –±—ã–ª –º–æ–¥—É–ª—å 'internal_logger_viewer':
# from .internal_logger_viewer import setup_module as setup_logger_viewer_module
# from .internal_logger_viewer.handlers import logger_viewer_router

# __all__ = ["setup_logger_viewer_module", "logger_viewer_router"]


======================================================================

------------------------------ FILE: Systems/core/database/core_models.py ------------------------------
# core/database/core_models.py
from datetime import datetime
from typing import List, Optional, TYPE_CHECKING
from sqlalchemy import String, ForeignKey, UniqueConstraint, Text, BigInteger
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .base import SDBBaseModel 

SDB_CORE_TABLE_PREFIX = "sdb_"

if TYPE_CHECKING:
    pass 

def get_column_comment(text: str) -> Optional[str]:
    return text

class Permission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}permissions"
    
    name: Mapped[str] = mapped_column(
        String(100), 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'view_users', 'manage_modules')")
    )
    description: Mapped[Optional[str]] = mapped_column(
        Text, 
        nullable=True, 
        comment=get_column_comment("–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )
    
    roles: Mapped[List["Role"]] = relationship(
        "Role",
        secondary=f"{SDB_CORE_TABLE_PREFIX}role_permissions",
        back_populates="permissions",
        lazy="selectin" 
    )
    
    # –ù–æ–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users_with_direct_access: Mapped[List["User"]] = relationship(
        "User",
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_permissions", # –ò–º—è –Ω–æ–≤–æ–π —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
        back_populates="direct_permissions",
        lazy="selectin" # –∏–ª–∏ "noload", –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
    )

    def __repr__(self) -> str:
        return f"<Permission(id={self.id}, name='{self.name}')>"

class RolePermission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}role_permissions"
    __table_args__ = (
        UniqueConstraint('role_id', 'permission_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}role_permissions_role_id_permission_id'),
    )
    
    role_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}roles.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–æ–ª–∏")
    )
    permission_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}permissions.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )

    def __repr__(self) -> str:
        return f"<RolePermission(id={self.id}, role_id={self.role_id}, permission_id={self.permission_id})>"
        
class Role(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}roles"
    
    name: Mapped[str] = mapped_column(
        String(50), 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–æ–ª–∏")
    )
    description: Mapped[Optional[str]] = mapped_column(
        Text, 
        nullable=True, 
        comment=get_column_comment("–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏")
    )
    
    users: Mapped[List["User"]] = relationship(
        "User", 
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_roles",
        back_populates="roles",
        lazy="selectin",
        cascade="save-update, merge" 
    )

    permissions: Mapped[List["Permission"]] = relationship(
        "Permission",
        secondary=f"{SDB_CORE_TABLE_PREFIX}role_permissions",
        back_populates="roles",
        lazy="selectin", 
        cascade="save-update, merge"
    )

    def __repr__(self) -> str:
        return f"<Role(id={self.id}, name='{self.name}')>"


class UserRole(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}user_roles"
    __table_args__ = (
        UniqueConstraint('user_id', 'role_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}user_roles_user_id_role_id'),
    )
    
    user_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}users.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    role_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}roles.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–æ–ª–∏")
    )

    def __repr__(self) -> str:
        return f"<UserRole(id={self.id}, user_id={self.user_id}, role_id={self.role_id})>"

# --- –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–≤—è–∑–∏ User <-> Permission ---
class UserPermission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}user_permissions"
    __table_args__ = (
        UniqueConstraint('user_id', 'permission_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}user_permissions_user_id_permission_id'),
    )

    user_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment=get_column_comment("ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    permission_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}permissions.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment=get_column_comment("ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )

    def __repr__(self) -> str:
        return f"<UserPermission(id={self.id}, user_id={self.user_id}, permission_id={self.permission_id})>"


class User(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}users"

    username_lower: Mapped[Optional[str]] = mapped_column(
        String(32), 
        nullable=True, 
        index=True, 
        comment=get_column_comment("Telegram username –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è –ø–æ–∏—Å–∫–∞")
    )
    
    telegram_id: Mapped[int] = mapped_column(
        BigInteger, 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω—ã–π Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    username: Mapped[Optional[str]] = mapped_column( 
        String(32), 
        nullable=True, 
        index=True, 
        comment=get_column_comment("Telegram username (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)")
    )
    first_name: Mapped[Optional[str]] = mapped_column(
        String(255), 
        nullable=True, 
        comment=get_column_comment("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    last_name: Mapped[Optional[str]] = mapped_column(
        String(255), 
        nullable=True, 
        comment=get_column_comment("–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    preferred_language_code: Mapped[Optional[str]] = mapped_column(
        String(10), 
        nullable=True, 
        comment=get_column_comment("–ö–æ–¥ —è–∑—ã–∫–∞ –±–æ—Ç–∞")
    )
    is_active: Mapped[bool] = mapped_column(
        default=True, 
        nullable=False, 
        comment=get_column_comment("–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    )
    is_bot_blocked: Mapped[bool] = mapped_column(
        default=False, 
        nullable=False, 
        comment=get_column_comment("–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞")
    )
    last_activity_at: Mapped[Optional[datetime]] = mapped_column(
        nullable=True, 
        comment=get_column_comment("–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")
    )

    roles: Mapped[List["Role"]] = relationship(
        "Role", 
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_roles",
        back_populates="users",
        lazy="selectin",
        cascade="save-update, merge"
    )
    
    # –ù–æ–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
    direct_permissions: Mapped[List["Permission"]] = relationship(
        "Permission",
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_permissions", # –ò–º—è –Ω–æ–≤–æ–π —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
        back_populates="users_with_direct_access",
        lazy="selectin", # –∏–ª–∏ "noload", –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∞–≤–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —é–∑–µ—Ä–∞
        cascade="save-update, merge" # –ü–æ–∑–≤–æ–ª–∏—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ user.direct_permissions.append()
    )
    
    @property
    def full_name(self) -> str:
        parts = []
        if self.first_name: parts.append(self.first_name)
        if self.last_name: parts.append(self.last_name)
        if parts: return " ".join(parts)
        elif self.username: return f"@{self.username}"
        return f"User_{self.telegram_id}"

    def __repr__(self) -> str:
        return f"<User(id={self.id}, tg_id={self.telegram_id}, name='{self.full_name}')>"


======================================================================

------------------------------ FILE: Systems/core/database/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/database/db_utils.py ------------------------------
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.
"""
from typing import Optional, Dict, Any
from sqlalchemy import create_engine, text
from sqlalchemy.engine import Engine


class DatabaseDialectHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ª–µ–∫—Ç–æ–≤ –ë–î"""
    
    @staticmethod
    def get_dialect_features(engine: Engine) -> Dict[str, bool]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞ –ë–î"""
        dialect_name = engine.dialect.name.lower()
        
        features = {
            'supports_comments': True,
            'supports_check_constraints': True,
            'supports_deferrable_fks': True,
            'supports_sequences': True,
            'supports_returning': True,
            'case_sensitive': True,
        }
        
        if dialect_name == 'sqlite':
            features.update({
                'supports_comments': False,
                'supports_deferrable_fks': False,
                'supports_sequences': False,
                'supports_returning': False,  # –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ SQLite
                'case_sensitive': False,
            })
        elif dialect_name in ['mysql', 'mariadb']:
            features.update({
                'supports_comments': True,
                'supports_check_constraints': True,  # MySQL 8.0+
                'supports_deferrable_fks': False,
                'supports_sequences': False,  # –î–æ MySQL 8.0
                'supports_returning': False,
                'case_sensitive': False,  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
            })
        elif dialect_name == 'postgresql':
            features.update({
                'supports_comments': True,
                'supports_check_constraints': True,
                'supports_deferrable_fks': True,
                'supports_sequences': True,
                'supports_returning': True,
                'case_sensitive': True,
            })
        
        return features
    
    @staticmethod
    def get_recommended_types(engine: Engine) -> Dict[str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞"""
        dialect_name = engine.dialect.name.lower()
        
        if dialect_name == 'sqlite':
            return {
                'id': 'INTEGER',
                'bigint': 'INTEGER',
                'string_short': 'TEXT',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'INTEGER',
                'datetime': 'DATETIME',
                'json': 'TEXT',
            }
        elif dialect_name in ['mysql', 'mariadb']:
            return {
                'id': 'INT AUTO_INCREMENT',
                'bigint': 'BIGINT',
                'string_short': 'VARCHAR(255)',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'TINYINT(1)',
                'datetime': 'DATETIME',
                'json': 'JSON',  # MySQL 5.7+
            }
        elif dialect_name == 'postgresql':
            return {
                'id': 'SERIAL',
                'bigint': 'BIGINT',
                'string_short': 'VARCHAR(255)',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'BOOLEAN',
                'datetime': 'TIMESTAMP WITH TIME ZONE',
                'json': 'JSONB',
            }
        
        return {}
    
    @staticmethod
    def create_db_if_not_exists(connection_url: str, db_name: str) -> bool:
        """–°–æ–∑–¥–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–¥–ª—è MySQL/PostgreSQL)"""
        try:
            if 'mysql' in connection_url or 'mariadb' in connection_url:
                # –î–ª—è MySQL
                base_url = connection_url.rsplit('/', 1)[0]
                engine = create_engine(base_url + '/mysql')
                with engine.connect() as conn:
                    conn.execute(text(f"CREATE DATABASE IF NOT EXISTS `{db_name}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci"))
                    conn.commit()
                return True
                
            elif 'postgresql' in connection_url:
                # –î–ª—è PostgreSQL
                base_url = connection_url.rsplit('/', 1)[0]
                engine = create_engine(base_url + '/postgres')
                with engine.connect() as conn:
                    # PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç –¥–ª—è CREATE DATABASE
                    conn.execute(text("COMMIT"))
                    result = conn.execute(text("SELECT 1 FROM pg_database WHERE datname = :db_name"), {"db_name": db_name})
                    if not result.fetchone():
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å identifier()
                        from sqlalchemy import sql
                        conn.execute(text('CREATE DATABASE :db_name WITH ENCODING "UTF8"').bindparam(
                            sql.bindparam("db_name", db_name, literal_execute=True)))
                return True
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î {db_name}: {e}")
            return False
        
        return True  # SQLite —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏


def get_db_info_query(dialect_name: str) -> Optional[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ë–î"""
    if dialect_name == 'sqlite':
        return "SELECT sqlite_version() as version"
    elif dialect_name in ['mysql', 'mariadb']:
        return "SELECT VERSION() as version"
    elif dialect_name == 'postgresql':
        return "SELECT version() as version"
    return None


def optimize_for_dialect(engine: Engine) -> Dict[str, Any]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞ –ë–î"""
    dialect_name = engine.dialect.name.lower()
    
    settings = {}
    
    if dialect_name == 'sqlite':
        settings = {
            'pool_pre_ping': False,
            'pool_recycle': -1,
            'echo': False,
            'connect_args': {
                'check_same_thread': False,
                'timeout': 30,
            }
        }
    elif dialect_name in ['mysql', 'mariadb']:
        settings = {
            'pool_pre_ping': True,
            'pool_recycle': 3600,
            'pool_size': 10,
            'max_overflow': 20,
            'connect_args': {
                'charset': 'utf8mb4',
                'connect_timeout': 60,
            }
        }
    elif dialect_name == 'postgresql':
        settings = {
            'pool_pre_ping': True,
            'pool_recycle': 3600,
            'pool_size': 10,
            'max_overflow': 20,
            'connect_args': {
                'connect_timeout': 60,
                'application_name': 'SwiftDevBot',
            }
        }
    
    return settings


======================================================================

------------------------------ FILE: Systems/core/database/manager.py ------------------------------
# core/database/manager.py

from pathlib import Path
from contextlib import asynccontextmanager
from typing import AsyncGenerator, List, Type, Optional, TYPE_CHECKING

from sqlalchemy.ext.asyncio import (
    AsyncSession,
    async_sessionmaker,
    create_async_engine,
    AsyncEngine
)
from sqlalchemy.pool import NullPool
from loguru import logger

from .base import Base
from Systems.core.app_settings import DEFAULT_PROJECT_DATA_DIR_NAME

if TYPE_CHECKING:
    from Systems.core.app_settings import DBSettings, AppSettings

class DBManager:
    def __init__(self, db_settings: 'DBSettings', app_settings: 'AppSettings'): # app_settings —Ç–µ–ø–µ—Ä—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        self._db_settings: 'DBSettings' = db_settings
        self._app_settings: 'AppSettings' = app_settings
        self._engine: Optional[AsyncEngine] = None
        self._session_factory: Optional[async_sessionmaker[AsyncSession]] = None
        self._db_url: Optional[str] = None

        self._logger = logger.bind(service="DBManager")
        self._logger.info(f"DBManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î: {self._db_settings.type}")

    def _build_db_url(self) -> str:
        if self._db_url:
            return self._db_url

        db_type = self._db_settings.type
        url: str

        if db_type == "sqlite":
            sqlite_path_str = self._db_settings.sqlite_path
            path_obj = Path(sqlite_path_str)
            abs_path: Path

            if path_obj.is_absolute():
                abs_path = path_obj.resolve()
            else:
                # self._app_settings –∑–¥–µ—Å—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç.–∫. –æ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
                if DEFAULT_PROJECT_DATA_DIR_NAME in path_obj.parts:
                    project_root_dir = self._app_settings.core.project_data_path.parent
                    abs_path = (project_root_dir / path_obj).resolve()
                else: 
                    abs_path = (self._app_settings.core.project_data_path / path_obj).resolve()
            
            abs_path.parent.mkdir(parents=True, exist_ok=True)
            self._logger.debug(f"–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –¥–ª—è SQLite: {abs_path}")
            url = f"sqlite+aiosqlite:///{abs_path}"
            
        elif db_type == "postgresql":
            if not self._db_settings.pg_dsn:
                msg = "DSN –¥–ª—è PostgreSQL (pg_dsn) –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
                self._logger.error(msg)
                raise ValueError(msg)
            url = str(self._db_settings.pg_dsn)
            
        elif db_type == "mysql":
            if not self._db_settings.mysql_dsn:
                msg = "DSN –¥–ª—è MySQL (mysql_dsn) –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
                self._logger.error(msg)
                raise ValueError(msg)
            url = str(self._db_settings.mysql_dsn)
            
        else:
            msg = f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: '{db_type}'"
            self._logger.error(msg)
            raise ValueError(msg)
        
        self._db_url = url
        return url

    async def initialize(self) -> None:
        if self._engine is not None:
            self._logger.debug("DBManager (engine) —É–∂–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return

        db_url = self._build_db_url()
        self._logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ SQLAlchemy –¥–ª—è URL: '{db_url[:db_url.find('://')+3]}...' (–¥–µ—Ç–∞–ª–∏ URL —Å–∫—Ä—ã—Ç—ã)")
        
        echo_sql = self._db_settings.echo_sql

        try:
            self._engine = create_async_engine(
                db_url,
                echo=echo_sql, 
                poolclass=NullPool,
            )
            
            self._session_factory = async_sessionmaker(
                bind=self._engine,
                class_=AsyncSession,
                expire_on_commit=False,
                autoflush=False,
                autocommit=False,
            )
            self._logger.success("SQLAlchemy AsyncEngine –∏ SessionFactory —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")
        except Exception as e:
            self._logger.critical(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SQLAlchemy Engine –∏–ª–∏ SessionFactory –¥–ª—è URL '{db_url}': {e}", exc_info=True)
            self._engine = None
            self._session_factory = None
            raise

    async def dispose(self) -> None:
        if self._engine:
            self._logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ SQLAlchemy AsyncEngine...")
            try:
                await self._engine.dispose()
                self._logger.success("SQLAlchemy AsyncEngine —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç.")
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ SQLAlchemy AsyncEngine: {e}", exc_info=True)
            finally:
                self._engine = None
                self._session_factory = None
        else:
            self._logger.debug("DBManager (engine) –Ω–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç.")

    @asynccontextmanager
    async def get_session(self) -> AsyncGenerator[AsyncSession, None]:
        if not self._session_factory:
            msg = "DBManager SessionFactory –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞! –í—ã–∑–æ–≤–∏—Ç–µ initialize() –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º —Å–µ—Å—Å–∏–∏."
            self._logger.critical(msg)
            raise RuntimeError(msg)

        session: AsyncSession = self._session_factory()
        self._logger.trace(f"–°–µ—Å—Å–∏—è –ë–î {id(session)} –æ—Ç–∫—Ä—ã—Ç–∞.")
        try:
            yield session
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –≤ —Å–µ—Å—Å–∏–∏ –ë–î {id(session)}: {e}. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–∫–∞—Ç (rollback).", exc_info=True)
            await session.rollback()
            raise
        finally:
            await session.close()
            self._logger.trace(f"–°–µ—Å—Å–∏—è –ë–î {id(session)} –∑–∞–∫—Ä—ã—Ç–∞.")

    async def create_all_core_tables(self) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)

        self._logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Base.metadata...")
        async with self._engine.begin() as conn:
            from Systems.core.database import core_models # noqa: F401
            await conn.run_sync(Base.metadata.create_all)
        self._logger.success("–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ Base.metadata) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).")

    async def create_specific_module_tables(self, module_model_classes: List[Type[Base]]) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)
        if not module_model_classes:
            self._logger.debug("–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è (—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç).")
            return

        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ —è–¥—Ä–∞ –ü–ï–†–ï–î –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª–µ–π
        # –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã SQLAlchemy –∑–Ω–∞–ª –æ —Ç–∞–±–ª–∏—Ü–∞—Ö —è–¥—Ä–∞ (sdb_users, sdb_roles –∏ —Ç.–¥.)
        # –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ foreign key –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –º–æ–¥—É–ª–µ–π
        from Systems.core.database import core_models # noqa: F401
        
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —Å–æ–∑–¥–∞–Ω—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤ –ë–î –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª–µ–π
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞
        from sqlalchemy import inspect, text
        from Systems.core.database.core_models import SDB_CORE_TABLE_PREFIX
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async with self._engine.begin() as check_conn:
            if self._db_settings.type == "sqlite":
                result = await check_conn.execute(text("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'sdb_%'"))
                existing_core_tables = [row[0] for row in result.fetchall()]
            else:
                inspector = inspect(self._engine.sync_engine)
                existing_core_tables = [t for t in inspector.get_table_names() if t.startswith("sdb_")]
        
        # –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∏—Ö (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
        if not existing_core_tables:
            self._logger.warning("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î. –°–æ–∑–¥–∞–µ–º –∏—Ö –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è...")
            await self.create_all_core_tables()
            self._logger.success("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —Å–æ–∑–¥–∞–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è...")
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ç–∞–±–ª–∏—Ü—ã sdb_users, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –Ω—É–∂–Ω–∞ –¥–ª—è foreign keys
            users_table_name = f"{SDB_CORE_TABLE_PREFIX}users"
            if users_table_name not in existing_core_tables:
                self._logger.warning(f"–¢–∞–±–ª–∏—Ü–∞ '{users_table_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞...")
                await self.create_all_core_tables()
                self._logger.success("–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —Å–æ–∑–¥–∞–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è...")
            else:
                self._logger.debug(f"–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î, –≤–∫–ª—é—á–∞—è '{users_table_name}': {existing_core_tables[:3]}...")

        tables_to_create = [model_cls.__table__ for model_cls in module_model_classes]
        table_names_str = ", ".join([table.name for table in tables_to_create])
        self._logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è –º–æ–¥—É–ª—è: [{table_names_str}]")

        async with self._engine.begin() as conn:
            # –í–∞–∂–Ω–æ: –º–æ–¥–µ–ª–∏ —è–¥—Ä–∞ —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—ã—à–µ, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∏ –≤ Base.metadata
            # –¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω—ã –≤—ã—à–µ, –µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º create_all –ë–ï–ó —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü, —á—Ç–æ–±—ã SQLAlchemy
            # –º–æ–≥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (foreign keys) –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
            # checkfirst=True –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã
            # –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ –ë–î
            await conn.run_sync(
                lambda sync_conn: Base.metadata.create_all(
                    bind=sync_conn, 
                    checkfirst=True
                )
            )
        self._logger.success(f"–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è [{table_names_str}] —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).")

    async def drop_specific_module_tables(self, module_model_classes: List[Type[Base]]) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)
        if not module_model_classes:
            self._logger.debug("–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è (—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç).")
            return

        tables_to_drop = [model_cls.__table__ for model_cls in module_model_classes]
        tables_to_drop_ordered = tables_to_drop[::-1] 
        table_names_str = ", ".join([table.name for table in tables_to_drop_ordered])
        
        self._logger.warning(f"–ó–ê–ü–†–û–° –ù–ê –£–î–ê–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶ –ú–û–î–£–õ–Ø (–û–ü–ê–°–ù–û!): [{table_names_str}]")
        
        async with self._engine.begin() as conn:
            await conn.run_sync(Base.metadata.drop_all, tables=tables_to_drop_ordered)
        self._logger.success(f"–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è [{table_names_str}] —É—Å–ø–µ—à–Ω–æ –£–î–ê–õ–ï–ù–´.")


======================================================================

------------------------------ FILE: Systems/core/database/base.py ------------------------------
# core/database/base.py
from typing import Any, Dict
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import func, MetaData
from datetime import datetime, timezone 

convention = {
    "ix": "ix_%(column_0_label)s",
    "uq": "uq_%(table_name)s_%(column_0_name)s",
    "ck": "ck_%(table_name)s_%(constraint_name)s",
    "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
    "pk": "pk_%(table_name)s"
}
metadata_obj = MetaData(naming_convention=convention)

class Base(DeclarativeBase):
    metadata = metadata_obj

class SDBBaseModel(Base):
    __abstract__ = True
    id: Mapped[int] = mapped_column(primary_key=True, index=True, autoincrement=True)
    created_at: Mapped[datetime] = mapped_column(
        default=lambda: datetime.now(timezone.utc),
        server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
        server_default=func.now(),
        server_onupdate=func.now() 
    )
    def to_dict(self, exclude: set = None) -> Dict[str, Any]:
        if exclude is None: exclude = set()
        data = {}
        for prop in self.__mapper__.iterate_properties:
            if hasattr(prop, 'columns') and prop.key not in exclude:
                try: data[prop.key] = getattr(self, prop.key)
                except AttributeError: pass
        return data
    def __repr__(self) -> str:
        pk_column_names = [pk_col.name for pk_col in self.__table__.primary_key.columns]
        pk_values_str = ", ".join(f"{name}={getattr(self, name)!r}" for name in pk_column_names)
        return f"<{self.__class__.__name__}({pk_values_str})>"


======================================================================

------------------------------ FILE: Systems/core/rbac/service.py ------------------------------
# core/rbac/service.py
from typing import TYPE_CHECKING, Dict, List, Optional, Set, Tuple, Union

from loguru import logger
from sqlalchemy import delete
from sqlalchemy import func as sql_func
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload

from Systems.core.database.core_models import (Permission,  # –î–æ–±–∞–≤–ª–µ–Ω–∞ UserPermission
                                       Role, RolePermission, User,
                                       UserPermission, UserRole)
from Systems.core.schemas.module_manifest import \
    PermissionManifest as ModulePermissionManifestSchema

if TYPE_CHECKING:
    from Systems.core.database.manager import DBManager
    from Systems.core.module_loader import ModuleInfo
    from Systems.core.services_provider import BotServicesProvider

# --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –†–æ–ª–∏ ---
DEFAULT_ROLE_USER = "User"
DEFAULT_ROLE_MODERATOR = "Moderator"
DEFAULT_ROLE_ADMIN = "Admin"
DEFAULT_ROLE_SUPER_ADMIN = "SuperAdmin"

DEFAULT_ROLES_DEFINITIONS: Dict[str, str] = {
    DEFAULT_ROLE_USER: "–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –±–∞–∑–æ–≤—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞.",
    DEFAULT_ROLE_MODERATOR: "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.",
    DEFAULT_ROLE_ADMIN: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∏–º–µ–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö.",
    DEFAULT_ROLE_SUPER_ADMIN: "–°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∏–º–µ–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã.",
}

# --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ø–î–†–ê (Permissions) ---
PERMISSION_CORE_VIEW_ADMIN_PANEL = "core.admin.view_panel"
PERMISSION_CORE_USERS_VIEW_LIST = "core.users.view_list"
PERMISSION_CORE_USERS_VIEW_DETAILS = "core.users.view_details"
PERMISSION_CORE_USERS_EDIT_PROFILE = "core.users.edit_profile"
PERMISSION_CORE_USERS_MANAGE_STATUS = "core.users.manage_status"
PERMISSION_CORE_USERS_ASSIGN_ROLES = "core.users.assign_roles"
PERMISSION_CORE_USERS_DELETE = "core.users.delete"
PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS = "core.users.manage_direct_permissions"  # –ù–û–í–û–ï –†–ê–ó–†–ï–®–ï–ù–ò–ï

PERMISSION_CORE_ROLES_VIEW = "core.roles.view"
PERMISSION_CORE_ROLES_CREATE = "core.roles.create"
PERMISSION_CORE_ROLES_EDIT = "core.roles.edit"
PERMISSION_CORE_ROLES_DELETE = "core.roles.delete"
PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS = "core.roles.assign_permissions"

PERMISSION_CORE_PERMISSIONS_VIEW = "core.permissions.view"

PERMISSION_CORE_MODULES_VIEW_LIST = "core.modules.view_list"
PERMISSION_CORE_MODULES_TOGGLE_ACTIVATION = "core.modules.toggle_activation"
PERMISSION_CORE_MODULES_MANAGE_SETTINGS = "core.modules.manage_settings"

PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC = "core.system.view_info.basic"
PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL = "core.system.view_info.full"
PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC = "core.system.view_logs.basic"
PERMISSION_CORE_SYSTEM_VIEW_LOGS_FULL = "core.system.view_logs.full"
PERMISSION_CORE_SYSTEM_MANAGE_BACKUPS = "core.system.manage_backups"
PERMISSION_CORE_SYSTEM_SEND_BROADCAST = "core.system.send_broadcast"

PERMISSION_CORE_SETTINGS_VIEW = "core.settings.view"
PERMISSION_CORE_SETTINGS_EDIT = "core.settings.edit"


DEFAULT_CORE_PERMISSIONS_DEFINITIONS: Dict[str, str] = {
    PERMISSION_CORE_VIEW_ADMIN_PANEL: "–î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.",
    PERMISSION_CORE_USERS_VIEW_LIST: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
    PERMISSION_CORE_USERS_VIEW_DETAILS: "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.",
    PERMISSION_CORE_USERS_EDIT_PROFILE: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, —è–∑—ã–∫ –∏ —Ç.–¥.).",
    PERMISSION_CORE_USERS_MANAGE_STATUS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–∫—Ç–∏–≤–µ–Ω/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω).",
    PERMISSION_CORE_USERS_ASSIGN_ROLES: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ —Ä–æ–ª–µ–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
    PERMISSION_CORE_USERS_DELETE: "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",  # –û–ü–ò–°–ê–ù–ò–ï –ù–û–í–û–ì–û –†–ê–ó–†–ï–®–ï–ù–ò–Ø
    PERMISSION_CORE_ROLES_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–æ–ª–µ–π –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.",
    PERMISSION_CORE_ROLES_CREATE: "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π.",
    PERMISSION_CORE_ROLES_EDIT: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–æ–ª–µ–π (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ).",
    PERMISSION_CORE_ROLES_DELETE: "–£–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π.",
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Å —Ä–æ–ª–µ–π.",
    PERMISSION_CORE_PERMISSIONS_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.",
    PERMISSION_CORE_MODULES_VIEW_LIST: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤.",
    PERMISSION_CORE_MODULES_TOGGLE_ACTIVATION: "–í–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–æ–≤.",
    PERMISSION_CORE_MODULES_MANAGE_SETTINGS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–¥—É–ª–µ–π.",
    PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC: "–ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
    PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.",
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC: "–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_FULL: "–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã –∏ –∏—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ.",
    PERMISSION_CORE_SYSTEM_MANAGE_BACKUPS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_SYSTEM_SEND_BROADCAST: "–û—Ç–ø—Ä–∞–≤–∫–∞ —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.",
    PERMISSION_CORE_SETTINGS_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ —è–¥—Ä–∞ SwiftDevBot.",
    PERMISSION_CORE_SETTINGS_EDIT: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —è–¥—Ä–∞ SwiftDevBot (–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫).",
}

DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE: Set[str] = {
    PERMISSION_CORE_VIEW_ADMIN_PANEL,
    PERMISSION_CORE_USERS_VIEW_LIST,
    PERMISSION_CORE_USERS_VIEW_DETAILS,
    PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
}

DEFAULT_PERMISSIONS_FOR_CORE_ADMIN_ROLE: Set[str] = {
    *DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE,
    PERMISSION_CORE_USERS_MANAGE_STATUS,
    PERMISSION_CORE_USERS_ASSIGN_ROLES,
    PERMISSION_CORE_MODULES_VIEW_LIST,
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC,
    PERMISSION_CORE_ROLES_VIEW,
    PERMISSION_CORE_PERMISSIONS_VIEW,
    PERMISSION_CORE_ROLES_CREATE,
    PERMISSION_CORE_ROLES_EDIT,
    PERMISSION_CORE_ROLES_DELETE,
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS,
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS,  # –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏ Admin –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

# –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç –í–°–ï —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
DEFAULT_PERMISSIONS_FOR_CORE_SUPER_ADMIN_ROLE: Set[str] = {
    *DEFAULT_PERMISSIONS_FOR_CORE_ADMIN_ROLE,
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞
    PERMISSION_CORE_USERS_DELETE,
    PERMISSION_CORE_USERS_EDIT_PROFILE,
    PERMISSION_CORE_MODULES_TOGGLE_ACTIVATION,
    PERMISSION_CORE_MODULES_MANAGE_SETTINGS,
    PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL,
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_FULL,
    PERMISSION_CORE_SYSTEM_MANAGE_BACKUPS,
    PERMISSION_CORE_SYSTEM_SEND_BROADCAST,
    PERMISSION_CORE_SETTINGS_VIEW,
    PERMISSION_CORE_SETTINGS_EDIT,
}

DEFAULT_PERMISSIONS_FOR_CORE_USER_ROLE: Set[str] = set()


class RBACService:
    def __init__(self, services: Optional["BotServicesProvider"] = None, db_manager: Optional["DBManager"] = None):
        self._services_provider_ref: Optional["BotServicesProvider"] = services
        if db_manager:
            self._db_manager = db_manager
        elif services and hasattr(services, "db") and services.db is not None:
            self._db_manager = services.db
        else:
            self._db_manager = None
            logger.warning(
                "RBACService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –±–µ–∑ DBManager. "
                "–ú–µ—Ç–æ–¥—ã ensure_default_... –ø–æ—Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ DBManager."
            )

        self._logger = logger.bind(service="RBACService")
        self._logger.info("RBACService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def _get_role_by_name(self, session: AsyncSession, role_name: str) -> Optional[Role]:
        self._logger.trace(f"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ –∏–º–µ–Ω–∏: '{role_name}'")
        stmt = select(Role).options(selectinload(Role.permissions)).where(Role.name == role_name)
        result = await session.execute(stmt)
        role = result.scalars().first()
        self._logger.trace(f"–†–æ–ª—å '{role_name}' –Ω–∞–π–¥–µ–Ω–∞: {role is not None} (ID: {getattr(role, 'id', 'N/A')})")
        return role

    async def get_or_create_role(
        self, session: AsyncSession, role_name: str, description: Optional[str] = None
    ) -> Optional[Role]:
        role = await self._get_role_by_name(session, role_name)
        if not role:
            role_def_desc = DEFAULT_ROLES_DEFINITIONS.get(role_name)
            current_description = description if description is not None else role_def_desc

            if role_name in DEFAULT_ROLES_DEFINITIONS and description is None:
                current_description = role_def_desc

            self._logger.info(
                f"–†–æ–ª—å '{role_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º: '{current_description or '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}'."
            )
            role = Role(name=role_name, description=current_description)
            session.add(role)
            try:
                await session.flush([role])
                self._logger.success(f"–†–æ–ª—å '{role_name}' —Å–æ–∑–¥–∞–Ω–∞ (—Åflushed) —Å ID: {role.id}")
            except Exception as e_flush_role:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ flush –¥–ª—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏ '{role_name}': {e_flush_role}", exc_info=True)
                return None
        return role

    async def register_permissions_from_modules(self, session: AsyncSession) -> int:
        if not self._services_provider_ref or not hasattr(self._services_provider_ref, "modules"):
            self._logger.error(
                "ModuleLoader –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ BotServicesProvider. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞."
            )
            return 0

        module_loader = self._services_provider_ref.modules
        declared_perms_manifests: List[ModulePermissionManifestSchema] = (
            module_loader.get_all_declared_permissions_from_active_modules()
        )

        if not declared_perms_manifests:
            self._logger.info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö, –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
            return 0

        self._logger.info(
            f"–ù–∞–π–¥–µ–Ω–æ {len(declared_perms_manifests)} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏..."
        )

        created_count = 0

        for perm_mft in declared_perms_manifests:
            existing_perm = await self._get_permission_by_name(session, perm_mft.name)
            if not existing_perm:
                new_perm_obj = await self.get_or_create_permission(session, perm_mft.name, perm_mft.description)
                if new_perm_obj:
                    created_count += 1
                else:
                    self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{perm_mft.name}'.")
            else:
                if existing_perm.description != perm_mft.description:
                    self._logger.info(
                        f"–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª—è '{perm_mft.name}' –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. "
                        f"–ë–î: '{existing_perm.description}', –ú–∞–Ω–∏—Ñ–µ—Å—Ç: '{perm_mft.description}'. –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è."
                    )
                self._logger.trace(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{perm_mft.name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î.")

        if created_count > 0:
            self._logger.success(
                f"{created_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏–∑ –º–æ–¥—É–ª–µ–π –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã/–æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (flush –±—ã–ª –≤ get_or_create_permission)."
            )

        return created_count

    async def ensure_default_entities_exist(self, session: AsyncSession) -> Tuple[int, int, int]:
        self._logger.info(
            "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π RBAC (—Ä–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —è–¥—Ä–∞, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π)..."
        )

        created_core_perms_count = 0
        created_module_perms_count = 0
        created_roles_count = 0
        initial_session_dirty = bool(session.new or session.dirty or session.deleted)

        self._logger.debug("–≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ø–î–†–ê.")
        core_permissions_to_add_objs: List[Permission] = []
        for perm_name, perm_description in DEFAULT_CORE_PERMISSIONS_DEFINITIONS.items():
            existing_perm = await self._get_permission_by_name(session, perm_name)
            if not existing_perm:
                new_perm = Permission(name=perm_name, description=perm_description)
                core_permissions_to_add_objs.append(new_perm)
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —è–¥—Ä–∞ '{perm_name}' –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")
                created_core_perms_count += 1

        if core_permissions_to_add_objs:
            session.add_all(core_permissions_to_add_objs)
            self._logger.info(f"{created_core_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–µ—Å—Å–∏—é.")

        self._logger.debug("–≠—Ç–∞–ø 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏–∑ –ú–ê–ù–ò–§–ï–°–¢–û–í –ú–û–î–£–õ–ï–ô.")
        module_perms_result = await self.register_permissions_from_modules(session)
        if module_perms_result == -1:
            self._logger.error(
                "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π. –î–∞–ª—å–Ω–µ–π—à–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RBAC –ø—Ä–µ—Ä–≤–∞–Ω–∞."
            )
            return 0, 0, -1
        created_module_perms_count = module_perms_result

        self._logger.debug("–≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –†–û–õ–ï–ô.")
        roles_to_add_objs: List[Role] = []
        for role_name, role_description in DEFAULT_ROLES_DEFINITIONS.items():
            existing_role = await self._get_role_by_name(session, role_name)
            if not existing_role:
                new_role = Role(name=role_name, description=role_description)
                roles_to_add_objs.append(new_role)
                self._logger.info(f"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–æ–ª—å '{role_name}' –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")
                created_roles_count += 1

        if roles_to_add_objs:
            session.add_all(roles_to_add_objs)
            self._logger.info(f"{created_roles_count} —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–µ—Å—Å–∏—é.")

        if core_permissions_to_add_objs or roles_to_add_objs or created_module_perms_count > 0:
            try:
                self._logger.debug("–≠—Ç–∞–ø 4: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—â–∏–π flush –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –Ω–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π...")
                await session.flush()
                self._logger.debug("–û–±—â–∏–π Flush –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
            except Exception as e_flush_all:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—â–µ–º flush —Ä–æ–ª–µ–π/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: {e_flush_all}", exc_info=True)
                await session.rollback()
                return 0, 0, 0

        self._logger.debug(f"–≠—Ç–∞–ø 5: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ø–î–†–ê —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ä–æ–ª—è–º.")
        assigned_perms_summary: Dict[str, int] = {}

        all_permissions_in_db = await self.get_all_permissions(session)
        all_permissions_map_by_name = {p.name: p for p in all_permissions_in_db}

        role_core_permission_map = {
            DEFAULT_ROLE_SUPER_ADMIN: DEFAULT_PERMISSIONS_FOR_CORE_SUPER_ADMIN_ROLE,
            DEFAULT_ROLE_ADMIN: DEFAULT_PERMISSIONS_FOR_CORE_ADMIN_ROLE,
            DEFAULT_ROLE_MODERATOR: DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE,
            DEFAULT_ROLE_USER: DEFAULT_PERMISSIONS_FOR_CORE_USER_ROLE,
        }

        changes_in_role_perms_assignment = False
        for role_name_to_setup, core_perm_names_to_assign in role_core_permission_map.items():
            role_obj = await self._get_role_by_name(session, role_name_to_setup)
            if not role_obj or role_obj.id is None:
                self._logger.error(
                    f"–†–æ–ª—å '{role_name_to_setup}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID –ø–æ—Å–ª–µ flush. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è."
                )
                continue

            current_role_assigned_count = 0
            self._logger.info(f"–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —è–¥–µ—Ä–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ '{role_name_to_setup}' (ID: {role_obj.id})...")
            for perm_name in core_perm_names_to_assign:
                perm_obj_to_assign = all_permissions_map_by_name.get(perm_name)
                if not perm_obj_to_assign or perm_obj_to_assign.id is None:
                    self._logger.warning(
                        f"–Ø–¥–µ—Ä–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{perm_name}' –¥–ª—è —Ä–æ–ª–∏ '{role_name_to_setup}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID. –ü—Ä–æ–ø—É—Å–∫."
                    )
                    continue

                if await self._ensure_role_has_permission_link(session, role_obj.id, perm_obj_to_assign.id):
                    if await self.assign_permission_to_role(
                        session, role_obj, perm_obj_to_assign.name, auto_create_perm=False
                    ):
                        current_role_assigned_count += 1
                        changes_in_role_perms_assignment = True

            if current_role_assigned_count > 0:
                assigned_perms_summary[role_name_to_setup] = current_role_assigned_count
                self._logger.info(
                    f"{current_role_assigned_count} –Ω–æ–≤—ã—Ö —è–¥–µ—Ä–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –±—ã–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã/–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ä–æ–ª–∏ '{role_name_to_setup}'."
                )

        self._logger.debug(f"–≠—Ç–∞–ø 5.1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤ –º–æ–¥—É–ª–µ–π —Ä–æ–ª–∏ '{DEFAULT_ROLE_USER}'.")
        role_user_obj = await self._get_role_by_name(session, DEFAULT_ROLE_USER)
        module_loader = self._services_provider_ref.modules if self._services_provider_ref else None

        auto_assigned_module_perms_count = 0
        if role_user_obj and role_user_obj.id and module_loader:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏ (–∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã)
            active_modules = []
            for module_name in module_loader.enabled_plugin_names:
                module_info = module_loader.available_modules.get(module_name)
                if module_info and not module_info.error:
                    active_modules.append(module_info)
            
            # –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏
            for module_info in module_loader.available_modules.values():
                if module_info.is_system_module and not module_info.error:
                    if module_info not in active_modules:
                        active_modules.append(module_info)
            
            for module_info in active_modules:
                if (
                    module_info.manifest
                    and module_info.manifest.metadata
                    and module_info.manifest.metadata.assign_default_access_to_user_role
                ):

                    base_access_perm_name = f"{module_info.name}.access_user_features"
                    perm_obj = all_permissions_map_by_name.get(base_access_perm_name)
                    if perm_obj and perm_obj.id:
                        if await self._ensure_role_has_permission_link(session, role_user_obj.id, perm_obj.id):
                            if await self.assign_permission_to_role(
                                session, role_user_obj, perm_obj.name, auto_create_perm=False
                            ):
                                self._logger.info(
                                    f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{perm_obj.name}' —Ä–æ–ª–∏ '{DEFAULT_ROLE_USER}'."
                                )
                                auto_assigned_module_perms_count += 1
                                changes_in_role_perms_assignment = True
                    else:
                        self._logger.warning(
                            f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{base_access_perm_name}' –¥–ª—è –º–æ–¥—É–ª—è '{module_info.name}', "
                            "—Ö–æ—Ç—è –æ–Ω –ø–æ–º–µ—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ User. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥—É–ª—å –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–æ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ."
                        )
        if auto_assigned_module_perms_count > 0:
            if DEFAULT_ROLE_USER in assigned_perms_summary:
                assigned_perms_summary[DEFAULT_ROLE_USER] += auto_assigned_module_perms_count
            else:
                assigned_perms_summary[DEFAULT_ROLE_USER] = auto_assigned_module_perms_count

        final_session_dirty = bool(session.new or session.dirty or session.deleted)
        if final_session_dirty or (
            not initial_session_dirty
            and (
                created_roles_count
                or created_core_perms_count
                or created_module_perms_count > 0
                or any(assigned_perms_summary.values())
            )
        ):
            self._logger.debug("–≠—Ç–∞–ø 6: –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–º–º–∏—Ç–∞ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π RBAC...")
            try:
                await session.commit()
                summary_log_parts = []
                if created_roles_count:
                    summary_log_parts.append(f"{created_roles_count} —Ä–æ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ")
                if created_core_perms_count:
                    summary_log_parts.append(f"{created_core_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞ —Å–æ–∑–¥–∞–Ω–æ")
                if created_module_perms_count > 0:
                    summary_log_parts.append(
                        f"{created_module_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ"
                    )
                for role_name_sum, count_sum in assigned_perms_summary.items():
                    if count_sum > 0:
                        summary_log_parts.append(f"{count_sum} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞–∑–Ω–∞—á–µ–Ω–æ {role_name_sum}")

                log_msg_commit = (
                    f"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ RBAC —Å—É—â–Ω–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã: "
                    f"{'; '.join(summary_log_parts) or '–Ω–µ—Ç —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∞–≤.'}."
                )
                self._logger.success(log_msg_commit)
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö RBAC —Å—É—â–Ω–æ—Å—Ç–µ–π: {e}", exc_info=True)
                await session.rollback()
                return 0, 0, 0
        else:
            self._logger.info("–ù–µ –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ RBAC –¥–ª—è –∫–æ–º–º–∏—Ç–∞.")

        return created_roles_count, created_core_perms_count, created_module_perms_count

    async def _ensure_role_has_permission_link(self, session: AsyncSession, role_id: int, permission_id: int) -> bool:
        self._logger.trace(f"[ENSURE_LINK] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ –¥–ª—è RoleID: {role_id}, PermID: {permission_id}")
        link_exists_stmt = (
            select(RolePermission.id)
            .where(RolePermission.role_id == role_id, RolePermission.permission_id == permission_id)
            .limit(1)
        )
        try:
            link_res = await session.execute(link_exists_stmt)
            scalar_result = link_res.scalar_one_or_none()
            if scalar_result is None:
                self._logger.trace(
                    f"[ENSURE_LINK] –°–≤—è–∑—å –¥–ª—è RoleID {role_id}, PermID {permission_id} –ù–ï –Ω–∞–π–¥–µ–Ω–∞ (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)."
                )
                return True
            else:
                self._logger.trace(
                    f"[ENSURE_LINK] –°–≤—è–∑—å –¥–ª—è RoleID {role_id}, PermID {permission_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (ID: {scalar_result})."
                )
                return False
        except Exception as e_exec_link:
            self._logger.error(
                f"[ENSURE_LINK] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–≤—è–∑–∏ RolePermission –¥–ª—è RoleID {role_id}, PermID {permission_id}: {e_exec_link}",
                exc_info=True,
            )
            return False

    async def assign_role_to_user(self, session: AsyncSession, user: User, role_name: str) -> bool:
        if not user or user.id is None:
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (user: {user}).")
            return False

        role_obj = await self.get_or_create_role(session, role_name)
        if not role_obj or role_obj.id is None:
            self._logger.error(
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å '{role_name}' (ID: {getattr(role_obj, 'id', 'N/A')}) –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}."
            )
            return False

        self._logger.debug(
            f"[ASSIGN_ROLE_TO_USER] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ –¥–ª—è UserID: {user.id} (—Ç–∏–ø: {type(user.id)}), RoleID: {role_obj.id} (—Ç–∏–ø: {type(role_obj.id)})"
        )
        existing_link_stmt = (
            select(UserRole.id).where(UserRole.user_id == user.id, UserRole.role_id == role_obj.id).limit(1)
        )
        try:
            existing_link_res = await session.execute(existing_link_stmt)
            scalar_res_link = existing_link_res.scalar_one_or_none()
            self._logger.debug(
                f"[ASSIGN_ROLE_TO_USER] –†–µ–∑—É–ª—å—Ç–∞—Ç scalar_one_or_none –¥–ª—è UserID {user.id}, RoleID {role_obj.id}: {scalar_res_link} (—Ç–∏–ø: {type(scalar_res_link)})"
            )

            if scalar_res_link is not None:
                self._logger.debug(f"–†–æ–ª—å '{role_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {user.id}.")
                return True

            new_user_role_link = UserRole(user_id=user.id, role_id=role_obj.id)
            session.add(new_user_role_link)
            self._logger.info(
                f"–†–æ–ª—å '{role_name}' (RoleID: {role_obj.id}) –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é UserID: {user.id} (–æ–∂–∏–¥–∞–µ—Ç commit)."
            )
            return True
        except Exception as e_assign:
            self._logger.error(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Ä–æ–ª–∏ '{role_name}' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}: {e_assign}", exc_info=True
            )
            return False

    async def remove_role_from_user(self, session: AsyncSession, user: User, role_name: str) -> bool:
        if not user or user.id is None:
            self._logger.error("–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å —Ä–æ–ª—å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID).")
            return False

        role_to_remove = await self._get_role_by_name(session, role_name)
        if not role_to_remove or role_to_remove.id is None:
            self._logger.warning(
                f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å '{role_name}' –∏–ª–∏ —Ä–æ–ª—å –±–µ–∑ ID —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}."
            )
            return True

        try:
            stmt_delete = delete(UserRole).where(UserRole.user_id == user.id, UserRole.role_id == role_to_remove.id)
            result = await session.execute(stmt_delete)

            if result.rowcount > 0:
                self._logger.info(f"–†–æ–ª—å '{role_name}' —Å–Ω—è—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
                return True
            else:
                self._logger.debug(f"–†–æ–ª—å '{role_name}' –Ω–µ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
                return True
        except Exception as e:
            self._logger.error(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ UserRole –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} –∏ —Ä–æ–ª–∏ '{role_name}': {e}",
                exc_info=True,
            )
            return False

    def user_has_role(self, user: User, role_name: str) -> bool:
        if not user or not user.roles:
            return False
        return any(r.name.lower() == role_name.lower() for r in user.roles if r and r.name)

    async def user_has_role_async(self, session: AsyncSession, user_telegram_id: int, role_name: str) -> bool:
        stmt = select(User).options(selectinload(User.roles)).where(User.telegram_id == user_telegram_id)
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()

        if not user_db:
            self._logger.debug(
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–∏ '{role_name}'."
            )
            return False
        return self.user_has_role(user_db, role_name)

    def get_user_role_names(self, user: User) -> Set[str]:
        if not user or not user.roles:
            return set()
        return {role.name for role in user.roles if role and role.name}

    async def get_user_roles_async(self, session: AsyncSession, user_telegram_id: int) -> List[Role]:
        stmt = select(User).options(selectinload(User.roles)).where(User.telegram_id == user_telegram_id)
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()

        if not user_db:
            self._logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –µ–≥–æ —Ä–æ–ª–µ–π.")
            return []
        return list(user_db.roles) if user_db.roles else []

    async def get_all_roles(self, session: AsyncSession) -> List[Role]:
        stmt = select(Role).options(selectinload(Role.permissions)).order_by(Role.name)
        result = await session.execute(stmt)
        roles = list(result.scalars().all())
        self._logger.debug(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ: {len(roles)}.")
        return roles

    async def delete_role(self, session: AsyncSession, role_name_or_id: Union[str, int]) -> bool:
        self._logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏: '{role_name_or_id}'...")
        role: Optional[Role] = None
        if isinstance(role_name_or_id, str):
            role = await self._get_role_by_name(session, role_name_or_id)
        elif isinstance(role_name_or_id, int):
            role = await session.get(Role, role_name_or_id)

        if not role:
            self._logger.warning(f"–†–æ–ª—å '{role_name_or_id}' –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return False

        if role.name in DEFAULT_ROLES_DEFINITIONS:
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ '{role.name}'. –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞.")
            return False

        user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role.id)
        user_role_count_res = await session.execute(user_role_count_stmt)
        user_count_with_role = user_role_count_res.scalar_one()

        if user_count_with_role > 0:
            self._logger.error(
                f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å '{role.name}' (ID: {role.id}), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ {user_count_with_role} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—è–º). "
                "–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —ç—Ç—É —Ä–æ–ª—å —Å–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
            )
            return False

        try:
            await session.execute(delete(RolePermission).where(RolePermission.role_id == role.id))
            await session.delete(role)
            self._logger.warning(
                f"–†–æ–ª—å '{role.name}' (ID: {role.id}) –∏ –µ–µ —Å–≤—è–∑–∏ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–º–µ—á–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç commit)."
            )
            return True
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏ '{role.name}': {e}", exc_info=True)
            return False

    async def _get_permission_by_name(self, session: AsyncSession, permission_name: str) -> Optional[Permission]:
        self._logger.trace(f"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏: '{permission_name}'")
        stmt = select(Permission).where(Permission.name == permission_name)
        result = await session.execute(stmt)
        perm = result.scalars().first()
        self._logger.trace(
            f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–∞–π–¥–µ–Ω–æ: {perm is not None} (ID: {getattr(perm, 'id', 'N/A')})"
        )
        return perm

    async def get_or_create_permission(
        self, session: AsyncSession, permission_name: str, description: Optional[str] = None
    ) -> Optional[Permission]:
        permission = await self._get_permission_by_name(session, permission_name)
        if not permission:
            perm_def_desc = DEFAULT_CORE_PERMISSIONS_DEFINITIONS.get(permission_name)
            current_description = description if description is not None else perm_def_desc

            if current_description is not None:
                self._logger.info(
                    f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º: '{current_description}'."
                )
                permission = Permission(name=permission_name, description=current_description)
                session.add(permission)
                try:
                    await session.flush([permission])
                    self._logger.success(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–æ–∑–¥–∞–Ω–æ (—Åflushed) —Å ID: {permission.id}")
                except Exception as e_flush_perm:
                    self._logger.error(
                        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ flush –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}': {e_flush_perm}", exc_info=True
                    )
                    return None
            else:
                self._logger.warning(
                    f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ. –ù–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
                )
                return None
        return permission

    async def assign_permission_to_role(
        self,
        session: AsyncSession,
        role: Role,
        permission_name: str,
        auto_create_perm: bool = True,
    ) -> bool:
        if not role or role.id is None:
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: –†–æ–ª—å –Ω–µ –≤–∞–ª–∏–¥–Ω–∞ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (role: {role}).")
            return False

        permission_obj: Optional[Permission] = None
        if auto_create_perm:
            permission_obj = await self.get_or_create_permission(session, permission_name, description=None)
        else:
            permission_obj = await self._get_permission_by_name(session, permission_name)

        if not permission_obj or permission_obj.id is None:
            log_msg = (
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å"
                + (" –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å" if auto_create_perm else "")
                + f" —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' (ID: {getattr(permission_obj, 'id', 'N/A')}) –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ '{role.name}'."
            )
            self._logger.error(log_msg)
            return False

        self._logger.debug(
            f"[ASSIGN_PERM_TO_ROLE] –ü—Ä–æ–≤–µ—Ä–∫–∞/–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤—è–∑–∏ –¥–ª—è RoleID: {role.id}, PermID: {permission_obj.id}"
        )

        if await self._ensure_role_has_permission_link(session, role.id, permission_obj.id):
            try:
                new_role_perm_link = RolePermission(role_id=role.id, permission_id=permission_obj.id)
                session.add(new_role_perm_link)
                self._logger.info(
                    f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' (PermID: {permission_obj.id}) –¥–æ–±–∞–≤–ª–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}' (RoleID: {role.id}) (–æ–∂–∏–¥–∞–µ—Ç commit)."
                )
                return True
            except Exception as e_add_link:
                self._logger.error(
                    f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ RolePermission –¥–ª—è RoleID {role.id}, PermID {permission_obj.id}: {e_add_link}",
                    exc_info=True,
                )
                return False
        else:
            link_exists_stmt = (
                select(RolePermission.id)
                .where(RolePermission.role_id == role.id, RolePermission.permission_id == permission_obj.id)
                .limit(1)
            )
            existing_link_res = await session.execute(link_exists_stmt)
            if existing_link_res.scalar_one_or_none() is not None:
                self._logger.trace(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}' (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ).")
                return True
            else:
                self._logger.error(
                    f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' –∏ —Ä–æ–ª–∏ '{role.name}'. "
                    "–í–æ–∑–º–æ–∂–Ω–æ, –æ—à–∏–±–∫–∞ –≤ _ensure_role_has_permission_link –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ."
                )
                return False

    async def remove_permission_from_role(self, session: AsyncSession, role: Role, permission_name: str) -> bool:
        if not role or role.id is None:
            return False
        permission_to_remove = await self._get_permission_by_name(session, permission_name)
        if not permission_to_remove or permission_to_remove.id is None:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å —Ä–æ–ª–∏ '{role.name}'.")
            return True

        try:
            stmt_delete = delete(RolePermission).where(
                RolePermission.role_id == role.id, RolePermission.permission_id == permission_to_remove.id
            )
            result = await session.execute(stmt_delete)
            if result.rowcount > 0:
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å —Ä–æ–ª–∏ '{role.name}' (–æ–∂–∏–¥–∞–µ—Ç commit).")
                return True
            else:
                self._logger.debug(
                    f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}'. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
                )
                return True
        except Exception as e_remove_perm:
            self._logger.error(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' —Å —Ä–æ–ª–∏ '{role.name}': {e_remove_perm}", exc_info=True
            )
            return False

    async def user_has_permission(self, session: AsyncSession, user_telegram_id: int, permission_name: str) -> bool:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –í–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ .env (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        if self._services_provider_ref and self._services_provider_ref.config:
            if user_telegram_id in self._services_provider_ref.config.core.super_admins:
                self._logger.trace(
                    f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} —è–≤–ª—è–µ—Ç—Å—è –í–ª–∞–¥–µ–ª—å—Ü–µ–º –∏–∑ .env, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ."
                )
                return True

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ —Ä–æ–ª—è–º–∏ –∏ –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
        stmt = (
            select(User)
            .options(
                selectinload(User.roles).selectinload(Role.permissions),  # –†–æ–ª–∏ –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                selectinload(User.direct_permissions),  # –ü—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            )
            .where(User.telegram_id == user_telegram_id)
        )
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()

        if not user_db:
            self._logger.trace(
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}'."
            )
            return False
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–æ–ª—å SuperAdmin (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
        if user_db.roles:
            for role_obj in user_db.roles:
                if role_obj.name == DEFAULT_ROLE_SUPER_ADMIN:
                    self._logger.trace(
                        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –∏–º–µ–µ—Ç —Ä–æ–ª—å 'SuperAdmin', —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)."
                    )
                    return True

        perm_name_lower = permission_name.lower()

        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_db.direct_permissions:
            for perm_obj in user_db.direct_permissions:
                if perm_obj.name.lower() == perm_name_lower:
                    self._logger.trace(
                        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}'."
                    )
                    return True

        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–æ–ª–∏
        if not user_db.roles:
            self._logger.trace(
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–ª–µ–π –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}'."
            )
            # (–ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –ø—Ä–∞–≤ –∏ –Ω–µ—Ç —Ä–æ–ª–µ–π, —Ç–æ –ø—Ä–∞–≤–∞ –Ω–µ—Ç)
            # return False # –≠—Ç–æ —É—Å–ª–æ–≤–∏–µ —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º return False
        else:  # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–ª–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö
            for role_obj in user_db.roles:
                if role_obj.permissions:
                    for perm_obj in role_obj.permissions:
                        if perm_obj.name.lower() == perm_name_lower:
                            self._logger.trace(
                                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —á–µ—Ä–µ–∑ —Ä–æ–ª—å '{role_obj.name}'."
                            )
                            return True

        self._logger.trace(
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –ù–ï –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' (–Ω–∏ –ø—Ä—è–º–æ–≥–æ, –Ω–∏ —á–µ—Ä–µ–∑ —Ä–æ–ª–∏)."
        )
        return False

    async def get_all_permissions(self, session: AsyncSession) -> List[Permission]:
        stmt = select(Permission).order_by(Permission.name)
        result = await session.execute(stmt)
        permissions = list(result.scalars().all())
        self._logger.debug(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π. –ù–∞–π–¥–µ–Ω–æ: {len(permissions)}.")
        return permissions

    async def get_role_permissions(self, session: AsyncSession, role_name: str) -> List[Permission]:
        stmt = select(Role).options(selectinload(Role.permissions)).where(Role.name == role_name)
        result = await session.execute(stmt)
        role_with_perms: Optional[Role] = result.scalars().first()

        if not role_with_perms:
            self._logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–æ–ª–∏ '{role_name}'.")
            return []

        return list(role_with_perms.permissions) if role_with_perms.permissions else []

    # --- –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---

    async def assign_direct_permission_to_user(
        self,
        session: AsyncSession,
        user: User,
        permission_name: str,
        auto_create_perm: bool = True,  # –û–±—ã—á–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    ) -> bool:
        if not user or user.id is None:
            self._logger.error(
                f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (user: {user})."
            )
            return False

        permission_obj: Optional[Permission]
        if auto_create_perm:  # –≠—Ç–æ –±–æ–ª—å—à–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
            permission_obj = await self.get_or_create_permission(session, permission_name)
        else:
            permission_obj = await self._get_permission_by_name(session, permission_name)

        if not permission_obj or permission_obj.id is None:
            log_msg = (
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å"
                + (" –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å" if auto_create_perm else "")
                + f" —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –¥–ª—è –ø—Ä—è–º–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}."
            )
            self._logger.error(log_msg)
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Å–≤—è–∑–∏
        existing_link_stmt = (
            select(UserPermission.id)
            .where(UserPermission.user_id == user.id, UserPermission.permission_id == permission_obj.id)
            .limit(1)
        )
        existing_link_res = await session.execute(existing_link_stmt)
        if existing_link_res.scalar_one_or_none() is not None:
            self._logger.debug(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}.")
            return True  # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å

        # –ï—Å–ª–∏ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ user.direct_permissions.append()
        # user.direct_permissions.append(permission_obj)
        # session.add(user)
        # –ò–õ–ò, –µ—Å–ª–∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ–π –Ω–∞–ø—Ä—è–º—É—é:
        new_user_perm_link = UserPermission(user_id=user.id, permission_id=permission_obj.id)
        session.add(new_user_perm_link)

        self._logger.info(
            f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit)."
        )
        return True

    async def remove_direct_permission_from_user(self, session: AsyncSession, user: User, permission_name: str) -> bool:
        if not user or user.id is None:
            self._logger.error("–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return False

        permission_to_remove = await self._get_permission_by_name(session, permission_name)
        if not permission_to_remove or permission_to_remove.id is None:
            self._logger.warning(
                f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id}."
            )
            return True  # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –∏ –Ω–µ –±—ã–ª–æ

        # –ï—Å–ª–∏ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ user.direct_permissions.remove()
        # if permission_to_remove in user.direct_permissions: # –ù—É–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ user.direct_permissions
        #     user.direct_permissions.remove(permission_to_remove)
        #     session.add(user)
        #     self._logger.info(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
        #     return True
        # else:
        #     self._logger.debug(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
        #     return True
        # –ò–õ–ò, –µ—Å–ª–∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ–π –Ω–∞–ø—Ä—è–º—É—é:
        stmt_delete = delete(UserPermission).where(
            UserPermission.user_id == user.id, UserPermission.permission_id == permission_to_remove.id
        )
        result = await session.execute(stmt_delete)
        if result.rowcount > 0:
            self._logger.info(
                f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit)."
            )
            return True
        else:
            self._logger.debug(
                f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            )
            return True

    async def get_user_direct_permissions(self, session: AsyncSession, user_id: int) -> List[Permission]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ –µ–≥–æ DB ID)."""
        user_db = await session.get(User, user_id, options=[selectinload(User.direct_permissions)])
        if not user_db:
            self._logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω—ã –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (DB ID: {user_id}).")
            return []
        return list(user_db.direct_permissions) if user_db.direct_permissions else []



======================================================================

------------------------------ FILE: Systems/core/rbac/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/http_client/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/http_client/retry.py ------------------------------
# core/http_client/retry.py
"""
Retry –º–µ—Ö–∞–Ω–∏–∑–º –∏ Circuit Breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
"""

import asyncio
import time
from enum import Enum
from typing import Optional, Callable, Any, Dict
from datetime import datetime, timedelta
from loguru import logger

import aiohttp
from aiohttp import ClientError, ClientResponseError


class CircuitState(Enum):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è Circuit Breaker"""
    CLOSED = "closed"      # –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
    OPEN = "open"          # –¶–µ–ø—å —Ä–∞–∑–æ–º–∫–Ω—É—Ç–∞, –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
    HALF_OPEN = "half_open"  # –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º


class CircuitBreaker:
    """
    Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
    """
    
    def __init__(
        self,
        failure_threshold: int = 5,
        recovery_timeout: int = 60,
        expected_exception: type = Exception
    ):
        """
        Args:
            failure_threshold: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ü–µ–ø–∏
            recovery_timeout: –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –¥–æ –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            expected_exception: –¢–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π
        """
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.expected_exception = expected_exception
        
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.last_failure_time: Optional[datetime] = None
        self.success_count = 0
        self._logger = logger.bind(service="CircuitBreaker")
    
    def call(self, func: Callable, *args, **kwargs) -> Any:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ circuit breaker"""
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
                self._logger.info("Circuit breaker –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ HALF_OPEN —Å–æ—Å—Ç–æ—è–Ω–∏–µ")
            else:
                raise Exception(f"Circuit breaker OPEN. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ {self.recovery_timeout} —Å–µ–∫—É–Ω–¥")
        
        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        except self.expected_exception as e:
            self._on_failure()
            raise
    
    async def call_async(self, func: Callable, *args, **kwargs) -> Any:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è call"""
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
                self._logger.info("Circuit breaker –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ HALF_OPEN —Å–æ—Å—Ç–æ—è–Ω–∏–µ")
            else:
                raise Exception(f"Circuit breaker OPEN. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ {self.recovery_timeout} —Å–µ–∫—É–Ω–¥")
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except self.expected_exception as e:
            self._on_failure()
            raise
    
    def _on_success(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        self.failure_count = 0
        if self.state == CircuitState.HALF_OPEN:
            self.success_count += 1
            if self.success_count >= 2:  # –ù—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                self.state = CircuitState.CLOSED
                self.success_count = 0
                self._logger.info("Circuit breaker –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (CLOSED)")
    
    def _on_failure(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏"""
        self.failure_count += 1
        self.last_failure_time = datetime.now()
        
        if self.state == CircuitState.HALF_OPEN:
            self.state = CircuitState.OPEN
            self._logger.warning("Circuit breaker —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è")
        elif self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN
            self._logger.error(
                f"Circuit breaker –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ {self.failure_count} –æ—à–∏–±–æ–∫. "
                f"–ë—É–¥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ {self.recovery_timeout} —Å–µ–∫—É–Ω–¥"
            )
    
    def _should_attempt_reset(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"""
        if not self.last_failure_time:
            return True
        return (datetime.now() - self.last_failure_time).total_seconds() >= self.recovery_timeout
    
    def reset(self):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å circuit breaker"""
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.success_count = 0
        self.last_failure_time = None
        self._logger.info("Circuit breaker –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–æ—à–µ–Ω")


class RetryConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è retry –º–µ—Ö–∞–Ω–∏–∑–º–∞"""
    
    def __init__(
        self,
        max_attempts: int = 3,
        initial_delay: float = 1.0,
        max_delay: float = 60.0,
        exponential_base: float = 2.0,
        jitter: bool = True,
        retry_on: tuple = (ClientError, ClientResponseError)
    ):
        self.max_attempts = max_attempts
        self.initial_delay = initial_delay
        self.max_delay = max_delay
        self.exponential_base = exponential_base
        self.jitter = jitter
        self.retry_on = retry_on


async def retry_with_backoff(
    func: Callable,
    *args,
    config: Optional[RetryConfig] = None,
    circuit_breaker: Optional[CircuitBreaker] = None,
    **kwargs
) -> Any:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    
    Args:
        func: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è retry
        circuit_breaker: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π circuit breaker
        *args, **kwargs: –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
    """
    if config is None:
        config = RetryConfig()
    
    last_exception = None
    
    for attempt in range(config.max_attempts):
        try:
            if circuit_breaker:
                result = await circuit_breaker.call_async(func, *args, **kwargs)
            else:
                result = await func(*args, **kwargs)
            return result
        
        except config.retry_on as e:
            last_exception = e
            
            if attempt == config.max_attempts - 1:
                # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                logger.error(f"–í—Å–µ {config.max_attempts} –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {e}")
                raise
            
            # –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
            delay = min(
                config.initial_delay * (config.exponential_base ** attempt),
                config.max_delay
            )
            
            if config.jitter:
                import random
                delay = delay * (0.5 + random.random() * 0.5)
            
            logger.warning(
                f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{config.max_attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}. "
                f"–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay:.2f} —Å–µ–∫—É–Ω–¥"
            )
            
            await asyncio.sleep(delay)
        
        except Exception as e:
            # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ retry: {e}")
            raise
    
    # –ù–µ –¥–æ–ª–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å —Å—é–¥–∞, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    if last_exception:
        raise last_exception
    raise Exception("Retry –º–µ—Ö–∞–Ω–∏–∑–º –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ")




======================================================================

------------------------------ FILE: Systems/core/http_client/manager.py ------------------------------
# core/http_client/manager.py

import asyncio
from typing import Optional, Dict, Any, Union, TYPE_CHECKING

try:
    import aiohttp
    from aiohttp import ClientSession, ClientTimeout, ClientResponse, ClientResponseError, ClientError
    from aiohttp import ServerTimeoutError as AiohttpTimeoutError
except ImportError:
    aiohttp = None # type: ignore
    ClientSession = Any # type: ignore
    ClientTimeout = Any # type: ignore
    ClientResponse = Any # type: ignore
    ClientResponseError = Any # type: ignore
    ClientError = Any # type: ignore
    AiohttpTimeoutError = Any # type: ignore

from loguru import logger

if TYPE_CHECKING:
    from Systems.core.app_settings import AppSettings


class HTTPClientManager:
    def __init__(self, default_timeout_seconds: int = 10, app_settings: Optional['AppSettings'] = None):
        if not aiohttp:
            msg = ("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ aiohttp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ (`pip install aiohttp`). "
                   "HTTPClientManager –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
            logger.critical(msg)
            raise ImportError(msg)
            
        self._session: Optional[ClientSession] = None
        self._default_timeout_config = ClientTimeout(total=default_timeout_seconds) 
        self._app_settings: Optional['AppSettings'] = app_settings 
        self._is_initialized_successfully = False
        logger.info(f"HTTPClientManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (—Ç–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {default_timeout_seconds} —Å–µ–∫).")

    async def initialize(self) -> None:
        if self._session is None or self._session.closed:
            try:
                self._session = ClientSession(timeout=self._default_timeout_config)
                self._is_initialized_successfully = True
                logger.success("aiohttp.ClientSession —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ aiohttp.ClientSession: {e}", exc_info=True)
                self._session = None
                self._is_initialized_successfully = False
                raise 
        else:
            logger.debug("aiohttp.ClientSession —É–∂–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def dispose(self) -> None:
        if self._session and not self._session.closed:
            try:
                await self._session.close()
                logger.info("aiohttp.ClientSession —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ aiohttp.ClientSession: {e}", exc_info=True)
        self._session = None
        self._is_initialized_successfully = False

    def is_available(self) -> bool:
        return self._session is not None and not self._session.closed and self._is_initialized_successfully

    def _get_session(self) -> ClientSession:
        if not self.is_available():
            msg = "HTTPClientManager (aiohttp.ClientSession) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç! –í—ã–∑–æ–≤–∏—Ç–µ initialize()."
            logger.critical(msg)
            raise RuntimeError(msg)
        return self._session # type: ignore 

    async def request(
        self,
        method: str,
        url: str,
        params: Optional[Dict[str, Any]] = None,
        data: Optional[Any] = None,
        json_data: Optional[Any] = None,
        headers: Optional[Dict[str, str]] = None,
        timeout_seconds: Optional[int] = None,
        raise_for_status: bool = False 
    ) -> Optional[ClientResponse]:
        session = self._get_session()
        current_timeout_config = ClientTimeout(total=timeout_seconds) if timeout_seconds is not None else self._default_timeout_config
        
        request_kwargs = {
            "params": params, "data": data, "json": json_data,
            "headers": headers, "timeout": current_timeout_config,
        }
        active_request_kwargs = {k: v for k, v in request_kwargs.items() if v is not None}

        log_context = {"method": method.upper(), "url": url, "params": params, "json_body": json_data is not None}
        logger.debug(f"HTTP Request: {method.upper()} {url}", **log_context)
        
        try:
            async with session.request(method, url, **active_request_kwargs) as response:
                logger.debug(f"HTTP Response: Status {response.status} for {url}", 
                             **log_context, status_code=response.status)
                if raise_for_status:
                    response.raise_for_status() 
                return response
        except ClientResponseError as e: 
            logger.warning(f"HTTP ClientResponseError: {e.status} {e.message} for {url}", **log_context)
            raise 
        except (asyncio.TimeoutError, AiohttpTimeoutError) as e:
            logger.warning(f"HTTP TimeoutError for {url} (timeout: {current_timeout_config.total}s): {type(e).__name__}", **log_context)
            raise 
        except ClientError as e: 
            logger.error(f"HTTP ClientError for {url}: {e}", **log_context, exc_info=True)
            raise 
        except Exception as e: 
            logger.error(f"Unexpected HTTP Error during request to {url}: {e}", **log_context, exc_info=True)
            raise


    async def get_json(
        self, url: str, params: Optional[Dict[str, Any]] = None, 
        headers: Optional[Dict[str, str]] = None, timeout_seconds: Optional[int] = None,
        default_on_error: Optional[Any] = None 
    ) -> Optional[Any]:
        response: Optional[ClientResponse] = None
        try:
            response = await self.request("GET", url, params=params, headers=headers, 
                                          timeout_seconds=timeout_seconds, raise_for_status=True)
            if response: 
                return await response.json()
            return default_on_error 
        except (ClientResponseError, asyncio.TimeoutError, AiohttpTimeoutError, ClientError) as e:
            logger.warning(f"HTTP(S) error during get_json for {url}: {type(e).__name__} - {e}")
            if default_on_error is not None: return default_on_error
            raise
        except aiohttp.ContentTypeError as e_json: 
            logger.warning(f"Failed to decode JSON response from {url}: {e_json}")
            if response: logger.trace(f"Response text (JSON error): {(await response.text())[:200]}")
            if default_on_error is not None: return default_on_error
            raise
        except Exception as e_unexp: 
            logger.error(f"Unexpected error in get_json for {url}: {e_unexp}", exc_info=True)
            if default_on_error is not None: return default_on_error
            raise


    async def post_json_response(
        self, url: str, json_data: Optional[Any] = None, params: Optional[Dict[str, Any]] = None,
        headers: Optional[Dict[str, str]] = None, timeout_seconds: Optional[int] = None,
        default_on_error: Optional[Any] = None 
    ) -> Optional[Any]:
        response: Optional[ClientResponse] = None
        try:
            response = await self.request("POST", url, params=params, json_data=json_data, headers=headers,
                                          timeout_seconds=timeout_seconds, raise_for_status=True)
            if response:
                return await response.json()
            return default_on_error
        except (ClientResponseError, asyncio.TimeoutError, AiohttpTimeoutError, ClientError) as e:
            logger.warning(f"HTTP(S) error during post_json for {url}: {type(e).__name__} - {e}")
            if default_on_error is not None: return default_on_error
            raise
        except aiohttp.ContentTypeError as e_json:
            logger.warning(f"Failed to decode JSON response from {url} after POST: {e_json}")
            if response: logger.trace(f"Response text (JSON error): {(await response.text())[:200]}")
            if default_on_error is not None: return default_on_error
            raise
        except Exception as e_unexp:
            logger.error(f"Unexpected error in post_json for {url}: {e_unexp}", exc_info=True)
            if default_on_error is not None: return default_on_error
            raise


======================================================================

------------------------------ FILE: Systems/core/cache/strategies.py ------------------------------
# core/cache/strategies.py
"""
–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
"""

import asyncio
from typing import Optional, Callable, Any, Dict, List
from datetime import datetime, timedelta
from loguru import logger

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider


class CacheStrategy:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self, ttl: int = 300):
        self.ttl = ttl
        self._logger = logger.bind(service="CacheStrategy")
    
    def get_key(self, prefix: str, *args, **kwargs) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –∫—ç—à–∞"""
        parts = [prefix]
        if args:
            parts.extend(str(arg) for arg in args)
        if kwargs:
            parts.extend(f"{k}={v}" for k, v in sorted(kwargs.items()))
        return ":".join(parts)
    
    async def get_or_set(
        self,
        cache_manager,
        key: str,
        func: Callable,
        *args,
        ttl: Optional[int] = None,
        **kwargs
    ) -> Any:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å"""
        raise NotImplementedError


class DefaultCacheStrategy(CacheStrategy):
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    async def get_or_set(
        self,
        cache_manager,
        key: str,
        func: Callable,
        *args,
        ttl: Optional[int] = None,
        **kwargs
    ) -> Any:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é"""
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
        cached_value = await cache_manager.get(key)
        if cached_value is not None:
            self._logger.debug(f"Cache hit: {key}")
            return cached_value
        
        # –ö—ç—à –ø—Ä–æ–º–∞—Ö, –≤—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        self._logger.debug(f"Cache miss: {key}")
        if asyncio.iscoroutinefunction(func):
            value = await func(*args, **kwargs)
        else:
            value = func(*args, **kwargs)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        await cache_manager.set(key, value, ttl=ttl or self.ttl)
        return value


class WriteThroughCacheStrategy(CacheStrategy):
    """–°—Ç—Ä–∞—Ç–µ–≥–∏—è Write-Through: –∑–∞–ø–∏—Å—å –≤ –∫—ç—à –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
    
    async def get_or_set(
        self,
        cache_manager,
        key: str,
        func: Callable,
        *args,
        ttl: Optional[int] = None,
        **kwargs
    ) -> Any:
        """Write-through –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        if asyncio.iscoroutinefunction(func):
            value = await func(*args, **kwargs)
        else:
            value = func(*args, **kwargs)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        await cache_manager.set(key, value, ttl=ttl or self.ttl)
        return value


class CacheInvalidator:
    """–ö–ª–∞—Å—Å –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞"""
    
    def __init__(self, cache_manager):
        self.cache_manager = cache_manager
        self._logger = logger.bind(service="CacheInvalidator")
        # –†–µ–≥–∏—Å—Ç—Ä –∫–ª—é—á–µ–π –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
        self._patterns: Dict[str, List[str]] = {}
    
    async def invalidate(self, key: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"""
        await self.cache_manager.delete(key)
        self._logger.debug(f"Cache invalidated: {key}")
    
    async def invalidate_pattern(self, pattern: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É"""
        # –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è Redis SCAN
        if hasattr(self.cache_manager, 'delete_pattern'):
            await self.cache_manager.delete_pattern(pattern)
        else:
            self._logger.warning(f"Pattern invalidation not supported for {type(self.cache_manager)}")
    
    async def invalidate_by_prefix(self, prefix: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º"""
        await self.invalidate_pattern(f"{prefix}*")
    
    def register_pattern(self, name: str, pattern: str):
        """–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        if name not in self._patterns:
            self._patterns[name] = []
        self._patterns[name].append(pattern)
    
    async def invalidate_by_registered_pattern(self, name: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É"""
        if name in self._patterns:
            for pattern in self._patterns[name]:
                await self.invalidate_pattern(pattern)


class CacheTagManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏ –∫—ç—à–∞ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    
    def __init__(self, cache_manager):
        self.cache_manager = cache_manager
        self._logger = logger.bind(service="CacheTagManager")
        # –ú–∞–ø–ø–∏–Ω–≥ —Ç–µ–≥–æ–≤ –Ω–∞ –∫–ª—é—á–∏: {tag: [key1, key2, ...]}
        self._tag_to_keys: Dict[str, List[str]] = {}
        # –ú–∞–ø–ø–∏–Ω–≥ –∫–ª—é—á–µ–π –Ω–∞ —Ç–µ–≥–∏: {key: [tag1, tag2, ...]}
        self._key_to_tags: Dict[str, List[str]] = {}
    
    async def tag_key(self, key: str, *tags: str):
        """–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ –∫ –∫–ª—é—á—É"""
        if key not in self._key_to_tags:
            self._key_to_tags[key] = []
        
        for tag in tags:
            if tag not in self._tag_to_keys:
                self._tag_to_keys[tag] = []
            if key not in self._tag_to_keys[tag]:
                self._tag_to_keys[tag].append(key)
            if tag not in self._key_to_tags[key]:
                self._key_to_tags[key].append(tag)
    
    async def invalidate_by_tag(self, tag: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏ —Å —Ç–µ–≥–æ–º"""
        if tag in self._tag_to_keys:
            for key in self._tag_to_keys[tag]:
                await self.cache_manager.delete(key)
                # –£–¥–∞–ª—è–µ–º —Ç–µ–≥ –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
                if key in self._key_to_tags:
                    self._key_to_tags[key].remove(tag)
            del self._tag_to_keys[tag]
            self._logger.info(f"Invalidated {len(self._tag_to_keys[tag])} keys by tag: {tag}")
    
    async def invalidate_by_tags(self, *tags: str):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ç–µ–≥–∞–º"""
        for tag in tags:
            await self.invalidate_by_tag(tag)




======================================================================

------------------------------ FILE: Systems/core/cache/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/cache/manager.py ------------------------------
# core/cache/manager.py

import asyncio
import json
import time
from typing import Optional, Any, Union, TYPE_CHECKING
from abc import ABC, abstractmethod

# –£—Å–ª–æ–≤–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è Redis —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
# –£—Å–ª–æ–≤–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è Redis —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
try:
    import redis.asyncio as redis_async
    REDIS_PY_AVAILABLE = True
except ImportError:
    redis_async = None # type: ignore
    REDIS_PY_AVAILABLE = False

if TYPE_CHECKING:
    from redis.asyncio.client import Redis as AsyncRedisClient
    from redis.exceptions import RedisError, ConnectionError as RedisConnectionError, TimeoutError as RedisTimeoutError
else:
    if REDIS_PY_AVAILABLE:
        from redis.asyncio.client import Redis as AsyncRedisClient
        from redis.exceptions import RedisError, ConnectionError as RedisConnectionError, TimeoutError as RedisTimeoutError
    else:
        AsyncRedisClient = Any # type: ignore
        RedisError = Exception # type: ignore
        RedisConnectionError = Exception # type: ignore
        RedisTimeoutError = asyncio.TimeoutError # –§–æ–ª–ª–±—ç–∫ –Ω–∞ asyncio.TimeoutError

# –£—Å–ª–æ–≤–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è cachetools
try:
    from cachetools import TTLCache
    CACHETOOLS_AVAILABLE = True
except ImportError:
    TTLCache = dict # type: ignore
    CACHETOOLS_AVAILABLE = False

from loguru import logger

if TYPE_CHECKING:
    from Systems.core.app_settings import CacheSettings

class BaseCache(ABC):
    @abstractmethod
    async def initialize(self) -> None: pass
    @abstractmethod
    async def dispose(self) -> None: pass
    @abstractmethod
    async def get(self, key: str) -> Optional[Any]: raise NotImplementedError
    @abstractmethod
    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None: raise NotImplementedError
    @abstractmethod
    async def delete(self, key: str) -> bool: raise NotImplementedError
    @abstractmethod
    async def exists(self, key: str) -> bool: raise NotImplementedError
    @abstractmethod
    async def clear(self) -> None: raise NotImplementedError

class MemoryCache(BaseCache):
    def __init__(self, maxsize: int = 1024, default_ttl: int = 300):
        self._default_ttl = default_ttl
        if CACHETOOLS_AVAILABLE and TTLCache:
            self._cache: Union[Any, dict] = TTLCache(maxsize=maxsize, ttl=default_ttl)  # type: ignore
            self._uses_cachetools = True
        else:
            logger.warning("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'cachetools' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è —Ä—É—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è MemoryCache —Å TTL.")
            self._cache = {} 
            self._maxsize = maxsize
            self._uses_cachetools = False
        logger.info(f"MemoryCache –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç cachetools: {self._uses_cachetools}, default TTL: {default_ttl}s).")

    async def initialize(self) -> None: logger.debug("MemoryCache.initialize() - –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
    async def dispose(self) -> None: await self.clear(); logger.debug("MemoryCache.dispose() - –∫—ç—à –æ—á–∏—â–µ–Ω.")

    async def get(self, key: str) -> Optional[Any]:
        if self._uses_cachetools and isinstance(self._cache, TTLCache):
            try: return self._cache[key]
            except KeyError: return None
        elif isinstance(self._cache, dict):
            item = self._cache.get(key)
            if item:
                value, expiry_timestamp = item
                if time.time() < expiry_timestamp: return value
                else: 
                    # –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–ª—é—á
                    await self.delete(key) 
            return None
        return None

    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        effective_ttl = ttl_seconds if ttl_seconds is not None else self._default_ttl
        if self._uses_cachetools and isinstance(self._cache, TTLCache):
            if ttl_seconds is not None and ttl_seconds != self._cache.ttl: # type: ignore
                 # TTLCache –∏–º–µ–µ—Ç –æ–±—â–∏–π TTL, –Ω–æ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ.
                 # –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π TTL.
                 logger.trace(f"MemoryCache (TTLCache) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–π TTL ({self._cache.ttl} —Å–µ–∫) –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π.") # type: ignore
            self._cache[key] = value
        elif isinstance(self._cache, dict):
            if len(self._cache) >= self._maxsize and key not in self._cache:
                # –ü—Ä–æ—Å—Ç–∞—è LRU-–ø–æ–¥–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞: —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π (–ø–µ—Ä–≤—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π)
                # –≠—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π LRU, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–π–¥–µ—Ç.
                try:
                    oldest_key = next(iter(self._cache))
                    del self._cache[oldest_key]
                    logger.trace(f"MemoryCache –¥–æ—Å—Ç–∏–≥ maxsize, —É–¥–∞–ª–µ–Ω –∫–ª—é—á (FIFO-like): {oldest_key}")
                except StopIteration: pass # –ü—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
            self._cache[key] = (value, time.time() + effective_ttl)

    async def delete(self, key: str) -> bool:
        if key in self._cache: 
            del self._cache[key]
            return True
        return False

    async def exists(self, key: str) -> bool: 
        # –î–ª—è TTLCache –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç TTL
        # –î–ª—è —Ä—É—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ get() —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TTL
        return await self.get(key) is not None

    async def clear(self) -> None: 
        self._cache.clear()
        logger.info("MemoryCache –æ—á–∏—â–µ–Ω.")


class RedisCache(BaseCache):
    def __init__(self, redis_url: str):
        if not REDIS_PY_AVAILABLE:
            msg = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π asyncio) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. `pip install redis`. RedisCache –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."
            logger.critical(msg)
            raise ImportError(msg)
        self.redis_url = redis_url
        self._redis_client: Optional[Any] = None  # type: ignore
        logger.info(f"RedisCache –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è URL: {self.redis_url} (–∏—Å–ø–æ–ª—å–∑—É—è redis.asyncio)")

    async def initialize(self) -> None:
        logger.debug(f"RedisCache: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è URL: {self.redis_url}")
        if not redis_async:
            logger.critical("RedisCache.initialize: redis.asyncio –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!")
            raise ImportError("redis.asyncio –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω")

        try:
            logger.debug(f"RedisCache: –í—ã–∑–æ–≤ redis.asyncio.from_url('{self.redis_url}')")
            self._redis_client = redis_async.from_url(  # type: ignore
                self.redis_url, 
                decode_responses=False, # –í–∞–∂–Ω–æ –¥–ª—è pickle
                socket_timeout=5,
                socket_connect_timeout=5,
                # health_check_interval=30 # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            )
            logger.debug(f"RedisCache: redis.asyncio.from_url –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–ª–∏–µ–Ω—Ç: {type(self._redis_client)}")
            
            if self._redis_client:
                logger.debug("RedisCache: –ü–æ–ø—ã—Ç–∫–∞ PING...")
                await self._redis_client.ping()
                logger.success(f"–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ PING –∫ Redis: {self.redis_url}")
            else:
                # –≠—Ç–∞ –≤–µ—Ç–∫–∞ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–∞, —Ç–∞–∫ –∫–∞–∫ from_url –æ–±—ã—á–Ω–æ –ª–∏–±–æ –ø–∞–¥–∞–µ—Ç, –ª–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç
                logger.error(f"RedisCache: redis.asyncio.from_url –≤–µ—Ä–Ω—É–ª None –¥–ª—è {self.redis_url}")
                self._redis_client = None 
                raise RedisConnectionError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç Redis (from_url –≤–µ—Ä–Ω—É–ª None)")

        except (asyncio.TimeoutError, RedisTimeoutError) as te: 
            logger.error(f"RedisCache: –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–ø–∏–Ω–≥–µ –∫ Redis ({self.redis_url}): {te}", exc_info=False) # exc_info=False —Ç.–∫. —Ç–∞–π–º–∞—É—Ç - —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ
            self._redis_client = None
            raise
        except RedisConnectionError as ce: 
            logger.error(f"RedisCache: –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Redis ({self.redis_url}): {ce}", exc_info=True)
            self._redis_client = None
            raise
        except RedisError as re: 
            logger.error(f"RedisCache: –û–±—â–∞—è –æ—à–∏–±–∫–∞ Redis –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–ø–∏–Ω–≥–µ ({self.redis_url}): {re}", exc_info=True)
            self._redis_client = None
            raise
        except Exception as e: 
            logger.error(f"RedisCache: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Redis ({self.redis_url}): {type(e).__name__} - {e}", exc_info=True)
            self._redis_client = None
            raise

    async def dispose(self) -> None:
        if self._redis_client:
            logger.info(f"RedisCache: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis ({self.redis_url})...")
            try:
                await self._redis_client.close()
                # –î–ª—è redis-py 4.2+ –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–∫—Ä—ã—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ–±—â–∏–π
                # –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (–æ–±—ã—á–Ω–æ close() –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
                if hasattr(self._redis_client, 'connection_pool') and hasattr(self._redis_client.connection_pool, 'disconnect'):
                     await self._redis_client.connection_pool.disconnect()
                logger.info(f"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Redis ({self.redis_url}) —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis ({self.redis_url}): {e}", exc_info=True)
            finally:
                self._redis_client = None

    async def get(self, key: str) -> Optional[Any]:
        if not self._redis_client: return None
        try:
            json_value = await self._redis_client.get(key)
            if json_value: 
                # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JSON –≤–º–µ—Å—Ç–æ pickle
                return json.loads(json_value.decode('utf-8'))
            return None
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ GET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return None
        except (json.JSONDecodeError, UnicodeDecodeError) as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return None
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ GET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return None


    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        if not self._redis_client: return
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JSON –≤–º–µ—Å—Ç–æ pickle
            json_value = json.dumps(value, ensure_ascii=False, default=str)
            await self._redis_client.set(key, json_value, ex=ttl_seconds)
        except (TypeError, ValueError) as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}")
        except RedisError as e_redis: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ SET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_redis}")
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ SET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}")


    async def delete(self, key: str) -> bool:
        if not self._redis_client: return False
        try: 
            deleted_count = await self._redis_client.delete(key)
            return deleted_count > 0
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ DELETE –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return False
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ DELETE –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return False


    async def exists(self, key: str) -> bool:
        if not self._redis_client: return False
        try: 
            exists_count = await self._redis_client.exists(key)
            return exists_count > 0
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ EXISTS –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return False
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ EXISTS –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return False


    async def clear(self) -> None:
        if not self._redis_client: return
        try:
            logger.warning(f"RedisCache: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ FLUSHDB –¥–ª—è Redis ({self.redis_url})!")
            await self._redis_client.flushdb()
            logger.info(f"RedisCache: FLUSHDB –¥–ª—è Redis ({self.redis_url}) –≤—ã–ø–æ–ª–Ω–µ–Ω.")
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ FLUSHDB: {e}")
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ FLUSHDB: {e_unexp}")


    def get_client_instance(self) -> Optional[Any]:  # type: ignore
        return self._redis_client


class CacheManager:
    def __init__(self, cache_settings: 'CacheSettings'):
        self._settings = cache_settings
        self._cache_backend: Optional[BaseCache] = None
        self._is_initialized_successfully = False
        logger.info(f"CacheManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∏–ø –∫—ç—à–∞: {self._settings.type}")

    async def initialize(self) -> None:
        if self._is_initialized_successfully:
            logger.debug(f"CacheManager (–±—ç–∫–µ–Ω–¥: {self._settings.type}) —É–∂–µ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return
        self._is_initialized_successfully = False # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–æ–π

        if self._settings.type == "redis":
            if not self._settings.redis_url:
                logger.error("–¢–∏–ø –∫—ç—à–∞ 'redis', –Ω–æ redis_url –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
                return
            if not REDIS_PY_AVAILABLE:
                logger.critical("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' (–¥–ª—è asyncio) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø –∫—ç—à–∞ 'redis'. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
                return
            try:
                self._cache_backend = RedisCache(redis_url=str(self._settings.redis_url))
            except ImportError as e_imp_redis: 
                logger.critical(f"CacheManager: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å RedisCache (ImportError): {e_imp_redis}")
                return 
        elif self._settings.type == "memory":
            self._cache_backend = MemoryCache() 
        else:
            logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫—ç—à–∞: '{self._settings.type}'. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.")
            return

        if self._cache_backend:
            try:
                await self._cache_backend.initialize()
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Redis, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª—Å—è
                if isinstance(self._cache_backend, RedisCache) and self._cache_backend.get_client_instance() is None:
                    logger.error(f"CacheManager: RedisCache.initialize() –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –Ω–æ –∫–ª–∏–µ–Ω—Ç Redis –æ—Å—Ç–∞–ª—Å—è None. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.")
                    self._cache_backend = None # –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã is_available() –≤–µ—Ä–Ω—É–ª False
                else:
                    self._is_initialized_successfully = True
                    logger.success(f"–ë—ç–∫–µ–Ω–¥ –∫—ç—à–∞ '{self._settings.type}' —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e_init_backend: 
                logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥–∞ –∫—ç—à–∞ '{self._settings.type}': {type(e_init_backend).__name__} - {e_init_backend}", exc_info=False)
                self._cache_backend = None 
    
    async def dispose(self) -> None:
        if self._cache_backend: 
            try: await self._cache_backend.dispose()
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫—ç—à–∞ '{self._settings.type}': {e}", exc_info=True)
        self._is_initialized_successfully = False 
        self._cache_backend = None 
        logger.info(f"–†–µ—Å—É—Ä—Å—ã CacheManager –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ '{self._settings.type}' –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã (–∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è).")


    def is_available(self) -> bool:
        return self._cache_backend is not None and self._is_initialized_successfully

    async def get(self, key: str, default: Optional[Any] = None) -> Optional[Any]:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. get('{key}') –≤–µ—Ä–Ω–µ—Ç default ({default}).")
            return default
        return await self._cache_backend.get(key)

    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. set('{key}', ...) –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.")
            return
        await self._cache_backend.set(key, value, ttl_seconds=ttl_seconds)

    async def delete(self, key: str) -> bool:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. delete('{key}') –≤–µ—Ä–Ω–µ—Ç False.")
            return False
        return await self._cache_backend.delete(key)

    async def exists(self, key: str) -> bool:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. exists('{key}') –≤–µ—Ä–Ω–µ—Ç False.")
            return False
        return await self._cache_backend.exists(key)

    async def clear_all_cache(self) -> None:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. clear_all_cache() –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.")
            return
        logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ '{self._settings.type}'.")
        await self._cache_backend.clear()

    async def get_redis_client_instance(self) -> Optional[Any]:  # type: ignore
        if self.is_available() and isinstance(self._cache_backend, RedisCache):
            return self._cache_backend.get_client_instance()
        logger.debug("–ó–∞–ø—Ä–æ—à–µ–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä Redis –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ RedisCache –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        return None


======================================================================

------------------------------ FILE: Systems/core/security/reputation_system.py ------------------------------
# core/security/reputation_system.py
"""
–°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –º–æ–¥—É–ª–µ–π
"""

import json
import time
from typing import Dict, List, Optional, Tuple
from pathlib import Path
from dataclasses import dataclass
from enum import Enum
from loguru import logger
from datetime import datetime, timedelta

class ReputationLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
    UNTRUSTED = "untrusted"    # 0-20
    SUSPICIOUS = "suspicious"  # 21-40
    NEUTRAL = "neutral"        # 41-60
    TRUSTED = "trusted"        # 61-80
    VERIFIED = "verified"      # 81-100

class ReputationFactor(Enum):
    """–§–∞–∫—Ç–æ—Ä—ã —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
    SIGNATURE_VALID = "signature_valid"
    CODE_QUALITY = "code_quality"
    SECURITY_SCAN = "security_scan"
    USER_FEEDBACK = "user_feedback"
    TIME_ACTIVE = "time_active"
    VIOLATIONS = "violations"
    UPDATES_FREQUENCY = "updates_frequency"

@dataclass
class ReputationScore:
    """–û—Ü–µ–Ω–∫–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
    module_name: str
    developer_id: str
    total_score: float
    level: ReputationLevel
    factors: Dict[ReputationFactor, float]
    last_updated: float
    confidence: float  # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ (0-1)

@dataclass
class DeveloperProfile:
    """–ü—Ä–æ—Ñ–∏–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"""
    developer_id: str
    name: str
    email: Optional[str]
    reputation_score: float
    reputation_level: ReputationLevel
    modules_count: int
    total_downloads: int
    verified: bool
    join_date: float
    last_activity: float

class ModuleReputationSystem:
    """–°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π"""
    
    def __init__(self, config):
        self.config = config
        self.reputation_dir = config.core.project_data_path / "Security" / "reputation"
        self.reputation_dir.mkdir(parents=True, exist_ok=True)
        
        # –í–µ—Å–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
        self.factor_weights = {
            ReputationFactor.SIGNATURE_VALID: 0.25,
            ReputationFactor.CODE_QUALITY: 0.20,
            ReputationFactor.SECURITY_SCAN: 0.20,
            ReputationFactor.USER_FEEDBACK: 0.15,
            ReputationFactor.TIME_ACTIVE: 0.10,
            ReputationFactor.VIOLATIONS: -0.20,  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å
            ReputationFactor.UPDATES_FREQUENCY: 0.10
        }
        
        # –ö—ç—à –æ—Ü–µ–Ω–æ–∫ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
        self.reputation_cache: Dict[str, ReputationScore] = {}
        
        # –ü—Ä–æ—Ñ–∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        self.developer_profiles: Dict[str, DeveloperProfile] = {}
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        self._load_reputation_data()
        
        logger.info(f"[Security] ModuleReputationSystem –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.reputation_cache)} –æ—Ü–µ–Ω–æ–∫ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏")
    
    def _load_reputation_data(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏ –º–æ–¥—É–ª–µ–π
            modules_file = self.reputation_dir / "module_reputations.json"
            if modules_file.exists():
                with open(modules_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    for module_name, score_data in data.items():
                        self.reputation_cache[module_name] = ReputationScore(**score_data)
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            developers_file = self.reputation_dir / "developer_profiles.json"
            if developers_file.exists():
                with open(developers_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    for dev_id, profile_data in data.items():
                        self.developer_profiles[dev_id] = DeveloperProfile(**profile_data)
        
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–ø—É—Ç–∞—Ü–∏–∏: {e}")
    
    def _save_reputation_data(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª—ã"""
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ –º–æ–¥—É–ª–µ–π
            modules_file = self.reputation_dir / "module_reputations.json"
            modules_data = {}
            for module_name, score in self.reputation_cache.items():
                modules_data[module_name] = {
                    "module_name": score.module_name,
                    "developer_id": score.developer_id,
                    "total_score": score.total_score,
                    "level": score.level.value,
                    "factors": {factor.value: value for factor, value in score.factors.items()},
                    "last_updated": score.last_updated,
                    "confidence": score.confidence
                }
            
            with open(modules_file, 'w', encoding='utf-8') as f:
                json.dump(modules_data, f, indent=2, ensure_ascii=False)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            developers_file = self.reputation_dir / "developer_profiles.json"
            developers_data = {}
            for dev_id, profile in self.developer_profiles.items():
                developers_data[dev_id] = {
                    "developer_id": profile.developer_id,
                    "name": profile.name,
                    "email": profile.email,
                    "reputation_score": profile.reputation_score,
                    "reputation_level": profile.reputation_level.value,
                    "modules_count": profile.modules_count,
                    "total_downloads": profile.total_downloads,
                    "verified": profile.verified,
                    "join_date": profile.join_date,
                    "last_activity": profile.last_activity
                }
            
            with open(developers_file, 'w', encoding='utf-8') as f:
                json.dump(developers_data, f, indent=2, ensure_ascii=False)
        
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ–ø—É—Ç–∞—Ü–∏–∏: {e}")
    
    def calculate_reputation_score(self, module_name: str, developer_id: str, 
                                 signature_valid: bool = False,
                                 code_quality_score: float = 0.5,
                                 security_scan_score: float = 0.5,
                                 user_feedback_score: float = 0.5,
                                 time_active_days: int = 0,
                                 violations_count: int = 0,
                                 updates_count: int = 0) -> ReputationScore:
        """–í—ã—á–∏—Å–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –º–æ–¥—É–ª—è"""
        
        factors = {}
        
        # –ü–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è
        factors[ReputationFactor.SIGNATURE_VALID] = 1.0 if signature_valid else 0.0
        
        # –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
        factors[ReputationFactor.CODE_QUALITY] = max(0.0, min(1.0, code_quality_score))
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        factors[ReputationFactor.SECURITY_SCAN] = max(0.0, min(1.0, security_scan_score))
        
        # –û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        factors[ReputationFactor.USER_FEEDBACK] = max(0.0, min(1.0, user_feedback_score))
        
        # –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
        factors[ReputationFactor.TIME_ACTIVE] = min(1.0, time_active_days / 365.0)  # –ú–∞–∫—Å–∏–º—É–º –∑–∞ –≥–æ–¥
        
        # –ù–∞—Ä—É—à–µ–Ω–∏—è (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä)
        factors[ReputationFactor.VIOLATIONS] = max(0.0, 1.0 - (violations_count * 0.1))
        
        # –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        factors[ReputationFactor.UPDATES_FREQUENCY] = min(1.0, updates_count / 12.0)  # –ú–∞–∫—Å–∏–º—É–º 12 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –≥–æ–¥
        
        # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π –±–∞–ª–ª
        total_score = 0.0
        total_weight = 0.0
        
        for factor, weight in self.factor_weights.items():
            if factor in factors:
                total_score += factors[factor] * abs(weight)
                total_weight += abs(weight)
        
        if total_weight > 0:
            total_score = (total_score / total_weight) * 100  # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ 0-100
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
        if total_score >= 81:
            level = ReputationLevel.VERIFIED
        elif total_score >= 61:
            level = ReputationLevel.TRUSTED
        elif total_score >= 41:
            level = ReputationLevel.NEUTRAL
        elif total_score >= 21:
            level = ReputationLevel.SUSPICIOUS
        else:
            level = ReputationLevel.UNTRUSTED
        
        # –í—ã—á–∏—Å–ª—è–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ
        confidence = min(1.0, (time_active_days / 30.0) + 0.1)  # –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ = –±–æ–ª—å—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        
        score = ReputationScore(
            module_name=module_name,
            developer_id=developer_id,
            total_score=total_score,
            level=level,
            factors=factors,
            last_updated=time.time(),
            confidence=confidence
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        self.reputation_cache[module_name] = score
        
        logger.debug(f"[Security] –í—ã—á–∏—Å–ª–µ–Ω–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è {module_name}: {total_score:.1f} ({level.value})")
        return score
    
    def get_module_reputation(self, module_name: str) -> Optional[ReputationScore]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ø—É—Ç–∞—Ü–∏—é –º–æ–¥—É–ª—è"""
        return self.reputation_cache.get(module_name)
    
    def update_module_reputation(self, module_name: str, **kwargs) -> ReputationScore:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–ø—É—Ç–∞—Ü–∏—é –º–æ–¥—É–ª—è"""
        current_score = self.reputation_cache.get(module_name)
        
        if current_score:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É
            developer_id = current_score.developer_id
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É
            developer_id = kwargs.get("developer_id", "unknown")
        
        new_score = self.calculate_reputation_score(module_name, developer_id, **kwargs)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        self._save_reputation_data()
        
        return new_score
    
    def register_developer(self, developer_id: str, name: str, email: Optional[str] = None) -> DeveloperProfile:
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"""
        profile = DeveloperProfile(
            developer_id=developer_id,
            name=name,
            email=email,
            reputation_score=50.0,  # –ù–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è
            reputation_level=ReputationLevel.NEUTRAL,
            modules_count=0,
            total_downloads=0,
            verified=False,
            join_date=time.time(),
            last_activity=time.time()
        )
        
        self.developer_profiles[developer_id] = profile
        self._save_reputation_data()
        
        logger.info(f"[Security] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: {developer_id}")
        return profile
    
    def get_developer_profile(self, developer_id: str) -> Optional[DeveloperProfile]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"""
        return self.developer_profiles.get(developer_id)
    
    def update_developer_activity(self, developer_id: str):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"""
        if developer_id in self.developer_profiles:
            self.developer_profiles[developer_id].last_activity = time.time()
            self._save_reputation_data()
    
    def get_reputation_statistics(self) -> Dict[str, any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        stats = {
            "total_modules": len(self.reputation_cache),
            "total_developers": len(self.developer_profiles),
            "reputation_distribution": {},
            "average_reputation": 0.0,
            "verified_modules": 0,
            "untrusted_modules": 0
        }
        
        if self.reputation_cache:
            total_score = 0.0
            
            for score in self.reputation_cache.values():
                level = score.level.value
                stats["reputation_distribution"][level] = stats["reputation_distribution"].get(level, 0) + 1
                
                total_score += score.total_score
                
                if score.level == ReputationLevel.VERIFIED:
                    stats["verified_modules"] += 1
                elif score.level == ReputationLevel.UNTRUSTED:
                    stats["untrusted_modules"] += 1
            
            stats["average_reputation"] = total_score / len(self.reputation_cache)
        
        return stats
    
    def get_top_modules(self, limit: int = 10) -> List[Tuple[str, ReputationScore]]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø –º–æ–¥—É–ª–µ–π –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        sorted_modules = sorted(
            self.reputation_cache.items(),
            key=lambda x: x[1].total_score,
            reverse=True
        )
        
        return sorted_modules[:limit]
    
    def get_suspicious_modules(self) -> List[Tuple[str, ReputationScore]]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏"""
        suspicious = []
        
        for module_name, score in self.reputation_cache.items():
            if score.level in [ReputationLevel.SUSPICIOUS, ReputationLevel.UNTRUSTED]:
                suspicious.append((module_name, score))
        
        return sorted(suspicious, key=lambda x: x[1].total_score)



======================================================================

------------------------------ FILE: Systems/core/security/security_levels.py ------------------------------
# core/security/security_levels.py
"""
–°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã
"""

import json
from typing import Dict, List, Optional, Tuple, Set
from pathlib import Path
from dataclasses import dataclass
from enum import Enum
from loguru import logger

class SecurityLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    PARANOID = "paranoid"      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
    STRICT = "strict"         # –°—Ç—Ä–æ–≥–∞—è –∑–∞—â–∏—Ç–∞
    MODERATE = "moderate"     # –£–º–µ—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞
    PERMISSIVE = "permissive" # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

class SecurityPolicy(Enum):
    """–ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    ALLOW_SIGNED_ONLY = "allow_signed_only"           # –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
    REQUIRE_REPUTATION = "require_reputation"          # –¢—Ä–µ–±–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ä–µ–ø—É—Ç–∞—Ü–∏—é
    SANDBOX_ALL_MODULES = "sandbox_all_modules"        # –í—Å–µ –º–æ–¥—É–ª–∏ –≤ sandbox
    AUDIT_ALL_ACTIONS = "audit_all_actions"           # –ê—É–¥–∏—Ç –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
    BLOCK_SUSPICIOUS = "block_suspicious"             # –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
    REQUIRE_APPROVAL = "require_approval"             # –¢—Ä–µ–±–æ–≤–∞—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

@dataclass
class SecurityConfiguration:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    level: SecurityLevel
    policies: Set[SecurityPolicy]
    min_reputation_score: float
    allowed_developers: Set[str]
    blocked_modules: Set[str]
    trusted_signers: Set[str]
    max_risk_score: float
    auto_approve_verified: bool

class SecurityLevelManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —É—Ä–æ–≤–Ω–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    def __init__(self, config):
        self.config = config
        self.security_dir = config.core.project_data_path / "Security" / "levels"
        self.security_dir.mkdir(parents=True, exist_ok=True)
        
        # –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        self.default_configurations = {
            SecurityLevel.PARANOID: SecurityConfiguration(
                level=SecurityLevel.PARANOID,
                policies={
                    SecurityPolicy.ALLOW_SIGNED_ONLY,
                    SecurityPolicy.REQUIRE_REPUTATION,
                    SecurityPolicy.SANDBOX_ALL_MODULES,
                    SecurityPolicy.AUDIT_ALL_ACTIONS,
                    SecurityPolicy.BLOCK_SUSPICIOUS,
                    SecurityPolicy.REQUIRE_APPROVAL
                },
                min_reputation_score=80.0,
                allowed_developers=set(),
                blocked_modules=set(),
                trusted_signers={"sdb_core_team"},
                max_risk_score=10.0,
                auto_approve_verified=False
            ),
            
            SecurityLevel.STRICT: SecurityConfiguration(
                level=SecurityLevel.STRICT,
                policies={
                    SecurityPolicy.ALLOW_SIGNED_ONLY,
                    SecurityPolicy.REQUIRE_REPUTATION,
                    SecurityPolicy.SANDBOX_ALL_MODULES,
                    SecurityPolicy.AUDIT_ALL_ACTIONS,
                    SecurityPolicy.BLOCK_SUSPICIOUS
                },
                min_reputation_score=60.0,
                allowed_developers=set(),
                blocked_modules=set(),
                trusted_signers={"sdb_core_team"},
                max_risk_score=30.0,
                auto_approve_verified=True
            ),
            
            SecurityLevel.MODERATE: SecurityConfiguration(
                level=SecurityLevel.MODERATE,
                policies={
                    SecurityPolicy.REQUIRE_REPUTATION,
                    SecurityPolicy.SANDBOX_ALL_MODULES,
                    SecurityPolicy.AUDIT_ALL_ACTIONS
                },
                min_reputation_score=40.0,
                allowed_developers=set(),
                blocked_modules=set(),
                trusted_signers={"sdb_core_team"},
                max_risk_score=50.0,
                auto_approve_verified=True
            ),
            
            SecurityLevel.PERMISSIVE: SecurityConfiguration(
                level=SecurityLevel.PERMISSIVE,
                policies={
                    SecurityPolicy.AUDIT_ALL_ACTIONS
                },
                min_reputation_score=0.0,
                allowed_developers=set(),
                blocked_modules=set(),
                trusted_signers=set(),
                max_risk_score=100.0,
                auto_approve_verified=True
            )
        }
        
        # –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        self.current_config = self._load_security_configuration()
        
        logger.info(f"[Security] SecurityLevelManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —É—Ä–æ–≤–Ω–µ–º {self.current_config.level.value}")
    
    def _load_security_configuration(self) -> SecurityConfiguration:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        config_file = self.security_dir / "security_config.json"
        
        if config_file.exists():
            try:
                with open(config_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                return SecurityConfiguration(
                    level=SecurityLevel(data["level"]),
                    policies={SecurityPolicy(policy) for policy in data["policies"]},
                    min_reputation_score=data["min_reputation_score"],
                    allowed_developers=set(data["allowed_developers"]),
                    blocked_modules=set(data["blocked_modules"]),
                    trusted_signers=set(data["trusted_signers"]),
                    max_risk_score=data["max_risk_score"],
                    auto_approve_verified=data["auto_approve_verified"]
                )
            except Exception as e:
                logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return self.default_configurations[SecurityLevel.MODERATE]
    
    def _save_security_configuration(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        config_file = self.security_dir / "security_config.json"
        
        try:
            data = {
                "level": self.current_config.level.value,
                "policies": [policy.value for policy in self.current_config.policies],
                "min_reputation_score": self.current_config.min_reputation_score,
                "allowed_developers": list(self.current_config.allowed_developers),
                "blocked_modules": list(self.current_config.blocked_modules),
                "trusted_signers": list(self.current_config.trusted_signers),
                "max_risk_score": self.current_config.max_risk_score,
                "auto_approve_verified": self.current_config.auto_approve_verified
            }
            
            with open(config_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
        
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")
    
    def set_security_level(self, level: SecurityLevel) -> bool:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            self.current_config = self.default_configurations[level].__class__(
                level=level,
                policies=self.default_configurations[level].policies.copy(),
                min_reputation_score=self.default_configurations[level].min_reputation_score,
                allowed_developers=self.default_configurations[level].allowed_developers.copy(),
                blocked_modules=self.default_configurations[level].blocked_modules.copy(),
                trusted_signers=self.default_configurations[level].trusted_signers.copy(),
                max_risk_score=self.default_configurations[level].max_risk_score,
                auto_approve_verified=self.default_configurations[level].auto_approve_verified
            )
            
            self._save_security_configuration()
            logger.info(f"[Security] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {level.value}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ {level.value}: {e}")
            return False
    
    def get_current_configuration(self) -> SecurityConfiguration:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        return self.current_config
    
    def add_policy(self, policy: SecurityPolicy) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            self.current_config.policies.add(policy)
            self._save_security_configuration()
            logger.info(f"[Security] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {policy.value}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ {policy.value}: {e}")
            return False
    
    def remove_policy(self, policy: SecurityPolicy) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            self.current_config.policies.discard(policy)
            self._save_security_configuration()
            logger.info(f"[Security] –£–¥–∞–ª–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {policy.value}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ {policy.value}: {e}")
            return False
    
    def add_trusted_signer(self, signer_id: str) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞"""
        try:
            self.current_config.trusted_signers.add(signer_id)
            self._save_security_configuration()
            logger.info(f"[Security] –î–æ–±–∞–≤–ª–µ–Ω –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–¥–ø–∏—Å–∞–Ω—Ç: {signer_id}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ {signer_id}: {e}")
            return False
    
    def remove_trusted_signer(self, signer_id: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞"""
        try:
            self.current_config.trusted_signers.discard(signer_id)
            self._save_security_configuration()
            logger.info(f"[Security] –£–¥–∞–ª–µ–Ω –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–¥–ø–∏—Å–∞–Ω—Ç: {signer_id}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ {signer_id}: {e}")
            return False
    
    def block_module(self, module_name: str) -> bool:
        """–ë–ª–æ–∫–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å"""
        try:
            self.current_config.blocked_modules.add(module_name)
            self._save_security_configuration()
            logger.info(f"[Security] –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–æ–¥—É–ª—å: {module_name}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def unblock_module(self, module_name: str) -> bool:
        """–†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å"""
        try:
            self.current_config.blocked_modules.discard(module_name)
            self._save_security_configuration()
            logger.info(f"[Security] –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–æ–¥—É–ª—å: {module_name}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def is_module_allowed(self, module_name: str, 
                         signature_valid: bool = False,
                         reputation_score: float = 0.0,
                         risk_score: float = 0.0,
                         developer_id: str = "unknown") -> Tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –º–æ–¥—É–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        if module_name in self.current_config.blocked_modules:
            return False, f"–ú–æ–¥—É–ª—å {module_name} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
        if SecurityPolicy.ALLOW_SIGNED_ONLY in self.current_config.policies:
            if not signature_valid:
                return False, f"–ú–æ–¥—É–ª—å {module_name} –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
        if SecurityPolicy.REQUIRE_REPUTATION in self.current_config.policies:
            if reputation_score < self.current_config.min_reputation_score:
                return False, f"–†–µ–ø—É—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è {module_name} —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è ({reputation_score:.1f} < {self.current_config.min_reputation_score})"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö
        if SecurityPolicy.BLOCK_SUSPICIOUS in self.current_config.policies:
            if risk_score > self.current_config.max_risk_score:
                return False, f"–†–∏—Å–∫ –º–æ–¥—É–ª—è {module_name} —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π ({risk_score:.1f} > {self.current_config.max_risk_score})"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        if self.current_config.allowed_developers and developer_id not in self.current_config.allowed_developers:
            return False, f"–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ {developer_id} –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö"
        
        return True, "–ú–æ–¥—É–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"
    
    def get_security_summary(self) -> Dict[str, any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        return {
            "current_level": self.current_config.level.value,
            "active_policies": [policy.value for policy in self.current_config.policies],
            "min_reputation_score": self.current_config.min_reputation_score,
            "max_risk_score": self.current_config.max_risk_score,
            "trusted_signers_count": len(self.current_config.trusted_signers),
            "blocked_modules_count": len(self.current_config.blocked_modules),
            "allowed_developers_count": len(self.current_config.allowed_developers),
            "auto_approve_verified": self.current_config.auto_approve_verified
        }



======================================================================

------------------------------ FILE: Systems/core/security/crypto_manager.py ------------------------------
# core/security/crypto_manager.py
"""
–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç–æ—è—â—É—é –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –ø–æ–¥–ø–∏—Å–µ–π
"""

import os
import json
import hashlib
import secrets
import time
from typing import Dict, List, Optional, Tuple
from pathlib import Path
from dataclasses import dataclass
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.backends import default_backend
from loguru import logger

@dataclass
class KeyPair:
    """–ü–∞—Ä–∞ –∫–ª—é—á–µ–π (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π)"""
    private_key: rsa.RSAPrivateKey
    public_key: rsa.RSAPublicKey
    key_id: str
    created_at: float
    expires_at: Optional[float] = None

@dataclass
class DigitalSignature:
    """–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è"""
    module_name: str
    version: str
    file_hash: str
    signature: bytes
    signer_key_id: str
    timestamp: float
    algorithm: str = "RSA-SHA256"

class CryptoManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π"""
    
    def __init__(self, config):
        self.config = config
        self.keys_dir = config.core.project_data_path / "Security" / "crypto_keys"
        self.keys_dir.mkdir(parents=True, exist_ok=True)
        
        # –ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
        self.master_password = self._get_or_create_master_password()
        
        # –ö—ç—à –∫–ª—é—á–µ–π
        self.key_cache: Dict[str, KeyPair] = {}
        
        logger.info(f"[Security] CryptoManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–π: {self.keys_dir}")
    
    def _get_or_create_master_password(self) -> bytes:
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å"""
        password_file = self.keys_dir / ".master_password"
        
        if password_file.exists():
            try:
                with open(password_file, 'rb') as f:
                    return f.read()
            except Exception as e:
                logger.error(f"[Security] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—è: {e}")
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å
        master_password = secrets.token_bytes(32)
        
        try:
            with open(password_file, 'wb') as f:
                f.write(master_password)
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
            os.chmod(password_file, 0o600)
            logger.info("[Security] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å")
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—è: {e}")
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
            master_password = b"temporary_password_change_me"
        
        return master_password
    
    def generate_key_pair(self, key_id: str, key_size: int = 2048) -> KeyPair:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π"""
        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            private_key = rsa.generate_private_key(
                public_exponent=65537,
                key_size=key_size,
                backend=default_backend()
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key = private_key.public_key()
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–∞—Ä—ã –∫–ª—é—á–µ–π
            key_pair = KeyPair(
                private_key=private_key,
                public_key=public_key,
                key_id=key_id,
                created_at=time.time()
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á–∏
            self._save_key_pair(key_pair)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à
            self.key_cache[key_id] = key_pair
            
            logger.info(f"[Security] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞—Ä–∞ –∫–ª—é—á–µ–π: {key_id}")
            return key_pair
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä—ã –∫–ª—é—á–µ–π {key_id}: {e}")
            raise
    
    def _save_key_pair(self, key_pair: KeyPair):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–∞—Ä—É –∫–ª—é—á–µ–π –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ"""
        try:
            # –®–∏—Ñ—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            encrypted_private_key = self._encrypt_private_key(key_pair.private_key)
            
            # –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key_pem = key_pair.public_key.public_bytes(
                encoding=serialization.Encoding.PEM,
                format=serialization.PublicFormat.SubjectPublicKeyInfo
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            private_key_file = self.keys_dir / f"{key_pair.key_id}.private"
            with open(private_key_file, 'wb') as f:
                f.write(encrypted_private_key)
            os.chmod(private_key_file, 0o600)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key_file = self.keys_dir / f"{key_pair.key_id}.public"
            with open(public_key_file, 'wb') as f:
                f.write(public_key_pem)
            os.chmod(public_key_file, 0o644)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            metadata = {
                "key_id": key_pair.key_id,
                "created_at": key_pair.created_at,
                "expires_at": key_pair.expires_at,
                "key_size": key_pair.public_key.key_size
            }
            
            metadata_file = self.keys_dir / f"{key_pair.key_id}.meta"
            with open(metadata_file, 'w') as f:
                json.dump(metadata, f, indent=2)
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä—ã –∫–ª—é—á–µ–π {key_pair.key_id}: {e}")
            raise
    
    def _encrypt_private_key(self, private_key: rsa.RSAPrivateKey) -> bytes:
        """–®–∏—Ñ—Ä—É–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á"""
        try:
            # –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            private_key_pem = private_key.private_bytes(
                encoding=serialization.Encoding.PEM,
                format=serialization.PrivateFormat.PKCS8,
                encryption_algorithm=serialization.NoEncryption()
            )
            
            # –°–æ–∑–¥–∞–µ–º —Å–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
            salt = secrets.token_bytes(16)
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—è
            kdf = PBKDF2HMAC(
                algorithm=hashes.SHA256(),
                length=32,
                salt=salt,
                iterations=100000,
                backend=default_backend()
            )
            encryption_key = kdf.derive(self.master_password)
            
            # –®–∏—Ñ—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
            # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AES-GCM
            encrypted_data = private_key_pem + salt  # –£–ø—Ä–æ—â–µ–Ω–∏–µ!
            
            return encrypted_data
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞: {e}")
            raise
    
    def load_key_pair(self, key_id: str) -> Optional[KeyPair]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ä—É –∫–ª—é—á–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if key_id in self.key_cache:
            return self.key_cache[key_id]
        
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            metadata_file = self.keys_dir / f"{key_id}.meta"
            if not metadata_file.exists():
                return None
            
            with open(metadata_file, 'r') as f:
                metadata = json.load(f)
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key_file = self.keys_dir / f"{key_id}.public"
            if not public_key_file.exists():
                return None
            
            with open(public_key_file, 'rb') as f:
                public_key_pem = f.read()
            
            public_key = serialization.load_pem_public_key(
                public_key_pem,
                backend=default_backend()
            )
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            private_key_file = self.keys_dir / f"{key_id}.private"
            if not private_key_file.exists():
                return None
            
            with open(private_key_file, 'rb') as f:
                encrypted_private_key = f.read()
            
            private_key = self._decrypt_private_key(encrypted_private_key)
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–∞—Ä—ã –∫–ª—é—á–µ–π
            key_pair = KeyPair(
                private_key=private_key,
                public_key=public_key,
                key_id=key_id,
                created_at=metadata["created_at"],
                expires_at=metadata.get("expires_at")
            )
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à
            self.key_cache[key_id] = key_pair
            
            return key_pair
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—ã –∫–ª—é—á–µ–π {key_id}: {e}")
            return None
    
    def _decrypt_private_key(self, encrypted_data: bytes) -> rsa.RSAPrivateKey:
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á"""
        try:
            # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
            # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å (—É–ø—Ä–æ—â–µ–Ω–∏–µ!)
            private_key_pem = encrypted_data[:-16]  # –£–±–∏—Ä–∞–µ–º —Å–æ–ª—å
            
            private_key = serialization.load_pem_private_key(
                private_key_pem,
                password=None,
                backend=default_backend()
            )
            
            return private_key
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞: {e}")
            raise
    
    def sign_data(self, data: bytes, key_id: str) -> bytes:
        """–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ"""
        try:
            key_pair = self.load_key_pair(key_id)
            if not key_pair:
                raise ValueError(f"–ö–ª—é—á {key_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å
            signature = key_pair.private_key.sign(
                data,
                padding.PSS(
                    mgf=padding.MGF1(hashes.SHA256()),
                    salt_length=padding.PSS.MAX_LENGTH
                ),
                hashes.SHA256()
            )
            
            logger.debug(f"[Security] –î–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –∫–ª—é—á–æ–º {key_id}")
            return signature
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–æ–º {key_id}: {e}")
            raise
    
    def verify_signature(self, data: bytes, signature: bytes, key_id: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å"""
        try:
            key_pair = self.load_key_pair(key_id)
            if not key_pair:
                logger.warning(f"[Security] –ö–ª—é—á {key_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏")
                return False
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
            key_pair.public_key.verify(
                signature,
                data,
                padding.PSS(
                    mgf=padding.MGF1(hashes.SHA256()),
                    salt_length=padding.PSS.MAX_LENGTH
                ),
                hashes.SHA256()
            )
            
            logger.debug(f"[Security] –ü–æ–¥–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∫–ª—é—á–æ–º {key_id}")
            return True
            
        except Exception as e:
            logger.warning(f"[Security] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –∫–ª—é—á–æ–º {key_id}: {e}")
            return False
    
    def sign_module(self, module_path: Path, key_id: str) -> DigitalSignature:
        """–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å"""
        try:
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –º–æ–¥—É–ª—è
            with open(module_path, 'rb') as f:
                module_data = f.read()
            
            # –í—ã—á–∏—Å–ª—è–µ–º —Ö—ç—à —Ñ–∞–π–ª–∞
            file_hash = hashlib.sha256(module_data).hexdigest()
            
            # –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
            signature_data = {
                "module_name": module_path.stem,
                "version": "1.0.0",  # TODO: –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
                "file_hash": file_hash,
                "timestamp": time.time(),
                "algorithm": "RSA-SHA256"
            }
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ bytes –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
            data_to_sign = json.dumps(signature_data, sort_keys=True).encode('utf-8')
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            signature = self.sign_data(data_to_sign, key_id)
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–¥–ø–∏—Å–∏
            digital_signature = DigitalSignature(
                module_name=module_path.stem,
                version=signature_data["version"],
                file_hash=file_hash,
                signature=signature,
                signer_key_id=key_id,
                timestamp=signature_data["timestamp"]
            )
            
            logger.info(f"[Security] –ú–æ–¥—É–ª—å {module_path.stem} –ø–æ–¥–ø–∏—Å–∞–Ω –∫–ª—é—á–æ–º {key_id}")
            return digital_signature
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è {module_path}: {e}")
            raise
    
    def verify_module_signature(self, module_path: Path, signature: DigitalSignature) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è"""
        try:
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –º–æ–¥—É–ª—è
            with open(module_path, 'rb') as f:
                module_data = f.read()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö—ç—à —Ñ–∞–π–ª–∞
            current_hash = hashlib.sha256(module_data).hexdigest()
            if current_hash != signature.file_hash:
                logger.warning(f"[Security] –•—ç—à —Ñ–∞–π–ª–∞ {module_path} –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–¥–ø–∏—Å—å—é")
                return False
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
            signature_data = {
                "module_name": signature.module_name,
                "version": signature.version,
                "file_hash": signature.file_hash,
                "timestamp": signature.timestamp,
                "algorithm": signature.algorithm
            }
            
            data_to_verify = json.dumps(signature_data, sort_keys=True).encode('utf-8')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
            is_valid = self.verify_signature(data_to_verify, signature.signature, signature.signer_key_id)
            
            if is_valid:
                logger.info(f"[Security] –ü–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è {module_path.stem} –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
            else:
                logger.warning(f"[Security] –ü–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è {module_path.stem} –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞")
            
            return is_valid
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª—è {module_path}: {e}")
            return False
    
    def list_available_keys(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª—é—á–µ–π"""
        try:
            key_files = list(self.keys_dir.glob("*.meta"))
            return [f.stem for f in key_files]
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π: {e}")
            return []
    
    def export_public_key(self, key_id: str) -> Optional[bytes]:
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"""
        try:
            key_pair = self.load_key_pair(key_id)
            if not key_pair:
                return None
            
            return key_pair.public_key.public_bytes(
                encoding=serialization.Encoding.PEM,
                format=serialization.PublicFormat.SubjectPublicKeyInfo
            )
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ {key_id}: {e}")
            return None



======================================================================

------------------------------ FILE: Systems/core/security/rate_limiter.py ------------------------------
# core/security/rate_limiter.py
"""
Rate Limiting Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ñ–ª—É–¥–∞ –∏ DDoS –∞—Ç–∞–∫
"""

import time
from collections import defaultdict
from typing import Dict, Optional, Tuple
from datetime import datetime, timedelta
from loguru import logger

from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, Update, Message, CallbackQuery
from aiogram.exceptions import TelegramRetryAfter

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider


class RateLimiter:
    """
    –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è rate limiting —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º sliding window –∞–ª–≥–æ—Ä–∏—Ç–º–∞
    """
    
    def __init__(self, default_limit: int = 10, default_window: int = 60):
        """
        Args:
            default_limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            default_window: –û–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        """
        self.default_limit = default_limit
        self.default_window = default_window
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {user_id: [(timestamp, action_type), ...]}
        self._requests: Dict[int, list] = defaultdict(list)
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
        self._limits: Dict[str, Tuple[int, int]] = {
            "message": (10, 60),  # 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
            "callback": (20, 60),  # 20 callback'–æ–≤ –≤ –º–∏–Ω—É—Ç—É
            "command": (5, 60),    # 5 –∫–æ–º–∞–Ω–¥ –≤ –º–∏–Ω—É—Ç—É
            "inline_query": (30, 60),  # 30 inline –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
        }
        self._logger = logger.bind(service="RateLimiter")
    
    def set_limit(self, action_type: str, limit: int, window: int):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç –¥–ª—è —Ç–∏–ø–∞ –¥–µ–π—Å—Ç–≤–∏—è"""
        self._limits[action_type] = (limit, window)
        self._logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è {action_type}: {limit} –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ {window} —Å–µ–∫—É–Ω–¥")
    
    def check_rate_limit(
        self, 
        user_id: int, 
        action_type: str = "message",
        custom_limit: Optional[int] = None,
        custom_window: Optional[int] = None
    ) -> Tuple[bool, int]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç rate limit –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            Tuple[bool, int]: (is_allowed, retry_after)
                - is_allowed: —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å
                - retry_after: —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å (–µ—Å–ª–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω)
        """
        current_time = time.time()
        limit, window = self._limits.get(action_type, (self.default_limit, self.default_window))
        
        if custom_limit is not None:
            limit = custom_limit
        if custom_window is not None:
            window = custom_window
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (—Å—Ç–∞—Ä—à–µ –æ–∫–Ω–∞)
        user_requests = self._requests[user_id]
        cutoff_time = current_time - window
        self._requests[user_id] = [
            req_time for req_time in user_requests 
            if req_time[0] > cutoff_time
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
        request_count = len(self._requests[user_id])
        
        if request_count >= limit:
            # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            oldest_request_time = min(req[0] for req in self._requests[user_id]) if self._requests[user_id] else current_time
            retry_after = int(window - (current_time - oldest_request_time)) + 1
            return False, retry_after
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        self._requests[user_id].append((current_time, action_type))
        return True, 0
    
    def reset_user(self, user_id: int):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self._requests:
            del self._requests[user_id]
            self._logger.debug(f"–°—á–µ—Ç—á–∏–∫ rate limit —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    def get_user_stats(self, user_id: int) -> Dict[str, int]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        current_time = time.time()
        user_requests = self._requests.get(user_id, [])
        
        stats = {}
        for action_type, (limit, window) in self._limits.items():
            cutoff_time = current_time - window
            action_requests = [
                req_time for req_time in user_requests 
                if req_time[0] > cutoff_time and req_time[1] == action_type
            ]
            stats[action_type] = {
                "count": len(action_requests),
                "limit": limit,
                "remaining": max(0, limit - len(action_requests))
            }
        
        return stats


class RateLimitMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    
    def __init__(self, rate_limiter: Optional[RateLimiter] = None):
        super().__init__()
        self.rate_limiter = rate_limiter or RateLimiter()
        self._logger = logger.bind(service="RateLimitMiddleware")
        # –ò—Å–∫–ª—é—á–µ–Ω–∏—è - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å—Å—è
        self._exempt_users: set = set()
    
    def exempt_user(self, user_id: int):
        """–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è"""
        self._exempt_users.add(user_id)
        self._logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è rate limit")
    
    def remove_exemption(self, user_id: int):
        """–£–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""
        self._exempt_users.discard(user_id)
    
    def _get_action_type(self, event: Update) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ —Å–æ–±—ã—Ç–∏—è"""
        if event.message:
            if event.message.text and event.message.text.startswith("/"):
                return "command"
            return "message"
        elif event.callback_query:
            return "callback"
        elif event.inline_query:
            return "inline_query"
        return "message"
    
    async def __call__(
        self,
        handler,
        event: Update,
        data: Dict
    ):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π rate limit"""
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–æ–±—ã—Ç–∏—è
        user = data.get("event_from_user")
        if not user:
            # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            return await handler(event, data)
        
        user_id = user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è (—Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –∏ —Ç.–¥.)
        services_provider = data.get("services_provider")
        if services_provider:
            if user_id in services_provider.config.core.super_admins:
                return await handler(event, data)
        
        if user_id in self._exempt_users:
            return await handler(event, data)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è
        action_type = self._get_action_type(event)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit
        is_allowed, retry_after = self.rate_limiter.check_rate_limit(
            user_id=user_id,
            action_type=action_type
        )
        
        if not is_allowed:
            self._logger.warning(
                f"Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} "
                f"(–¥–µ–π—Å—Ç–≤–∏–µ: {action_type}, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ {retry_after} —Å–µ–∫)"
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            error_message = (
                f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. "
                f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ {retry_after} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."
            )
            
            try:
                if event.message:
                    await event.message.answer(error_message)
                elif event.callback_query:
                    await event.callback_query.answer(
                        f"–ü–æ–¥–æ–∂–¥–∏—Ç–µ {retry_after} —Å–µ–∫",
                        show_alert=True
                    )
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ rate limit: {e}")
            
            return None  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        
        # –ï—Å–ª–∏ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        return await handler(event, data)




======================================================================

------------------------------ FILE: Systems/core/security/__init__.py ------------------------------
# core/security/__init__.py
"""
SDB Security Module
–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –º–æ–¥—É–ª–µ–π –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ SDB
"""

from .signature_manager import ModuleSignatureManager
from .sandbox_manager import ModuleSandboxManager
from .audit_logger import SecurityAuditLogger
from .reputation_system import ModuleReputationSystem
from .code_scanner import ModuleCodeScanner
from .security_levels import SecurityLevelManager
from .anomaly_detection import AnomalyDetector

__all__ = [
    "ModuleSignatureManager",
    "ModuleSandboxManager", 
    "SecurityAuditLogger",
    "ModuleReputationSystem",
    "ModuleCodeScanner",
    "SecurityLevelManager",
    "AnomalyDetector"
]



======================================================================

------------------------------ FILE: Systems/core/security/code_scanner.py ------------------------------
# core/security/code_scanner.py
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω–µ—Ä –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –º–æ–¥—É–ª–µ–π
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–¥ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É–≥—Ä–æ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
"""

import ast
import re
import json
from typing import Dict, List, Optional, Tuple, Set
from pathlib import Path
from dataclasses import dataclass
from enum import Enum
from loguru import logger

class ThreatLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ —É–≥—Ä–æ–∑"""
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

class ThreatType(Enum):
    """–¢–∏–ø—ã —É–≥—Ä–æ–∑"""
    MALICIOUS_IMPORT = "malicious_import"
    SYSTEM_COMMAND = "system_command"
    FILE_ACCESS = "file_access"
    NETWORK_REQUEST = "network_request"
    CODE_INJECTION = "code_injection"
    PRIVILEGE_ESCALATION = "privilege_escalation"
    DATA_EXFILTRATION = "data_exfiltration"
    BACKDOOR = "backdoor"
    CRYPTO_MINING = "crypto_mining"

@dataclass
class SecurityThreat:
    """–£–≥—Ä–æ–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    threat_type: ThreatType
    threat_level: ThreatLevel
    file_path: str
    line_number: int
    code_snippet: str
    description: str
    recommendation: str

@dataclass
class ScanResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    module_name: str
    scan_timestamp: float
    threats_found: List[SecurityThreat]
    risk_score: float  # 0-100
    is_safe: bool
    suspicious_patterns: List[str]
    code_metrics: Dict[str, any]

class ModuleCodeScanner:
    """–°–∫–∞–Ω–µ—Ä –∫–æ–¥–∞ –º–æ–¥—É–ª–µ–π"""
    
    def __init__(self, config):
        self.config = config
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
        self.suspicious_patterns = {
            # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            ThreatType.SYSTEM_COMMAND: [
                r'os\.system\(',
                r'subprocess\.',
                r'exec\(',
                r'eval\(',
                r'__import__\(',
                r'compile\(',
                r'execfile\(',
            ],
            
            # –î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
            ThreatType.FILE_ACCESS: [
                r'open\(',
                r'file\(',
                r'os\.remove\(',
                r'os\.unlink\(',
                r'shutil\.',
                r'os\.path\.',
            ],
            
            # –°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            ThreatType.NETWORK_REQUEST: [
                r'requests\.',
                r'urllib\.',
                r'socket\.',
                r'http\.',
                r'ftplib\.',
                r'smtplib\.',
            ],
            
            # –ò–Ω—ä–µ–∫—Ü–∏—è –∫–æ–¥–∞
            ThreatType.CODE_INJECTION: [
                r'eval\(',
                r'exec\(',
                r'__import__\(',
                r'getattr\(',
                r'setattr\(',
                r'globals\(',
                r'locals\(',
            ],
            
            # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
            ThreatType.MALICIOUS_IMPORT: [
                r'import\s+os',
                r'import\s+subprocess',
                r'import\s+socket',
                r'import\s+urllib',
                r'import\s+requests',
                r'from\s+os\s+import',
                r'from\s+subprocess\s+import',
            ],
            
            # Backdoor –ø–∞—Ç—Ç–µ—Ä–Ω—ã
            ThreatType.BACKDOOR: [
                r'backdoor',
                r'hidden',
                r'secret',
                r'admin',
                r'root',
                r'password',
                r'token',
                r'key',
            ],
            
            # –ö—Ä–∏–ø—Ç–æ–º–∞–π–Ω–∏–Ω–≥
            ThreatType.CRYPTO_MINING: [
                r'mining',
                r'hash',
                r'crypto',
                r'bitcoin',
                r'ethereum',
                r'miner',
            ]
        }
        
        # –í–µ—Å–∞ —É–≥—Ä–æ–∑ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ —Ä–∏—Å–∫–∞
        self.threat_weights = {
            ThreatLevel.CRITICAL: 1.0,
            ThreatLevel.HIGH: 0.7,
            ThreatLevel.MEDIUM: 0.4,
            ThreatLevel.LOW: 0.1
        }
        
        logger.info(f"[Security] ModuleCodeScanner –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å {len(self.suspicious_patterns)} —Ç–∏–ø–∞–º–∏ —É–≥—Ä–æ–∑")
    
    def scan_module(self, module_path: Path) -> ScanResult:
        """–°–∫–∞–Ω–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —É–≥—Ä–æ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            threats = []
            suspicious_patterns = []
            code_metrics = {}
            
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã –º–æ–¥—É–ª—è
            python_files = list(module_path.rglob("*.py"))
            
            for file_path in python_files:
                file_threats, file_patterns, file_metrics = self._scan_file(file_path)
                threats.extend(file_threats)
                suspicious_patterns.extend(file_patterns)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                for key, value in file_metrics.items():
                    code_metrics[key] = code_metrics.get(key, 0) + value
            
            # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π —Ä–∏—Å–∫
            risk_score = self._calculate_risk_score(threats)
            is_safe = risk_score < 30.0  # –ü–æ—Ä–æ–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            
            result = ScanResult(
                module_name=module_path.name,
                scan_timestamp=Path(module_path).stat().st_mtime,
                threats_found=threats,
                risk_score=risk_score,
                is_safe=is_safe,
                suspicious_patterns=list(set(suspicious_patterns)),
                code_metrics=code_metrics
            )
            
            logger.info(f"[Security] –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è {module_path.name}: –Ω–∞–π–¥–µ–Ω–æ {len(threats)} —É–≥—Ä–æ–∑, —Ä–∏—Å–∫ {risk_score:.1f}")
            return result
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è {module_path}: {e}")
            return ScanResult(
                module_name=module_path.name,
                scan_timestamp=0,
                threats_found=[],
                risk_score=100.0,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                is_safe=False,
                suspicious_patterns=[],
                code_metrics={}
            )
    
    def _scan_file(self, file_path: Path) -> Tuple[List[SecurityThreat], List[str], Dict[str, any]]:
        """–°–∫–∞–Ω–∏—Ä—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª"""
        threats = []
        suspicious_patterns = []
        metrics = {
            "lines_of_code": 0,
            "functions_count": 0,
            "classes_count": 0,
            "imports_count": 0
        }
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                lines = content.split('\n')
                metrics["lines_of_code"] = len(lines)
            
            # –ê–Ω–∞–ª–∏–∑ AST
            try:
                tree = ast.parse(content)
                metrics.update(self._analyze_ast(tree))
            except SyntaxError:
                logger.warning(f"[Security] –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ñ–∞–π–ª–µ {file_path}")
            
            # –ü–æ–∏—Å–∫ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            for line_num, line in enumerate(lines, 1):
                line_threats, line_patterns = self._analyze_line(line, line_num, file_path)
                threats.extend(line_threats)
                suspicious_patterns.extend(line_patterns)
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {file_path}: {e}")
        
        return threats, suspicious_patterns, metrics
    
    def _analyze_ast(self, tree: ast.AST) -> Dict[str, int]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç AST –¥–µ—Ä–µ–≤–æ"""
        metrics = {
            "functions_count": 0,
            "classes_count": 0,
            "imports_count": 0
        }
        
        for node in ast.walk(tree):
            if isinstance(node, ast.FunctionDef):
                metrics["functions_count"] += 1
            elif isinstance(node, ast.ClassDef):
                metrics["classes_count"] += 1
            elif isinstance(node, (ast.Import, ast.ImportFrom)):
                metrics["imports_count"] += 1
        
        return metrics
    
    def _analyze_line(self, line: str, line_num: int, file_path: Path) -> Tuple[List[SecurityThreat], List[str]]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –∫–æ–¥–∞"""
        threats = []
        patterns = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ç–∏–ø —É–≥—Ä–æ–∑
        for threat_type, pattern_list in self.suspicious_patterns.items():
            for pattern in pattern_list:
                if re.search(pattern, line, re.IGNORECASE):
                    threat_level = self._determine_threat_level(threat_type, pattern, line)
                    
                    threat = SecurityThreat(
                        threat_type=threat_type,
                        threat_level=threat_level,
                        file_path=str(file_path),
                        line_number=line_num,
                        code_snippet=line.strip(),
                        description=self._get_threat_description(threat_type),
                        recommendation=self._get_threat_recommendation(threat_type)
                    )
                    
                    threats.append(threat)
                    patterns.append(f"{threat_type.value}: {pattern}")
        
        return threats, patterns
    
    def _determine_threat_level(self, threat_type: ThreatType, pattern: str, line: str) -> ThreatLevel:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã"""
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≥—Ä–æ–∑—ã
        if threat_type in [ThreatType.CODE_INJECTION, ThreatType.PRIVILEGE_ESCALATION]:
            return ThreatLevel.CRITICAL
        
        # –í—ã—Å–æ–∫–∏–µ —É–≥—Ä–æ–∑—ã
        if threat_type in [ThreatType.SYSTEM_COMMAND, ThreatType.BACKDOOR]:
            return ThreatLevel.HIGH
        
        # –°—Ä–µ–¥–Ω–∏–µ —É–≥—Ä–æ–∑—ã
        if threat_type in [ThreatType.FILE_ACCESS, ThreatType.NETWORK_REQUEST]:
            return ThreatLevel.MEDIUM
        
        # –ù–∏–∑–∫–∏–µ —É–≥—Ä–æ–∑—ã
        return ThreatLevel.LOW
    
    def _get_threat_description(self, threat_type: ThreatType) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —É–≥—Ä–æ–∑—ã"""
        descriptions = {
            ThreatType.MALICIOUS_IMPORT: "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π",
            ThreatType.SYSTEM_COMMAND: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥",
            ThreatType.FILE_ACCESS: "–î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ",
            ThreatType.NETWORK_REQUEST: "–°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã",
            ThreatType.CODE_INJECTION: "–ò–Ω—ä–µ–∫—Ü–∏—è –∫–æ–¥–∞",
            ThreatType.PRIVILEGE_ESCALATION: "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π",
            ThreatType.DATA_EXFILTRATION: "–í–æ–∑–º–æ–∂–Ω–∞—è —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö",
            ThreatType.BACKDOOR: "–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ backdoor",
            ThreatType.CRYPTO_MINING: "–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –∫—Ä–∏–ø—Ç–æ–º–∞–π–Ω–∏–Ω–≥"
        }
        return descriptions.get(threat_type, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É–≥—Ä–æ–∑–∞")
    
    def _get_threat_recommendation(self, threat_type: ThreatType) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é —É–≥—Ä–æ–∑—ã"""
        recommendations = {
            ThreatType.MALICIOUS_IMPORT: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π",
            ThreatType.SYSTEM_COMMAND: "–ò–∑–±–µ–≥–∞–π—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥",
            ThreatType.FILE_ACCESS: "–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ",
            ThreatType.NETWORK_REQUEST: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤",
            ThreatType.CODE_INJECTION: "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ eval() –∏–ª–∏ exec()",
            ThreatType.PRIVILEGE_ESCALATION: "–ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø–æ–≤—ã—à–∞—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏",
            ThreatType.DATA_EXFILTRATION: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö",
            ThreatType.BACKDOOR: "–£–¥–∞–ª–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥",
            ThreatType.CRYPTO_MINING: "–£–¥–∞–ª–∏—Ç–µ –∫–æ–¥, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –º–∞–π–Ω–∏–Ω–≥–æ–º"
        }
        return recommendations.get(threat_type, "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    
    def _calculate_risk_score(self, threats: List[SecurityThreat]) -> float:
        """–í—ã—á–∏—Å–ª—è–µ—Ç –æ–±—â–∏–π —Ä–∏—Å–∫ –º–æ–¥—É–ª—è"""
        if not threats:
            return 0.0
        
        total_score = 0.0
        total_weight = 0.0
        
        for threat in threats:
            weight = self.threat_weights.get(threat.threat_level, 0.1)
            total_score += weight * 100  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –∑–∞ —É–≥—Ä–æ–∑—É
            total_weight += weight
        
        if total_weight > 0:
            return min(100.0, total_score / total_weight)
        
        return 0.0
    
    def get_scan_summary(self, scan_result: ScanResult) -> Dict[str, any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        threat_counts = {}
        for threat in scan_result.threats_found:
            level = threat.threat_level.value
            threat_counts[level] = threat_counts.get(level, 0) + 1
        
        return {
            "module_name": scan_result.module_name,
            "is_safe": scan_result.is_safe,
            "risk_score": scan_result.risk_score,
            "total_threats": len(scan_result.threats_found),
            "threat_counts": threat_counts,
            "suspicious_patterns_count": len(scan_result.suspicious_patterns),
            "code_metrics": scan_result.code_metrics
        }



======================================================================

------------------------------ FILE: Systems/core/security/sandbox_manager.py ------------------------------
# core/security/sandbox_manager.py
"""
–°–∏—Å—Ç–µ–º–∞ sandbox –¥–ª—è –º–æ–¥—É–ª–µ–π
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –º–æ–¥—É–ª–µ–π
"""

import os
import sys
import tempfile
import shutil
from typing import Dict, List, Optional, Any, Callable
from pathlib import Path
from dataclasses import dataclass
from enum import Enum
from loguru import logger
import importlib.util

class SecurityLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π"""
    PARANOID = "paranoid"      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è
    STRICT = "strict"         # –°—Ç—Ä–æ–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    MODERATE = "moderate"     # –£–º–µ—Ä–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    PERMISSIVE = "permissive" # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

@dataclass
class ModulePermissions:
    """–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª—è"""
    can_access_database: bool = False
    can_access_cache: bool = False
    can_access_filesystem: bool = False
    can_make_network_requests: bool = False
    can_execute_system_commands: bool = False
    can_modify_user_data: bool = False
    can_access_admin_functions: bool = False
    max_memory_mb: int = 50
    max_execution_time_seconds: int = 30

@dataclass
class SandboxViolation:
    """–ù–∞—Ä—É—à–µ–Ω–∏–µ sandbox"""
    module_name: str
    violation_type: str
    details: str
    timestamp: float
    severity: str  # "low", "medium", "high", "critical"

class ModuleSandboxManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä sandbox –¥–ª—è –º–æ–¥—É–ª–µ–π"""
    
    def __init__(self, config):
        self.config = config
        self.sandbox_dir = config.core.project_data_path / "Security" / "sandbox"
        self.sandbox_dir.mkdir(parents=True, exist_ok=True)
        
        # –£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        self.security_levels = {
            SecurityLevel.PARANOID: ModulePermissions(
                can_access_database=False,
                can_access_cache=False,
                can_access_filesystem=False,
                can_make_network_requests=False,
                can_execute_system_commands=False,
                can_modify_user_data=False,
                can_access_admin_functions=False,
                max_memory_mb=10,
                max_execution_time_seconds=10
            ),
            SecurityLevel.STRICT: ModulePermissions(
                can_access_database=True,
                can_access_cache=True,
                can_access_filesystem=False,
                can_make_network_requests=False,
                can_execute_system_commands=False,
                can_modify_user_data=True,
                can_access_admin_functions=False,
                max_memory_mb=25,
                max_execution_time_seconds=20
            ),
            SecurityLevel.MODERATE: ModulePermissions(
                can_access_database=True,
                can_access_cache=True,
                can_access_filesystem=True,
                can_make_network_requests=True,
                can_execute_system_commands=False,
                can_modify_user_data=True,
                can_access_admin_functions=False,
                max_memory_mb=50,
                max_execution_time_seconds=30
            ),
            SecurityLevel.PERMISSIVE: ModulePermissions(
                can_access_database=True,
                can_access_cache=True,
                can_access_filesystem=True,
                can_make_network_requests=True,
                can_execute_system_commands=True,
                can_modify_user_data=True,
                can_access_admin_functions=True,
                max_memory_mb=100,
                max_execution_time_seconds=60
            )
        }
        
        # –ê–∫—Ç–∏–≤–Ω—ã–µ sandbox'—ã –º–æ–¥—É–ª–µ–π
        self.active_sandboxes: Dict[str, Dict] = {}
        
        # –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π
        self.violations: List[SandboxViolation] = []
        
        logger.info(f"[Security] ModuleSandboxManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å {len(self.security_levels)} —É—Ä–æ–≤–Ω—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    
    def create_sandbox(self, module_name: str, security_level: SecurityLevel) -> bool:
        """–°–æ–∑–¥–∞–µ—Ç sandbox –¥–ª—è –º–æ–¥—É–ª—è"""
        try:
            if module_name in self.active_sandboxes:
                logger.warning(f"[Security] Sandbox –¥–ª—è –º–æ–¥—É–ª—è {module_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return True
            
            permissions = self.security_levels[security_level]
            
            # –°–æ–∑–¥–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –º–æ–¥—É–ª—è
            module_sandbox_dir = self.sandbox_dir / module_name
            module_sandbox_dir.mkdir(exist_ok=True)
            
            # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
            self._create_virtual_filesystem(module_sandbox_dir, permissions)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ sandbox
            sandbox_info = {
                "module_name": module_name,
                "security_level": security_level.value,
                "permissions": permissions.__dict__,
                "sandbox_dir": str(module_sandbox_dir),
                "created_at": os.time.time(),
                "violations": []
            }
            
            self.active_sandboxes[module_name] = sandbox_info
            
            logger.info(f"[Security] –°–æ–∑–¥–∞–Ω sandbox –¥–ª—è –º–æ–¥—É–ª—è {module_name} —Å —É—Ä–æ–≤–Ω–µ–º {security_level.value}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è sandbox –¥–ª—è –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def _create_virtual_filesystem(self, sandbox_dir: Path, permissions: ModulePermissions):
        """–°–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è –º–æ–¥—É–ª—è"""
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ—Å—Ç—É–ø–∞
        if permissions.can_access_filesystem:
            # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
            (sandbox_dir / "files").mkdir(exist_ok=True)
            (sandbox_dir / "temp").mkdir(exist_ok=True)
        
        if permissions.can_access_database:
            # –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–≥–æ–º —Ä–µ–∂–∏–º–µ)
            (sandbox_dir / "db").mkdir(exist_ok=True)
        
        if permissions.can_access_cache:
            # –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—ç—à
            (sandbox_dir / "cache").mkdir(exist_ok=True)
    
    def check_permission(self, module_name: str, permission_type: str, **kwargs) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è"""
        try:
            if module_name not in self.active_sandboxes:
                logger.warning(f"[Security] Sandbox –¥–ª—è –º–æ–¥—É–ª—è {module_name} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return False
            
            sandbox_info = self.active_sandboxes[module_name]
            permissions = ModulePermissions(**sandbox_info["permissions"])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            permission_map = {
                "database": permissions.can_access_database,
                "cache": permissions.can_access_cache,
                "filesystem": permissions.can_access_filesystem,
                "network": permissions.can_make_network_requests,
                "system_commands": permissions.can_execute_system_commands,
                "user_data": permissions.can_modify_user_data,
                "admin_functions": permissions.can_access_admin_functions
            }
            
            has_permission = permission_map.get(permission_type, False)
            
            if not has_permission:
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ
                violation = SandboxViolation(
                    module_name=module_name,
                    violation_type=f"permission_denied_{permission_type}",
                    details=f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ {permission_type} –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è",
                    timestamp=os.time.time(),
                    severity="medium"
                )
                self._record_violation(violation)
            
            return has_permission
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def _record_violation(self, violation: SandboxViolation):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ sandbox"""
        self.violations.append(violation)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ sandbox
        if violation.module_name in self.active_sandboxes:
            self.active_sandboxes[violation.module_name]["violations"].append(violation.__dict__)
        
        logger.warning(f"[Security] –ù–∞—Ä—É—à–µ–Ω–∏–µ sandbox: {violation.module_name} - {violation.violation_type} ({violation.severity})")
    
    def get_module_permissions(self, module_name: str) -> Optional[ModulePermissions]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª—è"""
        if module_name not in self.active_sandboxes:
            return None
        
        sandbox_info = self.active_sandboxes[module_name]
        return ModulePermissions(**sandbox_info["permissions"])
    
    def update_security_level(self, module_name: str, new_level: SecurityLevel) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è"""
        try:
            if module_name not in self.active_sandboxes:
                logger.error(f"[Security] Sandbox –¥–ª—è –º–æ–¥—É–ª—è {module_name} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return False
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            new_permissions = self.security_levels[new_level]
            self.active_sandboxes[module_name]["security_level"] = new_level.value
            self.active_sandboxes[module_name]["permissions"] = new_permissions.__dict__
            
            logger.info(f"[Security] –û–±–Ω–æ–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è {module_name} –Ω–∞ {new_level.value}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def destroy_sandbox(self, module_name: str) -> bool:
        """–£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç sandbox –º–æ–¥—É–ª—è"""
        try:
            if module_name not in self.active_sandboxes:
                return True
            
            # –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é sandbox
            sandbox_info = self.active_sandboxes[module_name]
            sandbox_dir = Path(sandbox_info["sandbox_dir"])
            
            if sandbox_dir.exists():
                shutil.rmtree(sandbox_dir)
            
            # –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö sandbox'–æ–≤
            del self.active_sandboxes[module_name]
            
            logger.info(f"[Security] –£–Ω–∏—á—Ç–æ–∂–µ–Ω sandbox –º–æ–¥—É–ª—è {module_name}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è sandbox –º–æ–¥—É–ª—è {module_name}: {e}")
            return False
    
    def get_violations(self, module_name: Optional[str] = None) -> List[SandboxViolation]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞—Ä—É—à–µ–Ω–∏–π"""
        if module_name:
            return [v for v in self.violations if v.module_name == module_name]
        return self.violations.copy()
    
    def get_sandbox_status(self, module_name: str) -> Optional[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å sandbox –º–æ–¥—É–ª—è"""
        return self.active_sandboxes.get(module_name)
    
    def list_active_sandboxes(self) -> Dict[str, Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö sandbox'–æ–≤"""
        return self.active_sandboxes.copy()



======================================================================

------------------------------ FILE: Systems/core/security/audit_logger.py ------------------------------
# core/security/audit_logger.py
"""
–°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç-–ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –º–æ–¥—É–ª–µ–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞
"""

import json
import time
from typing import Dict, List, Optional, Any
from pathlib import Path
from dataclasses import dataclass, asdict
from enum import Enum
from loguru import logger
from datetime import datetime

class AuditEventType(Enum):
    """–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞"""
    MODULE_LOAD = "module_load"
    MODULE_UNLOAD = "module_unload"
    COMMAND_EXECUTION = "command_execution"
    DATABASE_ACCESS = "database_access"
    FILE_ACCESS = "file_access"
    NETWORK_REQUEST = "network_request"
    SYSTEM_COMMAND = "system_command"
    USER_DATA_MODIFICATION = "user_data_modification"
    ADMIN_FUNCTION_ACCESS = "admin_function_access"
    SECURITY_VIOLATION = "security_violation"
    PERMISSION_CHECK = "permission_check"

class AuditSeverity(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π"""
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

@dataclass
class AuditEvent:
    """–°–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞"""
    event_id: str
    event_type: AuditEventType
    module_name: str
    user_id: Optional[int]
    timestamp: float
    severity: AuditSeverity
    details: Dict[str, Any]
    ip_address: Optional[str] = None
    user_agent: Optional[str] = None
    success: bool = True
    error_message: Optional[str] = None

class SecurityAuditLogger:
    """–õ–æ–≥–≥–µ—Ä –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    def __init__(self, config):
        self.config = config
        self.audit_dir = config.core.project_data_path / "Security" / "audit_logs"
        self.audit_dir.mkdir(parents=True, exist_ok=True)
        
        # –ë—É—Ñ–µ—Ä —Å–æ–±—ã—Ç–∏–π –¥–ª—è –±–∞—Ç—á–µ–≤–æ–π –∑–∞–ø–∏—Å–∏
        self.event_buffer: List[AuditEvent] = []
        self.buffer_size = 100
        self.buffer_timeout = 30  # —Å–µ–∫—É–Ω–¥
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
        self.event_stats = {
            "total_events": 0,
            "events_by_type": {},
            "events_by_severity": {},
            "events_by_module": {},
            "violations_count": 0
        }
        
        logger.info(f"[Security] SecurityAuditLogger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∞—É–¥–∏—Ç–∞: {self.audit_dir}")
    
    def log_event(self, 
                  event_type: AuditEventType,
                  module_name: str,
                  details: Dict[str, Any],
                  user_id: Optional[int] = None,
                  severity: AuditSeverity = AuditSeverity.MEDIUM,
                  success: bool = True,
                  error_message: Optional[str] = None,
                  ip_address: Optional[str] = None,
                  user_agent: Optional[str] = None) -> str:
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞"""
        
        event_id = self._generate_event_id()
        timestamp = time.time()
        
        event = AuditEvent(
            event_id=event_id,
            event_type=event_type,
            module_name=module_name,
            user_id=user_id,
            timestamp=timestamp,
            severity=severity,
            details=details,
            ip_address=ip_address,
            user_agent=user_agent,
            success=success,
            error_message=error_message
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä
        self.event_buffer.append(event)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self._update_stats(event)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –±—É—Ñ–µ—Ä
        if len(self.event_buffer) >= self.buffer_size:
            self._flush_buffer()
        
        logger.debug(f"[Security] –ó–∞–ø–∏—Å–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞: {event_type.value} –æ—Ç –º–æ–¥—É–ª—è {module_name}")
        return event_id
    
    def _generate_event_id(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–±—ã—Ç–∏—è"""
        timestamp = int(time.time() * 1000)
        return f"AUDIT_{timestamp}_{len(self.event_buffer)}"
    
    def _update_stats(self, event: AuditEvent):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–±—ã—Ç–∏–π"""
        self.event_stats["total_events"] += 1
        
        # –ü–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
        event_type = event.event_type.value
        self.event_stats["events_by_type"][event_type] = self.event_stats["events_by_type"].get(event_type, 0) + 1
        
        # –ü–æ —É—Ä–æ–≤–Ω—è–º —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
        severity = event.severity.value
        self.event_stats["events_by_severity"][severity] = self.event_stats["events_by_severity"].get(severity, 0) + 1
        
        # –ü–æ –º–æ–¥—É–ª—è–º
        module_name = event.module_name
        self.event_stats["events_by_module"][module_name] = self.event_stats["events_by_module"].get(module_name, 0) + 1
        
        # –ù–∞—Ä—É—à–µ–Ω–∏—è
        if event.event_type == AuditEventType.SECURITY_VIOLATION:
            self.event_stats["violations_count"] += 1
    
    def _flush_buffer(self):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –±—É—Ñ–µ—Ä —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–∞–π–ª"""
        if not self.event_buffer:
            return
        
        try:
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
            today = datetime.now().strftime("%Y-%m-%d")
            audit_file = self.audit_dir / f"audit_{today}.jsonl"
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSONL
            with open(audit_file, 'a', encoding='utf-8') as f:
                for event in self.event_buffer:
                    event_dict = asdict(event)
                    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º enum –≤ —Å—Ç—Ä–æ–∫–∏
                    event_dict["event_type"] = event.event_type.value
                    event_dict["severity"] = event.severity.value
                    f.write(json.dumps(event_dict, ensure_ascii=False) + '\n')
            
            logger.debug(f"[Security] –ó–∞–ø–∏—Å–∞–Ω–æ {len(self.event_buffer)} —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞ –≤ {audit_file}")
            
            # –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
            self.event_buffer.clear()
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –±—É—Ñ–µ—Ä–∞ –∞—É–¥–∏—Ç–∞: {e}")
    
    def log_module_load(self, module_name: str, module_path: str, signature_valid: bool, signer_id: Optional[str] = None):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥—É–ª—è"""
        details = {
            "module_path": module_path,
            "signature_valid": signature_valid,
            "signer_id": signer_id
        }
        
        severity = AuditSeverity.HIGH if not signature_valid else AuditSeverity.MEDIUM
        
        return self.log_event(
            event_type=AuditEventType.MODULE_LOAD,
            module_name=module_name,
            details=details,
            severity=severity,
            success=signature_valid
        )
    
    def log_command_execution(self, module_name: str, command: str, user_id: int, success: bool = True, error_message: Optional[str] = None):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"""
        details = {
            "command": command,
            "user_id": user_id
        }
        
        return self.log_event(
            event_type=AuditEventType.COMMAND_EXECUTION,
            module_name=module_name,
            details=details,
            user_id=user_id,
            severity=AuditSeverity.MEDIUM,
            success=success,
            error_message=error_message
        )
    
    def log_database_access(self, module_name: str, operation: str, table: str, user_id: Optional[int] = None, success: bool = True):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
        details = {
            "operation": operation,
            "table": table
        }
        
        return self.log_event(
            event_type=AuditEventType.DATABASE_ACCESS,
            module_name=module_name,
            details=details,
            user_id=user_id,
            severity=AuditSeverity.MEDIUM,
            success=success
        )
    
    def log_security_violation(self, module_name: str, violation_type: str, details: Dict[str, Any], user_id: Optional[int] = None):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        return self.log_event(
            event_type=AuditEventType.SECURITY_VIOLATION,
            module_name=module_name,
            details={
                "violation_type": violation_type,
                **details
            },
            user_id=user_id,
            severity=AuditSeverity.HIGH,
            success=False
        )
    
    def get_events(self, 
                   module_name: Optional[str] = None,
                   event_type: Optional[AuditEventType] = None,
                   severity: Optional[AuditSeverity] = None,
                   start_time: Optional[float] = None,
                   end_time: Optional[float] = None,
                   limit: int = 1000) -> List[AuditEvent]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
        
        # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä
        self._flush_buffer()
        
        events = []
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∞—É–¥–∏—Ç–∞
            audit_files = sorted(self.audit_dir.glob("audit_*.jsonl"), reverse=True)
            
            for audit_file in audit_files:
                if len(events) >= limit:
                    break
                
                with open(audit_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        if len(events) >= limit:
                            break
                        
                        try:
                            event_data = json.loads(line.strip())
                            
                            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                            if module_name and event_data.get("module_name") != module_name:
                                continue
                            
                            if event_type and event_data.get("event_type") != event_type.value:
                                continue
                            
                            if severity and event_data.get("severity") != severity.value:
                                continue
                            
                            if start_time and event_data.get("timestamp", 0) < start_time:
                                continue
                            
                            if end_time and event_data.get("timestamp", 0) > end_time:
                                continue
                            
                            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è
                            event = AuditEvent(
                                event_id=event_data["event_id"],
                                event_type=AuditEventType(event_data["event_type"]),
                                module_name=event_data["module_name"],
                                user_id=event_data.get("user_id"),
                                timestamp=event_data["timestamp"],
                                severity=AuditSeverity(event_data["severity"]),
                                details=event_data["details"],
                                ip_address=event_data.get("ip_address"),
                                user_agent=event_data.get("user_agent"),
                                success=event_data.get("success", True),
                                error_message=event_data.get("error_message")
                            )
                            
                            events.append(event)
                            
                        except Exception as e:
                            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞: {e}")
                            continue
        
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞: {e}")
        
        return events
    
    def get_statistics(self) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞"""
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        self._flush_buffer()
        
        return self.event_stats.copy()
    
    def cleanup_old_logs(self, days_to_keep: int = 30):
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞"""
        try:
            cutoff_time = time.time() - (days_to_keep * 24 * 60 * 60)
            
            for audit_file in self.audit_dir.glob("audit_*.jsonl"):
                if audit_file.stat().st_mtime < cutoff_time:
                    audit_file.unlink()
                    logger.info(f"[Security] –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∞—É–¥–∏—Ç–∞: {audit_file}")
        
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞: {e}")
    
    def force_flush(self):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –±—É—Ñ–µ—Ä"""
        self._flush_buffer()



======================================================================

------------------------------ FILE: Systems/core/security/anomaly_detection.py ------------------------------
# core/security/anomaly_detection.py
"""
–°–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π
–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤—ã—è–≤–ª—è–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
"""

import time
import json
from typing import Dict, List, Optional, Tuple, Set
from pathlib import Path
from dataclasses import dataclass
from enum import Enum
from collections import defaultdict, deque
from loguru import logger
from datetime import datetime, timedelta

class AnomalyType(Enum):
    """–¢–∏–ø—ã –∞–Ω–æ–º–∞–ª–∏–π"""
    FREQUENT_COMMANDS = "frequent_commands"           # –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã
    UNUSUAL_PATTERNS = "unusual_patterns"            # –ù–µ–æ–±—ã—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    SUSPICIOUS_TIMING = "suspicious_timing"          # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    RESOURCE_ABUSE = "resource_abuse"                # –ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
    DATA_EXFILTRATION = "data_exfiltration"          # –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ —É—Ç–µ—á–∫—É –¥–∞–Ω–Ω—ã—Ö
    PRIVILEGE_ESCALATION = "privilege_escalation"    # –ü–æ–ø—ã—Ç–∫–∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
    NETWORK_ANOMALY = "network_anomaly"              # –ê–Ω–æ–º–∞–ª—å–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    FILE_ACCESS_ANOMALY = "file_access_anomaly"      # –ê–Ω–æ–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º

class AnomalySeverity(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∞–Ω–æ–º–∞–ª–∏–π"""
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

@dataclass
class AnomalyDetection:
    """–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è"""
    anomaly_id: str
    anomaly_type: AnomalyType
    severity: AnomalySeverity
    module_name: str
    user_id: Optional[int]
    timestamp: float
    description: str
    evidence: Dict[str, any]
    confidence: float  # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ (0-1)
    auto_blocked: bool = False

@dataclass
class BehaviorPattern:
    """–ü–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤–µ–¥–µ–Ω–∏—è"""
    module_name: str
    user_id: Optional[int]
    pattern_type: str
    frequency: int
    time_window: int  # —Å–µ–∫—É–Ω–¥—ã
    last_seen: float

class AnomalyDetector:
    """–î–µ—Ç–µ–∫—Ç–æ—Ä –∞–Ω–æ–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è"""
    
    def __init__(self, config):
        self.config = config
        self.anomaly_dir = config.core.project_data_path / "Security" / "anomaly_detection"
        self.anomaly_dir.mkdir(parents=True, exist_ok=True)
        
        # –ü–æ—Ä–æ–≥–∏ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π
        self.thresholds = {
            "max_commands_per_minute": 30,
            "max_commands_per_hour": 500,
            "max_file_access_per_minute": 20,
            "max_network_requests_per_minute": 10,
            "max_database_queries_per_minute": 100,
            "suspicious_hours": [0, 1, 2, 3, 4, 5],  # –ù–æ—á–Ω—ã–µ —á–∞—Å—ã
            "unusual_pattern_threshold": 0.7
        }
        
        # –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π
        self.activity_history: Dict[str, deque] = defaultdict(lambda: deque(maxlen=1000))
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è
        self.behavior_patterns: Dict[str, List[BehaviorPattern]] = defaultdict(list)
        
        # –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏
        self.detected_anomalies: List[AnomalyDetection] = []
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_anomalies": 0,
            "anomalies_by_type": defaultdict(int),
            "anomalies_by_severity": defaultdict(int),
            "auto_blocked_modules": set()
        }
        
        logger.info(f"[Security] AnomalyDetector –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å {len(self.thresholds)} –ø–æ—Ä–æ–≥–∞–º–∏")
    
    def analyze_activity(self, 
                        module_name: str,
                        activity_type: str,
                        user_id: Optional[int] = None,
                        details: Optional[Dict] = None) -> List[AnomalyDetection]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥—É–ª—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∞–Ω–æ–º–∞–ª–∏–π"""
        
        timestamp = time.time()
        activity_key = f"{module_name}:{user_id or 'system'}"
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        activity_record = {
            "timestamp": timestamp,
            "activity_type": activity_type,
            "module_name": module_name,
            "user_id": user_id,
            "details": details or {}
        }
        
        self.activity_history[activity_key].append(activity_record)
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞ –∞–Ω–æ–º–∞–ª–∏–∏
        anomalies = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–æ—Ç—É –∫–æ–º–∞–Ω–¥
        command_anomalies = self._detect_frequent_commands(activity_key, timestamp)
        anomalies.extend(command_anomalies)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        timing_anomalies = self._detect_suspicious_timing(activity_key, timestamp)
        anomalies.extend(timing_anomalies)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—ã—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        pattern_anomalies = self._detect_unusual_patterns(activity_key, activity_record)
        anomalies.extend(pattern_anomalies)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
        resource_anomalies = self._detect_resource_abuse(activity_key, activity_record)
        anomalies.extend(resource_anomalies)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        for anomaly in anomalies:
            self._update_stats(anomaly)
        
        return anomalies
    
    def _detect_frequent_commands(self, activity_key: str, timestamp: float) -> List[AnomalyDetection]:
        """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã"""
        anomalies = []
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        recent_activities = [
            activity for activity in self.activity_history[activity_key]
            if timestamp - activity["timestamp"] <= 60  # –ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–Ω—É—Ç–∞
        ]
        
        command_count = len([a for a in recent_activities if a["activity_type"] == "command"])
        
        if command_count > self.thresholds["max_commands_per_minute"]:
            anomaly = AnomalyDetection(
                anomaly_id=f"freq_cmd_{int(timestamp)}",
                anomaly_type=AnomalyType.FREQUENT_COMMANDS,
                severity=AnomalySeverity.HIGH,
                module_name=activity_key.split(":")[0],
                user_id=int(activity_key.split(":")[1]) if activity_key.split(":")[1] != "system" else None,
                timestamp=timestamp,
                description=f"–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã: {command_count} –∑–∞ –º–∏–Ω—É—Ç—É",
                evidence={
                    "command_count": command_count,
                    "threshold": self.thresholds["max_commands_per_minute"],
                    "time_window": "1 minute"
                },
                confidence=min(1.0, command_count / self.thresholds["max_commands_per_minute"])
            )
            anomalies.append(anomaly)
        
        return anomalies
    
    def _detect_suspicious_timing(self, activity_key: str, timestamp: float) -> List[AnomalyDetection]:
        """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        anomalies = []
        
        current_hour = datetime.fromtimestamp(timestamp).hour
        
        if current_hour in self.thresholds["suspicious_hours"]:
            anomaly = AnomalyDetection(
                anomaly_id=f"susp_timing_{int(timestamp)}",
                anomaly_type=AnomalyType.SUSPICIOUS_TIMING,
                severity=AnomalySeverity.MEDIUM,
                module_name=activity_key.split(":")[0],
                user_id=int(activity_key.split(":")[1]) if activity_key.split(":")[1] != "system" else None,
                timestamp=timestamp,
                description=f"–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: {current_hour}:00",
                evidence={
                    "hour": current_hour,
                    "suspicious_hours": self.thresholds["suspicious_hours"]
                },
                confidence=0.6
            )
            anomalies.append(anomaly)
        
        return anomalies
    
    def _detect_unusual_patterns(self, activity_key: str, activity_record: Dict) -> List[AnomalyDetection]:
        """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–µ–æ–±—ã—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è"""
        anomalies = []
        
        module_name = activity_record["module_name"]
        activity_type = activity_record["activity_type"]
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è
        module_activities = [
            activity for activity in self.activity_history[activity_key]
            if activity["module_name"] == module_name
        ]
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        activity_counts = defaultdict(int)
        for activity in module_activities[-100:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π
            activity_counts[activity["activity_type"]] += 1
        
        total_activities = sum(activity_counts.values())
        if total_activities > 0:
            current_activity_ratio = activity_counts[activity_type] / total_activities
            
            # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —Ä–µ–¥–∫–æ
            if current_activity_ratio < 0.1 and total_activities > 10:
                anomaly = AnomalyDetection(
                    anomaly_id=f"unusual_pattern_{int(time.time())}",
                    anomaly_type=AnomalyType.UNUSUAL_PATTERNS,
                    severity=AnomalySeverity.MEDIUM,
                    module_name=module_name,
                    user_id=activity_record["user_id"],
                    timestamp=activity_record["timestamp"],
                    description=f"–ù–µ–æ–±—ã—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: {activity_type}",
                    evidence={
                        "activity_type": activity_type,
                        "ratio": current_activity_ratio,
                        "total_activities": total_activities,
                        "activity_counts": dict(activity_counts)
                    },
                    confidence=0.7
                )
                anomalies.append(anomaly)
        
        return anomalies
    
    def _detect_resource_abuse(self, activity_key: str, activity_record: Dict) -> List[AnomalyDetection]:
        """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏"""
        anomalies = []
        
        timestamp = activity_record["timestamp"]
        activity_type = activity_record["activity_type"]
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        recent_activities = [
            activity for activity in self.activity_history[activity_key]
            if timestamp - activity["timestamp"] <= 60  # –ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–Ω—É—Ç–∞
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Ä–µ—Å—É—Ä—Å–æ–≤
        resource_checks = {
            "file_access": ("file_access", self.thresholds["max_file_access_per_minute"]),
            "network_request": ("network_request", self.thresholds["max_network_requests_per_minute"]),
            "database_query": ("database_query", self.thresholds["max_database_queries_per_minute"])
        }
        
        for resource_type, (check_type, threshold) in resource_checks.items():
            count = len([a for a in recent_activities if a["activity_type"] == check_type])
            
            if count > threshold:
                anomaly = AnomalyDetection(
                    anomaly_id=f"resource_abuse_{resource_type}_{int(timestamp)}",
                    anomaly_type=AnomalyType.RESOURCE_ABUSE,
                    severity=AnomalySeverity.HIGH,
                    module_name=activity_key.split(":")[0],
                    user_id=int(activity_key.split(":")[1]) if activity_key.split(":")[1] != "system" else None,
                    timestamp=timestamp,
                    description=f"–ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ {resource_type}: {count} –∑–∞ –º–∏–Ω—É—Ç—É",
                    evidence={
                        "resource_type": resource_type,
                        "count": count,
                        "threshold": threshold,
                        "time_window": "1 minute"
                    },
                    confidence=min(1.0, count / threshold)
                )
                anomalies.append(anomaly)
        
        return anomalies
    
    def _update_stats(self, anomaly: AnomalyDetection):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–Ω–æ–º–∞–ª–∏–π"""
        self.stats["total_anomalies"] += 1
        self.stats["anomalies_by_type"][anomaly.anomaly_type.value] += 1
        self.stats["anomalies_by_severity"][anomaly.severity.value] += 1
        
        if anomaly.auto_blocked:
            self.stats["auto_blocked_modules"].add(anomaly.module_name)
        
        self.detected_anomalies.append(anomaly)
    
    def should_block_module(self, module_name: str, user_id: Optional[int] = None) -> Tuple[bool, str]:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å"""
        activity_key = f"{module_name}:{user_id or 'system'}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
        recent_anomalies = [
            anomaly for anomaly in self.detected_anomalies
            if anomaly.module_name == module_name and 
               time.time() - anomaly.timestamp <= 3600  # –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
        ]
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏
        critical_anomalies = [a for a in recent_anomalies if a.severity == AnomalySeverity.CRITICAL]
        if critical_anomalies:
            return True, f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã: {len(critical_anomalies)}"
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –º–Ω–æ–≥–æ –≤—ã—Å–æ–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π
        high_anomalies = [a for a in recent_anomalies if a.severity == AnomalySeverity.HIGH]
        if len(high_anomalies) >= 3:
            return True, f"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—ã—Å–æ–∫–∏—Ö –∞–Ω–æ–º–∞–ª–∏–π: {len(high_anomalies)}"
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –º–æ–¥—É–ª—å —É–∂–µ –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
        if module_name in self.stats["auto_blocked_modules"]:
            return True, "–ú–æ–¥—É–ª—å –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ"
        
        return False, "–ú–æ–¥—É–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω"
    
    def get_anomaly_statistics(self) -> Dict[str, any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–Ω–æ–º–∞–ª–∏–π"""
        return {
            "total_anomalies": self.stats["total_anomalies"],
            "anomalies_by_type": dict(self.stats["anomalies_by_type"]),
            "anomalies_by_severity": dict(self.stats["anomalies_by_severity"]),
            "auto_blocked_modules": list(self.stats["auto_blocked_modules"]),
            "active_modules": len(self.activity_history),
            "thresholds": self.thresholds
        }
    
    def get_recent_anomalies(self, hours: int = 24) -> List[AnomalyDetection]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏"""
        cutoff_time = time.time() - (hours * 3600)
        return [
            anomaly for anomaly in self.detected_anomalies
            if anomaly.timestamp >= cutoff_time
        ]
    
    def clear_old_data(self, days_to_keep: int = 30):
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        cutoff_time = time.time() - (days_to_keep * 24 * 3600)
        
        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        for activity_key in list(self.activity_history.keys()):
            activities = self.activity_history[activity_key]
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
            while activities and activities[0]["timestamp"] < cutoff_time:
                activities.popleft()
            
            # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª—é—á–∏
            if not activities:
                del self.activity_history[activity_key]
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏
        self.detected_anomalies = [
            anomaly for anomaly in self.detected_anomalies
            if anomaly.timestamp >= cutoff_time
        ]
        
        logger.info(f"[Security] –û—á–∏—â–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–π —Å—Ç–∞—Ä—à–µ {days_to_keep} –¥–Ω–µ–π")



======================================================================

------------------------------ FILE: Systems/core/security/signature_manager.py ------------------------------
# core/security/signature_manager.py
"""
–°–∏—Å—Ç–µ–º–∞ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π –º–æ–¥—É–ª–µ–π
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
"""

import os
import json
import time
from typing import Dict, List, Optional, Tuple
from pathlib import Path
from dataclasses import dataclass
from loguru import logger

from .crypto_manager import CryptoManager, DigitalSignature

@dataclass
class SignatureVerificationResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏"""
    is_valid: bool
    is_trusted: bool
    error_message: Optional[str] = None
    signer_reputation: Optional[str] = None
    key_id: Optional[str] = None

class ModuleSignatureManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π –º–æ–¥—É–ª–µ–π —Å –Ω–∞—Å—Ç–æ—è—â–µ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π"""
    
    def __init__(self, config):
        self.config = config
        self.signatures_dir = config.core.project_data_path / "Security" / "signatures"
        self.trusted_keys_dir = config.core.project_data_path / "Security" / "trusted_keys"
        self.signatures_dir.mkdir(parents=True, exist_ok=True)
        self.trusted_keys_dir.mkdir(parents=True, exist_ok=True)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        self.crypto_manager = CryptoManager(config)
        
        # –°–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤
        self.trusted_signers = self._load_trusted_signers()
        
        logger.info(f"[Security] ModuleSignatureManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π. –î–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤: {len(self.trusted_signers)}")
    
    def _load_trusted_signers(self) -> Dict[str, Dict]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤"""
        trusted_file = self.trusted_keys_dir / "trusted_signers.json"
        
        if trusted_file.exists():
            try:
                with open(trusted_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤: {e}")
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤
        default_trusted = {
            "sdb_core_team": {
                "name": "SDB Core Team",
                "email": "core@sdb.dev",
                "key_id": "SDB-CORE-2024",
                "reputation": "trusted",
                "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ SDB"
            }
        }
        
        self._save_trusted_signers(default_trusted)
        return default_trusted
    
    def _save_trusted_signers(self, signers: Dict[str, Dict]):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤"""
        trusted_file = self.trusted_keys_dir / "trusted_signers.json"
        
        try:
            with open(trusted_file, 'w', encoding='utf-8') as f:
                json.dump(signers, f, indent=2, ensure_ascii=False)
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤: {e}")
    
    def calculate_file_hash(self, file_path: Path) -> str:
        """–í—ã—á–∏—Å–ª—è–µ—Ç —Ö—ç—à —Ñ–∞–π–ª–∞"""
        try:
            with open(file_path, 'rb') as f:
                file_content = f.read()
                return hashlib.sha256(file_content).hexdigest()
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ö—ç—à–∞ —Ñ–∞–π–ª–∞ {file_path}: {e}")
            return ""
    
    def sign_module(self, module_path: Path, key_id: str) -> bool:
        """–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏"""
        try:
            if not module_path.exists():
                logger.error(f"[Security] –§–∞–π–ª –º–æ–¥—É–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω: {module_path}")
                return False
            
            # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –º–æ–¥—É–ª—å
            digital_signature = self.crypto_manager.sign_module(module_path, key_id)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–ø–∏—Å—å
            signature_file = self.signatures_dir / f"{module_path.stem}.sig"
            signature_data = {
                "module_name": digital_signature.module_name,
                "version": digital_signature.version,
                "file_hash": digital_signature.file_hash,
                "signature": digital_signature.signature.hex(),  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ hex –¥–ª—è JSON
                "signer_key_id": digital_signature.signer_key_id,
                "timestamp": digital_signature.timestamp,
                "algorithm": digital_signature.algorithm
            }
            
            with open(signature_file, 'w', encoding='utf-8') as f:
                json.dump(signature_data, f, indent=2, ensure_ascii=False)
            
            logger.info(f"[Security] –ú–æ–¥—É–ª—å {module_path.stem} —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω –∫–ª—é—á–æ–º {key_id}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è {module_path}: {e}")
            return False
    
    def _generate_signature(self, data: Dict, private_key_path: Optional[Path] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç GPG –ø–æ–¥–ø–∏—Å—å
        # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ö—ç—à –æ—Ç –¥–∞–Ω–Ω—ã—Ö
        data_str = json.dumps(data, sort_keys=True)
        return hashlib.sha256(data_str.encode()).hexdigest()
    
    def verify_signature(self, module_path: Path) -> SignatureVerificationResult:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏"""
        try:
            signature_file = self.signatures_dir / f"{module_path.stem}.sig"
            
            if not signature_file.exists():
                return SignatureVerificationResult(
                    is_valid=False,
                    is_trusted=False,
                    error_message="–ü–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
                )
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å—å
            with open(signature_file, 'r', encoding='utf-8') as f:
                signature_data = json.load(f)
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏
            digital_signature = DigitalSignature(
                module_name=signature_data["module_name"],
                version=signature_data["version"],
                file_hash=signature_data["file_hash"],
                signature=bytes.fromhex(signature_data["signature"]),  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ hex
                signer_key_id=signature_data["signer_key_id"],
                timestamp=signature_data["timestamp"],
                algorithm=signature_data["algorithm"]
            )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            is_valid = self.crypto_manager.verify_module_signature(module_path, digital_signature)
            
            if not is_valid:
                return SignatureVerificationResult(
                    is_valid=False,
                    is_trusted=False,
                    error_message="–ü–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞",
                    key_id=digital_signature.signer_key_id
                )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º
            key_id = digital_signature.signer_key_id
            is_trusted = key_id in self.trusted_signers
            
            return SignatureVerificationResult(
                is_valid=True,
                is_trusted=is_trusted,
                signer_reputation=self.trusted_signers.get(key_id, {}).get("reputation") if is_trusted else None,
                key_id=key_id
            )
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª—è {module_path}: {e}")
            return SignatureVerificationResult(
                is_valid=False,
                is_trusted=False,
                error_message=f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏: {e}"
            )
    
    def add_trusted_signer(self, signer_id: str, signer_info: Dict) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞"""
        try:
            self.trusted_signers[signer_id] = signer_info
            self._save_trusted_signers(self.trusted_signers)
            logger.info(f"[Security] –î–æ–±–∞–≤–ª–µ–Ω –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–¥–ø–∏—Å–∞–Ω—Ç: {signer_id}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ {signer_id}: {e}")
            return False
    
    def remove_trusted_signer(self, signer_id: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞"""
        try:
            if signer_id in self.trusted_signers:
                del self.trusted_signers[signer_id]
                self._save_trusted_signers(self.trusted_signers)
                logger.info(f"[Security] –£–¥–∞–ª–µ–Ω –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–¥–ø–∏—Å–∞–Ω—Ç: {signer_id}")
                return True
            return False
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ {signer_id}: {e}")
            return False
    
    def list_trusted_signers(self) -> Dict[str, Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤"""
        return self.trusted_signers.copy()
    
    def get_module_signature_info(self, module_name: str) -> Optional[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª—è"""
        signature_file = self.signatures_dir / f"{module_name}.sig"
        
        if not signature_file.exists():
            return None
        
        try:
            with open(signature_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª—è {module_name}: {e}")
            return None
    
    def generate_signing_key(self, key_id: str, key_size: int = 2048) -> bool:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è"""
        try:
            self.crypto_manager.generate_key_pair(key_id, key_size)
            logger.info(f"[Security] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞—Ä–∞ –∫–ª—é—á–µ–π –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è: {key_id}")
            return True
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π {key_id}: {e}")
            return False
    
    def export_public_key(self, key_id: str) -> Optional[bytes]:
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"""
        try:
            return self.crypto_manager.export_public_key(key_id)
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ {key_id}: {e}")
            return None
    
    def import_trusted_public_key(self, key_id: str, public_key_pem: bytes) -> bool:
        """–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"""
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key_file = self.trusted_keys_dir / f"{key_id}.public"
            with open(public_key_file, 'wb') as f:
                f.write(public_key_pem)
            os.chmod(public_key_file, 0o644)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö
            self.trusted_signers[key_id] = {
                "name": f"Imported Key {key_id}",
                "email": "unknown@example.com",
                "key_id": key_id,
                "reputation": "trusted",
                "description": "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –∫–ª—é—á",
                "imported_at": time.time()
            }
            
            self._save_trusted_signers(self.trusted_signers)
            
            logger.info(f"[Security] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á: {key_id}")
            return True
            
        except Exception as e:
            logger.error(f"[Security] –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ {key_id}: {e}")
            return False
    
    def list_available_keys(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª—é—á–µ–π"""
        return self.crypto_manager.list_available_keys()



======================================================================

------------------------------ FILE: Systems/core/security/input_validator.py ------------------------------
# core/security/input_validator.py
"""
–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ middleware
"""

import re
from typing import Optional, Dict, Any, List, Callable, Tuple
from loguru import logger

from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, Update, Message
from aiogram.filters import Command

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider


class InputValidator:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    """
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    DANGEROUS_PATTERNS = [
        (r'<script[^>]*>.*?</script>', 'XSS —Å–∫—Ä–∏–ø—Ç'),
        (r'javascript:', 'JavaScript –ø—Ä–æ—Ç–æ–∫–æ–ª'),
        (r'on\w+\s*=', 'HTML —Å–æ–±—ã—Ç–∏–µ'),
        (r'data:text/html', 'HTML data URI'),
        (r'eval\s*\(', 'eval —Ñ—É–Ω–∫—Ü–∏—è'),
        (r'exec\s*\(', 'exec —Ñ—É–Ω–∫—Ü–∏—è'),
        (r'__import__', '–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç'),
    ]
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –¥–ª–∏–Ω—ã
    MAX_MESSAGE_LENGTH = 4096  # –õ–∏–º–∏—Ç Telegram
    MAX_COMMAND_LENGTH = 100
    MAX_CALLBACK_DATA_LENGTH = 64
    
    def __init__(self):
        self._logger = logger.bind(service="InputValidator")
        self._compiled_patterns = [
            (re.compile(pattern, re.IGNORECASE | re.DOTALL), description)
            for pattern, description in self.DANGEROUS_PATTERNS
        ]
    
    def validate_message(self, text: Optional[str]) -> Tuple[bool, Optional[str]]:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Returns:
            Tuple[bool, Optional[str]]: (is_valid, error_message)
        """
        if not text:
            return True, None
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
        if len(text) > self.MAX_MESSAGE_LENGTH:
            return False, f"–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º {self.MAX_MESSAGE_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        for pattern, description in self._compiled_patterns:
            if pattern.search(text):
                self._logger.warning(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–ø–∞—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {description}")
                return False, f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç: {description}"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π (—Å–ø–∞–º)
        mention_count = text.count('@')
        if mention_count > 10:
            return False, "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã (—Ñ–ª—É–¥)
        if self._check_flood_pattern(text):
            return False, "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω —Ñ–ª—É–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏"
        
        return True, None
    
    def validate_command(self, command: str) -> Tuple[bool, Optional[str]]:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É"""
        if not command:
            return False, "–ü—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞"
        
        if len(command) > self.MAX_COMMAND_LENGTH:
            return False, f"–ö–æ–º–∞–Ω–¥–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è (–º–∞–∫—Å–∏–º—É–º {self.MAX_COMMAND_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)"
        
        # –ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å /
        if not command.startswith('/'):
            return False, "–ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å /"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if not re.match(r'^/[a-zA-Z0-9_]+(\s+.*)?$', command):
            return False, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∫–æ–º–∞–Ω–¥–µ"
        
        return True, None
    
    def validate_callback_data(self, callback_data: str) -> Tuple[bool, Optional[str]]:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç callback data"""
        if not callback_data:
            return False, "–ü—É—Å—Ç—ã–µ callback –¥–∞–Ω–Ω—ã–µ"
        
        if len(callback_data) > self.MAX_CALLBACK_DATA_LENGTH:
            return False, f"Callback data —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ (–º–∞–∫—Å–∏–º—É–º {self.MAX_CALLBACK_DATA_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if re.search(r'[<>"\']', callback_data):
            return False, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ callback data"
        
        return True, None
    
    def _check_flood_pattern(self, text: str, threshold: int = 5) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω —Ñ–ª—É–¥–∞ (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã)"""
        if len(text) < threshold * 2:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
        for i in range(len(text) - threshold):
            char = text[i]
            if text[i:i+threshold] == char * threshold:
                return True
        
        return False
    
    def sanitize_text(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
        # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
        text = re.sub(r'<[^>]+>', '', text)
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        text = text.replace('<', '&lt;').replace('>', '&gt;')
        return text


class InputValidationMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    """
    
    def __init__(self, validator: Optional[InputValidator] = None):
        super().__init__()
        self.validator = validator or InputValidator()
        self._logger = logger.bind(service="InputValidationMiddleware")
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è
        self._exempt_users: set = set()
    
    def exempt_user(self, user_id: int):
        """–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è"""
        self._exempt_users.add(user_id)
    
    async def __call__(
        self,
        handler,
        event: Update,
        data: Dict
    ):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        
        user = data.get("event_from_user")
        if user and user.id in self._exempt_users:
            return await handler(event, data)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        if event.message and event.message.text:
            is_valid, error_msg = self.validator.validate_message(event.message.text)
            if not is_valid:
                self._logger.warning(
                    f"–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id if user else 'unknown'}: {error_msg}"
                )
                try:
                    await event.message.answer(
                        f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {error_msg}\n"
                        f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
                    )
                except Exception as e:
                    self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
                return None
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        if event.message and event.message.text and event.message.text.startswith('/'):
            is_valid, error_msg = self.validator.validate_command(event.message.text)
            if not is_valid:
                self._logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç {user.id if user else 'unknown'}: {error_msg}")
                try:
                    await event.message.answer(f"‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {error_msg}")
                except Exception:
                    pass
                return None
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è callback query
        if event.callback_query and event.callback_query.data:
            is_valid, error_msg = self.validator.validate_callback_data(event.callback_query.data)
            if not is_valid:
                self._logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ callback data –æ—Ç {user.id if user else 'unknown'}: {error_msg}")
                try:
                    await event.callback_query.answer("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
                except Exception:
                    pass
                return None
        
        return await handler(event, data)




======================================================================

------------------------------ FILE: Systems/core/admin/filters_admin.py ------------------------------
# core/admin/filters_admin.py

from aiogram import types
from loguru import logger

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
from Systems.core.rbac.service import PERMISSION_CORE_VIEW_ADMIN_PANEL 

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

MODULE_NAME_FOR_LOG = "AdminFilters"

async def can_view_admin_panel_filter(event: types.TelegramObject, services_provider: 'BotServicesProvider') -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
    –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω, –µ—Å–ª–∏:
    1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ super_admins –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ PERMISSION_CORE_VIEW_ADMIN_PANEL.
    """
    user = getattr(event, 'from_user', None) 
    if not user: 
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–±—ã—Ç–∏–µ –±–µ–∑ 'from_user', –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return False

    user_id = user.id
    user_mention = f"@{user.username}" if user.username else f"ID:{user.id}"

    if user_id in services_provider.config.core.super_admins:
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (super_admin –∏–∑ config).")
        return True
    try:
        async with services_provider.db.get_session() as session:
            has_permission = await services_provider.rbac.user_has_permission(
                session, user_id, PERMISSION_CORE_VIEW_ADMIN_PANEL
            )
            if has_permission:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' (–¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω).")
                return True
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' –¥–ª—è {user_mention} –≤ –ë–î: {e}", exc_info=True)
        return False 
    
    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} "
                   f"–ø–æ–ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}'.")
    return False



======================================================================

------------------------------ FILE: Systems/core/admin/handlers_log_viewer.py ------------------------------
# core/admin/handlers_log_viewer.py
import logging
from aiogram import Router, types
from aiogram.filters import Command

router = Router()

@router.message(Command("some_command")) 
async def some_handler(message: types.Message):
    await message.answer("You triggered some_command!")


======================================================================

------------------------------ FILE: Systems/core/admin/__init__.py ------------------------------
# core/admin/__init__.py
from aiogram import Router
from loguru import logger

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
try:
    from .entry import section_entry_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'entry' (section router) loaded.")
except ImportError as e:
    section_entry_router = Router(name="sdb_admin_entry_stub_main") 
    logger.error(f"Failed to load admin submodule 'entry' (section router): {e}")

try:
    from .users import section_users_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'users' (section router) loaded.")
except ImportError as e:
    section_users_router = Router(name="sdb_admin_users_stub_main")
    logger.error(f"Failed to load admin submodule 'users' (section router): {e}")

try:
    from .roles import section_roles_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'roles' (section router) loaded.")
except ImportError as e:
    section_roles_router = Router(name="sdb_admin_roles_stub_main")
    logger.error(f"Failed to load admin submodule 'roles' (section router): {e}")

try:
    from .sys_info import section_sys_info_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'sys_info' (section router) loaded.")
except ImportError as e:
    section_sys_info_router = Router(name="sdb_admin_sys_info_stub_main")
    logger.error(f"Failed to load admin submodule 'sys_info' (section router): {e}")

try:
    from .modules_mgmt import section_modules_mgmt_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'modules_mgmt' (section router) loaded.")
except ImportError as e:
    section_modules_mgmt_router = Router(name="sdb_admin_modules_mgmt_stub_main")
    logger.error(f"Failed to load admin submodule 'modules_mgmt' (section router): {e}")

try:
    from .logs_viewer import section_logs_viewer_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'logs_viewer' (section router) loaded.")
except ImportError as e:
    section_logs_viewer_router = Router(name="sdb_admin_logs_viewer_stub_main")
    logger.error(f"Failed to load admin submodule 'logs_viewer' (section router): {e}")


# –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
admin_router = Router(name="sdb_admin_top_level_router") # –î–∞–µ–º –µ–º—É —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è

admin_router.include_router(section_entry_router)
admin_router.include_router(section_users_router)
admin_router.include_router(section_roles_router)
admin_router.include_router(section_sys_info_router)
admin_router.include_router(section_modules_mgmt_router)
admin_router.include_router(section_logs_viewer_router)

logger.success("Main admin_router composed from section routers.")

__all__ = ["admin_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/keyboards_admin_common.py ------------------------------
# core/admin/keyboards_admin_common.py
from aiogram import types 
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder 
from Systems.core.ui.callback_data_factories import CoreMenuNavigate, AdminMainMenuNavigate

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.i18n.translator import Translator
    from sqlalchemy.ext.asyncio import AsyncSession
    from Systems.core.rbac.service import (
        PERMISSION_CORE_USERS_VIEW_LIST,
        PERMISSION_CORE_MODULES_VIEW_LIST,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL,
        PERMISSION_CORE_ROLES_VIEW
    )

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è translator –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
_admin_translator_cache: Optional['Translator'] = None

def _get_admin_translator(services_provider: 'BotServicesProvider') -> 'Translator':
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç translator –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    global _admin_translator_cache
    if _admin_translator_cache is None:
        from Systems.core.i18n.translator import Translator
        _admin_translator_cache = Translator(
            locales_dir=services_provider.config.core.i18n.locales_dir,
            domain=services_provider.config.core.i18n.domain,
            default_locale=services_provider.config.core.i18n.default_locale,
            available_locales=services_provider.config.core.i18n.available_locales
        )
    return _admin_translator_cache

def get_admin_texts(services_provider: 'BotServicesProvider', locale: Optional[str] = None) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    if not locale:
        locale = services_provider.config.core.i18n.default_locale
    
    translator = _get_admin_translator(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    return {
        "admin_panel_title": t("admin_panel_title"),
        "admin_panel_select_section": t("admin_panel_select_section"),
        "admin_no_access": t("admin_no_access"),
        "admin_modules_in_development": t("admin_modules_in_development"),
        "back_to_main_menu_sdb": t("admin_back_to_main_menu_sdb"),
        "back_to_admin_menu_main": t("admin_back_to_admin_menu_main"),
        "pagination_prev": t("admin_pagination_prev"),
        "pagination_next": t("admin_pagination_next"),
        "confirm_yes": t("admin_confirm_yes"),
        "confirm_no": t("admin_confirm_no"),
        "close_message": t("admin_close_message"),
        "error_general": t("admin_error_general"),
        "access_denied": t("admin_access_denied"),
        "not_found_generic": t("admin_not_found_generic"),
        "system_info": t("admin_system_info"),
        "manage_modules": t("admin_manage_modules"),
        "manage_users": t("admin_manage_users"),
        "manage_roles": t("admin_manage_roles"),
        "perm_category_core": t("admin_perm_category_core"),
        "perm_category_modules": t("admin_perm_category_modules"),
        "perm_core_group_users": t("admin_perm_core_group_users"),
        "perm_core_group_roles": t("admin_perm_core_group_roles"),
        "perm_core_group_modules_core": t("admin_perm_core_group_modules_core"),
        "perm_core_group_system": t("admin_perm_core_group_system"),
        "perm_core_group_settings_core": t("admin_perm_core_group_settings_core"),
        "perm_core_group_other": t("admin_perm_core_group_other"),
        "back_to_perm_categories": t("admin_back_to_perm_categories"),
        "back_to_core_perm_groups": t("admin_back_to_core_perm_groups"),
        "back_to_module_list_for_perms": t("admin_back_to_module_list_for_perms"),
        "no_modules_with_perms": t("admin_no_modules_with_perms"),
        "no_permissions_in_group": t("admin_no_permissions_in_group"),
        "fsm_enter_role_name": t("admin_fsm_enter_role_name"),
        "fsm_role_name_empty": t("admin_fsm_role_name_empty"),
        "fsm_role_name_taken": t("admin_fsm_role_name_taken"),
        "fsm_enter_role_description": t("admin_fsm_enter_role_description"),
        "fsm_command_skip_description": t("admin_fsm_command_skip_description"),
        "fsm_command_cancel_role_creation": t("admin_fsm_command_cancel_role_creation"),
        "fsm_role_created_successfully": t("admin_fsm_role_created_successfully"),
        "fsm_role_creation_cancelled": t("admin_fsm_role_creation_cancelled"),
        "fsm_edit_role_title": t("admin_fsm_edit_role_title"),
        "fsm_edit_role_name_not_allowed": t("admin_fsm_edit_role_name_not_allowed"),
        "fsm_enter_new_role_description": t("admin_fsm_enter_new_role_description"),
        "fsm_enter_new_role_name": t("admin_fsm_enter_new_role_name"),
        "fsm_command_skip_name": t("admin_fsm_command_skip_name"),
        "fsm_command_cancel_role_edit": t("admin_fsm_command_cancel_role_edit"),
        "fsm_role_updated_successfully": t("admin_fsm_role_updated_successfully"),
        "fsm_role_update_cancelled": t("admin_fsm_role_update_cancelled"),
        "delete_role_confirm_text": t("admin_delete_role_confirm_text"),
        "role_is_standard_cant_delete": t("admin_role_is_standard_cant_delete"),
        "role_delete_failed": t("admin_role_delete_failed"),
        "role_deleted_successfully": t("admin_role_deleted_successfully"),
    }

# –°—Ç–∞—Ä—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (deprecated, –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω)
ADMIN_COMMON_TEXTS = {
    "back_to_main_menu_sdb": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB",
    "back_to_admin_menu_main": "‚¨ÖÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–ì–ª–∞–≤–Ω–∞—è)",
    "pagination_prev": "‚¨ÖÔ∏è –ü—Ä–µ–¥.",
    "pagination_next": "–°–ª–µ–¥. ‚û°Ô∏è",
    "confirm_yes": "‚úÖ –î–∞",
    "confirm_no": "‚ùå –ù–µ—Ç",
    "close_message": "‚ùå –ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ",
    "error_general": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
    "access_denied": "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.",
    "not_found_generic": "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.",
    
    # –¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏ - –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–µ –∏ –ª–æ–≥–∏—á–Ω–æ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
    "system_info": "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ",
    "manage_modules": "üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏", 
    "manage_users": "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
    "manage_roles": "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏",

    # –¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –≥—Ä—É–ø–ø —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω—ã)
    "perm_category_core": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ø–¥—Ä–∞",
    "perm_category_modules": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –ú–æ–¥—É–ª–µ–π",
    "perm_core_group_users": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–Ø–¥—Ä–æ)",
    "perm_core_group_roles": "–†–æ–ª–∏ (–Ø–¥—Ä–æ)",
    "perm_core_group_modules_core": "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–Ø–¥—Ä–æ)", # –ò–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    "perm_core_group_system": "–°–∏—Å—Ç–µ–º–∞ (–Ø–¥—Ä–æ)",
    "perm_core_group_settings_core": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞",
    "perm_core_group_other": "–ü—Ä–æ—á–∏–µ (–Ø–¥—Ä–æ)",
    "back_to_perm_categories": "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π",
    "back_to_core_perm_groups": "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞",
    "back_to_module_list_for_perms": "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π (–¥–ª—è –ø—Ä–∞–≤)",
    "no_modules_with_perms": "–ù–µ—Ç –º–æ–¥—É–ª–µ–π —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∞–≤",
    "no_permissions_in_group": "–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π",

    # –¢–µ–∫—Å—Ç—ã –¥–ª—è FSM (–¥–æ–±–∞–≤–ª–µ–Ω—ã)
    "fsm_enter_role_name": "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏:",
    "fsm_role_name_empty": "–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.",
    "fsm_role_name_taken": "–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º \"{role_name}\" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.",
    "fsm_enter_role_description": "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name}:",
    "fsm_command_skip_description": "/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
    "fsm_command_cancel_role_creation": "/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ",
    "fsm_role_created_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!",
    "fsm_role_creation_cancelled": "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
    
    "fsm_edit_role_title": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}",
    "fsm_edit_role_name_not_allowed": "–ò–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ {role_name} –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è.",
    "fsm_enter_new_role_description": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):",
    "fsm_enter_new_role_name": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):",
    "fsm_command_skip_name": "/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å",
    "fsm_command_cancel_role_edit": "/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
    "fsm_role_updated_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!",
    "fsm_role_update_cancelled": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",

    "delete_role_confirm_text": "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!",
    "role_is_standard_cant_delete": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å \"{role_name}\" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.",
    "role_delete_failed": "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å \"{role_name}\".",
    "role_deleted_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.",
}

def get_back_to_admin_main_menu_button(services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardButton:
    """–°–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏"""
    if services_provider:
        texts = get_admin_texts(services_provider, locale)
        text = texts["back_to_admin_menu_main"]
    else:
        text = ADMIN_COMMON_TEXTS["back_to_admin_menu_main"]
    return InlineKeyboardButton(
        text=text,
        callback_data=AdminMainMenuNavigate(target_section="main_admin").pack()
    )

def get_back_to_sdb_main_menu_button(services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardButton:
    """–°–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏"""
    if services_provider:
        texts = get_admin_texts(services_provider, locale)
        text = texts["back_to_main_menu_sdb"]
    else:
        text = ADMIN_COMMON_TEXTS["back_to_main_menu_sdb"]
    return InlineKeyboardButton(
        text=text,
        callback_data=CoreMenuNavigate(target_menu="main").pack()
    )

async def get_admin_main_menu_keyboard( 
    services: 'BotServicesProvider',
    user_tg_id: int,
    session: 'AsyncSession',
    locale: Optional[str] = None
) -> types.InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_tg_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                locale = db_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    texts = get_admin_texts(services, locale) 

    rbac = services.rbac
    user_is_owner_from_config = user_tg_id in services.config.core.super_admins

    from Systems.core.rbac.service import (
        PERMISSION_CORE_USERS_VIEW_LIST,
        PERMISSION_CORE_MODULES_VIEW_LIST,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL,
        PERMISSION_CORE_ROLES_VIEW
    )
    
    # –ë–õ–û–ö 1: –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–û–ô (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
    system_buttons = []
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC) or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL):
        system_buttons.append((texts["system_info"], AdminMainMenuNavigate(target_section="sys_info")))

    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_MODULES_VIEW_LIST):
        system_buttons.append((texts["manage_modules"], AdminMainMenuNavigate(target_section="modules")))
    
    # –ë–õ–û–ö 2: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò
    user_management_buttons = []
    
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_USERS_VIEW_LIST):
        user_management_buttons.append((texts["manage_users"], AdminMainMenuNavigate(target_section="users")))
    
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_ROLES_VIEW): 
        user_management_buttons.append((texts["manage_roles"], AdminMainMenuNavigate(target_section="roles")))

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    for text, callback_data in system_buttons:
        builder.button(text=text, callback_data=callback_data.pack())
    
    for text, callback_data in user_management_buttons:
        builder.button(text=text, callback_data=callback_data.pack())
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–≤–µ—Ä—Ö—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–Ω–∏–∑—É, –ø–æ –æ–¥–Ω–æ–π –≤ —Ä—è–¥ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    if builder.export(): 
        builder.adjust(1)

    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É
    builder.row(get_back_to_sdb_main_menu_button(services, locale)) 
    return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/admin/handlers_module_management.py ------------------------------
# core/admin/handlers_module_management.py
import logging
from aiogram import Router, types
from aiogram.filters import Command

router = Router()

@router.message(Command("some_command")) 
async def some_handler(message: types.Message):
    await message.answer("You triggered some_command!")


======================================================================

------------------------------ FILE: Systems/core/admin/modules_mgmt/keyboards_modules.py ------------------------------
# core/admin/modules_mgmt/keyboards_modules.py
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger
from typing import List, Dict, Any

from Systems.core.ui.callback_data_factories import AdminModulesPanelNavigate, AdminMainMenuNavigate
from Systems.core.admin.keyboards_admin_common import get_admin_texts, get_back_to_admin_main_menu_button
from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

async def get_modules_list_keyboard(modules_info: List[Dict[str, Any]], services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π"""
    builder = InlineKeyboardBuilder()
    
    if modules_info:
        for module in modules_info:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è
            status_icon = "‚úÖ" if module['is_enabled'] else "‚ùå"
            error_icon = "‚ö†Ô∏è" if module.get('error') else ""
            system_icon = "üîß" if module.get('is_system_module') else ""
            
            display_text = f"{status_icon} {system_icon} {module['name']} {error_icon}"
            callback_data = AdminModulesPanelNavigate(action="view", item_id=module['name']).pack()
            builder.button(text=display_text, callback_data=callback_data)
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    if services_provider:
        builder.row(get_back_to_admin_main_menu_button(services_provider, locale))
    else:
        builder.row(
            InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
                callback_data=AdminMainMenuNavigate(target_section="main_admin").pack()
            )
        )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup()

async def get_module_details_keyboard(module_name: str, is_enabled: bool, services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ"""
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        admin_texts = {}
    
    # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    toggle_text = admin_texts.get("modules_mgmt_toggle_disable", "‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å") if is_enabled else admin_texts.get("modules_mgmt_toggle_enable", "‚úÖ –í–∫–ª—é—á–∏—Ç—å")
    toggle_action = "disable" if is_enabled else "enable"
    builder.button(
        text=toggle_text,
        callback_data=AdminModulesPanelNavigate(action="toggle", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
    builder.button(
        text=admin_texts.get("modules_mgmt_actions", "üîß –î–µ–π—Å—Ç–≤–∏—è"),
        callback_data=AdminModulesPanelNavigate(action="actions", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π
    builder.row(
        InlineKeyboardButton(
            text=admin_texts.get("modules_mgmt_back_to_module_list", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π"),
            callback_data=AdminModulesPanelNavigate(action="list").pack()
        )
    )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup()

async def get_module_actions_keyboard(module_name: str, is_enabled: bool, services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å –º–æ–¥—É–ª–µ–º"""
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        admin_texts = {}
    
    # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    toggle_text = admin_texts.get("modules_mgmt_toggle_disable", "‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å") if is_enabled else admin_texts.get("modules_mgmt_toggle_enable", "‚úÖ –í–∫–ª—é—á–∏—Ç—å")
    toggle_action = "disable" if is_enabled else "enable"
    builder.button(
        text=toggle_text,
        callback_data=AdminModulesPanelNavigate(action="toggle", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü (–æ–ø–∞—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ)
    builder.button(
        text=admin_texts.get("modules_mgmt_clean_tables", "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã"),
        callback_data=AdminModulesPanelNavigate(action="clean_tables", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ
    builder.button(
        text=admin_texts.get("modules_mgmt_back_to_module_info", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"),
        callback_data=AdminModulesPanelNavigate(action="view", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π
    builder.row(
        InlineKeyboardButton(
            text=admin_texts.get("modules_mgmt_back_to_module_list", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π"),
            callback_data=AdminModulesPanelNavigate(action="list").pack()
        )
    )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/admin/modules_mgmt/__init__.py ------------------------------
# core/admin/modules_mgmt/__init__.py
from aiogram import Router

from .handlers_modules import modules_mgmt_router # –†–æ—É—Ç–µ—Ä –∏–∑ handlers_modules.py

section_modules_mgmt_router = Router(name="sdb_admin_section_modules_mgmt_router")
section_modules_mgmt_router.include_router(modules_mgmt_router)

__all__ = ["section_modules_mgmt_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/modules_mgmt/handlers_modules.py ------------------------------
# core/admin/modules_mgmt/handlers_modules.py
from aiogram import Router, types, F
from loguru import logger
from typing import List, Dict, Any, Optional

from Systems.core.ui.callback_data_factories import AdminModulesPanelNavigate, AdminMainMenuNavigate
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.admin.keyboards_admin_common import get_admin_texts
from .keyboards_modules import get_modules_list_keyboard, get_module_details_keyboard, get_module_actions_keyboard

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

modules_mgmt_router = Router(name="sdb_admin_modules_mgmt_handlers")
MODULE_NAME_FOR_LOG = "AdminModulesMgmt"

modules_mgmt_router.callback_query.filter(can_view_admin_panel_filter)

@modules_mgmt_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "modules"))
async def cq_admin_modules_start(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏.")
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π
    modules_info = await _get_modules_info(services_provider)
    
    text = f"üß© **{admin_texts.get('admin_modules_mgmt_title', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏')}**\n\n"
    if modules_info:
        enabled_count = sum(1 for m in modules_info if m['is_enabled'])
        total_count = len(modules_info)
        text += f"üìä {admin_texts.get('admin_sys_info_total_modules', '–í—Å–µ–≥–æ –º–æ–¥—É–ª–µ–π')}: {total_count}\n"
        text += f"‚úÖ {admin_texts.get('admin_sys_info_enabled_modules', '–í–∫–ª—é—á–µ–Ω–æ')}: {enabled_count}\n"
        text += f"‚ùå {admin_texts.get('admin_modules_disabled', '–û—Ç–∫–ª—é—á–µ–Ω–æ')}: {total_count - enabled_count}\n\n"
        text += admin_texts.get('admin_modules_select_module', '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:')
    else:
        text += admin_texts.get('admin_modules_not_found', '‚ùå –ú–æ–¥—É–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    
    keyboard = await get_modules_list_keyboard(modules_info, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "list"))
async def cq_admin_modules_list(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π.")
    
    # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –∏–∑ cq_admin_modules_start
    modules_info = await _get_modules_info(services_provider)
    
    text = f"üß© **{admin_texts.get('admin_modules_mgmt_title', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏')}**\n\n"
    if modules_info:
        enabled_count = sum(1 for m in modules_info if m['is_enabled'])
        total_count = len(modules_info)
        text += f"üìä {admin_texts.get('admin_sys_info_total_modules', '–í—Å–µ–≥–æ –º–æ–¥—É–ª–µ–π')}: {total_count}\n"
        text += f"‚úÖ {admin_texts.get('admin_sys_info_enabled_modules', '–í–∫–ª—é—á–µ–Ω–æ')}: {enabled_count}\n"
        text += f"‚ùå {admin_texts.get('admin_modules_disabled', '–û—Ç–∫–ª—é—á–µ–Ω–æ')}: {total_count - enabled_count}\n\n"
        text += admin_texts.get('admin_modules_select_module', '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:')
    else:
        text += admin_texts.get('admin_modules_not_found', '‚ùå –ú–æ–¥—É–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    
    keyboard = await get_modules_list_keyboard(modules_info, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "view"))
async def cq_admin_module_view(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    module_name = callback_data.item_id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–æ—Å–º–æ—Ç—Ä –º–æ–¥—É–ª—è {module_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª–µ
    module_info = await _get_module_info(services_provider, module_name)
    
    if not module_info:
        await query.answer(admin_texts.get("modules_mgmt_module_not_found", "–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"), show_alert=True)
        return
    
    text = f"üß© **{admin_texts.get('modules_mgmt_module_details_title', '–ú–æ–¥—É–ª—å')}: {module_name}**\n\n"
    text += f"üìã {admin_texts.get('modules_mgmt_module_description', '–û–ø–∏—Å–∞–Ω–∏–µ')}: {module_info.get('description', admin_texts.get('modules_mgmt_module_no_description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'))}\n"
    text += f"üìÖ {admin_texts.get('modules_mgmt_module_version', '–í–µ—Ä—Å–∏—è')}: {module_info.get('version', admin_texts.get('admin_sys_info_na', '–ù–µ —É–∫–∞–∑–∞–Ω–∞'))}\n"
    text += f"üë®‚Äçüíª {admin_texts.get('modules_mgmt_module_author', '–ê–≤—Ç–æ—Ä')}: {module_info.get('author', admin_texts.get('admin_sys_info_na', '–ù–µ —É–∫–∞–∑–∞–Ω'))}\n"
    text += f"üîó {admin_texts.get('modules_mgmt_module_website', '–°–∞–π—Ç')}: {module_info.get('website', admin_texts.get('admin_sys_info_na', '–ù–µ —É–∫–∞–∑–∞–Ω'))}\n"
    text += f"üìß {admin_texts.get('modules_mgmt_module_email', 'Email')}: {module_info.get('email', admin_texts.get('admin_sys_info_na', '–ù–µ —É–∫–∞–∑–∞–Ω'))}\n"
    text += f"üìÑ {admin_texts.get('modules_mgmt_module_license', '–õ–∏—Ü–µ–Ω–∑–∏—è')}: {module_info.get('license', admin_texts.get('admin_sys_info_na', '–ù–µ —É–∫–∞–∑–∞–Ω–∞'))}\n\n"
    status_text = admin_texts.get('modules_mgmt_module_is_enabled', '–í–∫–ª—é—á–µ–Ω') if module_info['is_enabled'] else admin_texts.get('modules_mgmt_module_is_disabled', '–û—Ç–∫–ª—é—á–µ–Ω')
    text += f"‚úÖ {admin_texts.get('modules_mgmt_module_status', '–°—Ç–∞—Ç—É—Å')}: {status_text}\n"
    
    if module_info.get('error'):
        text += f"‚ùå {admin_texts.get('modules_mgmt_module_error', '–û—à–∏–±–∫–∞')}: {module_info['error']}\n"
    
    keyboard = await get_module_details_keyboard(module_name, module_info['is_enabled'], services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "toggle"))
async def cq_admin_module_toggle(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    module_name = callback_data.item_id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è {module_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è
    module_info = await _get_module_info(services_provider, module_name)
    
    if not module_info:
        await query.answer(admin_texts.get("modules_mgmt_module_not_found", "–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"), show_alert=True)
        return
    
    current_status = module_info['is_enabled']
    new_status = not current_status
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    success = await _toggle_module(services_provider, module_name, new_status)
    
    if success:
        action_text = admin_texts.get("modules_mgmt_module_is_enabled", "–≤–∫–ª—é—á–µ–Ω") if new_status else admin_texts.get("modules_mgmt_module_is_disabled", "–æ—Ç–∫–ª—é—á–µ–Ω")
        await query.answer(admin_texts.get("modules_mgmt_module_toggle_success", "–ú–æ–¥—É–ª—å '{module_name}' —É—Å–ø–µ—à–Ω–æ {action}").format(module_name=module_name, action=action_text))
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        await cq_admin_module_view(query, callback_data, services_provider)
    else:
        await query.answer(admin_texts.get("modules_mgmt_module_toggle_failed", "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–æ–¥—É–ª—è"), show_alert=True)

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "actions"))
async def cq_admin_module_actions(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    module_name = callback_data.item_id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ–π—Å—Ç–≤–∏—è —Å –º–æ–¥—É–ª–µ–º {module_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª–µ
    module_info = await _get_module_info(services_provider, module_name)
    
    if not module_info:
        await query.answer(admin_texts.get("modules_mgmt_module_not_found", "–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"), show_alert=True)
        return
    
    text = f"üîß **{admin_texts.get('modules_mgmt_actions', '–î–µ–π—Å—Ç–≤–∏—è')} —Å –º–æ–¥—É–ª–µ–º: {module_name}**\n\n"
    text += admin_texts.get('admin_modules_select_action', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:')
    
    keyboard = await get_module_actions_keyboard(module_name, module_info['is_enabled'], services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥—É–ª—è: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "clean_tables"))
async def cq_admin_module_clean_tables(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    module_name = callback_data.item_id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è {module_name}")
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    text = f"‚ö†Ô∏è **{admin_texts.get('admin_warning', '–í–Ω–∏–º–∞–Ω–∏–µ!')}**\n\n"
    text += admin_texts.get("modules_mgmt_module_clean_tables_confirm", "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è '{module_name}'.\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è.").format(module_name=module_name)
    text += f"\n\n{admin_texts.get('admin_confirm_continue', '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')}"
    
    keyboard = await get_module_clean_tables_confirm_keyboard(module_name, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "clean_tables_confirm"))
async def cq_admin_module_clean_tables_confirm(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    module_name = callback_data.item_id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è {module_name}")
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü
    success = await _clean_module_tables(services_provider, module_name)
    
    if success:
        await query.answer(admin_texts.get("modules_mgmt_module_clean_tables_success", "–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –æ—á–∏—â–µ–Ω—ã").format(module_name=module_name))
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π
        await cq_admin_modules_list(query, services_provider)
    else:
        await query.answer(admin_texts.get("modules_mgmt_module_clean_tables_failed", "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü"), show_alert=True)

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async def _get_modules_info(services_provider: 'BotServicesProvider') -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö"""
    try:
        module_loader = services_provider.module_loader
        all_modules = module_loader.get_all_modules_info()
        
        modules_info = []
        for module_info in all_modules:
            modules_info.append({
                'name': module_info.name,
                'description': module_info.manifest.description if module_info.manifest else '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è',
                'version': module_info.manifest.version if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                'author': module_info.manifest.author if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
                'website': module_info.manifest.website if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
                'email': module_info.manifest.email if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
                'license': module_info.manifest.license if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                'is_enabled': module_info.is_enabled,
                'error': module_info.error,
                'is_system_module': module_info.is_system_module
            })
        
        return modules_info
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª—è—Ö: {e}")
        return []

async def _get_module_info(services_provider: 'BotServicesProvider', module_name: str) -> Optional[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–æ–¥—É–ª–µ"""
    try:
        module_loader = services_provider.module_loader
        module_info = module_loader.get_module_info(module_name)
        
        if not module_info:
            return None
        
        return {
            'name': module_info.name,
            'description': module_info.manifest.description if module_info.manifest else '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è',
            'version': module_info.manifest.version if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
            'author': module_info.manifest.author if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
            'website': module_info.manifest.website if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
            'email': module_info.manifest.email if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω',
            'license': module_info.manifest.license if module_info.manifest else '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
            'is_enabled': module_info.is_enabled,
            'error': module_info.error,
            'is_system_module': module_info.is_system_module
        }
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ {module_name}: {e}")
        return None

async def _toggle_module(services_provider: 'BotServicesProvider', module_name: str, enable: bool) -> bool:
    """–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å"""
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º CLI –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è–º–∏ - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è
        import subprocess
        import sys
        import shlex
        
        action = "enable" if enable else "disable"
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –º–æ–¥—É–ª—è
        if not module_name.replace('_', '').replace('-', '').isalnum():
            logger.error(f"–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏ –º–æ–¥—É–ª—è: {module_name}")
            return False
            
        cmd = [sys.executable, "sdb", "module", action, module_name]
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30, check=False)
        
        if result.returncode == 0:
            logger.info(f"–ú–æ–¥—É–ª—å {module_name} —É—Å–ø–µ—à–Ω–æ {action}d")
            return True
        else:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ {action} –º–æ–¥—É–ª—è {module_name}: {result.stderr}")
            return False
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–æ–¥—É–ª—è {module_name}: {e}")
        return False

async def _clean_module_tables(services_provider: 'BotServicesProvider', module_name: str) -> bool:
    """–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è"""
    try:
        import subprocess
        import sys
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –º–æ–¥—É–ª—è
        if not module_name.replace('_', '').replace('-', '').isalnum():
            logger.error(f"–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏ –º–æ–¥—É–ª—è: {module_name}")
            return False
            
        cmd = [sys.executable, "sdb", "module", "clean-tables", module_name]
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30, check=False)
        
        if result.returncode == 0:
            logger.info(f"–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è {module_name} —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã")
            return True
        else:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è {module_name}: {result.stderr}")
            return False
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è {module_name}: {e}")
        return False

async def get_module_clean_tables_confirm_keyboard(module_name: str, services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü"""
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        admin_texts = {}
    
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    builder.button(
        text=admin_texts.get("modules_mgmt_confirm_clean_tables", "‚úÖ –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å"),
        callback_data=AdminModulesPanelNavigate(action="clean_tables_confirm", item_id=module_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
    builder.button(
        text=admin_texts.get("admin_cancel", "‚ùå –û—Ç–º–µ–Ω–∞"),
        callback_data=AdminModulesPanelNavigate(action="view", item_id=module_name).pack()
    )
    
    builder.adjust(2)
    return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/admin/logs_viewer/keyboards_modules.py ------------------------------
# core/admin/logs_viewer/keyboards_logs.py
# –ü–æ–∫–∞ –ø—É—Å—Ç–æ–π, –Ω–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –±—É–¥—É—â–µ–π –ª–æ–≥–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞.
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
# from Systems.core.admin.keyboards_admin_common import get_back_to_admin_main_menu_button

# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:
# def get_logs_viewer_main_keyboard() -> InlineKeyboardMarkup:
#     builder = InlineKeyboardBuilder()
#     # builder.button(text="–°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–≥-—Ñ–∞–π–ª", callback_data=...)
#     # builder.button(text="–í—ã–±—Ä–∞—Ç—å –ª–æ–≥-—Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞", callback_data=...)
#     # builder.row(get_back_to_admin_main_menu_button())
#     return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/admin/logs_viewer/__init__.py ------------------------------
# core/admin/logs_viewer/__init__.py
from aiogram import Router

from .handlers_logs import logs_viewer_router 

section_logs_viewer_router = Router(name="sdb_admin_section_logs_viewer_router")
section_logs_viewer_router.include_router(logs_viewer_router)

__all__ = ["section_logs_viewer_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/logs_viewer/keyboards_logs.py ------------------------------
# core/admin/logs_viewer/keyboards_logs.py
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger
from typing import List, Dict, Any

from Systems.core.ui.callback_data_factories import AdminLogsViewerNavigate, AdminMainMenuNavigate
from Systems.core.admin.keyboards_admin_common import get_admin_texts, get_back_to_admin_main_menu_button
from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

async def get_logs_main_keyboard(log_files: List[Dict[str, Any]], services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤"""
    builder = InlineKeyboardBuilder()
    
    if log_files:
        for log_file in log_files:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏ —Ä–∞–∑–º–µ—Ä
            display_text = f"üìÑ {log_file['name']} ({log_file['size_formatted']})"
            callback_data = AdminLogsViewerNavigate(action="view_file", payload=log_file['name']).pack()
            builder.button(text=display_text, callback_data=callback_data)
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    if services_provider:
        builder.row(get_back_to_admin_main_menu_button(services_provider, locale))
    else:
        builder.row(
            InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
                callback_data=AdminMainMenuNavigate(target_section="main_admin").pack()
            )
        )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup()

async def get_log_file_keyboard(file_name: str, services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å —Ñ–∞–π–ª–æ–º –ª–æ–≥–æ–≤"""
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        admin_texts = {}
    
    # –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    builder.button(
        text=admin_texts.get("logs_viewer_view_content", "üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ"),
        callback_data=AdminLogsViewerNavigate(action="view_content", payload=file_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    builder.button(
        text=admin_texts.get("logs_viewer_download_file", "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"),
        callback_data=AdminLogsViewerNavigate(action="download", payload=file_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤
    builder.row(
        InlineKeyboardButton(
            text=admin_texts.get("logs_viewer_back_to_file_list", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤"),
            callback_data=AdminLogsViewerNavigate(action="back_to_main").pack()
        )
    )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup()

async def get_log_content_keyboard(file_name: str, services_provider: Optional['BotServicesProvider'] = None, locale: Optional[str] = None) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞"""
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        admin_texts = {}
    
    # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    builder.button(
        text=admin_texts.get("logs_viewer_download_file", "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"),
        callback_data=AdminLogsViewerNavigate(action="download", payload=file_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
    builder.button(
        text=admin_texts.get("logs_viewer_back_to_file_info", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ"),
        callback_data=AdminLogsViewerNavigate(action="view_file", payload=file_name).pack()
    )
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤
    builder.row(
        InlineKeyboardButton(
            text=admin_texts.get("logs_viewer_back_to_file_list", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤"),
            callback_data=AdminLogsViewerNavigate(action="back_to_main").pack()
        )
    )
    
    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥—É
    return builder.as_markup() 


======================================================================

------------------------------ FILE: Systems/core/admin/logs_viewer/handlers_logs.py ------------------------------
# core/admin/logs_viewer/handlers_logs.py
from aiogram import Router, types, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from loguru import logger
import os
from pathlib import Path
from datetime import datetime, timedelta
from typing import List, Optional, Dict, Any

from Systems.core.ui.callback_data_factories import AdminMainMenuNavigate, AdminLogsViewerNavigate
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from .keyboards_logs import get_logs_main_keyboard, get_log_file_keyboard, get_log_content_keyboard

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

logs_viewer_router = Router(name="sdb_admin_logs_viewer_handlers")
MODULE_NAME_FOR_LOG = "AdminLogsViewer"

logs_viewer_router.callback_query.filter(can_view_admin_panel_filter)

class FSMAdminLogsViewer(StatesGroup):
    viewing_log_content = State()

@logs_viewer_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "logs_view"))
async def cq_admin_logs_view_start(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤.")
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤
    log_files = await _get_available_log_files(services_provider)
    
    text = f"üìÑ **{admin_texts.get('logs_viewer_title', '–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã')}**\n\n"
    if log_files:
        text += f"{admin_texts.get('logs_viewer_files_found', '–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤')}: {len(log_files)}\n"
        text += admin_texts.get('logs_viewer_select_file', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:')
    else:
        text += admin_texts.get('logs_viewer_no_log_files', '‚ùå –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    
    keyboard = await get_logs_main_keyboard(log_files, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–æ–≤: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    else:
        await query.message.answer(text, reply_markup=keyboard, parse_mode="Markdown")
    
    await query.answer()

@logs_viewer_router.callback_query(AdminLogsViewerNavigate.filter(F.action == "view_file"))
async def cq_admin_logs_view_file(
    query: types.CallbackQuery,
    callback_data: AdminLogsViewerNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    file_name = callback_data.payload
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞ {file_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    log_file_info = await _get_log_file_info(services_provider, file_name)
    
    if not log_file_info:
        await query.answer(admin_texts.get("logs_viewer_file_not_found", "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"), show_alert=True)
        return
    
    text = f"üìÑ **{admin_texts.get('logs_viewer_file_details_title', '–§–∞–π–ª –ª–æ–≥–æ–≤')}: {file_name}**\n\n"
    text += f"üìä {admin_texts.get('logs_viewer_file_size', '–†–∞–∑–º–µ—Ä')}: {log_file_info['size_formatted']}\n"
    text += f"üìÖ {admin_texts.get('logs_viewer_file_last_modified', '–ò–∑–º–µ–Ω–µ–Ω')}: {log_file_info['modified_formatted']}\n"
    text += f"üìù {admin_texts.get('logs_viewer_file_lines', '–°—Ç—Ä–æ–∫')}: {log_file_info['lines_count']}\n\n"
    text += admin_texts.get('logs_viewer_select_action', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:')
    
    keyboard = await get_log_file_keyboard(file_name, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

@logs_viewer_router.callback_query(AdminLogsViewerNavigate.filter(F.action == "view_content"))
async def cq_admin_logs_view_content(
    query: types.CallbackQuery,
    callback_data: AdminLogsViewerNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    file_name = callback_data.payload
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ {file_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫)
    log_content = await _get_log_file_content(services_provider, file_name, lines_count=50)
    
    if not log_content:
        await query.answer(admin_texts.get("logs_viewer_error_reading_file", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª"), show_alert=True)
        return
    
    text = f"üìÑ **{admin_texts.get('logs_viewer_file_content_title', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞')}: {file_name}**\n\n"
    text += f"```\n{log_content}\n```"
    
    keyboard = await get_log_content_keyboard(file_name, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ª–æ–≥–æ–≤: {e}")
            # –ü–æ–ø—Ä–æ–±—É–µ–º –±–µ–∑ Markdown
            text = f"üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞: {file_name}\n\n{log_content}"
            await query.message.edit_text(text, reply_markup=keyboard)
    
    await query.answer()

@logs_viewer_router.callback_query(AdminLogsViewerNavigate.filter(F.action == "download"))
async def cq_admin_logs_download(
    query: types.CallbackQuery,
    callback_data: AdminLogsViewerNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    file_name = callback_data.payload
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ {file_name}")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    log_file_path = await _get_log_file_path(services_provider, file_name)
    
    if not log_file_path or not log_file_path.exists():
        await query.answer(admin_texts.get("logs_viewer_file_not_found", "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"), show_alert=True)
        return
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
        await query.message.answer_document(
            types.BufferedInputFile(
                log_file_path.read_bytes(),
                filename=file_name
            ),
            caption=f"üìÑ {admin_texts.get('logs_viewer_file_details_title', '–§–∞–π–ª –ª–æ–≥–æ–≤')}: {file_name}"
        )
        await query.answer(admin_texts.get("logs_viewer_file_sent", "–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"))
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤: {e}")
        await query.answer(admin_texts.get("logs_viewer_error_downloading_file", "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞"), show_alert=True)

@logs_viewer_router.callback_query(AdminLogsViewerNavigate.filter(F.action == "back_to_main"))
async def cq_admin_logs_back_to_main(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –≤–µ—Ä–Ω—É–ª—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é –ª–æ–≥–æ–≤")
    
    # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –∏–∑ cq_admin_logs_view_start
    log_files = await _get_available_log_files(services_provider)
    
    text = f"üìÑ **{admin_texts.get('logs_viewer_title', '–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã')}**\n\n"
    if log_files:
        text += f"{admin_texts.get('logs_viewer_files_found', '–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤')}: {len(log_files)}\n"
        text += admin_texts.get('logs_viewer_select_file', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:')
    else:
        text += admin_texts.get('logs_viewer_no_log_files', '‚ùå –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    
    keyboard = await get_logs_main_keyboard(log_files, services_provider, user_locale)
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é –ª–æ–≥–æ–≤: {e}")
            await query.answer(admin_texts["admin_error_display"], show_alert=True)
    
    await query.answer()

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async def _get_available_log_files(services_provider: 'BotServicesProvider') -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤"""
    try:
        log_dir = services_provider.config.core.project_data_path / "logs"
        if not log_dir.exists():
            return []
        
        log_files = []
        for file_path in log_dir.glob("*.log"):
            try:
                stat = file_path.stat()
                log_files.append({
                    'name': file_path.name,
                    'size': stat.st_size,
                    'modified': datetime.fromtimestamp(stat.st_mtime),
                    'size_formatted': _format_size(stat.st_size),
                    'modified_formatted': datetime.fromtimestamp(stat.st_mtime).strftime('%d.%m.%Y %H:%M')
                })
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ {file_path}: {e}")
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        log_files.sort(key=lambda x: x['modified'], reverse=True)
        return log_files
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤: {e}")
        return []

async def _get_log_file_info(services_provider: 'BotServicesProvider', file_name: str) -> Optional[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –ª–æ–≥–æ–≤"""
    try:
        log_file_path = await _get_log_file_path(services_provider, file_name)
        if not log_file_path or not log_file_path.exists():
            return None
        
        stat = log_file_path.stat()
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
        try:
            with open(log_file_path, 'r', encoding='utf-8') as f:
                lines_count = sum(1 for _ in f)
        except Exception:
            lines_count = 0
        
        return {
            'name': file_name,
            'size': stat.st_size,
            'modified': datetime.fromtimestamp(stat.st_mtime),
            'size_formatted': _format_size(stat.st_size),
            'modified_formatted': datetime.fromtimestamp(stat.st_mtime).strftime('%d.%m.%Y %H:%M'),
            'lines_count': lines_count
        }
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ {file_name}: {e}")
        return None

async def _get_log_file_content(services_provider: 'BotServicesProvider', file_name: str, lines_count: int = 50) -> Optional[str]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏)"""
    try:
        log_file_path = await _get_log_file_path(services_provider, file_name)
        if not log_file_path or not log_file_path.exists():
            return None
        
        with open(log_file_path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
        
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        if len(lines) > lines_count:
            lines = lines[-lines_count:]
        
        return ''.join(lines)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ {file_name}: {e}")
        return None

async def _get_log_file_path(services_provider: 'BotServicesProvider', file_name: str) -> Optional[Path]:
    """–ü–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤"""
    try:
        log_dir = services_provider.config.core.project_data_path / "logs"
        log_file_path = log_dir / file_name
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
        if not log_file_path.resolve().is_relative_to(log_dir.resolve()):
            logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É –≤–Ω–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤: {file_name}")
            return None
        
        return log_file_path
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É {file_name}: {e}")
        return None

def _format_size(size_bytes: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞"""
    if size_bytes == 0:
        return "0 B"
    
    size_names = ["B", "KB", "MB", "GB"]
    i = 0
    while size_bytes >= 1024 and i < len(size_names) - 1:
        size_bytes /= 1024.0
        i += 1
    
    return f"{size_bytes:.1f} {size_names[i]}"


======================================================================

------------------------------ FILE: Systems/core/admin/entry/handlers_entry.py ------------------------------
# core/admin/entry/handlers_entry.py
from aiogram import Router, types, F, Bot
from aiogram.filters import Command
from aiogram.utils.markdown import hbold
from loguru import logger
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_main_menu_keyboard 
from Systems.core.ui.callback_data_factories import CoreMenuNavigate, AdminMainMenuNavigate
from Systems.core.admin.filters_admin import can_view_admin_panel_filter 

from typing import TYPE_CHECKING, Union
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 


admin_entry_router = Router(name="sdb_admin_entry_handlers")
MODULE_NAME_FOR_LOG = "AdminEntry"

#admin_entry_router.message.filter(can_view_admin_panel_filter)
#admin_entry_router.callback_query.filter(can_view_admin_panel_filter)


async def send_admin_main_menu(message_or_query: Union[types.Message, types.CallbackQuery], services_provider: 'BotServicesProvider'):
    user_id = message_or_query.from_user.id 
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    from Systems.core.admin.keyboards_admin_common import get_admin_texts
    texts = get_admin_texts(services_provider, user_locale)
    
    text = (f"üõ† {hbold(texts.get('admin_panel_title', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å SwiftDevBot'))}\n"
            f"{texts.get('admin_panel_select_section', '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:')}")
    
    async with services_provider.db.get_session() as session: 
        keyboard = await get_admin_main_menu_keyboard(services_provider, user_id, session, locale=user_locale)

    if isinstance(message_or_query, types.Message):
        await message_or_query.answer(text, reply_markup=keyboard)
    elif isinstance(message_or_query, types.CallbackQuery) and message_or_query.message:
        try:
            if message_or_query.message.text != text or message_or_query.message.reply_markup != keyboard:
                await message_or_query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await message_or_query.answer() 
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ TelegramBadRequest).")
                await message_or_query.answer()
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {e_tbr}")
                if isinstance(message_or_query, types.CallbackQuery): 
                    try:
                        await message_or_query.bot.send_message(user_id, text, reply_markup=keyboard)
                        await message_or_query.message.delete() 
                        await message_or_query.answer()
                    except Exception as e_send_new:
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e_send_new}")
                        await message_or_query.answer(texts["error_general"], show_alert=True)
                else: 
                    await message_or_query.answer(texts["error_general"], show_alert=True)
        except Exception as e:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {e}", exc_info=True)
            if isinstance(message_or_query, types.CallbackQuery):
                await message_or_query.answer(texts["error_general"], show_alert=True)


@admin_entry_router.message(Command("admin_cp"))
async def cmd_admin_panel_main(message: types.Message, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id 
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    has_admin_access = False
    is_super_admin = user_id in services_provider.config.core.super_admins
    
    if is_super_admin:
        has_admin_access = True
    else:
        try:
            async with services_provider.db.get_session() as session:
                from Systems.core.rbac.service import PERMISSION_CORE_VIEW_ADMIN_PANEL
                has_admin_access = await services_provider.rbac.user_has_permission(session, user_id, PERMISSION_CORE_VIEW_ADMIN_PANEL)
        except Exception as e:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
            has_admin_access = False
    
    if has_admin_access:
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (—Å –ø—Ä–∞–≤–∞–º–∏) –≤–æ—à–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /admin_cp.")
        await send_admin_main_menu(message, services_provider)
    else:
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (–±–µ–∑ –ø—Ä–∞–≤) –ø–æ–ø—ã—Ç–∞–ª—Å—è –≤–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /admin_cp.")
        
        # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_locale = services_provider.config.core.i18n.default_locale
        try:
            async with services_provider.db.get_session() as session:
                from Systems.core.database.core_models import User as DBUser
                from sqlalchemy import select
                result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_id))
                db_user = result.scalar_one_or_none()
                if db_user and db_user.preferred_language_code:
                    user_locale = db_user.preferred_language_code
        except Exception:
            pass
        
        from Systems.core.admin.keyboards_admin_common import get_admin_texts
        texts = get_admin_texts(services_provider, user_locale)
        
        await message.answer(
            texts.get("admin_no_access", "üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.\n\n–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–æ—Ç–∞."),
            show_alert=False
        )

@admin_entry_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "admin_panel_main"))
async def cq_core_nav_to_admin_panel_main(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (—Å –ø—Ä–∞–≤–∞–º–∏) –≤–æ—à–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB.")
    await send_admin_main_menu(query, services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "main_admin"))
async def cq_admin_nav_to_main_admin_menu(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
    await send_admin_main_menu(query, services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "users"))
async def cq_admin_main_to_users_list(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider'
):
    from Systems.core.admin.users.handlers_list import cq_admin_users_list_entry
    from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate 
    await cq_admin_users_list_entry(query, AdminUsersPanelNavigate(action="list", page=1), services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "roles"))
async def cq_admin_main_to_roles_list(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    from Systems.core.admin.roles.handlers_list import cq_admin_roles_list_entry
    from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate 
    await cq_admin_roles_list_entry(query, AdminRolesPanelNavigate(action="list"), services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "sys_info"))
async def cq_admin_main_to_sys_info(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    from Systems.core.admin.sys_info.handlers_sys_info import cq_admin_show_system_info_entry
    from Systems.core.ui.callback_data_factories import AdminSysInfoPanelNavigate 
    await cq_admin_show_system_info_entry(query, AdminSysInfoPanelNavigate(action="show"), services_provider, bot)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "modules"))
async def cq_admin_main_to_modules(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == query.from_user.id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    from Systems.core.admin.keyboards_admin_common import get_admin_texts
    texts = get_admin_texts(services_provider, user_locale)
    
    await query.answer(texts.get("admin_modules_in_development", "–†–∞–∑–¥–µ–ª '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."), show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/admin/entry/__init__.py ------------------------------
# core/admin/entry/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–π" —Ä–æ—É—Ç–µ—Ä
from .handlers_entry import admin_entry_router

# –°–æ–∑–¥–∞–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
section_entry_router = Router(name="sdb_admin_section_entry_router")
section_entry_router.include_router(admin_entry_router)

__all__ = ["section_entry_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/sys_info/handlers_sys_info.py ------------------------------
# SwiftDevBot/core/admin/sys_info/handlers_sys_info.py
import sys
import platform
from datetime import datetime, timezone 
import psutil 
import aiogram 
import asyncio 
import os 
from pathlib import Path

from aiogram import Router, types, F, Bot
from aiogram.utils.markdown import hbold, hcode 
from loguru import logger
from sqlalchemy import select, func as sql_func 
from aiogram.exceptions import TelegramBadRequest

from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS
from .keyboards_sys_info import get_sys_info_keyboard
from Systems.core.ui.callback_data_factories import AdminSysInfoPanelNavigate
from Systems.core.admin.filters_admin import can_view_admin_panel_filter 
from Systems.core.rbac.service import PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC
from Systems.core.database.core_models import User as DBUserModel 
from Systems.core.bot_entrypoint import PID_FILENAME

from typing import TYPE_CHECKING, List, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

sys_info_router = Router(name="sdb_admin_sys_info_handlers")
MODULE_NAME_FOR_LOG = "AdminSysInfo"

async def _get_local_total_users_count(services_provider: 'BotServicesProvider') -> Optional[int]:
    try:
        async with services_provider.db.get_session() as session:
            count_stmt = select(sql_func.count(DBUserModel.id))
            total_users_result = await session.execute(count_stmt)
            return total_users_result.scalar_one_or_none() or 0
    except Exception as e: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è SysInfo: {e}")
        return None

def format_uptime(start_time: Optional[datetime]) -> str:
    if not start_time:
        return "–ù/–î"
    if start_time.tzinfo is None:
        start_time = start_time.replace(tzinfo=timezone.utc)
    uptime_delta = datetime.now(timezone.utc) - start_time
    days = uptime_delta.days
    hours, remainder = divmod(uptime_delta.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    parts = []
    if days > 0: parts.append(f"{int(days)}–¥")
    if hours > 0: parts.append(f"{int(hours)}—á")
    if minutes > 0: parts.append(f"{int(minutes)}–º")
    parts.append(f"{int(seconds)}—Å")
    return " ".join(parts) or "~0—Å"

@sys_info_router.callback_query(AdminSysInfoPanelNavigate.filter(F.action == "show"))
async def cq_admin_show_system_info_entry( 
    query: types.CallbackQuery, 
    callback_data: AdminSysInfoPanelNavigate, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    user_id = query.from_user.id 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)

    can_view_full = False
    can_view_basic = False
    is_owner_from_config = user_id in services_provider.config.core.super_admins
    async with services_provider.db.get_session() as session:
        if not is_owner_from_config: 
            can_view_full = await services_provider.rbac.user_has_permission(session, user_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL)
            if not can_view_full: 
                can_view_basic = await services_provider.rbac.user_has_permission(session, user_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC)
        
    if not (is_owner_from_config or can_view_full or can_view_basic):
        await query.answer(admin_texts["access_denied"], show_alert=True)
        return

    s = services_provider.config 
    
    text_parts: List[str] = [f"üñ•Ô∏è {hbold(admin_texts.get('admin_sys_info_title', '–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot'))}\n"]

    # –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    text_parts.append(f"‚ÑπÔ∏è {hbold(admin_texts.get('admin_sys_info_general', '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'))} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_sdb_core', 'SDB Core'))}: {hcode(f'v{s.core.sdb_version}')}")
    text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_python', 'Python'))}: {hcode(f'v{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}')}")
    text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_aiogram', 'Aiogram'))}: {hcode(f'v{aiogram.__version__}')}")
    text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_os', '–û–°'))}: {platform.system()} {platform.release()} ({platform.machine()})")
    
    # –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞
    text_parts.append(f"\nü§ñ {hbold(admin_texts.get('admin_sys_info_bot_process', '–ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞'))} ‚îÄ‚îÄ‚îÄ")
    current_pid_handler = os.getpid() 
    pid_file_path = s.core.project_data_path / PID_FILENAME
    
    pid_for_psutil_stats = current_pid_handler
    pid_display_str = hcode(str(current_pid_handler))

    if pid_file_path.is_file():
        try:
            pid_from_file = int(pid_file_path.read_text().strip())
            pid_display_str = hcode(str(pid_from_file))
            if psutil and psutil.pid_exists(pid_from_file):
                process = psutil.Process(pid_from_file)
                create_time = datetime.fromtimestamp(process.create_time(), tz=timezone.utc)
                uptime_val = format_uptime(create_time)
                start_time_str = create_time.strftime('%d.%m.%Y %H:%M')
                text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_pid', 'PID'))}: {pid_display_str}")
                text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_uptime', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã'))}: {hbold(uptime_val)}")
                pid_for_psutil_stats = pid_from_file 
            else:
                status_msg = admin_texts.get('admin_sys_info_process_not_found', '–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω')
                if not psutil: status_msg += " (psutil –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"
                text_parts.append(f"  ‚ñ∏ {hbold('–°—Ç–∞—Ç—É—Å (PID –∏–∑ —Ñ–∞–π–ª–∞)')}: {hcode(status_msg)} (PID: {pid_display_str})")
                text_parts.append(f"  ‚ñ∏ {hbold('PID (—Ö—ç–Ω–¥–ª–µ—Ä–∞)')}: {hcode(str(current_pid_handler))}")
        except Exception as e_pid:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PID-—Ñ–∞–π–ª–∞: {e_pid}")
            text_parts.append(f"  ‚ñ∏ {hbold('PID (–∏–∑ —Ñ–∞–π–ª–∞)')}: {hcode('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')}")
            text_parts.append(f"  ‚ñ∏ {hbold('PID (—Ö—ç–Ω–¥–ª–µ—Ä–∞)')}: {hcode(str(current_pid_handler))}")
    elif psutil:
        try:
            process = psutil.Process(current_pid_handler)
            create_time = datetime.fromtimestamp(process.create_time(), tz=timezone.utc)
            uptime_val = format_uptime(create_time)
            start_time_str = create_time.strftime('%d.%m.%Y %H:%M')
            text_parts.append(f"  ‚ñ∏ {hbold('–ó–∞–ø—É—â–µ–Ω (—Ç–µ–∫. –ø—Ä–æ—Ü–µ—Å—Å)')}: {start_time_str} (PID: {pid_display_str})")
            text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—Ç–µ–∫.)')}: {hbold(uptime_val)}")
        except Exception: 
             text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: {admin_texts.get('admin_sys_info_na', '–ù/–î')} (–æ—à–∏–±–∫–∞ psutil –¥–ª—è PID: {pid_display_str})")
    else:
        text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_pid', 'PID'))}: {pid_display_str}")
        text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_uptime', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã'))}: {admin_texts.get('admin_sys_info_na', '–ù/–î')} (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω / psutil –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)")

    if psutil:
        try:
            target_ps_proc = psutil.Process(pid_for_psutil_stats)
            mem_rss_mb = target_ps_proc.memory_info().rss / (1024 * 1024)
            cpu_perc = target_ps_proc.cpu_percent(interval=0.05)
            text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_memory', '–ü–∞–º—è—Ç—å'))}: {hbold(f'{mem_rss_mb:.2f} MB')}")
            text_parts.append(f"  ‚ñ∏ {hbold(admin_texts.get('admin_sys_info_cpu_percent', 'CPU'))}: {hbold(f'{cpu_perc:.1f}%')}")
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
             na_text = admin_texts.get('admin_sys_info_na', '–ù/–î')
             text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode(f'{na_text} (–ø—Ä–æ—Ü–µ—Å—Å {pid_for_psutil_stats} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)')}")
        except Exception as e_ps_stats:
             logger.warning(f"–û—à–∏–±–∫–∞ psutil –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ PID {pid_for_psutil_stats}: {e_ps_stats}")
             na_text = admin_texts.get('admin_sys_info_na', '–ù/–î')
             text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode(f'{na_text} (–æ—à–∏–±–∫–∞ psutil)')}")
    else:
        text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode('psutil –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')}")

    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    text_parts.append(f"\nüóÑÔ∏è {hbold(admin_texts.get('admin_sys_info_database', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö'))} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ {admin_texts.get('admin_sys_info_db_type', '–¢–∏–ø')}: {hbold(s.db.type.upper())}")
    if s.db.type == "sqlite":
        text_parts.append(f"  ‚ñ∏ –ü—É—Ç—å: {hcode(s.db.sqlite_path)}")
    
    # –ö—ç—à
    text_parts.append(f"\nüíæ {hbold('–ö—ç—à')} ‚îÄ‚îÄ‚îÄ")  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
    text_parts.append(f"  ‚ñ∏ –¢–∏–ø: {hbold(s.cache.type.capitalize())}")
    if s.cache.type == "redis" and s.cache.redis_url:
        text_parts.append(f"  ‚ñ∏ URL: {hcode(str(s.cache.redis_url))}") 
    text_parts.append(f"  ‚ñ∏ –î–æ—Å—Ç—É–ø–µ–Ω: {'‚úÖ –î–∞' if services_provider.cache.is_available() else '‚ùå –ù–µ—Ç'}")

    # –ú–æ–¥—É–ª–∏
    try:
        total_modules = len(services_provider.modules.get_all_modules_info())
        loaded_modules = len(services_provider.modules.get_loaded_modules_info(True, True))
        enabled_plugins = len(services_provider.modules.enabled_plugin_names)
        text_parts.append(f"\nüß© {hbold('–ú–æ–¥—É–ª–∏')} ‚îÄ‚îÄ‚îÄ")
        text_parts.append(f"  ‚ñ∏ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {hbold(str(total_modules))}")
        text_parts.append(f"  ‚ñ∏ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤: {hbold(str(enabled_plugins))}")
        text_parts.append(f"  ‚ñ∏ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {hbold(str(loaded_modules))}")
    except Exception as e_mod_info:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö: {e_mod_info}")
        text_parts.append(f"\nüß© {hbold('–ú–æ–¥—É–ª–∏')} ‚îÄ‚îÄ‚îÄ")
        text_parts.append(f"  ‚ñ∏ –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    total_users_count = await _get_local_total_users_count(services_provider)
    total_users_str = hbold(str(total_users_count)) if total_users_count is not None else f"{hcode('[–û—à–∏–±–∫–∞]')}"
    text_parts.append(f"\nüë• {hbold('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏')} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ –í—Å–µ–≥–æ –≤ –ë–î: {total_users_str}")

    text_response = "\n".join(text_parts)
    keyboard_sysinfo = get_sys_info_keyboard()

    if query.message:
        try:
            if query.message.text != text_response or query.message.reply_markup != keyboard_sysinfo:
                await query.message.edit_text(text_response, reply_markup=keyboard_sysinfo)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await query.answer()
        except TelegramBadRequest as e_tbr: 
            if "message is not modified" in str(e_tbr).lower():
                 logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                 await query.answer()
            else:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] TelegramBadRequest –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e_tbr}", exc_info=True)
                await query.answer(admin_texts["error_general"], show_alert=True)
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e_edit}", exc_info=True)
            await query.answer(admin_texts["error_general"], show_alert=True)
    else:
        await query.answer()


======================================================================

------------------------------ FILE: Systems/core/admin/sys_info/__init__.py ------------------------------
# core/admin/sys_info/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–π" —Ä–æ—É—Ç–µ—Ä
from .handlers_sys_info import sys_info_router

# –°–æ–∑–¥–∞–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ (—Ö–æ—Ç—è –∑–¥–µ—Å—å –æ–Ω –≤–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω)
section_sys_info_router = Router(name="sdb_admin_section_sys_info_router")
section_sys_info_router.include_router(sys_info_router)

__all__ = ["section_sys_info_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/sys_info/keyboards_sys_info.py ------------------------------
# core/admin/sys_info/keyboards_sys_info.py
from aiogram import types # <--- –î–û–ë–ê–í–õ–ï–ù –≠–¢–û–¢ –ò–ú–ü–û–†–¢
from aiogram.utils.keyboard import InlineKeyboardBuilder
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button

def get_sys_info_keyboard() -> types.InlineKeyboardMarkup: # –ò—Å–ø–æ–ª—å–∑—É–µ–º types.InlineKeyboardMarkup
    builder = InlineKeyboardBuilder()
    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()

# –ï—Å–ª–∏ –¥–ª—è sys_info –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Å–≤–æ–∏ —Ç–µ–∫—Å—Ç—ã, –∏—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞:
SYS_INFO_TEXTS = {
    "system_info_title": "üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot",
    # ... –¥—Ä—É–≥–∏–µ —Ç–µ–∫—Å—Ç—ã ...
}


======================================================================

------------------------------ FILE: Systems/core/admin/roles/handlers_role_perms.py ------------------------------
# core/admin/roles/handlers_role_perms.py
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.filters import StateFilter # <--- –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate 
from .keyboards_roles import get_admin_role_edit_permissions_keyboard_local, ROLES_MGMT_TEXTS, get_roles_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS
from Systems.core.database.core_models import Role as DBRole, Permission as DBPermission

from typing import TYPE_CHECKING, Optional, List
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

role_permissions_router = Router(name="sdb_admin_role_permissions_handlers")
MODULE_NAME_FOR_LOG = "AdminRolePermissions"

#role_permissions_router.callback_query.filter(can_view_admin_panel_filter)

# --- FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º —Ä–æ–ª–∏ ---
class FSMEditRolePermissions(StatesGroup):
    navigating_role_permissions = State()

# --- –í—Ö–æ–¥ –≤ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "edit_perms_start"))
async def cq_admin_role_edit_permissions_entry(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    target_role_db_id = callback_data.item_id
    page = callback_data.page or 1 

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    roles_texts = get_roles_mgmt_texts(services_provider, user_locale)

    if target_role_db_id is None:
        await query.answer(admin_texts["admin_error_role_id_not_specified"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –≤—Ö–æ–¥–∏—Ç –≤ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è Role ID: {target_role_db_id}, page: {page}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS):
            await query.answer(admin_texts["access_denied"], show_alert=True)
            return
        
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        if not target_role:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return

    await state.clear()
    await state.set_state(FSMEditRolePermissions.navigating_role_permissions)
    await state.update_data(
        target_role_id_for_perms=target_role_db_id,
        current_page=page, 
        # category_key –∏ entity_name –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    )
    
    await _show_role_permissions_menu(query, services_provider, state)

# --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/—Å—É—â–Ω–æ—Å—Ç—è–º/—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "edit_perms_nav"),
    StateFilter(FSMEditRolePermissions.navigating_role_permissions)
)
async def cq_admin_role_permissions_navigate(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    fsm_data = await state.get_data()
    target_role_db_id = fsm_data.get("target_role_id_for_perms")
    if target_role_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.", show_alert=True)
        await state.clear(); return

    new_fsm_context_data = {
        "category_key": callback_data.category_key,
        "entity_name": callback_data.entity_name,
        "current_page": callback_data.page or 1
    }
    await state.update_data(**new_fsm_context_data)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {query.from_user.id} –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∞–≤–∞–º —Ä–æ–ª–∏ (Role ID: {target_role_db_id}). "
                f"–ù–æ–≤—ã–π FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {new_fsm_context_data}")
    
    await _show_role_permissions_menu(query, services_provider, state)

# --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "toggle_perm"),
    StateFilter(FSMEditRolePermissions.navigating_role_permissions)
)
async def cq_admin_role_toggle_permission(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale_toggle = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale_toggle = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts_toggle = get_admin_texts(services_provider, user_locale_toggle)
    
    fsm_data = await state.get_data()
    target_role_db_id: Optional[int] = fsm_data.get("target_role_id_for_perms")
    permission_to_toggle_id: Optional[int] = callback_data.permission_id

    if target_role_db_id is None or permission_to_toggle_id is None:
        await query.answer(admin_texts_toggle["admin_error_invalid_permission_data"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ "
                f"PermID:'{permission_to_toggle_id}' –¥–ª—è Role DBID:{target_role_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS):
            await query.answer(admin_texts_toggle["access_denied"], show_alert=True); return
        
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        permission_to_modify = await session.get(DBPermission, permission_to_toggle_id)

        if not target_role or not permission_to_modify:
            await query.answer(admin_texts_toggle["not_found_generic"], show_alert=True); return

        role_has_this_perm = permission_to_modify in target_role.permissions
        alert_text, action_performed = "", False

        if role_has_this_perm:
            if await services_provider.rbac.remove_permission_from_role(session, target_role, permission_to_modify.name):
                action_performed = True
                alert_text = admin_texts_toggle["admin_role_perm_removed"].format(permission_name=permission_to_modify.name)
            else: alert_text = admin_texts_toggle["admin_role_perm_failed_to_remove"].format(permission_name=permission_to_modify.name)
        else:
            if await services_provider.rbac.assign_permission_to_role(session, target_role, permission_to_modify.name, auto_create_perm=False):
                action_performed = True
                alert_text = admin_texts_toggle["admin_role_perm_assigned"].format(permission_name=permission_to_modify.name)
            else: alert_text = admin_texts_toggle["admin_role_perm_failed_to_assign"].format(permission_name=permission_to_modify.name)
        
        if action_performed:
            try: await session.commit(); logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è Role ID: {target_role.id}"); await session.refresh(target_role, attribute_names=['permissions'])
            except Exception as e: await session.rollback(); logger.error(f"–û—à–∏–±–∫–∞ commit: {e}"); alert_text = admin_texts_toggle["admin_error_saving"]
        
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)
        await _show_role_permissions_menu(query, services_provider, state)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ ---
async def _show_role_permissions_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext
):
    admin_user_id = query.from_user.id
    fsm_data = await state.get_data()
    
    target_role_db_id = fsm_data.get("target_role_id_for_perms")
    category_key = fsm_data.get("category_key")
    entity_name = fsm_data.get("entity_name")
    page = fsm_data.get("current_page", 1)

    if target_role_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM (ID —Ä–æ–ª–∏).", show_alert=True); await state.clear(); return

    async with services_provider.db.get_session() as session:
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        if not target_role:
            await query.answer(admin_texts_show["not_found_generic"], show_alert=True); await state.clear(); return

        all_system_permissions = await services_provider.rbac.get_all_permissions(session)
        
        base_text = roles_texts_show["edit_permissions_for_role"].format(role_name=hbold(target_role.name))
        current_level_text = ""
        if category_key == "core":
            current_level_text = f" / {admin_texts_show.get('admin_perm_category_core', '–Ø–¥—Ä–æ')}"
            if entity_name: current_level_text += f" / {admin_texts_show.get(f'admin_perm_core_group_{entity_name}', entity_name.capitalize())}"
        elif category_key == "module":
            current_level_text = f" / {admin_texts_show.get('admin_perm_category_modules', '–ú–æ–¥—É–ª–∏')}"
            if entity_name:
                mod_info = services_provider.modules.get_module_info(entity_name)
                current_level_text += f" / {mod_info.manifest.display_name if mod_info and mod_info.manifest else entity_name}"
        
        text = f"{base_text}{current_level_text}\n–û—Ç–º–µ—Ç—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è/—Å–Ω—è—Ç–∏—è:"  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
        
        keyboard = await get_admin_role_edit_permissions_keyboard_local(
            target_role=target_role, 
            all_system_permissions=all_system_permissions, 
            services=services_provider, 
            current_admin_tg_id=admin_user_id, 
            session=session,
            category_key=category_key, entity_name=entity_name, page=page,
            locale=user_locale_show
        )

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
            except TelegramBadRequest as e:
                if "message is not modified" not in str(e).lower(): 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text (_show_role_permissions_menu): {e}")
            except Exception as e_edit:
                logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _show_role_permissions_menu: {e_edit}", exc_info=True)
                if query.message: await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.", show_alert=True)

# –í—ã—Ö–æ–¥ –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏")
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "view"), 
    StateFilter(FSMEditRolePermissions.navigating_role_permissions) 
)
async def cq_back_to_role_details_from_perms_fsm(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    await state.clear() 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –≤—ã—à–µ–ª –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏.")
    from .handlers_details import cq_admin_role_view_details_entry
    await cq_admin_role_view_details_entry(query, callback_data, services_provider)


======================================================================

------------------------------ FILE: Systems/core/admin/roles/keyboards_roles.py ------------------------------
# core/admin/roles/keyboards_roles.py
from typing import TYPE_CHECKING, List, Optional, Set, Dict
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ types –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger 

from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button, get_admin_texts
from Systems.core.rbac.service import (
    PERMISSION_CORE_ROLES_CREATE, 
    PERMISSION_CORE_ROLES_EDIT, 
    PERMISSION_CORE_ROLES_DELETE, 
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS,
    DEFAULT_ROLES_DEFINITIONS 
)

if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession
    from Systems.core.database.core_models import Role as DBRole, Permission as DBPermission
    from aiogram import types as AiogramTypes # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Å–µ–≤–¥–æ–Ω–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å —Å types –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö

def get_roles_mgmt_texts(services_provider: 'BotServicesProvider', locale: Optional[str] = None) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏"""
    if not locale:
        locale = services_provider.config.core.i18n.default_locale
    
    from Systems.core.admin.keyboards_admin_common import _get_admin_translator
    translator = _get_admin_translator(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    return {
        "role_list_title": t("admin_role_list_title"),
        "role_list_select_action": t("admin_role_list_select_action"),
        "role_list_no_roles": t("admin_role_list_no_roles"),
        "role_details_title": t("admin_role_details_title"),
        "role_action_edit_permissions": t("admin_role_action_edit_permissions"),
        "role_action_edit_role": t("admin_role_action_edit_role"),
        "role_action_delete_role": t("admin_role_action_delete_role"),
        "back_to_roles_list": t("admin_back_to_roles_list"),
        "edit_permissions_for_role": t("admin_edit_permissions_for_role"),
        "role_action_create_role": t("admin_role_action_create_role"),
    }

# –°—Ç–∞—Ä—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (deprecated)
ROLES_MGMT_TEXTS = {
    "role_list_title": "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏",
    "role_list_select_action": "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
    "role_list_no_roles": "–ù–µ—Ç —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    "role_details_title": "üõ°Ô∏è –î–µ—Ç–∞–ª–∏ —Ä–æ–ª–∏",
    "role_action_edit_permissions": "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è",
    "role_action_edit_role": "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å", 
    "role_action_delete_role": "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å",    
    "back_to_roles_list": "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π",
    "edit_permissions_for_role": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏: {role_name}", 
    "role_action_create_role": "‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å",
}


async def get_admin_roles_list_keyboard_local( 
    all_roles: List['DBRole'],
    services: Optional['BotServicesProvider'] = None, 
    user_tg_id: Optional[int] = None,          
    session: Optional['AsyncSession'] = None,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services:
        roles_texts = get_roles_mgmt_texts(services, locale)
        admin_texts = get_admin_texts(services, locale)
    else:
        roles_texts = ROLES_MGMT_TEXTS
        admin_texts = ADMIN_COMMON_TEXTS
    
    texts = roles_texts

    logger.debug(f"[AdminRolesKeyboards] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π. –í—Å–µ–≥–æ —Ä–æ–ª–µ–π: {len(all_roles)}")
    if not all_roles:
        cb_dummy_data = AdminRolesPanelNavigate(action="dummy_no_roles").pack()
        builder.button(
            text=texts["role_list_no_roles"],
            callback_data=cb_dummy_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–Ω–µ—Ç —Ä–æ–ª–µ–π', callback: {cb_dummy_data}")
    else:
        for role in sorted(all_roles, key=lambda r: r.name):
            cb_data = AdminRolesPanelNavigate(action="view", item_id=role.id).pack()
            builder.button(
                text=f"üõ°Ô∏è {role.name}",
                callback_data=cb_data
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–æ–ª–∏ '{role.name}' (ID: {role.id}), callback: {cb_data}")
        builder.adjust(1)
    
    if services and user_tg_id and session:
        is_owner_from_config = user_tg_id in services.config.core.super_admins
        can_create_roles = False
        try: 
            can_create_roles = is_owner_from_config or await services.rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_ROLES_CREATE)
        except Exception as e_perm_check:
            logger.error(f"[AdminRolesKeyboards] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_CREATE –¥–ª—è user {user_tg_id}: {e_perm_check}")

        if can_create_roles:
            cb_create_data = AdminRolesPanelNavigate(action="create_start").pack()
            builder.row( 
                InlineKeyboardButton(
                    text=texts["role_action_create_role"],
                    callback_data=cb_create_data
                )
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å', callback: {cb_create_data}")

    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()


async def get_admin_role_details_keyboard_local( 
    target_role: 'DBRole',
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession',
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == current_admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    roles_texts = get_roles_mgmt_texts(services, locale)
    admin_texts = get_admin_texts(services, locale)
    texts = roles_texts
    
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins
    logger.debug(f"[AdminRolesKeyboards] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —Ä–æ–ª–∏ '{target_role.name}' (ID: {target_role.id}). –ê–¥–º–∏–Ω: {current_admin_tg_id}, –≤–ª–∞–¥–µ–ª–µ—Ü: {current_admin_is_owner}")

    can_edit_role = False
    can_assign_perms = False
    can_delete_role = False

    try: 
        can_edit_role = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_EDIT)
        can_assign_perms = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS)
        can_delete_role = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_DELETE)
    except Exception as e_perm_check_details:
        logger.error(f"[AdminRolesKeyboards] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ {target_role.id} –∞–¥–º–∏–Ω–æ–º {current_admin_tg_id}: {e_perm_check_details}")


    if can_edit_role:
        cb_edit_data = AdminRolesPanelNavigate(action="edit_start", item_id=target_role.id).pack()
        builder.button(
            text=texts["role_action_edit_role"],
            callback_data=cb_edit_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å', callback: {cb_edit_data}")
        
    if can_assign_perms:
        cb_edit_perms_data = AdminRolesPanelNavigate(action="edit_perms_start", item_id=target_role.id, page=1).pack()
        builder.button(
            text=texts["role_action_edit_permissions"],
            callback_data=cb_edit_perms_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è', callback: {cb_edit_perms_data}")
    
    if target_role.name not in DEFAULT_ROLES_DEFINITIONS: 
        if can_delete_role:
            cb_delete_data = AdminRolesPanelNavigate(action="delete_confirm", item_id=target_role.id).pack()
            builder.button(
                text=texts["role_action_delete_role"],
                callback_data=cb_delete_data
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å', callback: {cb_delete_data}")

    if builder.export(): 
        builder.adjust(1)
    
    builder.row(InlineKeyboardButton(
        text=texts["back_to_roles_list"],
        callback_data=AdminRolesPanelNavigate(action="list").pack()
    ))
    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()

async def get_admin_role_edit_permissions_keyboard_local( 
    target_role: 'DBRole',
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession',
    all_system_permissions: Optional[List['DBPermission']] = None,
    category_key: Optional[str] = None,
    entity_name: Optional[str] = None,
    page: int = 1,
    perms_per_page: int = 7,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == current_admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    roles_texts = get_roles_mgmt_texts(services, locale)
    admin_texts = get_admin_texts(services, locale)
    texts = admin_texts
    
    rbac = services.rbac
    
    role_permission_ids: Set[int] = {perm.id for perm in target_role.permissions if perm.id is not None}

    builder.row(InlineKeyboardButton(
        text=roles_texts.get("back_to_roles_list", "‚¨ÖÔ∏è –ö –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏"),  # TODO: –¥–æ–±–∞–≤–∏—Ç—å back_to_role_details –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
        callback_data=AdminRolesPanelNavigate(action="view", item_id=target_role.id).pack()
    ))

    if not category_key:
        builder.button(
            text=admin_texts["perm_category_core"], 
            callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", page=1).pack()
        )
        module_perms_exist = False
        if services.modules:
            declared_module_perms = services.modules.get_all_declared_permissions_from_active_modules()
            if declared_module_perms: module_perms_exist = True
        if module_perms_exist:
            builder.button(
                text=admin_texts["perm_category_modules"],
                callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", page=1).pack()
            )
        builder.adjust(1)
        # –ù–µ –∑–∞–±—ã–≤–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" –∏ –∑–¥–µ—Å—å, –µ—Å–ª–∏ —ç—Ç–æ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        builder.row(get_back_to_admin_main_menu_button(services, locale))
        return builder.as_markup()

    permissions_to_display_final: List['DBPermission'] = []
    if all_system_permissions is None: 
        all_system_permissions = await rbac.get_all_permissions(session)

    back_to_category_selection_button = InlineKeyboardButton(
        text=admin_texts["back_to_perm_categories"], 
        callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key=None, entity_name=None, page=1).pack()
    )

    if category_key == "core":
        CORE_PERM_GROUPS_MAP_ROLES: Dict[str, str] = { 
            k: texts[f"perm_core_group_{k}"] for k in ["users", "roles", "modules_core", "system", "settings_core", "other"]
        }
        CORE_PERM_PREFIXES_MAP_ROLES: Dict[str, str] = {
            "users": "core.users.", "roles": "core.roles.", "modules_core": "core.modules.",
            "system": "core.system.", "settings_core": "core.settings."
        }
        if not entity_name: 
            for group_key, group_display_name in CORE_PERM_GROUPS_MAP_ROLES.items():
                prefix_to_check = CORE_PERM_PREFIXES_MAP_ROLES.get(group_key)
                has_perms_in_group = False
                if prefix_to_check:
                    if any(p.name.startswith(prefix_to_check) for p in all_system_permissions): has_perms_in_group = True
                elif group_key == "other": 
                    known_prefixes = list(CORE_PERM_PREFIXES_MAP_ROLES.values())
                    if any(p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes) for p in all_system_permissions): has_perms_in_group = True
                if has_perms_in_group:
                    builder.button(text=group_display_name, callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", entity_name=group_key, page=1).pack())
            builder.adjust(1)
            builder.row(back_to_category_selection_button)
        else: 
            if entity_name == "other":
                known_prefixes = list(CORE_PERM_PREFIXES_MAP_ROLES.values())
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes)]
            elif entity_name in CORE_PERM_PREFIXES_MAP_ROLES:
                prefix = CORE_PERM_PREFIXES_MAP_ROLES[entity_name]
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith(prefix)]
            builder.row(InlineKeyboardButton(text=admin_texts["back_to_core_perm_groups"], callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", entity_name=None, page=1).pack()))
    elif category_key == "module":
        if not services.modules: 
            builder.button(text=admin_texts.get("admin_modules_error_no_module_loader", "–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."), callback_data="dummy_error_no_module_loader_perms"); return builder.as_markup() # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
        module_permissions_map: Dict[str, List['DBPermission']] = {}
        module_display_names: Dict[str, str] = {}
        for p in all_system_permissions:
            if not p.name.startswith("core."):
                module_name_candidate = p.name.split('.')[0]
                if module_name_candidate not in module_permissions_map:
                    module_permissions_map[module_name_candidate] = []
                    mod_info = services.modules.get_module_info(module_name_candidate)
                    module_display_names[module_name_candidate] = mod_info.manifest.display_name if mod_info and mod_info.manifest else module_name_candidate
                module_permissions_map[module_name_candidate].append(p)
        if not entity_name: 
            sorted_module_names = sorted(module_permissions_map.keys())
            if not sorted_module_names: builder.button(text=admin_texts["no_modules_with_perms"], callback_data="dummy_no_mod_perms_for_role") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
            else:
                for mod_name in sorted_module_names:
                    builder.button(text=f"üß© {module_display_names.get(mod_name, mod_name)}", callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", entity_name=mod_name, page=1).pack())
            builder.adjust(1)
            builder.row(back_to_category_selection_button)
        else: 
            permissions_to_display_final = module_permissions_map.get(entity_name, [])
            builder.row(InlineKeyboardButton(text=texts["back_to_module_list_for_perms"], callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", entity_name=None, page=1).pack()))
    
    if permissions_to_display_final:
        permissions_to_display_final.sort(key=lambda p: p.name)
        total_perms_in_list = len(permissions_to_display_final)
        total_perm_pages = (total_perms_in_list + perms_per_page - 1) // perms_per_page
        total_perm_pages = max(1, total_perm_pages)
        current_perm_page = max(1, min(page, total_perm_pages))
        start_idx = (current_perm_page - 1) * perms_per_page
        end_idx = start_idx + perms_per_page
        paginated_perms = permissions_to_display_final[start_idx:end_idx]
        if not paginated_perms and current_perm_page == 1: builder.button(text=texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_role") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
        else:
            for perm in paginated_perms:
                is_assigned = perm.id in role_permission_ids
                prefix = "‚úÖ " if is_assigned else "‚¨ú "
                button_text = f"{prefix}{perm.name}"
                if perm.id is None: continue 
                builder.button(text=button_text, callback_data=AdminRolesPanelNavigate(action="toggle_perm", item_id=target_role.id, permission_id=perm.id, category_key=category_key, entity_name=entity_name, page=current_perm_page).pack())
            builder.adjust(1)
            if total_perm_pages > 1:
                pagination_row_perms = []
                nav_cb_data_base = AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key=category_key, entity_name=entity_name) 
                if current_perm_page > 1: pagination_row_perms.append(InlineKeyboardButton(text=texts["pagination_prev"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page - 1}).pack()))
                pagination_row_perms.append(InlineKeyboardButton(text=f"{current_perm_page}/{total_perm_pages}", callback_data="dummy_role_perm_page")) # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
                if current_perm_page < total_perm_pages: pagination_row_perms.append(InlineKeyboardButton(text=texts["pagination_next"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page + 1}).pack()))
                if pagination_row_perms: builder.row(*pagination_row_perms)
    elif entity_name: 
        builder.button(text=texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_role_entity") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data

    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()


======================================================================

------------------------------ FILE: Systems/core/admin/roles/handlers_crud_fsm.py ------------------------------
# core/admin/roles/handlers_crud_fsm.py
from typing import List
from aiogram import Router, types, F, Bot
from aiogram.filters import Command, StateFilter 
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup 
from aiogram.utils.markdown import hbold, hcode, hitalic
from aiogram.utils.keyboard import InlineKeyboardBuilder 
from loguru import logger
from sqlalchemy import select, func as sql_func
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS, get_roles_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts 
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_ROLES_CREATE, PERMISSION_CORE_ROLES_EDIT, PERMISSION_CORE_ROLES_DELETE, DEFAULT_ROLES_DEFINITIONS
from Systems.core.database.core_models import Role as DBRole, UserRole


from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession


role_crud_fsm_router = Router(name="sdb_admin_role_crud_fsm_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleCRUD"

#role_crud_fsm_router.callback_query.filter(can_view_admin_panel_filter)
#role_crud_fsm_router.message.filter(can_view_admin_panel_filter)

class FSMAdminCreateRole(StatesGroup):
    waiting_for_name = State()
    waiting_for_description = State()

class FSMAdminEditRole(StatesGroup): 
    waiting_for_new_name = State()
    waiting_for_new_description = State()

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "create_start"))
async def cq_admin_role_create_start_fsm( 
    query: types.CallbackQuery,
    state: FSMContext,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–æ–ª–∏ (FSM).")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_CREATE):
                await query.answer(admin_texts["access_denied"], show_alert=True)
                return
    
    await state.set_state(FSMAdminCreateRole.waiting_for_name)
    
    text = (f"{admin_texts.get('fsm_enter_role_name', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–æ–ª–∏:')}\n\n"
            f"{hitalic(admin_texts.get('fsm_command_cancel_role_creation', '/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=None) 
        except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è FSM (create_start): {e}. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ.")
            await query.bot.send_message(query.from_user.id, text) 
        except Exception as e_fatal:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_role_create_start_fsm –ø—Ä–∏ edit/send: {e_fatal}")
            await query.answer(admin_texts["error_general"], show_alert=True)
    else: 
        await query.bot.send_message(query.from_user.id, text) 
    await query.answer()


@role_crud_fsm_router.message(StateFilter(FSMAdminCreateRole.waiting_for_name), F.text)
async def process_fsm_role_name_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = message.from_user.id
    role_name = message.text.strip() if message.text else ""

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)

    if not role_name:
        await message.reply(admin_texts.get('fsm_role_name_empty', '–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'))
        return

    async with services_provider.db.get_session() as session:
        existing_role = await services_provider.rbac._get_role_by_name(session, role_name) 
        if existing_role:
            await message.reply(admin_texts.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(role_name)))
            return
            
    await state.update_data(new_role_name=role_name)
    await state.set_state(FSMAdminCreateRole.waiting_for_description)
    
    text = (f"{admin_texts.get('fsm_enter_role_description','–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name}:').format(role_name=hcode(role_name))}\n\n"
            f"{hitalic(admin_texts.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(admin_texts.get('fsm_command_cancel_role_creation','/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    await message.answer(text)


@role_crud_fsm_router.message(StateFilter(FSMAdminCreateRole.waiting_for_description), F.text)
async def process_fsm_role_description_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    admin_user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    roles_texts = get_roles_mgmt_texts(services_provider, user_locale)
    
    if message.text and message.text.lower() == "/skip_description": 
        role_description = None
    else:
        role_description = message.text.strip() if message.text else None

    user_data = await state.get_data()
    role_name = user_data.get("new_role_name")

    if not role_name: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] FSM: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–º—è —Ä–æ–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.")
        await message.answer(admin_texts["error_general"])
        await state.clear()
        from .handlers_list import cq_admin_roles_list_entry 
        chat_id_for_reply = message.chat.id
        dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0) 
        await cq_admin_roles_list_entry(
            types.CallbackQuery(id="dummy_fsm_error_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
            AdminRolesPanelNavigate(action="list"), services_provider
        )
        return

    async with services_provider.db.get_session() as session:
        created_role = await services_provider.rbac.get_or_create_role(session, role_name, role_description)
        if created_role:
            try:
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª —Ä–æ–ª—å: '{role_name}'.")
                await message.answer(admin_texts.get('fsm_role_created_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!').format(role_name=hcode(role_name)))
            except Exception as e_commit:
                await session.rollback()
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–ª–∏ '{role_name}': {e_commit}", exc_info=True)
                await message.answer(admin_texts["admin_error_saving"])  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        else:
            await message.answer(admin_texts["admin_error_saving"])  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
        await state.clear()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
        from Systems.core.database.core_models import Role as DBRole
        
        async with services_provider.db.get_session() as session:
            all_roles: List[DBRole] = await services_provider.rbac.get_all_roles(session)
            text = f"{roles_texts['role_list_title']}\n{roles_texts['role_list_select_action']}"
            keyboard = await get_admin_roles_list_keyboard_local(all_roles, services_provider, message.from_user.id, session, locale=user_locale)
            
            await message.bot.send_message(message.chat.id, text, reply_markup=keyboard)

@role_crud_fsm_router.message(Command("cancel_role_creation"), StateFilter(FSMAdminCreateRole))
async def cancel_create_role_fsm_command(
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider', 
    bot: Bot
):
    admin_user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    current_fsm_state = await state.get_state()
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–º–µ–Ω–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è {current_fsm_state} –∫–æ–º–∞–Ω–¥–æ–π.")
    await state.clear()
    await message.answer(admin_texts.get('fsm_role_creation_cancelled', "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."))
    
    from .handlers_list import cq_admin_roles_list_entry
    chat_id_for_reply = message.chat.id
    dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
    await cq_admin_roles_list_entry(
        types.CallbackQuery(id="dummy_fsm_cancel_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
        AdminRolesPanelNavigate(action="list"), services_provider
    )

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "edit_start"))
async def cq_admin_role_edit_start_fsm( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    state: FSMContext,
    services_provider: 'BotServicesProvider'
):
    from Systems.core.database.core_models import Role as DBRole
    admin_user_id = query.from_user.id
    role_id_to_edit = callback_data.item_id

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)

    if role_id_to_edit is None or not str(role_id_to_edit).isdigit(): 
        await query.answer(admin_texts["admin_error_role_id_invalid"], show_alert=True); return
    
    role_id_to_edit = int(str(role_id_to_edit)) 

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ ID: {role_id_to_edit} (FSM).")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_EDIT):
                await query.answer(admin_texts["access_denied"], show_alert=True); return
        
        role_to_edit = await session.get(DBRole, role_id_to_edit)
        if not role_to_edit:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return

        await state.update_data(
            editing_role_id=role_to_edit.id,
            current_role_name=role_to_edit.name,
            current_role_description=role_to_edit.description or "" 
        )

        title_text = admin_texts.get('fsm_edit_role_title','–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}').format(role_name=hcode(role_to_edit.name))
        
        if role_to_edit.name in DEFAULT_ROLES_DEFINITIONS:
            await state.set_state(FSMAdminEditRole.waiting_for_new_description)
            prompt_text = (f"{title_text}\n"
                           f"{admin_texts.get('fsm_edit_role_name_not_allowed','–ò–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ {role_name} –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_edit.name))}\n\n"
                           f"{admin_texts.get('fsm_enter_new_role_description','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):').format(role_name=hcode(role_to_edit.name), current_description=hitalic(role_to_edit.description or '–ø—É—Å—Ç–æ'))}\n\n"
                           f"{hitalic(admin_texts.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(admin_texts.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
        else:
            await state.set_state(FSMAdminEditRole.waiting_for_new_name)
            prompt_text = (f"{title_text}\n"
                           f"{admin_texts.get('fsm_enter_new_role_name','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):').format(current_name=hcode(role_to_edit.name))}\n\n"
                           f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_name','/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    
    if query.message:
        try:
            await query.message.edit_text(prompt_text, reply_markup=None) 
        except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è FSM (edit_start): {e}. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ.")
            await query.bot.send_message(query.from_user.id, prompt_text) 
    else:
        await query.bot.send_message(query.from_user.id, prompt_text) 
    await query.answer()


@role_crud_fsm_router.message(StateFilter(FSMAdminEditRole.waiting_for_new_name), F.text)
async def process_fsm_edit_role_name_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = message.from_user.id
    new_role_name_input = message.text.strip() if message.text else ""
    
    user_data = await state.get_data()
    current_role_name = user_data.get("current_role_name")
    role_id = user_data.get("editing_role_id")

    final_role_name = current_role_name 

    if new_role_name_input.lower() == "/skip_name":
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    elif not new_role_name_input:
        await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_empty', '–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'))
        return
    elif new_role_name_input != current_role_name:
        async with services_provider.db.get_session() as session:
            existing_role_with_new_name = await services_provider.rbac._get_role_by_name(session, new_role_name_input)
            if existing_role_with_new_name and existing_role_with_new_name.id != role_id:
                await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(new_role_name_input)))
                return
        final_role_name = new_role_name_input
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –≤–≤–µ–ª –Ω–æ–≤–æ–µ –∏–º—è '{final_role_name}' –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    
    await state.update_data(edited_role_name=final_role_name) 
    await state.set_state(FSMAdminEditRole.waiting_for_new_description)
    
    current_description = user_data.get("current_role_description", "–ø—É—Å—Ç–æ")
    text = (f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_description','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):').format(role_name=hcode(final_role_name), current_description=hitalic(current_description))}\n\n"
            f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    await message.answer(text)


@role_crud_fsm_router.message(StateFilter(FSMAdminEditRole.waiting_for_new_description), F.text)
async def process_fsm_edit_role_description_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    from Systems.core.database.core_models import Role as DBRole
    admin_user_id = message.from_user.id
    new_role_description_input = message.text.strip() if message.text else None

    user_data = await state.get_data()
    role_id = user_data.get("editing_role_id")
    final_role_name = user_data.get("edited_role_name", user_data.get("current_role_name")) 
    current_role_description = user_data.get("current_role_description")

    final_role_description = current_role_description 
    if new_role_description_input and new_role_description_input.lower() == "/skip_description":
        final_role_description = current_role_description if current_role_description is not None else None 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    elif new_role_description_input is not None: 
        final_role_description = new_role_description_input if new_role_description_input else None 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –≤–≤–µ–ª –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")

    if role_id is None or final_role_name is None: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] FSM Edit: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID —Ä–æ–ª–∏ –∏–ª–∏ –∏–º—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏.")
        await message.answer(ADMIN_COMMON_TEXTS["error_general"])
        await state.clear()
        return

    async with services_provider.db.get_session() as session:
        role_to_update = await session.get(DBRole, role_id)
        if not role_to_update:
            await message.answer(ADMIN_COMMON_TEXTS["not_found_generic"])
            await state.clear()
            return
        
        made_changes = False
        if role_to_update.name != final_role_name and role_to_update.name not in DEFAULT_ROLES_DEFINITIONS:
            if final_role_name != user_data.get("current_role_name"): 
                existing_role_check = await services_provider.rbac._get_role_by_name(session, final_role_name)
                if existing_role_check and existing_role_check.id != role_id:
                    await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(final_role_name)))
                    await state.set_state(FSMAdminEditRole.waiting_for_new_name)
                    current_name_for_prompt = user_data.get("current_role_name")
                    title_text = ADMIN_COMMON_TEXTS.get('fsm_edit_role_title','–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}').format(role_name=hcode(current_name_for_prompt))
                    prompt_text = (f"{title_text}\n"
                                   f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_name','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):').format(current_name=hcode(current_name_for_prompt))}\n\n"
                                   f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_name','/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
                    await message.answer(prompt_text)
                    return
            role_to_update.name = final_role_name
            made_changes = True
        elif role_to_update.name != final_role_name and role_to_update.name in DEFAULT_ROLES_DEFINITIONS:
            logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ '{role_to_update.name}' –Ω–∞ '{final_role_name}'. –ò–º—è –Ω–µ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ.")
        
        if role_to_update.description != final_role_description:
            role_to_update.description = final_role_description
            made_changes = True
        
        if made_changes:
            session.add(role_to_update)
            try:
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å ID {role_id} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ò–º—è: '{role_to_update.name}', –æ–ø–∏—Å–∞–Ω–∏–µ: '{role_to_update.description}'.")
                await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_updated_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!').format(role_name=hcode(role_to_update.name)))
            except Exception as e_commit:
                await session.rollback()
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏ ID {role_id}: {e_commit}", exc_info=True)
                await message.answer("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–æ–ª–∏.")
        else:
            await message.answer("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")

        await state.clear()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
        from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS
        from Systems.core.rbac.service import PERMISSION_CORE_ROLES_VIEW
        from Systems.core.database.core_models import Role as DBRole
        from sqlalchemy import select, func as sql_func
        
        async with services_provider.db.get_session() as session:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
            has_perm = await services_provider.rbac.user_has_permission(session, message.from_user.id, PERMISSION_CORE_ROLES_VIEW)
            if not has_perm:
                await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π.")
                return
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
            roles_query = select(DBRole).order_by(DBRole.name)
            roles_result = await session.execute(roles_query)
            all_roles = list(roles_result.scalars().all())
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            text = ROLES_MGMT_TEXTS["role_list_title"]
            keyboard = await get_admin_roles_list_keyboard_local(all_roles, services_provider, message.from_user.id, session)
            
            await message.answer(text, reply_markup=keyboard)

@role_crud_fsm_router.message(Command("cancel_role_edit"), StateFilter(FSMAdminEditRole))
async def cancel_edit_role_fsm_command_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider', 
    bot: Bot
):
    admin_user_id = message.from_user.id
    current_fsm_state = await state.get_state()
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–º–µ–Ω–∏–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è {current_fsm_state} –∫–æ–º–∞–Ω–¥–æ–π.")
    await state.clear()
    await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_update_cancelled', "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."))
    
    from .handlers_list import cq_admin_roles_list_entry
    chat_id_for_reply = message.chat.id
    dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
    await cq_admin_roles_list_entry(
        types.CallbackQuery(id="dummy_fsm_cancel_edit_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
        AdminRolesPanelNavigate(action="list"), services_provider
    )

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "delete_confirm"))
async def cq_admin_role_delete_confirm_crud( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    from Systems.core.database.core_models import Role as DBRole
    admin_user_id = query.from_user.id
    role_id_to_delete = callback_data.item_id

    if role_id_to_delete is None or not str(role_id_to_delete).isdigit():
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True); return
    
    role_id_to_delete = int(str(role_id_to_delete))

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏ ID: {role_id_to_delete}.")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_DELETE):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        role_to_delete = await session.get(DBRole, role_id_to_delete)
        if not role_to_delete:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

        if role_to_delete.name in DEFAULT_ROLES_DEFINITIONS:
            await query.answer(ADMIN_COMMON_TEXTS.get('role_is_standard_cant_delete','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å "{role_name}" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_delete.name)), show_alert=True); return
        
        user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role_id_to_delete)
        user_role_count_res = await session.execute(user_role_count_stmt)
        user_count_with_role = user_role_count_res.scalar_one()

        warning_text = ""
        if user_count_with_role > 0:
            text_with_warning = (f"üö´ {hbold('–£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!')}\n"
                                 f"–†–æ–ª—å {hcode(role_to_delete.name)} –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ {hbold(str(user_count_with_role))} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—è–º).\n"
                                 f"–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —ç—Ç—É —Ä–æ–ª—å —Å–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            builder = InlineKeyboardBuilder()
            builder.button(text=ROLES_MGMT_TEXTS.get('back_to_role_details', "–ù–∞–∑–∞–¥"), 
                           callback_data=AdminRolesPanelNavigate(action="view", item_id=role_id_to_delete).pack())
            if query.message: await query.message.edit_text(text_with_warning, reply_markup=builder.as_markup())
            await query.answer(f"–†–æ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è {user_count_with_role} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.", show_alert=True)
            return

        text = ADMIN_COMMON_TEXTS.get('delete_role_confirm_text','–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!').format(role_name=hbold(role_to_delete.name), warning_if_users=warning_text)
        
        from Systems.core.ui.keyboards_core import get_confirm_action_keyboard 
        keyboard = get_confirm_action_keyboard(
            confirm_callback_data=AdminRolesPanelNavigate(action="delete_execute", item_id=role_id_to_delete).pack(),
            cancel_callback_data=AdminRolesPanelNavigate(action="view", item_id=role_id_to_delete).pack() 
        )
        if query.message:
            await query.message.edit_text(text, reply_markup=keyboard)
        await query.answer()


@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "delete_execute"))
async def cq_admin_role_delete_execute_crud( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    from Systems.core.database.core_models import Role as DBRole
    from sqlalchemy import select, func as sql_func
    from Systems.core.database.core_models import UserRole
    admin_user_id = query.from_user.id
    role_id_to_delete = callback_data.item_id

    if role_id_to_delete is None or not str(role_id_to_delete).isdigit():
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True); return
    
    role_id_to_delete = int(str(role_id_to_delete))

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ ID: {role_id_to_delete}.")
    
    default_fail_text = ADMIN_COMMON_TEXTS.get('role_delete_failed','–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å "{role_name}".')
    alert_text = default_fail_text.format(role_name="ID:"+str(role_id_to_delete)) 

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_DELETE):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        role_to_delete = await session.get(DBRole, role_id_to_delete) 
        if not role_to_delete:
            alert_text = ADMIN_COMMON_TEXTS["not_found_generic"]
        elif role_to_delete.name in DEFAULT_ROLES_DEFINITIONS:
            alert_text = ADMIN_COMMON_TEXTS.get('role_is_standard_cant_delete','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å "{role_name}" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_delete.name))
        else:
            user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role_id_to_delete)
            user_role_count_res = await session.execute(user_role_count_stmt)
            if user_role_count_res.scalar_one() > 0:
                alert_text = "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –≤—Å–µ –µ—â–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."
            else:
                role_name_deleted = role_to_delete.name
                if await services_provider.rbac.delete_role(session, role_id_to_delete): 
                    try:
                        await session.commit()
                        alert_text = ADMIN_COMMON_TEXTS.get('role_deleted_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.').format(role_name=hcode(role_name_deleted))
                        logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text}")
                    except Exception as e_commit:
                        await session.rollback()
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏: {e_commit}", exc_info=True)
                        alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏."
                else: 
                    alert_text = default_fail_text.format(role_name=hcode(role_name_deleted))
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
        from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS
        from Systems.core.rbac.service import PERMISSION_CORE_ROLES_VIEW
        from Systems.core.database.core_models import Role as DBRole
        from sqlalchemy import select, func as sql_func
        
        async with services_provider.db.get_session() as session:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
            has_perm = await services_provider.rbac.user_has_permission(session, query.from_user.id, PERMISSION_CORE_ROLES_VIEW)
            if not has_perm:
                await query.bot.send_message(query.from_user.id, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π.")
                return
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
            roles_query = select(DBRole).order_by(DBRole.name)
            roles_result = await session.execute(roles_query)
            all_roles = list(roles_result.scalars().all())
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            text = ROLES_MGMT_TEXTS["role_list_title"]
            keyboard = await get_admin_roles_list_keyboard_local(all_roles, services_provider, query.from_user.id, session)
            
            await query.bot.send_message(query.from_user.id, text, reply_markup=keyboard)

    await query.answer(alert_text, show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/admin/roles/__init__.py ------------------------------
# core/admin/roles/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
from .handlers_list import roles_list_router
from .handlers_details import role_details_router
from .handlers_role_perms import role_permissions_router
from .handlers_crud_fsm import role_crud_fsm_router

# –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ "roles"
section_roles_router = Router(name="sdb_admin_section_roles_router")

section_roles_router.include_router(roles_list_router)
section_roles_router.include_router(role_details_router)
section_roles_router.include_router(role_permissions_router)
section_roles_router.include_router(role_crud_fsm_router)

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
__all__ = ["section_roles_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/roles/handlers_list.py ------------------------------
# core/admin/roles/handlers_list.py
from aiogram import Router, types, F, Bot 
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy import select, func as sql_func
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS, get_roles_mgmt_texts
from Systems.core.admin.keyboards_admin_common import get_admin_texts
from Systems.core.admin.filters_admin import can_view_admin_panel_filter 
from Systems.core.rbac.service import PERMISSION_CORE_ROLES_VIEW
from Systems.core.database.core_models import Role as DBRole

from typing import TYPE_CHECKING, List
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

roles_list_router = Router(name="sdb_admin_roles_list_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleMgmtList"

#roles_list_router.callback_query.filter(can_view_admin_panel_filter) 

@roles_list_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "list"))
async def cq_admin_roles_list_entry( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π.")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    roles_texts = get_roles_mgmt_texts(services_provider, user_locale)

    async with services_provider.db.get_session() as session: # type: AsyncSession
        has_perm_to_view_list = False
        is_owner_from_config = admin_user_id in services_provider.config.core.super_admins
        if is_owner_from_config:
            has_perm_to_view_list = True
        else:
            try:
                has_perm_to_view_list = await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_VIEW)
            except Exception as e_perm_check_list:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_VIEW –¥–ª—è user {admin_user_id}: {e_perm_check_list}")
                await query.answer(admin_texts["admin_error_checking_permissions"], show_alert=True) 
                return

        if not has_perm_to_view_list:
            await query.answer(admin_texts["admin_error_no_permission_to_view_roles"], show_alert=True) 
            return
        
        all_roles: List[DBRole] = await services_provider.rbac.get_all_roles(session)
        
        text = f"{roles_texts['role_list_title']}\n{roles_texts['role_list_select_action']}"
        keyboard = await get_admin_roles_list_keyboard_local(all_roles, services_provider, admin_user_id, session, locale=user_locale)

        target_chat_id = query.message.chat.id if query.message else admin_user_id

        try:
            if query.message and (query.message.text != text or query.message.reply_markup != keyboard):
                await query.message.edit_text(text, reply_markup=keyboard)
                logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–æ–ª–µ–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.")
            elif not query.message: 
                 await query.bot.send_message(target_chat_id, text, reply_markup=keyboard)
                 logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–æ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (—Ç.–∫. query.message –±—ã–ª None).")
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await query.answer()
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if query.message and "message to edit not found" in str(e_tbr).lower(): 
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ: {e_tbr}")
                await query.bot.send_message(target_chat_id, text, reply_markup=keyboard)
                await query.answer()
            elif "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                await query.answer()
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ Telegram BadRequest –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏/–æ—Ç–ø—Ä–∞–≤–∫–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π: {e_tbr}")
                await query.answer(admin_texts["admin_error_displaying_list"], show_alert=True)
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_roles_list_entry: {e_edit}", exc_info=True)
            await query.answer(admin_texts["admin_error_displaying_role_list"], show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/admin/roles/handlers_details.py ------------------------------
# core/admin/roles/handlers_details.py
from aiogram import Router, types, F, Bot
from aiogram.utils.markdown import hbold, hcode, hitalic
from loguru import logger
from sqlalchemy.orm import selectinload
from sqlalchemy import select, func as sql_func 
from aiogram.exceptions import TelegramBadRequest 

from Systems.core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_role_details_keyboard_local, ROLES_MGMT_TEXTS, get_roles_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_ROLES_VIEW, DEFAULT_ROLES_DEFINITIONS
from Systems.core.database.core_models import Role as DBRole

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

role_details_router = Router(name="sdb_admin_role_details_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleMgmtDetails"

#role_details_router.callback_query.filter(can_view_admin_panel_filter)

@role_details_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "view"))
async def cq_admin_role_view_details_entry( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    # logger.critical(f"!!! [{MODULE_NAME_FOR_LOG}] –•–≠–ù–î–õ–ï–† cq_admin_role_view_details_entry –í–´–ó–í–ê–ù! Callback: {callback_data.model_dump_json(exclude_none=True)}") # <--- –£–ë–†–ê–ù–û
    
    admin_user_id = query.from_user.id
    target_role_db_id: Optional[int] = None 
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    roles_texts = get_roles_mgmt_texts(services_provider, user_locale)
    
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—É—á–µ–Ω callback –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏: {callback_data.model_dump_json(exclude_none=True)}")

    if callback_data.item_id is None or not str(callback_data.item_id).isdigit():
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id (ID —Ä–æ–ª–∏: {callback_data.item_id}) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π.")
        await query.answer(admin_texts["admin_error_role_id_invalid"], show_alert=True)
        return
    
    target_role_db_id = int(str(callback_data.item_id))
        
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏ —Ä–æ–ª–∏ —Å DB ID: {target_role_db_id}")

    async with services_provider.db.get_session() as session: # type: AsyncSession
        has_perm_to_view = False
        is_owner_from_config = admin_user_id in services_provider.config.core.super_admins
        if is_owner_from_config:
            has_perm_to_view = True
            logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} —è–≤–ª—è–µ—Ç—Å—è –í–ª–∞–¥–µ–ª—å—Ü–µ–º, –¥–æ—Å—Ç—É–ø –∫ –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω.")
        else:
            try:
                has_perm_to_view = await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_VIEW)
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ '{PERMISSION_CORE_ROLES_VIEW}': {has_perm_to_view}")
            except Exception as e_perm:
                 logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_VIEW –¥–ª—è {admin_user_id}: {e_perm}")
                 await query.answer(admin_texts["error_general"], show_alert=True)
                 return

        if not has_perm_to_view:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏.")
            await query.answer(admin_texts["access_denied"], show_alert=True)
            return

        role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        
        if not role:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å —Å DB ID: {target_role_db_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            await query.answer(admin_texts["not_found_generic"], show_alert=True)
            return
        
        logger.debug(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å '{role.name}' –Ω–∞–π–¥–µ–Ω–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã...")
        permissions_list_str = "\n".join(
            [f"  ‚ñ´Ô∏è {hcode(p.name)} ({hitalic(p.description or '–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è')})" for p in sorted(role.permissions, key=lambda x: x.name)]
        ) if role.permissions else "  (–Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π)"  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã

        text_parts = [
            f"{roles_texts['role_details_title']}: {hcode(role.name)}",
            f"   DB ID: {hcode(str(role.id))}",
            f"   –û–ø–∏—Å–∞–Ω–∏–µ: {hitalic(role.description or '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}",  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
            f"\n{hbold('–†–∞–∑—Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π —Ä–æ–ª–∏:')}",  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
            permissions_list_str
        ]
        text = "\n".join(text_parts)
        
        keyboard = await get_admin_role_details_keyboard_local(role, services_provider, admin_user_id, session, locale=user_locale)
        logger.debug(f"[{MODULE_NAME_FOR_LOG}] –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ '{role.name}' —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞.")

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                    logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ä–æ–ª–∏ '{role.name}' –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.")
                else:
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
                await query.answer()
            except TelegramBadRequest as e_tbr:
                if "message is not modified" in str(e_tbr).lower():
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                    await query.answer()
                else:
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}): {e_tbr}")
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_role_view_details_entry –¥–ª—è —Ä–æ–ª–∏ {role.id}: {e_edit}", exc_info=True)
                await query.answer(admin_texts["error_general"], show_alert=True)
        else: 
             logger.warning(f"[{MODULE_NAME_FOR_LOG}] query.message is None –≤ cq_admin_role_view_details_entry –¥–ª—è —Ä–æ–ª–∏ {role.id}.")
             await query.answer()


======================================================================

------------------------------ FILE: Systems/core/admin/users/keyboards_users.py ------------------------------
# SwiftDevBot/core/admin/users/keyboards_users.py
from typing import TYPE_CHECKING, List, Set, Dict, Optional
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger

from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate, AdminMainMenuNavigate
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button, get_admin_texts
from Systems.core.rbac.service import (
    PERMISSION_CORE_USERS_ASSIGN_ROLES, 
    PERMISSION_CORE_USERS_MANAGE_STATUS,
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS, # <--- –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
    DEFAULT_ROLE_USER 
)

if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession
    from Systems.core.database.core_models import User as DBUser, Role as DBRole, Permission as DBPermission


def get_users_mgmt_texts(services_provider: 'BotServicesProvider', locale: Optional[str] = None) -> dict:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    if not locale:
        locale = services_provider.config.core.i18n.default_locale
    
    from Systems.core.admin.keyboards_admin_common import _get_admin_translator
    translator = _get_admin_translator(services_provider)
    
    def t(key: str, **kwargs) -> str:
        return translator.gettext(key, locale, **kwargs)
    
    return {
        "user_list_title_template": t("admin_user_list_title_template"),
        "user_details_title": t("admin_user_details_title"),
        "user_action_change_roles": t("admin_user_action_change_roles"),
        "user_action_toggle_active": t("admin_user_action_toggle_active"),
        "user_action_toggle_blocked": t("admin_user_action_toggle_blocked"),
        "edit_roles_for_user": t("admin_edit_roles_for_user"),
        "back_to_user_details": t("admin_back_to_user_details"),
        "user_is_owner_text": t("admin_user_is_owner_text"),
        "user_action_direct_perms": t("admin_user_action_direct_perms"),
        "edit_direct_perms_for_user": t("admin_edit_direct_perms_for_user"),
        "perm_status_direct": t("admin_perm_status_direct"),
        "perm_status_role": t("admin_perm_status_role"),
        "perm_status_none": t("admin_perm_status_none"),
        "back_to_direct_perm_categories": t("admin_back_to_direct_perm_categories"),
        "back_to_direct_perm_core_groups": t("admin_back_to_direct_perm_core_groups"),
        "back_to_direct_perm_module_list": t("admin_back_to_direct_perm_module_list"),
        "no_users_to_display": t("admin_no_users_to_display"),
        "user_active_yes": t("admin_user_active_yes"),
        "user_active_no": t("admin_user_active_no"),
        "user_blocked_yes": t("admin_user_blocked_yes"),
        "user_blocked_no": t("admin_user_blocked_no"),
        "user_no_roles": t("admin_user_no_roles"),
        "user_telegram_id": t("admin_user_telegram_id"),
        "user_db_id": t("admin_user_db_id"),
        "user_username": t("admin_user_username"),
        "user_first_name": t("admin_user_first_name"),
        "user_last_name": t("admin_user_last_name"),
        "user_language": t("admin_user_language"),
        "user_active": t("admin_user_active"),
        "user_bot_blocked": t("admin_user_bot_blocked"),
        "user_roles_status": t("admin_user_roles_status"),
        "user_registration": t("admin_user_registration"),
        "user_last_activity": t("admin_user_last_activity"),
    }

# –°—Ç–∞—Ä—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (deprecated)
USERS_MGMT_TEXTS = {
    "user_list_title_template": ADMIN_COMMON_TEXTS.get("user_list_title_template", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–°—Ç—Ä. {current_page}/{total_pages})"),
    "user_details_title": ADMIN_COMMON_TEXTS.get("user_details_title", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"),
    "user_action_change_roles": ADMIN_COMMON_TEXTS.get("user_action_change_roles", "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª–∏"),
    "user_action_toggle_active": ADMIN_COMMON_TEXTS.get("user_action_toggle_active", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {status}"),
    "user_action_toggle_blocked": ADMIN_COMMON_TEXTS.get("user_action_toggle_blocked", "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: {status}"),
    "edit_roles_for_user": ADMIN_COMMON_TEXTS.get("edit_roles_for_user", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π –¥–ª—è: {user_name}"),
    "back_to_user_details": ADMIN_COMMON_TEXTS.get("back_to_user_details", "‚¨ÖÔ∏è –ö –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
    "user_is_owner_text": ADMIN_COMMON_TEXTS.get("user_is_owner_text", "üëë –í–ª–∞–¥–µ–ª–µ—Ü —Å–∏—Å—Ç–µ–º—ã (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)"),
    "user_action_direct_perms": "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è",
    "edit_direct_perms_for_user": "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è: {user_name}",
    "perm_status_direct": "‚úÖ (–ø—Ä—è–º–æ–µ)",
    "perm_status_role": "‚òëÔ∏è (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)",
    "perm_status_none": "‚¨ú (–Ω–µ—Ç)",
    "back_to_direct_perm_categories": "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–ª—è —é–∑–µ—Ä–∞)",
    "back_to_direct_perm_core_groups": "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞ (–¥–ª—è —é–∑–µ—Ä–∞)",
    "back_to_direct_perm_module_list": "‚¨ÖÔ∏è –ö –º–æ–¥—É–ª—è–º (–¥–ª—è —é–∑–µ—Ä–∞)",
}


async def get_admin_users_list_keyboard_local( 
    users_on_page: List['DBUser'],
    total_pages: int,
    current_page: int,
    services_provider: Optional['BotServicesProvider'] = None,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if services_provider:
        users_texts = get_users_mgmt_texts(services_provider, locale)
        admin_texts = get_admin_texts(services_provider, locale)
    else:
        users_texts = USERS_MGMT_TEXTS
        admin_texts = ADMIN_COMMON_TEXTS
    
    if not users_on_page and current_page == 1:
        builder.button(text=users_texts.get("no_users_to_display", "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"), callback_data=AdminUsersPanelNavigate(action="dummy_no_users").pack())
    else:
        for user_obj in users_on_page:
            user_display = f"{user_obj.full_name}"
            if user_obj.username: user_display += f" (@{user_obj.username})"
            else: user_display += f" (ID: {user_obj.telegram_id})"
            
            status_icons = ["üí§" if not user_obj.is_active else "", "üö´" if user_obj.is_bot_blocked else ""]
            status_prefix = "".join(filter(None, status_icons)) + " " if any(status_icons) else ""

            builder.button(
                text=f"{status_prefix}{user_display}",
                callback_data=AdminUsersPanelNavigate(action="view", item_id=user_obj.id).pack()
            )
        builder.adjust(1)

    if total_pages > 1:
        pagination_row = []
        if current_page > 1:
            pagination_row.append(InlineKeyboardButton(
                text=admin_texts["pagination_prev"],
                callback_data=AdminUsersPanelNavigate(action="list", page=current_page - 1).pack()
            ))
        pagination_row.append(InlineKeyboardButton(
            text=f"{current_page}/{total_pages}",
            callback_data=AdminUsersPanelNavigate(action="dummy_page").pack() 
        ))
        if current_page < total_pages:
            pagination_row.append(InlineKeyboardButton(
                text=admin_texts["pagination_next"],
                callback_data=AdminUsersPanelNavigate(action="list", page=current_page + 1).pack()
            ))
        if pagination_row:
            builder.row(*pagination_row)

    builder.row(get_back_to_admin_main_menu_button(services_provider, locale))
    return builder.as_markup()


async def get_admin_user_details_keyboard_local( 
    target_user: 'DBUser', 
    services: 'BotServicesProvider',
    current_admin_tg_id: int, 
    session: 'AsyncSession',
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == current_admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    users_texts = get_users_mgmt_texts(services, locale)
    admin_texts = get_admin_texts(services, locale)
    
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins
    target_user_is_owner = target_user.telegram_id in services.config.core.super_admins

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –£–°–õ–û–í–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–ö–ò "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" ---
    can_manage_direct_perms = False
    if not target_user_is_owner: # –ù–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        if current_admin_is_owner: # –í–ª–∞–¥–µ–ª–µ—Ü –∫–æ–Ω—Ñ–∏–≥–∞ –º–æ–∂–µ—Ç –≤—Å—ë (–∫—Ä–æ–º–µ –ø—Ä–∞–≤ –¥—Ä—É–≥–∏—Ö –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤)
            can_manage_direct_perms = True
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS
            if await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
                can_manage_direct_perms = True
    
    if can_manage_direct_perms:
    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        builder.button(
            text=users_texts["user_action_direct_perms"],
            callback_data=AdminUsersPanelNavigate(action="edit_direct_perms_start", item_id=target_user.id).pack()
        )

    if not target_user_is_owner: 
        if current_admin_is_owner or \
           await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
            builder.button(
                text=users_texts["user_action_change_roles"],
                callback_data=AdminUsersPanelNavigate(action="edit_roles_start", item_id=target_user.id).pack()
            )

        if current_admin_is_owner or \
           await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
            active_status_text = users_texts["user_active_no"] if target_user.is_active else users_texts["user_active_yes"]
            builder.button(
                text=users_texts["user_action_toggle_active"].format(status=active_status_text),
                callback_data=AdminUsersPanelNavigate(action="toggle_active", item_id=target_user.id).pack()
            )
            blocked_status_text = users_texts["user_blocked_yes"] if target_user.is_bot_blocked else users_texts["user_blocked_no"]
            builder.button(
                text=users_texts["user_action_toggle_blocked"].format(status=blocked_status_text),
                callback_data=AdminUsersPanelNavigate(action="toggle_blocked", item_id=target_user.id).pack()
            )
    
    if builder.export(): 
        builder.adjust(1)

    builder.row(InlineKeyboardButton(
        text="‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã
        callback_data=AdminUsersPanelNavigate(action="list", page=1).pack() 
    ))
    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()

async def get_admin_user_edit_roles_keyboard_local( 
    target_user: 'DBUser',
    all_system_roles: List['DBRole'],
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == current_admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    users_texts = get_users_mgmt_texts(services, locale)
    admin_texts = get_admin_texts(services, locale)
    
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins

    target_user_role_ids: Set[int] = {role.id for role in target_user.roles if role.id is not None}

    for role in sorted(all_system_roles, key=lambda r: r.name):
        if role.id is None: continue 

        is_assigned = role.id in target_user_role_ids
        prefix = "‚úÖ " if is_assigned else "‚¨ú "
        
        can_toggle_this_role = False
        if current_admin_is_owner:
            can_toggle_this_role = True
        elif await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
            if role.name == DEFAULT_ROLE_USER and is_assigned and len(target_user.roles) == 1:
                can_toggle_this_role = False
                prefix = "üîí " 
            else:
                can_toggle_this_role = True
        
        if can_toggle_this_role:
            builder.button(
                text=f"{prefix}{role.name}",
                callback_data=AdminUsersPanelNavigate(
                    action="toggle_role", 
                    item_id=target_user.id, 
                    role_id=role.id 
                ).pack()
            )
        else: 
            builder.button(
                text=f"{prefix}{role.name} (–Ω–µ—Ç –ø—Ä–∞–≤)", 
                callback_data=AdminUsersPanelNavigate(action="dummy_cant_toggle").pack() 
            )

    builder.adjust(1)
    builder.row(InlineKeyboardButton(
        text=users_texts["back_to_user_details"], 
        callback_data=AdminUsersPanelNavigate(action="view", item_id=target_user.id).pack()
    ))
    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()

# --- –ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
async def get_user_direct_perms_keyboard(
    target_user: 'DBUser', # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á—å–∏ –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è
    services: 'BotServicesProvider',
    current_admin_tg_id: int, # –ê–¥–º–∏–Ω, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç
    session: 'AsyncSession',
    all_system_permissions: List['DBPermission'], # –í—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:
    category_key: Optional[str] = None,
    entity_name: Optional[str] = None,
    page: int = 1,
    perms_per_page: int = 7,
    locale: Optional[str] = None
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == current_admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services.config.core.i18n.default_locale
    
    users_texts = get_users_mgmt_texts(services, locale)
    admin_texts = get_admin_texts(services, locale)
    texts = users_texts 
    
    user_direct_perm_ids: Set[int] = {perm.id for perm in target_user.direct_permissions if perm.id is not None}
    user_role_perm_ids: Set[int] = set()
    for role in target_user.roles:
        if role.permissions:
            user_role_perm_ids.update(p.id for p in role.permissions if p.id is not None)

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    builder.row(InlineKeyboardButton(
        text=texts["back_to_user_details"],
        callback_data=AdminUsersPanelNavigate(action="view", item_id=target_user.id).pack()
    ))

    # --- –£—Ä–æ–≤–µ–Ω—å 1: –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–Ø–¥—Ä–æ / –ú–æ–¥—É–ª–∏) ---
    if not category_key:
        builder.button(
            text=admin_texts["perm_category_core"], # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core", page=1).pack()
        )
        module_perms_exist = any(not p.name.startswith("core.") for p in all_system_permissions)
        if module_perms_exist:
            builder.button(
                text=admin_texts["perm_category_modules"],
                callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module", page=1).pack()
            )
        builder.adjust(1)
        return builder.as_markup()

    # --- –£—Ä–æ–≤–µ–Ω—å 2 –∏ 3: –í—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–º–æ–¥—É–ª—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
    permissions_to_display_final: List['DBPermission'] = []
    
    if category_key == "core":
        CORE_PERM_GROUPS_MAP_USERS: Dict[str, str] = { # –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã, —Ç.–∫. –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–æ–ª–µ–π
            "users": admin_texts["perm_core_group_users"], 
            "roles": admin_texts["perm_core_group_roles"],
            "modules_core": admin_texts["perm_core_group_modules_core"], 
            "system": admin_texts["perm_core_group_system"],
            "settings_core": admin_texts["perm_core_group_settings_core"], 
            "other": admin_texts["perm_core_group_other"]
        }
        CORE_PERM_PREFIXES_MAP_USERS: Dict[str, str] = { # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
            "users": "core.users.", "roles": "core.roles.", "modules_core": "core.modules.",
            "system": "core.system.", "settings_core": "core.settings."
        }

        if not entity_name: # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–¥—Ä–∞
            for group_key, group_display_name in CORE_PERM_GROUPS_MAP_USERS.items():
                prefix_to_check = CORE_PERM_PREFIXES_MAP_USERS.get(group_key)
                has_perms_in_group = False
                if prefix_to_check:
                    if any(p.name.startswith(prefix_to_check) for p in all_system_permissions): has_perms_in_group = True
                elif group_key == "other": 
                    known_prefixes = list(CORE_PERM_PREFIXES_MAP_USERS.values())
                    if any(p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes) for p in all_system_permissions): has_perms_in_group = True
                if has_perms_in_group:
                    builder.button(text=group_display_name, callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core", entity_name=group_key, page=1).pack())
            builder.adjust(1)
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_categories"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id).pack()))
        else: # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–¥—Ä–∞
            if entity_name == "other":
                known_prefixes = list(CORE_PERM_PREFIXES_MAP_USERS.values())
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes)]
            elif entity_name in CORE_PERM_PREFIXES_MAP_USERS:
                prefix = CORE_PERM_PREFIXES_MAP_USERS[entity_name]
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith(prefix)]
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_core_groups"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core").pack()))

    elif category_key == "module":
        if not services.modules: 
            builder.button(text="–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", callback_data="dummy_error_no_module_loader"); return builder.as_markup()
        module_permissions_map: Dict[str, List['DBPermission']] = {}
        module_display_names: Dict[str, str] = {}
        for p in all_system_permissions:
            if not p.name.startswith("core."):
                module_name_candidate = p.name.split('.')[0]
                if module_name_candidate not in module_permissions_map:
                    module_permissions_map[module_name_candidate] = []
                    mod_info = services.modules.get_module_info(module_name_candidate)
                    module_display_names[module_name_candidate] = mod_info.manifest.display_name if mod_info and mod_info.manifest else module_name_candidate
                module_permissions_map[module_name_candidate].append(p)
        if not entity_name: 
            sorted_module_names = sorted(module_permissions_map.keys())
            if not sorted_module_names: builder.button(text=admin_texts["no_modules_with_perms"], callback_data="dummy_no_mod_perms_for_user")
            else:
                for mod_name in sorted_module_names:
                    builder.button(text=f"üß© {module_display_names.get(mod_name, mod_name)}", callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module", entity_name=mod_name, page=1).pack())
            builder.adjust(1)
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_categories"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id).pack()))
        else: 
            permissions_to_display_final = module_permissions_map.get(entity_name, [])
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_module_list"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module").pack()))
    
    if permissions_to_display_final:
        permissions_to_display_final.sort(key=lambda p: p.name)
        total_perms_in_list = len(permissions_to_display_final)
        total_perm_pages = (total_perms_in_list + perms_per_page - 1) // perms_per_page
        total_perm_pages = max(1, total_perm_pages)
        current_perm_page = max(1, min(page, total_perm_pages))
        start_idx = (current_perm_page - 1) * perms_per_page
        end_idx = start_idx + perms_per_page
        paginated_perms = permissions_to_display_final[start_idx:end_idx]

        if not paginated_perms and current_perm_page == 1:
            builder.button(text=admin_texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_user")
        else:
            for perm in paginated_perms:
                if perm.id is None: continue
                status_prefix = texts["perm_status_none"] # ‚¨ú
                is_direct = perm.id in user_direct_perm_ids
                is_via_role = perm.id in user_role_perm_ids

                if is_direct:
                    status_prefix = texts["perm_status_direct"] # ‚úÖ
                elif is_via_role: # –ù–µ –ø—Ä—è–º–æ–µ, –Ω–æ —á–µ—Ä–µ–∑ —Ä–æ–ª—å
                    status_prefix = texts["perm_status_role"] # ‚òëÔ∏è
                
                button_text = f"{status_prefix} {perm.name}"
                
                can_toggle_locally = not (is_via_role and not is_direct)

                if can_toggle_locally:
                    builder.button(
                        text=button_text,
                        callback_data=AdminUsersPanelNavigate(
                            action="toggle_direct_perm", 
                            item_id=target_user.id, 
                            permission_id=perm.id,
                            category_key=category_key, 
                            entity_name=entity_name, 
                            page=current_perm_page
                        ).pack()
                    )
                else: 
                    builder.button(
                        text=button_text,
                        callback_data=AdminUsersPanelNavigate(action="dummy_perm_via_role").pack()
                    )
            builder.adjust(1)

            if total_perm_pages > 1:
                pagination_row_perms = []
                nav_cb_data_base = AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key=category_key, entity_name=entity_name)
                if current_perm_page > 1: pagination_row_perms.append(InlineKeyboardButton(text=admin_texts["pagination_prev"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page - 1}).pack()))
                pagination_row_perms.append(InlineKeyboardButton(text=f"{current_perm_page}/{total_perm_pages}", callback_data="dummy_direct_perm_page"))
                if current_perm_page < total_perm_pages: pagination_row_perms.append(InlineKeyboardButton(text=admin_texts["pagination_next"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page + 1}).pack()))
                if pagination_row_perms: builder.row(*pagination_row_perms)
    elif entity_name: 
        builder.button(text=admin_texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_user_entity")

    builder.row(get_back_to_admin_main_menu_button(services, locale))
    return builder.as_markup()




======================================================================

------------------------------ FILE: Systems/core/admin/users/handlers_direct_perms.py ------------------------------
# core/admin/users/handlers_direct_perms.py
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.filters import StateFilter # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º StateFilter
from aiogram.exceptions import TelegramBadRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º TelegramBadRequest

from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_user_direct_perms_keyboard, USERS_MGMT_TEXTS, get_users_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts 
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS 
from Systems.core.database.core_models import User as DBUser, Permission as DBPermission, Role as DBRole # –î–æ–±–∞–≤–∏–ª DBRole

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_direct_perms_router = Router(name="sdb_admin_user_direct_perms_handlers")
MODULE_NAME_FOR_LOG = "AdminUserDirectPerms"

#user_direct_perms_router.callback_query.filter(can_view_admin_panel_filter)

# --- FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –ø—Ä—è–º—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
class FSMDirectUserPermsNavigation(StatesGroup):
    navigating_direct_perms = State()

# --- –í—Ö–æ–¥ –≤ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ ---
@user_direct_perms_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "edit_direct_perms_start"))
async def cq_admin_user_edit_direct_perms_entry( # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    target_user_db_id = callback_data.item_id

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)

    if target_user_db_id is None:
        await query.answer(admin_texts["admin_error_user_id_not_specified"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –≤—Ö–æ–¥–∏—Ç –≤ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è User DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
            await query.answer(admin_texts["access_denied"], show_alert=True)
            return
        
        target_user = await session.get(DBUser, target_user_db_id)
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer(admin_texts["admin_error_cannot_manage_owner_direct_perms"], show_alert=True); return

    await state.clear() 
    await state.set_state(FSMDirectUserPermsNavigation.navigating_direct_perms)
    await state.update_data(
        target_user_id_for_perms=target_user_db_id, 
    )
    
    await _show_user_direct_perms_menu(query, services_provider, state)

# --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/—Å—É—â–Ω–æ—Å—Ç—è–º/—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "direct_perms_nav"),
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms)
)
async def cq_admin_user_direct_perms_navigate(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == query.from_user.id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    fsm_data = await state.get_data()
    target_user_db_id = fsm_data.get("target_user_id_for_perms")
    if target_user_db_id is None: 
        await query.answer(admin_texts["admin_error_fsm_state"], show_alert=True)
        await state.clear(); return

    new_fsm_context_data = {
        "category_key": callback_data.category_key,
        "entity_name": callback_data.entity_name,
        "current_page": callback_data.page or 1
    }
    await state.update_data(**new_fsm_context_data)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {query.from_user.id} –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä—è–º—ã–º –ø—Ä–∞–≤–∞–º (User ID: {target_user_db_id}). "
                f"–ù–æ–≤—ã–π FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {new_fsm_context_data}")
    
    await _show_user_direct_perms_menu(query, services_provider, state)

# --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "toggle_direct_perm"),
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms)
)
async def cq_admin_user_toggle_direct_perm(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    fsm_data = await state.get_data()
    target_user_db_id: Optional[int] = fsm_data.get("target_user_id_for_perms")
    permission_to_toggle_id: Optional[int] = callback_data.permission_id

    if target_user_db_id is None or permission_to_toggle_id is None:
        await query.answer(admin_texts["admin_error_invalid_permission_data"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ "
                f"PermID:'{permission_to_toggle_id}' –¥–ª—è User DBID:{target_user_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
            await query.answer(admin_texts["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.direct_permissions)])
        permission_to_modify = await session.get(DBPermission, permission_to_toggle_id)

        if not target_user or not permission_to_modify:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins: 
            await query.answer(admin_texts["admin_error_cannot_modify_owner_direct_perms"], show_alert=True); return

        user_has_direct_perm = permission_to_modify in target_user.direct_permissions
        alert_text, action_performed = "", False

        if user_has_direct_perm:
            if await services_provider.rbac.remove_direct_permission_from_user(session, target_user, permission_to_modify.name):
                action_performed = True
                alert_text = admin_texts["admin_direct_perm_removed"].format(permission_name=permission_to_modify.name)
            else: alert_text = admin_texts["admin_direct_perm_failed_to_remove"].format(permission_name=permission_to_modify.name)
        else:
            if await services_provider.rbac.assign_direct_permission_to_user(session, target_user, permission_to_modify.name, auto_create_perm=False):
                action_performed = True
                alert_text = admin_texts["admin_direct_perm_assigned"].format(permission_name=permission_to_modify.name)
            else: alert_text = admin_texts["admin_direct_perm_failed_to_assign"].format(permission_name=permission_to_modify.name)
        
        if action_performed:
            try: await session.commit(); logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è User ID: {target_user.id}"); await session.refresh(target_user, attribute_names=['direct_permissions'])
            except Exception as e: await session.rollback(); logger.error(f"–û—à–∏–±–∫–∞ commit: {e}"); alert_text = admin_texts["admin_error_saving"]
        
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)
        await _show_user_direct_perms_menu(query, services_provider, state) 

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
async def _show_user_direct_perms_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext
):
    admin_user_id = query.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)
    
    fsm_data = await state.get_data()
    
    target_user_db_id = fsm_data.get("target_user_id_for_perms")
    category_key = fsm_data.get("category_key")
    entity_name = fsm_data.get("entity_name")
    page = fsm_data.get("current_page", 1)

    if target_user_db_id is None:
        await query.answer(admin_texts["admin_error_fsm_state_user_id"], show_alert=True); await state.clear(); return

    async with services_provider.db.get_session() as session:
        target_user = await session.get(DBUser, target_user_db_id, options=[
            selectinload(DBUser.direct_permissions), 
            selectinload(DBUser.roles).selectinload(DBRole.permissions) 
        ])
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); await state.clear(); return

        all_system_permissions = await services_provider.rbac.get_all_permissions(session)
        
        base_text = users_texts["edit_direct_perms_for_user"].format(user_name=hbold(target_user.full_name))
        current_level_text = ""
        if category_key == "core":
            current_level_text = f" / {admin_texts['admin_perm_category_core']}"
            if entity_name: current_level_text += f" / {admin_texts.get(f'admin_perm_core_group_{entity_name}', entity_name.capitalize())}"
        elif category_key == "module":
            current_level_text = " / –ú–æ–¥—É–ª–∏"
            if entity_name:
                mod_info = services_provider.modules.get_module_info(entity_name)
                current_level_text += f" / {mod_info.manifest.display_name if mod_info and mod_info.manifest else entity_name}"
        
        text = f"{base_text}{current_level_text}\n–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:"
        
        keyboard = await get_user_direct_perms_keyboard(
            target_user=target_user,
            services=services_provider,
            current_admin_tg_id=admin_user_id,
            session=session,
            all_system_permissions=all_system_permissions,
            category_key=category_key,
            entity_name=entity_name,
            page=page,
            locale=user_locale
        )

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
            except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e).lower(): 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text (_show_user_direct_perms_menu): {e}")
            except Exception as e_edit:
                logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _show_user_direct_perms_menu: {e_edit}", exc_info=True)
                # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—à–∏–±–∫–∏
                user_locale_err = services_provider.config.core.i18n.default_locale
                try:
                    async with services_provider.db.get_session() as session:
                        from Systems.core.database.core_models import User as DBUser
                        from sqlalchemy import select
                        result = await session.execute(select(DBUser).where(DBUser.telegram_id == query.from_user.id))
                        db_user = result.scalar_one_or_none()
                        if db_user and db_user.preferred_language_code:
                            user_locale_err = db_user.preferred_language_code
                except Exception:
                    pass
                admin_texts_err = get_admin_texts(services_provider, user_locale_err)
                if query.message: await query.answer(admin_texts_err["admin_error_display"], show_alert=True)

# –í—ã—Ö–æ–¥ –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "view"), 
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms) 
)
async def cq_back_to_user_details_from_direct_perms_fsm(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    await state.clear() 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –≤—ã—à–µ–ª –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏.")
    from .handlers_details import cq_admin_user_view_details_entry
    await cq_admin_user_view_details_entry(query, callback_data, services_provider)


======================================================================

------------------------------ FILE: Systems/core/admin/users/__init__.py ------------------------------
# SwiftDevBot/core/admin/users/__init__.py
from aiogram import Router
from loguru import logger

# --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ò–ú–ü–û–†–¢ ---
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ core/admin/, –∞ –Ω–µ core/admin/users/
from ..filters_admin import can_view_admin_panel_filter # –ò—Å–ø–æ–ª—å–∑—É–µ–º .. –¥–ª—è –ø–æ–¥—ä–µ–º–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
from .handlers_list import users_list_router
from .handlers_details import user_details_router
from .handlers_roles_assign import user_roles_assign_router
from .handlers_direct_perms import user_direct_perms_router

# –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ "users"
section_users_router = Router(name="sdb_admin_section_users_router")

# –ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω –¥–æ–ª–∂–µ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ –≤–µ—Å—å —Ä–∞–∑–¥–µ–ª users
# section_users_router.message.filter(can_view_admin_panel_filter)
# section_users_router.callback_query.filter(can_view_admin_panel_filter)
# –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –≥–ª–∞–≤–Ω–æ–º—É admin_router, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ,
# –Ω–æ –Ω–µ –≤—Ä–µ–¥–Ω–æ. –õ—É—á—à–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–∞–≤–∞ –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.

section_users_router.include_router(users_list_router)
section_users_router.include_router(user_details_router)
section_users_router.include_router(user_roles_assign_router)
section_users_router.include_router(user_direct_perms_router)

__all__ = ["section_users_router"]


======================================================================

------------------------------ FILE: Systems/core/admin/users/handlers_list.py ------------------------------
# core/admin/users/handlers_list.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy import select, func as sql_func # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢ func
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_users_list_keyboard_local, USERS_MGMT_TEXTS, get_users_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts 
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_USERS_VIEW_LIST
from Systems.core.database.core_models import User as DBUser

from typing import TYPE_CHECKING, List
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider

users_list_router = Router(name="sdb_admin_users_list_handlers")
MODULE_NAME_FOR_LOG = "AdminUserList"

#users_list_router.callback_query.filter(can_view_admin_panel_filter)

USERS_PER_PAGE_ADMIN_LOCAL = 10 

@users_list_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "list"))
async def cq_admin_users_list_entry( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider' 
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {callback_data.page or 1}")

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)

    async with services_provider.db.get_session() as session: 
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins: 
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_VIEW_LIST):
                await query.answer(admin_texts["access_denied"], show_alert=True)
                return
        
        current_page = callback_data.page if callback_data.page is not None else 1
        
        total_users = 0
        try:
            count_stmt = select(sql_func.count(DBUser.id)) 
            total_users_res = await session.execute(count_stmt)
            total_users = total_users_res.scalar_one_or_none() or 0
        except Exception as e_count:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e_count}")
            await query.answer(admin_texts["admin_error_getting_users_data"], show_alert=True)
            return
        
        total_pages = (total_users + USERS_PER_PAGE_ADMIN_LOCAL - 1) // USERS_PER_PAGE_ADMIN_LOCAL
        total_pages = max(1, total_pages) 
        current_page = max(1, min(current_page, total_pages))
        offset = (current_page - 1) * USERS_PER_PAGE_ADMIN_LOCAL

        stmt_users = (
            select(DBUser)
            .order_by(DBUser.id.desc()) 
            .limit(USERS_PER_PAGE_ADMIN_LOCAL)
            .offset(offset)
        )
        users_result = await session.execute(stmt_users)
        users_on_page: List[DBUser] = list(users_result.scalars().all())

        text = users_texts["user_list_title_template"].format(current_page=current_page, total_pages=total_pages)
        if total_users == 0 : 
             text = "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n\n–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—ã

        keyboard = await get_admin_users_list_keyboard_local(users_on_page, total_pages, current_page, services_provider, user_locale)

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                else:
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.")
                await query.answer()
            except TelegramBadRequest as e_tbr:
                if "message is not modified" in str(e_tbr).lower():
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                    await query.answer()
                else:
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e_tbr}")
                    await query.answer() 
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_users_list_entry: {e_edit}", exc_info=True)
                await query.answer(admin_texts["error_general"], show_alert=True)


======================================================================

------------------------------ FILE: Systems/core/admin/users/handlers_details.py ------------------------------
# core/admin/users/handlers_details.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold, hcode
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_user_details_keyboard_local, USERS_MGMT_TEXTS, get_users_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts 
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_USERS_VIEW_DETAILS, PERMISSION_CORE_USERS_MANAGE_STATUS
from Systems.core.database.core_models import User as DBUser

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_details_router = Router(name="sdb_admin_user_details_handlers")
MODULE_NAME_FOR_LOG = "AdminUserDetails"

#user_details_router.callback_query.filter(can_view_admin_panel_filter)

async def _send_or_edit_user_details_local( 
    query: types.CallbackQuery, 
    target_user: DBUser, 
    services_provider: 'BotServicesProvider', 
    session: 'AsyncSession', 
    admin_tg_id: int,
    locale: Optional[str] = None
):
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not locale:
        try:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_tg_id))
            admin_user = result.scalar_one_or_none()
            if admin_user and admin_user.preferred_language_code:
                locale = admin_user.preferred_language_code
        except Exception:
            pass
        
        if not locale:
            locale = services_provider.config.core.i18n.default_locale
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
    users_texts = get_users_mgmt_texts(services_provider, locale)
    admin_texts = get_admin_texts(services_provider, locale)
    
    target_user_is_owner = target_user.telegram_id in services_provider.config.core.super_admins
    
    roles_display_str: str
    if target_user_is_owner:
        roles_display_str = users_texts["user_is_owner_text"]
    elif target_user.roles:
        roles_display_str = ", ".join(sorted([role.name for role in target_user.roles]))
    else:
        roles_display_str = users_texts["user_no_roles"]

    text_parts = [
        f"üë§ {hbold(users_texts['user_details_title'])}: {target_user.full_name}",
        f"   {users_texts['user_telegram_id']}: {hcode(str(target_user.telegram_id))}",
        f"   {users_texts['user_db_id']}: {hcode(str(target_user.id))}",
        f"   {users_texts['user_username']}: {hcode(f'@{target_user.username}') if target_user.username else '-'}",
        f"   {users_texts['user_first_name']}: {hcode(target_user.first_name or '-')}",
        f"   {users_texts['user_last_name']}: {hcode(target_user.last_name or '-')}",
        f"   {users_texts['user_language']}: {hcode(target_user.preferred_language_code or '-')}",
        f"   {users_texts['user_active']}: {users_texts['user_active_yes'] if target_user.is_active else users_texts['user_active_no']}",
        f"   {users_texts['user_bot_blocked']}: {users_texts['user_blocked_yes'] if target_user.is_bot_blocked else users_texts['user_blocked_no']}",
        f"   {users_texts['user_roles_status']}: {hbold(roles_display_str)}",
        f"   {users_texts['user_registration']}: {target_user.created_at.strftime('%Y-%m-%d %H:%M') if target_user.created_at else '-'}",
        f"   {users_texts['user_last_activity']}: {target_user.last_activity_at.strftime('%Y-%m-%d %H:%M') if target_user.last_activity_at else '-'}",
    ]
    text = "\n".join(text_parts)
    keyboard = await get_admin_user_details_keyboard_local(target_user, services_provider, admin_tg_id, session, locale=locale)

    if query.message:
        try:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}): {e_tbr}")
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _send_or_edit_user_details_local –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user.id}: {e_edit}", exc_info=True)


@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "view"))
async def cq_admin_user_view_details_entry( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None

    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    
    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError:
            await query.answer(admin_texts["admin_error_invalid_user_id_format"], show_alert=True); return
    
    if target_user_db_id is None:
        await query.answer(admin_texts["admin_error_user_id_not_specified"], show_alert=True); return
        
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_VIEW_DETAILS):
                await query.answer(admin_texts["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return
        
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
    await query.answer() 

@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_active"))
async def cq_admin_user_toggle_active_details( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError: pass
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)
    
    if target_user_db_id is None:
        await query.answer(admin_texts["admin_error_user_id_not_specified"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
                await query.answer(admin_texts["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return
        
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer(admin_texts["admin_error_cannot_change_owner_status"], show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
            return

        new_status = not target_user.is_active
        changed = await services_provider.user_service.set_user_active_status(target_user, new_status, session)
        alert_text = ""
        if changed:
            try:
                await session.commit()
                status_text = users_texts["user_active_yes"] if new_status else users_texts["user_active_no"]
                alert_text = admin_texts["admin_user_status_active_changed"].format(user_name=target_user.full_name, status=status_text)
                logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text}")
            except Exception as e_commit:
                await session.rollback()
                alert_text = admin_texts["admin_error_saving"]
        else:
            alert_text = admin_texts["admin_user_status_active_not_changed"]
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
        await query.answer(alert_text, show_alert=bool(changed and "–û—à–∏–±–∫–∞" not in alert_text)) 

@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_blocked"))
async def cq_admin_user_toggle_blocked_details( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError: pass
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)
    
    if target_user_db_id is None:
        await query.answer(admin_texts["admin_error_user_id_not_specified"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
                await query.answer(admin_texts["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer(admin_texts["admin_error_cannot_change_owner_block_status"], show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
            return

        new_status = not target_user.is_bot_blocked
        changed = await services_provider.user_service.set_user_bot_blocked_status(target_user, new_status, session)
        alert_text = ""
        if changed:
            try:
                await session.commit()
                status_text = users_texts["user_blocked_yes"] if new_status else users_texts["user_blocked_no"]
                alert_text = admin_texts["admin_user_block_status_changed"].format(user_name=target_user.full_name, status=status_text)
            except Exception as e_commit: await session.rollback(); alert_text = admin_texts["admin_error_saving"]
        else: alert_text = admin_texts["admin_user_block_status_not_changed"]
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
        await query.answer(alert_text, show_alert=bool(changed and "–û—à–∏–±–∫–∞" not in alert_text))


======================================================================

------------------------------ FILE: Systems/core/admin/users/handlers_roles_assign.py ------------------------------
# core/admin/users/handlers_roles_assign.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from Systems.core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_user_edit_roles_keyboard_local, USERS_MGMT_TEXTS, get_users_mgmt_texts
from Systems.core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_texts 
from Systems.core.admin.filters_admin import can_view_admin_panel_filter
from Systems.core.rbac.service import PERMISSION_CORE_USERS_ASSIGN_ROLES, DEFAULT_ROLE_USER
from Systems.core.database.core_models import User as DBUser, Role as DBRole
from .handlers_details import _send_or_edit_user_details_local

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_roles_assign_router = Router(name="sdb_admin_user_roles_assign_handlers")
MODULE_NAME_FOR_LOG = "AdminUserRolesAssign"

#user_roles_assign_router.callback_query.filter(can_view_admin_panel_filter)

@user_roles_assign_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "edit_roles_start"))
async def cq_admin_user_edit_roles_start_assign( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_locale = services_provider.config.core.i18n.default_locale
    try:
        async with services_provider.db.get_session() as session:
            from Systems.core.database.core_models import User as DBUser
            from sqlalchemy import select
            result = await session.execute(select(DBUser).where(DBUser.telegram_id == admin_user_id))
            db_user = result.scalar_one_or_none()
            if db_user and db_user.preferred_language_code:
                user_locale = db_user.preferred_language_code
    except Exception:
        pass
    
    admin_texts = get_admin_texts(services_provider, user_locale)
    users_texts = get_users_mgmt_texts(services_provider, user_locale)
    
    if callback_data.item_id is not None:
        try: 
            target_user_db_id = int(str(callback_data.item_id))
        except ValueError:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id '{callback_data.item_id}' –¥–ª—è edit_roles_start.")
            await query.answer(admin_texts["admin_error_invalid_user_id"], show_alert=True)
            return
    
    if target_user_db_id is None: 
        await query.answer(admin_texts["admin_error_user_id_for_roles_not_specified"], show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
                await query.answer(admin_texts["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(admin_texts["not_found_generic"], show_alert=True); return

        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer(admin_texts["admin_error_cannot_change_owner_roles"], show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id, locale=user_locale)
            return

        all_system_roles = await services_provider.rbac.get_all_roles(session)
        text = users_texts["edit_roles_for_user"].format(user_name=hbold(target_user.full_name))
        keyboard = await get_admin_user_edit_roles_keyboard_local(target_user, all_system_roles, services_provider, admin_user_id, session, locale=user_locale)

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e_tbr).lower(): await query.answer()
                else: logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text –¥–ª—è —Ä–æ–ª–µ–π: {e_tbr}")
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –≤ cq_admin_user_edit_roles_start_assign: {e_edit}", exc_info=True)
                await query.answer(admin_texts["error_general"], show_alert=True)

@user_roles_assign_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_role"))
async def cq_admin_user_toggle_role_assign( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    role_to_toggle_id: Optional[int] = None

    if callback_data.item_id is not None: 
        try: 
            target_user_db_id = int(str(callback_data.item_id))
        except ValueError: 
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id '{callback_data.item_id}' –¥–ª—è toggle_role.")
            pass 
    
    if callback_data.role_id is not None: 
        try: 
            role_to_toggle_id = int(str(callback_data.role_id))
        except ValueError: 
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π role_id '{callback_data.role_id}' –¥–ª—è toggle_role.")
            pass 

    if target_user_db_id is None or role_to_toggle_id is None:
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ ID –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–∏: user_id={target_user_db_id}, role_id={role_to_toggle_id}")
        await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å ID:{role_to_toggle_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID:{target_user_db_id}")

    async with services_provider.db.get_session() as session:
        is_current_admin_owner = admin_user_id in services_provider.config.core.super_admins
        if not is_current_admin_owner:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        role_to_modify = await session.get(DBRole, role_to_toggle_id)

        if not target_user or not role_to_modify:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞.", show_alert=True); return
            
        user_has_this_role = role_to_modify in target_user.roles
        if role_to_modify.name == DEFAULT_ROLE_USER and user_has_this_role and len(target_user.roles) == 1:
            await query.answer(f"–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–æ–ª—å '{DEFAULT_ROLE_USER}'.", show_alert=True); return
        
        alert_text, action_performed = "", False
        if user_has_this_role: 
            if await services_provider.rbac.remove_role_from_user(session, target_user, role_to_modify.name):
                action_performed, alert_text = True, f"–†–æ–ª—å '{role_to_modify.name}' —Å–Ω—è—Ç–∞."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–æ–ª—å '{role_to_modify.name}'."
        else: 
            if await services_provider.rbac.assign_role_to_user(session, target_user, role_to_modify.name):
                action_performed, alert_text = True, f"–†–æ–ª—å '{role_to_modify.name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–∞."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å '{role_to_modify.name}'."
        
        if action_performed:
            try: 
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è {target_user.full_name}")
                await session.refresh(target_user, attribute_names=['roles'])
            except Exception as e: 
                await session.rollback()
                logger.error(f"–û—à–∏–±–∫–∞ commit: {e}")
                alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
                action_performed=False 
        
        all_roles = await services_provider.rbac.get_all_roles(session) 
        keyboard_text = USERS_MGMT_TEXTS["edit_roles_for_user"].format(user_name=hbold(target_user.full_name))
        kb = await get_admin_user_edit_roles_keyboard_local(target_user, all_roles, services_provider, admin_user_id, session)
        if query.message: 
            try: 
                await query.message.edit_text(keyboard_text, reply_markup=kb) # –ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã keyboard_text
            except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e_tbr).lower():
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ä–æ–ª–µ–π (toggle): {e_tbr}")
            except Exception as e: 
                logger.warning(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è kb —Ä–æ–ª–µ–π (toggle): {e}")
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)


======================================================================

------------------------------ FILE: Systems/core/schemas/module_manifest.py ------------------------------
# core/schemas/module_manifest.py

from typing import List, Optional, Dict, Any, Union, Literal
from pydantic import BaseModel, Field, field_validator, HttpUrl, ValidationInfo
import re
from loguru import logger 


class CommandManifest(BaseModel):
    command: str = Field(..., description="–°–∞–º–∞ –∫–æ–º–∞–Ω–¥–∞ (–±–µ–∑ '/'). –ù–∞–ø—Ä–∏–º–µ—Ä, 'weather'.")
    description: str = Field(..., description="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è /help).")
    icon: Optional[str] = Field(default=None, description="–≠–º–æ–¥–∑–∏-–∏–∫–æ–Ω–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).")
    category: Optional[str] = Field(default=None, description="–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).")
    admin_only: bool = Field(default=False, alias="admin", description="–¢—Ä–µ–±—É–µ—Ç –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

class SettingChoiceOption(BaseModel):
    value: Any
    display_name: str

class SettingManifest(BaseModel):
    type: Literal["string", "int", "float", "bool", "choice", "multichoice", "text"] = Field(
        description="–¢–∏–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."
    )
    label: str = Field(..., description="–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è UI).")
    description: Optional[str] = Field(default=None, description="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è UI).")
    default: Optional[Any] = Field(default=None, description="–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ required=True –∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ñ–∏–≥–µ.")
    required: bool = Field(default=False, description="–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π.")
    options: Optional[List[Union[str, int, float, SettingChoiceOption]]] = Field(
        default=None,
        description="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."
    )
    min_value: Optional[Union[int, float]] = Field(default=None, alias="min", description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.")
    max_value: Optional[Union[int, float]] = Field(default=None, alias="max", description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.")
    regex_validator: Optional[str] = Field(default=None, description="–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏.")

    @field_validator('options', mode='before')
    @classmethod
    def _check_options_for_choice_type(cls, v: Optional[List[Any]], info: ValidationInfo) -> Optional[List[Any]]:
        setting_type = info.data.get('type') if info.data else None
        if setting_type in ["choice", "multichoice"] and (v is None or not v):
            raise ValueError(f"–ü–æ–ª–µ 'options' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç–∏–ø–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{setting_type}'")
        if setting_type not in ["choice", "multichoice"] and v is not None:
            logger.warning(f"–ü–æ–ª–µ 'options' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'choice'/'multichoice', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        return v

    @field_validator('min_value', 'max_value', mode='before')
    @classmethod
    def _check_min_max_for_numeric_type(cls, v: Optional[Union[int, float]], info: ValidationInfo) -> Optional[Union[int, float]]:
        setting_type = info.data.get('type') if info.data else None
        field_name = info.field_name 
        if setting_type not in ["int", "float"] and v is not None:
            logger.warning(f"–ü–æ–ª–µ '{field_name}' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'int'/'float', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        return v

    @field_validator('regex_validator', mode='before')
    @classmethod
    def _check_regex_for_string_type(cls, v: Optional[str], info: ValidationInfo) -> Optional[str]:
        setting_type = info.data.get('type') if info.data else None
        if setting_type != "string" and v is not None:
            logger.warning(f"–ü–æ–ª–µ 'regex_validator' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'string', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        if v is not None:
            try: re.compile(v)
            except re.error as e: raise ValueError(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π regex –≤ 'regex_validator': {e}")
        return v

    @field_validator('default', mode='after') 
    @classmethod
    def _check_default_for_required(cls, v: Optional[Any], info: ValidationInfo) -> Optional[Any]:
        if info.data.get('required') and v is None:
             field_label = info.data.get('label', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞') 
             raise ValueError(f"–î–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{field_label}' (required=True) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ 'default' –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")
        return v

class PermissionManifest(BaseModel): 
    name: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'my_module.can_edit_items'). –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'module_name.permission_key'.")
    description: str = Field(..., description="–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.")

    @field_validator('name')
    @classmethod
    def _validate_permission_name_format(cls, v: str, info: ValidationInfo) -> str:
        if not re.fullmatch(r"^[a-z0-9_]+(\.[a-z0-9_]+)+$", v.lower()):
            raise ValueError(f"–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{v}' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'module_name.permission_key' "
                             f"(–Ω–∞–ø—Ä–∏–º–µ—Ä, 'example_module.view_data') –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, '_' –∏ '.'")
        return v.lower() 


class BackgroundTaskManifest(BaseModel):
    entry_point: str = Field(...)
    schedule: Optional[str] = Field(default=None)
    description: Optional[str] = Field(default=None)

class ModuleMetadata(BaseModel):
    homepage: Optional[HttpUrl] = Field(default=None)
    license: Optional[str] = Field(default=None)
    tags: List[str] = Field(default_factory=list)
    min_sdb_core_version: Optional[str] = Field(default=None)
    assign_default_access_to_user_role: bool = Field( # <--- –ù–û–í–û–ï –ü–û–õ–ï
        default=False, 
        description="–ï—Å–ª–∏ true, –±–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{module_name}.access_user_features' –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ 'User'."
    )

    @field_validator('min_sdb_core_version', mode='before')
    @classmethod
    def _validate_semver_format(cls, v: Optional[str]) -> Optional[str]:
        if v is not None:
            semver_regex = r"^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
            if not re.fullmatch(semver_regex, v):
                raise ValueError(f"min_sdb_core_version ('{v}') –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ SemVer")
        return v

class ModuleManifest(BaseModel):
    model_config = {"protected_namespaces": ()}
    
    name: str = Field(..., min_length=3, pattern=r'^[a-z][a-z0-9_]*[a-z0-9]$')
    display_name: str = Field(..., min_length=3)
    version: str = Field(...)
    description: Optional[str] = Field(default=None)
    author: Optional[str] = Field(default=None)
    
    python_requirements: List[str] = Field(default_factory=list)
    sdb_module_dependencies: List[str] = Field(default_factory=list)
    model_definitions: List[str] = Field(default_factory=list)
    commands: List[CommandManifest] = Field(default_factory=list)
    settings: Dict[str, SettingManifest] = Field(default_factory=dict) 
    declared_permissions: List[PermissionManifest] = Field(default_factory=list, alias="permissions")
    background_tasks: Dict[str, BackgroundTaskManifest] = Field(default_factory=dict)
    metadata: ModuleMetadata = Field(default_factory=ModuleMetadata) # <--- –ò–ó–ú–ï–ù–ï–ù–û: metadata —Ç–µ–ø–µ—Ä—å –Ω–µ Optional, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ –ø–æ–ª–µ assign_default_access_to_user_role

    @field_validator('version', mode='before')
    @classmethod
    def _validate_module_version_format(cls, v: str) -> str:
        semver_regex = r"^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
        if not re.fullmatch(semver_regex, v):
            raise ValueError(f"–í–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è ('{v}') –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É SemVer 2.0.0")
        return v

    @field_validator('name', mode='before')
    @classmethod
    def _validate_module_name(cls, v: str) -> str:
        if not v.islower() and "_" not in v: 
            if v.lower() != v: 
                 logger.warning(f"–ò–º—è –º–æ–¥—É–ª—è '{v}' —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è snake_case.")
        return v
        
    @field_validator('declared_permissions') 
    @classmethod
    def _validate_permission_names_match_module(cls, v: List[PermissionManifest], info: ValidationInfo) -> List[PermissionManifest]:
        module_name = info.data.get('name') 
        if module_name:
            for perm_manifest in v:
                if not perm_manifest.name.startswith(f"{module_name}."):
                    raise ValueError(
                        f"–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{perm_manifest.name}' –≤ –º–æ–¥—É–ª–µ '{module_name}' "
                        f"–¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ '{module_name}.'"
                    )
        return v

    model_config = {
        "extra": "forbid",
        "protected_namespaces": (),
        "validate_assignment": True,
        "populate_by_name": True
    }


======================================================================

------------------------------ FILE: Systems/core/users/service.py ------------------------------
# SwiftDevBot/core/users/service.py
from typing import TYPE_CHECKING, Optional, Tuple, List 
from aiogram import types as aiogram_types
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, orm 
from sqlalchemy.orm import attributes as orm_attributes 
from loguru import logger
from sqlalchemy.exc import IntegrityError 
from datetime import datetime, timezone 

from Systems.core.database.core_models import User as DBUser, Role as DBRole 
from Systems.core.rbac.service import DEFAULT_ROLE_USER 

if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.app_settings import I18nSettings 
    from Systems.core.rbac.service import RBACService 


class UserService:
    def __init__(self, services_provider: 'BotServicesProvider'):
        self._services = services_provider
        self._logger = logger.bind(service="UserService")
        self._logger.info("UserService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def _get_user_by_telegram_id(self, telegram_id: int, session: AsyncSession, load_roles: bool = False, load_direct_perms: bool = False) -> Optional[DBUser]:
        self._logger.trace(f"–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î. TG ID: {telegram_id}, –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π: {load_roles}, –ø—Ä—è–º—ã—Ö –ø—Ä–∞–≤: {load_direct_perms}")
        stmt = select(DBUser).where(DBUser.telegram_id == telegram_id)
        options_to_load = []
        if load_roles:
            options_to_load.append(orm.selectinload(DBUser.roles).selectinload(DBRole.permissions))
        if load_direct_perms:
            options_to_load.append(orm.selectinload(DBUser.direct_permissions))
        
        if options_to_load:
            stmt = stmt.options(*options_to_load)
            
        result = await session.execute(stmt)
        user = result.scalars().first()
        if user:
            roles_loaded_str = "–Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ"
            if load_roles:
                is_roles_relationship_loaded = orm_attributes.instance_state(user).has_identity and \
                                            'roles' in orm_attributes.instance_state(user).committed_state
                
                roles_loaded_str = "–∑–∞–≥—Ä—É–∂–µ–Ω—ã" if is_roles_relationship_loaded and user.roles is not None else "–ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
                if is_roles_relationship_loaded and user.roles is not None:
                     self._logger.trace(f"User roles data (count): {len(user.roles)}")
                elif not is_roles_relationship_loaded:
                    self._logger.trace(f"–ê—Ç—Ä–∏–±—É—Ç 'roles' –Ω–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}, —Ö–æ—Ç—è load_roles=True.")

            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–∞–π–¥–µ–Ω –≤ –ë–î (DB ID: {user.id}). –†–æ–ª–∏: {roles_loaded_str}")
        else:
            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î.")
        return user

    async def _update_existing_user_data(
        self,
        db_user: DBUser,
        tg_user: aiogram_types.User,
        current_lang_code: str
        ) -> bool: # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –±—ã–ª–∏ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ–º–µ last_activity_at)
        updated_fields_log: dict = {}
        data_changed_meaningfully = False # –§–ª–∞–≥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ last_activity

        if db_user.username != tg_user.username:
            updated_fields_log['username'] = (db_user.username, tg_user.username)
            db_user.username = tg_user.username
            db_user.username_lower = tg_user.username.lower() if tg_user.username else None 
            data_changed_meaningfully = True
        if db_user.first_name != tg_user.first_name:
            updated_fields_log['first_name'] = (db_user.first_name, tg_user.first_name)
            db_user.first_name = tg_user.first_name
            data_changed_meaningfully = True
        if db_user.last_name != tg_user.last_name:
            updated_fields_log['last_name'] = (db_user.last_name, tg_user.last_name)
            db_user.last_name = tg_user.last_name
            data_changed_meaningfully = True
        # –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º preferred_language_code, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª –µ–≥–æ —è–≤–Ω–æ
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫, –¥–∞–∂–µ –µ—Å–ª–∏ —è–∑—ã–∫ Telegram –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (None)
        if db_user.preferred_language_code is None and current_lang_code:
            updated_fields_log['preferred_language_code'] = (db_user.preferred_language_code, current_lang_code)
            db_user.preferred_language_code = current_lang_code
            data_changed_meaningfully = True
            self._logger.debug(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —è–∑—ã–∫ –∏–∑ Telegram –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {tg_user.id}: {current_lang_code} (—è–∑—ã–∫ –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ)")
        
        is_owner_check = tg_user.id in self._services.config.core.super_admins

        if is_owner_check:
            if not db_user.is_active:
                db_user.is_active = True; data_changed_meaningfully = True
                updated_fields_log['is_active (owner override)'] = (False, True)
            # –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
            # if db_user.is_bot_blocked:
            #     db_user.is_bot_blocked = False; data_changed_meaningfully = True
            #     updated_fields_log['is_bot_blocked (owner override)'] = (True, False)
        else:
            # –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # if db_user.is_bot_blocked:
            #     updated_fields_log['is_bot_blocked (user active)'] = (db_user.is_bot_blocked, False)
            #     db_user.is_bot_blocked = False
            #     data_changed_meaningfully = True
            if not db_user.is_active:
                updated_fields_log['is_active (user active)'] = (db_user.is_active, True)
                db_user.is_active = True
                data_changed_meaningfully = True

        # –û–±–Ω–æ–≤–ª—è–µ–º last_activity_at —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if db_user.is_active and not db_user.is_bot_blocked:
            db_user.last_activity_at = datetime.now(timezone.utc)
        elif not db_user.is_active:
            self._logger.debug(f"–ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º last_activity_at –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id}")
        elif db_user.is_bot_blocked:
            self._logger.debug(f"–ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º last_activity_at –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id}")
        
        if data_changed_meaningfully:
            self._logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id} (DB ID: {db_user.id}) –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {updated_fields_log}")
        
        return data_changed_meaningfully

    async def process_user_on_start(self, tg_user: aiogram_types.User) -> Tuple[Optional[DBUser], bool]:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–ª–∏ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º —Å–æ–±—ã—Ç–∏–∏.
        –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (DBUser, user_was_created_bool).
        """
        self._logger.info(f"UserService.process_user_on_start –¥–ª—è TG ID: {tg_user.id} (@{tg_user.username or 'N/A'})")
        
        is_owner = tg_user.id in self._services.config.core.super_admins
        if is_owner:
            self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {tg_user.id} –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü —Å–∏—Å—Ç–µ–º—ã.")

        user_was_created = False # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥

        async with self._services.db.get_session() as session:
            try:
                db_user = await self._get_user_by_telegram_id(tg_user.id, session, load_roles=True) # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Ä–æ–ª—è–º–∏
                
                data_actually_changed_in_db = False # –§–ª–∞–≥ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –∫–æ–º–º–∏—Ç–∞

                i18n_settings: Optional["I18nSettings"] = getattr(self._services.config.core, 'i18n', None)
                available_locales = getattr(i18n_settings, 'available_locales', ['en', 'ua']) if i18n_settings else ['en', 'ua']
                default_locale = getattr(i18n_settings, 'default_locale', 'en') if i18n_settings else 'en'
                current_lang_code = tg_user.language_code if tg_user.language_code and tg_user.language_code in available_locales else default_locale
                self._logger.trace(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω —è–∑—ã–∫ '{current_lang_code}' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {tg_user.id}.")

                if not db_user:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
                    db_user = DBUser(
                        telegram_id=tg_user.id, username=tg_user.username,
                        username_lower=tg_user.username.lower() if tg_user.username else None,
                        first_name=tg_user.first_name, last_name=tg_user.last_name,
                        preferred_language_code=current_lang_code,
                        is_active=True, is_bot_blocked=False,
                        last_activity_at=datetime.now(timezone.utc) 
                    )
                    session.add(db_user) 
                    user_was_created = True # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
                    data_actually_changed_in_db = True
                    self._logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ —Å–æ–∑–¥–∞–Ω–∏—é.")
                else:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} (DB ID: {db_user.id}) –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...")
                    if await self._update_existing_user_data(db_user, tg_user, current_lang_code):
                        data_actually_changed_in_db = True
                    # last_activity_at –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ _update_existing_user_data, –∏ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å,
                    # —Ç–æ data_actually_changed_in_db –º–æ–∂–µ—Ç –±—ã—Ç—å False, –Ω–æ —Å–µ—Å—Å–∏—è –≤—Å–µ —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç dirty.
                    if db_user not in session.dirty and db_user not in session.new :
                        session.add(db_user) # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —Ç–∞–º
                    self._logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id} –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —Å–µ—Å—Å–∏–µ–π (–∏–∑–º–µ–Ω–µ–Ω–∏—è: {data_actually_changed_in_db}).")
                
                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
                rbac_service: Optional["RBACService"] = getattr(self._services, 'rbac', None)
                if rbac_service:
                    if user_was_created: 
                        await session.flush([db_user]) # –ü–æ–ª—É—á–∞–µ–º ID
                        self._logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –ø–æ–ª—É—á–∏–ª DB ID: {db_user.id} –ø–æ—Å–ª–µ flush.")
                        if is_owner:
                            # –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –∏–∑ .env –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å SuperAdmin
                            if await rbac_service.assign_role_to_user(session, db_user, "SuperAdmin"):
                                self._logger.info(f"–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {tg_user.id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å 'SuperAdmin'.")
                                data_actually_changed_in_db = True
                        else:
                            if await rbac_service.assign_role_to_user(session, db_user, DEFAULT_ROLE_USER):
                                data_actually_changed_in_db = True
                    elif db_user: # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                        if is_owner:
                            # –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –∏–∑ .env –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–æ–ª—å SuperAdmin
                            user_role_names = {r.name for r in db_user.roles} if db_user.roles else set()
                            if "SuperAdmin" not in user_role_names:
                                # –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å SuperAdmin –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                                if await rbac_service.assign_role_to_user(session, db_user, "SuperAdmin"):
                                    self._logger.info(f"–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {tg_user.id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å 'SuperAdmin'.")
                                    data_actually_changed_in_db = True
                            # –£–¥–∞–ª—è–µ–º –¥—Ä—É–≥–∏–µ —Ä–æ–ª–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (SuperAdmin –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞)
                            roles_to_remove = user_role_names - {"SuperAdmin"}
                            for role_name in roles_to_remove:
                                if await rbac_service.remove_role_from_user(session, db_user, role_name):
                                    self._logger.info(f"–†–æ–ª—å '{role_name}' —É–¥–∞–ª–µ–Ω–∞ —É —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {tg_user.id} (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–æ–ª—å 'SuperAdmin').")
                                    data_actually_changed_in_db = True
                        elif not db_user.roles: # –û–±—ã—á–Ω—ã–π —é–∑–µ—Ä –±–µ–∑ —Ä–æ–ª–µ–π - –¥–∞–µ–º User
                            if await rbac_service.assign_role_to_user(session, db_user, DEFAULT_ROLE_USER):
                                data_actually_changed_in_db = True
                
                # –ö–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–µ—Å—Å–∏—è "–≥—Ä—è–∑–Ω–∞—è"
                # (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_activity_at –¥–µ–ª–∞–µ—Ç —Å–µ—Å—Å–∏—é –≥—Ä—è–∑–Ω–æ–π)
                if data_actually_changed_in_db or (session.new or session.dirty or session.deleted): 
                    self._logger.info(f"UserService: –ü–ï–†–ï–î session.commit() –¥–ª—è TG ID {tg_user.id}. "
                                     f"Data changed: {data_actually_changed_in_db}, Dirty: {session.dirty}, New: {session.new}")
                    await session.commit()
                    self._logger.success(f"UserService: –ü–û–°–õ–ï session.commit() –¥–ª—è TG ID {tg_user.id}.")
                    if db_user: # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î
                        await session.refresh(db_user, attribute_names=['id', 'roles', 'direct_permissions', 'last_activity_at', 'is_active', 'is_bot_blocked'])
                        logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {db_user.id} –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ –ë–î –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ –≤ UserService.")
                else:
                    self._logger.trace(f"–ù–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–µ—Å—Å–∏–∏ –¥–ª—è TG ID {tg_user.id} –≤ UserService. –ö–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
                
                return db_user, user_was_created

            except IntegrityError as ie: # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–Ω–∫–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –º–µ–∂–¥—É SELECT –∏ INSERT)
                await session.rollback()
                self._logger.error(f"–û—à–∏–±–∫–∞ IntegrityError –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ TG ID {tg_user.id}. {ie.orig if hasattr(ie, 'orig') else ie}", exc_info=True)
                self._logger.info(f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID {tg_user.id} –ø–æ—Å–ª–µ IntegrityError.")
                db_user_retry = await self._get_user_by_telegram_id(tg_user.id, session, load_roles=True)
                if db_user_retry:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {tg_user.id} –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ.")
                    meaningful_data_updated_on_retry = await self._update_existing_user_data(db_user_retry, tg_user, current_lang_code)
                    
                    # –õ–æ–≥–∏–∫–∞ —Ä–æ–ª–µ–π –ø—Ä–∏ —Ä–µ—Ç—Ä–∞–µ (—É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–º–µ–µ—Ç —Ä–æ–ª—å Admin, –∞ —é–∑–µ—Ä —Å —Ä–æ–ª—å—é User)
                    if rbac_service:
                        if is_owner:
                            # –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –∏–∑ .env –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–æ–ª—å SuperAdmin
                            user_role_names_retry = {r.name for r in db_user_retry.roles} if db_user_retry.roles else set()
                            if "SuperAdmin" not in user_role_names_retry:
                                if await rbac_service.assign_role_to_user(session, db_user_retry, "SuperAdmin"):
                                    self._logger.info(f"–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {tg_user.id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å 'SuperAdmin' (retry).")
                            # –£–¥–∞–ª—è–µ–º –¥—Ä—É–≥–∏–µ —Ä–æ–ª–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (SuperAdmin –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞)
                            roles_to_remove_retry = user_role_names_retry - {"SuperAdmin"}
                            for role_name in roles_to_remove_retry:
                                if await rbac_service.remove_role_from_user(session, db_user_retry, role_name):
                                    self._logger.info(f"–†–æ–ª—å '{role_name}' —É–¥–∞–ª–µ–Ω–∞ —É —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {tg_user.id} (retry).")
                        elif not db_user_retry.roles: # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –∏ —É –Ω–µ–≥–æ –Ω–µ—Ç —Ä–æ–ª–µ–π
                             await rbac_service.assign_role_to_user(session, db_user_retry, DEFAULT_ROLE_USER)
                    
                    if meaningful_data_updated_on_retry or (session.new or session.dirty or session.deleted):
                        self._logger.info(f"UserService (retry): –ü–ï–†–ï–î session.commit() –¥–ª—è TG ID {tg_user.id}.")
                        await session.commit()
                        self._logger.success(f"UserService (retry): –ü–û–°–õ–ï session.commit() –¥–ª—è TG ID {tg_user.id}.")
                        await session.refresh(db_user_retry, attribute_names=['id', 'roles', 'direct_permissions', 'last_activity_at', 'is_active', 'is_bot_blocked'])
                    return db_user_retry, False # False, —Ç.–∫. –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –Ω–∞ –º–æ–º–µ–Ω—Ç —Ä–µ—Ç—Ä–∞—è
                self._logger.error(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {tg_user.id} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–∞–∂–µ –ø–æ—Å–ª–µ IntegrityError –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏.")
                return None, False
            except Exception as e: 
                self._logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ ({type(e).__name__}) –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ TG ID {tg_user.id} –≤ UserService: {e}", exc_info=True)
                if hasattr(session, 'is_active') and session.is_active: 
                    await session.rollback()
                return None, False
        
        self._logger.error(f"–í—ã—Ö–æ–¥ –∏–∑ process_user_on_start –¥–ª—è TG ID {tg_user.id} –±–µ–∑ —è–≤–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞.")
        return None, False
    
    async def update_user_language(self, user: DBUser, language_code: str, session: AsyncSession) -> bool:
        if user.preferred_language_code != language_code:
            user.preferred_language_code = language_code
            if user not in session.dirty and user not in session.new : session.add(user) 
            self._logger.info(f"–Ø–∑—ã–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '{language_code}' (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False

    async def set_user_active_status(self, user: DBUser, is_active: bool, session: AsyncSession) -> bool:
        if user.telegram_id in self._services.config.core.super_admins:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ ({user.telegram_id}). –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
            return False 

        if user.is_active != is_active:
            user.is_active = is_active
            if user not in session.dirty and user not in session.new : session.add(user)
            self._logger.info(f"–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {is_active} (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False

    async def set_user_bot_blocked_status(self, user: DBUser, is_bot_blocked: bool, session: AsyncSession) -> bool:
        if user.telegram_id in self._services.config.core.super_admins:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ ({user.telegram_id}). –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
            return False 

        if user.is_bot_blocked != is_bot_blocked:
            user.is_bot_blocked = is_bot_blocked
            if user not in session.dirty and user not in session.new : session.add(user)
            self._logger.info(f"–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {is_bot_blocked} (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False

    async def get_user_by_telegram_id(
        self, 
        session: AsyncSession, 
        telegram_id: int, 
        load_roles: bool = True,
        load_direct_perms: bool = False
    ) -> Optional[DBUser]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID.
        
        Args:
            session: Database session
            telegram_id: Telegram user ID
            load_roles: –ó–∞–≥—Ä—É–∂–∞—Ç—å –ª–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            load_direct_perms: –ó–∞–≥—Ä—É–∂–∞—Ç—å –ª–∏ –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            
        Returns:
            User object or None if not found
        """
        return await self._get_user_by_telegram_id(
            telegram_id=telegram_id,
            session=session,
            load_roles=load_roles,
            load_direct_perms=load_direct_perms
        )


======================================================================

------------------------------ FILE: Systems/core/users/__init__.py ------------------------------
# core/users/__init__.py
from .service import UserService

__all__ = ["UserService"]


======================================================================

------------------------------ FILE: Systems/core/users/middleware.py ------------------------------
# SwiftDevBot/core/users/middleware.py
from typing import Callable, Dict, Any, Awaitable, Optional
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, User as AiogramUser, Update 
from loguru import logger
from datetime import datetime, timezone 

from Systems.core.database.core_models import User as DBUser
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from Systems.core.ui.keyboards_core import TEXTS_CORE_KEYBOARDS_EN


from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.users.service import UserService 

MODULE_NAME_FOR_LOG = "UserStatusMiddleware"

class UserStatusMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: Update, 
        data: Dict[str, Any]
    ) -> Any:
        
        aiogram_event_user: Optional[AiogramUser] = data.get("event_from_user")
        if not aiogram_event_user:
            return await handler(event, data)

        user_tg_id = aiogram_event_user.id
        user_mention = f"@{aiogram_event_user.username}" if aiogram_event_user.username else f"ID:{user_tg_id}"
        
        services_provider: Optional['BotServicesProvider'] = data.get("services_provider")
        if not (services_provider and hasattr(services_provider, 'db') and hasattr(services_provider, 'user_service')):
            logger.critical(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã (DBManager, UserService) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã "
                           f"–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ data. –ü—Ä–æ–≤–µ—Ä–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
            if event.message: await event.message.reply("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            elif event.callback_query: await event.callback_query.answer("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.", show_alert=True)
            return None

        db_user: Optional[DBUser] = None
        user_service: 'UserService' = services_provider.user_service
        user_was_created_in_this_middleware_call = False # –§–ª–∞–≥ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ middleware

        try:
            async with services_provider.db.get_session() as session:
                stmt = select(DBUser).where(DBUser.telegram_id == user_tg_id)
                result = await session.execute(stmt)
                db_user = result.scalars().first()
        except Exception as e_get_user:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention}: {e_get_user}", exc_info=True)
            if event.message: await event.message.reply("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            elif event.callback_query: await event.callback_query.answer("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.", show_alert=True)
            return None

        is_owner_from_config = user_tg_id in services_provider.config.core.super_admins
        is_start_command = event.message and event.message.text and event.message.text.startswith("/start")

        if not db_user: 
            if is_start_command or is_owner_from_config:
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î. "
                            f"–≠—Ç–æ {'/start' if is_start_command else '–í–ª–∞–¥–µ–ª–µ—Ü ('+str(user_tg_id)+')'}. "
                            f"–í—ã–∑–æ–≤ UserService.process_user_on_start –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
                try:
                    processed_user, created_flag = await user_service.process_user_on_start(aiogram_event_user)
                    db_user = processed_user
                    if created_flag: # –ï—Å–ª–∏ UserService –µ–≥–æ –¢–û–õ–¨–ö–û –ß–¢–û –°–û–ó–î–ê–õ
                        user_was_created_in_this_middleware_call = True
                    
                    if not db_user:
                        # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ process_user_on_start)
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] UserService.process_user_on_start –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å/–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
                        if event.message: await event.message.reply("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
                        elif event.callback_query: await event.callback_query.answer("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.", show_alert=True)
                        return None
                    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω/–æ–±—Ä–∞–±–æ—Ç–∞–Ω UserService –≤ middleware. –ë—ã–ª —Å–æ–∑–¥–∞–Ω —Å–µ–π—á–∞—Å: {user_was_created_in_this_middleware_call}")
                except Exception as e_create_mw:
                    # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è e_create_mw)
                    logger.error(f"[{MODULE_NAME_FOR_LOG}] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ process_user_on_start –∏–∑ middleware –¥–ª—è {user_mention}: {e_create_mw}", exc_info=True)
                    if event.message: await event.message.reply("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.")
                    elif event.callback_query: await event.callback_query.answer("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è.", show_alert=True)
                    return None
            else: 
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –∏ —ç—Ç–æ –Ω–µ /start/–≤–ª–∞–¥–µ–ª–µ—Ü. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
                please_register_text = TEXTS_CORE_KEYBOARDS_EN.get("user_middleware_please_register", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º.")
                # ... (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ return None)
                if event.message:
                    try: await event.message.reply(please_register_text)
                    except Exception as e_reply: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä. {user_mention}: {e_reply}")
                elif event.callback_query:
                    try: await event.callback_query.answer(please_register_text, show_alert=True)
                    except Exception as e_answer: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback –æ —Ä–µ–≥–∏—Å—Ç—Ä. {user_mention}: {e_answer}")
                return None 
        elif not is_start_command: 
            logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–∞–π–¥–µ–Ω. –í—ã–∑–æ–≤ process_user_on_start –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
            try:
                processed_user, _ = await user_service.process_user_on_start(aiogram_event_user) # –§–ª–∞–≥ created –∑–¥–µ—Å—å –Ω–µ —Ç–∞–∫ –≤–∞–∂–µ–Ω
                if processed_user:
                    db_user = processed_user 
                else: 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] process_user_on_start –≤–µ—Ä–Ω—É–ª None –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware.")
            except Exception as e_update_mw:
                 logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware: {e_update_mw}", exc_info=True)
        
        if not db_user:
            logger.critical(f"[{MODULE_NAME_FOR_LOG}] db_user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è {user_mention}. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
            return None

        # –ü—Ä–æ–≤–µ—Ä–∫–∏ is_active –∏ is_bot_blocked (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        if not db_user.is_active:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
            if event.message:
                await event.message.reply("‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
            elif event.callback_query:
                await event.callback_query.answer("‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω.", show_alert=True)
            return None

        if db_user.is_bot_blocked:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
            if event.message:
                await event.message.reply("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            elif event.callback_query:
                await event.callback_query.answer("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.", show_alert=True)
            return None 
            
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–µ–ª. –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.")
        data['sdb_user'] = db_user
        # --- –ü–ï–†–ï–î–ê–ï–ú –§–õ–ê–ì –û –°–û–ó–î–ê–ù–ò–ò –í –•–≠–ù–î–õ–ï–† /start ---
        if is_start_command: # –¢–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start –ø–µ—Ä–µ–¥–∞–µ–º —ç—Ç–æ—Ç —Ñ–ª–∞–≥
            data['user_was_just_created'] = user_was_created_in_this_middleware_call
            logger.debug(f"[{MODULE_NAME_FOR_LOG}] –î–ª—è /start –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ user_was_just_created = {user_was_created_in_this_middleware_call}")

        return await handler(event, data)


======================================================================

------------------------------ FILE: Systems/core/module_loader/migrations.py ------------------------------
# core/module_loader/migrations.py
"""
–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î –¥–ª—è –º–æ–¥—É–ª–µ–π
"""

import importlib
from pathlib import Path
from typing import List, Optional, Dict
from loguru import logger

from sqlalchemy.ext.asyncio import AsyncSession
from alembic import config as alembic_config
from alembic.script import ScriptDirectory
from alembic.runtime.migration import MigrationContext

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.module_loader import ModuleInfo


class ModuleMigrationManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –º–æ–¥—É–ª–µ–π
    """
    
    def __init__(self, services_provider: 'BotServicesProvider'):
        self.services = services_provider
        self._logger = logger.bind(service="ModuleMigrationManager")
        self._migration_paths: Dict[str, Path] = {}
    
    def register_module_migrations(self, module_name: str, migrations_path: Path):
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º –º–æ–¥—É–ª—è"""
        if migrations_path.exists() and migrations_path.is_dir():
            self._migration_paths[module_name] = migrations_path
            self._logger.info(f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥—É–ª—è {module_name}: {migrations_path}")
        else:
            self._logger.warning(f"–ü—É—Ç—å –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {migrations_path}")
    
    async def run_module_migrations(
        self,
        module_name: str,
        target_revision: str = "head"
    ) -> bool:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥—É–ª—è
        
        Args:
            module_name: –ò–º—è –º–æ–¥—É–ª—è
            target_revision: –¶–µ–ª–µ–≤–∞—è —Ä–µ–≤–∏–∑–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "head")
        
        Returns:
            True –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
        """
        if module_name not in self._migration_paths:
            self._logger.warning(f"–ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥—É–ª—è {module_name} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
            return False
        
        migrations_path = self._migration_paths[module_name]
        
        try:
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Alembic –¥–ª—è –º–æ–¥—É–ª—è
            module_alembic_cfg = alembic_config.Config()
            module_alembic_cfg.set_main_option("script_location", str(migrations_path))
            
            # –ü–æ–ª—É—á–∞–µ–º URL –ë–î –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤
            db_url = self.services.db.get_database_url()
            module_alembic_cfg.set_main_option("sqlalchemy.url", db_url)
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            from alembic import command
            command.upgrade(module_alembic_cfg, target_revision)
            
            self._logger.success(f"–ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è {module_name} –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–æ —Ä–µ–≤–∏–∑–∏–∏ {target_revision}")
            return True
        
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –º–æ–¥—É–ª—è {module_name}: {e}", exc_info=True)
            return False
    
    async def get_module_migration_status(self, module_name: str) -> Dict:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –º–æ–¥—É–ª—è
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
        """
        if module_name not in self._migration_paths:
            return {
                "registered": False,
                "current_revision": None,
                "head_revision": None
            }
        
        try:
            migrations_path = self._migration_paths[module_name]
            script = ScriptDirectory.from_config(
                alembic_config.Config().set_main_option("script_location", str(migrations_path))
            )
            
            head_revision = script.get_current_head()
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é –∏–∑ –ë–î
            async with self.services.db.get_session() as session:
                context = MigrationContext.configure(await session.connection())
                current_revision = context.get_current_revision()
            
            return {
                "registered": True,
                "current_revision": current_revision,
                "head_revision": head_revision,
                "is_up_to_date": current_revision == head_revision
            }
        
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π –º–æ–¥—É–ª—è {module_name}: {e}")
            return {
                "registered": True,
                "error": str(e)
            }
    
    async def run_all_module_migrations(self) -> Dict[str, bool]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å {module_name: success}
        """
        results = {}
        for module_name in self._migration_paths.keys():
            results[module_name] = await self.run_module_migrations(module_name)
        return results




======================================================================

------------------------------ FILE: Systems/core/errors/handler.py ------------------------------
# core/errors/handler.py
"""
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
"""

import traceback
from typing import Optional, Dict, Any
from loguru import logger

from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, Update, Message, CallbackQuery, ErrorEvent
from aiogram.exceptions import TelegramAPIError, TelegramRetryAfter, TelegramBadRequest

from .exceptions import (
    SDBException, DatabaseError, ModuleError, PermissionError,
    ValidationError, RateLimitError, ConfigurationError,
    ExternalAPIError, CacheError, SecurityError
)


class ErrorHandlerMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    """
    
    def __init__(self):
        super().__init__()
        self._logger = logger.bind(service="ErrorHandlerMiddleware")
    
    async def __call__(
        self,
        handler,
        event: Update,
        data: Dict
    ):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""
        try:
            return await handler(event, data)
        except RateLimitError as e:
            return await self._handle_rate_limit_error(e, event)
        except PermissionError as e:
            return await self._handle_permission_error(e, event)
        except ValidationError as e:
            return await self._handle_validation_error(e, event)
        except DatabaseError as e:
            return await self._handle_database_error(e, event)
        except ModuleError as e:
            return await self._handle_module_error(e, event)
        except TelegramRetryAfter as e:
            return await self._handle_telegram_retry_after(e, event)
        except TelegramAPIError as e:
            return await self._handle_telegram_api_error(e, event)
        except SDBException as e:
            return await self._handle_sdb_exception(e, event)
        except Exception as e:
            return await self._handle_unexpected_error(e, event)
    
    async def _handle_rate_limit_error(self, error: RateLimitError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ rate limit"""
        self._logger.warning(f"Rate limit error: {error.message}")
        message = f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {error.retry_after} —Å–µ–∫—É–Ω–¥."
        return await self._send_error_message(event, message)
    
    async def _handle_permission_error(self, error: PermissionError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"""
        self._logger.warning(f"Permission error: {error.message} (permission: {error.permission})")
        message = f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.\n{error.message}"
        return await self._send_error_message(event, message, show_alert=True)
    
    async def _handle_validation_error(self, error: ValidationError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        self._logger.warning(f"Validation error: {error.message} (field: {error.field})")
        message = f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {error.message}"
        return await self._send_error_message(event, message)
    
    async def _handle_database_error(self, error: DatabaseError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ë–î"""
        self._logger.error(f"Database error: {error.message}", exc_info=True)
        message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        return await self._send_error_message(event, message)
    
    async def _handle_module_error(self, error: ModuleError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –º–æ–¥—É–ª—è"""
        self._logger.error(f"Module error in {error.module_name}: {error.message}", exc_info=True)
        message = f"‚ùå –û—à–∏–±–∫–∞ –º–æ–¥—É–ª—è {error.module_name}: {error.message}"
        return await self._send_error_message(event, message)
    
    async def _handle_telegram_retry_after(self, error: TelegramRetryAfter, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram RetryAfter"""
        self._logger.warning(f"Telegram RetryAfter: {error.retry_after} seconds")
        # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        return None
    
    async def _handle_telegram_api_error(self, error: TelegramAPIError, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ Telegram API"""
        self._logger.error(f"Telegram API error: {error.message}", exc_info=True)
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
        if isinstance(error, TelegramBadRequest):
            if "message is too long" in str(error).lower():
                message = "‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ."
            elif "can't parse" in str(error).lower():
                message = "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è."
            else:
                message = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è."
        else:
            message = "‚ùå –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Telegram API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        
        return await self._send_error_message(event, message)
    
    async def _handle_sdb_exception(self, error: SDBException, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è SDB"""
        self._logger.error(f"SDB Exception [{error.error_code}]: {error.message}", exc_info=True)
        message = f"‚ùå –û—à–∏–±–∫–∞: {error.message}"
        return await self._send_error_message(event, message)
    
    async def _handle_unexpected_error(self, error: Exception, event: Update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
        error_traceback = traceback.format_exc()
        self._logger.critical(
            f"Unexpected error: {type(error).__name__}: {error}",
            exc_info=True
        )
        
        # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω."
        return await self._send_error_message(event, message)
    
    async def _send_error_message(
        self, 
        event: Update, 
        message: str, 
        show_alert: bool = False
    ) -> Optional[Any]:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        try:
            if event.message:
                await event.message.answer(message)
            elif event.callback_query:
                await event.callback_query.answer(message, show_alert=show_alert)
        except Exception as e:
            self._logger.error(f"Failed to send error message: {e}")
        return None


async def handle_error(event: ErrorEvent, exception: Exception):
    """
    –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è aiogram
    """
    logger.error(
        f"Unhandled error in aiogram: {type(exception).__name__}: {exception}",
        exc_info=exception
    )




======================================================================

------------------------------ FILE: Systems/core/errors/__init__.py ------------------------------
# core/errors/__init__.py
"""
–ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
"""

from .exceptions import (
    SDBException,
    DatabaseError,
    ModuleError,
    PermissionError,
    ValidationError,
    RateLimitError,
    ConfigurationError,
    ExternalAPIError,
    CacheError,
    SecurityError
)

from .handler import ErrorHandlerMiddleware, handle_error

__all__ = [
    "SDBException",
    "DatabaseError",
    "ModuleError",
    "PermissionError",
    "ValidationError",
    "RateLimitError",
    "ConfigurationError",
    "ExternalAPIError",
    "CacheError",
    "SecurityError",
    "ErrorHandlerMiddleware",
    "handle_error"
]




======================================================================

------------------------------ FILE: Systems/core/errors/exceptions.py ------------------------------
# core/errors/exceptions.py
"""
–ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è SwiftDevBot
"""


class SDBException(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ SwiftDevBot"""
    def __init__(self, message: str, error_code: str = "UNKNOWN_ERROR", details: dict = None):
        self.message = message
        self.error_code = error_code
        self.details = details or {}
        super().__init__(self.message)


class DatabaseError(SDBException):
    """–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    def __init__(self, message: str, details: dict = None):
        super().__init__(message, "DATABASE_ERROR", details)


class ModuleError(SDBException):
    """–û—à–∏–±–∫–∞ –º–æ–¥—É–ª—è"""
    def __init__(self, message: str, module_name: str = None, details: dict = None):
        super().__init__(message, "MODULE_ERROR", details)
        self.module_name = module_name


class PermissionError(SDBException):
    """–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"""
    def __init__(self, message: str, permission: str = None, details: dict = None):
        super().__init__(message, "PERMISSION_ERROR", details)
        self.permission = permission


class ValidationError(SDBException):
    """–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    def __init__(self, message: str, field: str = None, details: dict = None):
        super().__init__(message, "VALIDATION_ERROR", details)
        self.field = field


class RateLimitError(SDBException):
    """–û—à–∏–±–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è rate limit"""
    def __init__(self, message: str, retry_after: int = 0, details: dict = None):
        super().__init__(message, "RATE_LIMIT_ERROR", details)
        self.retry_after = retry_after


class ConfigurationError(SDBException):
    """–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    def __init__(self, message: str, config_key: str = None, details: dict = None):
        super().__init__(message, "CONFIGURATION_ERROR", details)
        self.config_key = config_key


class ExternalAPIError(SDBException):
    """–û—à–∏–±–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ API"""
    def __init__(self, message: str, api_name: str = None, status_code: int = None, details: dict = None):
        super().__init__(message, "EXTERNAL_API_ERROR", details)
        self.api_name = api_name
        self.status_code = status_code


class CacheError(SDBException):
    """–û—à–∏–±–∫–∞ –∫—ç—à–∞"""
    def __init__(self, message: str, details: dict = None):
        super().__init__(message, "CACHE_ERROR", details)


class SecurityError(SDBException):
    """–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    def __init__(self, message: str, threat_type: str = None, details: dict = None):
        super().__init__(message, "SECURITY_ERROR", details)
        self.threat_type = threat_type




======================================================================

------------------------------ FILE: Systems/core/monitoring/metrics.py ------------------------------
# core/monitoring/metrics.py
"""
Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
"""

import time
from typing import Dict, Optional, Any
from collections import defaultdict
from datetime import datetime
from loguru import logger

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider


class MetricsCollector:
    """
    –°–±–æ—Ä—â–∏–∫ –º–µ—Ç—Ä–∏–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Prometheus
    """
    
    def __init__(self):
        self._logger = logger.bind(service="MetricsCollector")
        
        # –°—á–µ—Ç—á–∏–∫–∏
        self._counters: Dict[str, int] = defaultdict(int)
        
        # –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        self._histograms: Dict[str, list] = defaultdict(list)
        
        # Gauge –º–µ—Ç—Ä–∏–∫–∏ (—Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        self._gauges: Dict[str, float] = defaultdict(float)
        
        # –ú–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        self._last_update: Dict[str, datetime] = {}
    
    def increment_counter(self, name: str, labels: Optional[Dict[str, str]] = None, value: int = 1):
        """–£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫"""
        key = self._format_key(name, labels)
        self._counters[key] += value
        self._last_update[key] = datetime.now()
    
    def record_histogram(self, name: str, value: float, labels: Optional[Dict[str, str]] = None):
        """–ó–∞–ø–∏—Å–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É"""
        key = self._format_key(name, labels)
        self._histograms[key].append(value)
        # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –∑–Ω–∞—á–µ–Ω–∏–π
        if len(self._histograms[key]) > 1000:
            self._histograms[key] = self._histograms[key][-1000:]
        self._last_update[key] = datetime.now()
    
    def set_gauge(self, name: str, value: float, labels: Optional[Dict[str, str]] = None):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ gauge"""
        key = self._format_key(name, labels)
        self._gauges[key] = value
        self._last_update[key] = datetime.now()
    
    def _format_key(self, name: str, labels: Optional[Dict[str, str]]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–ª—é—á –º–µ—Ç—Ä–∏–∫–∏ —Å –ª–µ–π–±–ª–∞–º–∏"""
        if not labels:
            return name
        label_str = ",".join(f"{k}={v}" for k, v in sorted(labels.items()))
        return f"{name}{{{label_str}}}"
    
    def get_prometheus_format(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus
        """
        lines = []
        
        # Counters
        for key, value in self._counters.items():
            lines.append(f"# TYPE {key.split('{')[0]} counter")
            lines.append(f"{key} {value}")
        
        # Gauges
        for key, value in self._gauges.items():
            lines.append(f"# TYPE {key.split('{')[0]} gauge")
            lines.append(f"{key} {value}")
        
        # Histograms (–∫–∞–∫ summary)
        for key, values in self._histograms.items():
            if values:
                lines.append(f"# TYPE {key.split('{')[0]} summary")
                lines.append(f"{key}_count {len(values)}")
                lines.append(f"{key}_sum {sum(values)}")
                lines.append(f"{key}_avg {sum(values) / len(values)}")
                if values:
                    sorted_values = sorted(values)
                    lines.append(f"{key}_min {sorted_values[0]}")
                    lines.append(f"{key}_max {sorted_values[-1]}")
        
        return "\n".join(lines) + "\n"
    
    def get_metrics_dict(self) -> Dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è"""
        return {
            "counters": dict(self._counters),
            "gauges": dict(self._gauges),
            "histograms": {
                k: {
                    "count": len(v),
                    "sum": sum(v),
                    "avg": sum(v) / len(v) if v else 0,
                    "min": min(v) if v else 0,
                    "max": max(v) if v else 0
                }
                for k, v in self._histograms.items()
            }
        }


class MetricsMiddleware:
    """
    Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
    """
    
    def __init__(self, metrics_collector: MetricsCollector):
        self.metrics = metrics_collector
        self._logger = logger.bind(service="MetricsMiddleware")
    
    async def __call__(self, handler, event, data: Dict):
        """–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è"""
        start_time = time.time()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
        event_type = "unknown"
        if hasattr(event, 'message') and event.message:
            event_type = "message"
        elif hasattr(event, 'callback_query') and event.callback_query:
            event_type = "callback"
        elif hasattr(event, 'inline_query') and event.inline_query:
            event_type = "inline_query"
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π
        self.metrics.increment_counter(
            "sdb_events_total",
            labels={"type": event_type}
        )
        
        try:
            result = await handler(event, data)
            
            # –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            self.metrics.increment_counter(
                "sdb_events_success_total",
                labels={"type": event_type}
            )
            
            return result
        
        except Exception as e:
            # –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            self.metrics.increment_counter(
                "sdb_events_error_total",
                labels={"type": event_type, "error": type(e).__name__}
            )
            raise
        
        finally:
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            duration = time.time() - start_time
            self.metrics.record_histogram(
                "sdb_event_duration_seconds",
                duration,
                labels={"type": event_type}
            )


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–±–æ—Ä—â–∏–∫–∞ –º–µ—Ç—Ä–∏–∫
_global_metrics_collector: Optional[MetricsCollector] = None


def get_metrics_collector() -> MetricsCollector:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–±–æ—Ä—â–∏–∫–∞ –º–µ—Ç—Ä–∏–∫"""
    global _global_metrics_collector
    if _global_metrics_collector is None:
        _global_metrics_collector = MetricsCollector()
    return _global_metrics_collector




======================================================================

------------------------------ FILE: Systems/core/monitoring/health.py ------------------------------
# core/monitoring/health.py
"""
Health check endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
"""

import asyncio
from typing import Dict, Optional, List
from datetime import datetime
from loguru import logger

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from Systems.core.services_provider import BotServicesProvider


class HealthStatus:
    """–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞"""
    
    def __init__(self, name: str, status: str, message: str = "", details: Dict = None):
        self.name = name
        self.status = status  # "healthy", "degraded", "unhealthy"
        self.message = message
        self.details = details or {}
        self.timestamp = datetime.now()
    
    def to_dict(self) -> Dict:
        return {
            "name": self.name,
            "status": self.status,
            "message": self.message,
            "details": self.details,
            "timestamp": self.timestamp.isoformat()
        }


class HealthChecker:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    """
    
    def __init__(self, services_provider: Optional['BotServicesProvider'] = None):
        self.services = services_provider
        self._logger = logger.bind(service="HealthChecker")
    
    async def check_database(self) -> HealthStatus:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            if not self.services or not hasattr(self.services, 'db'):
                return HealthStatus(
                    "database",
                    "unhealthy",
                    "DBManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                )
            
            start_time = datetime.now()
            async with self.services.db.get_session() as session:
                # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                from sqlalchemy import text
                result = await session.execute(text("SELECT 1"))
                result.scalar()
            
            duration = (datetime.now() - start_time).total_seconds()
            
            if duration > 1.0:
                return HealthStatus(
                    "database",
                    "degraded",
                    f"–ú–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ë–î: {duration:.2f}s",
                    {"response_time": duration}
                )
            
            return HealthStatus(
                "database",
                "healthy",
                "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞",
                {"response_time": duration}
            )
        
        except Exception as e:
            self._logger.error(f"Database health check failed: {e}")
            return HealthStatus(
                "database",
                "unhealthy",
                f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {str(e)}"
            )
    
    async def check_cache(self) -> HealthStatus:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫—ç—à–∞"""
        try:
            if not self.services or not hasattr(self.services, 'cache'):
                return HealthStatus(
                    "cache",
                    "unhealthy",
                    "CacheManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                )
            
            if not self.services.cache.is_available():
                return HealthStatus(
                    "cache",
                    "unhealthy",
                    "–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                )
            
            # –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏/—á—Ç–µ–Ω–∏—è
            test_key = "__health_check__"
            test_value = "test"
            
            start_time = datetime.now()
            await self.services.cache.set(test_key, test_value, ttl=10)
            cached_value = await self.services.cache.get(test_key)
            await self.services.cache.delete(test_key)
            duration = (datetime.now() - start_time).total_seconds()
            
            if cached_value != test_value:
                return HealthStatus(
                    "cache",
                    "degraded",
                    "–ö—ç—à –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
                )
            
            return HealthStatus(
                "cache",
                "healthy",
                "–ö—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ",
                {"response_time": duration}
            )
        
        except Exception as e:
            self._logger.error(f"Cache health check failed: {e}")
            return HealthStatus(
                "cache",
                "unhealthy",
                f"–û—à–∏–±–∫–∞ –∫—ç—à–∞: {str(e)}"
            )
    
    async def check_telegram_api(self) -> HealthStatus:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram API"""
        try:
            if not self.services or not hasattr(self.services, 'bot'):
                return HealthStatus(
                    "telegram_api",
                    "unhealthy",
                    "Bot –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                )
            
            start_time = datetime.now()
            bot_info = await self.services.bot.get_me()
            duration = (datetime.now() - start_time).total_seconds()
            
            return HealthStatus(
                "telegram_api",
                "healthy",
                f"Telegram API –¥–æ—Å—Ç—É–ø–µ–Ω (@{bot_info.username})",
                {
                    "bot_id": bot_info.id,
                    "bot_username": bot_info.username,
                    "response_time": duration
                }
            )
        
        except Exception as e:
            self._logger.error(f"Telegram API health check failed: {e}")
            return HealthStatus(
                "telegram_api",
                "unhealthy",
                f"–û—à–∏–±–∫–∞ Telegram API: {str(e)}"
            )
    
    async def check_modules(self) -> HealthStatus:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥—É–ª–µ–π"""
        try:
            if not self.services or not hasattr(self.services, 'modules'):
                return HealthStatus(
                    "modules",
                    "unhealthy",
                    "ModuleLoader –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                )
            
            module_loader = self.services.modules
            all_modules = module_loader.get_all_modules_info()
            loaded_modules = [
                m for m in all_modules 
                if m.is_enabled and m.is_loaded_successfully
            ]
            failed_modules = [
                m for m in all_modules 
                if m.is_enabled and not m.is_loaded_successfully and m.error
            ]
            
            total = len(all_modules)
            loaded = len(loaded_modules)
            failed = len(failed_modules)
            
            if failed > 0:
                status = "degraded" if loaded > 0 else "unhealthy"
                message = f"{failed} –º–æ–¥—É–ª–µ–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            else:
                status = "healthy"
                message = f"–í—Å–µ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ({loaded}/{total})"
            
            return HealthStatus(
                "modules",
                status,
                message,
                {
                    "total": total,
                    "loaded": loaded,
                    "failed": failed,
                    "failed_modules": [m.name for m in failed_modules]
                }
            )
        
        except Exception as e:
            self._logger.error(f"Modules health check failed: {e}")
            return HealthStatus(
                "modules",
                "unhealthy",
                f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥—É–ª–µ–π: {str(e)}"
            )
    
    async def check_all(self) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        """
        checks = await asyncio.gather(
            self.check_database(),
            self.check_cache(),
            self.check_telegram_api(),
            self.check_modules(),
            return_exceptions=True
        )
        
        results = {}
        overall_status = "healthy"
        
        for check in checks:
            if isinstance(check, Exception):
                self._logger.error(f"Health check exception: {check}")
                continue
            
            if isinstance(check, HealthStatus):
                results[check.name] = check.to_dict()
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
                if check.status == "unhealthy":
                    overall_status = "unhealthy"
                elif check.status == "degraded" and overall_status == "healthy":
                    overall_status = "degraded"
        
        return {
            "status": overall_status,
            "timestamp": datetime.now().isoformat(),
            "checks": results
        }
    
    async def get_health_summary(self) -> Dict:
        """–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –æ –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã"""
        health_data = await self.check_all()
        
        return {
            "status": health_data["status"],
            "timestamp": health_data["timestamp"],
            "checks_count": len(health_data["checks"]),
            "healthy_count": sum(
                1 for c in health_data["checks"].values() 
                if c["status"] == "healthy"
            ),
            "degraded_count": sum(
                1 for c in health_data["checks"].values() 
                if c["status"] == "degraded"
            ),
            "unhealthy_count": sum(
                1 for c in health_data["checks"].values() 
                if c["status"] == "unhealthy"
            )
        }




======================================================================

------------------------------ FILE: Systems/core/monitoring/__init__.py ------------------------------
# core/monitoring/__init__.py
"""
–ú–æ–¥—É–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –º–µ—Ç—Ä–∏–∫
"""

from .metrics import MetricsCollector, MetricsMiddleware, get_metrics_collector
from .health import HealthChecker, HealthStatus

__all__ = [
    "MetricsCollector",
    "MetricsMiddleware",
    "get_metrics_collector",
    "HealthChecker",
    "HealthStatus"
]




======================================================================

------------------------------ FILE: Systems/core/events/dispatcher.py ------------------------------
# core/events/dispatcher.py

import asyncio
from collections import defaultdict
from typing import Callable, Any, Coroutine, List, Dict, Optional, Union, TYPE_CHECKING # –î–æ–±–∞–≤–∏–ª Optional, Union
from loguru import logger

if TYPE_CHECKING:
    # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π —Ç–∏–ø –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
    # EventHandler = Callable[..., Coroutine[Any, Any, None]]
    pass


class EventDispatcher:
    """
    –ü—Ä–æ—Å—Ç–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è SwiftDevBot.
    –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º —Å–∏—Å—Ç–µ–º—ã (—è–¥—Ä—É, –º–æ–¥—É–ª—è–º) –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
    –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–∏—Ö, –Ω–µ –∏–º–µ—è –ø—Ä—è–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞.
    """

    def __init__(self):
        # –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∏–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è,
        # –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–∫–æ—Ä—É—Ç–∏–Ω).
        self._listeners: Dict[str, List[Callable[..., Coroutine[Any, Any, None]]]] = defaultdict(list)
        self._logger = logger.bind(service="EventDispatcher")
        self._logger.info("EventDispatcher –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def subscribe(self, event_type: str, handler: Callable[..., Coroutine[Any, Any, None]]) -> None:
        """
        –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞.
                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sdb:core:startup", "module_name:user_registered").
            handler: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∫–æ—Ä—É—Ç–∏–Ω–∞), –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è.
                     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ –∂–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ (*args) –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ (**kwargs) –∞—Ä–≥—É–º–µ–Ω—Ç—ã,
                     —á—Ç–æ –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –º–µ—Ç–æ–¥ publish().

        Raises:
            TypeError: –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–∫–æ—Ä—É—Ç–∏–Ω–æ–π).
        """
        if not asyncio.iscoroutinefunction(handler):
            err_msg = (f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' –¥–ª—è —Å–æ–±—ã—Ç–∏—è '{event_type}' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "
                       f"–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å 'async def').")
            self._logger.error(err_msg)
            raise TypeError(err_msg) # –î–µ–ª–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç—Ä–æ–∂–µ

        self._listeners[event_type].append(handler)
        self._logger.debug(f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–æ–±—ã—Ç–∏–µ '{event_type}'.")

    def unsubscribe(self, event_type: str, handler: Callable[..., Coroutine[Any, Any, None]]) -> None:
        """
        –û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è.
            handler: –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø–∏—Å–∞—Ç—å.
        """
        try:
            self._listeners[event_type].remove(handler)
            self._logger.debug(f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø–∏—Å–∞–Ω –æ—Ç —Å–æ–±—ã—Ç–∏—è '{event_type}'.")
        except ValueError: # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø–∏—Å–∞—Ç—å –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' "
                                 f"–æ—Ç —Å–æ–±—ã—Ç–∏—è '{event_type}'. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        except KeyError: # –¢–∞–∫–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è –≤–æ–æ–±—â–µ –Ω–µ—Ç –≤ _listeners
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è '{event_type}'.")

    async def publish(self, event_type: str, *args: Any, **kwargs: Any) -> List[Union[Any, Exception]]:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ, –≤—ã–∑—ã–≤–∞—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

        –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `asyncio.gather()`.
        –ï—Å–ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —ç—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–π–º–∞–Ω–æ,
        –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ, –∏ –≤–º–µ—Å—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —ç—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–º —Å–ø–∏—Å–∫–µ –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
        –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) –ø—É–±–ª–∏–∫—É–µ–º–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
            *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –∫–∞–∂–¥–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.
            **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –∫–∞–∂–¥–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.

        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.
            –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ—Ä–Ω—É–ª –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–Ω–æ –±—É–¥–µ—Ç –≤ —Å–ø–∏—Å–∫–µ.
            –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –≤ —Å–ø–∏—Å–∫–µ –Ω–∞ –µ–≥–æ –º–µ—Å—Ç–µ –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç —ç—Ç–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
            –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
        """
        if event_type not in self._listeners or not self._listeners[event_type]:
            self._logger.trace(f"–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏—è '{event_type}'. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞.")
            return []

        handlers_to_call = self._listeners[event_type]
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ª–æ–≥–∞, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö
        args_repr = f"{len(args)} positional"
        kwargs_repr = f"{len(kwargs)} keyword"
        
        self._logger.info(f"–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è '{event_type}' –¥–ª—è {len(handlers_to_call)} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. "
                          f"–ê—Ä–≥—É–º–µ–Ω—Ç—ã: ({args_repr}), ({kwargs_repr}).")

        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—É—Ç–∏–Ω –¥–ª—è –≤—ã–∑–æ–≤–∞
        tasks = [handler(*args, **kwargs) for handler in handlers_to_call]
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –∏ —Å–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        results: List[Union[Any, Exception]] = await asyncio.gather(*tasks, return_exceptions=True)

        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
        for i, result_or_exc in enumerate(results):
            if isinstance(result_or_exc, Exception):
                failed_handler_name = handlers_to_call[i].__qualname__
                self._logger.error(
                    f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏—è '{failed_handler_name}' –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è '{event_type}': "
                    f"{type(result_or_exc).__name__}('{result_or_exc}')",
                    exc_info=result_or_exc # –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–±–µ–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
                )
        
        return results

    def get_listeners_count(self, event_type: Optional[str] = None) -> Union[int, Dict[str, int]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
        –ï—Å–ª–∏ `event_type` —É–∫–∞–∑–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
        –ï—Å–ª–∏ `event_type` –Ω–µ —É–∫–∞–∑–∞–Ω (None), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å {event_type: count} –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.
        """
        if event_type:
            return len(self._listeners.get(event_type, []))
        else:
            return {etype: len(handler_list) for etype, handler_list in self._listeners.items() if handler_list}

    async def dispose(self) -> None: # –°–¥–µ–ª–∞–µ–º async, –µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        """–û—á–∏—â–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã."""
        self._listeners.clear()
        self._logger.info("EventDispatcher –æ—á–∏—â–µ–Ω (–≤—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏ —Å–ø–∏—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π —É–¥–∞–ª–µ–Ω—ã).")


======================================================================

------------------------------ FILE: Systems/core/events/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/i18n/__init__.py ------------------------------



======================================================================

------------------------------ FILE: Systems/core/i18n/translator.py ------------------------------
# core/i18n/translator.py

import yaml
from pathlib import Path
from typing import Dict, List, Optional, Any
from loguru import logger

class Translator:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π) —Å—Ç—Ä–æ–∫.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç YAML —Ñ–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    –§–æ—Ä–º–∞—Ç: key = value –≤ YAML —Ñ–∞–π–ª–∞—Ö.
    """
    def __init__(
        self, 
        locales_dir: Path, 
        domain: str = "bot", # –ò–º—è –¥–æ–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è YAML, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        default_locale: str = "ru", 
        available_locales: Optional[List[str]] = None
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä.

        Args:
            locales_dir: –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'locales' (–≥–¥–µ –ª–µ–∂–∞—Ç —Ñ–∞–π–ª—ã en.yaml, ua.yaml, ru.yaml).
            domain: –ò–º—è –¥–æ–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è YAML, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏).
            default_locale: –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω.
            available_locales: –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ['en', 'ua', 'ru']).
                               –ï—Å–ª–∏ None, –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ YAML —Ñ–∞–π–ª–æ–≤ –≤ locales_dir.
        """
        self.locales_dir = locales_dir
        self.domain = domain
        self.default_locale = default_locale
        self._translations: Dict[str, Dict[str, str]] = {} # –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤: {locale: {key: value}}

        if available_locales:
            self.available_locales = available_locales
        else:
            # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–∏ –ø–æ YAML —Ñ–∞–π–ª–∞–º –≤ locales_dir
            self.available_locales = []
            if self.locales_dir.is_dir():
                for item in self.locales_dir.iterdir():
                    if item.is_file() and item.suffix == ".yaml":
                        locale_name = item.stem  # –ò–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (en, ua, ru)
                        self.available_locales.append(locale_name)
            if not self.available_locales:
                 logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã YAML —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ {self.locales_dir}. "
                                f"–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.")
            elif default_locale not in self.available_locales and self.available_locales:
                logger.warning(f"–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '{default_locale}' –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö: {self.available_locales}. "
                               f"–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —è–∑—ã–∫.")
        
        logger.info(f"Translator –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. Locales dir: '{self.locales_dir}', Domain: '{self.domain}', "
                    f"Default: '{self.default_locale}', Available: {self.available_locales}")
        
        # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        self.load_all_translations()


    def load_translation(self, locale: str) -> Optional[Dict[str, str]]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫—ç—à–∞ —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞."""
        if locale in self._translations:
            return self._translations[locale]
        
        if locale not in self.available_locales:
            logger.trace(f"–Ø–∑—ã–∫ '{locale}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –¥–ª—è –Ω–µ–≥–æ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞.")
            return None

        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º YAML —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
            yaml_file = self.locales_dir / f"{locale}.yaml"
            if not yaml_file.exists():
                logger.warning(f"–§–∞–π–ª –ø–µ—Ä–µ–≤–æ–¥–∞ '{yaml_file}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —è–∑—ã–∫
                if locale != self.default_locale:
                    return self.load_translation(self.default_locale)
                return None
            
            with open(yaml_file, 'r', encoding='utf-8') as f:
                translations = yaml.safe_load(f) or {}
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç "key = value" –≤ —Å–ª–æ–≤–∞—Ä—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            # –ï—Å–ª–∏ YAML —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–ª–æ–≤–∞—Ä—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
            if isinstance(translations, dict):
                self._translations[locale] = translations
                logger.debug(f"–ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —è–∑—ã–∫–∞ '{locale}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ({len(translations)} –∫–ª—é—á–µ–π).")
                return translations
            else:
                logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ '{yaml_file}'. –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å.")
                return None
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —è–∑—ã–∫–∞ '{locale}': {e}", exc_info=True)
            # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —è–∑—ã–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            if locale != self.default_locale:
                return self.load_translation(self.default_locale)
            return None

    def load_all_translations(self) -> None:
        """–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã."""
        logger.info(f"–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ({self.available_locales})...")
        for lang in self.available_locales:
            self.load_translation(lang)
        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è {len(self._translations)} —è–∑—ã–∫–æ–≤.")

    def gettext(self, message_key: str, locale: str, **kwargs: Any) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ –∫–ª—é—á—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å kwargs.

        Args:
            message_key: –ö–ª—é—á –ø–µ—Ä–µ–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "main_menu_title")
            locale: –ö–æ–¥ —è–∑—ã–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "en", "ua", "ru")
            **kwargs: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏

        Returns:
            –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —Å–∞–º –∫–ª—é—á, –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
        translations = self._translations.get(locale)
        if not translations:
            translations = self.load_translation(locale)
        
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —è–∑—ã–∫
        if not translations or message_key not in translations:
            if locale != self.default_locale:
                default_translations = self._translations.get(self.default_locale)
                if not default_translations:
                    default_translations = self.load_translation(self.default_locale)
                if default_translations and message_key in default_translations:
                    translations = default_translations
                    logger.trace(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ '{self.default_locale}' –¥–ª—è –∫–ª—é—á–∞ '{message_key}'")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        if translations and message_key in translations:
            translated_text = translations[message_key]
        else:
            # –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª—é—á
            logger.warning(f"–ü–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∫–ª—é—á–∞ '{message_key}' (locale: {locale}). –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª—é—á.")
            translated_text = message_key

        try:
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å kwargs
            return translated_text.format(**kwargs) if kwargs else translated_text
        except (KeyError, IndexError) as e_format:
            logger.warning(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–ª—é—á–∞ '{message_key}' (locale: {locale}): {e_format}. "
                           f"–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: '{translated_text}', kwargs: {kwargs}")
            return translated_text # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

    def ngettext(self, singular_key: str, plural_key: str, count: int, locale: str, **kwargs: Any) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞.
        
        Args:
            singular_key: –ö–ª—é—á –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
            plural_key: –ö–ª—é—á –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
            count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
            locale: –ö–æ–¥ —è–∑—ã–∫–∞
            **kwargs: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            
        Returns:
            –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º —á–∏—Å–ª–∞
        """
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º singular_key –µ—Å–ª–∏ count == 1, –∏–Ω–∞—á–µ plural_key
        # –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∞–≤–∏–ª –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
        key_to_use = singular_key if count == 1 else plural_key
        
        # –î–æ–±–∞–≤–ª—è–µ–º count –≤ kwargs –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        format_kwargs = {**kwargs, 'count': count}
        
        return self.gettext(key_to_use, locale, **format_kwargs)

    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
    # –µ—Å–ª–∏ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–≤–µ—Å—Ç–µ–Ω —Å–µ—Ä–≤–∏—Å—É.
    # async def gettext_for_user(self, user_id: int, message_key: str, **kwargs) -> str:
    #     user_locale = await self._get_user_locale(user_id) # –ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –ë–î –∏–ª–∏ –∫—ç—à—É —Å —è–∑—ã–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    #     return self.gettext(message_key, user_locale, **kwargs)


======================================================================

------------------------------ FILE: Systems/core/i18n/middleware.py ------------------------------
# core/i18n/middleware.py

from typing import Callable, Dict, Any, Awaitable, Optional
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, User as AiogramUser # User –∏–∑ aiogram.types

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à Translator –∏ AppSettings (–¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö)
from .translator import Translator
from Systems.core.app_settings import settings as sdb_settings # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
from Systems.core.database.core_models import User as DBUser # –ù–∞—à–∞ –º–æ–¥–µ–ª—å User –∏–∑ –ë–î
from sqlalchemy.ext.asyncio import AsyncSession # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î

# –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ BotServicesProvider –∏–∑ workflow_data –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å)
# from Systems.core.services_provider import BotServicesProvider


class I18nMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (gettext) –≤ —Ö—ç–Ω–¥–ª–µ—Ä—ã.
    """
    def __init__(self, translator: Translator):
        super().__init__()
        self.translator = translator
        self.default_locale = translator.default_locale
        self.available_locales = translator.available_locales
        # logger –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ data, –µ—Å–ª–∏ BotServicesProvider –µ–≥–æ –ø–µ—Ä–µ–¥–∞–µ—Ç, –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π

    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject, # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å Message, CallbackQuery, etc.
        data: Dict[str, Any]   # –°–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –≤ —Ö—ç–Ω–¥–ª–µ—Ä
    ) -> Any:
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–æ–±—ã—Ç–∏–∏
        aiogram_event_user: Optional[AiogramUser] = data.get("event_from_user")
        
        user_locale: str = self.default_locale # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —è–∑—ã–∫ —Å–∏—Å—Ç–µ–º—ã

        if aiogram_event_user:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∞—à–µ–π –ë–î
            # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ DBManager –∏–ª–∏ —Å–µ—Å—Å–∏–∏
            # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ BotServicesProvider (services) –¥–æ—Å—Ç—É–ø–µ–Ω –≤ data
            services = data.get("services_provider") # –ò–º—è –∫–ª—é—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –µ–≥–æ –ø–æ–ª–æ–∂–∏–ª–∏ –≤ Dispatcher
            
            db_user: Optional[DBUser] = None
            if services and hasattr(services, 'db'):
                try:
                    async with services.db.get_session() as session: # type: AsyncSession
                        # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
                        from sqlalchemy import select # –õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç
                        stmt = select(DBUser).where(DBUser.telegram_id == aiogram_event_user.id)
                        result = await session.execute(stmt)
                        db_user = result.scalars().first()
                        
                        if db_user and db_user.preferred_language_code and db_user.preferred_language_code in self.available_locales:
                            user_locale = db_user.preferred_language_code
                        elif db_user and not db_user.preferred_language_code:
                            # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –Ω–µ—Ç —è–∑—ã–∫–∞, –Ω–æ –µ—Å—Ç—å —è–∑—ã–∫ –≤ Telegram –∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                            if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                                user_locale = aiogram_event_user.language_code
                                # –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫ –≤ –ë–î –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                # db_user.preferred_language_code = user_locale
                                # await session.commit() # –û–°–¢–û–†–û–ñ–ù–û: commit –≤ middleware
                        elif not db_user: # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –ë–î
                            if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                                user_locale = aiogram_event_user.language_code
                except Exception as e:
                    # logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è TG ID {aiogram_event_user.id}: {e}")
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–≥–µ—Ä –∏–∑ data, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
                    data.get("logger", logger).error(f"I18nMiddleware: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —è–∑—ã–∫–∞ –¥–ª—è TG ID {aiogram_event_user.id}: {e}")
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å default_locale –∏–ª–∏ —è–∑—ã–∫–æ–º –∏–∑ Telegram, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–Ω–µ–µ
            else: # –ï—Å–ª–∏ services –∏–ª–∏ services.db –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                 data.get("logger", logger).warning("I18nMiddleware: BotServicesProvider –∏–ª–∏ DBManager –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ data. –Ø–∑—ã–∫ –∏–∑ –ë–î –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω.")
                 # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —è–∑—ã–∫ –∏–∑ Telegram API, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                 if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                     user_locale = aiogram_event_user.language_code
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —è–∑—ã–∫ –≤ data –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö
        data["user_locale"] = user_locale
        
        # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —Ö—ç–Ω–¥–ª–µ—Ä–∞–º —É–¥–æ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        # –û–Ω–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_locale, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤ data
        # –≠—Ç–æ –æ–±–µ—Ä—Ç–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å locale –∫–∞–∂–¥—ã–π —Ä–∞–∑
        data["gettext"] = lambda message_key, **kwargs: self.translator.gettext(message_key, user_locale, **kwargs)
        data["ngettext"] = lambda singular_key, plural_key, count, **kwargs: self.translator.ngettext(singular_key, plural_key, count, user_locale, **kwargs)
        
        # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∞–º –æ–±—ä–µ–∫—Ç translator, –µ—Å–ª–∏ —ç—Ç–æ —É–¥–æ–±–Ω–µ–µ
        data["translator"] = self.translator 
        
        # data.get("logger", logger).debug(f"I18nMiddleware: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —è–∑—ã–∫ '{user_locale}' –¥–ª—è TG ID {aiogram_event_user.id if aiogram_event_user else 'N/A'}.")
        
        return await handler(event, data)


======================================================================

------------------------------ FILE: Systems/core/logging/structured.py ------------------------------
# core/logging/structured.py
"""
–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
"""

import json
import sys
from typing import Any, Dict, Optional
from datetime import datetime
from loguru import logger


class StructuredLogger:
    """
    –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä —Å JSON –≤—ã–≤–æ–¥–æ–º
    """
    
    def __init__(self, json_output: bool = False, indent: Optional[int] = None):
        self.json_output = json_output
        self.indent = indent
        self._setup_logger()
    
    def _setup_logger(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞"""
        if self.json_output:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π handler
            logger.remove()
            
            # –î–æ–±–∞–≤–ª—è–µ–º JSON handler
            logger.add(
                sys.stdout,
                format=self._json_formatter,
                serialize=True,
                level="DEBUG"
            )
    
    def _json_formatter(self, record: Dict[str, Any]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –ª–æ–≥–∞ –≤ JSON"""
        log_data = {
            "timestamp": datetime.fromtimestamp(record["time"].timestamp()).isoformat(),
            "level": record["level"].name,
            "message": record["message"],
            "module": record.get("name", ""),
            "function": record.get("function", ""),
            "line": record.get("line", 0),
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if "extra" in record:
            log_data.update(record["extra"])
        
        # –î–æ–±–∞–≤–ª—è–µ–º exception info –µ—Å–ª–∏ –µ—Å—Ç—å
        if "exception" in record:
            log_data["exception"] = {
                "type": record["exception"].type.__name__ if record["exception"] else None,
                "value": str(record["exception"].value) if record["exception"] else None,
                "traceback": record["exception"].traceback if record["exception"] else None
            }
        
        return json.dumps(log_data, indent=self.indent, ensure_ascii=False)
    
    def bind(self, **kwargs):
        """–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫ –ª–æ–≥–≥–µ—Ä—É"""
        return logger.bind(**kwargs)


def setup_structured_logging(
    json_output: bool = False,
    log_file: Optional[str] = None,
    rotation: str = "10 MB",
    retention: str = "7 days",
    level: str = "INFO"
):
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    
    Args:
        json_output: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSON —Ñ–æ—Ä–º–∞—Ç
        log_file: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        rotation: –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
        retention: –•—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
        level: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    logger.remove()
    
    if json_output:
        # JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        logger.add(
            sys.stdout,
            format=lambda record: json.dumps({
                "timestamp": datetime.fromtimestamp(record["time"].timestamp()).isoformat(),
                "level": record["level"].name,
                "message": record["message"],
                "module": record.get("name", ""),
                "function": record.get("function", ""),
                "line": record.get("line", 0),
                **record.get("extra", {})
            }, ensure_ascii=False),
            serialize=True,
            level=level
        )
    else:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        logger.add(
            sys.stdout,
            format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
            level=level
        )
    
    # –§–∞–π–ª–æ–≤—ã–π –ª–æ–≥ (–≤—Å–µ–≥–¥–∞ JSON –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏)
    if log_file:
        logger.add(
            log_file,
            format=lambda record: json.dumps({
                "timestamp": datetime.fromtimestamp(record["time"].timestamp()).isoformat(),
                "level": record["level"].name,
                "message": record["message"],
                "module": record.get("name", ""),
                "function": record.get("function", ""),
                "line": record.get("line", 0),
                **record.get("extra", {})
            }, ensure_ascii=False),
            serialize=True,
            rotation=rotation,
            retention=retention,
            level="DEBUG"  # –í —Ñ–∞–π–ª –ø–∏—à–µ–º –≤—Å–µ
        )




======================================================================

------------------------------ FILE: Systems/web/tsconfig.node.json ------------------------------
{
    "compilerOptions": {
      "target": "ES2022",
      "lib": ["ES2023"],
      "module": "ESNext",
      "skipLibCheck": true,
  
      /* Bundler mode */
      "moduleResolution": "bundler",
      "allowImportingTsExtensions": true,
      "isolatedModules": true,
      "moduleDetection": "force",
      "noEmit": true,
  
      /* Linting */
      "strict": true,
      "noUnusedLocals": true,
      "noUnusedParameters": true,
      "noFallthroughCasesInSwitch": true
    },
    "include": ["vite.config.ts"]
  }
  


======================================================================

------------------------------ FILE: Systems/web/index.html ------------------------------
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SwiftDevBot Futuristic Glass Dashboard</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>



======================================================================

------------------------------ FILE: Systems/web/tailwind.config.js ------------------------------
/** @type {import('tailwindcss').Config} */
export default {
    content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
    theme: {
      extend: {},
    },
    plugins: [],
  };
  


======================================================================

------------------------------ FILE: Systems/web/tsconfig.app.json ------------------------------
{
    "compilerOptions": {
      "target": "ES2020",
      "useDefineForClassFields": true,
      "lib": ["ES2020", "DOM", "DOM.Iterable"],
      "module": "ESNext",
      "skipLibCheck": true,
  
      /* Bundler mode */
      "moduleResolution": "bundler",
      "allowImportingTsExtensions": true,
      "isolatedModules": true,
      "moduleDetection": "force",
      "noEmit": true,
      "jsx": "react-jsx",
  
      /* Linting */
      "strict": true,
      "noUnusedLocals": true,
      "noUnusedParameters": true,
      "noFallthroughCasesInSwitch": true
    },
    "include": ["src"]
  }
  


======================================================================

------------------------------ FILE: Systems/web/__init__.py ------------------------------
# Systems/web/__init__.py
"""
Web interface for SwiftDevBot dashboard (React + TypeScript + Vite).
"""



======================================================================

------------------------------ FILE: Systems/web/README.md ------------------------------
# SwiftDevBot Web Dashboard

–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –≤–µ–±-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram-–±–æ—Ç–æ–º SwiftDevBot –Ω–∞ React + TypeScript + Vite –≤ —Å—Ç–∏–ª–µ Liquid Glass Interface.

## üé® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **React + TypeScript** - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ —Å —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
- **Vite** - –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- **Liquid Glass Design** - –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ —Ä–∞–∑–º—ã—Ç–∏—è
- **Holographic UI** - –ù–µ–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –∏ —Å–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
- **Tailwind CSS** - –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏
- **–î–≤—É—Ö—Ç–µ–º–∞** - –°–≤–µ—Ç–ª–∞—è –∏ —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **RBAC —Å–∏—Å—Ç–µ–º–∞** - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd Systems/web
npm install
```

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ (Vite)
npm run dev

# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ FastAPI backend
python3 ../../sdb.py web start
```

Frontend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:5173` (Vite dev server)
Backend API –Ω–∞ `http://localhost:8000`

### –°–±–æ—Ä–∫–∞ –¥–ª—è production

```bash
# –°–æ–±—Ä–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
npm run build

# –ó–∞–ø—É—Å—Ç–∏—Ç—å FastAPI (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
python3 ../../sdb.py web start
```

–ü–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ FastAPI –Ω–∞ `http://localhost:8000`

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Systems/web/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/          # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/              # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (GlassCard, GlassButton, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sections/        # –°–µ–∫—Ü–∏–∏ dashboard (Home, Modules, Users, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx       # –®–∞–ø–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.tsx      # –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AnimatedBackground.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contexts/             # React Contexts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx  # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ThemeContext.tsx # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.ts           # FastAPI –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login.tsx        # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Dashboard.tsx    # –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx              # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx             # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ index.css            # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îú‚îÄ‚îÄ app.py                   # FastAPI backend
‚îú‚îÄ‚îÄ vite.config.ts           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vite
‚îú‚îÄ‚îÄ tailwind.config.js       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind
‚îú‚îÄ‚îÄ tsconfig.json            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è TypeScript
‚îî‚îÄ‚îÄ package.json             # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –†–æ–ª–∏

- **User** - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ (–º–æ–¥—É–ª–∏, –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- **Admin** - –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –≤–∫–ª—é—á–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã

### –î–µ–º–æ-—Ä–µ–∂–∏–º

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ª—é–±–∞—è –ø–∞—Ä–∞ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ API.

## üì± –†–∞–∑–¥–µ–ª—ã –ø–∞–Ω–µ–ª–∏

### –î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

1. **Home** - –û–±–∑–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
2. **Modules** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ –±–æ—Ç–∞
3. **Users** - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **Statistics** - –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏
5. **Logs** - –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
6. **Settings** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏
7. **Documentation** - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø–æ–º–æ—â—å

### –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

8. **Core Config** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
9. **Services** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
10. **Monitoring** - –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

## üé® –¶–≤–µ—Ç–æ–≤—ã–µ —Ç–µ–º—ã

### –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
- –ë–µ–ª—ã–π —Ñ–æ–Ω —Å –ª–µ–≥–∫–∏–º —Å–∏–Ω–∏–º —Å–≤–µ—á–µ–Ω–∏–µ–º
- –ú—è–≥–∫–∏–µ —Ç–µ–Ω–∏ –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è
- –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥ —Å—Ç–µ–∫–ª–æ–º

### –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
- –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Ç–µ–º–Ω–æ-—Å–∏–Ω–µ–≥–æ –∫ –ª–∞–∑—É—Ä–Ω–æ–º—É
- –ù–µ–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã (–±–∏—Ä—é–∑–æ–≤—ã–π, –ª–∞–π–º–æ–≤—ã–π, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)
- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–µ—Ç–æ–≤—ã–µ –±–ª–∏–∫–∏

## üîß API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/auth/login` - –í—Ö–æ–¥
- `POST /api/auth/logout` - –í—ã—Ö–æ–¥

### –î–∞–Ω–Ω—ã–µ
- `GET /api/health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `GET /api/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞
- `GET /api/modules` - –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π
- `GET /api/users` - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `GET /api/logs` - –õ–æ–≥–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —É—Ä–æ–≤–Ω—é)

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ `Systems/web/`:

```env
VITE_API_BASE_URL=http://localhost:8000
```

### Vite Proxy

–í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Vite –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ `/api` –Ω–∞ FastAPI backend (`http://localhost:8000`).

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- **Frontend**: React 18, TypeScript, Vite
- **Styling**: Tailwind CSS, Custom CSS (Liquid Glass)
- **Icons**: Lucide React
- **Backend**: FastAPI (Python)
- **–°—Ç–∏–ª–∏**: Liquid Glass, Glassmorphism, Neon Cyberpunk
- **–®—Ä–∏—Ñ—Ç—ã**: System fonts (Inter fallback)
- **–ê–Ω–∏–º–∞—Ü–∏–∏**: CSS Animations, Transitions

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev          # –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server
npm run build        # –°–æ–±—Ä–∞—Ç—å –¥–ª—è production
npm run preview      # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä production build
npm run lint         # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–æ–º
npm run typecheck    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã TypeScript

# Backend
python3 ../../sdb.py web start    # –ó–∞–ø—É—Å—Ç–∏—Ç—å FastAPI —Å–µ—Ä–≤–µ—Ä
```

## üéØ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ sdb_services
- [ ] WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (Chart.js/Recharts)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [React Docs](https://react.dev)
- [TypeScript Docs](https://www.typescriptlang.org)
- [Vite Docs](https://vitejs.dev)
- [Tailwind CSS Docs](https://tailwindcss.com)

---

**SwiftDevBot** ‚Äî —Å–æ–∑–¥–∞–Ω —Å ‚ù§Ô∏è –∫–æ–º–∞–Ω–¥–æ–π SoverX



======================================================================

------------------------------ FILE: Systems/web/.gitignore ------------------------------
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.env



======================================================================

------------------------------ FILE: Systems/web/package-lock.json ------------------------------
{
    "name": "vite-react-typescript-starter",
    "version": "0.0.0",
    "lockfileVersion": 3,
    "requires": true,
    "packages": {
        "": {
            "name": "vite-react-typescript-starter",
            "version": "0.0.0",
            "dependencies": {
                "lucide-react": "^0.344.0",
                "react": "^18.3.1",
                "react-dom": "^18.3.1"
            },
            "devDependencies": {
                "@eslint/js": "^9.9.1",
                "@types/react": "^18.3.5",
                "@types/react-dom": "^18.3.0",
                "@vitejs/plugin-react": "^4.3.1",
                "autoprefixer": "^10.4.18",
                "eslint": "^9.9.1",
                "eslint-plugin-react-hooks": "^5.1.0-rc.0",
                "eslint-plugin-react-refresh": "^0.4.11",
                "globals": "^15.9.0",
                "postcss": "^8.4.35",
                "tailwindcss": "^3.4.1",
                "typescript": "^5.5.3",
                "typescript-eslint": "^8.3.0",
                "vite": "^5.4.2"
            }
        },
        "node_modules/@alloc/quick-lru": {
            "version": "5.2.0",
            "resolved": "https://registry.npmjs.org/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
            "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
            "dev": true,
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/@ampproject/remapping": {
            "version": "2.3.0",
            "resolved": "https://registry.npmjs.org/@ampproject/remapping/-/remapping-2.3.0.tgz",
            "integrity": "sha512-30iZtAPgz+LTIYoeivqYo853f02jBYSd5uGnGpkFV0M3xOt9aN73erkgYAmZU43x4VfqcnLxW9Kpg3R5LC4YYw==",
            "dev": true,
            "dependencies": {
                "@jridgewell/gen-mapping": "^0.3.5",
                "@jridgewell/trace-mapping": "^0.3.24"
            },
            "engines": {
                "node": ">=6.0.0"
            }
        },
        "node_modules/@babel/code-frame": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.25.7.tgz",
            "integrity": "sha512-0xZJFNE5XMpENsgfHYTw8FbX4kv53mFLn2i3XPoq69LyhYSCBJtitaHx9QnsVTrsogI4Z3+HtEfZ2/GFPOtf5g==",
            "dev": true,
            "dependencies": {
                "@babel/highlight": "^7.25.7",
                "picocolors": "^1.0.0"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/compat-data": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.25.7.tgz",
            "integrity": "sha512-9ickoLz+hcXCeh7jrcin+/SLWm+GkxE2kTvoYyp38p4WkdFXfQJxDFGWp/YHjiKLPx06z2A7W8XKuqbReXDzsw==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/core": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.25.7.tgz",
            "integrity": "sha512-yJ474Zv3cwiSOO9nXJuqzvwEeM+chDuQ8GJirw+pZ91sCGCyOZ3dJkVE09fTV0VEVzXyLWhh3G/AolYTPX7Mow==",
            "dev": true,
            "peer": true,
            "dependencies": {
                "@ampproject/remapping": "^2.2.0",
                "@babel/code-frame": "^7.25.7",
                "@babel/generator": "^7.25.7",
                "@babel/helper-compilation-targets": "^7.25.7",
                "@babel/helper-module-transforms": "^7.25.7",
                "@babel/helpers": "^7.25.7",
                "@babel/parser": "^7.25.7",
                "@babel/template": "^7.25.7",
                "@babel/traverse": "^7.25.7",
                "@babel/types": "^7.25.7",
                "convert-source-map": "^2.0.0",
                "debug": "^4.1.0",
                "gensync": "^1.0.0-beta.2",
                "json5": "^2.2.3",
                "semver": "^6.3.1"
            },
            "engines": {
                "node": ">=6.9.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/babel"
            }
        },
        "node_modules/@babel/generator": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.25.7.tgz",
            "integrity": "sha512-5Dqpl5fyV9pIAD62yK9P7fcA768uVPUyrQmqpqstHWgMma4feF1x/oFysBCVZLY5wJ2GkMUCdsNDnGZrPoR6rA==",
            "dev": true,
            "dependencies": {
                "@babel/types": "^7.25.7",
                "@jridgewell/gen-mapping": "^0.3.5",
                "@jridgewell/trace-mapping": "^0.3.25",
                "jsesc": "^3.0.2"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-compilation-targets": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.25.7.tgz",
            "integrity": "sha512-DniTEax0sv6isaw6qSQSfV4gVRNtw2rte8HHM45t9ZR0xILaufBRNkpMifCRiAPyvL4ACD6v0gfCwCmtOQaV4A==",
            "dev": true,
            "dependencies": {
                "@babel/compat-data": "^7.25.7",
                "@babel/helper-validator-option": "^7.25.7",
                "browserslist": "^4.24.0",
                "lru-cache": "^5.1.1",
                "semver": "^6.3.1"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-module-imports": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.25.7.tgz",
            "integrity": "sha512-o0xCgpNmRohmnoWKQ0Ij8IdddjyBFE4T2kagL/x6M3+4zUgc+4qTOUBoNe4XxDskt1HPKO007ZPiMgLDq2s7Kw==",
            "dev": true,
            "dependencies": {
                "@babel/traverse": "^7.25.7",
                "@babel/types": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-module-transforms": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.25.7.tgz",
            "integrity": "sha512-k/6f8dKG3yDz/qCwSM+RKovjMix563SLxQFo0UhRNo239SP6n9u5/eLtKD6EAjwta2JHJ49CsD8pms2HdNiMMQ==",
            "dev": true,
            "dependencies": {
                "@babel/helper-module-imports": "^7.25.7",
                "@babel/helper-simple-access": "^7.25.7",
                "@babel/helper-validator-identifier": "^7.25.7",
                "@babel/traverse": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            },
            "peerDependencies": {
                "@babel/core": "^7.0.0"
            }
        },
        "node_modules/@babel/helper-plugin-utils": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.25.7.tgz",
            "integrity": "sha512-eaPZai0PiqCi09pPs3pAFfl/zYgGaE6IdXtYvmf0qlcDTd3WCtO7JWCcRd64e0EQrcYgiHibEZnOGsSY4QSgaw==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-simple-access": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-simple-access/-/helper-simple-access-7.25.7.tgz",
            "integrity": "sha512-FPGAkJmyoChQeM+ruBGIDyrT2tKfZJO8NcxdC+CWNJi7N8/rZpSxK7yvBJ5O/nF1gfu5KzN7VKG3YVSLFfRSxQ==",
            "dev": true,
            "dependencies": {
                "@babel/traverse": "^7.25.7",
                "@babel/types": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-string-parser": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.25.7.tgz",
            "integrity": "sha512-CbkjYdsJNHFk8uqpEkpCvRs3YRp9tY6FmFY7wLMSYuGYkrdUi7r2lc4/wqsvlHoMznX3WJ9IP8giGPq68T/Y6g==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-validator-identifier": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.25.7.tgz",
            "integrity": "sha512-AM6TzwYqGChO45oiuPqwL2t20/HdMC1rTPAesnBCgPCSF1x3oN9MVUwQV2iyz4xqWrctwK5RNC8LV22kaQCNYg==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helper-validator-option": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.25.7.tgz",
            "integrity": "sha512-ytbPLsm+GjArDYXJ8Ydr1c/KJuutjF2besPNbIZnZ6MKUxi/uTA22t2ymmA4WFjZFpjiAMO0xuuJPqK2nvDVfQ==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/helpers": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.25.7.tgz",
            "integrity": "sha512-Sv6pASx7Esm38KQpF/U/OXLwPPrdGHNKoeblRxgZRLXnAtnkEe4ptJPDtAZM7fBLadbc1Q07kQpSiGQ0Jg6tRA==",
            "dev": true,
            "dependencies": {
                "@babel/template": "^7.25.7",
                "@babel/types": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/highlight": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/highlight/-/highlight-7.25.7.tgz",
            "integrity": "sha512-iYyACpW3iW8Fw+ZybQK+drQre+ns/tKpXbNESfrhNnPLIklLbXr7MYJ6gPEd0iETGLOK+SxMjVvKb/ffmk+FEw==",
            "dev": true,
            "dependencies": {
                "@babel/helper-validator-identifier": "^7.25.7",
                "chalk": "^2.4.2",
                "js-tokens": "^4.0.0",
                "picocolors": "^1.0.0"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/parser": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.25.7.tgz",
            "integrity": "sha512-aZn7ETtQsjjGG5HruveUK06cU3Hljuhd9Iojm4M8WWv3wLE6OkE5PWbDUkItmMgegmccaITudyuW5RPYrYlgWw==",
            "dev": true,
            "dependencies": {
                "@babel/types": "^7.25.7"
            },
            "bin": {
                "parser": "bin/babel-parser.js"
            },
            "engines": {
                "node": ">=6.0.0"
            }
        },
        "node_modules/@babel/plugin-transform-react-jsx-self": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.25.7.tgz",
            "integrity": "sha512-JD9MUnLbPL0WdVK8AWC7F7tTG2OS6u/AKKnsK+NdRhUiVdnzyR1S3kKQCaRLOiaULvUiqK6Z4JQE635VgtCFeg==",
            "dev": true,
            "dependencies": {
                "@babel/helper-plugin-utils": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            },
            "peerDependencies": {
                "@babel/core": "^7.0.0-0"
            }
        },
        "node_modules/@babel/plugin-transform-react-jsx-source": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.25.7.tgz",
            "integrity": "sha512-S/JXG/KrbIY06iyJPKfxr0qRxnhNOdkNXYBl/rmwgDd72cQLH9tEGkDm/yJPGvcSIUoikzfjMios9i+xT/uv9w==",
            "dev": true,
            "dependencies": {
                "@babel/helper-plugin-utils": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            },
            "peerDependencies": {
                "@babel/core": "^7.0.0-0"
            }
        },
        "node_modules/@babel/template": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.25.7.tgz",
            "integrity": "sha512-wRwtAgI3bAS+JGU2upWNL9lSlDcRCqD05BZ1n3X2ONLH1WilFP6O1otQjeMK/1g0pvYcXC7b/qVUB1keofjtZA==",
            "dev": true,
            "dependencies": {
                "@babel/code-frame": "^7.25.7",
                "@babel/parser": "^7.25.7",
                "@babel/types": "^7.25.7"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/traverse": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.25.7.tgz",
            "integrity": "sha512-jatJPT1Zjqvh/1FyJs6qAHL+Dzb7sTb+xr7Q+gM1b+1oBsMsQQ4FkVKb6dFlJvLlVssqkRzV05Jzervt9yhnzg==",
            "dev": true,
            "dependencies": {
                "@babel/code-frame": "^7.25.7",
                "@babel/generator": "^7.25.7",
                "@babel/parser": "^7.25.7",
                "@babel/template": "^7.25.7",
                "@babel/types": "^7.25.7",
                "debug": "^4.3.1",
                "globals": "^11.1.0"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@babel/traverse/node_modules/globals": {
            "version": "11.12.0",
            "resolved": "https://registry.npmjs.org/globals/-/globals-11.12.0.tgz",
            "integrity": "sha512-WOBp/EEGUiIsJSp7wcv/y6MO+lV9UoncWqxuFfm8eBwzWNgyfBd6Gz+IeKQ9jCmyhoH99g15M3T+QaVHFjizVA==",
            "dev": true,
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/@babel/types": {
            "version": "7.25.7",
            "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.25.7.tgz",
            "integrity": "sha512-vwIVdXG+j+FOpkwqHRcBgHLYNL7XMkufrlaFvL9o6Ai9sJn9+PdyIL5qa0XzTZw084c+u9LOls53eoZWP/W5WQ==",
            "dev": true,
            "dependencies": {
                "@babel/helper-string-parser": "^7.25.7",
                "@babel/helper-validator-identifier": "^7.25.7",
                "to-fast-properties": "^2.0.0"
            },
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/@esbuild/aix-ppc64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
            "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
            "cpu": [
                "ppc64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "aix"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/android-arm": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
            "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
            "cpu": [
                "arm"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "android"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/android-arm64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
            "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "android"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/android-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
            "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "android"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/darwin-arm64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
            "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "darwin"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/darwin-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
            "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "darwin"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/freebsd-arm64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
            "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "freebsd"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/freebsd-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
            "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "freebsd"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-arm": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
            "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
            "cpu": [
                "arm"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-arm64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
            "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-ia32": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
            "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
            "cpu": [
                "ia32"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-loong64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
            "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
            "cpu": [
                "loong64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-mips64el": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
            "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
            "cpu": [
                "mips64el"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-ppc64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
            "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
            "cpu": [
                "ppc64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-riscv64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
            "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
            "cpu": [
                "riscv64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-s390x": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
            "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
            "cpu": [
                "s390x"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/linux-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
            "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/netbsd-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
            "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "netbsd"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/openbsd-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
            "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "openbsd"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/sunos-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
            "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "sunos"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/win32-arm64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
            "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/win32-ia32": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
            "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
            "cpu": [
                "ia32"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@esbuild/win32-x64": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
            "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ],
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@eslint-community/eslint-utils": {
            "version": "4.4.0",
            "resolved": "https://registry.npmjs.org/@eslint-community/eslint-utils/-/eslint-utils-4.4.0.tgz",
            "integrity": "sha512-1/sA4dwrzBAyeUoQ6oxahHKmrZvsnLCg4RfxW3ZFGGmQkSNQPFNLV9CUEFQP1x9EYXHTo5p6xdhZM1Ne9p/AfA==",
            "dev": true,
            "dependencies": {
                "eslint-visitor-keys": "^3.3.0"
            },
            "engines": {
                "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
            },
            "peerDependencies": {
                "eslint": "^6.0.0 || ^7.0.0 || >=8.0.0"
            }
        },
        "node_modules/@eslint-community/eslint-utils/node_modules/eslint-visitor-keys": {
            "version": "3.4.3",
            "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-3.4.3.tgz",
            "integrity": "sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==",
            "dev": true,
            "engines": {
                "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/@eslint-community/regexpp": {
            "version": "4.11.1",
            "resolved": "https://registry.npmjs.org/@eslint-community/regexpp/-/regexpp-4.11.1.tgz",
            "integrity": "sha512-m4DVN9ZqskZoLU5GlWZadwDnYo3vAEydiUayB9widCl9ffWx2IvPnp6n3on5rJmziJSw9Bv+Z3ChDVdMwXCY8Q==",
            "dev": true,
            "engines": {
                "node": "^12.0.0 || ^14.0.0 || >=16.0.0"
            }
        },
        "node_modules/@eslint/config-array": {
            "version": "0.18.0",
            "resolved": "https://registry.npmjs.org/@eslint/config-array/-/config-array-0.18.0.tgz",
            "integrity": "sha512-fTxvnS1sRMu3+JjXwJG0j/i4RT9u4qJ+lqS/yCGap4lH4zZGzQ7tu+xZqQmcMZq5OBZDL4QRxQzRjkWcGt8IVw==",
            "dev": true,
            "dependencies": {
                "@eslint/object-schema": "^2.1.4",
                "debug": "^4.3.1",
                "minimatch": "^3.1.2"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            }
        },
        "node_modules/@eslint/core": {
            "version": "0.6.0",
            "resolved": "https://registry.npmjs.org/@eslint/core/-/core-0.6.0.tgz",
            "integrity": "sha512-8I2Q8ykA4J0x0o7cg67FPVnehcqWTBehu/lmY+bolPFHGjh49YzGBMXTvpqVgEbBdvNCSxj6iFgiIyHzf03lzg==",
            "dev": true,
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            }
        },
        "node_modules/@eslint/eslintrc": {
            "version": "3.1.0",
            "resolved": "https://registry.npmjs.org/@eslint/eslintrc/-/eslintrc-3.1.0.tgz",
            "integrity": "sha512-4Bfj15dVJdoy3RfZmmo86RK1Fwzn6SstsvK9JS+BaVKqC6QQQQyXekNaC+g+LKNgkQ+2VhGAzm6hO40AhMR3zQ==",
            "dev": true,
            "dependencies": {
                "ajv": "^6.12.4",
                "debug": "^4.3.2",
                "espree": "^10.0.1",
                "globals": "^14.0.0",
                "ignore": "^5.2.0",
                "import-fresh": "^3.2.1",
                "js-yaml": "^4.1.0",
                "minimatch": "^3.1.2",
                "strip-json-comments": "^3.1.1"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/@eslint/eslintrc/node_modules/globals": {
            "version": "14.0.0",
            "resolved": "https://registry.npmjs.org/globals/-/globals-14.0.0.tgz",
            "integrity": "sha512-oahGvuMGQlPw/ivIYBjVSrWAfWLBeku5tpPE2fOPLi+WHffIWbuh2tCjhyQhTBPMf5E9jDEH4FOmTYgYwbKwtQ==",
            "dev": true,
            "engines": {
                "node": ">=18"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/@eslint/js": {
            "version": "9.12.0",
            "resolved": "https://registry.npmjs.org/@eslint/js/-/js-9.12.0.tgz",
            "integrity": "sha512-eohesHH8WFRUprDNyEREgqP6beG6htMeUYeCpkEgBCieCMme5r9zFWjzAJp//9S+Kub4rqE+jXe9Cp1a7IYIIA==",
            "dev": true,
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            }
        },
        "node_modules/@eslint/object-schema": {
            "version": "2.1.4",
            "resolved": "https://registry.npmjs.org/@eslint/object-schema/-/object-schema-2.1.4.tgz",
            "integrity": "sha512-BsWiH1yFGjXXS2yvrf5LyuoSIIbPrGUWob917o+BTKuZ7qJdxX8aJLRxs1fS9n6r7vESrq1OUqb68dANcFXuQQ==",
            "dev": true,
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            }
        },
        "node_modules/@eslint/plugin-kit": {
            "version": "0.2.0",
            "resolved": "https://registry.npmjs.org/@eslint/plugin-kit/-/plugin-kit-0.2.0.tgz",
            "integrity": "sha512-vH9PiIMMwvhCx31Af3HiGzsVNULDbyVkHXwlemn/B0TFj/00ho3y55efXrUZTfQipxoHC5u4xq6zblww1zm1Ig==",
            "dev": true,
            "dependencies": {
                "levn": "^0.4.1"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            }
        },
        "node_modules/@humanfs/core": {
            "version": "0.19.0",
            "resolved": "https://registry.npmjs.org/@humanfs/core/-/core-0.19.0.tgz",
            "integrity": "sha512-2cbWIHbZVEweE853g8jymffCA+NCMiuqeECeBBLm8dg2oFdjuGJhgN4UAbI+6v0CKbbhvtXA4qV8YR5Ji86nmw==",
            "dev": true,
            "engines": {
                "node": ">=18.18.0"
            }
        },
        "node_modules/@humanfs/node": {
            "version": "0.16.5",
            "resolved": "https://registry.npmjs.org/@humanfs/node/-/node-0.16.5.tgz",
            "integrity": "sha512-KSPA4umqSG4LHYRodq31VDwKAvaTF4xmVlzM8Aeh4PlU1JQ3IG0wiA8C25d3RQ9nJyM3mBHyI53K06VVL/oFFg==",
            "dev": true,
            "dependencies": {
                "@humanfs/core": "^0.19.0",
                "@humanwhocodes/retry": "^0.3.0"
            },
            "engines": {
                "node": ">=18.18.0"
            }
        },
        "node_modules/@humanwhocodes/module-importer": {
            "version": "1.0.1",
            "resolved": "https://registry.npmjs.org/@humanwhocodes/module-importer/-/module-importer-1.0.1.tgz",
            "integrity": "sha512-bxveV4V8v5Yb4ncFTT3rPSgZBOpCkjfK0y4oVVVJwIuDVBRMDXrPyXRL988i5ap9m9bnyEEjWfm5WkBmtffLfA==",
            "dev": true,
            "engines": {
                "node": ">=12.22"
            },
            "funding": {
                "type": "github",
                "url": "https://github.com/sponsors/nzakas"
            }
        },
        "node_modules/@humanwhocodes/retry": {
            "version": "0.3.1",
            "resolved": "https://registry.npmjs.org/@humanwhocodes/retry/-/retry-0.3.1.tgz",
            "integrity": "sha512-JBxkERygn7Bv/GbN5Rv8Ul6LVknS+5Bp6RgDC/O8gEBU/yeH5Ui5C/OlWrTb6qct7LjjfT6Re2NxB0ln0yYybA==",
            "dev": true,
            "engines": {
                "node": ">=18.18"
            },
            "funding": {
                "type": "github",
                "url": "https://github.com/sponsors/nzakas"
            }
        },
        "node_modules/@isaacs/cliui": {
            "version": "8.0.2",
            "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
            "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
            "dev": true,
            "dependencies": {
                "string-width": "^5.1.2",
                "string-width-cjs": "npm:string-width@^4.2.0",
                "strip-ansi": "^7.0.1",
                "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
                "wrap-ansi": "^8.1.0",
                "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
            },
            "engines": {
                "node": ">=12"
            }
        },
        "node_modules/@jridgewell/gen-mapping": {
            "version": "0.3.5",
            "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.5.tgz",
            "integrity": "sha512-IzL8ZoEDIBRWEzlCcRhOaCupYyN5gdIK+Q6fbFdPDg6HqX6jpkItn7DFIpW9LQzXG6Df9sA7+OKnq0qlz/GaQg==",
            "dev": true,
            "dependencies": {
                "@jridgewell/set-array": "^1.2.1",
                "@jridgewell/sourcemap-codec": "^1.4.10",
                "@jridgewell/trace-mapping": "^0.3.24"
            },
            "engines": {
                "node": ">=6.0.0"
            }
        },
        "node_modules/@jridgewell/resolve-uri": {
            "version": "3.1.2",
            "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
            "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
            "dev": true,
            "engines": {
                "node": ">=6.0.0"
            }
        },
        "node_modules/@jridgewell/set-array": {
            "version": "1.2.1",
            "resolved": "https://registry.npmjs.org/@jridgewell/set-array/-/set-array-1.2.1.tgz",
            "integrity": "sha512-R8gLRTZeyp03ymzP/6Lil/28tGeGEzhx1q2k703KGWRAI1VdvPIXdG70VJc2pAMw3NA6JKL5hhFu1sJX0Mnn/A==",
            "dev": true,
            "engines": {
                "node": ">=6.0.0"
            }
        },
        "node_modules/@jridgewell/sourcemap-codec": {
            "version": "1.5.0",
            "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.0.tgz",
            "integrity": "sha512-gv3ZRaISU3fjPAgNsriBRqGWQL6quFx04YMPW/zD8XMLsU32mhCCbfbO6KZFLjvYpCZ8zyDEgqsgf+PwPaM7GQ==",
            "dev": true
        },
        "node_modules/@jridgewell/trace-mapping": {
            "version": "0.3.25",
            "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.25.tgz",
            "integrity": "sha512-vNk6aEwybGtawWmy/PzwnGDOjCkLWSD2wqvjGGAgOAwCGWySYXfYoxt00IJkTF+8Lb57DwOb3Aa0o9CApepiYQ==",
            "dev": true,
            "dependencies": {
                "@jridgewell/resolve-uri": "^3.1.0",
                "@jridgewell/sourcemap-codec": "^1.4.14"
            }
        },
        "node_modules/@nodelib/fs.scandir": {
            "version": "2.1.5",
            "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
            "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
            "dev": true,
            "dependencies": {
                "@nodelib/fs.stat": "2.0.5",
                "run-parallel": "^1.1.9"
            },
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/@nodelib/fs.stat": {
            "version": "2.0.5",
            "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
            "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
            "dev": true,
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/@nodelib/fs.walk": {
            "version": "1.2.8",
            "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
            "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
            "dev": true,
            "dependencies": {
                "@nodelib/fs.scandir": "2.1.5",
                "fastq": "^1.6.0"
            },
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/@pkgjs/parseargs": {
            "version": "0.11.0",
            "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
            "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
            "dev": true,
            "optional": true,
            "engines": {
                "node": ">=14"
            }
        },
        "node_modules/@rollup/rollup-android-arm-eabi": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.24.0.tgz",
            "integrity": "sha512-Q6HJd7Y6xdB48x8ZNVDOqsbh2uByBhgK8PiQgPhwkIw/HC/YX5Ghq2mQY5sRMZWHb3VsFkWooUVOZHKr7DmDIA==",
            "cpu": [
                "arm"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "android"
            ]
        },
        "node_modules/@rollup/rollup-android-arm64": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.24.0.tgz",
            "integrity": "sha512-ijLnS1qFId8xhKjT81uBHuuJp2lU4x2yxa4ctFPtG+MqEE6+C5f/+X/bStmxapgmwLwiL3ih122xv8kVARNAZA==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "android"
            ]
        },
        "node_modules/@rollup/rollup-darwin-arm64": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.24.0.tgz",
            "integrity": "sha512-bIv+X9xeSs1XCk6DVvkO+S/z8/2AMt/2lMqdQbMrmVpgFvXlmde9mLcbQpztXm1tajC3raFDqegsH18HQPMYtA==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "darwin"
            ]
        },
        "node_modules/@rollup/rollup-darwin-x64": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.24.0.tgz",
            "integrity": "sha512-X6/nOwoFN7RT2svEQWUsW/5C/fYMBe4fnLK9DQk4SX4mgVBiTA9h64kjUYPvGQ0F/9xwJ5U5UfTbl6BEjaQdBQ==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "darwin"
            ]
        },
        "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.24.0.tgz",
            "integrity": "sha512-0KXvIJQMOImLCVCz9uvvdPgfyWo93aHHp8ui3FrtOP57svqrF/roSSR5pjqL2hcMp0ljeGlU4q9o/rQaAQ3AYA==",
            "cpu": [
                "arm"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-arm-musleabihf": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.24.0.tgz",
            "integrity": "sha512-it2BW6kKFVh8xk/BnHfakEeoLPv8STIISekpoF+nBgWM4d55CZKc7T4Dx1pEbTnYm/xEKMgy1MNtYuoA8RFIWw==",
            "cpu": [
                "arm"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-arm64-gnu": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.24.0.tgz",
            "integrity": "sha512-i0xTLXjqap2eRfulFVlSnM5dEbTVque/3Pi4g2y7cxrs7+a9De42z4XxKLYJ7+OhE3IgxvfQM7vQc43bwTgPwA==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-arm64-musl": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.24.0.tgz",
            "integrity": "sha512-9E6MKUJhDuDh604Qco5yP/3qn3y7SLXYuiC0Rpr89aMScS2UAmK1wHP2b7KAa1nSjWJc/f/Lc0Wl1L47qjiyQw==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-powerpc64le-gnu": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-powerpc64le-gnu/-/rollup-linux-powerpc64le-gnu-4.24.0.tgz",
            "integrity": "sha512-2XFFPJ2XMEiF5Zi2EBf4h73oR1V/lycirxZxHZNc93SqDN/IWhYYSYj8I9381ikUFXZrz2v7r2tOVk2NBwxrWw==",
            "cpu": [
                "ppc64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-riscv64-gnu": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.24.0.tgz",
            "integrity": "sha512-M3Dg4hlwuntUCdzU7KjYqbbd+BLq3JMAOhCKdBE3TcMGMZbKkDdJ5ivNdehOssMCIokNHFOsv7DO4rlEOfyKpg==",
            "cpu": [
                "riscv64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-s390x-gnu": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.24.0.tgz",
            "integrity": "sha512-mjBaoo4ocxJppTorZVKWFpy1bfFj9FeCMJqzlMQGjpNPY9JwQi7OuS1axzNIk0nMX6jSgy6ZURDZ2w0QW6D56g==",
            "cpu": [
                "s390x"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-x64-gnu": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.24.0.tgz",
            "integrity": "sha512-ZXFk7M72R0YYFN5q13niV0B7G8/5dcQ9JDp8keJSfr3GoZeXEoMHP/HlvqROA3OMbMdfr19IjCeNAnPUG93b6A==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-linux-x64-musl": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.24.0.tgz",
            "integrity": "sha512-w1i+L7kAXZNdYl+vFvzSZy8Y1arS7vMgIy8wusXJzRrPyof5LAb02KGr1PD2EkRcl73kHulIID0M501lN+vobQ==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "linux"
            ]
        },
        "node_modules/@rollup/rollup-win32-arm64-msvc": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.24.0.tgz",
            "integrity": "sha512-VXBrnPWgBpVDCVY6XF3LEW0pOU51KbaHhccHw6AS6vBWIC60eqsH19DAeeObl+g8nKAz04QFdl/Cefta0xQtUQ==",
            "cpu": [
                "arm64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ]
        },
        "node_modules/@rollup/rollup-win32-ia32-msvc": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.24.0.tgz",
            "integrity": "sha512-xrNcGDU0OxVcPTH/8n/ShH4UevZxKIO6HJFK0e15XItZP2UcaiLFd5kiX7hJnqCbSztUF8Qot+JWBC/QXRPYWQ==",
            "cpu": [
                "ia32"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ]
        },
        "node_modules/@rollup/rollup-win32-x64-msvc": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.24.0.tgz",
            "integrity": "sha512-fbMkAF7fufku0N2dE5TBXcNlg0pt0cJue4xBRE2Qc5Vqikxr4VCgKj/ht6SMdFcOacVA9rqF70APJ8RN/4vMJw==",
            "cpu": [
                "x64"
            ],
            "dev": true,
            "optional": true,
            "os": [
                "win32"
            ]
        },
        "node_modules/@types/babel__core": {
            "version": "7.20.5",
            "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
            "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
            "dev": true,
            "dependencies": {
                "@babel/parser": "^7.20.7",
                "@babel/types": "^7.20.7",
                "@types/babel__generator": "*",
                "@types/babel__template": "*",
                "@types/babel__traverse": "*"
            }
        },
        "node_modules/@types/babel__generator": {
            "version": "7.6.8",
            "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.6.8.tgz",
            "integrity": "sha512-ASsj+tpEDsEiFr1arWrlN6V3mdfjRMZt6LtK/Vp/kreFLnr5QH5+DhvD5nINYZXzwJvXeGq+05iUXcAzVrqWtw==",
            "dev": true,
            "dependencies": {
                "@babel/types": "^7.0.0"
            }
        },
        "node_modules/@types/babel__template": {
            "version": "7.4.4",
            "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
            "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
            "dev": true,
            "dependencies": {
                "@babel/parser": "^7.1.0",
                "@babel/types": "^7.0.0"
            }
        },
        "node_modules/@types/babel__traverse": {
            "version": "7.20.6",
            "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.20.6.tgz",
            "integrity": "sha512-r1bzfrm0tomOI8g1SzvCaQHo6Lcv6zu0EA+W2kHrt8dyrHQxGzBBL4kdkzIS+jBMV+EYcMAEAqXqYaLJq5rOZg==",
            "dev": true,
            "dependencies": {
                "@babel/types": "^7.20.7"
            }
        },
        "node_modules/@types/estree": {
            "version": "1.0.6",
            "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.6.tgz",
            "integrity": "sha512-AYnb1nQyY49te+VRAVgmzfcgjYS91mY5P0TKUDCLEM+gNnA+3T6rWITXRLYCpahpqSQbN5cE+gHpnPyXjHWxcw==",
            "dev": true
        },
        "node_modules/@types/json-schema": {
            "version": "7.0.15",
            "resolved": "https://registry.npmjs.org/@types/json-schema/-/json-schema-7.0.15.tgz",
            "integrity": "sha512-5+fP8P8MFNC+AyZCDxrB2pkZFPGzqQWUzpSeuuVLvm8VMcorNYavBqoFcxK8bQz4Qsbn4oUEEem4wDLfcysGHA==",
            "dev": true
        },
        "node_modules/@types/prop-types": {
            "version": "15.7.13",
            "resolved": "https://registry.npmjs.org/@types/prop-types/-/prop-types-15.7.13.tgz",
            "integrity": "sha512-hCZTSvwbzWGvhqxp/RqVqwU999pBf2vp7hzIjiYOsl8wqOmUxkQ6ddw1cV3l8811+kdUFus/q4d1Y3E3SyEifA==",
            "dev": true
        },
        "node_modules/@types/react": {
            "version": "18.3.11",
            "resolved": "https://registry.npmjs.org/@types/react/-/react-18.3.11.tgz",
            "integrity": "sha512-r6QZ069rFTjrEYgFdOck1gK7FLVsgJE7tTz0pQBczlBNUhBNk0MQH4UbnFSwjpQLMkLzgqvBBa+qGpLje16eTQ==",
            "dev": true,
            "dependencies": {
                "@types/prop-types": "*",
                "csstype": "^3.0.2"
            }
        },
        "node_modules/@types/react-dom": {
            "version": "18.3.0",
            "resolved": "https://registry.npmjs.org/@types/react-dom/-/react-dom-18.3.0.tgz",
            "integrity": "sha512-EhwApuTmMBmXuFOikhQLIBUn6uFg81SwLMOAUgodJF14SOBOCMdU04gDoYi0WOJJHD144TL32z4yDqCW3dnkQg==",
            "dev": true,
            "dependencies": {
                "@types/react": "*"
            }
        },
        "node_modules/@typescript-eslint/eslint-plugin": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/eslint-plugin/-/eslint-plugin-8.8.1.tgz",
            "integrity": "sha512-xfvdgA8AP/vxHgtgU310+WBnLB4uJQ9XdyP17RebG26rLtDrQJV3ZYrcopX91GrHmMoH8bdSwMRh2a//TiJ1jQ==",
            "dev": true,
            "dependencies": {
                "@eslint-community/regexpp": "^4.10.0",
                "@typescript-eslint/scope-manager": "8.8.1",
                "@typescript-eslint/type-utils": "8.8.1",
                "@typescript-eslint/utils": "8.8.1",
                "@typescript-eslint/visitor-keys": "8.8.1",
                "graphemer": "^1.4.0",
                "ignore": "^5.3.1",
                "natural-compare": "^1.4.0",
                "ts-api-utils": "^1.3.0"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependencies": {
                "@typescript-eslint/parser": "^8.0.0 || ^8.0.0-alpha.0",
                "eslint": "^8.57.0 || ^9.0.0"
            },
            "peerDependenciesMeta": {
                "typescript": {
                    "optional": true
                }
            }
        },
        "node_modules/@typescript-eslint/parser": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/parser/-/parser-8.8.1.tgz",
            "integrity": "sha512-hQUVn2Lij2NAxVFEdvIGxT9gP1tq2yM83m+by3whWFsWC+1y8pxxxHUFE1UqDu2VsGi2i6RLcv4QvouM84U+ow==",
            "dev": true,
            "peer": true,
            "dependencies": {
                "@typescript-eslint/scope-manager": "8.8.1",
                "@typescript-eslint/types": "8.8.1",
                "@typescript-eslint/typescript-estree": "8.8.1",
                "@typescript-eslint/visitor-keys": "8.8.1",
                "debug": "^4.3.4"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependencies": {
                "eslint": "^8.57.0 || ^9.0.0"
            },
            "peerDependenciesMeta": {
                "typescript": {
                    "optional": true
                }
            }
        },
        "node_modules/@typescript-eslint/scope-manager": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/scope-manager/-/scope-manager-8.8.1.tgz",
            "integrity": "sha512-X4JdU+66Mazev/J0gfXlcC/dV6JI37h+93W9BRYXrSn0hrE64IoWgVkO9MSJgEzoWkxONgaQpICWg8vAN74wlA==",
            "dev": true,
            "dependencies": {
                "@typescript-eslint/types": "8.8.1",
                "@typescript-eslint/visitor-keys": "8.8.1"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            }
        },
        "node_modules/@typescript-eslint/type-utils": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/type-utils/-/type-utils-8.8.1.tgz",
            "integrity": "sha512-qSVnpcbLP8CALORf0za+vjLYj1Wp8HSoiI8zYU5tHxRVj30702Z1Yw4cLwfNKhTPWp5+P+k1pjmD5Zd1nhxiZA==",
            "dev": true,
            "dependencies": {
                "@typescript-eslint/typescript-estree": "8.8.1",
                "@typescript-eslint/utils": "8.8.1",
                "debug": "^4.3.4",
                "ts-api-utils": "^1.3.0"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependenciesMeta": {
                "typescript": {
                    "optional": true
                }
            }
        },
        "node_modules/@typescript-eslint/types": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/types/-/types-8.8.1.tgz",
            "integrity": "sha512-WCcTP4SDXzMd23N27u66zTKMuEevH4uzU8C9jf0RO4E04yVHgQgW+r+TeVTNnO1KIfrL8ebgVVYYMMO3+jC55Q==",
            "dev": true,
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            }
        },
        "node_modules/@typescript-eslint/typescript-estree": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/typescript-estree/-/typescript-estree-8.8.1.tgz",
            "integrity": "sha512-A5d1R9p+X+1js4JogdNilDuuq+EHZdsH9MjTVxXOdVFfTJXunKJR/v+fNNyO4TnoOn5HqobzfRlc70NC6HTcdg==",
            "dev": true,
            "dependencies": {
                "@typescript-eslint/types": "8.8.1",
                "@typescript-eslint/visitor-keys": "8.8.1",
                "debug": "^4.3.4",
                "fast-glob": "^3.3.2",
                "is-glob": "^4.0.3",
                "minimatch": "^9.0.4",
                "semver": "^7.6.0",
                "ts-api-utils": "^1.3.0"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependenciesMeta": {
                "typescript": {
                    "optional": true
                }
            }
        },
        "node_modules/@typescript-eslint/typescript-estree/node_modules/brace-expansion": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
            "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
            "dev": true,
            "dependencies": {
                "balanced-match": "^1.0.0"
            }
        },
        "node_modules/@typescript-eslint/typescript-estree/node_modules/minimatch": {
            "version": "9.0.5",
            "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
            "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
            "dev": true,
            "dependencies": {
                "brace-expansion": "^2.0.1"
            },
            "engines": {
                "node": ">=16 || 14 >=14.17"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/@typescript-eslint/typescript-estree/node_modules/semver": {
            "version": "7.6.3",
            "resolved": "https://registry.npmjs.org/semver/-/semver-7.6.3.tgz",
            "integrity": "sha512-oVekP1cKtI+CTDvHWYFUcMtsK/00wmAEfyqKfNdARm8u1wNVhSgaX7A8d4UuIlUI5e84iEwOhs7ZPYRmzU9U6A==",
            "dev": true,
            "bin": {
                "semver": "bin/semver.js"
            },
            "engines": {
                "node": ">=10"
            }
        },
        "node_modules/@typescript-eslint/utils": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/utils/-/utils-8.8.1.tgz",
            "integrity": "sha512-/QkNJDbV0bdL7H7d0/y0qBbV2HTtf0TIyjSDTvvmQEzeVx8jEImEbLuOA4EsvE8gIgqMitns0ifb5uQhMj8d9w==",
            "dev": true,
            "dependencies": {
                "@eslint-community/eslint-utils": "^4.4.0",
                "@typescript-eslint/scope-manager": "8.8.1",
                "@typescript-eslint/types": "8.8.1",
                "@typescript-eslint/typescript-estree": "8.8.1"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependencies": {
                "eslint": "^8.57.0 || ^9.0.0"
            }
        },
        "node_modules/@typescript-eslint/visitor-keys": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/@typescript-eslint/visitor-keys/-/visitor-keys-8.8.1.tgz",
            "integrity": "sha512-0/TdC3aeRAsW7MDvYRwEc1Uwm0TIBfzjPFgg60UU2Haj5qsCs9cc3zNgY71edqE3LbWfF/WoZQd3lJoDXFQpag==",
            "dev": true,
            "dependencies": {
                "@typescript-eslint/types": "8.8.1",
                "eslint-visitor-keys": "^3.4.3"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            }
        },
        "node_modules/@typescript-eslint/visitor-keys/node_modules/eslint-visitor-keys": {
            "version": "3.4.3",
            "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-3.4.3.tgz",
            "integrity": "sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==",
            "dev": true,
            "engines": {
                "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/@vitejs/plugin-react": {
            "version": "4.3.2",
            "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.3.2.tgz",
            "integrity": "sha512-hieu+o05v4glEBucTcKMK3dlES0OeJlD9YVOAPraVMOInBCwzumaIFiUjr4bHK7NPgnAHgiskUoceKercrN8vg==",
            "dev": true,
            "dependencies": {
                "@babel/core": "^7.25.2",
                "@babel/plugin-transform-react-jsx-self": "^7.24.7",
                "@babel/plugin-transform-react-jsx-source": "^7.24.7",
                "@types/babel__core": "^7.20.5",
                "react-refresh": "^0.14.2"
            },
            "engines": {
                "node": "^14.18.0 || >=16.0.0"
            },
            "peerDependencies": {
                "vite": "^4.2.0 || ^5.0.0"
            }
        },
        "node_modules/acorn": {
            "version": "8.12.1",
            "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.12.1.tgz",
            "integrity": "sha512-tcpGyI9zbizT9JbV6oYE477V6mTlXvvi0T0G3SNIYE2apm/G5huBa1+K89VGeovbg+jycCrfhl3ADxErOuO6Jg==",
            "dev": true,
            "peer": true,
            "bin": {
                "acorn": "bin/acorn"
            },
            "engines": {
                "node": ">=0.4.0"
            }
        },
        "node_modules/acorn-jsx": {
            "version": "5.3.2",
            "resolved": "https://registry.npmjs.org/acorn-jsx/-/acorn-jsx-5.3.2.tgz",
            "integrity": "sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ==",
            "dev": true,
            "peerDependencies": {
                "acorn": "^6.0.0 || ^7.0.0 || ^8.0.0"
            }
        },
        "node_modules/ajv": {
            "version": "6.12.6",
            "resolved": "https://registry.npmjs.org/ajv/-/ajv-6.12.6.tgz",
            "integrity": "sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==",
            "dev": true,
            "dependencies": {
                "fast-deep-equal": "^3.1.1",
                "fast-json-stable-stringify": "^2.0.0",
                "json-schema-traverse": "^0.4.1",
                "uri-js": "^4.2.2"
            },
            "funding": {
                "type": "github",
                "url": "https://github.com/sponsors/epoberezkin"
            }
        },
        "node_modules/ansi-regex": {
            "version": "6.1.0",
            "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.1.0.tgz",
            "integrity": "sha512-7HSX4QQb4CspciLpVFwyRe79O3xsIZDDLER21kERQ71oaPodF8jL725AgJMFAYbooIqolJoRLuM81SpeUkpkvA==",
            "dev": true,
            "engines": {
                "node": ">=12"
            },
            "funding": {
                "url": "https://github.com/chalk/ansi-regex?sponsor=1"
            }
        },
        "node_modules/ansi-styles": {
            "version": "3.2.1",
            "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-3.2.1.tgz",
            "integrity": "sha512-VT0ZI6kZRdTh8YyJw3SMbYm/u+NqfsAxEpWO0Pf9sq8/e94WxxOpPKx9FR1FlyCtOVDNOQ+8ntlqFxiRc+r5qA==",
            "dev": true,
            "dependencies": {
                "color-convert": "^1.9.0"
            },
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/any-promise": {
            "version": "1.3.0",
            "resolved": "https://registry.npmjs.org/any-promise/-/any-promise-1.3.0.tgz",
            "integrity": "sha512-7UvmKalWRt1wgjL1RrGxoSJW/0QZFIegpeGvZG9kjp8vrRu55XTHbwnqq2GpXm9uLbcuhxm3IqX9OB4MZR1b2A==",
            "dev": true
        },
        "node_modules/anymatch": {
            "version": "3.1.3",
            "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
            "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
            "dev": true,
            "dependencies": {
                "normalize-path": "^3.0.0",
                "picomatch": "^2.0.4"
            },
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/arg": {
            "version": "5.0.2",
            "resolved": "https://registry.npmjs.org/arg/-/arg-5.0.2.tgz",
            "integrity": "sha512-PYjyFOLKQ9y57JvQ6QLo8dAgNqswh8M1RMJYdQduT6xbWSgK36P/Z/v+p888pM69jMMfS8Xd8F6I1kQ/I9HUGg==",
            "dev": true
        },
        "node_modules/argparse": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
            "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
            "dev": true
        },
        "node_modules/autoprefixer": {
            "version": "10.4.20",
            "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.20.tgz",
            "integrity": "sha512-XY25y5xSv/wEoqzDyXXME4AFfkZI0P23z6Fs3YgymDnKJkCGOnkL0iTxCa85UTqaSgfcqyf3UA6+c7wUvx/16g==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/postcss/"
                },
                {
                    "type": "tidelift",
                    "url": "https://tidelift.com/funding/github/npm/autoprefixer"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "dependencies": {
                "browserslist": "^4.23.3",
                "caniuse-lite": "^1.0.30001646",
                "fraction.js": "^4.3.7",
                "normalize-range": "^0.1.2",
                "picocolors": "^1.0.1",
                "postcss-value-parser": "^4.2.0"
            },
            "bin": {
                "autoprefixer": "bin/autoprefixer"
            },
            "engines": {
                "node": "^10 || ^12 || >=14"
            },
            "peerDependencies": {
                "postcss": "^8.1.0"
            }
        },
        "node_modules/balanced-match": {
            "version": "1.0.2",
            "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
            "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
            "dev": true
        },
        "node_modules/binary-extensions": {
            "version": "2.3.0",
            "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
            "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
            "dev": true,
            "engines": {
                "node": ">=8"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/brace-expansion": {
            "version": "1.1.11",
            "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.11.tgz",
            "integrity": "sha512-iCuPHDFgrHX7H2vEI/5xpz07zSHB00TpugqhmYtVmMO6518mCuRMoOYFldEBl0g187ufozdaHgWKcYFb61qGiA==",
            "dev": true,
            "dependencies": {
                "balanced-match": "^1.0.0",
                "concat-map": "0.0.1"
            }
        },
        "node_modules/braces": {
            "version": "3.0.3",
            "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
            "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
            "dev": true,
            "dependencies": {
                "fill-range": "^7.1.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/browserslist": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.24.0.tgz",
            "integrity": "sha512-Rmb62sR1Zpjql25eSanFGEhAxcFwfA1K0GuQcLoaJBAcENegrQut3hYdhXFF1obQfiDyqIW/cLM5HSJ/9k884A==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/browserslist"
                },
                {
                    "type": "tidelift",
                    "url": "https://tidelift.com/funding/github/npm/browserslist"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "peer": true,
            "dependencies": {
                "caniuse-lite": "^1.0.30001663",
                "electron-to-chromium": "^1.5.28",
                "node-releases": "^2.0.18",
                "update-browserslist-db": "^1.1.0"
            },
            "bin": {
                "browserslist": "cli.js"
            },
            "engines": {
                "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
            }
        },
        "node_modules/callsites": {
            "version": "3.1.0",
            "resolved": "https://registry.npmjs.org/callsites/-/callsites-3.1.0.tgz",
            "integrity": "sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==",
            "dev": true,
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/camelcase-css": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/camelcase-css/-/camelcase-css-2.0.1.tgz",
            "integrity": "sha512-QOSvevhslijgYwRx6Rv7zKdMF8lbRmx+uQGx2+vDc+KI/eBnsy9kit5aj23AgGu3pa4t9AgwbnXWqS+iOY+2aA==",
            "dev": true,
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/caniuse-lite": {
            "version": "1.0.30001667",
            "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001667.tgz",
            "integrity": "sha512-7LTwJjcRkzKFmtqGsibMeuXmvFDfZq/nzIjnmgCGzKKRVzjD72selLDK1oPF/Oxzmt4fNcPvTDvGqSDG4tCALw==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/browserslist"
                },
                {
                    "type": "tidelift",
                    "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ]
        },
        "node_modules/chalk": {
            "version": "2.4.2",
            "resolved": "https://registry.npmjs.org/chalk/-/chalk-2.4.2.tgz",
            "integrity": "sha512-Mti+f9lpJNcwF4tWV8/OrTTtF1gZi+f8FqlyAdouralcFWFQWF2+NgCHShjkCb+IFBLq9buZwE1xckQU4peSuQ==",
            "dev": true,
            "dependencies": {
                "ansi-styles": "^3.2.1",
                "escape-string-regexp": "^1.0.5",
                "supports-color": "^5.3.0"
            },
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/chokidar": {
            "version": "3.6.0",
            "resolved": "https://registry.npmjs.org/chokidar/-/chokidar-3.6.0.tgz",
            "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
            "dev": true,
            "dependencies": {
                "anymatch": "~3.1.2",
                "braces": "~3.0.2",
                "glob-parent": "~5.1.2",
                "is-binary-path": "~2.1.0",
                "is-glob": "~4.0.1",
                "normalize-path": "~3.0.0",
                "readdirp": "~3.6.0"
            },
            "engines": {
                "node": ">= 8.10.0"
            },
            "funding": {
                "url": "https://paulmillr.com/funding/"
            },
            "optionalDependencies": {
                "fsevents": "~2.3.2"
            }
        },
        "node_modules/chokidar/node_modules/glob-parent": {
            "version": "5.1.2",
            "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
            "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
            "dev": true,
            "dependencies": {
                "is-glob": "^4.0.1"
            },
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/color-convert": {
            "version": "1.9.3",
            "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-1.9.3.tgz",
            "integrity": "sha512-QfAUtd+vFdAtFQcC8CCyYt1fYWxSqAiK2cSD6zDB8N3cpsEBAvRxp9zOGg6G/SHHJYAT88/az/IuDGALsNVbGg==",
            "dev": true,
            "dependencies": {
                "color-name": "1.1.3"
            }
        },
        "node_modules/color-name": {
            "version": "1.1.3",
            "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.3.tgz",
            "integrity": "sha512-72fSenhMw2HZMTVHeCA9KCmpEIbzWiQsjN+BHcBbS9vr1mtt+vJjPdksIBNUmKAW8TFUDPJK5SUU3QhE9NEXDw==",
            "dev": true
        },
        "node_modules/commander": {
            "version": "4.1.1",
            "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
            "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA==",
            "dev": true,
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/concat-map": {
            "version": "0.0.1",
            "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
            "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
            "dev": true
        },
        "node_modules/convert-source-map": {
            "version": "2.0.0",
            "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
            "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
            "dev": true
        },
        "node_modules/cross-spawn": {
            "version": "7.0.3",
            "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.3.tgz",
            "integrity": "sha512-iRDPJKUPVEND7dHPO8rkbOnPpyDygcDFtWjpeWNCgy8WP2rXcxXL8TskReQl6OrB2G7+UJrags1q15Fudc7G6w==",
            "dev": true,
            "dependencies": {
                "path-key": "^3.1.0",
                "shebang-command": "^2.0.0",
                "which": "^2.0.1"
            },
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/cssesc": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/cssesc/-/cssesc-3.0.0.tgz",
            "integrity": "sha512-/Tb/JcjK111nNScGob5MNtsntNM1aCNUDipB/TkwZFhyDrrE47SOx/18wF2bbjgc3ZzCSKW1T5nt5EbFoAz/Vg==",
            "dev": true,
            "bin": {
                "cssesc": "bin/cssesc"
            },
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/csstype": {
            "version": "3.1.3",
            "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.1.3.tgz",
            "integrity": "sha512-M1uQkMl8rQK/szD0LNhtqxIPLpimGm8sOBwU7lLnCpSbTyY3yeU1Vc7l4KT5zT4s/yOxHH5O7tIuuLOCnLADRw==",
            "dev": true
        },
        "node_modules/debug": {
            "version": "4.3.7",
            "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.7.tgz",
            "integrity": "sha512-Er2nc/H7RrMXZBFCEim6TCmMk02Z8vLC2Rbi1KEBggpo0fS6l0S1nnapwmIi3yW/+GOJap1Krg4w0Hg80oCqgQ==",
            "dev": true,
            "dependencies": {
                "ms": "^2.1.3"
            },
            "engines": {
                "node": ">=6.0"
            },
            "peerDependenciesMeta": {
                "supports-color": {
                    "optional": true
                }
            }
        },
        "node_modules/deep-is": {
            "version": "0.1.4",
            "resolved": "https://registry.npmjs.org/deep-is/-/deep-is-0.1.4.tgz",
            "integrity": "sha512-oIPzksmTg4/MriiaYGO+okXDT7ztn/w3Eptv/+gSIdMdKsJo0u4CfYNFJPy+4SKMuCqGw2wxnA+URMg3t8a/bQ==",
            "dev": true
        },
        "node_modules/didyoumean": {
            "version": "1.2.2",
            "resolved": "https://registry.npmjs.org/didyoumean/-/didyoumean-1.2.2.tgz",
            "integrity": "sha512-gxtyfqMg7GKyhQmb056K7M3xszy/myH8w+B4RT+QXBQsvAOdc3XymqDDPHx1BgPgsdAA5SIifona89YtRATDzw==",
            "dev": true
        },
        "node_modules/dlv": {
            "version": "1.1.3",
            "resolved": "https://registry.npmjs.org/dlv/-/dlv-1.1.3.tgz",
            "integrity": "sha512-+HlytyjlPKnIG8XuRG8WvmBP8xs8P71y+SKKS6ZXWoEgLuePxtDoUEiH7WkdePWrQ5JBpE6aoVqfZfJUQkjXwA==",
            "dev": true
        },
        "node_modules/eastasianwidth": {
            "version": "0.2.0",
            "resolved": "https://registry.npmjs.org/eastasianwidth/-/eastasianwidth-0.2.0.tgz",
            "integrity": "sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==",
            "dev": true
        },
        "node_modules/electron-to-chromium": {
            "version": "1.5.33",
            "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.33.tgz",
            "integrity": "sha512-+cYTcFB1QqD4j4LegwLfpCNxifb6dDFUAwk6RsLusCwIaZI6or2f+q8rs5tTB2YC53HhOlIbEaqHMAAC8IOIwA==",
            "dev": true
        },
        "node_modules/emoji-regex": {
            "version": "9.2.2",
            "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
            "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
            "dev": true
        },
        "node_modules/esbuild": {
            "version": "0.21.5",
            "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
            "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
            "dev": true,
            "hasInstallScript": true,
            "bin": {
                "esbuild": "bin/esbuild"
            },
            "engines": {
                "node": ">=12"
            },
            "optionalDependencies": {
                "@esbuild/aix-ppc64": "0.21.5",
                "@esbuild/android-arm": "0.21.5",
                "@esbuild/android-arm64": "0.21.5",
                "@esbuild/android-x64": "0.21.5",
                "@esbuild/darwin-arm64": "0.21.5",
                "@esbuild/darwin-x64": "0.21.5",
                "@esbuild/freebsd-arm64": "0.21.5",
                "@esbuild/freebsd-x64": "0.21.5",
                "@esbuild/linux-arm": "0.21.5",
                "@esbuild/linux-arm64": "0.21.5",
                "@esbuild/linux-ia32": "0.21.5",
                "@esbuild/linux-loong64": "0.21.5",
                "@esbuild/linux-mips64el": "0.21.5",
                "@esbuild/linux-ppc64": "0.21.5",
                "@esbuild/linux-riscv64": "0.21.5",
                "@esbuild/linux-s390x": "0.21.5",
                "@esbuild/linux-x64": "0.21.5",
                "@esbuild/netbsd-x64": "0.21.5",
                "@esbuild/openbsd-x64": "0.21.5",
                "@esbuild/sunos-x64": "0.21.5",
                "@esbuild/win32-arm64": "0.21.5",
                "@esbuild/win32-ia32": "0.21.5",
                "@esbuild/win32-x64": "0.21.5"
            }
        },
        "node_modules/escalade": {
            "version": "3.2.0",
            "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
            "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
            "dev": true,
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/escape-string-regexp": {
            "version": "1.0.5",
            "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-1.0.5.tgz",
            "integrity": "sha512-vbRorB5FUQWvla16U8R/qgaFIya2qGzwDrNmCZuYKrbdSUMG6I1ZCGQRefkRVhuOkIGVne7BQ35DSfo1qvJqFg==",
            "dev": true,
            "engines": {
                "node": ">=0.8.0"
            }
        },
        "node_modules/eslint": {
            "version": "9.12.0",
            "resolved": "https://registry.npmjs.org/eslint/-/eslint-9.12.0.tgz",
            "integrity": "sha512-UVIOlTEWxwIopRL1wgSQYdnVDcEvs2wyaO6DGo5mXqe3r16IoCNWkR29iHhyaP4cICWjbgbmFUGAhh0GJRuGZw==",
            "dev": true,
            "peer": true,
            "dependencies": {
                "@eslint-community/eslint-utils": "^4.2.0",
                "@eslint-community/regexpp": "^4.11.0",
                "@eslint/config-array": "^0.18.0",
                "@eslint/core": "^0.6.0",
                "@eslint/eslintrc": "^3.1.0",
                "@eslint/js": "9.12.0",
                "@eslint/plugin-kit": "^0.2.0",
                "@humanfs/node": "^0.16.5",
                "@humanwhocodes/module-importer": "^1.0.1",
                "@humanwhocodes/retry": "^0.3.1",
                "@types/estree": "^1.0.6",
                "@types/json-schema": "^7.0.15",
                "ajv": "^6.12.4",
                "chalk": "^4.0.0",
                "cross-spawn": "^7.0.2",
                "debug": "^4.3.2",
                "escape-string-regexp": "^4.0.0",
                "eslint-scope": "^8.1.0",
                "eslint-visitor-keys": "^4.1.0",
                "espree": "^10.2.0",
                "esquery": "^1.5.0",
                "esutils": "^2.0.2",
                "fast-deep-equal": "^3.1.3",
                "file-entry-cache": "^8.0.0",
                "find-up": "^5.0.0",
                "glob-parent": "^6.0.2",
                "ignore": "^5.2.0",
                "imurmurhash": "^0.1.4",
                "is-glob": "^4.0.0",
                "json-stable-stringify-without-jsonify": "^1.0.1",
                "lodash.merge": "^4.6.2",
                "minimatch": "^3.1.2",
                "natural-compare": "^1.4.0",
                "optionator": "^0.9.3",
                "text-table": "^0.2.0"
            },
            "bin": {
                "eslint": "bin/eslint.js"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "url": "https://eslint.org/donate"
            },
            "peerDependencies": {
                "jiti": "*"
            },
            "peerDependenciesMeta": {
                "jiti": {
                    "optional": true
                }
            }
        },
        "node_modules/eslint-plugin-react-hooks": {
            "version": "5.1.0-rc-fb9a90fa48-20240614",
            "resolved": "https://registry.npmjs.org/eslint-plugin-react-hooks/-/eslint-plugin-react-hooks-5.1.0-rc-fb9a90fa48-20240614.tgz",
            "integrity": "sha512-xsiRwaDNF5wWNC4ZHLut+x/YcAxksUd9Rizt7LaEn3bV8VyYRpXnRJQlLOfYaVy9esk4DFP4zPPnoNVjq5Gc0w==",
            "dev": true,
            "engines": {
                "node": ">=10"
            },
            "peerDependencies": {
                "eslint": "^3.0.0 || ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0-0 || ^9.0.0"
            }
        },
        "node_modules/eslint-plugin-react-refresh": {
            "version": "0.4.12",
            "resolved": "https://registry.npmjs.org/eslint-plugin-react-refresh/-/eslint-plugin-react-refresh-0.4.12.tgz",
            "integrity": "sha512-9neVjoGv20FwYtCP6CB1dzR1vr57ZDNOXst21wd2xJ/cTlM2xLq0GWVlSNTdMn/4BtP6cHYBMCSp1wFBJ9jBsg==",
            "dev": true,
            "peerDependencies": {
                "eslint": ">=7"
            }
        },
        "node_modules/eslint-scope": {
            "version": "8.1.0",
            "resolved": "https://registry.npmjs.org/eslint-scope/-/eslint-scope-8.1.0.tgz",
            "integrity": "sha512-14dSvlhaVhKKsa9Fx1l8A17s7ah7Ef7wCakJ10LYk6+GYmP9yDti2oq2SEwcyndt6knfcZyhyxwY3i9yL78EQw==",
            "dev": true,
            "dependencies": {
                "esrecurse": "^4.3.0",
                "estraverse": "^5.2.0"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/eslint-visitor-keys": {
            "version": "4.1.0",
            "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-4.1.0.tgz",
            "integrity": "sha512-Q7lok0mqMUSf5a/AdAZkA5a/gHcO6snwQClVNNvFKCAVlxXucdU8pKydU5ZVZjBx5xr37vGbFFWtLQYreLzrZg==",
            "dev": true,
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/eslint/node_modules/ansi-styles": {
            "version": "4.3.0",
            "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
            "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
            "dev": true,
            "dependencies": {
                "color-convert": "^2.0.1"
            },
            "engines": {
                "node": ">=8"
            },
            "funding": {
                "url": "https://github.com/chalk/ansi-styles?sponsor=1"
            }
        },
        "node_modules/eslint/node_modules/chalk": {
            "version": "4.1.2",
            "resolved": "https://registry.npmjs.org/chalk/-/chalk-4.1.2.tgz",
            "integrity": "sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==",
            "dev": true,
            "dependencies": {
                "ansi-styles": "^4.1.0",
                "supports-color": "^7.1.0"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/chalk/chalk?sponsor=1"
            }
        },
        "node_modules/eslint/node_modules/color-convert": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
            "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
            "dev": true,
            "dependencies": {
                "color-name": "~1.1.4"
            },
            "engines": {
                "node": ">=7.0.0"
            }
        },
        "node_modules/eslint/node_modules/color-name": {
            "version": "1.1.4",
            "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
            "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
            "dev": true
        },
        "node_modules/eslint/node_modules/escape-string-regexp": {
            "version": "4.0.0",
            "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz",
            "integrity": "sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==",
            "dev": true,
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/eslint/node_modules/has-flag": {
            "version": "4.0.0",
            "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-4.0.0.tgz",
            "integrity": "sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/eslint/node_modules/supports-color": {
            "version": "7.2.0",
            "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
            "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
            "dev": true,
            "dependencies": {
                "has-flag": "^4.0.0"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/espree": {
            "version": "10.2.0",
            "resolved": "https://registry.npmjs.org/espree/-/espree-10.2.0.tgz",
            "integrity": "sha512-upbkBJbckcCNBDBDXEbuhjbP68n+scUd3k/U2EkyM9nw+I/jPiL4cLF/Al06CF96wRltFda16sxDFrxsI1v0/g==",
            "dev": true,
            "dependencies": {
                "acorn": "^8.12.0",
                "acorn-jsx": "^5.3.2",
                "eslint-visitor-keys": "^4.1.0"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "url": "https://opencollective.com/eslint"
            }
        },
        "node_modules/esquery": {
            "version": "1.6.0",
            "resolved": "https://registry.npmjs.org/esquery/-/esquery-1.6.0.tgz",
            "integrity": "sha512-ca9pw9fomFcKPvFLXhBKUK90ZvGibiGOvRJNbjljY7s7uq/5YO4BOzcYtJqExdx99rF6aAcnRxHmcUHcz6sQsg==",
            "dev": true,
            "dependencies": {
                "estraverse": "^5.1.0"
            },
            "engines": {
                "node": ">=0.10"
            }
        },
        "node_modules/esrecurse": {
            "version": "4.3.0",
            "resolved": "https://registry.npmjs.org/esrecurse/-/esrecurse-4.3.0.tgz",
            "integrity": "sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==",
            "dev": true,
            "dependencies": {
                "estraverse": "^5.2.0"
            },
            "engines": {
                "node": ">=4.0"
            }
        },
        "node_modules/estraverse": {
            "version": "5.3.0",
            "resolved": "https://registry.npmjs.org/estraverse/-/estraverse-5.3.0.tgz",
            "integrity": "sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==",
            "dev": true,
            "engines": {
                "node": ">=4.0"
            }
        },
        "node_modules/esutils": {
            "version": "2.0.3",
            "resolved": "https://registry.npmjs.org/esutils/-/esutils-2.0.3.tgz",
            "integrity": "sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/fast-deep-equal": {
            "version": "3.1.3",
            "resolved": "https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz",
            "integrity": "sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==",
            "dev": true
        },
        "node_modules/fast-glob": {
            "version": "3.3.2",
            "resolved": "https://registry.npmjs.org/fast-glob/-/fast-glob-3.3.2.tgz",
            "integrity": "sha512-oX2ruAFQwf/Orj8m737Y5adxDQO0LAB7/S5MnxCdTNDd4p6BsyIVsv9JQsATbTSq8KHRpLwIHbVlUNatxd+1Ow==",
            "dev": true,
            "dependencies": {
                "@nodelib/fs.stat": "^2.0.2",
                "@nodelib/fs.walk": "^1.2.3",
                "glob-parent": "^5.1.2",
                "merge2": "^1.3.0",
                "micromatch": "^4.0.4"
            },
            "engines": {
                "node": ">=8.6.0"
            }
        },
        "node_modules/fast-glob/node_modules/glob-parent": {
            "version": "5.1.2",
            "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
            "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
            "dev": true,
            "dependencies": {
                "is-glob": "^4.0.1"
            },
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/fast-json-stable-stringify": {
            "version": "2.1.0",
            "resolved": "https://registry.npmjs.org/fast-json-stable-stringify/-/fast-json-stable-stringify-2.1.0.tgz",
            "integrity": "sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==",
            "dev": true
        },
        "node_modules/fast-levenshtein": {
            "version": "2.0.6",
            "resolved": "https://registry.npmjs.org/fast-levenshtein/-/fast-levenshtein-2.0.6.tgz",
            "integrity": "sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==",
            "dev": true
        },
        "node_modules/fastq": {
            "version": "1.17.1",
            "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.17.1.tgz",
            "integrity": "sha512-sRVD3lWVIXWg6By68ZN7vho9a1pQcN/WBFaAAsDDFzlJjvoGx0P8z7V1t72grFJfJhu3YPZBuu25f7Kaw2jN1w==",
            "dev": true,
            "dependencies": {
                "reusify": "^1.0.4"
            }
        },
        "node_modules/file-entry-cache": {
            "version": "8.0.0",
            "resolved": "https://registry.npmjs.org/file-entry-cache/-/file-entry-cache-8.0.0.tgz",
            "integrity": "sha512-XXTUwCvisa5oacNGRP9SfNtYBNAMi+RPwBFmblZEF7N7swHYQS6/Zfk7SRwx4D5j3CH211YNRco1DEMNVfZCnQ==",
            "dev": true,
            "dependencies": {
                "flat-cache": "^4.0.0"
            },
            "engines": {
                "node": ">=16.0.0"
            }
        },
        "node_modules/fill-range": {
            "version": "7.1.1",
            "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
            "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
            "dev": true,
            "dependencies": {
                "to-regex-range": "^5.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/find-up": {
            "version": "5.0.0",
            "resolved": "https://registry.npmjs.org/find-up/-/find-up-5.0.0.tgz",
            "integrity": "sha512-78/PXT1wlLLDgTzDs7sjq9hzz0vXD+zn+7wypEe4fXQxCmdmqfGsEPQxmiCSQI3ajFV91bVSsvNtrJRiW6nGng==",
            "dev": true,
            "dependencies": {
                "locate-path": "^6.0.0",
                "path-exists": "^4.0.0"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/flat-cache": {
            "version": "4.0.1",
            "resolved": "https://registry.npmjs.org/flat-cache/-/flat-cache-4.0.1.tgz",
            "integrity": "sha512-f7ccFPK3SXFHpx15UIGyRJ/FJQctuKZ0zVuN3frBo4HnK3cay9VEW0R6yPYFHC0AgqhukPzKjq22t5DmAyqGyw==",
            "dev": true,
            "dependencies": {
                "flatted": "^3.2.9",
                "keyv": "^4.5.4"
            },
            "engines": {
                "node": ">=16"
            }
        },
        "node_modules/flatted": {
            "version": "3.3.1",
            "resolved": "https://registry.npmjs.org/flatted/-/flatted-3.3.1.tgz",
            "integrity": "sha512-X8cqMLLie7KsNUDSdzeN8FYK9rEt4Dt67OsG/DNGnYTSDBG4uFAJFBnUeiV+zCVAvwFy56IjM9sH51jVaEhNxw==",
            "dev": true
        },
        "node_modules/foreground-child": {
            "version": "3.3.0",
            "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.3.0.tgz",
            "integrity": "sha512-Ld2g8rrAyMYFXBhEqMz8ZAHBi4J4uS1i/CxGMDnjyFWddMXLVcDp051DZfu+t7+ab7Wv6SMqpWmyFIj5UbfFvg==",
            "dev": true,
            "dependencies": {
                "cross-spawn": "^7.0.0",
                "signal-exit": "^4.0.1"
            },
            "engines": {
                "node": ">=14"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/fraction.js": {
            "version": "4.3.7",
            "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-4.3.7.tgz",
            "integrity": "sha512-ZsDfxO51wGAXREY55a7la9LScWpwv9RxIrYABrlvOFBlH/ShPnrtsXeuUIfXKKOVicNxQ+o8JTbJvjS4M89yew==",
            "dev": true,
            "engines": {
                "node": "*"
            },
            "funding": {
                "type": "patreon",
                "url": "https://github.com/sponsors/rawify"
            }
        },
        "node_modules/fsevents": {
            "version": "2.3.3",
            "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
            "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
            "dev": true,
            "hasInstallScript": true,
            "optional": true,
            "os": [
                "darwin"
            ],
            "engines": {
                "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
            }
        },
        "node_modules/function-bind": {
            "version": "1.1.2",
            "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
            "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
            "dev": true,
            "funding": {
                "url": "https://github.com/sponsors/ljharb"
            }
        },
        "node_modules/gensync": {
            "version": "1.0.0-beta.2",
            "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
            "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
            "dev": true,
            "engines": {
                "node": ">=6.9.0"
            }
        },
        "node_modules/glob": {
            "version": "10.4.5",
            "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
            "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
            "dev": true,
            "dependencies": {
                "foreground-child": "^3.1.0",
                "jackspeak": "^3.1.2",
                "minimatch": "^9.0.4",
                "minipass": "^7.1.2",
                "package-json-from-dist": "^1.0.0",
                "path-scurry": "^1.11.1"
            },
            "bin": {
                "glob": "dist/esm/bin.mjs"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/glob-parent": {
            "version": "6.0.2",
            "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-6.0.2.tgz",
            "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
            "dev": true,
            "dependencies": {
                "is-glob": "^4.0.3"
            },
            "engines": {
                "node": ">=10.13.0"
            }
        },
        "node_modules/glob/node_modules/brace-expansion": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
            "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
            "dev": true,
            "dependencies": {
                "balanced-match": "^1.0.0"
            }
        },
        "node_modules/glob/node_modules/minimatch": {
            "version": "9.0.5",
            "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
            "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
            "dev": true,
            "dependencies": {
                "brace-expansion": "^2.0.1"
            },
            "engines": {
                "node": ">=16 || 14 >=14.17"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/globals": {
            "version": "15.11.0",
            "resolved": "https://registry.npmjs.org/globals/-/globals-15.11.0.tgz",
            "integrity": "sha512-yeyNSjdbyVaWurlwCpcA6XNBrHTMIeDdj0/hnvX/OLJ9ekOXYbLsLinH/MucQyGvNnXhidTdNhTtJaffL2sMfw==",
            "dev": true,
            "engines": {
                "node": ">=18"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/graphemer": {
            "version": "1.4.0",
            "resolved": "https://registry.npmjs.org/graphemer/-/graphemer-1.4.0.tgz",
            "integrity": "sha512-EtKwoO6kxCL9WO5xipiHTZlSzBm7WLT627TqC/uVRd0HKmq8NXyebnNYxDoBi7wt8eTWrUrKXCOVaFq9x1kgag==",
            "dev": true
        },
        "node_modules/has-flag": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
            "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
            "dev": true,
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/hasown": {
            "version": "2.0.2",
            "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
            "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
            "dev": true,
            "dependencies": {
                "function-bind": "^1.1.2"
            },
            "engines": {
                "node": ">= 0.4"
            }
        },
        "node_modules/ignore": {
            "version": "5.3.2",
            "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.2.tgz",
            "integrity": "sha512-hsBTNUqQTDwkWtcdYI2i06Y/nUBEsNEDJKjWdigLvegy8kDuJAS8uRlpkkcQpyEXL0Z/pjDy5HBmMjRCJ2gq+g==",
            "dev": true,
            "engines": {
                "node": ">= 4"
            }
        },
        "node_modules/import-fresh": {
            "version": "3.3.0",
            "resolved": "https://registry.npmjs.org/import-fresh/-/import-fresh-3.3.0.tgz",
            "integrity": "sha512-veYYhQa+D1QBKznvhUHxb8faxlrwUnxseDAbAp457E0wLNio2bOSKnjYDhMj+YiAq61xrMGhQk9iXVk5FzgQMw==",
            "dev": true,
            "dependencies": {
                "parent-module": "^1.0.0",
                "resolve-from": "^4.0.0"
            },
            "engines": {
                "node": ">=6"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/imurmurhash": {
            "version": "0.1.4",
            "resolved": "https://registry.npmjs.org/imurmurhash/-/imurmurhash-0.1.4.tgz",
            "integrity": "sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==",
            "dev": true,
            "engines": {
                "node": ">=0.8.19"
            }
        },
        "node_modules/is-binary-path": {
            "version": "2.1.0",
            "resolved": "https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz",
            "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
            "dev": true,
            "dependencies": {
                "binary-extensions": "^2.0.0"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/is-core-module": {
            "version": "2.15.1",
            "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.15.1.tgz",
            "integrity": "sha512-z0vtXSwucUJtANQWldhbtbt7BnL0vxiFjIdDLAatwhDYty2bad6s+rijD6Ri4YuYJubLzIJLUidCh09e1djEVQ==",
            "dev": true,
            "dependencies": {
                "hasown": "^2.0.2"
            },
            "engines": {
                "node": ">= 0.4"
            },
            "funding": {
                "url": "https://github.com/sponsors/ljharb"
            }
        },
        "node_modules/is-extglob": {
            "version": "2.1.1",
            "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
            "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/is-fullwidth-code-point": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
            "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/is-glob": {
            "version": "4.0.3",
            "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
            "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
            "dev": true,
            "dependencies": {
                "is-extglob": "^2.1.1"
            },
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/is-number": {
            "version": "7.0.0",
            "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
            "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
            "dev": true,
            "engines": {
                "node": ">=0.12.0"
            }
        },
        "node_modules/isexe": {
            "version": "2.0.0",
            "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
            "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
            "dev": true
        },
        "node_modules/jackspeak": {
            "version": "3.4.3",
            "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-3.4.3.tgz",
            "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
            "dev": true,
            "dependencies": {
                "@isaacs/cliui": "^8.0.2"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            },
            "optionalDependencies": {
                "@pkgjs/parseargs": "^0.11.0"
            }
        },
        "node_modules/jiti": {
            "version": "1.21.6",
            "resolved": "https://registry.npmjs.org/jiti/-/jiti-1.21.6.tgz",
            "integrity": "sha512-2yTgeWTWzMWkHu6Jp9NKgePDaYHbntiwvYuuJLbbN9vl7DC9DvXKOB2BC3ZZ92D3cvV/aflH0osDfwpHepQ53w==",
            "dev": true,
            "bin": {
                "jiti": "bin/jiti.js"
            }
        },
        "node_modules/js-tokens": {
            "version": "4.0.0",
            "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
            "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ=="
        },
        "node_modules/js-yaml": {
            "version": "4.1.0",
            "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.0.tgz",
            "integrity": "sha512-wpxZs9NoxZaJESJGIZTyDEaYpl0FKSA+FB9aJiyemKhMwkxQg63h4T1KJgUGHpTqPDNRcmmYLugrRjJlBtWvRA==",
            "dev": true,
            "dependencies": {
                "argparse": "^2.0.1"
            },
            "bin": {
                "js-yaml": "bin/js-yaml.js"
            }
        },
        "node_modules/jsesc": {
            "version": "3.0.2",
            "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.0.2.tgz",
            "integrity": "sha512-xKqzzWXDttJuOcawBt4KnKHHIf5oQ/Cxax+0PWFG+DFDgHNAdi+TXECADI+RYiFUMmx8792xsMbbgXj4CwnP4g==",
            "dev": true,
            "bin": {
                "jsesc": "bin/jsesc"
            },
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/json-buffer": {
            "version": "3.0.1",
            "resolved": "https://registry.npmjs.org/json-buffer/-/json-buffer-3.0.1.tgz",
            "integrity": "sha512-4bV5BfR2mqfQTJm+V5tPPdf+ZpuhiIvTuAB5g8kcrXOZpTT/QwwVRWBywX1ozr6lEuPdbHxwaJlm9G6mI2sfSQ==",
            "dev": true
        },
        "node_modules/json-schema-traverse": {
            "version": "0.4.1",
            "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
            "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
            "dev": true
        },
        "node_modules/json-stable-stringify-without-jsonify": {
            "version": "1.0.1",
            "resolved": "https://registry.npmjs.org/json-stable-stringify-without-jsonify/-/json-stable-stringify-without-jsonify-1.0.1.tgz",
            "integrity": "sha512-Bdboy+l7tA3OGW6FjyFHWkP5LuByj1Tk33Ljyq0axyzdk9//JSi2u3fP1QSmd1KNwq6VOKYGlAu87CisVir6Pw==",
            "dev": true
        },
        "node_modules/json5": {
            "version": "2.2.3",
            "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
            "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
            "dev": true,
            "bin": {
                "json5": "lib/cli.js"
            },
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/keyv": {
            "version": "4.5.4",
            "resolved": "https://registry.npmjs.org/keyv/-/keyv-4.5.4.tgz",
            "integrity": "sha512-oxVHkHR/EJf2CNXnWxRLW6mg7JyCCUcG0DtEGmL2ctUo1PNTin1PUil+r/+4r5MpVgC/fn1kjsx7mjSujKqIpw==",
            "dev": true,
            "dependencies": {
                "json-buffer": "3.0.1"
            }
        },
        "node_modules/levn": {
            "version": "0.4.1",
            "resolved": "https://registry.npmjs.org/levn/-/levn-0.4.1.tgz",
            "integrity": "sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==",
            "dev": true,
            "dependencies": {
                "prelude-ls": "^1.2.1",
                "type-check": "~0.4.0"
            },
            "engines": {
                "node": ">= 0.8.0"
            }
        },
        "node_modules/lilconfig": {
            "version": "3.1.3",
            "resolved": "https://registry.npmjs.org/lilconfig/-/lilconfig-3.1.3.tgz",
            "integrity": "sha512-/vlFKAoH5Cgt3Ie+JLhRbwOsCQePABiU3tJ1egGvyQ+33R/vcwM2Zl2QR/LzjsBeItPt3oSVXapn+m4nQDvpzw==",
            "dev": true,
            "engines": {
                "node": ">=14"
            },
            "funding": {
                "url": "https://github.com/sponsors/antonk52"
            }
        },
        "node_modules/lines-and-columns": {
            "version": "1.2.4",
            "resolved": "https://registry.npmjs.org/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
            "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
            "dev": true
        },
        "node_modules/locate-path": {
            "version": "6.0.0",
            "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-6.0.0.tgz",
            "integrity": "sha512-iPZK6eYjbxRu3uB4/WZ3EsEIMJFMqAoopl3R+zuq0UjcAm/MO6KCweDgPfP3elTztoKP3KtnVHxTn2NHBSDVUw==",
            "dev": true,
            "dependencies": {
                "p-locate": "^5.0.0"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/lodash.merge": {
            "version": "4.6.2",
            "resolved": "https://registry.npmjs.org/lodash.merge/-/lodash.merge-4.6.2.tgz",
            "integrity": "sha512-0KpjqXRVvrYyCsX1swR/XTK0va6VQkQM6MNo7PqW77ByjAhoARA8EfrP1N4+KlKj8YS0ZUCtRT/YUuhyYDujIQ==",
            "dev": true
        },
        "node_modules/loose-envify": {
            "version": "1.4.0",
            "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
            "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
            "dependencies": {
                "js-tokens": "^3.0.0 || ^4.0.0"
            },
            "bin": {
                "loose-envify": "cli.js"
            }
        },
        "node_modules/lru-cache": {
            "version": "5.1.1",
            "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
            "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
            "dev": true,
            "dependencies": {
                "yallist": "^3.0.2"
            }
        },
        "node_modules/lucide-react": {
            "version": "0.344.0",
            "resolved": "https://registry.npmjs.org/lucide-react/-/lucide-react-0.344.0.tgz",
            "integrity": "sha512-6YyBnn91GB45VuVT96bYCOKElbJzUHqp65vX8cDcu55MQL9T969v4dhGClpljamuI/+KMO9P6w9Acq1CVQGvIQ==",
            "peerDependencies": {
                "react": "^16.5.1 || ^17.0.0 || ^18.0.0"
            }
        },
        "node_modules/merge2": {
            "version": "1.4.1",
            "resolved": "https://registry.npmjs.org/merge2/-/merge2-1.4.1.tgz",
            "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
            "dev": true,
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/micromatch": {
            "version": "4.0.8",
            "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
            "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
            "dev": true,
            "dependencies": {
                "braces": "^3.0.3",
                "picomatch": "^2.3.1"
            },
            "engines": {
                "node": ">=8.6"
            }
        },
        "node_modules/minimatch": {
            "version": "3.1.2",
            "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
            "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
            "dev": true,
            "dependencies": {
                "brace-expansion": "^1.1.7"
            },
            "engines": {
                "node": "*"
            }
        },
        "node_modules/minipass": {
            "version": "7.1.2",
            "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
            "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
            "dev": true,
            "engines": {
                "node": ">=16 || 14 >=14.17"
            }
        },
        "node_modules/ms": {
            "version": "2.1.3",
            "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
            "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
            "dev": true
        },
        "node_modules/mz": {
            "version": "2.7.0",
            "resolved": "https://registry.npmjs.org/mz/-/mz-2.7.0.tgz",
            "integrity": "sha512-z81GNO7nnYMEhrGh9LeymoE4+Yr0Wn5McHIZMK5cfQCl+NDX08sCZgUc9/6MHni9IWuFLm1Z3HTCXu2z9fN62Q==",
            "dev": true,
            "dependencies": {
                "any-promise": "^1.0.0",
                "object-assign": "^4.0.1",
                "thenify-all": "^1.0.0"
            }
        },
        "node_modules/nanoid": {
            "version": "3.3.7",
            "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.7.tgz",
            "integrity": "sha512-eSRppjcPIatRIMC1U6UngP8XFcz8MQWGQdt1MTBQ7NaAmvXDfvNxbvWV3x2y6CdEUciCSsDHDQZbhYaB8QEo2g==",
            "dev": true,
            "funding": [
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "bin": {
                "nanoid": "bin/nanoid.cjs"
            },
            "engines": {
                "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
            }
        },
        "node_modules/natural-compare": {
            "version": "1.4.0",
            "resolved": "https://registry.npmjs.org/natural-compare/-/natural-compare-1.4.0.tgz",
            "integrity": "sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw==",
            "dev": true
        },
        "node_modules/node-releases": {
            "version": "2.0.18",
            "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.18.tgz",
            "integrity": "sha512-d9VeXT4SJ7ZeOqGX6R5EM022wpL+eWPooLI+5UpWn2jCT1aosUQEhQP214x33Wkwx3JQMvIm+tIoVOdodFS40g==",
            "dev": true
        },
        "node_modules/normalize-path": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
            "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/normalize-range": {
            "version": "0.1.2",
            "resolved": "https://registry.npmjs.org/normalize-range/-/normalize-range-0.1.2.tgz",
            "integrity": "sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/object-assign": {
            "version": "4.1.1",
            "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
            "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/object-hash": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/object-hash/-/object-hash-3.0.0.tgz",
            "integrity": "sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==",
            "dev": true,
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/optionator": {
            "version": "0.9.4",
            "resolved": "https://registry.npmjs.org/optionator/-/optionator-0.9.4.tgz",
            "integrity": "sha512-6IpQ7mKUxRcZNLIObR0hz7lxsapSSIYNZJwXPGeF0mTVqGKFIXj1DQcMoT22S3ROcLyY/rz0PWaWZ9ayWmad9g==",
            "dev": true,
            "dependencies": {
                "deep-is": "^0.1.3",
                "fast-levenshtein": "^2.0.6",
                "levn": "^0.4.1",
                "prelude-ls": "^1.2.1",
                "type-check": "^0.4.0",
                "word-wrap": "^1.2.5"
            },
            "engines": {
                "node": ">= 0.8.0"
            }
        },
        "node_modules/p-limit": {
            "version": "3.1.0",
            "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-3.1.0.tgz",
            "integrity": "sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==",
            "dev": true,
            "dependencies": {
                "yocto-queue": "^0.1.0"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/p-locate": {
            "version": "5.0.0",
            "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-5.0.0.tgz",
            "integrity": "sha512-LaNjtRWUBY++zB5nE/NwcaoMylSPk+S+ZHNB1TzdbMJMny6dynpAGt7X/tl/QYq3TIeE6nxHppbo2LGymrG5Pw==",
            "dev": true,
            "dependencies": {
                "p-limit": "^3.0.2"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/package-json-from-dist": {
            "version": "1.0.1",
            "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
            "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw==",
            "dev": true
        },
        "node_modules/parent-module": {
            "version": "1.0.1",
            "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
            "integrity": "sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==",
            "dev": true,
            "dependencies": {
                "callsites": "^3.0.0"
            },
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/path-exists": {
            "version": "4.0.0",
            "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-4.0.0.tgz",
            "integrity": "sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/path-key": {
            "version": "3.1.1",
            "resolved": "https://registry.npmjs.org/path-key/-/path-key-3.1.1.tgz",
            "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/path-parse": {
            "version": "1.0.7",
            "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
            "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
            "dev": true
        },
        "node_modules/path-scurry": {
            "version": "1.11.1",
            "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.11.1.tgz",
            "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
            "dev": true,
            "dependencies": {
                "lru-cache": "^10.2.0",
                "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
            },
            "engines": {
                "node": ">=16 || 14 >=14.18"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/path-scurry/node_modules/lru-cache": {
            "version": "10.4.3",
            "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
            "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
            "dev": true
        },
        "node_modules/picocolors": {
            "version": "1.1.1",
            "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
            "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
            "dev": true
        },
        "node_modules/picomatch": {
            "version": "2.3.1",
            "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
            "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
            "dev": true,
            "engines": {
                "node": ">=8.6"
            },
            "funding": {
                "url": "https://github.com/sponsors/jonschlinkert"
            }
        },
        "node_modules/pify": {
            "version": "2.3.0",
            "resolved": "https://registry.npmjs.org/pify/-/pify-2.3.0.tgz",
            "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/pirates": {
            "version": "4.0.6",
            "resolved": "https://registry.npmjs.org/pirates/-/pirates-4.0.6.tgz",
            "integrity": "sha512-saLsH7WeYYPiD25LDuLRRY/i+6HaPYr6G1OUlN39otzkSTxKnubR9RTxS3/Kk50s1g2JTgFwWQDQyplC5/SHZg==",
            "dev": true,
            "engines": {
                "node": ">= 6"
            }
        },
        "node_modules/postcss": {
            "version": "8.4.47",
            "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.47.tgz",
            "integrity": "sha512-56rxCq7G/XfB4EkXq9Egn5GCqugWvDFjafDOThIdMBsI15iqPqR5r15TfSr1YPYeEI19YeaXMCbY6u88Y76GLQ==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/postcss/"
                },
                {
                    "type": "tidelift",
                    "url": "https://tidelift.com/funding/github/npm/postcss"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "peer": true,
            "dependencies": {
                "nanoid": "^3.3.7",
                "picocolors": "^1.1.0",
                "source-map-js": "^1.2.1"
            },
            "engines": {
                "node": "^10 || ^12 || >=14"
            }
        },
        "node_modules/postcss-import": {
            "version": "15.1.0",
            "resolved": "https://registry.npmjs.org/postcss-import/-/postcss-import-15.1.0.tgz",
            "integrity": "sha512-hpr+J05B2FVYUAXHeK1YyI267J/dDDhMU6B6civm8hSY1jYJnBXxzKDKDswzJmtLHryrjhnDjqqp/49t8FALew==",
            "dev": true,
            "dependencies": {
                "postcss-value-parser": "^4.0.0",
                "read-cache": "^1.0.0",
                "resolve": "^1.1.7"
            },
            "engines": {
                "node": ">=14.0.0"
            },
            "peerDependencies": {
                "postcss": "^8.0.0"
            }
        },
        "node_modules/postcss-js": {
            "version": "4.0.1",
            "resolved": "https://registry.npmjs.org/postcss-js/-/postcss-js-4.0.1.tgz",
            "integrity": "sha512-dDLF8pEO191hJMtlHFPRa8xsizHaM82MLfNkUHdUtVEV3tgTp5oj+8qbEqYM57SLfc74KSbw//4SeJma2LRVIw==",
            "dev": true,
            "dependencies": {
                "camelcase-css": "^2.0.1"
            },
            "engines": {
                "node": "^12 || ^14 || >= 16"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/postcss/"
            },
            "peerDependencies": {
                "postcss": "^8.4.21"
            }
        },
        "node_modules/postcss-load-config": {
            "version": "4.0.2",
            "resolved": "https://registry.npmjs.org/postcss-load-config/-/postcss-load-config-4.0.2.tgz",
            "integrity": "sha512-bSVhyJGL00wMVoPUzAVAnbEoWyqRxkjv64tUl427SKnPrENtq6hJwUojroMz2VB+Q1edmi4IfrAPpami5VVgMQ==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/postcss/"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "dependencies": {
                "lilconfig": "^3.0.0",
                "yaml": "^2.3.4"
            },
            "engines": {
                "node": ">= 14"
            },
            "peerDependencies": {
                "postcss": ">=8.0.9",
                "ts-node": ">=9.0.0"
            },
            "peerDependenciesMeta": {
                "postcss": {
                    "optional": true
                },
                "ts-node": {
                    "optional": true
                }
            }
        },
        "node_modules/postcss-nested": {
            "version": "6.2.0",
            "resolved": "https://registry.npmjs.org/postcss-nested/-/postcss-nested-6.2.0.tgz",
            "integrity": "sha512-HQbt28KulC5AJzG+cZtj9kvKB93CFCdLvog1WFLf1D+xmMvPGlBstkpTEZfK5+AN9hfJocyBFCNiqyS48bpgzQ==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/postcss/"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "dependencies": {
                "postcss-selector-parser": "^6.1.1"
            },
            "engines": {
                "node": ">=12.0"
            },
            "peerDependencies": {
                "postcss": "^8.2.14"
            }
        },
        "node_modules/postcss-selector-parser": {
            "version": "6.1.2",
            "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.2.tgz",
            "integrity": "sha512-Q8qQfPiZ+THO/3ZrOrO0cJJKfpYCagtMUkXbnEfmgUjwXg6z/WBeOyS9APBBPCTSiDV+s4SwQGu8yFsiMRIudg==",
            "dev": true,
            "dependencies": {
                "cssesc": "^3.0.0",
                "util-deprecate": "^1.0.2"
            },
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/postcss-value-parser": {
            "version": "4.2.0",
            "resolved": "https://registry.npmjs.org/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
            "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
            "dev": true
        },
        "node_modules/prelude-ls": {
            "version": "1.2.1",
            "resolved": "https://registry.npmjs.org/prelude-ls/-/prelude-ls-1.2.1.tgz",
            "integrity": "sha512-vkcDPrRZo1QZLbn5RLGPpg/WmIQ65qoWWhcGKf/b5eplkkarX0m9z8ppCat4mlOqUsWpyNuYgO3VRyrYHSzX5g==",
            "dev": true,
            "engines": {
                "node": ">= 0.8.0"
            }
        },
        "node_modules/punycode": {
            "version": "2.3.1",
            "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
            "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
            "dev": true,
            "engines": {
                "node": ">=6"
            }
        },
        "node_modules/queue-microtask": {
            "version": "1.2.3",
            "resolved": "https://registry.npmjs.org/queue-microtask/-/queue-microtask-1.2.3.tgz",
            "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
            "dev": true,
            "funding": [
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/feross"
                },
                {
                    "type": "patreon",
                    "url": "https://www.patreon.com/feross"
                },
                {
                    "type": "consulting",
                    "url": "https://feross.org/support"
                }
            ]
        },
        "node_modules/react": {
            "version": "18.3.1",
            "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
            "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
            "peer": true,
            "dependencies": {
                "loose-envify": "^1.1.0"
            },
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/react-dom": {
            "version": "18.3.1",
            "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
            "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
            "dependencies": {
                "loose-envify": "^1.1.0",
                "scheduler": "^0.23.2"
            },
            "peerDependencies": {
                "react": "^18.3.1"
            }
        },
        "node_modules/react-refresh": {
            "version": "0.14.2",
            "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.14.2.tgz",
            "integrity": "sha512-jCvmsr+1IUSMUyzOkRcvnVbX3ZYC6g9TDrDbFuFmRDq7PD4yaGbLKNQL6k2jnArV8hjYxh7hVhAZB6s9HDGpZA==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/read-cache": {
            "version": "1.0.0",
            "resolved": "https://registry.npmjs.org/read-cache/-/read-cache-1.0.0.tgz",
            "integrity": "sha512-Owdv/Ft7IjOgm/i0xvNDZ1LrRANRfew4b2prF3OWMQLxLfu3bS8FVhCsrSCMK4lR56Y9ya+AThoTpDCTxCmpRA==",
            "dev": true,
            "dependencies": {
                "pify": "^2.3.0"
            }
        },
        "node_modules/readdirp": {
            "version": "3.6.0",
            "resolved": "https://registry.npmjs.org/readdirp/-/readdirp-3.6.0.tgz",
            "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
            "dev": true,
            "dependencies": {
                "picomatch": "^2.2.1"
            },
            "engines": {
                "node": ">=8.10.0"
            }
        },
        "node_modules/resolve": {
            "version": "1.22.8",
            "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.8.tgz",
            "integrity": "sha512-oKWePCxqpd6FlLvGV1VU0x7bkPmmCNolxzjMf4NczoDnQcIWrAF+cPtZn5i6n+RfD2d9i0tzpKnG6Yk168yIyw==",
            "dev": true,
            "dependencies": {
                "is-core-module": "^2.13.0",
                "path-parse": "^1.0.7",
                "supports-preserve-symlinks-flag": "^1.0.0"
            },
            "bin": {
                "resolve": "bin/resolve"
            },
            "funding": {
                "url": "https://github.com/sponsors/ljharb"
            }
        },
        "node_modules/resolve-from": {
            "version": "4.0.0",
            "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
            "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
            "dev": true,
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/reusify": {
            "version": "1.0.4",
            "resolved": "https://registry.npmjs.org/reusify/-/reusify-1.0.4.tgz",
            "integrity": "sha512-U9nH88a3fc/ekCF1l0/UP1IosiuIjyTh7hBvXVMHYgVcfGvt897Xguj2UOLDeI5BG2m7/uwyaLVT6fbtCwTyzw==",
            "dev": true,
            "engines": {
                "iojs": ">=1.0.0",
                "node": ">=0.10.0"
            }
        },
        "node_modules/rollup": {
            "version": "4.24.0",
            "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.24.0.tgz",
            "integrity": "sha512-DOmrlGSXNk1DM0ljiQA+i+o0rSLhtii1je5wgk60j49d1jHT5YYttBv1iWOnYSTG+fZZESUOSNiAl89SIet+Cg==",
            "dev": true,
            "dependencies": {
                "@types/estree": "1.0.6"
            },
            "bin": {
                "rollup": "dist/bin/rollup"
            },
            "engines": {
                "node": ">=18.0.0",
                "npm": ">=8.0.0"
            },
            "optionalDependencies": {
                "@rollup/rollup-android-arm-eabi": "4.24.0",
                "@rollup/rollup-android-arm64": "4.24.0",
                "@rollup/rollup-darwin-arm64": "4.24.0",
                "@rollup/rollup-darwin-x64": "4.24.0",
                "@rollup/rollup-linux-arm-gnueabihf": "4.24.0",
                "@rollup/rollup-linux-arm-musleabihf": "4.24.0",
                "@rollup/rollup-linux-arm64-gnu": "4.24.0",
                "@rollup/rollup-linux-arm64-musl": "4.24.0",
                "@rollup/rollup-linux-powerpc64le-gnu": "4.24.0",
                "@rollup/rollup-linux-riscv64-gnu": "4.24.0",
                "@rollup/rollup-linux-s390x-gnu": "4.24.0",
                "@rollup/rollup-linux-x64-gnu": "4.24.0",
                "@rollup/rollup-linux-x64-musl": "4.24.0",
                "@rollup/rollup-win32-arm64-msvc": "4.24.0",
                "@rollup/rollup-win32-ia32-msvc": "4.24.0",
                "@rollup/rollup-win32-x64-msvc": "4.24.0",
                "fsevents": "~2.3.2"
            }
        },
        "node_modules/run-parallel": {
            "version": "1.2.0",
            "resolved": "https://registry.npmjs.org/run-parallel/-/run-parallel-1.2.0.tgz",
            "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
            "dev": true,
            "funding": [
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/feross"
                },
                {
                    "type": "patreon",
                    "url": "https://www.patreon.com/feross"
                },
                {
                    "type": "consulting",
                    "url": "https://feross.org/support"
                }
            ],
            "dependencies": {
                "queue-microtask": "^1.2.2"
            }
        },
        "node_modules/scheduler": {
            "version": "0.23.2",
            "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
            "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
            "dependencies": {
                "loose-envify": "^1.1.0"
            }
        },
        "node_modules/semver": {
            "version": "6.3.1",
            "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
            "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
            "dev": true,
            "bin": {
                "semver": "bin/semver.js"
            }
        },
        "node_modules/shebang-command": {
            "version": "2.0.0",
            "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz",
            "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
            "dev": true,
            "dependencies": {
                "shebang-regex": "^3.0.0"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/shebang-regex": {
            "version": "3.0.0",
            "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-3.0.0.tgz",
            "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/signal-exit": {
            "version": "4.1.0",
            "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
            "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
            "dev": true,
            "engines": {
                "node": ">=14"
            },
            "funding": {
                "url": "https://github.com/sponsors/isaacs"
            }
        },
        "node_modules/source-map-js": {
            "version": "1.2.1",
            "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
            "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/string-width": {
            "version": "5.1.2",
            "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
            "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
            "dev": true,
            "dependencies": {
                "eastasianwidth": "^0.2.0",
                "emoji-regex": "^9.2.2",
                "strip-ansi": "^7.0.1"
            },
            "engines": {
                "node": ">=12"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/string-width-cjs": {
            "name": "string-width",
            "version": "4.2.3",
            "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
            "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
            "dev": true,
            "dependencies": {
                "emoji-regex": "^8.0.0",
                "is-fullwidth-code-point": "^3.0.0",
                "strip-ansi": "^6.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/string-width-cjs/node_modules/ansi-regex": {
            "version": "5.0.1",
            "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
            "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/string-width-cjs/node_modules/emoji-regex": {
            "version": "8.0.0",
            "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
            "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
            "dev": true
        },
        "node_modules/string-width-cjs/node_modules/strip-ansi": {
            "version": "6.0.1",
            "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
            "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
            "dev": true,
            "dependencies": {
                "ansi-regex": "^5.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/strip-ansi": {
            "version": "7.1.0",
            "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
            "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
            "dev": true,
            "dependencies": {
                "ansi-regex": "^6.0.1"
            },
            "engines": {
                "node": ">=12"
            },
            "funding": {
                "url": "https://github.com/chalk/strip-ansi?sponsor=1"
            }
        },
        "node_modules/strip-ansi-cjs": {
            "name": "strip-ansi",
            "version": "6.0.1",
            "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
            "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
            "dev": true,
            "dependencies": {
                "ansi-regex": "^5.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/strip-ansi-cjs/node_modules/ansi-regex": {
            "version": "5.0.1",
            "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
            "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/strip-json-comments": {
            "version": "3.1.1",
            "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-3.1.1.tgz",
            "integrity": "sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==",
            "dev": true,
            "engines": {
                "node": ">=8"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        },
        "node_modules/sucrase": {
            "version": "3.35.0",
            "resolved": "https://registry.npmjs.org/sucrase/-/sucrase-3.35.0.tgz",
            "integrity": "sha512-8EbVDiu9iN/nESwxeSxDKe0dunta1GOlHufmSSXxMD2z2/tMZpDMpvXQGsc+ajGo8y2uYUmixaSRUc/QPoQ0GA==",
            "dev": true,
            "dependencies": {
                "@jridgewell/gen-mapping": "^0.3.2",
                "commander": "^4.0.0",
                "glob": "^10.3.10",
                "lines-and-columns": "^1.1.6",
                "mz": "^2.7.0",
                "pirates": "^4.0.1",
                "ts-interface-checker": "^0.1.9"
            },
            "bin": {
                "sucrase": "bin/sucrase",
                "sucrase-node": "bin/sucrase-node"
            },
            "engines": {
                "node": ">=16 || 14 >=14.17"
            }
        },
        "node_modules/supports-color": {
            "version": "5.5.0",
            "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
            "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
            "dev": true,
            "dependencies": {
                "has-flag": "^3.0.0"
            },
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/supports-preserve-symlinks-flag": {
            "version": "1.0.0",
            "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
            "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
            "dev": true,
            "engines": {
                "node": ">= 0.4"
            },
            "funding": {
                "url": "https://github.com/sponsors/ljharb"
            }
        },
        "node_modules/tailwindcss": {
            "version": "3.4.17",
            "resolved": "https://registry.npmjs.org/tailwindcss/-/tailwindcss-3.4.17.tgz",
            "integrity": "sha512-w33E2aCvSDP0tW9RZuNXadXlkHXqFzSkQew/aIa2i/Sj8fThxwovwlXHSPXTbAHwEIhBFXAedUhP2tueAKP8Og==",
            "dev": true,
            "dependencies": {
                "@alloc/quick-lru": "^5.2.0",
                "arg": "^5.0.2",
                "chokidar": "^3.6.0",
                "didyoumean": "^1.2.2",
                "dlv": "^1.1.3",
                "fast-glob": "^3.3.2",
                "glob-parent": "^6.0.2",
                "is-glob": "^4.0.3",
                "jiti": "^1.21.6",
                "lilconfig": "^3.1.3",
                "micromatch": "^4.0.8",
                "normalize-path": "^3.0.0",
                "object-hash": "^3.0.0",
                "picocolors": "^1.1.1",
                "postcss": "^8.4.47",
                "postcss-import": "^15.1.0",
                "postcss-js": "^4.0.1",
                "postcss-load-config": "^4.0.2",
                "postcss-nested": "^6.2.0",
                "postcss-selector-parser": "^6.1.2",
                "resolve": "^1.22.8",
                "sucrase": "^3.35.0"
            },
            "bin": {
                "tailwind": "lib/cli.js",
                "tailwindcss": "lib/cli.js"
            },
            "engines": {
                "node": ">=14.0.0"
            }
        },
        "node_modules/text-table": {
            "version": "0.2.0",
            "resolved": "https://registry.npmjs.org/text-table/-/text-table-0.2.0.tgz",
            "integrity": "sha512-N+8UisAXDGk8PFXP4HAzVR9nbfmVJ3zYLAWiTIoqC5v5isinhr+r5uaO8+7r3BMfuNIufIsA7RdpVgacC2cSpw==",
            "dev": true
        },
        "node_modules/thenify": {
            "version": "3.3.1",
            "resolved": "https://registry.npmjs.org/thenify/-/thenify-3.3.1.tgz",
            "integrity": "sha512-RVZSIV5IG10Hk3enotrhvz0T9em6cyHBLkH/YAZuKqd8hRkKhSfCGIcP2KUY0EPxndzANBmNllzWPwak+bheSw==",
            "dev": true,
            "dependencies": {
                "any-promise": "^1.0.0"
            }
        },
        "node_modules/thenify-all": {
            "version": "1.6.0",
            "resolved": "https://registry.npmjs.org/thenify-all/-/thenify-all-1.6.0.tgz",
            "integrity": "sha512-RNxQH/qI8/t3thXJDwcstUO4zeqo64+Uy/+sNVRBx4Xn2OX+OZ9oP+iJnNFqplFra2ZUVeKCSa2oVWi3T4uVmA==",
            "dev": true,
            "dependencies": {
                "thenify": ">= 3.1.0 < 4"
            },
            "engines": {
                "node": ">=0.8"
            }
        },
        "node_modules/to-fast-properties": {
            "version": "2.0.0",
            "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
            "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
            "dev": true,
            "engines": {
                "node": ">=4"
            }
        },
        "node_modules/to-regex-range": {
            "version": "5.0.1",
            "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
            "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
            "dev": true,
            "dependencies": {
                "is-number": "^7.0.0"
            },
            "engines": {
                "node": ">=8.0"
            }
        },
        "node_modules/ts-api-utils": {
            "version": "1.3.0",
            "resolved": "https://registry.npmjs.org/ts-api-utils/-/ts-api-utils-1.3.0.tgz",
            "integrity": "sha512-UQMIo7pb8WRomKR1/+MFVLTroIvDVtMX3K6OUir8ynLyzB8Jeriont2bTAtmNPa1ekAgN7YPDyf6V+ygrdU+eQ==",
            "dev": true,
            "engines": {
                "node": ">=16"
            },
            "peerDependencies": {
                "typescript": ">=4.2.0"
            }
        },
        "node_modules/ts-interface-checker": {
            "version": "0.1.13",
            "resolved": "https://registry.npmjs.org/ts-interface-checker/-/ts-interface-checker-0.1.13.tgz",
            "integrity": "sha512-Y/arvbn+rrz3JCKl9C4kVNfTfSm2/mEp5FSz5EsZSANGPSlQrpRI5M4PKF+mJnE52jOO90PnPSc3Ur3bTQw0gA==",
            "dev": true
        },
        "node_modules/type-check": {
            "version": "0.4.0",
            "resolved": "https://registry.npmjs.org/type-check/-/type-check-0.4.0.tgz",
            "integrity": "sha512-XleUoc9uwGXqjWwXaUTZAmzMcFZ5858QA2vvx1Ur5xIcixXIP+8LnFDgRplU30us6teqdlskFfu+ae4K79Ooew==",
            "dev": true,
            "dependencies": {
                "prelude-ls": "^1.2.1"
            },
            "engines": {
                "node": ">= 0.8.0"
            }
        },
        "node_modules/typescript": {
            "version": "5.6.3",
            "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.6.3.tgz",
            "integrity": "sha512-hjcS1mhfuyi4WW8IWtjP7brDrG2cuDZukyrYrSauoXGNgx0S7zceP07adYkJycEr56BOUTNPzbInooiN3fn1qw==",
            "dev": true,
            "peer": true,
            "bin": {
                "tsc": "bin/tsc",
                "tsserver": "bin/tsserver"
            },
            "engines": {
                "node": ">=14.17"
            }
        },
        "node_modules/typescript-eslint": {
            "version": "8.8.1",
            "resolved": "https://registry.npmjs.org/typescript-eslint/-/typescript-eslint-8.8.1.tgz",
            "integrity": "sha512-R0dsXFt6t4SAFjUSKFjMh4pXDtq04SsFKCVGDP3ZOzNP7itF0jBcZYU4fMsZr4y7O7V7Nc751dDeESbe4PbQMQ==",
            "dev": true,
            "dependencies": {
                "@typescript-eslint/eslint-plugin": "8.8.1",
                "@typescript-eslint/parser": "8.8.1",
                "@typescript-eslint/utils": "8.8.1"
            },
            "engines": {
                "node": "^18.18.0 || ^20.9.0 || >=21.1.0"
            },
            "funding": {
                "type": "opencollective",
                "url": "https://opencollective.com/typescript-eslint"
            },
            "peerDependenciesMeta": {
                "typescript": {
                    "optional": true
                }
            }
        },
        "node_modules/undici-types": {
            "version": "7.10.0",
            "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-7.10.0.tgz",
            "integrity": "sha512-t5Fy/nfn+14LuOc2KNYg75vZqClpAiqscVvMygNnlsHBFpSXdJaYtXMcdNLpl/Qvc3P2cB3s6lOV51nqsFq4ag==",
            "dev": true,
            "optional": true
        },
        "node_modules/update-browserslist-db": {
            "version": "1.1.1",
            "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.1.tgz",
            "integrity": "sha512-R8UzCaa9Az+38REPiJ1tXlImTJXlVfgHZsglwBD/k6nj76ctsH1E3q4doGrukiLQd3sGQYu56r5+lo5r94l29A==",
            "dev": true,
            "funding": [
                {
                    "type": "opencollective",
                    "url": "https://opencollective.com/browserslist"
                },
                {
                    "type": "tidelift",
                    "url": "https://tidelift.com/funding/github/npm/browserslist"
                },
                {
                    "type": "github",
                    "url": "https://github.com/sponsors/ai"
                }
            ],
            "dependencies": {
                "escalade": "^3.2.0",
                "picocolors": "^1.1.0"
            },
            "bin": {
                "update-browserslist-db": "cli.js"
            },
            "peerDependencies": {
                "browserslist": ">= 4.21.0"
            }
        },
        "node_modules/uri-js": {
            "version": "4.4.1",
            "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
            "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
            "dev": true,
            "dependencies": {
                "punycode": "^2.1.0"
            }
        },
        "node_modules/util-deprecate": {
            "version": "1.0.2",
            "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
            "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
            "dev": true
        },
        "node_modules/vite": {
            "version": "5.4.8",
            "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.8.tgz",
            "integrity": "sha512-FqrItQ4DT1NC4zCUqMB4c4AZORMKIa0m8/URVCZ77OZ/QSNeJ54bU1vrFADbDsuwfIPcgknRkmqakQcgnL4GiQ==",
            "dev": true,
            "peer": true,
            "dependencies": {
                "esbuild": "^0.21.3",
                "postcss": "^8.4.43",
                "rollup": "^4.20.0"
            },
            "bin": {
                "vite": "bin/vite.js"
            },
            "engines": {
                "node": "^18.0.0 || >=20.0.0"
            },
            "funding": {
                "url": "https://github.com/vitejs/vite?sponsor=1"
            },
            "optionalDependencies": {
                "fsevents": "~2.3.3"
            },
            "peerDependencies": {
                "@types/node": "^18.0.0 || >=20.0.0",
                "less": "*",
                "lightningcss": "^1.21.0",
                "sass": "*",
                "sass-embedded": "*",
                "stylus": "*",
                "sugarss": "*",
                "terser": "^5.4.0"
            },
            "peerDependenciesMeta": {
                "@types/node": {
                    "optional": true
                },
                "less": {
                    "optional": true
                },
                "lightningcss": {
                    "optional": true
                },
                "sass": {
                    "optional": true
                },
                "sass-embedded": {
                    "optional": true
                },
                "stylus": {
                    "optional": true
                },
                "sugarss": {
                    "optional": true
                },
                "terser": {
                    "optional": true
                }
            }
        },
        "node_modules/which": {
            "version": "2.0.2",
            "resolved": "https://registry.npmjs.org/which/-/which-2.0.2.tgz",
            "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
            "dev": true,
            "dependencies": {
                "isexe": "^2.0.0"
            },
            "bin": {
                "node-which": "bin/node-which"
            },
            "engines": {
                "node": ">= 8"
            }
        },
        "node_modules/word-wrap": {
            "version": "1.2.5",
            "resolved": "https://registry.npmjs.org/word-wrap/-/word-wrap-1.2.5.tgz",
            "integrity": "sha512-BN22B5eaMMI9UMtjrGd5g5eCYPpCPDUy0FJXbYsaT5zYxjFOckS53SQDE3pWkVoWpHXVb3BrYcEN4Twa55B5cA==",
            "dev": true,
            "engines": {
                "node": ">=0.10.0"
            }
        },
        "node_modules/wrap-ansi": {
            "version": "8.1.0",
            "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
            "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
            "dev": true,
            "dependencies": {
                "ansi-styles": "^6.1.0",
                "string-width": "^5.0.1",
                "strip-ansi": "^7.0.1"
            },
            "engines": {
                "node": ">=12"
            },
            "funding": {
                "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
            }
        },
        "node_modules/wrap-ansi-cjs": {
            "name": "wrap-ansi",
            "version": "7.0.0",
            "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
            "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
            "dev": true,
            "dependencies": {
                "ansi-styles": "^4.0.0",
                "string-width": "^4.1.0",
                "strip-ansi": "^6.0.0"
            },
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
            }
        },
        "node_modules/wrap-ansi-cjs/node_modules/ansi-regex": {
            "version": "5.0.1",
            "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
            "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
            "dev": true,
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/wrap-ansi-cjs/node_modules/ansi-styles": {
            "version": "4.3.0",
            "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
            "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
            "dev": true,
            "dependencies": {
                "color-convert": "^2.0.1"
            },
            "engines": {
                "node": ">=8"
            },
            "funding": {
                "url": "https://github.com/chalk/ansi-styles?sponsor=1"
            }
        },
        "node_modules/wrap-ansi-cjs/node_modules/color-convert": {
            "version": "2.0.1",
            "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
            "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
            "dev": true,
            "dependencies": {
                "color-name": "~1.1.4"
            },
            "engines": {
                "node": ">=7.0.0"
            }
        },
        "node_modules/wrap-ansi-cjs/node_modules/color-name": {
            "version": "1.1.4",
            "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
            "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
            "dev": true
        },
        "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
            "version": "8.0.0",
            "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
            "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
            "dev": true
        },
        "node_modules/wrap-ansi-cjs/node_modules/string-width": {
            "version": "4.2.3",
            "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
            "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
            "dev": true,
            "dependencies": {
                "emoji-regex": "^8.0.0",
                "is-fullwidth-code-point": "^3.0.0",
                "strip-ansi": "^6.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/wrap-ansi-cjs/node_modules/strip-ansi": {
            "version": "6.0.1",
            "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
            "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
            "dev": true,
            "dependencies": {
                "ansi-regex": "^5.0.1"
            },
            "engines": {
                "node": ">=8"
            }
        },
        "node_modules/wrap-ansi/node_modules/ansi-styles": {
            "version": "6.2.1",
            "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
            "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
            "dev": true,
            "engines": {
                "node": ">=12"
            },
            "funding": {
                "url": "https://github.com/chalk/ansi-styles?sponsor=1"
            }
        },
        "node_modules/yallist": {
            "version": "3.1.1",
            "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
            "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
            "dev": true
        },
        "node_modules/yaml": {
            "version": "2.5.1",
            "resolved": "https://registry.npmjs.org/yaml/-/yaml-2.5.1.tgz",
            "integrity": "sha512-bLQOjaX/ADgQ20isPJRvF0iRUHIxVhYvr53Of7wGcWlO2jvtUlH5m87DsmulFVxRpNLOnI4tB6p/oh8D7kpn9Q==",
            "dev": true,
            "bin": {
                "yaml": "bin.mjs"
            },
            "engines": {
                "node": ">= 14"
            }
        },
        "node_modules/yocto-queue": {
            "version": "0.1.0",
            "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-0.1.0.tgz",
            "integrity": "sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==",
            "dev": true,
            "engines": {
                "node": ">=10"
            },
            "funding": {
                "url": "https://github.com/sponsors/sindresorhus"
            }
        }
    }
}



======================================================================

------------------------------ FILE: Systems/web/package.json ------------------------------
{
    "name": "vite-react-typescript-starter",
    "private": true,
    "version": "0.0.0",
    "type": "module",
    "scripts": {
      "dev": "vite",
      "build": "vite build",
      "lint": "eslint .",
      "preview": "vite preview",
      "typecheck": "tsc --noEmit -p tsconfig.app.json"
    },
    "dependencies": {
      "lucide-react": "^0.344.0",
      "react": "^18.3.1",
      "react-dom": "^18.3.1"
    },
    "devDependencies": {
      "@eslint/js": "^9.9.1",
      "@types/react": "^18.3.5",
      "@types/react-dom": "^18.3.0",
      "@vitejs/plugin-react": "^4.3.1",
      "autoprefixer": "^10.4.18",
      "eslint": "^9.9.1",
      "eslint-plugin-react-hooks": "^5.1.0-rc.0",
      "eslint-plugin-react-refresh": "^0.4.11",
      "globals": "^15.9.0",
      "postcss": "^8.4.35",
      "tailwindcss": "^3.4.1",
      "typescript": "^5.5.3",
      "typescript-eslint": "^8.3.0",
      "vite": "^5.4.2"
    }
  }
  


======================================================================

------------------------------ FILE: Systems/web/app.py ------------------------------
"""
FastAPI application for SwiftDevBot web dashboard.
Serves React frontend and provides API endpoints.
"""

import os
import hashlib
from pathlib import Path
from typing import Optional, Dict

from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import HTMLResponse, FileResponse, Response
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware


def create_app(sdb_services=None, debug: bool = False) -> FastAPI:
    """
    Create and configure FastAPI application for SwiftDevBot web dashboard.
    
    Args:
        sdb_services: BotServicesProvider instance (optional)
        debug: Enable debug mode
        
    Returns:
        Configured FastAPI application
    """
    # Get web directory path
    web_dir = Path(__file__).parent
    dist_dir = web_dir / "dist"
    
    # Create FastAPI app
    app = FastAPI(
        title="SwiftDevBot Dashboard",
        description="Futuristic Liquid Glass Dashboard for SwiftDevBot",
        version="0.2.0",
        debug=debug,
        docs_url="/api/docs",
        redoc_url="/api/redoc",
        openapi_url="/api/openapi.json",
    )
    
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"] if debug else [],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # Mount static files (Vite build output)
    if dist_dir.exists():
        app.mount("/assets", StaticFiles(directory=str(dist_dir / "assets")), name="assets")
        
        # Serve index.html for root
        @app.get("/", response_class=HTMLResponse)
        async def read_root():
            """Serve the main dashboard page."""
            index_path = dist_dir / "index.html"
            if index_path.exists():
                return FileResponse(str(index_path))
            return HTMLResponse("<h1>SwiftDevBot Dashboard</h1><p>Please build the frontend: npm run build</p>")
    
    # API routes
    @app.get("/api/health")
    async def health_check():
        """Health check endpoint."""
        if sdb_services:
            from Systems.core.monitoring.health import HealthChecker
            health_checker = HealthChecker(sdb_services)
            return await health_checker.get_health_summary()
        return {
            "status": "healthy",
            "service": "SwiftDevBot Dashboard",
            "version": "0.2.0"
        }
    
    @app.get("/api/health/detailed")
    async def health_check_detailed():
        """Detailed health check endpoint."""
        if sdb_services:
            from Systems.core.monitoring.health import HealthChecker
            health_checker = HealthChecker(sdb_services)
            return await health_checker.check_all()
        return {
            "status": "healthy",
            "service": "SwiftDevBot Dashboard",
            "version": "0.2.0",
            "checks": {}
        }
    
    @app.get("/metrics")
    async def metrics():
        """Prometheus metrics endpoint."""
        if sdb_services:
            from Systems.core.monitoring.metrics import get_metrics_collector
            metrics_collector = get_metrics_collector()
            return Response(
                content=metrics_collector.get_prometheus_format(),
                media_type="text/plain"
            )
        return Response(content="# No metrics available\n", media_type="text/plain")
    
    @app.get("/api/stats")
    async def get_stats():
        """Get bot statistics."""
        # This would normally fetch from sdb_services
        # For now, return mock data
        return {
            "uptime": "2d 5h 30m",
            "messages_today": 1234,
            "total_users": 567,
            "active_modules": 8,
            "total_modules": 12
        }
    
    @app.get("/api/modules")
    async def get_modules():
        """Get modules list."""
        # This would normally fetch from sdb_services
        # For now, return mock data
        return [
            {
                "name": "sys_status",
                "status": "active",
                "description": "–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å —Å—Ç–∞—Ç—É—Å–∞"
            },
            {
                "name": "universal_template",
                "status": "active",
                "description": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –º–æ–¥—É–ª—è"
            },
            {
                "name": "example_module",
                "status": "inactive",
                "description": "–ü—Ä–∏–º–µ—Ä –º–æ–¥—É–ª—è"
            }
        ]
    
    @app.get("/api/users")
    async def get_users():
        """Get users list."""
        # This would normally fetch from sdb_services
        # For now, return mock data
        return [
            {
                "id": 1,
                "username": "user1",
                "role": "user",
                "avatar": "U"
            },
            {
                "id": 2,
                "username": "admin",
                "role": "admin",
                "avatar": "A"
            },
            {
                "id": 3,
                "username": "user2",
                "role": "user",
                "avatar": "U"
            }
        ]
    
    @app.get("/api/logs")
    async def get_logs(limit: int = 100, level: Optional[str] = None):
        """Get logs."""
        # This would normally fetch from sdb_services
        # For now, return mock data
        logs = [
            {
                "level": "info",
                "message": "Bot started successfully",
                "timestamp": "2025-11-04T10:00:00Z"
            },
            {
                "level": "info",
                "message": "Module sys_status loaded",
                "timestamp": "2025-11-04T10:00:01Z"
            },
            {
                "level": "warning",
                "message": "High memory usage detected",
                "timestamp": "2025-11-04T10:00:02Z"
            },
            {
                "level": "info",
                "message": "User connected",
                "timestamp": "2025-11-04T10:00:03Z"
            }
        ]
        
        if level and level != "all":
            logs = [log for log in logs if log["level"] == level]
        
        return logs[:limit]
    
    # Authentication routes
    @app.post("/api/auth/login")
    async def login(request: Request):
        """Login endpoint - supports both username/password and token-based auth."""
        try:
            data = await request.json()
            
            # Token-based authentication (from Telegram bot)
            token = data.get("token")
            if token:
                try:
                    from Systems.web.auth.jwt_handler import get_jwt_handler
                    jwt_handler = get_jwt_handler()
                    payload = await jwt_handler.verify_token(token)
                    
                    if payload:
                        user_info = jwt_handler.get_user_info(payload)
                        # –†–æ–ª—å —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ lowercase –≤ jwt_handler
                        role = user_info["role"].lower() if user_info.get("role") else "user"
                        return {
                            "user": {
                                "username": user_info["username"],
                                "role": role
                            },
                            "token": token
                        }
                    else:
                        raise HTTPException(status_code=401, detail="Invalid or expired token")
                except Exception as e:
                    raise HTTPException(status_code=401, detail=f"Token verification failed: {str(e)}")
            
            # Username/password authentication removed - only token-based auth is supported
            raise HTTPException(status_code=400, detail="Username/password authentication is disabled. Please use token-based authentication via Telegram bot.")
        except HTTPException:
            raise
        except Exception as e:
            raise HTTPException(status_code=400, detail=str(e))
    
    @app.get("/api/auth/verify")
    async def verify_token(token: Optional[str] = None):
        """Verify JWT token from query parameter."""
        if not token:
            raise HTTPException(status_code=400, detail="Token parameter is required")
        
        try:
            from Systems.web.auth.jwt_handler import get_jwt_handler
            jwt_handler = get_jwt_handler()
            payload = await jwt_handler.verify_token(token)
            
            if payload:
                user_info = jwt_handler.get_user_info(payload)
                return {
                    "valid": True,
                    "user": {
                        "username": user_info["username"],
                        "role": user_info["role"]
                    }
                }
            else:
                return {"valid": False, "error": "Invalid or expired token"}
        except Exception as e:
            return {"valid": False, "error": str(e)}
    
    @app.post("/api/auth/logout")
    async def logout():
        """Logout endpoint."""
        return {"success": True}
    
    # Cloud password endpoints
    @app.get("/api/auth/cloud-password/check")
    async def check_cloud_password_setup(request: Request):
        """Check if cloud password is setup for current user."""
        # Get user from token
        auth_header = request.headers.get("Authorization", "")
        if not auth_header:
            return {"isSetup": False}
        token = auth_header.replace("Bearer ", "")
        if not token:
            return {"isSetup": False}
        
        try:
            from Systems.web.auth.jwt_handler import get_jwt_handler
            jwt_handler = get_jwt_handler()
            payload = await jwt_handler.verify_token(token)
            
            if payload:
                user_info = jwt_handler.get_user_info(payload)
                user_id = user_info.get("user_id")
                
                # Check if cloud password exists (in real app, check database)
                # For demo, use localStorage-like approach
                cloud_password_file = Path(__file__).parent.parent.parent / "config" / f"cloud_password_{user_id}.txt"
                return {"isSetup": cloud_password_file.exists()}
        except Exception:
            pass
        
        return {"isSetup": False}
    
    @app.post("/api/auth/cloud-password/setup")
    async def setup_cloud_password(request: Request):
        """Setup cloud password for current user."""
        try:
            data = await request.json()
            password = data.get("password")
            
            if not password or len(password) < 8:
                raise HTTPException(status_code=400, detail="Password must be at least 8 characters")
            
            # Get user from token
            auth_header = request.headers.get("Authorization", "")
            if not auth_header:
                raise HTTPException(status_code=401, detail="Token required")
            token = auth_header.replace("Bearer ", "")
            if not token:
                raise HTTPException(status_code=401, detail="Token required")
            
            from Systems.web.auth.jwt_handler import get_jwt_handler
            jwt_handler = get_jwt_handler()
            payload = await jwt_handler.verify_token(token)
            
            if not payload:
                raise HTTPException(status_code=401, detail="Invalid token")
            
            user_info = jwt_handler.get_user_info(payload)
            user_id = user_info.get("user_id")
            
            # Hash password (in real app, use proper hashing like bcrypt)
            password_hash = hashlib.sha256(password.encode()).hexdigest()
            
            # Save cloud password (in real app, save to database)
            config_dir = Path(__file__).parent.parent.parent / "config"
            config_dir.mkdir(parents=True, exist_ok=True)
            cloud_password_file = config_dir / f"cloud_password_{user_id}.txt"
            
            with open(cloud_password_file, 'w') as f:
                f.write(password_hash)
            
            # Set secure permissions
            os.chmod(cloud_password_file, 0o600)
            
            return {"success": True}
        except HTTPException:
            raise
        except Exception as e:
            raise HTTPException(status_code=400, detail=str(e))
    
    @app.post("/api/auth/cloud-password/verify")
    async def verify_cloud_password(request: Request):
        """Verify cloud password for current user."""
        try:
            data = await request.json()
            password = data.get("password")
            
            if not password:
                raise HTTPException(status_code=400, detail="Password required")
            
            # Get user from token
            auth_header = request.headers.get("Authorization", "")
            if not auth_header:
                raise HTTPException(status_code=401, detail="Token required")
            token = auth_header.replace("Bearer ", "")
            if not token:
                raise HTTPException(status_code=401, detail="Token required")
            
            from Systems.web.auth.jwt_handler import get_jwt_handler
            jwt_handler = get_jwt_handler()
            payload = await jwt_handler.verify_token(token)
            
            if not payload:
                raise HTTPException(status_code=401, detail="Invalid token")
            
            user_info = jwt_handler.get_user_info(payload)
            user_id = user_info.get("user_id")
            
            # Load cloud password hash
            cloud_password_file = Path(__file__).parent.parent.parent / "config" / f"cloud_password_{user_id}.txt"
            
            if not cloud_password_file.exists():
                raise HTTPException(status_code=404, detail="Cloud password not setup")
            
            with open(cloud_password_file, 'r') as f:
                saved_hash = f.read().strip()
            
            # Verify password
            password_hash = hashlib.sha256(password.encode()).hexdigest()
            
            if password_hash != saved_hash:
                raise HTTPException(status_code=401, detail="Invalid password")
            
            return {"success": True}
        except HTTPException:
            raise
        except Exception as e:
            raise HTTPException(status_code=400, detail=str(e))
    
    # Catch-all route for SPA - must be last
    @app.get("/{path:path}", response_class=HTMLResponse)
    async def catch_all(path: str):
        """Catch-all route for SPA routing."""
        # Don't catch API routes or static files
        if path.startswith("api/") or path.startswith("assets/"):
            raise HTTPException(status_code=404, detail="Not found")
        
        # Serve index.html for all other routes
        if dist_dir.exists():
            index_path = dist_dir / "index.html"
            if index_path.exists():
                return FileResponse(str(index_path))
        
        return HTMLResponse("<h1>SwiftDevBot Dashboard</h1><p>Please build the frontend: npm run build</p>")
    
    return app



======================================================================

------------------------------ FILE: Systems/web/tsconfig.json ------------------------------
{
    "files": [],
    "references": [
      { "path": "./tsconfig.app.json" },
      { "path": "./tsconfig.node.json" }
    ]
  }
  


======================================================================

------------------------------ FILE: Systems/web/eslint.config.js ------------------------------
import js from '@eslint/js';
import globals from 'globals';
import reactHooks from 'eslint-plugin-react-hooks';
import reactRefresh from 'eslint-plugin-react-refresh';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  }
);



======================================================================

------------------------------ FILE: Systems/web/vite.config.ts ------------------------------
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  optimizeDeps: {
    exclude: ['lucide-react'],
  },
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
    },
  },
});



======================================================================

------------------------------ FILE: Systems/web/postcss.config.js ------------------------------
export default {
    plugins: {
      tailwindcss: {},
      autoprefixer: {},
    },
  };
  


======================================================================

------------------------------ FILE: Systems/web/auth/jwt_handler.py ------------------------------
"""
JWT Token Handler for SwiftDevBot Web Dashboard
Handles creation and validation of JWT tokens for web authentication.
"""

import os
import secrets
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
from pathlib import Path

try:
    import jwt
    from jwt import PyJWTError
except ImportError:
    jwt = None
    PyJWTError = Exception


class JWTHandler:
    """JWT token handler for web authentication."""
    
    def __init__(self, secret_key: Optional[str] = None):
        """
        Initialize JWT handler.
        
        Args:
            secret_key: Secret key for JWT signing. If None, will be generated/loaded.
        """
        self.secret_key = secret_key or self._get_or_create_secret_key()
        self.algorithm = "HS256"
    
    def _get_or_create_secret_key(self) -> str:
        """
        Get or create JWT secret key.
        
        Returns:
            Secret key string
        """
        # Try to get from environment
        env_key = os.environ.get("SDB_JWT_SECRET_KEY")
        if env_key:
            return env_key
        
        # Try to load from config file
        config_path = Path(__file__).parent.parent.parent.parent / "config" / "security_keys.json"
        if config_path.exists():
            try:
                import json
                with open(config_path, 'r') as f:
                    config = json.load(f)
                    if 'jwt_secret' in config:
                        return config['jwt_secret']
            except Exception:
                pass
        
        # Generate new key (for development only - should be set in production)
        new_key = secrets.token_urlsafe(32)
        
        # Try to save to config file
        try:
            config_path.parent.mkdir(parents=True, exist_ok=True)
            import json
            config = {'jwt_secret': new_key}
            with open(config_path, 'w') as f:
                json.dump(config, f, indent=2)
        except Exception:
            pass
        
        return new_key
    
    async def create_access_token(
        self,
        user_id: int,
        username: str,
        role: str = "User",
        expires_in: timedelta = timedelta(minutes=5)
    ) -> str:
        """
        Create JWT access token.
        
        Args:
            user_id: Telegram user ID
            username: Username
            role: User role (Admin, Moderator, User)
            expires_in: Token expiration time
            
        Returns:
            JWT token string
        """
        if jwt is None:
            raise ImportError("PyJWT is required. Install it with: pip install PyJWT")
        
        now = datetime.utcnow()
        expire = now + expires_in
        
        payload: Dict[str, Any] = {
            "user_id": user_id,
            "username": username,
            "role": role.lower(),  # Normalize role to lowercase
            "iat": now,
            "exp": expire,
        }
        
        token = jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
        return token
    
    async def verify_token(self, token: str) -> Optional[Dict[str, Any]]:
        """
        Verify JWT token and return payload.
        
        Args:
            token: JWT token string
            
        Returns:
            Token payload if valid, None otherwise
        """
        if jwt is None:
            raise ImportError("PyJWT is required. Install it with: pip install PyJWT")
        
        try:
            payload = jwt.decode(
                token,
                self.secret_key,
                algorithms=[self.algorithm]
            )
            return payload
        except PyJWTError:
            return None
    
    def get_user_info(self, payload: Dict[str, Any]) -> Dict[str, Any]:
        """
        Extract user info from token payload.
        
        Args:
            payload: JWT token payload
            
        Returns:
            User info dictionary
        """
        return {
            "user_id": payload.get("user_id"),
            "username": payload.get("username"),
            "role": payload.get("role", "user"),
        }


# Singleton instance
_jwt_handler: Optional[JWTHandler] = None


def get_jwt_handler() -> JWTHandler:
    """
    Get or create JWT handler instance.
    
    Returns:
        JWTHandler instance
    """
    global _jwt_handler
    if _jwt_handler is None:
        _jwt_handler = JWTHandler()
    return _jwt_handler



======================================================================

------------------------------ FILE: Systems/web/auth/__init__.py ------------------------------
"""Authentication module for SwiftDevBot web dashboard."""



======================================================================

------------------------------ FILE: Systems/web/supabasex/migrations/20251104203347_create_swiftdevbot_schema.sql ------------------------------
/*
  # SwiftDevBot Database Schema

  ## Overview
  Complete database schema for SwiftDevBot admin dashboard with authentication,
  user management, module tracking, logs, and statistics.

  ## New Tables
  
  ### 1. `profiles`
  - `id` (uuid, FK to auth.users) - User profile ID
  - `email` (text) - User email
  - `full_name` (text) - User's full name
  - `role` (text) - User role: 'user' or 'admin'
  - `avatar_url` (text) - Profile avatar URL
  - `created_at` (timestamptz) - Account creation timestamp
  - `updated_at` (timestamptz) - Last update timestamp

  ### 2. `bot_modules`
  - `id` (uuid, PK) - Module ID
  - `name` (text) - Module name
  - `description` (text) - Module description
  - `status` (text) - Module status: 'active' or 'inactive'
  - `icon` (text) - Lucide icon name
  - `color` (text) - Theme color for UI
  - `config` (jsonb) - Module configuration
  - `created_at` (timestamptz) - Creation timestamp
  - `updated_at` (timestamptz) - Last update timestamp

  ### 3. `bot_logs`
  - `id` (uuid, PK) - Log entry ID
  - `level` (text) - Log level: 'info', 'warning', 'error', 'success'
  - `message` (text) - Log message
  - `module` (text) - Related module name
  - `metadata` (jsonb) - Additional log data
  - `created_at` (timestamptz) - Log timestamp

  ### 4. `bot_statistics`
  - `id` (uuid, PK) - Statistics ID
  - `metric_name` (text) - Metric name
  - `value` (numeric) - Metric value
  - `timestamp` (timestamptz) - Measurement timestamp
  - `metadata` (jsonb) - Additional metric data

  ### 5. `bot_users`
  - `id` (uuid, PK) - Bot user ID
  - `telegram_id` (bigint) - Telegram user ID
  - `username` (text) - Telegram username
  - `full_name` (text) - User's full name
  - `is_blocked` (boolean) - Block status
  - `interaction_count` (int) - Total interactions
  - `last_active` (timestamptz) - Last activity timestamp
  - `created_at` (timestamptz) - Registration timestamp

  ## Security
  - RLS enabled on all tables
  - Policies for authenticated users based on roles
  - Admin-only access for sensitive operations
*/

-- Create profiles table
CREATE TABLE IF NOT EXISTS profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text UNIQUE NOT NULL,
  full_name text NOT NULL,
  role text NOT NULL DEFAULT 'user' CHECK (role IN ('user', 'admin')),
  avatar_url text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  TO authenticated
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);

-- Create bot_modules table
CREATE TABLE IF NOT EXISTS bot_modules (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text UNIQUE NOT NULL,
  description text NOT NULL,
  status text NOT NULL DEFAULT 'inactive' CHECK (status IN ('active', 'inactive')),
  icon text NOT NULL DEFAULT 'Box',
  color text NOT NULL DEFAULT '#3B82F6',
  config jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE bot_modules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view modules"
  ON bot_modules FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Only admins can modify modules"
  ON bot_modules FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Create bot_logs table
CREATE TABLE IF NOT EXISTS bot_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  level text NOT NULL CHECK (level IN ('info', 'warning', 'error', 'success')),
  message text NOT NULL,
  module text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE bot_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view logs"
  ON bot_logs FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Only admins can insert logs"
  ON bot_logs FOR INSERT
  TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Create bot_statistics table
CREATE TABLE IF NOT EXISTS bot_statistics (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  metric_name text NOT NULL,
  value numeric NOT NULL,
  timestamp timestamptz DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb
);

CREATE INDEX IF NOT EXISTS idx_bot_statistics_metric ON bot_statistics(metric_name, timestamp DESC);

ALTER TABLE bot_statistics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view statistics"
  ON bot_statistics FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Only admins can insert statistics"
  ON bot_statistics FOR INSERT
  TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Create bot_users table
CREATE TABLE IF NOT EXISTS bot_users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id bigint UNIQUE NOT NULL,
  username text,
  full_name text NOT NULL,
  is_blocked boolean DEFAULT false,
  interaction_count int DEFAULT 0,
  last_active timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now()
);

ALTER TABLE bot_users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view bot users"
  ON bot_users FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Only admins can modify bot users"
  ON bot_users FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Insert sample data for modules
INSERT INTO bot_modules (name, description, status, icon, color) VALUES
  ('AI Chat', 'Intelligent conversation module with GPT integration', 'active', 'MessageSquare', '#06B6D4'),
  ('Code Review', 'Automated code analysis and suggestions', 'active', 'Code', '#8B5CF6'),
  ('Task Manager', 'Project and task tracking system', 'inactive', 'CheckSquare', '#10B981'),
  ('Analytics', 'Real-time data analytics and reporting', 'active', 'BarChart3', '#F59E0B'),
  ('Notifications', 'Smart notification delivery system', 'active', 'Bell', '#EF4444'),
  ('File Manager', 'Document storage and management', 'inactive', 'Folder', '#6366F1')
ON CONFLICT (name) DO NOTHING;

-- Insert sample logs
INSERT INTO bot_logs (level, message, module) VALUES
  ('success', 'Bot successfully started and connected to Telegram API', 'System'),
  ('info', 'AI Chat module initialized with GPT-4 model', 'AI Chat'),
  ('warning', 'High memory usage detected: 85% of allocated resources', 'System'),
  ('success', 'Code Review completed for repository: swift-project', 'Code Review'),
  ('info', 'Analytics report generated: 1,247 active users', 'Analytics'),
  ('error', 'Failed to send notification: Network timeout', 'Notifications');


======================================================================

------------------------------ FILE: Systems/web/src/App.tsx ------------------------------
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { ThemeProvider } from './contexts/ThemeContext';
import { CloudPasswordSetup } from './pages/CloudPasswordSetup';
import { CloudPasswordPrompt } from './pages/CloudPasswordPrompt';
import { Dashboard } from './pages/Dashboard';
import { AnimatedBackground } from './components/AnimatedBackground';

const AppContent = () => {
  const { user, loading, cloudPasswordSetup, cloudPasswordVerified } = useAuth();
  
  // Debug logging
  console.log('AppContent render:', { 
    hasUser: !!user, 
    loading, 
    cloudPasswordSetup, 
    cloudPasswordVerified 
  });

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  // If user exists but cloud password status is still checking
  if (user && cloudPasswordSetup === null) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  // If user is logged in but cloud password not verified
  if (user && !cloudPasswordVerified) {
    if (cloudPasswordSetup === false) {
      // First time - need to setup cloud password
      return (
        <>
          <AnimatedBackground />
          <div className="relative z-10">
            <CloudPasswordSetup />
          </div>
        </>
      );
    } else {
      // Cloud password exists - need to verify
      return (
        <>
          <AnimatedBackground />
          <div className="relative z-10">
            <CloudPasswordPrompt />
          </div>
        </>
      );
    }
  }

  // User is logged in and cloud password verified
  if (user && cloudPasswordVerified) {
    return (
      <>
        <AnimatedBackground />
        <div className="relative z-10">
          <Dashboard />
        </div>
      </>
    );
  }

  // No user - show message that login is only via token
  return (
    <>
      <AnimatedBackground />
      <div className="relative z-10 min-h-screen flex items-center justify-center p-4">
        <div className="text-center max-w-md">
          <h1 className="logo-text text-4xl font-bold mb-4">SwiftDevBot</h1>
          <p className="text-glass-text-secondary mb-6">
            –î–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É <code className="bg-white/10 px-2 py-1 rounded">/login</code> –≤ Telegram –±–æ—Ç–µ
          </p>
          <p className="text-sm text-glass-text-secondary">
            –í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å
          </p>
        </div>
      </div>
    </>
  );
};

function App() {
  return (
    <ThemeProvider>
      <AuthProvider>
        <AppContent />
      </AuthProvider>
    </ThemeProvider>
  );
}

export default App;



======================================================================

------------------------------ FILE: Systems/web/src/main.tsx ------------------------------
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import App from './App.tsx';
import './index.css';

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>
);



======================================================================

------------------------------ FILE: Systems/web/src/index.css ------------------------------
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.18);
  --glass-shadow: rgba(0, 0, 0, 0.1);
  --text-primary: rgba(15, 23, 42, 0.95);
  --text-secondary: rgba(15, 23, 42, 0.7);
  --gradient-primary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
  --gradient-accent: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
}

[data-theme='dark'] {
  --glass-bg: rgba(0, 0, 0, 0.25);
  --glass-border: rgba(255, 255, 255, 0.12);
  --glass-shadow: rgba(0, 0, 0, 0.3);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.6);
}

* {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  transition: background-color 0.3s ease;
}

[data-theme='light'] body {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #dbeafe 100%);
}

[data-theme='dark'] body {
  background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
}

.animated-background {
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
  pointer-events: none;
}

.gradient-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.4;
  animation: float 20s infinite ease-in-out;
}

[data-theme='dark'] .gradient-orb {
  opacity: 0.3;
}

.orb-1 {
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, #06b6d4, transparent);
  top: -10%;
  left: -10%;
  animation-delay: 0s;
}

.orb-2 {
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, #8b5cf6, transparent);
  bottom: -10%;
  right: -10%;
  animation-delay: 7s;
}

.orb-3 {
  width: 450px;
  height: 450px;
  background: radial-gradient(circle, #84cc16, transparent);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation-delay: 14s;
}

.light-beam {
  position: absolute;
  width: 2px;
  height: 100%;
  background: linear-gradient(
    to bottom,
    transparent,
    rgba(6, 182, 212, 0.3),
    transparent
  );
  animation: beam-move 8s infinite ease-in-out;
}

.beam-1 {
  left: 20%;
  animation-delay: 0s;
}

.beam-2 {
  left: 50%;
  animation-delay: 2.5s;
}

.beam-3 {
  left: 80%;
  animation-delay: 5s;
}

@keyframes float {
  0%, 100% {
    transform: translate(0, 0) scale(1);
  }
  33% {
    transform: translate(30px, -30px) scale(1.1);
  }
  66% {
    transform: translate(-20px, 20px) scale(0.9);
  }
}

@keyframes beam-move {
  0%, 100% {
    opacity: 0.2;
    transform: translateY(-100%);
  }
  50% {
    opacity: 0.5;
    transform: translateY(100%);
  }
}

.glass-card {
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  border-radius: 1rem;
  box-shadow: 0 8px 32px var(--glass-shadow),
              inset 0 1px 1px rgba(255, 255, 255, 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.glass-card.overflow-visible {
  overflow: visible;
}

.glass-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.1),
    transparent
  );
  transition: left 0.5s ease;
}

.glass-card:hover::before {
  left: 100%;
}

.glass-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 48px var(--glass-shadow),
              inset 0 1px 1px rgba(255, 255, 255, 0.15);
  border-color: rgba(6, 182, 212, 0.3);
}

.glass-glow {
  box-shadow: 0 8px 32px var(--glass-shadow),
              0 0 20px rgba(6, 182, 212, 0.15),
              inset 0 1px 1px rgba(255, 255, 255, 0.1);
}

[data-theme='dark'] .glass-glow {
  box-shadow: 0 8px 32px var(--glass-shadow),
              0 0 30px rgba(6, 182, 212, 0.2),
              inset 0 1px 1px rgba(255, 255, 255, 0.05);
}

.glass-button {
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  border-radius: 0.75rem;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  color: var(--text-primary);
}

.glass-button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.glass-button:hover::before {
  width: 300px;
  height: 300px;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(6, 182, 212, 0.3);
}

.glass-button:active {
  transform: translateY(0);
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.glass-button-primary {
  background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(59, 130, 246, 0.2));
  border-color: rgba(6, 182, 212, 0.4);
  color: #06b6d4;
}

[data-theme='dark'] .glass-button-primary {
  color: #06b6d4;
}

.glass-button-primary:hover {
  background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(59, 130, 246, 0.3));
  border-color: rgba(6, 182, 212, 0.6);
  box-shadow: 0 8px 24px rgba(6, 182, 212, 0.4);
}

.glass-button-secondary {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.3);
  color: #8b5cf6;
}

.glass-button-secondary:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: rgba(139, 92, 246, 0.5);
  box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
}

.glass-button-danger {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.glass-button-danger:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
  box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
}

.glass-input {
  width: 100%;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 0.75rem;
  padding: 0.75rem 1rem;
  color: var(--text-primary);
  font-size: 1rem;
  transition: all 0.3s ease;
  outline: none;
}

.glass-input::placeholder {
  color: var(--text-secondary);
}

.glass-input:focus {
  border-color: rgba(6, 182, 212, 0.5);
  box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
}

.glass-input-error {
  border-color: rgba(239, 68, 68, 0.5);
}

.glass-input-error:focus {
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.text-glass-text {
  color: var(--text-primary);
}

.text-glass-text-secondary {
  color: var(--text-secondary);
}

.logo-container {
  position: relative;
  animation: pulse-glow 3s ease-in-out infinite;
}

.logo-container svg {
  filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.5));
}

[data-theme='light'] .logo-container svg {
  color: #0891b2;
}

[data-theme='dark'] .logo-container svg {
  color: #06b6d4;
}

@keyframes pulse-glow {
  0%, 100% {
    filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.5));
  }
  50% {
    filter: drop-shadow(0 0 30px rgba(6, 182, 212, 0.8));
  }
}

.logo-text {
  background: linear-gradient(
    135deg,
    #06b6d4 0%,
    #3b82f6 20%,
    #8b5cf6 40%,
    #ec4899 60%,
    #84cc16 80%,
    #06b6d4 100%
  );
  background-size: 400% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradient-shift 8s ease-in-out infinite;
  position: relative;
  display: inline-block;
}

.logo-text::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    135deg,
    #06b6d4 0%,
    #3b82f6 20%,
    #8b5cf6 40%,
    #ec4899 60%,
    #84cc16 80%,
    #06b6d4 100%
  );
  background-size: 400% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: blur(15px);
  opacity: 0.6;
  z-index: -1;
  animation: gradient-shift 8s ease-in-out infinite reverse;
}

@keyframes gradient-shift {
  0% {
    background-position: 0% center;
    filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.4));
  }
  20% {
    background-position: 25% center;
    filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
  }
  40% {
    background-position: 50% center;
    filter: drop-shadow(0 0 25px rgba(139, 92, 246, 0.6));
  }
  60% {
    background-position: 75% center;
    filter: drop-shadow(0 0 30px rgba(236, 72, 153, 0.7));
  }
  80% {
    background-position: 100% center;
    filter: drop-shadow(0 0 25px rgba(132, 204, 22, 0.6));
  }
  100% {
    background-position: 200% center;
    filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.4));
  }
}

.footer-text {
  color: var(--text-secondary);
  position: relative;
  display: inline-block;
}

.footer-text span {
  background: linear-gradient(135deg, #06b6d4, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(6, 182, 212, 0.2);
  border-top-color: #06b6d4;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@media (max-width: 1024px) {
  .glass-card {
    border-radius: 0.75rem;
  }

  .gradient-orb {
    filter: blur(60px);
  }
}

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}



======================================================================

------------------------------ FILE: Systems/web/src/api.ts ------------------------------
export interface User {
    username: string;
    role: string;
}

export interface Profile {
    username: string;
    role: string;
}

export const api = {
    loginWithToken: async (token: string) => {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
        });
        if (!response.ok) throw new Error('Login failed');
        return response.json();
    },

    checkCloudPasswordSetup: async () => {
        const token = localStorage.getItem('sdb_token');
        const response = await fetch('/api/auth/cloud-password/check', {
            headers: { 'Authorization': `Bearer ${token}` },
        });
        if (!response.ok) throw new Error('Check failed');
        return response.json();
    },

    setupCloudPassword: async (password: string) => {
        const token = localStorage.getItem('sdb_token');
        const response = await fetch('/api/auth/cloud-password/setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ password }),
        });
        if (!response.ok) {
            const error = await response.json().catch(() => ({ detail: 'Setup failed' }));
            throw new Error(error.detail || 'Setup failed');
        }
        return response.json();
    },

    verifyCloudPassword: async (password: string) => {
        const token = localStorage.getItem('sdb_token');
        const response = await fetch('/api/auth/cloud-password/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ password }),
        });
        if (!response.ok) {
            const error = await response.json().catch(() => ({ detail: 'Verification failed' }));
            throw new Error(error.detail || 'Verification failed');
        }
        return response.json();
    },

    logout: async () => {
        await fetch('/api/auth/logout', { method: 'POST' });
    }
};



======================================================================

------------------------------ FILE: Systems/web/src/package.json ------------------------------



======================================================================

------------------------------ FILE: Systems/web/src/vite-env.d.ts ------------------------------
/// <reference types="vite/client" />



======================================================================

------------------------------ FILE: Systems/web/src/contexts/ThemeContext.tsx ------------------------------
import { createContext, useContext, useEffect, useState, ReactNode } from 'react';

type Theme = 'light' | 'dark';

type ThemeContextType = {
  theme: Theme;
  toggleTheme: () => void;
};

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider');
  }
  return context;
};

export const ThemeProvider = ({ children }: { children: ReactNode }) => {
  const [theme, setTheme] = useState<Theme>(() => {
    const saved = localStorage.getItem('theme');
    return (saved as Theme) || 'dark';
  });

  useEffect(() => {
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme((prev) => (prev === 'dark' ? 'light' : 'dark'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/contexts/AuthContext.tsx ------------------------------
import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { api, User, Profile } from '../api';

type AuthContextType = {
  user: User | null;
  profile: Profile | null;
  isAdmin: boolean;
  loading: boolean;
  cloudPasswordSetup: boolean | null; // null = checking, true = setup, false = not setup
  cloudPasswordVerified: boolean; // true = verified, false = not verified
  signInWithToken: (token: string) => Promise<void>;
  setupCloudPassword: (password: string) => Promise<void>;
  verifyCloudPassword: (password: string) => Promise<void>;
  signOut: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [loading, setLoading] = useState(true);
  const [cloudPasswordSetup, setCloudPasswordSetup] = useState<boolean | null>(null);
  const [cloudPasswordVerified, setCloudPasswordVerified] = useState(false);

  const signInWithToken = async (token: string) => {
    try {
      console.log('signInWithToken called with token:', token ? 'present' : 'missing');
      const response = await api.loginWithToken(token);
      console.log('loginWithToken response:', response);
      setUser(response.user);
      const userProfile: Profile = {
        username: response.user.username,
        role: response.user.role,
      };
      setProfile(userProfile);
      localStorage.setItem('sdb_user', JSON.stringify(response.user));
      localStorage.setItem('sdb_token', response.token);
      console.log('Token saved to localStorage:', response.token ? 'yes' : 'no');

      // Check if cloud password is setup (async, don't block)
      api.checkCloudPasswordSetup()
        .then(result => {
          console.log('Cloud password setup check result:', result);
          setCloudPasswordSetup(result.isSetup);
        })
        .catch(error => {
          console.error('Error checking cloud password setup:', error);
          setCloudPasswordSetup(false);
        });
    } catch (error) {
      console.error('Token sign in error:', error);
      throw error;
    }
  };

  const setupCloudPassword = async (password: string) => {
    try {
      console.log('Setting up cloud password...');
      await api.setupCloudPassword(password);
      console.log('Cloud password setup successful');
      setCloudPasswordSetup(true);
      setCloudPasswordVerified(true);
      localStorage.setItem('sdb_cloud_password_setup', 'true');
      localStorage.setItem('sdb_cloud_password_verified', 'true');
      console.log('State updated: cloudPasswordSetup=true, cloudPasswordVerified=true');
    } catch (error) {
      console.error('Cloud password setup error:', error);
      throw error;
    }
  };

  const verifyCloudPassword = async (password: string) => {
    try {
      console.log('Calling api.verifyCloudPassword...');
      await api.verifyCloudPassword(password);
      console.log('API verifyCloudPassword successful, updating state...');
      setCloudPasswordVerified(true);
      localStorage.setItem('sdb_cloud_password_verified', 'true');
      console.log('State updated: cloudPasswordVerified=true');
      // Force a small delay to ensure state update propagates
      await new Promise(resolve => setTimeout(resolve, 100));
      console.log('State update complete, should trigger re-render');
    } catch (error) {
      console.error('Cloud password verification error:', error);
      throw error;
    }
  };

  useEffect(() => {
    // Check for token in URL (from Telegram bot)
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
      // Remove token from URL
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);

      // Try to login with token
      signInWithToken(token).catch((error) => {
        console.error('Token login failed:', error);
        setLoading(false);
      }).finally(() => {
        setLoading(false);
      });
      return;
    }

    // Check for saved session
    const savedUser = localStorage.getItem('sdb_user');
    const cloudPasswordVerified = localStorage.getItem('sdb_cloud_password_verified');

    if (savedUser && cloudPasswordVerified === 'true') {
      try {
        const userData = JSON.parse(savedUser);
        setUser(userData);
        setProfile({
          username: userData.username,
          role: userData.role,
        });
        setCloudPasswordVerified(true);

        // Check cloud password setup status
        api.checkCloudPasswordSetup()
          .then(result => setCloudPasswordSetup(result.isSetup))
          .catch(() => {
            setCloudPasswordSetup(false);
            setLoading(false);
          })
          .finally(() => {
            setLoading(false);
          });
      } catch (error) {
        console.error('Error loading saved user:', error);
        localStorage.removeItem('sdb_user');
        localStorage.removeItem('sdb_token');
        localStorage.removeItem('sdb_cloud_password_verified');
        setCloudPasswordSetup(false);
        setLoading(false);
      }
    } else if (savedUser) {
      // User exists but cloud password not verified - need to verify
      try {
        const userData = JSON.parse(savedUser);
        setUser(userData);
        setProfile({
          username: userData.username,
          role: userData.role,
        });

        // Check cloud password setup status
        api.checkCloudPasswordSetup()
          .then(result => setCloudPasswordSetup(result.isSetup))
          .catch(() => {
            setCloudPasswordSetup(false);
            setLoading(false);
          })
          .finally(() => {
            setLoading(false);
          });
      } catch (error) {
        console.error('Error loading saved user:', error);
        localStorage.removeItem('sdb_user');
        localStorage.removeItem('sdb_token');
        setCloudPasswordSetup(false);
        setLoading(false);
      }
    } else {
      // No user - no need to check cloud password
      setCloudPasswordSetup(false);
      setLoading(false);
    }
  }, []);

  const signOut = async () => {
    try {
      await api.logout();
    } catch (error) {
      console.error('Sign out error:', error);
    } finally {
      setUser(null);
      setProfile(null);
      setCloudPasswordVerified(false);
      localStorage.removeItem('sdb_user');
      localStorage.removeItem('sdb_token');
      localStorage.removeItem('sdb_cloud_password_verified');
      localStorage.removeItem('sdb_cloud_password_setup');
    }
  };

  // Check for admin role - handle various cases
  const isAdminValue = profile?.role?.toLowerCase() === 'admin' ||
    profile?.role === 'admin' ||
    profile?.role === 'Admin' ||
    profile?.role === 'SUPERADMIN' ||
    profile?.role?.toLowerCase() === 'superadmin';

  // Debug logging
  console.log('AuthContext - profile:', profile);
  console.log('AuthContext - profile.role:', profile?.role);
  console.log('AuthContext - isAdmin:', isAdminValue);
  console.log('AuthContext - user:', user);

  const value = {
    user,
    profile,
    isAdmin: isAdminValue,
    loading,
    cloudPasswordSetup,
    cloudPasswordVerified,
    signInWithToken,
    setupCloudPassword,
    verifyCloudPassword,
    signOut,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};



======================================================================

------------------------------ FILE: Systems/web/src/components/Header.tsx ------------------------------
import { useState, useRef, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import { Zap, Sun, Moon, User, LogOut, Menu, X } from 'lucide-react';
import { GlassCard } from './ui/GlassCard';

type HeaderProps = {
  onMenuToggle: () => void;
  isMobileMenuOpen: boolean;
};

export const Header = ({ onMenuToggle, isMobileMenuOpen }: HeaderProps) => {
  const { profile, signOut } = useAuth();
  const { theme, toggleTheme } = useTheme();
  const [showDropdown, setShowDropdown] = useState(false);
  const menuButtonRef = useRef<HTMLDivElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node) &&
        menuButtonRef.current &&
        !menuButtonRef.current.contains(event.target as Node)
      ) {
        setShowDropdown(false);
      }
    };

    if (showDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
      };
    }
  }, [showDropdown]);

  const handleSignOut = async () => {
    await signOut();
    setShowDropdown(false);
  };

  return (
    <header className="sticky top-0 z-50 backdrop-blur-xl">
      <GlassCard className="m-4 p-4 overflow-visible">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button
              onClick={onMenuToggle}
              className="lg:hidden p-2 hover:bg-white/10 rounded-lg transition-colors"
            >
              {isMobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
            </button>

            <div className="flex items-center gap-3">
              <div className="logo-container">
                <Zap className="w-8 h-8" />
              </div>
              <div>
                <h1 className="logo-text text-xl font-bold">SwiftDevBot</h1>
                <p className="text-xs text-glass-text-secondary">Control Center</p>
              </div>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <button
              onClick={toggleTheme}
              className="p-2 hover:bg-white/10 rounded-lg transition-all hover:scale-110"
              title={`Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`}
            >
              {theme === 'dark' ? (
                <Sun className="w-5 h-5 text-yellow-400" />
              ) : (
                <Moon className="w-5 h-5 text-blue-600" />
              )}
            </button>

            <div className="relative" ref={menuButtonRef}>
              <button
                onClick={() => setShowDropdown(!showDropdown)}
                className="flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg transition-colors"
              >
                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center">
                  <User className="w-5 h-5 text-white" />
                </div>
                <div className="hidden md:block text-left">
                  <p className="text-sm font-medium text-glass-text">{profile?.username}</p>
                  <p className="text-xs text-glass-text-secondary capitalize">{profile?.role}</p>
                </div>
              </button>

              {showDropdown && (
                <>
                  <div
                    className="fixed inset-0 z-[90]"
                    onClick={() => setShowDropdown(false)}
                  />
                  <div 
                    ref={dropdownRef}
                    className="absolute right-0 mt-2 w-48 z-[100]"
                    style={{
                      position: 'absolute',
                      top: '100%',
                      right: 0,
                    }}
                  >
                    <GlassCard className="p-2 shadow-2xl">
                      <button
                        onClick={handleSignOut}
                        className="w-full flex items-center gap-2 px-3 py-2 text-sm text-glass-text hover:bg-white/10 rounded-lg transition-colors"
                      >
                        <LogOut className="w-4 h-4" />
                        Sign Out
                      </button>
                    </GlassCard>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      </GlassCard>
    </header>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/Sidebar.tsx ------------------------------
import { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { GlassCard } from './ui/GlassCard';
import {
  Home,
  Box,
  Users,
  BarChart3,
  FileText,
  Settings,
  BookOpen,
  Server,
  Activity,
  Sliders,
  Shield,
  ChevronDown,
  ChevronRight,
} from 'lucide-react';

type MenuItem = {
  id: string;
  label: string;
  icon: React.ElementType;
  adminOnly?: boolean;
};

const userMenuItems: MenuItem[] = [
  { id: 'home', label: 'Home', icon: Home },
  { id: 'modules', label: 'Modules', icon: Box },
  { id: 'users', label: 'Users', icon: Users },
  { id: 'statistics', label: 'Statistics', icon: BarChart3 },
  { id: 'logs', label: 'Logs', icon: FileText },
  { id: 'settings', label: 'Settings', icon: Settings },
  { id: 'docs', label: 'Documentation', icon: BookOpen },
];

const adminMenuItems: MenuItem[] = [
  { id: 'config', label: 'Core Config', icon: Sliders },
  { id: 'services', label: 'Services', icon: Server },
  { id: 'monitoring', label: 'Monitoring', icon: Activity },
];

type SidebarProps = {
  activeSection: string;
  onSectionChange: (section: string) => void;
  isMobileOpen: boolean;
  onClose: () => void;
};

export const Sidebar = ({ activeSection, onSectionChange, isMobileOpen, onClose }: SidebarProps) => {
  const { isAdmin, profile } = useAuth();
  const [adminMenuOpen, setAdminMenuOpen] = useState(false);
  
  // Debug logging
  console.log('Sidebar render - isAdmin:', isAdmin, 'profile:', profile);

  const handleItemClick = (id: string) => {
    onSectionChange(id);
    onClose();
  };

  return (
    <>
      {isMobileOpen && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 lg:hidden"
          onClick={onClose}
        />
      )}

      <aside
        className={`
          fixed lg:sticky top-0 left-0 h-screen z-40 lg:z-20
          transform transition-transform duration-300 ease-in-out
          ${isMobileOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        `}
      >
        <div className="h-full p-4">
          <GlassCard className="h-full p-4 w-64 flex flex-col">
            <nav className="flex-1 space-y-2">
              {/* User menu items */}
              {userMenuItems.map((item) => {
                const Icon = item.icon;
                const isActive = activeSection === item.id;

                return (
                  <button
                    key={item.id}
                    onClick={() => handleItemClick(item.id)}
                    className={`
                      w-full flex items-center gap-3 px-4 py-3 rounded-xl
                      transition-all duration-200 group
                      ${isActive
                        ? 'bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border-l-4 border-cyan-400'
                        : 'hover:bg-white/10 hover:translate-x-1'
                      }
                    `}
                  >
                    <Icon
                      className={`
                        w-5 h-5 transition-colors
                        ${isActive
                          ? 'text-cyan-400'
                          : 'text-glass-text-secondary group-hover:text-glass-text'
                        }
                      `}
                    />
                    <span
                      className={`
                        font-medium text-sm
                        ${isActive
                          ? 'text-glass-text'
                          : 'text-glass-text-secondary group-hover:text-glass-text'
                        }
                      `}
                    >
                      {item.label}
                    </span>
                  </button>
                );
              })}

              {/* Admin section - only for admins */}
              {isAdmin ? (
                <div className="mt-4 pt-4 border-t border-white/10">
                  <div className="text-xs text-purple-300/50 mb-2 px-4">Admin Panel</div>
                  <button
                    onClick={() => setAdminMenuOpen(!adminMenuOpen)}
                    className={`
                      w-full flex items-center gap-3 px-4 py-3 rounded-xl
                      transition-all duration-200 group
                      bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30
                      hover:from-purple-500/30 hover:to-pink-500/30
                    `}
                  >
                    <Shield className="w-5 h-5 text-purple-300" />
                    <span className="font-medium text-sm text-purple-300 flex-1 text-left">
                      –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </span>
                    {adminMenuOpen ? (
                      <ChevronDown className="w-4 h-4 text-purple-300" />
                    ) : (
                      <ChevronRight className="w-4 h-4 text-purple-300" />
                    )}
                  </button>

                  {adminMenuOpen && (
                    <div className="mt-2 space-y-1 ml-4 border-l-2 border-purple-400/30 pl-2">
                      {adminMenuItems.map((item) => {
                        const Icon = item.icon;
                        const isActive = activeSection === item.id;

                        return (
                          <button
                            key={item.id}
                            onClick={() => handleItemClick(item.id)}
                            className={`
                              w-full flex items-center gap-3 px-4 py-2 rounded-lg
                              transition-all duration-200 group
                              ${isActive
                                ? 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 border-l-2 border-purple-400'
                                : 'hover:bg-white/10 hover:translate-x-1'
                              }
                            `}
                          >
                            <Icon
                              className={`
                                w-4 h-4 transition-colors
                                ${isActive
                                  ? 'text-purple-300'
                                  : 'text-glass-text-secondary group-hover:text-purple-300'
                                }
                              `}
                            />
                            <span
                              className={`
                                font-medium text-xs
                                ${isActive
                                  ? 'text-purple-300'
                                  : 'text-glass-text-secondary group-hover:text-purple-300'
                                }
                              `}
                            >
                              {item.label}
                            </span>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              ) : (
                <div className="mt-4 pt-4 border-t border-white/10">
                  <div className="text-xs text-red-300/50 px-4">
                    Debug: isAdmin = {String(isAdmin)}, role = {profile?.role || 'undefined'}
                  </div>
                </div>
              )}
            </nav>

          </GlassCard>
        </div>
      </aside>
    </>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/AnimatedBackground.tsx ------------------------------
import { useTheme } from '../contexts/ThemeContext';

export const AnimatedBackground = () => {
  const { theme } = useTheme();

  return (
    <div className="animated-background">
      <div className="gradient-orb orb-1"></div>
      <div className="gradient-orb orb-2"></div>
      <div className="gradient-orb orb-3"></div>
      {theme === 'dark' && (
        <>
          <div className="light-beam beam-1"></div>
          <div className="light-beam beam-2"></div>
          <div className="light-beam beam-3"></div>
        </>
      )}
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/ui/GlassCard.tsx ------------------------------
import { ReactNode } from 'react';

type GlassCardProps = {
  children: ReactNode;
  className?: string;
  hover?: boolean;
  glow?: boolean;
};

export const GlassCard = ({ children, className = '', hover = false, glow = false }: GlassCardProps) => {
  return (
    <div
      className={`
        glass-card
        ${hover ? 'glass-hover' : ''}
        ${glow ? 'glass-glow' : ''}
        ${className}
      `}
    >
      {children}
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/ui/GlassInput.tsx ------------------------------
import { InputHTMLAttributes, forwardRef } from 'react';

type GlassInputProps = InputHTMLAttributes<HTMLInputElement> & {
  label?: string;
  error?: string;
};

export const GlassInput = forwardRef<HTMLInputElement, GlassInputProps>(
  ({ label, error, className = '', ...props }, ref) => {
    return (
      <div className="w-full">
        {label && (
          <label className="block text-sm font-medium mb-2 text-glass-text">
            {label}
          </label>
        )}
        <input
          ref={ref}
          className={`
            glass-input
            ${error ? 'glass-input-error' : ''}
            ${className}
          `}
          {...props}
        />
        {error && (
          <p className="mt-1 text-sm text-red-400">{error}</p>
        )}
      </div>
    );
  }
);

GlassInput.displayName = 'GlassInput';



======================================================================

------------------------------ FILE: Systems/web/src/components/ui/GlassButton.tsx ------------------------------
import { ReactNode, ButtonHTMLAttributes } from 'react';

type GlassButtonProps = ButtonHTMLAttributes<HTMLButtonElement> & {
  children: ReactNode;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'sm' | 'md' | 'lg';
};

export const GlassButton = ({
  children,
  variant = 'primary',
  size = 'md',
  className = '',
  ...props
}: GlassButtonProps) => {
  const sizeClasses = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg',
  };

  return (
    <button
      className={`
        glass-button
        glass-button-${variant}
        ${sizeClasses[size]}
        ${className}
      `}
      {...props}
    >
      {children}
    </button>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Settings.tsx ------------------------------
import { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { GlassCard } from '../ui/GlassCard';
import { GlassInput } from '../ui/GlassInput';
import { GlassButton } from '../ui/GlassButton';
import { User, Shield } from 'lucide-react';

export const Settings = () => {
  const { profile } = useAuth();
  const [formData, setFormData] = useState({
    username: profile?.username || '',
  });
  const [saved, setSaved] = useState(false);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaved(true);
    setTimeout(() => setSaved(false), 3000);
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Settings</h2>
        <p className="text-glass-text-secondary">Manage your account and preferences</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <GlassCard className="p-6 text-center" hover>
          <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center">
            <User className="w-12 h-12 text-white" />
          </div>
          <h3 className="text-xl font-bold text-glass-text mb-1">{profile?.username}</h3>
          <p className="text-glass-text-secondary text-sm mb-3 capitalize">{profile?.role}</p>
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-500/20 text-purple-300 text-sm font-semibold">
            <Shield className="w-4 h-4" />
            {profile?.role?.toUpperCase()}
          </div>
        </GlassCard>

        <div className="lg:col-span-2">
          <GlassCard className="p-6" glow>
            <h3 className="text-xl font-bold text-glass-text mb-6">Profile Information</h3>
            <form onSubmit={handleSave} className="space-y-4">
              <GlassInput
                label="Username"
                type="text"
                value={formData.username}
                onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                placeholder="Enter your username"
              />

              <div className="flex items-center gap-3 pt-4">
                <GlassButton type="submit" variant="primary">
                  Save Changes
                </GlassButton>
                {saved && (
                  <span className="text-green-400 text-sm font-medium">Settings saved!</span>
                )}
              </div>
            </form>
          </GlassCard>
        </div>
      </div>

      <GlassCard className="p-6">
        <h3 className="text-xl font-bold text-glass-text mb-4">Preferences</h3>
        <div className="space-y-4">
          {[
            { label: 'Email Notifications', description: 'Receive email updates about bot activity' },
            { label: 'Auto-refresh Dashboard', description: 'Automatically update dashboard data' },
            { label: 'Dark Mode by Default', description: 'Always start with dark theme' },
          ].map((pref) => (
            <div key={pref.label} className="flex items-center justify-between p-4 rounded-lg bg-white/5">
              <div>
                <p className="text-glass-text font-medium">{pref.label}</p>
                <p className="text-glass-text-secondary text-sm">{pref.description}</p>
              </div>
              <label className="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" className="sr-only peer" defaultChecked />
                <div className="w-11 h-6 bg-white/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div>
              </label>
            </div>
          ))}
        </div>
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Monitoring.tsx ------------------------------
import { GlassCard } from '../ui/GlassCard';
import { Activity, Cpu, HardDrive, Wifi, Zap } from 'lucide-react';

export const Monitoring = () => {
  const metrics = [
    { label: 'CPU Usage', value: 45, icon: Cpu, color: 'from-cyan-400 to-blue-500' },
    { label: 'Memory', value: 62, icon: Activity, color: 'from-purple-400 to-pink-500' },
    { label: 'Disk I/O', value: 28, icon: HardDrive, color: 'from-green-400 to-emerald-500' },
    { label: 'Network', value: 71, icon: Wifi, color: 'from-orange-400 to-red-500' },
  ];

  const requests = Array.from({ length: 50 }, () => Math.random() * 100);

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">System Monitoring</h2>
        <p className="text-glass-text-secondary">Real-time performance metrics and health status</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {metrics.map((metric) => {
          const Icon = metric.icon;
          return (
            <GlassCard key={metric.label} hover glow className="p-6">
              <div className="flex items-start justify-between mb-4">
                <div className={`p-3 rounded-xl bg-gradient-to-br ${metric.color} bg-opacity-20`}>
                  <Icon className="w-6 h-6 text-white" />
                </div>
                <span className="text-2xl font-bold text-glass-text">{metric.value}%</span>
              </div>
              <p className="text-glass-text-secondary text-sm mb-2">{metric.label}</p>
              <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                <div
                  className={`h-full bg-gradient-to-r ${metric.color} rounded-full transition-all duration-500`}
                  style={{ width: `${metric.value}%` }}
                />
              </div>
            </GlassCard>
          );
        })}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <GlassCard className="p-6" glow>
          <h3 className="text-xl font-bold text-glass-text mb-4">Request Rate</h3>
          <div className="h-48 flex items-end gap-1">
            {requests.map((height, i) => (
              <div
                key={i}
                className="flex-1 bg-gradient-to-t from-cyan-500 to-purple-500 rounded-t transition-all hover:opacity-80"
                style={{ height: `${height}%`, minHeight: '2px' }}
              />
            ))}
          </div>
          <div className="flex justify-between mt-4 text-xs text-glass-text-secondary">
            <span>0s</span>
            <span>25s</span>
            <span>50s</span>
          </div>
        </GlassCard>

        <GlassCard className="p-6" glow>
          <h3 className="text-xl font-bold text-glass-text mb-4">Response Times</h3>
          <div className="space-y-4">
            {[
              { endpoint: '/api/messages', time: 45, color: 'bg-green-500' },
              { endpoint: '/api/users', time: 67, color: 'bg-yellow-500' },
              { endpoint: '/api/modules', time: 32, color: 'bg-green-500' },
              { endpoint: '/api/stats', time: 89, color: 'bg-orange-500' },
            ].map((endpoint) => (
              <div key={endpoint.endpoint}>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-glass-text font-mono">{endpoint.endpoint}</span>
                  <span className="text-sm font-semibold text-glass-text">{endpoint.time}ms</span>
                </div>
                <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                  <div
                    className={`h-full ${endpoint.color} rounded-full transition-all duration-500`}
                    style={{ width: `${endpoint.time}%` }}
                  />
                </div>
              </div>
            ))}
          </div>
        </GlassCard>
      </div>

      <GlassCard className="p-6" glow>
        <h3 className="text-xl font-bold text-glass-text mb-6">Active Connections</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {[
            { label: 'WebSocket Connections', value: 127, icon: Zap, change: '+12' },
            { label: 'Database Connections', value: 34, icon: HardDrive, change: '+3' },
            { label: 'API Requests/min', value: 1453, icon: Activity, change: '+89' },
          ].map((stat) => {
            const Icon = stat.icon;
            return (
              <div key={stat.label} className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-cyan-500/20">
                  <Icon className="w-6 h-6 text-cyan-400" />
                </div>
                <div>
                  <p className="text-glass-text-secondary text-sm">{stat.label}</p>
                  <div className="flex items-baseline gap-2">
                    <p className="text-2xl font-bold text-glass-text">{stat.value}</p>
                    <span className="text-sm text-green-400 font-semibold">{stat.change}</span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Home.tsx ------------------------------
import { useEffect, useState } from 'react';
import { api, BotStats } from '../../api';
import { GlassCard } from '../ui/GlassCard';
import { Activity, Users, Zap, TrendingUp } from 'lucide-react';

type Stats = {
  activeModules: number;
  totalUsers: number;
  todayInteractions: number;
  systemStatus: 'online' | 'degraded' | 'offline';
};

export const Home = () => {
  const [stats, setStats] = useState<Stats>({
    activeModules: 0,
    totalUsers: 0,
    todayInteractions: 0,
    systemStatus: 'online',
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStats();
  }, []);

  const loadStats = async () => {
    try {
      const botStats: BotStats = await api.getStats();
      setStats({
        activeModules: botStats.active_modules || 0,
        totalUsers: botStats.total_users || 0,
        todayInteractions: botStats.messages_today || 0,
        systemStatus: 'online',
      });
    } catch (error) {
      console.error('Error loading stats:', error);
    } finally {
      setLoading(false);
    }
  };

  const statCards = [
    {
      label: 'Active Modules',
      value: stats.activeModules,
      icon: Zap,
      color: 'from-cyan-400 to-blue-500',
      bgColor: 'bg-cyan-500/10',
    },
    {
      label: 'Total Users',
      value: stats.totalUsers,
      icon: Users,
      color: 'from-purple-400 to-pink-500',
      bgColor: 'bg-purple-500/10',
    },
    {
      label: 'Today Interactions',
      value: stats.todayInteractions,
      icon: TrendingUp,
      color: 'from-green-400 to-emerald-500',
      bgColor: 'bg-green-500/10',
    },
    {
      label: 'System Status',
      value: stats.systemStatus.toUpperCase(),
      icon: Activity,
      color: 'from-orange-400 to-red-500',
      bgColor: 'bg-orange-500/10',
    },
  ];

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Welcome to SwiftDevBot</h2>
        <p className="text-glass-text-secondary">Monitor and control your bot's operations</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {statCards.map((card) => {
          const Icon = card.icon;
          return (
            <GlassCard key={card.label} hover glow className="p-6">
              <div className="flex items-start justify-between mb-4">
                <div className={`p-3 rounded-xl ${card.bgColor}`}>
                  <Icon className={`w-6 h-6 bg-gradient-to-r ${card.color} bg-clip-text text-transparent`} />
                </div>
              </div>
              <div>
                <p className="text-glass-text-secondary text-sm mb-1">{card.label}</p>
                <p className="text-2xl font-bold text-glass-text">{card.value}</p>
              </div>
            </GlassCard>
          );
        })}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <GlassCard className="p-6" glow>
          <h3 className="text-xl font-bold text-glass-text mb-4">Recent Activity</h3>
          <div className="space-y-3">
            {[
              { action: 'Module activated', module: 'AI Chat', time: '2 minutes ago' },
              { action: 'User registered', module: 'System', time: '15 minutes ago' },
              { action: 'Code review completed', module: 'Code Review', time: '1 hour ago' },
              { action: 'Analytics updated', module: 'Analytics', time: '2 hours ago' },
            ].map((activity, index) => (
              <div
                key={index}
                className="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
              >
                <div>
                  <p className="text-glass-text font-medium">{activity.action}</p>
                  <p className="text-glass-text-secondary text-sm">{activity.module}</p>
                </div>
                <span className="text-xs text-glass-text-secondary">{activity.time}</span>
              </div>
            ))}
          </div>
        </GlassCard>

        <GlassCard className="p-6" glow>
          <h3 className="text-xl font-bold text-glass-text mb-4">System Health</h3>
          <div className="space-y-4">
            {[
              { metric: 'CPU Usage', value: 45, color: 'bg-cyan-500' },
              { metric: 'Memory', value: 62, color: 'bg-purple-500' },
              { metric: 'Network', value: 28, color: 'bg-green-500' },
              { metric: 'Storage', value: 71, color: 'bg-orange-500' },
            ].map((metric) => (
              <div key={metric.metric}>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-glass-text">{metric.metric}</span>
                  <span className="text-sm font-semibold text-glass-text">{metric.value}%</span>
                </div>
                <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                  <div
                    className={`h-full ${metric.color} rounded-full transition-all duration-500`}
                    style={{ width: `${metric.value}%` }}
                  />
                </div>
              </div>
            ))}
          </div>
        </GlassCard>
      </div>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Config.tsx ------------------------------
import { useState } from 'react';
import { GlassCard } from '../ui/GlassCard';
import { GlassInput } from '../ui/GlassInput';
import { GlassButton } from '../ui/GlassButton';
import { Sliders, Database, Key, Globe } from 'lucide-react';

export const Config = () => {
  const [config, setConfig] = useState({
    botToken: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
    apiUrl: 'https://api.telegram.org',
    webhookUrl: 'https://your-domain.com/webhook',
    maxRetries: '3',
    timeout: '30',
  });

  const [saved, setSaved] = useState(false);

  const handleSave = (e: React.FormEvent) => {
    e.preventDefault();
    setSaved(true);
    setTimeout(() => setSaved(false), 3000);
  };

  const configSections = [
    {
      icon: Key,
      title: 'Authentication',
      fields: [
        { key: 'botToken', label: 'Bot Token', type: 'password' },
      ],
    },
    {
      icon: Globe,
      title: 'API Configuration',
      fields: [
        { key: 'apiUrl', label: 'API URL', type: 'text' },
        { key: 'webhookUrl', label: 'Webhook URL', type: 'text' },
      ],
    },
    {
      icon: Sliders,
      title: 'Performance',
      fields: [
        { key: 'maxRetries', label: 'Max Retries', type: 'number' },
        { key: 'timeout', label: 'Timeout (seconds)', type: 'number' },
      ],
    },
  ];

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Core Configuration</h2>
        <p className="text-glass-text-secondary">Manage bot's core settings and parameters</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        {[
          { icon: Database, label: 'Database', value: 'Connected', color: 'text-green-400' },
          { icon: Key, label: 'API Status', value: 'Active', color: 'text-cyan-400' },
          { icon: Globe, label: 'Webhook', value: 'Running', color: 'text-purple-400' },
        ].map((status) => {
          const Icon = status.icon;
          return (
            <GlassCard key={status.label} hover className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-glass-text-secondary text-sm mb-1">{status.label}</p>
                  <p className={`text-xl font-bold ${status.color}`}>{status.value}</p>
                </div>
                <Icon className={`w-8 h-8 ${status.color}`} />
              </div>
            </GlassCard>
          );
        })}
      </div>

      <form onSubmit={handleSave} className="space-y-6">
        {configSections.map((section) => {
          const Icon = section.icon;
          return (
            <GlassCard key={section.title} className="p-6" glow>
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 rounded-lg bg-cyan-500/20">
                  <Icon className="w-5 h-5 text-cyan-400" />
                </div>
                <h3 className="text-xl font-bold text-glass-text">{section.title}</h3>
              </div>
              <div className="space-y-4">
                {section.fields.map((field) => (
                  <GlassInput
                    key={field.key}
                    label={field.label}
                    type={field.type}
                    value={config[field.key as keyof typeof config]}
                    onChange={(e) => setConfig({ ...config, [field.key]: e.target.value })}
                  />
                ))}
              </div>
            </GlassCard>
          );
        })}

        <div className="flex items-center gap-3">
          <GlassButton type="submit" variant="primary" size="lg">
            Save Configuration
          </GlassButton>
          {saved && (
            <span className="text-green-400 text-sm font-medium">Configuration saved!</span>
          )}
        </div>
      </form>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Services.tsx ------------------------------
import { useState } from 'react';
import { GlassCard } from '../ui/GlassCard';
import { GlassButton } from '../ui/GlassButton';
import { Server, Play, Pause, RotateCw, AlertCircle } from 'lucide-react';

type ServiceStatus = 'running' | 'stopped' | 'restarting';

type Service = {
  id: string;
  name: string;
  description: string;
  status: ServiceStatus;
  uptime: string;
  memory: string;
};

export const Services = () => {
  const [services, setServices] = useState<Service[]>([
    {
      id: '1',
      name: 'Bot Core',
      description: 'Main bot process and event handler',
      status: 'running',
      uptime: '5d 12h 34m',
      memory: '245 MB',
    },
    {
      id: '2',
      name: 'Message Queue',
      description: 'Asynchronous message processing',
      status: 'running',
      uptime: '5d 12h 34m',
      memory: '128 MB',
    },
    {
      id: '3',
      name: 'Analytics Engine',
      description: 'Real-time data processing',
      status: 'running',
      uptime: '5d 12h 34m',
      memory: '312 MB',
    },
    {
      id: '4',
      name: 'Cache Service',
      description: 'Redis-based caching layer',
      status: 'stopped',
      uptime: '0m',
      memory: '0 MB',
    },
  ]);

  const handleServiceAction = (id: string, action: 'start' | 'stop' | 'restart') => {
    setServices(services.map(s => {
      if (s.id === id) {
        if (action === 'start') return { ...s, status: 'running' as ServiceStatus };
        if (action === 'stop') return { ...s, status: 'stopped' as ServiceStatus };
        if (action === 'restart') {
          setTimeout(() => {
            setServices(prev => prev.map(ps =>
              ps.id === id ? { ...ps, status: 'running' as ServiceStatus } : ps
            ));
          }, 2000);
          return { ...s, status: 'restarting' as ServiceStatus };
        }
      }
      return s;
    }));
  };

  const getStatusColor = (status: ServiceStatus) => {
    switch (status) {
      case 'running':
        return 'text-green-400 bg-green-500/10 border-green-500/30';
      case 'stopped':
        return 'text-red-400 bg-red-500/10 border-red-500/30';
      case 'restarting':
        return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
    }
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Service Management</h2>
        <p className="text-glass-text-secondary">Control and monitor bot services</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {[
          { label: 'Total Services', value: services.length, color: 'text-cyan-400' },
          { label: 'Running', value: services.filter(s => s.status === 'running').length, color: 'text-green-400' },
          { label: 'Stopped', value: services.filter(s => s.status === 'stopped').length, color: 'text-red-400' },
          { label: 'Health', value: '98%', color: 'text-purple-400' },
        ].map((stat) => (
          <GlassCard key={stat.label} hover className="p-6">
            <p className="text-glass-text-secondary text-sm mb-1">{stat.label}</p>
            <p className={`text-2xl font-bold ${stat.color}`}>{stat.value}</p>
          </GlassCard>
        ))}
      </div>

      <div className="space-y-4">
        {services.map((service) => (
          <GlassCard key={service.id} className="p-6" glow>
            <div className="flex items-start justify-between gap-4">
              <div className="flex items-start gap-4 flex-1">
                <div className="p-3 rounded-xl bg-cyan-500/20">
                  <Server className="w-6 h-6 text-cyan-400" />
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-2">
                    <h3 className="text-xl font-bold text-glass-text">{service.name}</h3>
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold capitalize ${getStatusColor(service.status)}`}>
                      {service.status}
                    </span>
                  </div>
                  <p className="text-glass-text-secondary mb-3">{service.description}</p>
                  <div className="flex gap-4 text-sm">
                    <div>
                      <span className="text-glass-text-secondary">Uptime: </span>
                      <span className="text-glass-text font-medium">{service.uptime}</span>
                    </div>
                    <div>
                      <span className="text-glass-text-secondary">Memory: </span>
                      <span className="text-glass-text font-medium">{service.memory}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="flex gap-2">
                {service.status === 'stopped' ? (
                  <GlassButton
                    size="sm"
                    variant="primary"
                    onClick={() => handleServiceAction(service.id, 'start')}
                  >
                    <Play className="w-4 h-4" />
                  </GlassButton>
                ) : (
                  <GlassButton
                    size="sm"
                    variant="danger"
                    onClick={() => handleServiceAction(service.id, 'stop')}
                    disabled={service.status === 'restarting'}
                  >
                    <Pause className="w-4 h-4" />
                  </GlassButton>
                )}
                <GlassButton
                  size="sm"
                  variant="secondary"
                  onClick={() => handleServiceAction(service.id, 'restart')}
                  disabled={service.status === 'stopped' || service.status === 'restarting'}
                >
                  <RotateCw className={`w-4 h-4 ${service.status === 'restarting' ? 'animate-spin' : ''}`} />
                </GlassButton>
              </div>
            </div>
          </GlassCard>
        ))}
      </div>

      <GlassCard className="p-6 bg-orange-500/5 border-orange-500/20">
        <div className="flex items-start gap-3">
          <AlertCircle className="w-6 h-6 text-orange-400 flex-shrink-0 mt-1" />
          <div>
            <h3 className="text-lg font-bold text-orange-400 mb-2">Warning</h3>
            <p className="text-glass-text-secondary">
              Stopping critical services may affect bot functionality. Always ensure proper backups
              before making changes to production services.
            </p>
          </div>
        </div>
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Logs.tsx ------------------------------
import { useEffect, useState } from 'react';
import { api, BotLog } from '../../api';
import { GlassCard } from '../ui/GlassCard';
import { AlertCircle, CheckCircle, Info, AlertTriangle } from 'lucide-react';

export const Logs = () => {
  const [logs, setLogs] = useState<BotLog[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<string>('all');

  useEffect(() => {
    loadLogs();
  }, [filter]);

  const loadLogs = async () => {
    try {
      const data = await api.getLogs(50, filter === 'all' ? undefined : filter);
      setLogs(data || []);
    } catch (error) {
      console.error('Error loading logs:', error);
    } finally {
      setLoading(false);
    }
  };

  const getLogIcon = (level: string) => {
    switch (level) {
      case 'success':
        return CheckCircle;
      case 'error':
        return AlertCircle;
      case 'warning':
        return AlertTriangle;
      default:
        return Info;
    }
  };

  const getLogColor = (level: string) => {
    switch (level) {
      case 'success':
        return 'text-green-400 bg-green-500/10 border-green-500/30';
      case 'error':
        return 'text-red-400 bg-red-500/10 border-red-500/30';
      case 'warning':
        return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
      default:
        return 'text-blue-400 bg-blue-500/10 border-blue-500/30';
    }
  };

  const formatDate = (date: string) => {
    try {
      return new Date(date).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });
    } catch {
      return date;
    }
  };

  const filters = [
    { value: 'all', label: 'All Logs' },
    { value: 'info', label: 'Info' },
    { value: 'success', label: 'Success' },
    { value: 'warning', label: 'Warning' },
    { value: 'error', label: 'Error' },
  ];

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold text-glass-text mb-2">System Logs</h2>
          <p className="text-glass-text-secondary">Real-time system activity and events</p>
        </div>
        <div className="flex gap-2">
          {filters.map((f) => (
            <button
              key={f.value}
              onClick={() => setFilter(f.value)}
              className={`
                px-4 py-2 rounded-lg text-sm font-medium transition-all
                ${filter === f.value
                  ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
                  : 'bg-white/5 text-glass-text-secondary hover:bg-white/10'
                }
              `}
            >
              {f.label}
            </button>
          ))}
        </div>
      </div>

      <GlassCard className="p-6" glow>
        <div className="space-y-2">
          {logs.map((log, index) => {
            const Icon = getLogIcon(log.level);
            const colorClass = getLogColor(log.level);

            return (
              <div
                key={index}
                className="flex items-start gap-4 p-4 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
              >
                <div className={`p-2 rounded-lg ${colorClass}`}>
                  <Icon className="w-5 h-5" />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-start justify-between gap-2 mb-1">
                    <p className="text-glass-text font-medium">{log.message}</p>
                    <span className="text-xs text-glass-text-secondary whitespace-nowrap">
                      {formatDate(log.timestamp)}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className={`text-xs px-2 py-1 rounded-md capitalize ${colorClass}`}>
                      {log.level}
                    </span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {logs.length === 0 && (
          <div className="text-center py-12">
            <Info className="w-16 h-16 mx-auto mb-4 text-glass-text-secondary" />
            <h3 className="text-xl font-bold text-glass-text mb-2">No logs found</h3>
            <p className="text-glass-text-secondary">
              {filter === 'all' ? 'No logs available' : `No ${filter} logs found`}
            </p>
          </div>
        )}
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Modules.tsx ------------------------------
import { useEffect, useState } from 'react';
import { api, BotModule } from '../../api';
import { useAuth } from '../../contexts/AuthContext';
import { GlassCard } from '../ui/GlassCard';
import { GlassButton } from '../ui/GlassButton';
import { Box } from 'lucide-react';

export const Modules = () => {
  const { isAdmin } = useAuth();
  const [modules, setModules] = useState<BotModule[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadModules();
  }, []);

  const loadModules = async () => {
    try {
      const data = await api.getModules();
      setModules(data || []);
    } catch (error) {
      console.error('Error loading modules:', error);
    } finally {
      setLoading(false);
    }
  };

  const toggleModuleStatus = async (moduleName: string, currentStatus: string) => {
    if (!isAdmin) return;

    // TODO: Implement module toggle API endpoint
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    setModules(modules.map(m => 
      m.name === moduleName ? { ...m, status: newStatus as 'active' | 'inactive' } : m
    ));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-3xl font-bold text-glass-text mb-2">Bot Modules</h2>
          <p className="text-glass-text-secondary">Manage your bot's functionality modules</p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {modules.map((module) => {
          const isActive = module.status === 'active';
          const color = isActive ? '#06b6d4' : '#6b7280';

          return (
            <GlassCard key={module.name} hover glow className="p-6">
              <div className="flex items-start justify-between mb-4">
                <div
                  className="p-3 rounded-xl"
                  style={{
                    backgroundColor: `${color}20`,
                    borderColor: `${color}40`,
                    borderWidth: '1px',
                  }}
                >
                  <Box
                    className="w-6 h-6"
                    style={{ color }}
                  />
                </div>
                <div
                  className={`
                    px-3 py-1 rounded-full text-xs font-semibold
                    ${isActive
                      ? 'bg-green-500/20 text-green-400 border border-green-500/30'
                      : 'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                    }
                  `}
                >
                  {isActive ? 'Active' : 'Inactive'}
                </div>
              </div>

              <h3 className="text-xl font-bold text-glass-text mb-2">{module.name}</h3>
              <p className="text-glass-text-secondary text-sm mb-4 line-clamp-2">
                {module.description}
              </p>

              {isAdmin && (
                <GlassButton
                  variant={isActive ? 'secondary' : 'primary'}
                  size="sm"
                  className="w-full"
                  onClick={() => toggleModuleStatus(module.name, module.status)}
                >
                  {isActive ? 'Deactivate' : 'Activate'}
                </GlassButton>
              )}
            </GlassCard>
          );
        })}
      </div>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Docs.tsx ------------------------------
import { GlassCard } from '../ui/GlassCard';
import { BookOpen, Code, Rocket, Shield, Zap } from 'lucide-react';

export const Docs = () => {
  const sections = [
    {
      icon: Rocket,
      title: 'Getting Started',
      description: 'Quick start guide to set up and configure your bot',
      color: 'from-cyan-400 to-blue-500',
    },
    {
      icon: Code,
      title: 'API Reference',
      description: 'Complete documentation of available API endpoints',
      color: 'from-purple-400 to-pink-500',
    },
    {
      icon: Zap,
      title: 'Module Development',
      description: 'Learn how to create custom modules for your bot',
      color: 'from-green-400 to-emerald-500',
    },
    {
      icon: Shield,
      title: 'Security Best Practices',
      description: 'Guidelines for keeping your bot secure',
      color: 'from-orange-400 to-red-500',
    },
  ];

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Documentation</h2>
        <p className="text-glass-text-secondary">Learn how to use and customize SwiftDevBot</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {sections.map((section) => {
          const Icon = section.icon;
          return (
            <GlassCard key={section.title} hover glow className="p-6 cursor-pointer">
              <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${section.color} flex items-center justify-center mb-4`}>
                <Icon className="w-6 h-6 text-white" />
              </div>
              <h3 className="text-xl font-bold text-glass-text mb-2">{section.title}</h3>
              <p className="text-glass-text-secondary">{section.description}</p>
            </GlassCard>
          );
        })}
      </div>

      <GlassCard className="p-8" glow>
        <div className="flex items-start gap-4">
          <BookOpen className="w-8 h-8 text-cyan-400 flex-shrink-0" />
          <div>
            <h3 className="text-2xl font-bold text-glass-text mb-4">About SwiftDevBot</h3>
            <div className="space-y-4 text-glass-text-secondary">
              <p>
                SwiftDevBot is a powerful, modular Telegram bot designed for developers.
                It provides a comprehensive set of tools and features to streamline your
                development workflow.
              </p>
              <p>
                The bot is built with modern technologies and follows best practices for
                security, scalability, and maintainability. Each module can be independently
                activated or deactivated based on your needs.
              </p>
              <p>
                This dashboard provides full control over your bot's functionality,
                allowing you to monitor activity, manage users, and configure settings
                in real-time.
              </p>
            </div>
          </div>
        </div>
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Statistics.tsx ------------------------------
import { useEffect, useState } from 'react';
import { api } from '../../api';
import { GlassCard } from '../ui/GlassCard';
import { TrendingUp, TrendingDown, Activity } from 'lucide-react';

type StatData = {
  name: string;
  value: number;
  change: number;
};

export const Statistics = () => {
  const [stats, setStats] = useState<StatData[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStatistics();
  }, []);

  const loadStatistics = async () => {
    try {
      // Get stats from API
      const botStats = await api.getStats();
      
      // Transform to display format
      const statsData: StatData[] = [
        {
          name: 'Messages Today',
          value: botStats.messages_today || 0,
          change: 5.2, // Mock change
        },
        {
          name: 'Total Users',
          value: botStats.total_users || 0,
          change: 2.1,
        },
        {
          name: 'Active Modules',
          value: botStats.active_modules || 0,
          change: 0,
        },
        {
          name: 'Total Modules',
          value: botStats.total_modules || 0,
          change: 0,
        },
      ];
      
      setStats(statsData);
    } catch (error) {
      console.error('Error loading statistics:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Statistics</h2>
        <p className="text-glass-text-secondary">Real-time analytics and metrics</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {stats.map((stat) => {
          const isPositive = stat.change >= 0;
          return (
            <GlassCard key={stat.name} hover glow className="p-6">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <p className="text-glass-text-secondary text-sm mb-1">
                    {stat.name}
                  </p>
                  <p className="text-3xl font-bold text-glass-text">
                    {stat.value.toLocaleString()}
                  </p>
                </div>
                <Activity className="w-6 h-6 text-cyan-400" />
              </div>
              {stat.change !== 0 && (
                <div className="flex items-center gap-2">
                  {isPositive ? (
                    <TrendingUp className="w-4 h-4 text-green-400" />
                  ) : (
                    <TrendingDown className="w-4 h-4 text-red-400" />
                  )}
                  <span
                    className={`text-sm font-semibold ${
                      isPositive ? 'text-green-400' : 'text-red-400'
                    }`}
                  >
                    {isPositive ? '+' : ''}{stat.change.toFixed(1)}%
                  </span>
                  <span className="text-xs text-glass-text-secondary">vs previous</span>
                </div>
              )}
            </GlassCard>
          );
        })}
      </div>

      <GlassCard className="p-6" glow>
        <h3 className="text-xl font-bold text-glass-text mb-4">Activity Chart</h3>
        <div className="h-64 flex items-end gap-2">
          {Array.from({ length: 24 }).map((_, i) => {
            const height = Math.random() * 100;
            return (
              <div
                key={i}
                className="flex-1 bg-gradient-to-t from-cyan-500 to-purple-500 rounded-t-lg transition-all hover:opacity-80 cursor-pointer"
                style={{ height: `${height}%`, minHeight: '4px' }}
                title={`Hour ${i}: ${Math.floor(height)}%`}
              />
            );
          })}
        </div>
        <div className="flex justify-between mt-4 text-xs text-glass-text-secondary">
          <span>00:00</span>
          <span>06:00</span>
          <span>12:00</span>
          <span>18:00</span>
          <span>24:00</span>
        </div>
      </GlassCard>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/components/sections/Users.tsx ------------------------------
import { useEffect, useState } from 'react';
import { api, BotUser } from '../../api';
import { useAuth } from '../../contexts/AuthContext';
import { GlassCard } from '../ui/GlassCard';
import { GlassButton } from '../ui/GlassButton';
import { User, Shield, Ban } from 'lucide-react';

export const Users = () => {
  const { isAdmin } = useAuth();
  const [users, setUsers] = useState<BotUser[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadUsers();
  }, []);

  const loadUsers = async () => {
    try {
      const data = await api.getUsers();
      setUsers(data || []);
    } catch (error) {
      console.error('Error loading users:', error);
    } finally {
      setLoading(false);
    }
  };

  const toggleBlockStatus = async (userId: number, currentStatus: boolean) => {
    if (!isAdmin) return;

    // TODO: Implement user block/unblock API endpoint
    setUsers(users.map(u => u.id === userId ? { ...u, is_blocked: !currentStatus } : u));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-3xl font-bold text-glass-text mb-2">Bot Users</h2>
        <p className="text-glass-text-secondary">Manage users interacting with your bot</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {users.map((user) => (
          <GlassCard key={user.id} hover className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center">
                  {user.avatar ? (
                    <span className="text-white font-semibold">{user.avatar}</span>
                  ) : (
                    <User className="w-6 h-6 text-white" />
                  )}
                </div>
                <div>
                  <h3 className="font-bold text-glass-text">{user.username || `User ${user.id}`}</h3>
                  {user.username && (
                    <p className="text-sm text-glass-text-secondary">@{user.username}</p>
                  )}
                </div>
              </div>
              {(user as never)['is_blocked'] ? (
                <Ban className="w-5 h-5 text-red-400" />
              ) : (
                <Shield className="w-5 h-5 text-green-400" />
              )}
            </div>

            <div className="space-y-2 mb-4">
              <div className="flex items-center justify-between text-sm">
                <span className="text-glass-text-secondary">ID</span>
                <span className="text-glass-text font-mono">{user.id}</span>
              </div>
              {user.role && (
                <div className="flex items-center justify-between text-sm">
                  <span className="text-glass-text-secondary">Role</span>
                  <span className="text-glass-text font-semibold capitalize">{user.role}</span>
                </div>
              )}
            </div>

            {isAdmin && (
              <GlassButton
                variant={(user as never)['is_blocked'] ? 'primary' : 'danger'}
                size="sm"
                className="w-full"
                onClick={() => toggleBlockStatus(user.id, (user as never)['is_blocked'] || false)}
              >
                {(user as never)['is_blocked'] ? 'Unblock User' : 'Block User'}
              </GlassButton>
            )}
          </GlassCard>
        ))}
      </div>

      {users.length === 0 && (
        <GlassCard className="p-12 text-center">
          <User className="w-16 h-16 mx-auto mb-4 text-glass-text-secondary" />
          <h3 className="text-xl font-bold text-glass-text mb-2">No users yet</h3>
          <p className="text-glass-text-secondary">Users will appear here once they interact with your bot</p>
        </GlassCard>
      )}
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/pages/CloudPasswordSetup.tsx ------------------------------
import { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { GlassCard } from '../components/ui/GlassCard';
import { GlassButton } from '../components/ui/GlassButton';
import { GlassInput } from '../components/ui/GlassInput';
import { Shield, Zap, Lock } from 'lucide-react';

export const CloudPasswordSetup = () => {
  const { setupCloudPassword } = useAuth();
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (password.length < 8) {
      setError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤');
      return;
    }

    if (password !== confirmPassword) {
      setError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      return;
    }

    setLoading(true);

    try {
      await setupCloudPassword(password);
    } catch (err) {
      setError(err instanceof Error ? err.message : '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞—Ä–æ–ª—è');
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
      <div className="w-full max-w-md relative z-10">
        <GlassCard className="p-8" glow>
          <div className="flex flex-col items-center mb-8">
            <div className="logo-container mb-4">
              <Zap className="w-16 h-16" />
            </div>
            <h1 className="logo-text text-4xl font-bold mb-2">SwiftDevBot</h1>
            <p className="text-glass-text-secondary text-sm">
              –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            </p>
          </div>

          <div className="mb-6 p-4 rounded-xl bg-cyan-500/10 border border-cyan-400/30">
            <div className="flex items-start gap-3">
              <Shield className="w-5 h-5 text-cyan-400 mt-0.5 flex-shrink-0" />
              <div>
                <p className="text-sm font-medium text-glass-text mb-1">
                  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å
                </p>
                <p className="text-xs text-glass-text-secondary">
                  –≠—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–ø–∞–Ω–µ–ª–∏. 
                  –ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω-—Å—Å—ã–ª–∫—É.
                </p>
              </div>
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-5">
            <GlassInput
              label="–û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤"
              required
              minLength={8}
            />

            <GlassInput
              label="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
              type="password"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
              required
              minLength={8}
            />

            {error && (
              <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
                {error}
              </div>
            )}

            <GlassButton
              type="submit"
              variant="primary"
              size="lg"
              className="w-full"
              disabled={loading}
            >
              {loading ? (
                '–£—Å—Ç–∞–Ω–æ–≤–∫–∞...'
              ) : (
                <>
                  <Lock className="w-4 h-4 mr-2" />
                  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
                </>
              )}
            </GlassButton>
          </form>
        </GlassCard>

        <div className="text-center mt-8">
          <p className="footer-text text-sm">
            SwiftDevBot ‚Äî created by <span className="font-semibold">SoverX</span>
          </p>
        </div>
      </div>
    </div>
  );
};




======================================================================

------------------------------ FILE: Systems/web/src/pages/Dashboard.tsx ------------------------------
import { useState } from 'react';
import { Header } from '../components/Header';
import { Sidebar } from '../components/Sidebar';
import { Home } from '../components/sections/Home';
import { Modules } from '../components/sections/Modules';
import { Users } from '../components/sections/Users';
import { Statistics } from '../components/sections/Statistics';
import { Logs } from '../components/sections/Logs';
import { Settings } from '../components/sections/Settings';
import { Docs } from '../components/sections/Docs';
import { Config } from '../components/sections/Config';
import { Services } from '../components/sections/Services';
import { Monitoring } from '../components/sections/Monitoring';

const sections = {
  home: Home,
  modules: Modules,
  users: Users,
  statistics: Statistics,
  logs: Logs,
  settings: Settings,
  docs: Docs,
  config: Config,
  services: Services,
  monitoring: Monitoring,
};

export const Dashboard = () => {
  const [activeSection, setActiveSection] = useState('home');
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const ActiveComponent = sections[activeSection as keyof typeof sections] || Home;

  return (
    <div className="min-h-screen flex">
      <Sidebar
        activeSection={activeSection}
        onSectionChange={setActiveSection}
        isMobileOpen={isMobileMenuOpen}
        onClose={() => setIsMobileMenuOpen(false)}
      />

      <div className="flex-1 flex flex-col min-w-0">
        <Header
          onMenuToggle={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
          isMobileMenuOpen={isMobileMenuOpen}
        />

        <main className="flex-1 p-4 lg:p-8">
          <ActiveComponent />
        </main>

        <footer className="p-4 text-center">
          <p className="footer-text text-sm">
            SwiftDevBot ‚Äî created by <span className="font-semibold">SoverX</span>
          </p>
        </footer>
      </div>
    </div>
  );
};



======================================================================

------------------------------ FILE: Systems/web/src/pages/CloudPasswordPrompt.tsx ------------------------------
import { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { GlassCard } from '../components/ui/GlassCard';
import { GlassButton } from '../components/ui/GlassButton';
import { GlassInput } from '../components/ui/GlassInput';
import { Lock, Zap, Shield } from 'lucide-react';

export const CloudPasswordPrompt = () => {
  const { verifyCloudPassword } = useAuth();
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!password || password.trim() === '') {
      setError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
      return;
    }
    
    setError('');
    setLoading(true);

    try {
      console.log('Verifying cloud password...');
      await verifyCloudPassword(password);
      console.log('Cloud password verified successfully');
      // State will be updated by verifyCloudPassword, which will trigger App re-render
      // Don't set loading to false here - let the component re-render naturally
      setPassword('');
    } catch (err) {
      console.error('Cloud password verification error:', err);
      const errorMessage = err instanceof Error ? err.message : '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
      setError(errorMessage);
      setPassword('');
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
      <div className="w-full max-w-md relative z-10">
        <GlassCard className="p-8" glow>
          <div className="flex flex-col items-center mb-8">
            <div className="logo-container mb-4">
              <Zap className="w-16 h-16" />
            </div>
            <h1 className="logo-text text-4xl font-bold mb-2">SwiftDevBot</h1>
            <p className="text-glass-text-secondary text-sm">
              –í–≤–µ–¥–∏—Ç–µ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å
            </p>
          </div>

          <div className="mb-6 p-4 rounded-xl bg-purple-500/10 border border-purple-400/30">
            <div className="flex items-start gap-3">
              <Shield className="w-5 h-5 text-purple-400 mt-0.5 flex-shrink-0" />
              <div>
                <p className="text-sm font-medium text-glass-text mb-1">
                  –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
                </p>
                <p className="text-xs text-glass-text-secondary">
                  –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –≤–∞—à –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å.
                </p>
              </div>
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-5">
            <GlassInput
              label="–û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å"
              required
              autoFocus
            />

            {error && (
              <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
                {error}
              </div>
            )}

            <GlassButton
              type="submit"
              variant="primary"
              size="lg"
              className="w-full"
              disabled={loading || !password}
            >
              {loading ? (
                '–ü—Ä–æ–≤–µ—Ä–∫–∞...'
              ) : (
                <>
                  <Lock className="w-4 h-4 mr-2" />
                  –í–æ–π—Ç–∏
                </>
              )}
            </GlassButton>
          </form>
        </GlassCard>

        <div className="text-center mt-8">
          <p className="footer-text text-sm">
            SwiftDevBot ‚Äî created by <span className="font-semibold">SoverX</span>
          </p>
        </div>
      </div>
    </div>
  );
};




======================================================================

------------------------------ FILE: Systems/cli/db.py ------------------------------
# cli_commands/db_cmd.py

import asyncio
import os
import subprocess
import sys
from pathlib import Path

import typer
from rich.console import Console
from rich.panel import Panel

console = Console()

db_app = typer.Typer(
    name="db",
    help="üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic.",
    rich_markup_mode="rich",
)

# –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ (__file__)
# Systems/cli/db.py -> Systems/cli/ -> Systems/ -> PROJECT_ROOT
PROJECT_ROOT_FROM_DB_CMD = Path(__file__).resolve().parent.parent.parent
ALEMBIC_INI_PATH_STR = str(PROJECT_ROOT_FROM_DB_CMD / "alembic.ini")


def _run_alembic_command(
    args: list[str], suppress_success_output: bool = False
) -> bool:
    try:
        alembic_ini_actual_path = Path(ALEMBIC_INI_PATH_STR)
        if not alembic_ini_actual_path.is_file():
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alembic '{ALEMBIC_INI_PATH_STR}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]"
            )
            console.print(
                f"  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –ø—É—Ç—å –∫ alembic.ini –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω."
            )
            return False

        command = ["alembic", "-c", ALEMBIC_INI_PATH_STR] + args

        env = os.environ.copy()
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ PYTHONPATH, —á—Ç–æ–±—ã Alembic –º–æ–≥ –Ω–∞–π—Ç–∏ core –∏ Modules
        # –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ env.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB
        existing_python_path = env.get("PYTHONPATH", "")
        project_root_str = str(PROJECT_ROOT_FROM_DB_CMD)

        if existing_python_path:
            # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ project_root_str –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
            path_parts = existing_python_path.split(os.pathsep)
            if project_root_str not in path_parts:
                env["PYTHONPATH"] = (
                    f"{project_root_str}{os.pathsep}{existing_python_path}"
                )
            else:  # –£–∂–µ –µ—Å—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                env["PYTHONPATH"] = existing_python_path
        else:
            env["PYTHONPATH"] = project_root_str

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ sys.path –ø–µ—Ä–µ–¥–∞–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        # (–û–±—ã—á–Ω–æ PYTHONPATH –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
        # current_sys_path_str = os.pathsep.join(s.strip() for s in sys.path if s.strip())
        # env["PYTHONPATH"] = f"{current_sys_path_str}{os.pathsep}{env.get('PYTHONPATH', '')}"

        process = subprocess.run(
            command,
            capture_output=True,
            text=True,
            encoding="utf-8",
            env=env,
            cwd=str(PROJECT_ROOT_FROM_DB_CMD),  # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
        )

        if process.stdout and not (process.returncode == 0 and suppress_success_output):
            console.print(process.stdout.strip())

        if process.stderr:
            is_actual_error_in_stderr = (
                "error" in process.stderr.lower()
                or "fail" in process.stderr.lower()
                or "traceback" in process.stderr.lower()
                or "critical" in process.stderr.lower()
            )

            if process.returncode != 0 or is_actual_error_in_stderr:
                console.print(f"[bold red]Alembic STDERR:[/]\n{process.stderr.strip()}")
            elif not (process.returncode == 0 and suppress_success_output):
                console.print(
                    f"[dim yellow]Alembic STDERR (info/warnings):[/]\n{process.stderr.strip()}"
                )

        if process.returncode != 0:
            console.print(
                f"[bold red]–ö–æ–º–∞–Ω–¥–∞ Alembic –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: {process.returncode}). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ.[/]"
            )
            return False
        return True

    except FileNotFoundError:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ö–æ–º–∞–Ω–¥–∞ 'alembic' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.[/]")
        console.print(
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Alembic —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –≤–∞—à–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º PATH."
        )
        console.print(f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: [cyan]pip install alembic[/]")
        return False
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã Alembic: {e}[/]"
        )
        return False


@db_app.command(
    name="upgrade",
    help="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ 'head', —Ç.–µ. –ø–æ—Å–ª–µ–¥–Ω–µ–π).",
)
def db_upgrade_cmd(
    revision: str = typer.Argument(
        "head",
        help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'head', 'base', specific_id, '+1', '-2').",
    )
):
    console.print(
        f"–ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π Alembic –¥–æ —Ä–µ–≤–∏–∑–∏–∏: [cyan]{revision}[/]..."
    )
    if not _run_alembic_command(["upgrade", revision]):
        raise typer.Exit(code=1)
    console.print(f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db upgrade {revision}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]")


@db_app.command(name="downgrade", help="–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic.")
def db_downgrade_cmd(
    revision: str = typer.Argument(
        "1",
        help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'base', specific_id) –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≤–∏–∑–∏–π –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1' –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π, '2' –¥–ª—è –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö). –î–ª—è –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –æ–¥–Ω—É —Ä–µ–≤–∏–∑–∏—é –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —É–∫–∞–∑–∞—Ç—å '-1'.",
    )
):
    target_revision = revision
    if revision.isdigit():
        target_revision = f"-{revision}"
        description_log = f"–Ω–∞ {revision} —Ä–µ–≤–∏–∑–∏—é(–∏) –Ω–∞–∑–∞–¥ (–¥–æ {target_revision})"
    else:
        description_log = f"–¥–æ —Ä–µ–≤–∏–∑–∏–∏ '{revision}'"

    console.print(f"–ó–∞–ø—É—Å–∫ –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–π Alembic {description_log}...")
    if typer.confirm(
        f"–í—ã [bold red]–£–í–ï–†–ï–ù–´[/], —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ {description_log}? –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.",
        abort=True,
    ):
        if not _run_alembic_command(["downgrade", revision]):
            raise typer.Exit(code=1)
        console.print(
            f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db downgrade {revision}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]"
        )


@db_app.command(name="revision", help="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic.")
def db_revision_cmd(
    message: str = typer.Option(
        ...,
        "-m",
        "--message",
        help="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).",
    ),
    autogenerate: bool = typer.Option(
        True,
        "--autogenerate/--no-autogenerate",
        help="–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).",
    ),
):
    args = ["revision"]
    if autogenerate:
        args.append("--autogenerate")
    args.extend(["-m", message])

    console.print(
        f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ Alembic —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º: '[cyan]{message}[/]' (autogenerate: {autogenerate})..."
    )
    if not _run_alembic_command(args):
        raise typer.Exit(code=1)
    console.print(
        f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db revision' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ù–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ 'alembic_migrations/versions/'.[/]"
    )


@db_app.command(name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∏—Å—Ç–æ—Ä–∏—é.")
def db_status_cmd(
    verbose: bool = typer.Option(
        False, "--verbose", "-v", help="–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥."
    )
):
    """
    –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π Alembic.
    –ù–µ —Ç—Ä–µ–±—É–µ—Ç BOT_TOKEN - Alembic —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î —á–µ—Ä–µ–∑ env.py –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ.
    """
    console.print(
        Panel(
            "[bold blue]–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π Alembic (–∫–æ–º–∞–Ω–¥–∞ 'current')[/]",
            expand=False,
            border_style="blue",
        )
    )
    current_args = ["current"]
    if verbose:
        current_args.append("--verbose")

    success_current = _run_alembic_command(
        current_args, suppress_success_output=verbose
    )
    if not success_current:
        console.print(
            "[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å Alembic (Alembic current).[/yellow]"
        )

    console.print(
        Panel(
            "[bold blue]–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π Alembic (–∫–æ–º–∞–Ω–¥–∞ 'history')[/]",
            expand=False,
            border_style="blue",
            style="blue",
        )
    )
    history_args = ["history"]
    if not _run_alembic_command(history_args):
        console.print(
            "[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π Alembic (Alembic history).[/yellow]"
        )


@db_app.command(
    name="init-core",
    help="[–û–ü–ê–°–ù–û] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é, –º–∏–Ω—É—è Alembic.",
)
def db_init_core_cmd():
    console.print(
        Panel(
            "[bold yellow]–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ SDB –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –Ω–∞–ø—Ä—è–º—É—é[/]",
            expand=False,
            border_style="yellow",
        )
    )
    console.print(
        "[bold red]–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:[/bold red] –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é, –∏–≥–Ω–æ—Ä–∏—Ä—É—è Alembic."
    )
    if typer.confirm(
        "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é?",
        abort=True,
    ):
        try:
            from Systems.core.app_settings import load_app_settings
            from Systems.core.database.manager import DBManager
            from Systems.core.rbac.service import RBACService
            from Systems.core.services_provider import BotServicesProvider
            from Systems.core.module_loader import ModuleLoader

            settings = load_app_settings()

            async def _init_core_data_task_runner():
                nonlocal settings
                console.print(
                    f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–î: {settings.db.type} (URL —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫)."
                )
                db_m = DBManager(db_settings=settings.db, app_settings=settings)
                try:
                    await db_m.initialize()

                    console.print(
                        "–í—ã–∑–æ–≤ DBManager.create_all_core_tables() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞..."
                    )
                    await db_m.create_all_core_tables()
                    console.print(
                        "[bold green]–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).[/]"
                    )

                    console.print("–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π...")
                    # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π BotServicesProvider –¥–ª—è RBACService
                    # (–Ω—É–∂–µ–Ω –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π)
                    services = BotServicesProvider(settings=settings)
                    services._db_manager = db_m
                    
                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ModuleLoader –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π
                    module_loader = ModuleLoader(settings=settings, services_provider=services)
                    module_loader.scan_all_available_modules()
                    services._module_loader = module_loader
                    
                    rbac_s = RBACService(services=services)
                    async with db_m.get_session() as session:
                        roles_count, core_perms_count, mod_perms_count = await rbac_s.ensure_default_entities_exist(session)
                        await session.commit()
                        
                        if roles_count > 0 or core_perms_count > 0 or mod_perms_count > 0:
                            console.print(
                                f"[bold green]–£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ: {roles_count} —Ä–æ–ª–µ–π, {core_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞, {mod_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π.[/bold green]"
                            )
                        else:
                            console.print(
                                "[dim]–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –∏–ª–∏ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ RBACService).[/dim]"
                            )
                except Exception as e_task:
                    console.print(
                        f"[bold red]–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e_task}[/]"
                    )
                    import traceback
                    console.print(f"[dim]{traceback.format_exc()}[/]")
                    raise
                finally:
                    await db_m.dispose()

            asyncio.run(_init_core_data_task_runner())
            console.print("\n[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db init-core' —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.[/]")
            console.print(
                "[yellow]–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ Alembic —Ä–∞–Ω–µ–µ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.[/]"
            )
            console.print(
                "  [yellow]–í–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å 'sdb db stamp head', —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Alembic —Å —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–æ–π –ë–î.[/]"
            )
            console.print(
                "  [yellow]–î–µ–ª–∞–π—Ç–µ —ç—Ç–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ë–î —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–µ–≤–æ–π '–≥–æ–ª–æ–≤–æ–π'.[/]"
            )

        except ImportError as e_imp:
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —è–¥—Ä–∞ –¥–ª—è 'db init-core': {e_imp}[/]"
            )
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ 'db init-core': {e}[/]")
            raise typer.Exit(code=1)


@db_app.command(
    name="stamp", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é Alembic –≤ –ë–î, –Ω–µ –ø—Ä–∏–º–µ–Ω—è—è –º–∏–≥—Ä–∞—Ü–∏–∏."
)
def db_stamp_cmd(
    revision: str = typer.Argument(
        ..., help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'head', 'base', specific_id)."
    ),
    purge: bool = typer.Option(
        False,
        "--purge",
        help="–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤–µ—Ä—Å–∏–π Alembic –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!).",
    ),
):
    console.print(
        f"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–≤–∏–∑–∏–∏ Alembic: [cyan]{revision}[/]"
        + ("[bold yellow] —Å –æ—á–∏—Å—Ç–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤–µ—Ä—Å–∏–π[/]" if purge else "")
    )
    if purge:
        if not typer.confirm(
            f"[bold red]–í–ù–ò–ú–ê–ù–ò–ï: –û–ø—Ü–∏—è --purge –£–î–ê–õ–ò–¢ –í–°–ï –ó–ê–ü–ò–°–ò –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤–µ—Ä—Å–∏–π Alembic –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ä–µ–≤–∏–∑–∏–∏ '{revision}'. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ë–î. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
            abort=True,
        ):
            return

    args = ["stamp"]
    if purge:
        args.append("--purge")
    args.append(revision)

    if not _run_alembic_command(args):
        raise typer.Exit(code=1)
    console.print(
        f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db stamp {revision}{' --purge' if purge else ''}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]"
    )



======================================================================

------------------------------ FILE: Systems/cli/user.py ------------------------------
# cli_commands/user_cmd.py

import asyncio
from typing import Any, List, Optional, Tuple

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.text import Text  # –î–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞

from .utils import get_sdb_services_for_cli  # –ù–∞—à–∞ —É—Ç–∏–ª–∏—Ç–∞

console = Console()
user_app = typer.Typer(
    name="user",
    help="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ SDB –∏ –∏—Ö —Ä–æ–ª—è–º–∏ (RBAC).",
    rich_markup_mode="rich",
)

# --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥ ---


async def _list_users_cmd_async(limit: int, offset: int, sort_by: str, sort_desc: bool):
    panel_title = "[bold blue]–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SwiftDevBot[/]"
    db_m = None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        async with db_m.get_session() as session:
            from sqlalchemy import asc, desc
            from sqlalchemy import func as sql_func
            from sqlalchemy import select
            from sqlalchemy.orm import selectinload

            from Systems.core.database.core_models import User

            count_stmt = select(sql_func.count(User.id))
            total_users_result = await session.execute(count_stmt)
            total_users = total_users_result.scalar_one_or_none() or 0

            if total_users == 0:
                console.print(
                    Panel(
                        "[yellow]–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.[/yellow]",
                        title=panel_title,
                    )
                )
                return

            # –õ–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            order_column = getattr(
                User, sort_by, User.id
            )  # –î–µ—Ñ–æ–ª—Ç –ø–æ id, –µ—Å–ª–∏ –∞—Ç—Ä–∏–±—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            order_expression = desc(order_column) if sort_desc else asc(order_column)

            stmt = (
                select(User)
                .options(selectinload(User.roles))
                .order_by(order_expression)
                .limit(limit)
                .offset(offset)
            )
            result = await session.execute(stmt)
            users: List[User] = list(result.scalars().all())

            if (
                not users and total_users > 0
            ):  # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–æ –Ω–µ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                console.print(
                    Panel(
                        f"[yellow]–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (—Å–º–µ—â–µ–Ω–∏–µ {offset}, –ª–∏–º–∏—Ç {limit}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç, –Ω–æ –≤—Å–µ–≥–æ –≤ –ë–î: {total_users}.[/yellow]",
                        title=panel_title,
                    )
                )
                return
            elif not users:  # –≠—Ç–æ —É—Å–ª–æ–≤–∏–µ —É–∂–µ –ø–æ–∫—Ä—ã—Ç–æ –≤—ã—à–µ, –Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                console.print(
                    Panel(
                        "[yellow]–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.[/yellow]",
                        title=panel_title,
                    )
                )
                return

            table_title = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ SDB (–ü–æ–∫–∞–∑–∞–Ω–æ: {len(users)} –∏–∑ {total_users}, –õ–∏–º–∏—Ç: {limit}, –°–º–µ—â–µ–Ω–∏–µ: {offset}, –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: {sort_by} {'DESC' if sort_desc else 'ASC'})"
            table = Table(
                title=table_title,
                show_header=True,
                header_style="bold magenta",
                expand=True,
            )
            table.add_column("DB ID", style="dim cyan", justify="right", no_wrap=True)
            table.add_column("TG ID", style="cyan", justify="right", no_wrap=True)
            table.add_column("–ü–æ–ª–Ω–æ–µ –ò–º—è", min_width=20)
            table.add_column("Username", style="yellow", no_wrap=True)
            table.add_column("–†–æ–ª–∏", min_width=15)
            table.add_column("–Ø–∑—ã–∫", justify="center", no_wrap=True)
            table.add_column("–ê–∫—Ç–∏–≤–µ–Ω", justify="center", no_wrap=True)
            table.add_column("–ë–æ—Ç –±–ª–æ–∫.", justify="center", no_wrap=True)
            table.add_column("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", no_wrap=True)
            table.add_column("–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", no_wrap=True)

            for user_obj in users:
                roles_str = (
                    ", ".join(sorted([role.name for role in user_obj.roles]))
                    if user_obj.roles
                    else "-"
                )
                active_str = "‚úÖ" if user_obj.is_active else "‚ùå"
                blocked_str = "üö´" if user_obj.is_bot_blocked else "‚úÖ"
                created_at_str = (
                    user_obj.created_at.strftime("%Y-%m-%d %H:%M")
                    if user_obj.created_at
                    else "-"
                )
                last_activity_str = (
                    user_obj.last_activity_at.strftime("%Y-%m-%d %H:%M")
                    if user_obj.last_activity_at
                    else "-"
                )

                table.add_row(
                    str(user_obj.id),
                    str(user_obj.telegram_id),
                    user_obj.full_name,
                    f"@{user_obj.username}" if user_obj.username else "-",
                    roles_str,
                    user_obj.preferred_language_code or "-",
                    active_str,
                    blocked_str,
                    created_at_str,
                    last_activity_str,
                )
            console.print(
                Panel(table, title=panel_title, border_style="blue", padding=(1, 1))
            )
    except Exception as e:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user list': {type(e).__name__} - {e}[/]"
        )
        raise
    finally:
        if db_m:
            await db_m.dispose()


async def _find_user_interactive(
    session: Any, identifier: str
) -> Optional[Any]:  # User
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –∏–ª–∏ username."""
    from sqlalchemy import select
    from sqlalchemy.orm import selectinload

    from Systems.core.database.core_models import User

    user: Optional[User] = None
    if identifier.isdigit():
        user_id_int = int(identifier)
        stmt = (
            select(User)
            .options(selectinload(User.roles))
            .where(User.telegram_id == user_id_int)
        )
        result = await session.execute(stmt)
        user = result.scalars().first()
        if user:
            return user
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ TG ID, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ DB ID
        stmt_db_id = (
            select(User).options(selectinload(User.roles)).where(User.id == user_id_int)
        )
        result_db_id = await session.execute(stmt_db_id)
        user = result_db_id.scalars().first()
        if user:
            return user

    # –ï—Å–ª–∏ –Ω–µ —á–∏—Å–ª–æ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ ID, –∏—â–µ–º –ø–æ username (–±–µ–∑ @)
    username_to_search = identifier.lstrip("@")
    stmt_uname = (
        select(User)
        .options(selectinload(User.roles))
        .where(User.username_lower == username_to_search.lower())
    )
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞ username_lower –∏–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ILIKE –¥–ª—è PostgreSQL/–¥—Ä—É–≥–∏—Ö –ë–î
    # –î–ª—è SQLite —ç—Ç–æ –±—É–¥–µ—Ç WHERE lower(username) = lower(:username_to_search)
    # –ß—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∫—Ä–æ—Å—Å-–°–£–ë–î –±–µ–∑ ILIKE, –ª—É—á—à–µ –∏–º–µ—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ username_lower –∏–ª–∏ –¥–µ–ª–∞—Ç—å lower() –≤ –∑–∞–ø—Ä–æ—Å–µ
    # stmt_uname = select(User).options(selectinload(User.roles)).where(func.lower(User.username) == username_to_search.lower())
    result_uname = await session.execute(stmt_uname)
    user = result_uname.scalars().first()
    return user


async def _info_user_cmd_async(user_identifier: str):
    db_m = None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        async with db_m.get_session() as session:
            user = await _find_user_interactive(session, user_identifier)

            if not user:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.[/]"
                )
                raise typer.Exit(code=1)

            panel_title = f"[bold blue]–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: {user.full_name} (TG ID: {user.telegram_id})[/]"
            info_text = Text()
            info_text.append(f"DB ID: {user.id}\n", style="bold")
            info_text.append(f"Telegram ID: {user.telegram_id}\n", style="bold")
            info_text.append(f"–ü–æ–ª–Ω–æ–µ –∏–º—è: {user.full_name}\n")
            info_text.append(
                f"Username: @{user.username}\n" if user.username else "Username: -\n"
            )
            info_text.append(
                f"–Ø–∑—ã–∫ –±–æ—Ç–∞: {user.preferred_language_code or '(–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)'}\n"
            )
            info_text.append(
                f"–ê–∫—Ç–∏–≤–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ: {'–î–∞ ‚úÖ' if user.is_active else '–ù–µ—Ç ‚ùå'}\n"
            )
            info_text.append(
                f"–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {'–î–∞ üö´' if user.is_bot_blocked else '–ù–µ—Ç ‚úÖ'}\n"
            )
            created_at_str = (
                user.created_at.strftime("%Y-%m-%d %H:%M:%S %Z")
                if user.created_at and user.created_at.tzinfo
                else (
                    user.created_at.strftime("%Y-%m-%d %H:%M:%S")
                    if user.created_at
                    else "-"
                )
            )
            updated_at_str = (
                user.updated_at.strftime("%Y-%m-%d %H:%M:%S %Z")
                if user.updated_at and user.updated_at.tzinfo
                else (
                    user.updated_at.strftime("%Y-%m-%d %H:%M:%S")
                    if user.updated_at
                    else "-"
                )
            )
            last_activity_str = (
                user.last_activity_at.strftime("%Y-%m-%d %H:%M:%S %Z")
                if user.last_activity_at and user.last_activity_at.tzinfo
                else (
                    user.last_activity_at.strftime("%Y-%m-%d %H:%M:%S")
                    if user.last_activity_at
                    else " (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)"
                )
            )
            info_text.append(f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {created_at_str}\n")
            info_text.append(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {updated_at_str}\n")
            info_text.append(f"–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {last_activity_str}\n")
            roles_str = (
                ", ".join(sorted([role.name for role in user.roles]))
                if user.roles
                else " (–Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π)"
            )
            info_text.append(f"–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {roles_str}\n", style="bold")

            console.print(
                Panel(info_text, title=panel_title, border_style="blue", padding=1)
            )
    finally:
        if db_m:
            await db_m.dispose()


async def _list_roles_cmd_async():
    panel_title = "[bold blue]–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ SDB[/]"
    db_m, rbac_s = None, None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        # –°–æ–∑–¥–∞–µ–º RBACService —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        from Systems.core.rbac.service import RBACService

        rbac_s = RBACService(services=None, db_manager=db_m)

        async with db_m.get_session() as session:
            from Systems.core.database.core_models import \
                Role  # Role —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ RBACService

            all_roles: List[Role] = await rbac_s.get_all_roles(session)

            if not all_roles:
                console.print(
                    Panel(
                        "[yellow]–í —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π.[/yellow]",
                        title=panel_title,
                    )
                )
                return

            table = Table(
                title="–°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–æ–ª–∏ SDB",
                show_header=True,
                header_style="bold magenta",
                expand=True,
            )
            table.add_column("DB ID", style="dim cyan", justify="right", no_wrap=True)
            table.add_column("–ò–º—è –†–æ–ª–∏", style="cyan", min_width=15)
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", min_width=30, max_width=70, overflow="fold")

            for role_obj in all_roles:
                table.add_row(
                    str(role_obj.id),
                    role_obj.name,
                    role_obj.description if role_obj.description else "-",
                )
            console.print(
                Panel(table, title=panel_title, border_style="blue", padding=(1, 1))
            )
    finally:
        if db_m:
            await db_m.dispose()


async def _assign_role_cmd_async(user_identifier: str, role_name: str):
    console.print(
        f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å [cyan]'{role_name}'[/] –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é [cyan]'{user_identifier}'[/]..."
    )
    db_m, rbac_s = None, None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        # –°–æ–∑–¥–∞–µ–º RBACService —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        from Systems.core.rbac.service import RBACService

        rbac_s = RBACService(services=None, db_manager=db_m)

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]"
                )
                raise typer.Exit(code=1)

            if await rbac_s.assign_role_to_user(session, user_obj, role_name):
                await session.commit()
                console.print(
                    f"[bold green]–†–æ–ª—å '{role_name}' —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_obj.telegram_id} (@{user_obj.username}).[/]"
                )
            else:
                # RBACService –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏
                console.print(
                    f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å '{role_name}' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_obj.telegram_id}. "
                    "–í–æ–∑–º–æ–∂–Ω–æ, —Ä–æ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ (—Å–º. –ª–æ–≥–∏).[/]"
                )
                # –ù–µ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å rollback –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ assign_role_to_user –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å –≤ —Å–µ—Å—Å–∏—é, –Ω–æ –Ω–µ UserRole
                raise typer.Exit(code=1)
    finally:
        if db_m:
            await db_m.dispose()


async def _remove_role_cmd_async(user_identifier: str, role_name: str):
    console.print(
        f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å —Ä–æ–ª—å [cyan]'{role_name}'[/] —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [cyan]'{user_identifier}'[/]..."
    )
    db_m, rbac_s = None, None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        # –°–æ–∑–¥–∞–µ–º RBACService —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        from Systems.core.rbac.service import RBACService

        rbac_s = RBACService(services=None, db_manager=db_m)

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]"
                )
                raise typer.Exit(code=1)

            if await rbac_s.remove_role_from_user(session, user_obj, role_name):
                await session.commit()
                console.print(
                    f"[bold green]–†–æ–ª—å '{role_name}' —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id} (@{user_obj.username}).[/]"
                )
            else:
                console.print(
                    f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–æ–ª—å '{role_name}' —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id}. "
                    "–í–æ–∑–º–æ–∂–Ω–æ, —Ä–æ–ª—å –Ω–µ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ (—Å–º. –ª–æ–≥–∏).[/]"
                )
                raise typer.Exit(code=1)
    finally:
        if db_m:
            await db_m.dispose()


async def _block_user_cmd_async(user_identifier: str, reason: str):
    console.print(f"–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [cyan]'{user_identifier}'[/]...")
    if reason:
        console.print(f"–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: [yellow]{reason}[/]")

    db_m, core_settings = None, None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ë–î + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ core –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ super_admins
        from .utils import get_db_with_core_config_for_cli

        db_m, core_settings = await get_db_with_core_config_for_cli()

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]"
                )
                raise typer.Exit(code=1)

            if user_obj.telegram_id in core_settings.super_admins:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã![/]"
                )
                raise typer.Exit(code=1)

            if user_obj.is_bot_blocked:
                console.print(
                    f"[bold yellow]–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_obj.telegram_id} —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.[/]"
                )
                return

            from Systems.core.users.service import UserService

            user_service = UserService(
                services_provider=None
            )  # –°–æ–∑–¥–∞–µ–º –±–µ–∑ services_provider –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

            if await user_service.set_user_bot_blocked_status(user_obj, True, session):
                await session.commit()
                console.print(
                    f"[bold green]–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_obj.telegram_id} (@{user_obj.username or '–±–µ–∑ username'}) —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.[/]"
                )
                if reason:
                    console.print(f"–ü—Ä–∏—á–∏–Ω–∞: [yellow]{reason}[/]")
            else:
                console.print(
                    f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id}.[/]"
                )
                raise typer.Exit(code=1)
    finally:
        if db_m:
            await db_m.dispose()


async def _unblock_user_cmd_async(user_identifier: str):
    console.print(
        f"–ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [cyan]'{user_identifier}'[/]..."
    )
    db_m = None
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–∞
        from .utils import get_db_only_for_cli

        db_m = await get_db_only_for_cli()

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(
                    f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]"
                )
                raise typer.Exit(code=1)

            if not user_obj.is_bot_blocked:
                console.print(
                    f"[bold yellow]–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_obj.telegram_id} –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.[/]"
                )
                return

            from Systems.core.users.service import UserService

            user_service = UserService(
                services_provider=None
            )  # –°–æ–∑–¥–∞–µ–º –±–µ–∑ services_provider –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

            if await user_service.set_user_bot_blocked_status(user_obj, False, session):
                await session.commit()
                console.print(
                    f"[bold green]–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_obj.telegram_id} (@{user_obj.username or '–±–µ–∑ username'}) —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.[/]"
                )
            else:
                console.print(
                    f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id}.[/]"
                )
                raise typer.Exit(code=1)
    finally:
        if db_m:
            await db_m.dispose()


# --- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è Typer ---


@user_app.command(
    name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SDB –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."
)
def list_users_cmd_wrapper(
    limit: int = typer.Option(
        20,
        "--limit",
        "-l",
        help="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.",
        min=1,
        max=200,
    ),
    offset: int = typer.Option(
        0, "--offset", "-o", help="–°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", min=0
    ),
    sort_by: str = typer.Option(
        "id",
        "--sort-by",
        help="–ü–æ–ª–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (id, telegram_id, username, first_name, last_name, created_at, last_activity_at).",
        case_sensitive=False,
    ),
    desc: bool = typer.Option(False, "--desc", help="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é."),
):
    valid_sort_fields = [
        "id",
        "telegram_id",
        "username",
        "first_name",
        "last_name",
        "created_at",
        "last_activity_at",
    ]
    if sort_by.lower() not in valid_sort_fields:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è --sort-by: '{sort_by}'.[/]"
        )
        console.print(f"–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: {', '.join(valid_sort_fields)}")
        raise typer.Exit(code=1)
    try:
        asyncio.run(
            _list_users_cmd_async(
                limit=limit, offset=offset, sort_by=sort_by.lower(), sort_desc=desc
            )
        )
    except Exception as e:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user list': {type(e).__name__} - {e}[/]"
        )
        # console.print_exception(show_locals=True) # –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        raise typer.Exit(code=1)


@user_app.command(
    name="info",
    help="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –µ–≥–æ Telegram ID, DB ID –∏–ª–∏ Username.",
)
def info_user_cmd_wrapper(
    user_identifier: str = typer.Argument(
        ..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    )
):
    try:
        asyncio.run(_info_user_cmd_async(user_identifier=user_identifier))
    except typer.Exit:  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º Exit, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        raise
    except Exception as e:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user info': {type(e).__name__} - {e}[/]"
        )
        raise typer.Exit(code=1)


@user_app.command(name="roles", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ.")
def list_roles_cmd_wrapper():
    try:
        asyncio.run(_list_roles_cmd_async())
    except Exception as e:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user roles': {type(e).__name__} - {e}[/]"
        )
        raise typer.Exit(code=1)


@user_app.command(name="assign-role", help="–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.")
def assign_role_cmd_wrapper(
    user_identifier: str = typer.Argument(
        ..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    ),
    role_name: str = typer.Argument(
        ..., help="–ò–º—è —Ä–æ–ª–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Admin', 'User')."
    ),
):
    try:
        asyncio.run(
            _assign_role_cmd_async(user_identifier=user_identifier, role_name=role_name)
        )
    except typer.Exit:
        raise
    except Exception as e:
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ _assign_role_cmd_async
        raise typer.Exit(code=1)


@user_app.command(name="remove-role", help="–°–Ω—è—Ç—å —Ä–æ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
@user_app.command(name="block", help="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ.")
@user_app.command(name="unblock", help="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ.")
def remove_role_cmd_wrapper(
    user_identifier: str = typer.Argument(
        ..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    ),
    role_name: str = typer.Argument(..., help="–ò–º—è —Ä–æ–ª–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è."),
):
    try:
        asyncio.run(
            _remove_role_cmd_async(user_identifier=user_identifier, role_name=role_name)
        )
    except typer.Exit:
        raise
    except Exception as e:
        raise typer.Exit(code=1)


@user_app.command(name="block", help="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ.")
def block_user_cmd_wrapper(
    user_identifier: str = typer.Argument(
        ..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    ),
    reason: str = typer.Option(
        "", "--reason", "-r", help="–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)."
    ),
):
    try:
        asyncio.run(
            _block_user_cmd_async(user_identifier=user_identifier, reason=reason)
        )
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/bold red]")
        raise typer.Exit(code=1)


@user_app.command(name="unblock", help="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ.")
def unblock_user_cmd_wrapper(
    user_identifier: str = typer.Argument(
        ..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
    )
):
    try:
        asyncio.run(_unblock_user_cmd_async(user_identifier=user_identifier))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/bold red]")
        raise typer.Exit(code=1)



======================================================================

------------------------------ FILE: Systems/cli/run.py ------------------------------
# --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê cli/run.py ---
import asyncio
import os
import subprocess
import sys
import time
from pathlib import Path

import typer
from loguru import logger as global_logger
from rich.panel import Panel

from .process import (PID_FILENAME,  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
                      _is_process_running)

sdb_console = None  # –ë—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –≤ sdb.py


def run_command(
    debug: bool = typer.Option(
        False,
        "--debug",
        "-d",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ (—É–≤–µ–ª–∏—á–∏—Ç —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ DEBUG).",
    ),
    verbose: bool = typer.Option(
        False,
        "--verbose",
        "-v",
        help="–ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–æ–¥—É–ª–µ, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å—Ç—Ä–æ–∫–µ.",
    ),
    background: bool = typer.Option(
        False,
        "--background",
        "-b",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–º–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å).",
    ),
):
    """
    üöÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Telegram –±–æ—Ç–∞ SDB.
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —É—Å–∫–æ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫ CLI
    from Systems.core.app_settings import settings
    from Systems.core.bot_entrypoint import run_sdb_bot

    global sdb_console
    if sdb_console is None:
        from rich.console import Console

        sdb_console = Console()

    project_root = Path(__file__).resolve().parent.parent
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    pid_file_path = settings.core.project_data_path / PID_FILENAME

    if pid_file_path.exists():
        try:
            with open(pid_file_path, "r") as f:
                pid = int(f.read().strip())
            if _is_process_running(pid):
                sdb_console.print(
                    f"[yellow]‚ö° SDB Core —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω (PID: {pid}). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'sdb stop' –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.[/yellow]"
                )
                raise typer.Exit(code=1)
        except (OSError, ValueError):
            sdb_console.print(
                f"[yellow]üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª ({pid_file_path}). –û—á–∏—Å—Ç–∫–∞...[/yellow]"
            )
            pid_file_path.unlink(missing_ok=True)
        except Exception as e_pid_check:
            sdb_console.print(
                f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PID-—Ñ–∞–π–ª–∞: {e_pid_check}[/red]"
            )

    if debug:
        sdb_console.print(
            Panel(
                f"[bold yellow]–ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ DEBUG.[/]",
                title="SDB Run (Debug Mode Requested)",
                expand=False,
                border_style="yellow",
            )
        )
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "true"
    else:
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "false"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ verbose –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    if verbose:
        os.environ["SDB_VERBOSE"] = "true"
    else:
        os.environ["SDB_VERBOSE"] = "false"

    if background:
        if sys.platform == "win32":
            sdb_console.print(
                "[bold red]–§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (-b/--background) –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Windows —á–µ—Ä–µ–∑ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.[/bold red]"
            )
            sdb_console.print(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –±–µ–∑ —Ñ–ª–∞–≥–∞ -b –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏."
            )
            raise typer.Exit(code=1)

        sdb_console.print(
            Panel(
                "[bold blue]üöÄ –ó–∞–ø—É—Å–∫ SDB Core –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...[/]",
                title="SDB Core (Background)",
                expand=False,
                border_style="blue",
            )
        )

        run_bot_script_path = project_root / "run_bot.py"

        env_for_subprocess = os.environ.copy()
        env_for_subprocess["SDB_SHOULD_WRITE_PID"] = "true"
        # –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ verbose –≤ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
        env_for_subprocess["SDB_VERBOSE"] = "true" if verbose else "false"

        try:
            process = subprocess.Popen(
                [sys.executable, str(run_bot_script_path)],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                start_new_session=True,
                env=env_for_subprocess,
            )
            sdb_console.print(
                f"‚ö° SDB Core –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ (—Å–∏—Å—Ç–µ–º–Ω—ã–π PID: {process.pid})."
            )
            sdb_console.print(
                f"–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è PID-—Ñ–∞–π–ª–∞ '{PID_FILENAME}' (–¥–æ 10 —Å–µ–∫—É–Ω–¥)..."
            )

            pid_file_created_successfully = False
            for i in range(10):
                time.sleep(1)
                if pid_file_path.exists():
                    try:
                        actual_pid_from_file_str = pid_file_path.read_text().strip()
                        if actual_pid_from_file_str.isdigit():
                            actual_pid_from_file = int(actual_pid_from_file_str)
                            sdb_console.print(
                                f"[green]PID-—Ñ–∞–π–ª {pid_file_path} —Å–æ–∑–¥–∞–Ω. PID –±–æ—Ç–∞: {actual_pid_from_file}.[/green]"
                            )
                            sdb_console.print(
                                "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]sdb status[/cyan]"
                            )
                            sdb_console.print(
                                "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]sdb stop[/cyan]"
                            )
                            pid_file_created_successfully = True
                            break
                    except (ValueError, IOError) as e_read_pid:
                        sdb_console.print(
                            f"[yellow]–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PID –∏–∑ —Ñ–∞–π–ª–∞ ({e_read_pid}). –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]"
                        )

            if not pid_file_created_successfully:
                sdb_console.print(
                    f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: PID-—Ñ–∞–π–ª –Ω–µ –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–Ω/–ø—Ä–æ—á–∏—Ç–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥.[/yellow]"
                )
                sdb_console.print(
                    f"  –í–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."
                )
                sdb_console.print(
                    f"  –°–∏—Å—Ç–µ–º–Ω—ã–π PID: {process.pid}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é."
                )

        except Exception as e_popen:
            sdb_console.print(
                f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ: {e_popen}[/bold red]"
            )
            raise typer.Exit(code=1)
    else:
        if not debug:
            sdb_console.print(
                Panel(
                    "[bold green]–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ SDB...[/]",
                    title="SDB Run",
                    expand=False,
                    border_style="green",
                )
            )
        try:
            os.environ["SDB_SHOULD_WRITE_PID"] = "false"

            bot_coroutine = run_sdb_bot()
            exit_code = asyncio.run(bot_coroutine)

            if exit_code != 0:
                sdb_console.print(
                    f"[bold red]–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏: {exit_code}[/]"
                )
                sys.exit(exit_code)
            else:
                sdb_console.print("[bold green]–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.[/]")

        except KeyboardInterrupt:
            sdb_console.print(
                "\n[bold orange_red1]ü§ñ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C).[/]"
            )
            sys.exit(0)
        except Exception as e:
            sdb_console.print(
                Panel(
                    f"[bold red]–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:[/]\n{e}",
                    title="SDB Runtime Error",
                    border_style="red",
                    expand=True,
                )
            )
            global_logger.opt(exception=e).critical(
                "–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ cli/run.py"
            )
            sys.exit(1)


# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê cli/run.py ---



======================================================================

------------------------------ FILE: Systems/cli/backup.py ------------------------------
# --- –§–∞–π–ª: cli/backup_unified.py ---
import hashlib
import json
import os
import shutil
import subprocess
import tarfile
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional, Union
from typing import Tuple as TypingTuple
from urllib.parse import urlparse

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

from .utils import confirm_action, sdb_console

backup_app = typer.Typer(
    name="backup",
    help="üíæ –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±—ç–∫–∞–ø–æ–≤ —Å —Ö–µ—à–∞–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ë–î –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º",
    no_args_is_help=True,
)

console = Console()

# === –ö–û–ù–°–¢–ê–ù–¢–´ ===
DB_BACKUP_DIR_NAME = "database"
FILES_BACKUP_DIR_NAME = "files"
DATA_ARCHIVE_EXTENSION = ".tar.gz"
POSTGRES_BACKUP_FILENAME = "postgres_dump.sql"
MYSQL_BACKUP_FILENAME = "mysql_dump.sql"
USER_CONFIG_DIR_NAME_FOR_BACKUP_DEFAULT = "Config"


# === –£–¢–ò–õ–ò–¢–´ –•–ï–®–ò–†–û–í–ê–ù–ò–Ø ===
def sha256(file_path: Path, chunk_size: int = 65536) -> str:
    """–í—ã—á–∏—Å–ª—è–µ—Ç SHA256 —Ö–µ—à —Ñ–∞–π–ª–∞."""
    h = hashlib.sha256()
    with open(file_path, "rb") as f:
        for chunk in iter(lambda: f.read(chunk_size), b""):
            h.update(chunk)
    return h.hexdigest()


def scan_directory(path: Path, excludes: Optional[List[str]] = None) -> dict[str, str]:
    """–°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Å–æ–∑–¥–∞–µ—Ç —Ö–µ—à–∏ —Ñ–∞–π–ª–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
    import fnmatch
    
    hashes = {}
    excludes = excludes or []
    
    for file in path.rglob("*"):
        if file.is_file():
            rel_path = file.relative_to(path).as_posix()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            excluded = False
            for exclude in excludes:
                # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å –∑–≤–µ–∑–¥–æ—á–∫–æ–π (*.pyc, *.log –∏ —Ç.–¥.)
                if "*" in exclude:
                    if fnmatch.fnmatch(rel_path, exclude) or fnmatch.fnmatch(file.name, exclude):
                        excluded = True
                        break
                # –ü–æ–ª–Ω—ã–µ –ø—É—Ç–∏ (Data/Cache_data)
                elif "/" in exclude:
                    if rel_path.startswith(exclude) or rel_path == exclude:
                        excluded = True
                        break
                # –ò–º–µ–Ω–∞ –ø–∞–ø–æ–∫ –∏–ª–∏ —Ñ–∞–π–ª–æ–≤
                else:
                    path_parts = rel_path.split("/")
                    if exclude in path_parts or exclude == file.name:
                        excluded = True
                        break
            
            if excluded:
                continue
                
            hashes[rel_path] = sha256(file)
    return hashes


# === –£–¢–ò–õ–ò–¢–´ –ë–î ===
def _get_backup_base_dir() -> Optional[Path]:
    """–ü–æ–ª—É—á–∞–µ—Ç –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤."""
    try:
        project_root = Path(__file__).resolve().parent.parent
        backup_dir = project_root / "backup"
        backup_dir.mkdir(parents=True, exist_ok=True)
        return backup_dir
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤: {e}[/]")
        return None


def _find_system_utility(name: str) -> Optional[str]:
    """–ù–∞—Ö–æ–¥–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é —É—Ç–∏–ª–∏—Ç—É."""
    return shutil.which(name)


def _execute_system_command(
    command: List[str],
    env_vars: Optional[dict] = None,
    input_data: Optional[str] = None,
    show_stdout_on_success: bool = False,
) -> bool:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É."""
    full_env = os.environ.copy()
    if env_vars:
        full_env.update(env_vars)

    try:
        result = subprocess.run(
            command,
            env=full_env,
            input=input_data,
            text=True,
            capture_output=True,
            check=True,
        )

        if show_stdout_on_success and result.stdout.strip():
            console.print(result.stdout.strip())

        return True
    except subprocess.CalledProcessError as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: {e}[/]")
        if e.stderr:
            console.print(f"[red]{e.stderr}[/]")
        return False
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        return False


# === –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ===


@backup_app.command("create")
def create_backup(
    backup_type: str = typer.Option(
        "full", "--type", "-t", help="–¢–∏–ø –±—ç–∫–∞–ø–∞: full, files, db, custom"
    ),
    dest: Optional[Path] = typer.Option(
        None, "--dest", "-d", help="–ü–∞–ø–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –±—ç–∫–∞–ø–∞"
    ),
    compress: bool = typer.Option(
        True, "--compress/--no-compress", help="–°–∂–∏–º–∞—Ç—å –∞—Ä—Ö–∏–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ)"
    ),
    verify_hashes: bool = typer.Option(
        True,
        "--verify-hashes/--no-verify-hashes",
        help="–°–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ö–µ—à–∏ —Ñ–∞–π–ª–æ–≤",
    ),
    exclude: Optional[List[str]] = typer.Option(
        None, "--exclude", "-x", help="–ò—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏"
    ),
    include_data_dirs: Optional[List[str]] = typer.Option(
        None, "--data-dir", "-dd", help=f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–∑ Data –¥–ª—è –±—ç–∫–∞–ø–∞"
    ),
    db_url: Optional[str] = typer.Option(None, "--db-url", help="URL –ë–î –¥–ª—è –±—ç–∫–∞–ø–∞"),
):
    """üöÄ –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –±—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤ –∏/–∏–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""
    import time

    start_time = time.time()

    console.print(f"[bold cyan]üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–∏–ø–∞: {backup_type.upper()}[/]")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if backup_type == "custom" and dest:
        # –î–ª—è custom –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª—é–±—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        project_root = Path(__file__).resolve().parent.parent
        source_path = project_root
    else:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
        project_root = Path(__file__).resolve().parent.parent
        source_path = project_root

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –±—ç–∫–∞–ø–∞
    scope_analysis = analyze_backup_scope(source_path)

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    for warning in scope_analysis["warnings"]:
        console.print(f"[yellow]{warning}[/]")

    for recommendation in scope_analysis["recommendations"]:
        console.print(f"[blue]{recommendation}[/]")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –≤–∫–ª—é—á–∞—Ç—å
    include_files = backup_type in ["full", "files", "custom"]
    include_db = backup_type in ["full", "db"]

    # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_base_dir = _get_backup_base_dir()
    if not backup_base_dir:
        return

    # –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    working_name = f"unified_{backup_type}_{timestamp}"
    if compress:
        temp_target = backup_base_dir / f"temp_{working_name}"
        final_target = dest or backup_base_dir / f"{working_name}.tar.gz"
        temp_target.mkdir(parents=True, exist_ok=True)
        working_target = temp_target
    else:
        final_target = dest or backup_base_dir / working_name
        final_target = Path(final_target).expanduser().resolve()
        final_target.mkdir(parents=True, exist_ok=True)
        working_target = final_target

    console.print(f"[dim]üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: {final_target}[/]")

    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±—ç–∫–∞–ø–∞
    backup_metadata = {
        "type": f"unified_{backup_type}",
        "timestamp": timestamp,
        "includes_files": include_files,
        "includes_db": include_db,
        "compressed": compress,
        "verify_hashes": verify_hashes,
        "creation_time": datetime.now().isoformat() + "Z",
        "excluded_patterns": [],  # –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∑–∂–µ
        "files": {},
        "database": {},
    }

    total_size = 0
    files_count = 0

    # === –≠–¢–ê–ü 1: –§–ê–ô–õ–´ ===
    if include_files:
        console.print(f"\n[cyan]üìÅ –≠—Ç–∞–ø 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤[/]")

        project_root = Path(__file__).resolve().parent.parent

        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–∫—ç—à, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã)
        auto_excludes = [
            # Git –∏ VCS
            ".git",
            ".gitignore",
            ".gitattributes",
            ".hg",
            ".svn",
            
            # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Python
            ".venv",
            "venv",
            ".env",
            "env",
            "ENV",
            "virtualenv",
            ".virtualenv",
            "pyenv",
            ".python-version",
            
            # Python –∫—ç—à –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            "__pycache__",
            "*.pyc",
            "*.pyo",
            "*.pyd",
            ".Python",
            "*.so",
            ".pytest_cache",
            ".mypy_cache",
            ".coverage",
            ".tox",
            ".nox",
            "htmlcov",
            ".cache",
            "pip-log.txt",
            "pip-delete-this-directory.txt",
            
            # Node.js –∏ JavaScript
            "node_modules",
            "npm-debug.log*",
            "yarn-debug.log*",
            "yarn-error.log*",
            ".npm",
            ".yarn-integrity",
            
            # IDE –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
            ".vscode",
            ".idea",
            "*.swp",
            "*.swo",
            "*~",
            ".vim",
            ".emacs.d",
            
            # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã
            ".DS_Store",
            ".DS_Store?",
            "._*",
            ".Spotlight-V100",
            ".Trashes",
            "ehthumbs.db",
            "Thumbs.db",
            "Desktop.ini",
            
            # –õ–æ–≥–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            "*.log",
            "logs",
            "*.tmp",
            "*.temp",
            "tmp",
            "temp",
            ".tmp",
            
            # –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—ã –∏ —Å–±–æ—Ä–∫–∏
            "dist",
            "build",
            "*.egg-info",
            ".eggs",
            "*.egg",
            "*.whl",
            
            # –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
            "Data/Cache_data",
            "Data/Logs",
            "Data/api/cache",
            "Data/monitor/cache",
            
            # –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
            "backup",
            "backups",
            "*.bak",
            "*.backup",
            "temp_*",  # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏ –±—ç–∫–∞–ø–æ–≤
            
            # Docker –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            ".dockerignore",
            "Dockerfile*",
            "docker-compose*.yml",
            ".docker",
            
            # –ü—Ä–æ—á–∏–µ —Ñ–∞–π–ª—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            ".env.local",
            ".env.*.local",
            "*.orig",
            ".sass-cache",
            ".parcel-cache",
        ]

        if exclude:
            auto_excludes.extend(exclude)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        backup_metadata["excluded_patterns"] = auto_excludes

        console.print(f"[dim]üö´ –ò—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω–æ: {len(auto_excludes)} ({', '.join(auto_excludes[:5])}...)[/]")

        # –°–∫–∞–Ω–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        if verify_hashes:
            console.print("[cyan]üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...[/]")
            file_hashes = scan_directory(project_root, excludes=auto_excludes)
        else:
            console.print("[cyan]üìÅ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è...[/]")
            import fnmatch
            
            file_hashes = {}
            for file in project_root.rglob("*"):
                if file.is_file():
                    rel_path = file.relative_to(project_root).as_posix()
                    
                    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π
                    excluded = False
                    for exclude in auto_excludes:
                        if "*" in exclude:
                            if fnmatch.fnmatch(rel_path, exclude) or fnmatch.fnmatch(file.name, exclude):
                                excluded = True
                                break
                        elif "/" in exclude:
                            if rel_path.startswith(exclude) or rel_path == exclude:
                                excluded = True
                                break
                        else:
                            path_parts = rel_path.split("/")
                            if exclude in path_parts or exclude == file.name:
                                excluded = True
                                break
                    
                    if not excluded:
                        file_hashes[rel_path] = ""  # –ü—É—Å—Ç–æ–π —Ö–µ—à

        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
        for rel_path in file_hashes.keys():
            file_path = project_root / rel_path
            if file_path.exists():
                total_size += file_path.stat().st_size

        files_count = len(file_hashes)
        console.print(f"   üìÅ –§–∞–π–ª–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: {files_count:,}")
        console.print(f"   üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤: {total_size / (1024*1024):.1f}MB")

        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        files_dir = working_target / FILES_BACKUP_DIR_NAME
        files_dir.mkdir(parents=True, exist_ok=True)

        console.print("[cyan]üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...[/]")
        for rel_path in file_hashes:
            src = project_root / rel_path
            dest_path = files_dir / rel_path
            dest_path.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(src, dest_path)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–µ—à–∏ —Ñ–∞–π–ª–æ–≤
        if verify_hashes:
            with open(working_target / "file_hashes.json", "w", encoding="utf-8") as f:
                json.dump(file_hashes, f, indent=2)

        backup_metadata["files"] = {
            "count": files_count,
            "total_size": total_size,
            "hashes_enabled": verify_hashes,
        }

    # === –≠–¢–ê–ü 2: –ë–ê–ó–ê –î–ê–ù–ù–´–• ===
    if include_db:
        console.print(f"\n[cyan]üóÉÔ∏è  –≠—Ç–∞–ø 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö[/]")

        # –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º —Ç–∏–ø –ë–î
        db_info = detect_database_type()
        console.print(f"[cyan]üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ç–∏–ø –ë–î: {db_info['type'].upper()}[/]")

        db_dir = working_target / DB_BACKUP_DIR_NAME
        db_dir.mkdir(parents=True, exist_ok=True)

        db_success = False

        if db_info["type"] == "sqlite":
            console.print(
                "[cyan]üìÑ SQLite –æ–±–Ω–∞—Ä—É–∂–µ–Ω - —Ñ–∞–π–ª—ã —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ –±—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤[/]"
            )
            if db_info["detected_files"]:
                console.print(
                    f"[green]‚úÖ –ù–∞–π–¥–µ–Ω—ã SQLite —Ñ–∞–π–ª—ã: {', '.join(db_info['detected_files'])}[/]"
                )

            # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
            sqlite_info = {
                "type": "sqlite",
                "files": db_info["detected_files"],
                "note": "SQLite files are included in files backup",
                "location": db_info["location"],
            }
            with open(db_dir / "sqlite_info.json", "w", encoding="utf-8") as f:
                json.dump(sqlite_info, f, indent=2)

            db_success = True
            backup_metadata["database"] = {
                "type": "sqlite",
                "success": True,
                "files": db_info["detected_files"],
                "backup_method": "included_in_files",
            }

        elif db_info["type"] == "postgresql":
            console.print("[cyan]üêò –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ PostgreSQL...[/]")
            pg_dump = _find_system_utility("pg_dump")
            if pg_dump and db_info["location"]:
                dump_file = db_dir / POSTGRES_BACKUP_FILENAME
                cmd = [pg_dump, db_info["location"], "-f", str(dump_file)]
                db_success = _execute_system_command(cmd)
                if db_success:
                    console.print("[green]‚úÖ PostgreSQL –±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω[/]")
            else:
                console.print("[red]‚ùå pg_dump –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ URL –ë–î –Ω–µ —É–∫–∞–∑–∞–Ω[/]")

        elif db_info["type"] == "mysql":
            console.print("[cyan]üê¨ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ MySQL...[/]")
            mysqldump = _find_system_utility("mysqldump")
            if mysqldump and db_info["location"]:
                dump_file = db_dir / MYSQL_BACKUP_FILENAME
                # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞, –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å URL
                console.print(
                    "[yellow]‚ö†Ô∏è MySQL –±—ç–∫–∞–ø —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏[/]"
                )
            else:
                console.print("[red]‚ùå mysqldump –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ URL –ë–î –Ω–µ —É–∫–∞–∑–∞–Ω[/]")

        elif db_info["type"] == "none":
            console.print("[yellow]‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞[/]")
            console.print(
                "[dim]üí° –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite, —Ñ–∞–π–ª—ã –ë–î –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –±—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤[/]"
            )

        else:
            console.print(f"[yellow]‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ë–î: {db_info['type']}[/]")

        # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ë–î
        if "database" not in backup_metadata:
            backup_metadata["database"] = {
                "type": db_info["type"],
                "success": db_success,
                "needs_separate_backup": db_info["needs_separate_backup"],
                "detected_files": db_info["detected_files"],
            }

    # === –≠–¢–ê–ü 3: –ú–ï–¢–ê–î–ê–ù–ù–´–ï ===
    console.print(f"\n[cyan]üìã –≠—Ç–∞–ø 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö[/]")

    with open(working_target / "metadata.json", "w", encoding="utf-8") as f:
        json.dump(backup_metadata, f, indent=2, ensure_ascii=False)

    # === –≠–¢–ê–ü 4: –ê–†–•–ò–í–ê–¶–ò–Ø ===
    if compress:
        console.print(f"\n[cyan]üóúÔ∏è –≠—Ç–∞–ø 4: –ê—Ä—Ö–∏–≤–∞—Ü–∏—è[/]")
        final_target = Path(final_target).expanduser().resolve()

        with tarfile.open(final_target, "w:gz") as tar:
            for item in working_target.rglob("*"):
                if item.is_file():
                    arcname = item.relative_to(working_target)
                    tar.add(item, arcname=arcname)

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
        shutil.rmtree(working_target)

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∂–∞—Ç–∏—è
        archive_size = final_target.stat().st_size
        compression_ratio = (
            (1 - archive_size / total_size) * 100 if total_size > 0 else 0
        )

        console.print(f"   üì¶ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: {final_target.name}")
        console.print(f"   üìä –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: {archive_size / (1024*1024):.1f}MB")
        console.print(f"   üìà –°–∂–∞—Ç–∏–µ: {compression_ratio:.1f}%")

    # === –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===
    end_time = time.time()
    duration = end_time - start_time

    console.print(f"\n[green]üéâ –ë—ç–∫–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ![/]")
    console.print(
        Panel.fit(
            f"[green]‚úÖ –¢–∏–ø:[/] {backup_type.upper()}\n"
            f"[green]üìÅ –§–∞–π–ª–æ–≤:[/] {files_count:,} ({total_size / (1024*1024):.1f}MB)\n"
            f"[green]üóÉÔ∏è –ë–î:[/] {'–≤–∫–ª—é—á–µ–Ω–∞' if include_db else '–Ω–µ –≤–∫–ª—é—á–µ–Ω–∞'}\n"
            f"[green]üîç –•–µ—à–∏:[/] {'–≤–∫–ª—é—á–µ–Ω—ã' if verify_hashes else '–æ—Ç–∫–ª—é—á–µ–Ω—ã'}\n"
            f"[green]‚è±Ô∏è –í—Ä–µ–º—è:[/] {duration:.1f}—Å\n"
            f"[green]üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç:[/] {final_target}",
            title="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ç–∫–∞–ø–∞",
            border_style="green",
        )
    )


@backup_app.command("list")
def list_backups(
    backup_type: str = typer.Option(
        "all", "--type", "-t", help="–¢–∏–ø –±—ç–∫–∞–ø–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞: all, files, db, unified"
    ),
    show_hashes: bool = typer.Option(
        False, "--show-hashes", help="–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–µ—à–∞—Ö"
    ),
):
    """üìã –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤."""
    backup_base_dir = _get_backup_base_dir()
    if not backup_base_dir:
        return

    console.print("[bold cyan]üìã –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤[/]")

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –±—ç–∫–∞–ø—ã
    backups = []

    # –ü–æ–∏—Å–∫ –∞—Ä—Ö–∏–≤–æ–≤ .tar.gz
    for backup_file in backup_base_dir.glob("*.tar.gz"):
        try:
            # –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            with tarfile.open(backup_file, "r:gz") as tar:
                try:
                    metadata_member = tar.getmember("metadata.json")
                    metadata_file = tar.extractfile(metadata_member)
                    metadata = json.load(metadata_file)

                    backup_info = {
                        "name": backup_file.name,
                        "path": backup_file,
                        "type": metadata.get("type", "unknown"),
                        "timestamp": metadata.get("timestamp", "unknown"),
                        "size": backup_file.stat().st_size,
                        "includes_files": metadata.get("includes_files", False),
                        "includes_db": metadata.get("includes_db", False),
                        "compressed": True,
                        "verify_hashes": metadata.get("verify_hashes", False),
                    }
                    backups.append(backup_info)
                except:
                    # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞
                    backup_info = {
                        "name": backup_file.name,
                        "path": backup_file,
                        "type": "legacy",
                        "timestamp": "unknown",
                        "size": backup_file.stat().st_size,
                        "includes_files": True,
                        "includes_db": False,
                        "compressed": True,
                        "verify_hashes": False,
                    }
                    backups.append(backup_info)
        except:
            continue

    # –ü–æ–∏—Å–∫ –ø–∞–ø–æ–∫ —Å –±—ç–∫–∞–ø–∞–º–∏
    for backup_dir in backup_base_dir.iterdir():
        if backup_dir.is_dir() and not backup_dir.name.startswith("temp_"):
            metadata_file = backup_dir / "metadata.json"
            if metadata_file.exists():
                try:
                    with open(metadata_file, encoding="utf-8") as f:
                        metadata = json.load(f)

                    backup_info = {
                        "name": backup_dir.name,
                        "path": backup_dir,
                        "type": metadata.get("type", "unknown"),
                        "timestamp": metadata.get("timestamp", "unknown"),
                        "size": sum(
                            f.stat().st_size
                            for f in backup_dir.rglob("*")
                            if f.is_file()
                        ),
                        "includes_files": metadata.get("includes_files", False),
                        "includes_db": metadata.get("includes_db", False),
                        "compressed": False,
                        "verify_hashes": metadata.get("verify_hashes", False),
                    }
                    backups.append(backup_info)
                except:
                    continue

    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
    if backup_type != "all":
        backups = [b for b in backups if backup_type in b["type"]]

    if not backups:
        console.print("[yellow]üì≠ –ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    table = Table(title="üíæ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã")
    table.add_column("–ò–º—è", style="cyan")
    table.add_column("–¢–∏–ø", style="magenta")
    table.add_column("–†–∞–∑–º–µ—Ä", style="green")
    table.add_column("–§–∞–π–ª—ã", style="blue")
    table.add_column("–ë–î", style="red")
    if show_hashes:
        table.add_column("–•–µ—à–∏", style="yellow")
    table.add_column("–î–∞—Ç–∞", style="dim")

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
    backups.sort(key=lambda x: x["timestamp"], reverse=True)

    for backup in backups:
        size_mb = backup["size"] / (1024 * 1024)
        files_icon = "‚úÖ" if backup["includes_files"] else "‚ùå"
        db_icon = "‚úÖ" if backup["includes_db"] else "‚ùå"
        hashes_icon = "üîç" if backup["verify_hashes"] else "‚ùå"

        row = [backup["name"], backup["type"], f"{size_mb:.1f}MB", files_icon, db_icon]

        if show_hashes:
            row.append(hashes_icon)

        row.append(backup["timestamp"])
        table.add_row(*row)

    console.print(table)
    console.print(f"\n[dim]–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {len(backups)} –±—ç–∫–∞–ø–æ–≤[/]")


@backup_app.command("restore")
def restore_backup(
    backup_path: str = typer.Argument(..., help="–ò–º—è –∏–ª–∏ –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"),
    dest: Path = typer.Argument(..., help="–¶–µ–ª–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"),
    backup_type: str = typer.Option(
        "auto", "--type", "-t", help="–ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å: auto, files, db, all"
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", help="–ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
    ),
    verify_hashes: bool = typer.Option(
        True,
        "--verify-hashes/--no-verify-hashes",
        help="–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ö–µ—à–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏",
    ),
    skip_on_error: bool = typer.Option(
        False, "--skip-on-error", help="–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
    ),
    restore_db: bool = typer.Option(
        True, "--db/--no-db", help="–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
    ),
    db_url: Optional[str] = typer.Option(
        None, "--db-url", help="URL –ë–î –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"
    ),
):
    """üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã –∏/–∏–ª–∏ –ë–î –∏–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞."""
    backup_path = _resolve_backup_path(backup_path)
    console.print(f"[bold cyan]üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑: {backup_path}[/]")

    if dry_run:
        console.print(
            "[bold yellow]üîç –°–£–•–û–ô –ó–ê–ü–£–°–ö: –ü–æ–∫–∞–∑—ã–≤–∞—é —á—Ç–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ[/]"
        )
    else:
        console.print(f"[bold cyan]üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑: {backup_path}[/]")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±—ç–∫–∞–ø–∞
    is_archive = backup_path.suffix == ".gz" and backup_path.suffixes[-2:] == [
        ".tar",
        ".gz",
    ]

    if is_archive:
        console.print("[cyan]üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–∂–∞—Ç—ã–π –∞—Ä—Ö–∏–≤[/]")
        temp_dir = (
            backup_path.parent
            / f"temp_restore_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        )
        temp_dir.mkdir(exist_ok=True)

        try:
            with tarfile.open(backup_path, "r:gz") as tar:
                tar.extractall(temp_dir)
            restore_source = temp_dir
            cleanup_temp = True
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏: {e}[/]")
            shutil.rmtree(temp_dir, ignore_errors=True)
            return
    else:
        console.print("[cyan]üìÅ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–∞–ø–∫–∞ —Å –±—ç–∫–∞–ø–æ–º[/]")
        restore_source = backup_path
        cleanup_temp = False

    try:
        # –ß–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        metadata_file = restore_source / "metadata.json"
        if metadata_file.exists():
            with open(metadata_file, encoding="utf-8") as f:
                metadata = json.load(f)
        else:
            console.print(
                "[yellow]‚ö†Ô∏è –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ä–µ–∂–∏–º[/]"
            )
            metadata = {
                "includes_files": True,
                "includes_db": False,
                "verify_hashes": False,
            }

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å
        should_restore_files = backup_type in ["auto", "files", "all"] and metadata.get(
            "includes_files", False
        )
        should_restore_db = (
            backup_type in ["auto", "db", "all"]
            and metadata.get("includes_db", False)
            and restore_db
        )

        console.print(f"[cyan]üìã –ü–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:[/]")
        console.print(f"   üìÅ –§–∞–π–ª—ã: {'‚úÖ' if should_restore_files else '‚ùå'}")
        console.print(f"   üóÉÔ∏è –ë–î: {'‚úÖ' if should_restore_db else '‚ùå'}")

        if not should_restore_files and not should_restore_db:
            console.print("[red]‚ùå –ù–µ—á–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å![/]")
            return

        if not dry_run:
            dest.mkdir(parents=True, exist_ok=True)

        restored_files = 0
        skipped_files = 0
        hash_errors = []

        # === –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –§–ê–ô–õ–û–í ===
        if should_restore_files:
            console.print(f"\n[cyan]üìÅ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤[/]")

            files_dir = restore_source / FILES_BACKUP_DIR_NAME
            if files_dir.exists():
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à–∏ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
                file_hashes = {}
                hash_file = restore_source / "file_hashes.json"
                if verify_hashes and hash_file.exists():
                    with open(hash_file, encoding="utf-8") as f:
                        file_hashes = json.load(f)
                    console.print(f"[cyan]üîç –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ö–µ—à–µ–π: {len(file_hashes)}[/]")

                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã
                for src_file in files_dir.rglob("*"):
                    if src_file.is_file():
                        rel_path = src_file.relative_to(files_dir).as_posix()
                        dest_file = dest / rel_path

                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if verify_hashes and rel_path in file_hashes:
                            expected_hash = file_hashes[rel_path]
                            if expected_hash:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Ö–µ—à–∏
                                actual_hash = sha256(src_file)
                                if actual_hash != expected_hash:
                                    error_msg = f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ö–µ—à: {rel_path}"
                                    hash_errors.append(error_msg)

                                    if skip_on_error:
                                        console.print(
                                            f"[yellow]{error_msg} (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)[/]"
                                        )
                                        skipped_files += 1
                                        continue
                                    else:
                                        console.print(f"[red]{error_msg}[/]")
                                        console.print(
                                            f"[red]‚ùå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ![/]"
                                        )
                                        return

                        if dry_run:
                            console.print(f"  [cyan]‚Üí[/] {rel_path}")
                        else:
                            dest_file.parent.mkdir(parents=True, exist_ok=True)
                            shutil.copy2(src_file, dest_file)
                            restored_files += 1

                if not dry_run:
                    console.print(
                        f"[green]‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {restored_files}[/]"
                    )
            else:
                console.print("[yellow]‚ö†Ô∏è –§–∞–π–ª—ã –≤ –±—ç–∫–∞–ø–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")

        # === –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ë–î ===
        if should_restore_db and not dry_run:
            console.print(f"\n[cyan]üóÉÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö[/]")

            db_dir = restore_source / DB_BACKUP_DIR_NAME
            if db_dir.exists():
                db_info = metadata.get("database", {})
                db_type = db_info.get("type", "unknown")

                if db_type == "postgresql":
                    pg_restore = _find_system_utility("psql")
                    dump_file = db_dir / POSTGRES_BACKUP_FILENAME
                    if pg_restore and dump_file.exists():
                        console.print("[cyan]üêò –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PostgreSQL...[/]")
                        cmd = [pg_restore, db_url, "-f", str(dump_file)]
                        if _execute_system_command(cmd):
                            console.print("[green]‚úÖ –ë–î PostgreSQL –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞[/]")
                        else:
                            console.print("[red]‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è PostgreSQL[/]")

                elif db_type == "mysql":
                    mysql = _find_system_utility("mysql")
                    dump_file = db_dir / MYSQL_BACKUP_FILENAME
                    if mysql and dump_file.exists():
                        console.print("[cyan]üê¨ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MySQL...[/]")
                        # –ö–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ë–î
                        console.print(
                            "[yellow]‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MySQL —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏[/]"
                        )
            else:
                console.print("[yellow]‚ö†Ô∏è –ë–î –≤ –±—ç–∫–∞–ø–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞[/]")

        # === –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===
        if dry_run:
            console.print(f"\n[yellow]üîç –°—É—Ö–æ–π –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω[/]")
        else:
            console.print(f"\n[green]üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ![/]")
            if verify_hashes and hash_errors:
                console.print(f"[red]‚ö†Ô∏è –û—à–∏–±–æ–∫ —Ö–µ—à–µ–π: {len(hash_errors)}[/]")
                if skipped_files:
                    console.print(f"[yellow]‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {skipped_files}[/]")
            elif verify_hashes:
                console.print("[green]üîç –í—Å–µ —Ö–µ—à–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã[/]")

    finally:
        if cleanup_temp:
            shutil.rmtree(temp_dir, ignore_errors=True)


@backup_app.command("verify")
def verify_backup(
    backup_path: str = typer.Argument(..., help="–ò–º—è –∏–ª–∏ –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"),
    checksum: bool = typer.Option(
        True, "--checksum/--no-checksum", help="–ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã —Ñ–∞–π–ª–æ–≤"
    ),
):
    """üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞."""
    backup_path = _resolve_backup_path(backup_path)
    console.print(f"[bold cyan]üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—ç–∫–∞–ø–∞: {backup_path}[/]")

    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ restore - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    is_archive = backup_path.suffix == ".gz" and backup_path.suffixes[-2:] == [
        ".tar",
        ".gz",
    ]

    if is_archive:
        console.print("[cyan]üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∂–∞—Ç–æ–≥–æ –∞—Ä—Ö–∏–≤–∞[/]")
        temp_dir = (
            backup_path.parent
            / f"temp_verify_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        )
        temp_dir.mkdir(exist_ok=True)

        try:
            with tarfile.open(backup_path, "r:gz") as tar:
                tar.extractall(temp_dir)
            verify_source = temp_dir
            cleanup_temp = True
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ: {e}[/]")
            shutil.rmtree(temp_dir, ignore_errors=True)
            return
    else:
        verify_source = backup_path
        cleanup_temp = False

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        metadata_file = verify_source / "metadata.json"
        if not metadata_file.exists():
            console.print("[red]‚ùå –§–∞–π–ª metadata.json –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
            return

        with open(metadata_file, encoding="utf-8") as f:
            metadata = json.load(f)

        console.print(f"[green]üìã –¢–∏–ø –±—ç–∫–∞–ø–∞: {metadata.get('type', 'unknown')}[/]")

        errors = []
        total_files = 0
        verified_files = 0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
        if metadata.get("includes_files", False):
            console.print(f"[cyan]üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤...[/]")

            files_dir = verify_source / FILES_BACKUP_DIR_NAME
            if files_dir.exists():
                hash_file = verify_source / "file_hashes.json"
                if checksum and hash_file.exists():
                    with open(hash_file, encoding="utf-8") as f:
                        file_hashes = json.load(f)

                    console.print(
                        f"[cyan]üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ {len(file_hashes)} —Ñ–∞–π–ª–æ–≤ —Å —Ö–µ—à–∞–º–∏...[/]"
                    )

                    for rel_path, expected_hash in file_hashes.items():
                        total_files += 1
                        file_path = files_dir / rel_path

                        if not file_path.exists():
                            errors.append(f"–§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: {rel_path}")
                            continue

                        if expected_hash:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Ö–µ—à–∏
                            actual_hash = sha256(file_path)
                            if actual_hash != expected_hash:
                                errors.append(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ö–µ—à: {rel_path}")
                                continue

                        verified_files += 1
                else:
                    console.print(
                        "[yellow]‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–µ–π –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞[/]"
                    )
                    for file_path in files_dir.rglob("*"):
                        if file_path.is_file():
                            total_files += 1
                            verified_files += 1

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î
        if metadata.get("includes_db", False):
            console.print(f"[cyan]üóÉÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...[/]")

            db_dir = verify_source / DB_BACKUP_DIR_NAME
            if db_dir.exists():
                db_info = metadata.get("database", {})
                expected_file = db_info.get("backup_file", "")
                if expected_file:
                    db_file = db_dir / expected_file
                    if db_file.exists():
                        console.print(f"[green]‚úÖ –§–∞–π–ª –ë–î –Ω–∞–π–¥–µ–Ω: {expected_file}[/]")
                    else:
                        errors.append(f"–§–∞–π–ª –ë–î –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: {expected_file}")

        # –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if errors:
            console.print(f"\n[red]‚ùå –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: {len(errors)}[/]")
            for error in errors[:10]:
                console.print(f"  ‚Ä¢ {error}")
            if len(errors) > 10:
                console.print(f"  ‚Ä¢ ... –∏ –µ—â—ë {len(errors) - 10} –æ—à–∏–±–æ–∫")
        else:
            console.print(f"\n[green]‚úÖ –ë—ç–∫–∞–ø —Ü–µ–ª–æ—Å—Ç–µ–Ω![/]")
            console.print(f"   üìÅ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {verified_files}/{total_files}")
            if checksum:
                console.print(f"   üîç –í—Å–µ —Ö–µ—à–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã")

    finally:
        if cleanup_temp:
            shutil.rmtree(temp_dir, ignore_errors=True)


@backup_app.command("info")
def backup_info(
    backup_path: str = typer.Argument(
        ..., help="–ò–º—è –∏–ª–∏ –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
    )
):
    """üìä –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—ç–∫–∞–ø–µ."""
    backup_path = _resolve_backup_path(backup_path)
    console.print(f"[bold cyan]üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—ç–∫–∞–ø–µ: {backup_path}[/]")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±—ç–∫–∞–ø–∞ –∏ —á–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥—Ä—É–≥–∏–º –∫–æ–º–∞–Ω–¥–∞–º
    is_archive = backup_path.suffix == ".gz" and backup_path.suffixes[-2:] == [
        ".tar",
        ".gz",
    ]

    if is_archive:
        archive_size = backup_path.stat().st_size
        console.print(
            f"[cyan]üì¶ –¢–∏–ø: –°–∂–∞—Ç—ã–π –∞—Ä—Ö–∏–≤ ({archive_size / (1024*1024):.1f}MB)[/]"
        )

        temp_dir = (
            backup_path.parent / f"temp_info_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        )
        temp_dir.mkdir(exist_ok=True)

        try:
            with tarfile.open(backup_path, "r:gz") as tar:
                metadata_files = ["metadata.json"]
                for member in tar.getmembers():
                    if member.name in metadata_files:
                        tar.extract(member, temp_dir)

            info_source = temp_dir
            cleanup_temp = True
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: {e}[/]")
            shutil.rmtree(temp_dir, ignore_errors=True)
            return
    else:
        console.print("[cyan]üìÅ –¢–∏–ø: –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏[/]")
        info_source = backup_path
        cleanup_temp = False

    try:
        metadata_file = info_source / "metadata.json"
        if metadata_file.exists():
            with open(metadata_file, encoding="utf-8") as f:
                metadata = json.load(f)

            # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.print(
                Panel.fit(
                    f"[green]üè∑Ô∏è –¢–∏–ø:[/] {metadata.get('type', 'unknown')}\n"
                    f"[green]üìÖ –°–æ–∑–¥–∞–Ω:[/] {metadata.get('timestamp', 'unknown')}\n"
                    f"[green]üìÅ –í–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª—ã:[/] {'‚úÖ' if metadata.get('includes_files') else '‚ùå'}\n"
                    f"[green]üóÉÔ∏è –í–∫–ª—é—á–∞–µ—Ç –ë–î:[/] {'‚úÖ' if metadata.get('includes_db') else '‚ùå'}\n"
                    f"[green]üîç –•–µ—à–∏:[/] {'‚úÖ' if metadata.get('verify_hashes') else '‚ùå'}\n"
                    f"[green]üóúÔ∏è –°–∂–∞—Ç–∏–µ:[/] {'‚úÖ' if metadata.get('compressed') else '‚ùå'}",
                    title="üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
                    border_style="green",
                )
            )

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö
            files_info = metadata.get("files", {})
            if files_info:
                console.print(
                    Panel.fit(
                        f"[blue]üìÅ –§–∞–π–ª–æ–≤:[/] {files_info.get('count', 0):,}\n"
                        f"[blue]üìä –†–∞–∑–º–µ—Ä:[/] {files_info.get('total_size', 0) / (1024*1024):.1f}MB\n"
                        f"[blue]üîç –•–µ—à–∏:[/] {'–≤–∫–ª—é—á–µ–Ω—ã' if files_info.get('hashes_enabled') else '–æ—Ç–∫–ª—é—á–µ–Ω—ã'}",
                        title="üìÅ –§–∞–π–ª—ã",
                        border_style="blue",
                    )
                )

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ë–î
            db_info = metadata.get("database", {})
            if db_info and db_info.get("type") != "unknown":
                console.print(
                    Panel.fit(
                        f"[red]üóÉÔ∏è –¢–∏–ø –ë–î:[/] {db_info.get('type', 'unknown')}\n"
                        f"[red]‚úÖ –£—Å–ø–µ—à–Ω–æ:[/] {'‚úÖ' if db_info.get('success') else '‚ùå'}\n"
                        f"[red]üìÑ –§–∞–π–ª:[/] {db_info.get('backup_file', '–Ω–µ —É–∫–∞–∑–∞–Ω')}",
                        title="üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö",
                        border_style="red",
                    )
                )

            console.print("[green]‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ[/]")
        else:
            console.print("[red]‚ùå –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã[/]")

    finally:
        if cleanup_temp:
            shutil.rmtree(temp_dir, ignore_errors=True)


# === –£–õ–£–ß–®–ï–ù–ù–´–ï –£–¢–ò–õ–ò–¢–´ –û–ë–ù–ê–†–£–ñ–ï–ù–ò–Ø ===


def detect_database_type(path: Optional[Path] = None) -> Dict[str, Any]:
    """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–æ–µ–∫—Ç–µ."""

    if path is None:
        # –ü—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞ (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è sdb.py)
        search_path = Path(__file__).resolve().parent.parent
    else:
        search_path = path.resolve()

    # –ü–æ–∏—Å–∫ SQLite —Ñ–∞–π–ª–æ–≤
    sqlite_files = []
    for pattern in ["**/*.db", "**/*.sqlite", "**/*.sqlite3"]:
        sqlite_files.extend(search_path.glob(pattern))

    # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    sqlite_files = [
        f
        for f in sqlite_files
        if not any(
            exclude in str(f)
            for exclude in [".git", "__pycache__", ".pytest_cache", ".venv"]
        )
    ]

    if sqlite_files:
        return {
            "type": "sqlite",
            "location": str(sqlite_files[0]),  # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
            "needs_separate_backup": False,
            "detected_files": [str(f.relative_to(search_path)) for f in sqlite_files],
        }

    # –ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ë–î
    config_files = [
        search_path / ".env",
        search_path / ".env.local",
        search_path / "config.py",
        search_path / "settings.py",
    ]

    for config_file in config_files:
        if config_file.exists():
            content = config_file.read_text()

            # –ü–æ–∏—Å–∫ PostgreSQL
            if any(
                keyword in content.lower()
                for keyword in ["postgresql", "postgres", "psycopg"]
            ):
                return {
                    "type": "postgresql",
                    "location": "external_server",
                    "needs_separate_backup": True,
                    "config_file": str(config_file),
                    "detected_files": [],
                }

            # –ü–æ–∏—Å–∫ MySQL
            if any(
                keyword in content.lower()
                for keyword in ["mysql", "pymysql", "mysqlclient"]
            ):
                return {
                    "type": "mysql",
                    "location": "external_server",
                    "needs_separate_backup": True,
                    "config_file": str(config_file),
                    "detected_files": [],
                }

    return {
        "type": "none",
        "location": "not_found",
        "needs_separate_backup": False,
        "detected_files": [],
    }


def analyze_backup_scope(source_path: Path) -> dict:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±–ª–∞—Å—Ç—å –±—ç–∫–∞–ø–∞ –∏ –≤—ã–¥–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."""
    project_root = Path(__file__).resolve().parent.parent
    analysis = {
        "is_project_root": False,
        "is_external_path": False,
        "includes_project_files": False,
        "missing_important_dirs": [],
        "recommendations": [],
        "warnings": [],
    }

    source_path = source_path.resolve()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—É—Ç—å –∫–æ—Ä–Ω–µ–º –ø—Ä–æ–µ–∫—Ç–∞
    if source_path == project_root:
        analysis["is_project_root"] = True
        analysis["includes_project_files"] = True

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø—É—Ç—å –≤–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
    try:
        source_path.relative_to(project_root)
        analysis["is_external_path"] = False
    except ValueError:
        analysis["is_external_path"] = True
        analysis["warnings"].append(
            "‚ö†Ô∏è –£–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –í–ù–ï –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot"
        )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–∂–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
    important_dirs = [
        ("Systems/core", "–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –±–æ—Ç–∞"),
        ("Systems/cli", "CLI –∫–æ–º–∞–Ω–¥—ã"),
        ("modules", "–ú–æ–¥—É–ª–∏ –±–æ—Ç–∞"),
        ("Data", "–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞"),
        ("Systems/locales", "–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è"),
    ]

    for dir_name, description in important_dirs:
        dir_path = project_root / dir_name
        if dir_path.exists():
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤ –±—ç–∫–∞–ø
                source_path.relative_to(dir_path.parent)
                if not any(source_path == parent for parent in dir_path.parents):
                    analysis["missing_important_dirs"].append(
                        f"{dir_name} ({description})"
                    )
            except ValueError:
                analysis["missing_important_dirs"].append(f"{dir_name} ({description})")

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if analysis["is_external_path"]:
        analysis["recommendations"].append(
            "üí° –î–ª—è –±—ç–∫–∞–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"
        )

    if analysis["missing_important_dirs"]:
        analysis["warnings"].append(
            f"‚ö†Ô∏è –ù–µ –≤–∫–ª—é—á–µ–Ω—ã –≤–∞–∂–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {', '.join(analysis['missing_important_dirs'][:3])}"
        )
        analysis["recommendations"].append(
            "üí° –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ç–∫–∞–ø–∞ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞: --type=full –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—É—Ç–∏"
        )

    return analysis


@backup_app.command("check")
def check_project_config(
    path: Optional[Path] = typer.Argument(
        None, help="–ü—É—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)"
    )
):
    """üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±—ç–∫–∞–ø—É."""

    if path is None:
        path = Path(__file__).resolve().parent.parent
    else:
        path = path.expanduser().resolve()

    console.print(f"[bold cyan]üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: {path}[/]")

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å
    scope_analysis = analyze_backup_scope(path)

    # –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º –ë–î –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏
    db_info = detect_database_type(path)

    # –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
    console.print(
        Panel.fit(
            f"[green]üìç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π –ø—É—Ç—å:[/] {path}\n"
            f"[green]üè† –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞:[/] {'‚úÖ' if scope_analysis['is_project_root'] else '‚ùå'}\n"
            f"[green]üåê –í–Ω–µ—à–Ω–∏–π –ø—É—Ç—å:[/] {'‚ö†Ô∏è' if scope_analysis['is_external_path'] else '‚úÖ'}\n"
            f"[green]üìÅ –í–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:[/] {'‚úÖ' if scope_analysis['includes_project_files'] else '‚ùå'}",
            title="üìã –ê–Ω–∞–ª–∏–∑ –æ–±–ª–∞—Å—Ç–∏ –±—ç–∫–∞–ø–∞",
            border_style="blue",
        )
    )

    console.print(
        Panel.fit(
            f"[green]üóÉÔ∏è –¢–∏–ø –ë–î:[/] {db_info['type'].upper()}\n"
            f"[green]üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:[/] {db_info['location'] or '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}\n"
            f"[green]üîÑ –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø:[/] {'‚úÖ' if db_info['needs_separate_backup'] else '‚ùå'}\n"
            f"[green]üìÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã:[/] {', '.join(db_info['detected_files']) if db_info['detected_files'] else '–Ω–µ—Ç'}",
            title="üóÉÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î",
            border_style="green",
        )
    )

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if scope_analysis["warnings"]:
        console.print("\n[bold red]‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:[/]")
        for warning in scope_analysis["warnings"]:
            console.print(f"  {warning}")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if scope_analysis["recommendations"]:
        console.print("\n[bold blue]üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:[/]")
        for recommendation in scope_analysis["recommendations"]:
            console.print(f"  {recommendation}")

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±—ç–∫–∞–ø—É
    console.print(f"\n[bold cyan]üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –±—ç–∫–∞–ø–∞:[/]")

    if scope_analysis["is_project_root"]:
        console.print("  [green]# –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)[/]")
        console.print("  [dim]python sdb.py backup create --type=full[/]")

        if db_info["type"] == "sqlite":
            console.print("\n  [green]# –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã (SQLite —É–∂–µ –≤–∫–ª—é—á–µ–Ω)[/]")
            console.print("  [dim]python sdb.py backup create --type=files[/]")

        if db_info["needs_separate_backup"]:
            console.print("\n  [green]# –¢–æ–ª—å–∫–æ –ë–î (PostgreSQL/MySQL)[/]")
            console.print(
                "  [dim]python sdb.py backup create --type=db --db-url=–≤–∞—à_url[/]"
            )

    else:
        console.print("  [yellow]# –ö–∞—Å—Ç–æ–º–Ω—ã–π –±—ç–∫–∞–ø —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏[/]")
        console.print(f"  [dim]python sdb.py backup create --type=custom {path}[/]")

        console.print("\n  [green]# –ë—ç–∫–∞–ø –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)[/]")
        console.print("  [dim]python sdb.py backup create --type=full[/]")

    console.print(f"\n[green]‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω[/]")


@backup_app.command("diff")
def diff_backup(
    backup_path: str = typer.Argument(..., help="–ò–º—è –∏–ª–∏ –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"),
    show_details: bool = typer.Option(
        False, "--details", "-d", help="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö"
    ),
    check_hashes: bool = typer.Option(
        True, "--check-hashes/--no-check-hashes", help="–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ö–µ—à–∏ —Ñ–∞–π–ª–æ–≤"
    ),
    ignore_timestamps: bool = typer.Option(
        False, "--ignore-timestamps", help="–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏"
    ),
    exclude: Optional[List[str]] = typer.Option(
        None, "--exclude", "-x", help="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"
    ),
):
    """üîç –°—Ä–∞–≤–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –±—ç–∫–∞–ø–æ–º."""
    backup_path = _resolve_backup_path(backup_path)
    console.print(f"[bold cyan]üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å –±—ç–∫–∞–ø–æ–º: {backup_path}[/]")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±—ç–∫–∞–ø–∞
    is_archive = backup_path.suffix == ".gz" and backup_path.suffixes[-2:] == [".tar", ".gz"]
    
    if is_archive:
        console.print("[cyan]üì¶ –ê–Ω–∞–ª–∏–∑ —Å–∂–∞—Ç–æ–≥–æ –∞—Ä—Ö–∏–≤–∞...[/]")
        temp_dir = backup_path.parent / f"temp_diff_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        temp_dir.mkdir(exist_ok=True)
        
        try:
            with tarfile.open(backup_path, "r:gz") as tar:
                tar.extractall(temp_dir)
            backup_source = temp_dir
            cleanup_temp = True
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏: {e}[/]")
            shutil.rmtree(temp_dir, ignore_errors=True)
            return
    else:
        console.print("[cyan]üìÅ –ê–Ω–∞–ª–∏–∑ –ø–∞–ø–∫–∏ —Å –±—ç–∫–∞–ø–æ–º...[/]")
        backup_source = backup_path
        cleanup_temp = False
    
    try:
        # –ß–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±—ç–∫–∞–ø–∞
        metadata_file = backup_source / "metadata.json"
        if not metadata_file.exists():
            console.print("[red]‚ùå –§–∞–π–ª metadata.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—ç–∫–∞–ø–µ[/]")
            return
            
        with open(metadata_file, encoding="utf-8") as f:
            backup_metadata = json.load(f)
        
        console.print(f"[green]üìã –¢–∏–ø –±—ç–∫–∞–ø–∞: {backup_metadata.get('type', 'unknown')}[/]")
        console.print(f"[green]üìÖ –°–æ–∑–¥–∞–Ω: {backup_metadata.get('timestamp', 'unknown')}[/]")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞
        backup_excludes = backup_metadata.get("excluded_patterns", [])
        if exclude:
            backup_excludes.extend(exclude)
        
        # === –°–†–ê–í–ù–ï–ù–ò–ï –§–ê–ô–õ–û–í ===
        if backup_metadata.get("includes_files", False):
            console.print(f"\n[cyan]üìÅ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...[/]")
            
            # –ß–∏—Ç–∞–µ–º —Ö–µ—à–∏ –∏–∑ –±—ç–∫–∞–ø–∞
            backup_hashes = {}
            hash_file = backup_source / "file_hashes.json"
            if hash_file.exists():
                with open(hash_file, encoding="utf-8") as f:
                    backup_hashes = json.load(f)
            
            # –°–∫–∞–Ω–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
            project_root = Path(__file__).resolve().parent.parent
            console.print("[cyan]üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...[/]")
            
            if check_hashes and backup_hashes:
                current_hashes = scan_directory(project_root, excludes=backup_excludes)
            else:
                # –°–∫–∞–Ω–∏—Ä—É–µ–º –±–µ–∑ —Ö–µ—à–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                current_hashes = {}
                import fnmatch
                
                for file in project_root.rglob("*"):
                    if file.is_file():
                        rel_path = file.relative_to(project_root).as_posix()
                        
                        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
                        excluded = False
                        for excl in backup_excludes:
                            if "*" in excl:
                                if fnmatch.fnmatch(rel_path, excl) or fnmatch.fnmatch(file.name, excl):
                                    excluded = True
                                    break
                            elif "/" in excl:
                                if rel_path.startswith(excl) or rel_path == excl:
                                    excluded = True
                                    break
                            else:
                                path_parts = rel_path.split("/")
                                if excl in path_parts or excl == file.name:
                                    excluded = True
                                    break
                        
                        if not excluded:
                            current_hashes[rel_path] = ""  # –ü—É—Å—Ç–æ–π —Ö–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∂–∏–º–∞
            
            # –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π
            added_files = []
            deleted_files = []
            modified_files = []
            
            # –§–∞–π–ª—ã –≤ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –Ω–µ –≤ –±—ç–∫–∞–ø–µ (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ)
            for file_path in current_hashes:
                if file_path not in backup_hashes:
                    file_stat = (project_root / file_path).stat()
                    added_files.append({
                        "path": file_path,
                        "size": file_stat.st_size,
                        "modified": datetime.fromtimestamp(file_stat.st_mtime).isoformat(),
                    })
            
            # –§–∞–π–ª—ã –≤ –±—ç–∫–∞–ø–µ, –Ω–æ –Ω–µ –≤ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º–µ (—É–¥–∞–ª—ë–Ω–Ω—ã–µ)
            for file_path in backup_hashes:
                if file_path not in current_hashes:
                    deleted_files.append({
                        "path": file_path,
                        "hash": backup_hashes[file_path][:8] if backup_hashes[file_path] else "no-hash",
                    })
            
            # –§–∞–π–ª—ã –≤ –æ–±–µ–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ)
            for file_path in backup_hashes:
                if file_path in current_hashes:
                    current_file = project_root / file_path
                    if current_file.exists():
                        backup_hash = backup_hashes[file_path]
                        current_hash = current_hashes[file_path]
                        
                        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö–µ—à–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                        if check_hashes and backup_hash and current_hash:
                            if backup_hash != current_hash:
                                file_stat = current_file.stat()
                                modified_files.append({
                                    "path": file_path,
                                    "backup_hash": backup_hash[:8],
                                    "current_hash": current_hash[:8],
                                    "size": file_stat.st_size,
                                    "modified": datetime.fromtimestamp(file_stat.st_mtime).isoformat(),
                                    "reason": "hash_different"
                                })
                        elif not check_hashes:
                            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
                            file_stat = current_file.stat()
                            backup_files_dir = backup_source / FILES_BACKUP_DIR_NAME / file_path
                            
                            if backup_files_dir.exists():
                                backup_stat = backup_files_dir.stat()
                                size_different = file_stat.st_size != backup_stat.st_size
                                
                                if not ignore_timestamps:
                                    time_different = abs(file_stat.st_mtime - backup_stat.st_mtime) > 2
                                else:
                                    time_different = False
                                
                                if size_different or time_different:
                                    reasons = []
                                    if size_different:
                                        reasons.append("size_different")
                                    if time_different:
                                        reasons.append("time_different")
                                    
                                    modified_files.append({
                                        "path": file_path,
                                        "backup_size": backup_stat.st_size,
                                        "current_size": file_stat.st_size,
                                        "modified": datetime.fromtimestamp(file_stat.st_mtime).isoformat(),
                                        "reason": "+".join(reasons)
                                    })
            
            # === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ===
            console.print(f"\n[bold green]üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:[/]")
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            stats_table = Table(title="üìà –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
            stats_table.add_column("–ö–∞—Ç–µ–≥–æ—Ä–∏—è", style="bold")
            stats_table.add_column("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", style="cyan")
            stats_table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="dim")
            
            stats_table.add_row("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ", f"{len(added_files)}", "–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ —Å–∏—Å—Ç–µ–º–µ")
            stats_table.add_row("‚ùå –£–¥–∞–ª–µ–Ω–æ", f"{len(deleted_files)}", "–§–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å–∏—Å—Ç–µ–º–µ")
            stats_table.add_row("üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ", f"{len(modified_files)}", "–§–∞–π–ª—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å")
            
            console.print(stats_table)
            
            # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞
            if show_details:
                if added_files:
                    console.print(f"\n[bold green]‚úÖ –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –§–ê–ô–õ–´ ({len(added_files)}):[/]")
                    added_table = Table()
                    added_table.add_column("–§–∞–π–ª", style="green")
                    added_table.add_column("–†–∞–∑–º–µ—Ä", style="cyan")
                    added_table.add_column("–ò–∑–º–µ–Ω—ë–Ω", style="dim")
                    
                    for file_info in added_files[:20]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 20
                        size_mb = file_info["size"] / (1024 * 1024) if file_info["size"] > 1024*1024 else file_info["size"]
                        size_str = f"{size_mb:.1f}MB" if file_info["size"] > 1024*1024 else f"{file_info['size']}B"
                        added_table.add_row(
                            file_info["path"],
                            size_str,
                            file_info["modified"][:16]
                        )
                    
                    console.print(added_table)
                    if len(added_files) > 20:
                        console.print(f"[dim]... –∏ –µ—â—ë {len(added_files) - 20} —Ñ–∞–π–ª–æ–≤[/]")
                
                if deleted_files:
                    console.print(f"\n[bold red]‚ùå –£–î–ê–õ–Å–ù–ù–´–ï –§–ê–ô–õ–´ ({len(deleted_files)}):[/]")
                    deleted_table = Table()
                    deleted_table.add_column("–§–∞–π–ª", style="red")
                    deleted_table.add_column("–•–µ—à (–±—ç–∫–∞–ø)", style="dim")
                    
                    for file_info in deleted_files[:20]:
                        deleted_table.add_row(
                            file_info["path"],
                            file_info["hash"]
                        )
                    
                    console.print(deleted_table)
                    if len(deleted_files) > 20:
                        console.print(f"[dim]... –∏ –µ—â—ë {len(deleted_files) - 20} —Ñ–∞–π–ª–æ–≤[/]")
                
                if modified_files:
                    console.print(f"\n[bold yellow]üîÑ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´ ({len(modified_files)}):[/]")
                    modified_table = Table()
                    modified_table.add_column("–§–∞–π–ª", style="yellow")
                    modified_table.add_column("–ü—Ä–∏—á–∏–Ω–∞", style="magenta")
                    
                    if check_hashes:
                        modified_table.add_column("–•–µ—à (–±—ç–∫–∞–ø)", style="dim")
                        modified_table.add_column("–•–µ—à (—Ç–µ–∫—É—â–∏–π)", style="cyan")
                    else:
                        modified_table.add_column("–†–∞–∑–º–µ—Ä (–±—ç–∫–∞–ø)", style="dim")
                        modified_table.add_column("–†–∞–∑–º–µ—Ä (—Ç–µ–∫—É—â–∏–π)", style="cyan")
                    
                    for file_info in modified_files[:20]:
                        if check_hashes:
                            modified_table.add_row(
                                file_info["path"],
                                file_info["reason"],
                                file_info.get("backup_hash", "N/A"),
                                file_info.get("current_hash", "N/A")
                            )
                        else:
                            backup_size = file_info.get("backup_size", 0)
                            current_size = file_info.get("current_size", 0)
                            backup_size_str = f"{backup_size}B" if backup_size < 1024*1024 else f"{backup_size/(1024*1024):.1f}MB"
                            current_size_str = f"{current_size}B" if current_size < 1024*1024 else f"{current_size/(1024*1024):.1f}MB"
                            
                            modified_table.add_row(
                                file_info["path"],
                                file_info["reason"],
                                backup_size_str,
                                current_size_str
                            )
                    
                    console.print(modified_table)
                    if len(modified_files) > 20:
                        console.print(f"[dim]... –∏ –µ—â—ë {len(modified_files) - 20} —Ñ–∞–π–ª–æ–≤[/]")
            else:
                # –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                if added_files:
                    console.print(f"[green]‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(added_files)} (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --details –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π)[/]")
                if deleted_files:
                    console.print(f"[red]‚ùå –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(deleted_files)} (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --details –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π)[/]")
                if modified_files:
                    console.print(f"[yellow]üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(modified_files)} (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --details –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π)[/]")
            
            # –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
            total_changes = len(added_files) + len(deleted_files) + len(modified_files)
            if total_changes == 0:
                console.print(f"\n[bold green]üéâ –°–∏—Å—Ç–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ –±—ç–∫–∞–ø—É![/]")
            else:
                console.print(f"\n[bold yellow]‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {total_changes} –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ[/]")
                
                # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                if len(added_files) > 10 or len(modified_files) > 10:
                    console.print(f"[blue]üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –±—ç–∫–∞–ø –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π[/]")
                    console.print(f"[dim]   python3 sdb.py backup create --type=full[/]")
        
        else:
            console.print("[yellow]‚ö†Ô∏è –ë—ç–∫–∞–ø –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è[/]")
        
        # === –°–†–ê–í–ù–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• ===
        if backup_metadata.get("includes_db", False):
            console.print(f"\n[cyan]üóÉÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...[/]")
            
            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–î
            backup_db = backup_metadata.get("database", {})
            current_db = detect_database_type()
            
            console.print(f"[dim]–¢–∏–ø –ë–î –≤ –±—ç–∫–∞–ø–µ: {backup_db.get('type', 'unknown')}[/]")
            console.print(f"[dim]–¢–µ–∫—É—â–∏–π —Ç–∏–ø –ë–î: {current_db.get('type', 'unknown')}[/]")
            
            if backup_db.get("type") != current_db.get("type"):
                console.print("[yellow]‚ö†Ô∏è –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–∏–ª—Å—è![/]")
            
            if current_db.get("type") == "sqlite":
                # –î–ª—è SQLite —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ –ë–î
                current_db_files = current_db.get("detected_files", [])
                backup_db_files = backup_db.get("files", [])
                
                if set(current_db_files) != set(backup_db_files):
                    console.print("[yellow]üîÑ –§–∞–π–ª—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–∏–ª–∏—Å—å[/]")
                    console.print(f"   –ë—ç–∫–∞–ø: {backup_db_files}")
                    console.print(f"   –¢–µ–∫—É—â–∏–µ: {current_db_files}")
                else:
                    console.print("[green]‚úÖ –§–∞–π–ª—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –±—ç–∫–∞–ø—É[/]")
            else:
                console.print("[blue]üí° –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ë–î —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–º–ø–æ–≤[/]")
        
    finally:
        if cleanup_temp:
            shutil.rmtree(temp_dir, ignore_errors=True)
    
    console.print(f"\n[green]‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ[/]")

def _resolve_backup_path(backup_path: Union[str, Path]) -> Path:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–º—É/–∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –ø—É—Ç–∏."""
    p = Path(backup_path)
    if p.exists():
        return p.resolve()
    # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç / ‚Äî –∏—â–µ–º –≤ backup/
    if not p.is_absolute() and '/' not in str(p):
        backup_dir = _get_backup_base_dir()
        candidate = backup_dir / p
        if candidate.exists():
            return candidate.resolve()
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø—É—Ç—å
    return p.resolve()

# --- –ö–æ–Ω–µ—Ü backup_unified.py ---



======================================================================

------------------------------ FILE: Systems/cli/system.py ------------------------------
# cli_commands/system_cmd.py

import json
import os
import platform
import shutil
import signal
import subprocess
import sys
import tarfile
import time
from datetime import datetime
from pathlib import Path
from typing import List, Optional

import typer
from rich.console import Console
from rich.panel import Panel

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–∫–∞–Ω—å—è –≤ —Ç–µ—Å—Ç–∞—Ö
try:
    from Systems.cli.utils import get_settings_only_for_cli
    from Systems.core.app_settings import PROJECT_ROOT_DIR, settings
except ImportError:
    # Fallback –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    settings = None
    get_settings_only_for_cli = None
    PROJECT_ROOT_DIR = Path.cwd()

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
system_app = typer.Typer(help="–°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è SwiftDevBot.")
console = Console()


def _show_basic_system_info(settings):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤."""
    console.print("\n[bold cyan]–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:[/bold cyan]")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ë–î
    console.print(f"[bold]–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:[/bold] {settings.db.type}")
    if settings.db.type == "sqlite":
        db_path = settings.core.project_data_path / (
            settings.db.sqlite_path or "Database_files/swiftdevbot.db"
        )
        db_exists = db_path.exists()
        console.print(f"[bold]–§–∞–π–ª –ë–î:[/bold] {db_path} {'‚úÖ' if db_exists else '‚ùå'}")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
    dirs_to_check = [
        ("–õ–æ–≥–∏", settings.core.project_data_path / "Logs"),
        ("–ö—ç—à", settings.core.project_data_path / "Cache_data"),
        ("–ë—ç–∫–∞–ø—ã", settings.core.project_data_path / "core_backups"),
        ("–ö–æ–Ω—Ñ–∏–≥", settings.core.project_data_path / "Config"),
    ]

    for name, path in dirs_to_check:
        exists = path.exists()
        console.print(f"[bold]{name}:[/bold] {path} {'‚úÖ' if exists else '‚ùå'}")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—ç—à–µ
    cache_type = getattr(settings.cache, "type", "memory")
    console.print(f"[bold]–¢–∏–ø –∫—ç—à–∞:[/bold] {cache_type}")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª—è—Ö (–ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫)
    try:
        enabled_modules_path = (
            settings.core.project_data_path / settings.core.enabled_modules_config_path
        )
        if enabled_modules_path.exists():
            with open(enabled_modules_path, "r") as f:
                enabled_modules = json.load(f)
            console.print(
                f"[bold]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π:[/bold] {len(enabled_modules)} –∑–∞–ø–∏—Å–µ–π"
            )
        else:
            console.print(f"[bold]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π:[/bold] —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        console.print(f"[bold]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π:[/bold] –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è ({e})")


@system_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ SwiftDevBot.")
def info_cmd():
    """
    –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ BOT_TOKEN.
    """
    try:
        settings = get_settings_only_for_cli()  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
        _show_basic_system_info(settings)
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}[/red]")
        raise typer.Exit(1)


@system_app.command(name="update", help="–û–±–Ω–æ–≤–∏—Ç—å SwiftDevBot –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.")
def update_cmd(
    branch: str = typer.Option("main", "--branch", "-b", help="–í–µ—Ç–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."),
    backup: bool = typer.Option(
        True, "--backup/--no-backup", help="–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º."
    ),
    restart: bool = typer.Option(
        False, "--restart", "-r", help="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."
    ),
):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏."""
    try:
        settings = settings  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        root_dir = PROJECT_ROOT_DIR

        console.print(
            f"[bold blue]–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SwiftDevBot —Å –≤–µ—Ç–∫–∏ '{branch}'...[/bold blue]"
        )

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        if backup:
            console.print("[yellow]–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...[/yellow]")
            backup_name = (
                f"backup_before_update_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            )
            backup_path = (
                settings.core.project_data_path
                / "core_backups"
                / f"{backup_name}.tar.gz"
            )
            backup_path.parent.mkdir(parents=True, exist_ok=True)

            # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
            with tarfile.open(backup_path, "w:gz") as tar:

                def filter_func(tarinfo):
                    # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                    if any(
                        exclude in tarinfo.name
                        for exclude in [
                            ".git",
                            "__pycache__",
                            ".pytest_cache",
                            "node_modules",
                            "venv",
                            ".env",
                        ]
                    ):
                        return None
                    return tarinfo

                tar.add(root_dir, arcname=".", filter=filter_func)

            console.print(f"[green]–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_path}[/green]")

        # Git pull –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        console.print("[blue]–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...[/blue]")
        result = subprocess.run(
            ["git", "pull", "origin", branch],
            cwd=root_dir,
            capture_output=True,
            text=True,
        )

        if result.returncode != 0:
            console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {result.stderr}[/red]")
            raise typer.Exit(1)

        console.print("[green]–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω![/green]")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        requirements_path = root_dir / "requirements.txt"
        if requirements_path.exists():
            console.print("[blue]–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...[/blue]")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "pip",
                    "install",
                    "-r",
                    str(requirements_path),
                    "--upgrade",
                ],
                capture_output=True,
                text=True,
            )

            if result.returncode == 0:
                console.print("[green]–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã![/green]")
            else:
                console.print(
                    f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: {result.stderr}[/yellow]"
                )

        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
        console.print("[blue]–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î...[/blue]")
        try:
            result = subprocess.run(
                [sys.executable, "-m", "alembic", "upgrade", "head"],
                cwd=root_dir,
                capture_output=True,
                text=True,
            )

            if result.returncode == 0:
                console.print("[green]–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã![/green]")
            else:
                console.print(
                    f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π: {result.stderr}[/yellow]"
                )
        except Exception as e:
            console.print(f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: {e}[/yellow]")

        console.print("[bold green]‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ![/bold green]")

        if restart:
            console.print("[blue]–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞...[/blue]")
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç
                import signal
                import subprocess
                import time

                # –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞
                result = subprocess.run(
                    ["pgrep", "-f", "run_bot.py"], capture_output=True, text=True
                )
                if result.returncode == 0:
                    pid = int(result.stdout.strip())
                    console.print(f"[yellow]–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç (PID: {pid})...[/yellow]")

                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    os.kill(pid, signal.SIGTERM)
                    time.sleep(3)

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
                    try:
                        os.kill(pid, 0)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
                        console.print(
                            "[yellow]–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...[/yellow]"
                        )
                        os.kill(pid, signal.SIGKILL)
                        time.sleep(1)
                    except ProcessLookupError:
                        pass  # –ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è

                # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –∑–∞–Ω–æ–≤–æ
                console.print("[green]–ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç...[/green]")
                subprocess.Popen(
                    [sys.executable, "run_bot.py"],
                    cwd=settings.core.project_root_path,
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL,
                )

                console.print("[bold green]‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω![/bold green]")

            except Exception as restart_error:
                console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ: {restart_error}[/red]")
                console.print(
                    "[yellow]–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç –≤—Ä—É—á–Ω—É—é: python run_bot.py[/yellow]"
                )

    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}[/red]")
        raise typer.Exit(1)


@system_app.command(name="rollback", help="–û—Ç–∫–∞—Ç–∏—Ç—å SwiftDevBot –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏.")
def rollback_cmd(
    backup_name: str = typer.Argument(
        ..., help="–ò–º—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è."
    ),
    confirm: bool = typer.Option(
        False, "--confirm", "-y", help="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–∫–∞—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤."
    ),
):
    """–û—Ç–∫–∞—Ç —Å–∏—Å—Ç–µ–º—ã –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏."""
    try:
        settings = settings  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        root_dir = PROJECT_ROOT_DIR

        # –ü–æ–∏—Å–∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        backup_path = (
            settings.core.project_data_path / "core_backups" / f"{backup_name}.tar.gz"
        )
        if not backup_path.exists():
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            backup_path = settings.core.project_data_path / "core_backups" / backup_name
            if not backup_path.exists():
                console.print(f"[red]–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è '{backup_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞![/red]")
                console.print("\n[blue]–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:[/blue]")
                backup_dir = settings.core.project_data_path / "core_backups"
                if backup_dir.exists():
                    for backup in backup_dir.glob("*.tar.gz"):
                        console.print(f"  ‚Ä¢ {backup.stem}")
                raise typer.Exit(1)

        console.print(f"[yellow]–ù–∞–π–¥–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_path}[/yellow]")

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        if not confirm:
            confirm_rollback = typer.confirm(
                "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –û—Ç–∫–∞—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
            )
            if not confirm_rollback:
                console.print("[blue]–û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.[/blue]")
                raise typer.Exit(0)

        console.print("[bold red]üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–∫–∞—Ç —Å–∏—Å—Ç–µ–º—ã...[/bold red]")

        # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        temp_backup_name = (
            f"temp_before_rollback_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        )
        temp_backup_path = (
            settings.core.project_data_path
            / "core_backups"
            / f"{temp_backup_name}.tar.gz"
        )

        console.print("[blue]–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...[/blue]")
        with tarfile.open(temp_backup_path, "w:gz") as tar:
            tar.add(
                root_dir,
                arcname=".",
                exclude=lambda path: any(ex in path for ex in [".git", "__pycache__"]),
            )

        # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        console.print("[blue]–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...[/blue]")
        with tarfile.open(backup_path, "r:gz") as tar:
            tar.extractall(path=root_dir, filter="data")

        console.print("[green]‚úÖ –§–∞–π–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏![/green]")
        console.print(f"[blue]–í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {temp_backup_path}[/blue]")
        console.print(
            "[bold yellow]–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ç–∞–∫–∂–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`sdb db downgrade ...`) –∏ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ![/bold yellow]"
        )

    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ: {e}[/red]")
        raise typer.Exit(1)


@system_app.command(
    name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤."
)
def status_cmd():
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã."""
    try:
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∏–º–ø–æ—Ä—Ç–∞

        console.print("\n[bold cyan]–°—Ç–∞—Ç—É—Å SwiftDevBot:[/bold cyan]")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        root_dir = PROJECT_ROOT_DIR

        main_files = [
            ("–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª", root_dir / "sdb.py"),
            ("–§–∞–π–ª –∑–∞–ø—É—Å–∫–∞", root_dir / "run_bot.py"),
            (
                "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è",
                settings.core.project_data_path / "Config" / "core_settings.yaml",
            ),
        ]

        for name, path in main_files:
            exists = path.exists()
            console.print(f"[bold]{name}:[/bold] {'‚úÖ' if exists else '‚ùå'} {path}")

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
        console.print(
            f"\n[bold]–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:[/bold] {platform.system()} {platform.release()}"
        )
        console.print(f"[bold]Python –≤–µ—Ä—Å–∏—è:[/bold] {platform.python_version()}")
        console.print(f"[bold]–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:[/bold] {platform.machine()}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞
        try:
            result = subprocess.run(
                ["git", "rev-parse", "--short", "HEAD"],
                cwd=root_dir,
                capture_output=True,
                text=True,
            )

            if result.returncode == 0:
                commit_hash = result.stdout.strip()
                console.print(f"[bold]Git –∫–æ–º–º–∏—Ç:[/bold] {commit_hash}")

                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                result = subprocess.run(
                    ["git", "status", "--porcelain"],
                    cwd=root_dir,
                    capture_output=True,
                    text=True,
                )

                if result.stdout.strip():
                    console.print("[yellow]‚ö†Ô∏è –ï—Å—Ç—å –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è[/yellow]")
                else:
                    console.print("[green]‚úÖ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è[/green]")
        except:
            console.print("[yellow]Git –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞[/yellow]")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ VPN —Å—Ç–∞—Ç—É—Å–∞
        console.print(f"\n[bold cyan]VPN –°—Ç–∞—Ç—É—Å:[/bold cyan]")
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º systemd —Å–µ—Ä–≤–∏—Å
            result = subprocess.run(
                ["systemctl", "is-active", "--quiet", "swiftdevbot-vpn.service"],
                capture_output=True,
            )

            if result.returncode == 0:
                console.print("[green]‚úÖ VPN —Å–µ—Ä–≤–∏—Å –∞–∫—Ç–∏–≤–µ–Ω[/green]")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                result = subprocess.run(
                    ["ip", "addr", "show", "tun1"], capture_output=True, text=True
                )

                if result.returncode == 0:
                    console.print("[green]‚úÖ VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–µ–Ω[/green]")

                    # –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP
                    try:
                        result = subprocess.run(
                            [
                                "curl",
                                "-s",
                                "--connect-timeout",
                                "5",
                                "https://icanhazip.com",
                            ],
                            capture_output=True,
                            text=True,
                        )

                        if result.returncode == 0 and result.stdout.strip():
                            external_ip = result.stdout.strip()
                            console.print(f"[bold]–í–Ω–µ—à–Ω–∏–π IP:[/bold] {external_ip}")

                            if external_ip == "31.202.91.112":
                                console.print(
                                    "[green]üéâ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ASUS —Ä–æ—É—Ç–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ![/green]"
                                )
                            else:
                                console.print(
                                    "[yellow]‚ö†Ô∏è IP –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É[/yellow]"
                                )
                    except:
                        console.print("[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP[/yellow]")
                else:
                    console.print("[red]‚ùå VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω[/red]")
            else:
                console.print("[red]‚ùå VPN —Å–µ—Ä–≤–∏—Å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω[/red]")
        except Exception as vpn_error:
            console.print(
                f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å VPN —Å—Ç–∞—Ç—É—Å: {vpn_error}[/yellow]"
            )

        _show_basic_system_info(settings)

    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}[/red]")
        raise typer.Exit(1)


@system_app.command(name="vpn", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å VPN –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.")
def vpn_status_cmd():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ VPN –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è."""
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ VPN
        result = subprocess.run(
            [str(PROJECT_ROOT_DIR / "scripts" / "check_vpn_status.sh")],
            capture_output=True,
            text=True,
        )

        if result.returncode == 0:
            console.print(result.stdout)
        else:
            console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ VPN: {result.stderr}[/red]")
            raise typer.Exit(1)

    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ VPN —Å—Ç–∞—Ç—É—Å–∞: {e}[/red]")
        raise typer.Exit(1)



======================================================================

------------------------------ FILE: Systems/cli/web.py ------------------------------
# cli/web.py
"""
CLI –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±-–ø–∞–Ω–µ–ª—å—é.
"""

import asyncio
import sys
from pathlib import Path

import typer
from rich.console import Console
from rich.panel import Panel

console = Console()

web_app = typer.Typer(
    name="web",
    help="üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±-–ø–∞–Ω–µ–ª—å—é SwiftDevBot",
    rich_markup_mode="rich",
)


@web_app.command(name="start", help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–ø–∞–Ω–µ–ª—å.")
def web_start_cmd(
    host: str = typer.Option(None, "--host", "-h", help="–•–æ—Å—Ç –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏"),
    port: int = typer.Option(None, "--port", "-p", help="–ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏"),
    reload: bool = typer.Option(False, "--reload", help="–ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö"),
    workers: int = typer.Option(1, "--workers", "-w", help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤"),
):
    """
    –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–ø–∞–Ω–µ–ª—å SwiftDevBot.
    
    Args:
        host: –•–æ—Å—Ç –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∏–∑ SDB_WEB_HOST –∏–ª–∏ 127.0.0.1)
        port: –ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∏–∑ SDB_WEB_PORT –∏–ª–∏ 8000)
        reload: –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
        workers: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ (–¥–ª—è production)
    """
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã
    import os
    from dotenv import load_dotenv
    load_dotenv('.env')
    
    if host is None:
        host = os.environ.get("SDB_WEB_HOST", "127.0.0.1")
    if port is None:
        port = int(os.environ.get("SDB_WEB_PORT", "8000"))
    
    try:
        asyncio.run(_web_start_async(host, port, reload, workers))
    except KeyboardInterrupt:
        console.print("\n[yellow]–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±-–ø–∞–Ω–µ–ª–∏...[/]")
        sys.exit(0)
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–ø–∞–Ω–µ–ª–∏:[/] {e}")
        import traceback
        console.print(f"[dim]{traceback.format_exc()}[/]")
        raise typer.Exit(code=1)


async def _web_start_async(host: str, port: int, reload: bool, workers: int):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤–µ–±-–ø–∞–Ω–µ–ª–∏."""
    try:
        import uvicorn
    except ImportError:
        console.print(
            "[bold red]uvicorn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω![/]\n"
            "[yellow]–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π:[/] pip install uvicorn[standard]"
        )
        raise typer.Exit(code=1)
    
    console.print(
        Panel(
            f"[bold cyan]üåê –ó–ê–ü–£–°–ö –í–ï–ë-–ü–ê–ù–ï–õ–ò SWIFTDEVBOT[/]\n\n"
            f"[cyan]–•–æ—Å—Ç:[/] {host}\n"
            f"[cyan]–ü–æ—Ä—Ç:[/] {port}\n"
            f"[cyan]–†–µ–∂–∏–º:[/] {'Development' if reload else 'Production'}\n"
            f"[cyan]–í–æ—Ä–∫–µ—Ä—ã:[/] {workers}",
            expand=False,
            border_style="cyan",
        )
    )
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º create_app –∏–∑ web.app
    try:
        from Systems.web.app import create_app
        from Systems.core.services_provider import BotServicesProvider
        from Systems.core.app_settings import load_app_settings
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SDB
        settings = load_app_settings()
        
        # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏, –±–µ–∑ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞)
        services = BotServicesProvider(settings=settings)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        try:
            await services.setup_services()
            console.print("[green]‚úÖ –°–µ—Ä–≤–∏—Å—ã SDB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã[/]")
        except Exception as e:
            console.print(f"[yellow]‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:[/] {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        app = create_app(sdb_services=services, debug=reload)
    except ImportError as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:[/] {e}")
        import traceback
        console.print(f"[dim]{traceback.format_exc()}[/]")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:[/] {e}")
        import traceback
        console.print(f"[dim]{traceback.format_exc()}[/]")
        raise typer.Exit(code=1)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º uvicorn
    try:
        config = uvicorn.Config(
            app=app,
            host=host,
            port=port,
            reload=reload,
            workers=workers if not reload else 1,  # reload –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç workers
            log_level="info",
        )
        server = uvicorn.Server(config)
        console.print(f"\n[bold green]‚úÖ –í–µ–±-–ø–∞–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω–∞![/]")
        console.print(f"[cyan]–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:[/] http://{host}:{port}")
        await server.serve()
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:[/] {e}")
        import traceback
        console.print(f"[dim]{traceback.format_exc()}[/]")
        raise typer.Exit(code=1)


@web_app.command(name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤–µ–±-–ø–∞–Ω–µ–ª–∏.")
def web_status_cmd():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤–µ–±-–ø–∞–Ω–µ–ª–∏."""
    console.print(Panel("[bold cyan]–°–¢–ê–¢–£–° –í–ï–ë-–ü–ê–ù–ï–õ–ò[/]", expand=False, border_style="cyan"))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
    import socket
    
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        result = sock.connect_ex(("127.0.0.1", 8000))
        sock.close()
        
        if result == 0:
            console.print("[green]‚úÖ –í–µ–±-–ø–∞–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω–∞[/]")
            console.print("[cyan]URL:[/] http://127.0.0.1:8000")
        else:
            console.print("[yellow]‚ö†Ô∏è –í–µ–±-–ø–∞–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞[/]")
    except Exception as e:
        console.print(f"[yellow]‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: {e}[/]")


if __name__ == "__main__":
    web_app()




======================================================================

------------------------------ FILE: Systems/cli/tasks.py ------------------------------
# cli/tasks.py
import asyncio
import json
import subprocess
import uuid
from datetime import datetime, timedelta
from pathlib import Path
from typing import Any, Dict, List, Optional

import psutil
import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

console = Console()
tasks_app = typer.Typer(name="tasks", help="üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã")

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∑–∞–¥–∞—á
TASKS_DIR = Path("Data/tasks")
TASKS_CONFIG_FILE = TASKS_DIR / "tasks_config.json"
TASKS_LOG_FILE = TASKS_DIR / "tasks.log"


def _ensure_tasks_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–¥–∞—á –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    TASKS_DIR.mkdir(parents=True, exist_ok=True)
    if not TASKS_CONFIG_FILE.exists():
        with open(TASKS_CONFIG_FILE, "w") as f:
            json.dump({"tasks": {}, "schedules": {}}, f)


def _load_tasks_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∑–∞–¥–∞—á"""
    _ensure_tasks_directory()
    try:
        with open(TASKS_CONFIG_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"tasks": {}, "schedules": {}}


def _save_tasks_config(config: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∑–∞–¥–∞—á"""
    _ensure_tasks_directory()
    with open(TASKS_CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def _log_task_event(task_id: str, event: str, details: str = ""):
    """–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏ –≤ –ª–æ–≥"""
    _ensure_tasks_directory()
    timestamp = datetime.now().isoformat()
    log_entry = f"[{timestamp}] {task_id}: {event}"
    if details:
        log_entry += f" - {details}"

    with open(TASKS_LOG_FILE, "a") as f:
        f.write(log_entry + "\n")


@tasks_app.command(name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.")
def tasks_list_cmd(
    status: Optional[str] = typer.Option(
        None,
        "--status",
        "-s",
        help="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: running, completed, failed, pending",
    ),
    limit: int = typer.Option(
        20, "--limit", "-l", help="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á", min=1, max=100
    ),
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á"""
    try:
        asyncio.run(_tasks_list_async(status, limit))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'tasks list': {e}[/]")
        raise typer.Exit(code=1)


async def _tasks_list_async(status: Optional[str], limit: int):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á"""
    console.print(
        Panel("[bold blue]–°–ü–ò–°–û–ö –ó–ê–î–ê–ß –°–ò–°–¢–ï–ú–´[/]", expand=False, border_style="blue")
    )

    config = _load_tasks_config()
    tasks = config.get("tasks", {})

    if not tasks:
        console.print("[yellow]–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    # –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
    filtered_tasks = []
    for task_id, task_info in tasks.items():
        if status is None or task_info.get("status") == status:
            filtered_tasks.append((task_id, task_info))

    if not filtered_tasks:
        console.print(f"[yellow]–ó–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{status}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
    filtered_tasks.sort(key=lambda x: x[1].get("created_at", ""), reverse=True)

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    filtered_tasks = filtered_tasks[:limit]

    table = Table(title=f"–ó–∞–¥–∞—á–∏ —Å–∏—Å—Ç–µ–º—ã (–ø–æ–∫–∞–∑–∞–Ω–æ: {len(filtered_tasks)})")
    table.add_column("ID", style="cyan")
    table.add_column("–ù–∞–∑–≤–∞–Ω–∏–µ", style="white")
    table.add_column("–¢–∏–ø", style="blue")
    table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
    table.add_column("–°–æ–∑–¥–∞–Ω–∞", style="yellow")
    table.add_column("–ü—Ä–æ–≥—Ä–µ—Å—Å", style="red")

    for task_id, task_info in filtered_tasks:
        created_at = task_info.get("created_at", "")
        if created_at:
            try:
                dt = datetime.fromisoformat(created_at)
                created_str = dt.strftime("%Y-%m-%d %H:%M")
            except:
                created_str = created_at
        else:
            created_str = "N/A"

        status = task_info.get("status", "unknown")
        status_color = {
            "running": "green",
            "completed": "blue",
            "failed": "red",
            "pending": "yellow",
            "cancelled": "red",
        }.get(status, "white")

        progress = task_info.get("progress", "0%")

        table.add_row(
            task_id,
            task_info.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"),
            task_info.get("type", "unknown"),
            f"[{status_color}]{status}[/{status_color}]",
            created_str,
            progress,
        )

    console.print(table)


@tasks_app.command(name="cancel", help="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É.")
def tasks_cancel_cmd(
    task_id: str = typer.Argument(..., help="ID –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã"),
    force: bool = typer.Option(False, "--force", "-f", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞"),
):
    """–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É"""
    try:
        asyncio.run(_tasks_cancel_async(task_id, force))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'tasks cancel': {e}[/]")
        raise typer.Exit(code=1)


async def _tasks_cancel_async(task_id: str, force: bool):
    """–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É"""
    console.print(
        Panel(
            f"[bold blue]–û–¢–ú–ï–ù–ê –ó–ê–î–ê–ß–ò: {task_id}[/]", expand=False, border_style="blue"
        )
    )

    config = _load_tasks_config()
    tasks = config.get("tasks", {})

    if task_id not in tasks:
        console.print(f"[bold red]–ó–∞–¥–∞—á–∞ '{task_id}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞[/]")
        raise typer.Exit(code=1)

    task_info = tasks[task_id]
    status = task_info.get("status", "unknown")

    if status == "completed":
        console.print(f"[yellow]–ó–∞–¥–∞—á–∞ '{task_id}' —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞[/]")
        return

    if status == "cancelled":
        console.print(f"[yellow]–ó–∞–¥–∞—á–∞ '{task_id}' —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–∞[/]")
        return

    if status == "failed":
        console.print(f"[yellow]–ó–∞–¥–∞—á–∞ '{task_id}' —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π[/]")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–¥–∞—á–∏
    pid = task_info.get("pid")
    if pid and status == "running":
        try:
            process = psutil.Process(pid)
            if not force:
                console.print(f"[yellow]–ó–∞–¥–∞—á–∞ '{task_id}' –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (PID: {pid})[/]")
                console.print("[dim]–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç–º–µ–Ω—ã[/]")
                return

            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
            process.terminate()
            try:
                process.wait(timeout=5)
            except psutil.TimeoutExpired:
                process.kill()

            console.print(f"[green]–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–¥–∞—á–∏ '{task_id}' (PID: {pid}) –∑–∞–≤–µ—Ä—à–µ–Ω[/]")
        except psutil.NoSuchProcess:
            console.print(
                f"[yellow]–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–¥–∞—á–∏ '{task_id}' (PID: {pid}) –Ω–µ –Ω–∞–π–¥–µ–Ω[/]"
            )
        except Exception as e:
            console.print(f"[yellow]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞: {e}[/]")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
    task_info["status"] = "cancelled"
    task_info["cancelled_at"] = datetime.now().isoformat()
    task_info["progress"] = "0%"

    _save_tasks_config(config)
    _log_task_event(task_id, "cancelled", f"force={force}")

    console.print(f"[green]–ó–∞–¥–∞—á–∞ '{task_id}' —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞[/]")


@tasks_app.command(name="schedule", help="–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É.")
def tasks_schedule_cmd(
    task_type: str = typer.Argument(
        ..., help="–¢–∏–ø –∑–∞–¥–∞—á–∏: backup, cleanup, sync, custom"
    ),
    schedule: str = typer.Option(
        ..., "--schedule", "-s", help="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (cron —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ 'now')"
    ),
    name: Optional[str] = typer.Option(None, "--name", "-n", help="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"),
    params: Optional[str] = typer.Option(
        None, "--params", "-p", help="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—á–∏ –≤ JSON"
    ),
):
    """–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É"""
    try:
        asyncio.run(_tasks_schedule_async(task_type, schedule, name, params))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'tasks schedule': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _tasks_schedule_async(
    task_type: str, schedule: str, name: Optional[str], params: Optional[str]
):
    """–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É"""
    console.print(
        Panel(
            f"[bold blue]–ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –ó–ê–î–ê–ß–ò: {task_type}[/]",
            expand=False,
            border_style="blue",
        )
    )

    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
    valid_types = ["backup", "cleanup", "sync", "custom"]
    if task_type not in valid_types:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–¥–∞—á–∏: {task_type}[/]")
        console.print(f"[dim]–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã: {', '.join(valid_types)}[/]")
        raise typer.Exit(code=1)

    # –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    task_params = {}
    if params:
        try:
            task_params = json.loads(params)
        except json.JSONDecodeError as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤ JSON –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö: {e}[/]")
            raise typer.Exit(code=1)

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–¥–∞—á–∏
    task_id = f"task_{uuid.uuid4().hex[:8]}"

    # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ
    task_info = {
        "id": task_id,
        "name": name or f"{task_type} task",
        "type": task_type,
        "schedule": schedule,
        "params": task_params,
        "status": "pending",
        "progress": "0%",
        "created_at": datetime.now().isoformat(),
        "scheduled_at": datetime.now().isoformat() if schedule == "now" else None,
    }

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = _load_tasks_config()
    config["tasks"][task_id] = task_info

    # –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è —Å–µ–π—á–∞—Å
    if schedule == "now":
        task_info["status"] = "running"
        task_info["started_at"] = datetime.now().isoformat()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        asyncio.create_task(_execute_task(task_id, task_info))

    _save_tasks_config(config)
    _log_task_event(task_id, "scheduled", f"type={task_type}, schedule={schedule}")

    console.print(f"[green]–ó–∞–¥–∞—á–∞ '{task_id}' —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞[/]")
    console.print(f"[dim]–¢–∏–ø: {task_type}[/]")
    console.print(f"[dim]–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: {schedule}[/]")
    if name:
        console.print(f"[dim]–ù–∞–∑–≤–∞–Ω–∏–µ: {name}[/]")


async def _execute_task(task_id: str, task_info: Dict[str, Any]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É"""
    task_type = task_info["type"]

    try:
        _log_task_event(task_id, "started")

        if task_type == "backup":
            await _execute_backup_task(task_id, task_info)
        elif task_type == "cleanup":
            await _execute_cleanup_task(task_id, task_info)
        elif task_type == "sync":
            await _execute_sync_task(task_id, task_info)
        elif task_type == "custom":
            await _execute_custom_task(task_id, task_info)
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–¥–∞—á–∏: {task_type}")

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
        config = _load_tasks_config()
        if task_id in config["tasks"]:
            config["tasks"][task_id]["status"] = "completed"
            config["tasks"][task_id]["progress"] = "100%"
            config["tasks"][task_id]["completed_at"] = datetime.now().isoformat()
            _save_tasks_config(config)
            _log_task_event(task_id, "completed")

    except Exception as e:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—à–∏–±–∫—É
        config = _load_tasks_config()
        if task_id in config["tasks"]:
            config["tasks"][task_id]["status"] = "failed"
            config["tasks"][task_id]["error"] = str(e)
            config["tasks"][task_id]["failed_at"] = datetime.now().isoformat()
            _save_tasks_config(config)
            _log_task_event(task_id, "failed", str(e))


async def _execute_backup_task(task_id: str, task_info: Dict[str, Any]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"""
    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: {task_id}[/]")

    # –°–∏–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    await asyncio.sleep(2)

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    console.print(f"[green]–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: {task_id}[/]")


async def _execute_cleanup_task(task_id: str, task_info: Dict[str, Any]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏"""
    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏: {task_id}[/]")

    # –°–∏–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    await asyncio.sleep(1)

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏
    console.print(f"[green]–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {task_id}[/]")


async def _execute_sync_task(task_id: str, task_info: Dict[str, Any]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {task_id}[/]")

    # –°–∏–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    await asyncio.sleep(3)

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    console.print(f"[green]–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {task_id}[/]")


async def _execute_custom_task(task_id: str, task_info: Dict[str, Any]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∑–∞–¥–∞—á—É"""
    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–∏: {task_id}[/]")

    params = task_info.get("params", {})
    command = params.get("command")

    if command:
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
            process = await asyncio.create_subprocess_exec(
                *command.split(),
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE,
            )

            stdout, stderr = await process.communicate()

            if process.returncode == 0:
                console.print(f"[green]–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ: {command}[/]")
            else:
                raise Exception(f"–ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: {stderr.decode()}")

        except Exception as e:
            raise Exception(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: {e}")
    else:
        # –°–∏–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        await asyncio.sleep(1)
        console.print(f"[green]–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {task_id}[/]")


@tasks_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ.")
def tasks_info_cmd(task_id: str = typer.Argument(..., help="ID –∑–∞–¥–∞—á–∏")):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ"""
    try:
        asyncio.run(_tasks_info_async(task_id))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'tasks info': {e}[/]")
        raise typer.Exit(code=1)


async def _tasks_info_async(task_id: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ"""
    console.print(
        Panel(
            f"[bold blue]–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–î–ê–ß–ï: {task_id}[/]",
            expand=False,
            border_style="blue",
        )
    )

    config = _load_tasks_config()
    tasks = config.get("tasks", {})

    if task_id not in tasks:
        console.print(f"[bold red]–ó–∞–¥–∞—á–∞ '{task_id}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞[/]")
        raise typer.Exit(code=1)

    task_info = tasks[task_id]

    console.print(f"[cyan]ID:[/] {task_id}")
    console.print(f"[cyan]–ù–∞–∑–≤–∞–Ω–∏–µ:[/] {task_info.get('name', 'N/A')}")
    console.print(f"[cyan]–¢–∏–ø:[/] {task_info.get('type', 'N/A')}")
    console.print(f"[cyan]–°—Ç–∞—Ç—É—Å:[/] {task_info.get('status', 'N/A')}")
    console.print(f"[cyan]–ü—Ä–æ–≥—Ä–µ—Å—Å:[/] {task_info.get('progress', 'N/A')}")
    console.print(f"[cyan]–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:[/] {task_info.get('schedule', 'N/A')}")
    console.print(f"[cyan]–°–æ–∑–¥–∞–Ω–∞:[/] {task_info.get('created_at', 'N/A')}")

    if task_info.get("started_at"):
        console.print(f"[cyan]–ù–∞—á–∞—Ç–∞:[/] {task_info['started_at']}")

    if task_info.get("completed_at"):
        console.print(f"[cyan]–ó–∞–≤–µ—Ä—à–µ–Ω–∞:[/] {task_info['completed_at']}")

    if task_info.get("failed_at"):
        console.print(f"[cyan]–û—à–∏–±–∫–∞:[/] {task_info['failed_at']}")
        console.print(f"[cyan]–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:[/] {task_info.get('error', 'N/A')}")

    if task_info.get("cancelled_at"):
        console.print(f"[cyan]–û—Ç–º–µ–Ω–µ–Ω–∞:[/] {task_info['cancelled_at']}")

    if task_info.get("params"):
        console.print(
            f"[cyan]–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:[/] {json.dumps(task_info['params'], indent=2)}"
        )


if __name__ == "__main__":
    tasks_app()



======================================================================

------------------------------ FILE: Systems/cli/config.py ------------------------------
# --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê cli/config.py ---
import sys
from pathlib import Path
from typing import Any, Dict, List, Optional

import typer
import yaml
from dotenv import find_dotenv, set_key
from rich.console import Console
from rich.panel import Panel
from rich.syntax import Syntax

from .utils import (PROJECT_ROOT, USER_CONFIG_DIR_NAME,
                    USER_CORE_CONFIG_FILENAME, USER_MODULES_CONFIG_DIR_NAME,
                    confirm_action, read_yaml_file, sdb_console,
                    write_yaml_file)

# --- Typer App –¥–ª—è –≥—Ä—É–ø–ø—ã –∫–æ–º–∞–Ω–¥ 'config' ---
config_app = typer.Typer(
    name="config",
    help="üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π SwiftDevBot (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Å–º–æ—Ç—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–µ).",
    rich_markup_mode="rich",
    no_args_is_help=True,
)

ENV_FILENAME = ".env"


# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
def _update_env_file(key: str, value: str) -> bool:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç .env —Ñ–∞–π–ª."""
    env_path = find_dotenv(
        filename=ENV_FILENAME, usecwd=True, raise_error_if_not_found=False
    )
    if not env_path:
        env_path = PROJECT_ROOT / ENV_FILENAME
        sdb_console.print(
            f"[dim]–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π: {env_path}[/dim]"
        )
        env_path.touch()
    try:
        set_key(
            dotenv_path=env_path,
            key_to_set=key,
            value_to_set=value,
            quote_mode="always",
        )
        sdb_console.print(
            f"[green]‚úì[/] –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è [cyan]{key}[/] —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ [yellow]{env_path}[/yellow]"
        )
        return True
    except Exception as e:
        sdb_console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ .env —Ñ–∞–π–ª ({env_path}): {e}[/bold red]"
        )
        return False


def _get_project_data_path() -> Path:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å –∫ Data (–±—ã–ª–æ project_data), –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."""
    from Systems.core.app_settings import CoreAppSettings

    default_path = CoreAppSettings.model_fields["project_data_path"].default
    return (PROJECT_ROOT / default_path).resolve()


# --- –ö–æ–º–∞–Ω–¥—ã CLI ---


@config_app.command(
    name="init", help="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."
)
def init_command(
    force: bool = typer.Option(
        False, "--force", "-f", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏."
    )
):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–∑–∞—Ä–¥ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞."""
    sdb_console.print(
        Panel("ü§ñ [bold cyan]–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π—â–∏–∫ SwiftDevBot[/]", expand=False)
    )

    # –®–∞–≥ 1: –¢–æ–∫–µ–Ω –ë–æ—Ç–∞
    sdb_console.print("\n--- [bold]–®–∞–≥ 1: –¢–æ–∫–µ–Ω Telegram –ë–æ—Ç–∞[/bold] ---")
    bot_token = typer.prompt(
        "üîë –í–≤–µ–¥–∏—Ç–µ –≤–∞—à BOT_TOKEN (–ø–æ–ª—É—á–∏—Ç—å —É @BotFather)", hide_input=True
    )
    if not bot_token or len(bot_token.split(":")) != 2:
        sdb_console.print(
            "[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞.[/bold red]"
        )
        raise typer.Exit(1)
    _update_env_file("BOT_TOKEN", bot_token)

    # –®–∞–≥ 2: –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö
    sdb_console.print("\n--- [bold]–®–∞–≥ 2: –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö[/bold] ---")
    db_type_choice = typer.prompt(
        "üóÑÔ∏è –¢–∏–ø –ë–î: [1] sqlite, [2] postgresql, [3] mysql", default="1"
    )

    env_vars_to_set: Dict[str, str] = {}
    if db_type_choice == "1":
        env_vars_to_set["SDB_DB_TYPE"] = "sqlite"
        env_vars_to_set["SDB_DB_SQLITE_PATH"] = "Database_files/swiftdevbot.db"
    elif db_type_choice in ["2", "3"]:
        db_type = "postgresql" if db_type_choice == "2" else "mysql"
        sdb_console.print(f"--- [bold]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ {db_type.capitalize()}[/bold] ---")
        host = typer.prompt("  üåê –•–æ—Å—Ç", default="localhost")
        port = typer.prompt(
            "  üö™ –ü–æ—Ä—Ç", default="5432" if db_type == "postgresql" else "3306"
        )
        user = typer.prompt("  üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        password = typer.prompt("  üîí –ü–∞—Ä–æ–ª—å", hide_input=True)
        dbname = typer.prompt("  üíæ –ò–º—è –ë–î")
        driver = "psycopg" if db_type == "postgresql" else "aiomysql"
        dsn = f"{db_type}+{driver}://{user}:{password}@{host}:{port}/{dbname}"
        if db_type == "mysql":
            dsn += "?charset=utf8mb4"
        env_vars_to_set["SDB_DB_TYPE"] = db_type
        env_key = "SDB_DB_PG_DSN" if db_type == "postgresql" else "SDB_DB_MYSQL_DSN"
        env_vars_to_set[env_key] = dsn
    else:
        sdb_console.print("[bold red]–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞.[/bold red]")
        raise typer.Exit(1)

    for key, value in env_vars_to_set.items():
        _update_env_file(key, value)

    # –®–∞–≥ 3: –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    sdb_console.print("\n--- [bold]–®–∞–≥ 3: –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä[/bold] ---")
    super_admin_id = typer.prompt("üëë –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID (—á–∏—Å–ª–æ–≤–æ–π)")
    if not super_admin_id.isdigit():
        sdb_console.print(
            "[bold red]–û—à–∏–±–∫–∞: Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.[/bold red]"
        )
        raise typer.Exit(1)
    _update_env_file("SDB_CORE_SUPER_ADMINS", super_admin_id)

    # –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ core_settings.yaml
    sdb_console.print("\n--- [bold]–®–∞–≥ 4: –§–∞–π–ª –±–∞–∑–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫[/bold] ---")
    project_data_path = _get_project_data_path()
    user_config_file = (
        project_data_path / USER_CONFIG_DIR_NAME / USER_CORE_CONFIG_FILENAME
    )

    if (
        user_config_file.exists()
        and not force
        and not confirm_action(
            f"–§–∞–π–ª {user_config_file} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ?",
            default_choice=False,
            abort_on_false=False,
        )
    ):
        sdb_console.print("[yellow]–°–æ–∑–¥–∞–Ω–∏–µ core_settings.yaml –ø—Ä–æ–ø—É—â–µ–Ω–æ.[/yellow]")
    else:
        from Systems.core.app_settings import AppSettings

        default_settings = AppSettings(telegram={"token": "dummy"}).model_dump(
            exclude_defaults=False
        )
        # –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env
        del default_settings["telegram"]
        del default_settings["db"]
        del default_settings["core"]["super_admins"]

        if write_yaml_file(user_config_file, default_settings):
            sdb_console.print(
                f"[green]‚úì[/] –§–∞–π–ª [yellow]{user_config_file}[/yellow] —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω."
            )

    sdb_console.print(
        Panel("‚úÖ [bold green]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞![/]", expand=False)
    )
    sdb_console.print("üí° [bold]–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:[/bold] [cyan]sdb db upgrade head[/cyan]")


@config_app.command(
    "get", help="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞."
)
def get_command(
    key: Optional[str] = typer.Argument(None, help="–ö–ª—é—á (–Ω–∞–ø—Ä. 'db.type')"),
    show_defaults: bool = typer.Option(False, "--show-defaults"),
):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SDB."""
    try:
        from Systems.core.app_settings import settings

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ app_settings
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}[/bold red]")
        raise typer.Exit(1)

    if key is None:
        config_dict = settings.model_dump(
            mode="json", exclude_defaults=not show_defaults
        )
        yaml_output = yaml.dump(config_dict, indent=2, sort_keys=False)
        sdb_console.print(
            Panel("[bold cyan]–ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SwiftDevBot[/]", expand=False)
        )
        sdb_console.print(
            Syntax(yaml_output, "yaml", theme="native", line_numbers=True)
        )
    else:
        try:
            value = settings
            for part in key.split("."):
                value = getattr(value, part) if hasattr(value, part) else value[part]  # type: ignore

            if hasattr(value, "model_dump"):
                value = value.model_dump(mode="json")

            # –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            sdb_console.print(Panel(f"[bold cyan]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {key}[/]", expand=False))

            if isinstance(value, dict):
                yaml_output = yaml.dump(value, indent=2, sort_keys=False)
                sdb_console.print(Syntax(yaml_output, "yaml", theme="native"))
            else:
                sdb_console.print(f"   [green]–ó–Ω–∞—á–µ–Ω–∏–µ:[/green] {value}")
                sdb_console.print(f"   [blue]–¢–∏–ø:[/blue] {type(value).__name__}")

        except (AttributeError, KeyError):
            sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞: –ö–ª—é—á '{key}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/bold red]")
            raise typer.Exit(1)


@config_app.command("set", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ core_settings.yaml –∏–ª–∏ .env.")
def set_command(
    key: str = typer.Argument(..., help="–ö–ª—é—á –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–∞–ø—Ä. 'core.log_level')"),
    value: str = typer.Argument(..., help="–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ."),
):
    """–ò–∑–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —è–¥—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    sdb_console.print(
        f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å [cyan]{key}[/] = [green]'{value}'[/green]..."
    )

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    env_map = {
        "telegram.token": "BOT_TOKEN",
        "db.pg_dsn": "SDB_DB_PG_DSN",
        "db.mysql_dsn": "SDB_DB_MYSQL_DSN",
        "core.super_admins": "SDB_CORE_SUPER_ADMINS",
    }
    if key.lower() in env_map:
        _update_env_file(env_map[key.lower()], value)
        return

    # –ï—Å–ª–∏ –Ω–µ—Ç, —Ä–∞–±–æ—Ç–∞–µ–º —Å core_settings.yaml
    project_data_path = _get_project_data_path()
    config_file = project_data_path / USER_CONFIG_DIR_NAME / USER_CORE_CONFIG_FILENAME
    config_data = read_yaml_file(config_file)
    if config_data is None:
        sdb_console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª {config_file}.[/bold red]\n–ó–∞–ø—É—Å—Ç–∏—Ç–µ 'sdb config init', —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ."
        )
        raise typer.Exit(1)

    keys = key.split(".")
    current_level = config_data
    for i, k in enumerate(keys[:-1]):
        if k not in current_level or not isinstance(current_level[k], dict):
            current_level[k] = {}
        current_level = current_level[k]

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
    final_value: Any = value
    if value.lower() in ["true", "false"]:
        final_value = value.lower() == "true"
    elif value.isdigit():
        final_value = int(value)
    else:
        try:
            final_value = float(value)
        except ValueError:
            pass

    current_level[keys[-1]] = final_value

    if write_yaml_file(config_file, config_data):
        sdb_console.print(
            f"[green]‚úì[/] –ö–ª—é—á [cyan]{key}[/] –æ–±–Ω–æ–≤–ª–µ–Ω –≤ [yellow]{config_file}[/yellow]."
        )
        sdb_console.print(
            "[yellow]–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.[/yellow]"
        )


@config_app.command("notifications", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ.")
def notifications_command(
    enable: bool = typer.Option(True, "--enable/--disable", help="–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.")
):
    """–£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞."""
    sdb_console.print(
        f"üîï –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏: {'–≤–∫–ª—é—á–µ–Ω—ã' if enable else '–æ—Ç–∫–ª—é—á–µ–Ω—ã'}"
    )
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —á–µ—Ä–µ–∑ set_command
    set_command("core.enable_startup_shutdown_notifications", str(enable).lower())


@config_app.command("set-module", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è.")
def set_module_command(
    module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è (–∏–∑ manifest.name)."),
    key: str = typer.Argument(..., help="–ö–ª—é—á –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –º–æ–¥—É–ª–µ."),
    value: str = typer.Argument(..., help="–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ."),
):
    """–ò–∑–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è."""
    sdb_console.print(
        f"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è [magenta]{module_name}[/]: [cyan]{key}[/] = [green]'{value}'[/green]"
    )

    project_data_path = _get_project_data_path()
    module_config_file = (
        project_data_path
        / USER_CONFIG_DIR_NAME
        / USER_MODULES_CONFIG_DIR_NAME
        / f"{module_name}.yaml"
    )

    config_data = read_yaml_file(module_config_file) or {}

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    final_value: Any = value
    if value.lower() in ["true", "false"]:
        final_value = value.lower() == "true"
    elif value.isdigit():
        final_value = int(value)
    else:
        try:
            final_value = float(value)
        except ValueError:
            pass

    config_data[key] = final_value

    if write_yaml_file(module_config_file, config_data):
        sdb_console.print(
            f"[green]‚úì[/] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª—è [magenta]{module_name}[/] –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ [yellow]{module_config_file}[/yellow]."
        )
        sdb_console.print(
            "[yellow]–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.[/yellow]"
        )


if __name__ == "__main__":
    config_app()  # --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê cli/config.py ---



======================================================================

------------------------------ FILE: Systems/cli/monitor.py ------------------------------
# --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê cli/monitor.py ---
import asyncio
import json
import logging
import os
import platform
import sqlite3
import time
from datetime import datetime, timedelta
from pathlib import Path
from typing import Any, Dict, List, Optional, Tuple

import aiohttp
import psutil
import typer
from rich.console import Console
from rich.live import Live
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.table import Table
from rich.text import Text

# –ò–º–ø–æ—Ä—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SDB —Å–µ—Ä–≤–∏—Å–∞–º–∏
try:
    from Systems.cli.utils import get_sdb_services_for_cli
except ImportError:
    # Fallback –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    async def get_sdb_services_for_cli(init_db=False):
        raise ImportError("get_sdb_services_for_cli –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞")


from rich.align import Align
from rich.layout import Layout

from Systems.cli.utils import format_size, get_sdb_services_for_cli

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞–µ–º Typer-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
monitor_app = typer.Typer(
    name="monitor",
    help="üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã SwiftDevBot",
    rich_markup_mode="rich",
)

console = Console()

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
MONITOR_DIR = Path("Data/monitor")
METRICS_DB = MONITOR_DIR / "metrics.db"
ALERTS_CONFIG = MONITOR_DIR / "alerts_config.json"
METRICS_HISTORY_FILE = MONITOR_DIR / "metrics_history.json"

# –ü–æ—Ä–æ–≥–∏ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
DEFAULT_ALERTS = {
    "cpu": {"warning": 70, "critical": 90},
    "memory": {"warning": 80, "critical": 95},
    "disk": {"warning": 85, "critical": 95},
    "response_time": {"warning": 2.0, "critical": 5.0},
}


def _ensure_monitor_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    MONITOR_DIR.mkdir(parents=True, exist_ok=True)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –º–µ—Ç—Ä–∏–∫
    if not METRICS_DB.exists():
        _init_metrics_database()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤
    if not ALERTS_CONFIG.exists():
        _init_alerts_config()


def _init_metrics_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–µ—Ç—Ä–∏–∫"""
    conn = sqlite3.connect(METRICS_DB)
    cursor = conn.cursor()

    cursor.execute(
        """
        CREATE TABLE IF NOT EXISTS metrics (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
            cpu_percent REAL,
            memory_percent REAL,
            disk_percent REAL,
            network_bytes_sent INTEGER,
            network_bytes_recv INTEGER,
            response_time REAL,
            bot_status TEXT,
            db_status TEXT
        )
    """
    )

    cursor.execute(
        """
        CREATE INDEX IF NOT EXISTS idx_timestamp 
        ON metrics(timestamp)
    """
    )

    conn.commit()
    conn.close()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")


def _init_alerts_config():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤"""
    config = {
        "alerts": DEFAULT_ALERTS,
        "notifications": {
            "enabled": True,
            "channels": ["telegram_admin"],
            "cooldown": 300,  # 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
        },
        "history": {"enabled": True, "retention_days": 30},
    }

    with open(ALERTS_CONFIG, "w") as f:
        json.dump(config, f, indent=2)

    logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")


def _load_alerts_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–ª–µ—Ä—Ç–æ–≤"""
    _ensure_monitor_directory()
    try:
        with open(ALERTS_CONFIG, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"alerts": DEFAULT_ALERTS, "notifications": {"enabled": True}}


def _save_metrics_to_db(metrics: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = sqlite3.connect(METRICS_DB)
        cursor = conn.cursor()

        cursor.execute(
            """
            INSERT INTO metrics 
            (cpu_percent, memory_percent, disk_percent, network_bytes_sent, 
             network_bytes_recv, response_time, bot_status, db_status)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """,
            (
                metrics.get("cpu_percent", 0),
                metrics.get("memory_percent", 0),
                metrics.get("disk_percent", 0),
                metrics.get("network_bytes_sent", 0),
                metrics.get("network_bytes_recv", 0),
                metrics.get("response_time", 0),
                metrics.get("bot_status", "unknown"),
                metrics.get("db_status", "unknown"),
            ),
        )

        conn.commit()
        conn.close()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –≤ –ë–î: {e}")


def _get_metrics_history(hours: int = 24) -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–µ—Ç—Ä–∏–∫"""
    try:
        conn = sqlite3.connect(METRICS_DB)
        cursor = conn.cursor()

        since = datetime.now() - timedelta(hours=hours)

        cursor.execute(
            """
            SELECT * FROM metrics 
            WHERE timestamp >= ? 
            ORDER BY timestamp DESC
        """,
            (since,),
        )

        columns = [description[0] for description in cursor.description]
        rows = cursor.fetchall()

        conn.close()

        return [dict(zip(columns, row)) for row in rows]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –º–µ—Ç—Ä–∏–∫: {e}")
        return []


async def _check_alerts(metrics: Dict[str, Any]) -> List[Dict[str, Any]]:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º –∞–ª–µ—Ä—Ç–æ–≤"""
    config = _load_alerts_config()
    alerts = []

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ CPU
    cpu_percent = metrics.get("cpu_percent", 0)
    if cpu_percent > config["alerts"]["cpu"]["critical"]:
        alerts.append(
            {
                "type": "critical",
                "metric": "cpu",
                "value": cpu_percent,
                "threshold": config["alerts"]["cpu"]["critical"],
                "message": f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU: {cpu_percent:.1f}%",
            }
        )
    elif cpu_percent > config["alerts"]["cpu"]["warning"]:
        alerts.append(
            {
                "type": "warning",
                "metric": "cpu",
                "value": cpu_percent,
                "threshold": config["alerts"]["cpu"]["warning"],
                "message": f"–í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU: {cpu_percent:.1f}%",
            }
        )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
    memory_percent = metrics.get("memory_percent", 0)
    if memory_percent > config["alerts"]["memory"]["critical"]:
        alerts.append(
            {
                "type": "critical",
                "metric": "memory",
                "value": memory_percent,
                "threshold": config["alerts"]["memory"]["critical"],
                "message": f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {memory_percent:.1f}%",
            }
        )
    elif memory_percent > config["alerts"]["memory"]["warning"]:
        alerts.append(
            {
                "type": "warning",
                "metric": "memory",
                "value": memory_percent,
                "threshold": config["alerts"]["memory"]["warning"],
                "message": f"–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {memory_percent:.1f}%",
            }
        )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞
    disk_percent = metrics.get("disk_percent", 0)
    if disk_percent > config["alerts"]["disk"]["critical"]:
        alerts.append(
            {
                "type": "critical",
                "metric": "disk",
                "value": disk_percent,
                "threshold": config["alerts"]["disk"]["critical"],
                "message": f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: {disk_percent:.1f}%",
            }
        )
    elif disk_percent > config["alerts"]["disk"]["warning"]:
        alerts.append(
            {
                "type": "warning",
                "metric": "disk",
                "value": disk_percent,
                "threshold": config["alerts"]["disk"]["warning"],
                "message": f"–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: {disk_percent:.1f}%",
            }
        )

    return alerts


async def _send_alert_notifications(alerts: List[Dict[str, Any]]):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–ª–µ—Ä—Ç–∞—Ö"""
    if not alerts:
        return

    config = _load_alerts_config()
    if not config.get("notifications", {}).get("enabled", False):
        return

    try:
        from Systems.cli.notifications import (_load_notifications_config,
                                       _send_notification_by_type)

        notifications_config = _load_notifications_config()
        channels = notifications_config.get("channels", {})

        for alert in alerts:
            priority = "urgent" if alert["type"] == "critical" else "high"
            message = f"üö® –ê–õ–ï–†–¢: {alert['message']}\n\n–ú–µ—Ç—Ä–∏–∫–∞: {alert['metric']}\n–ó–Ω–∞—á–µ–Ω–∏–µ: {alert['value']:.1f}\n–ü–æ—Ä–æ–≥: {alert['threshold']:.1f}"

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            for channel_name in config["notifications"]["channels"]:
                if (
                    channel_name in channels
                    and channels[channel_name].get("status") == "active"
                ):
                    await _send_notification_by_type(
                        channels[channel_name], message, priority
                    )

    except ImportError:
        logger.warning("–ú–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∞–ª–µ—Ä—Ç–∞—Ö: {e}")


# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---


def _get_system_info() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ."""
    return {
        "platform": platform.system(),
        "platform_version": platform.version(),
        "architecture": platform.architecture()[0],
        "processor": platform.processor(),
        "hostname": platform.node(),
        "python_version": platform.python_version(),
    }


def _get_cpu_info() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ CPU."""
    cpu_percent = psutil.cpu_percent(interval=1)
    cpu_count = psutil.cpu_count()
    cpu_freq = psutil.cpu_freq()

    return {
        "percent": cpu_percent,
        "count": cpu_count,
        "frequency": cpu_freq.current if cpu_freq else None,
        "load_avg": psutil.getloadavg() if hasattr(psutil, "getloadavg") else None,
    }


def _get_memory_info() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–º—è—Ç–∏."""
    memory = psutil.virtual_memory()
    swap = psutil.swap_memory()

    return {
        "total": memory.total,
        "available": memory.available,
        "used": memory.used,
        "percent": memory.percent,
        "swap_total": swap.total,
        "swap_used": swap.used,
        "swap_percent": swap.percent,
    }


def _get_disk_info() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏—Å–∫–µ."""
    disk = psutil.disk_usage("/")
    disk_io = psutil.disk_io_counters()

    return {
        "total": disk.total,
        "used": disk.used,
        "free": disk.free,
        "percent": disk.percent,
        "read_bytes": disk_io.read_bytes if disk_io else 0,
        "write_bytes": disk_io.write_bytes if disk_io else 0,
    }


def _get_network_info() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ç–∏."""
    network_io = psutil.net_io_counters()

    return {
        "bytes_sent": network_io.bytes_sent,
        "bytes_recv": network_io.bytes_recv,
        "packets_sent": network_io.packets_sent,
        "packets_recv": network_io.packets_recv,
    }


async def _get_bot_status() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞."""
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        try:
            settings, db_manager, _ = await get_sdb_services_for_cli()
            bot_token = settings.bot_token
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø—Ä–æ–±—É–µ–º –∏–∑ .env
            try:
                from dotenv import load_dotenv

                load_dotenv()
                bot_token = os.getenv("BOT_TOKEN")
                if not bot_token:
                    return {
                        "status": "error",
                        "error": "BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–ª–∏ .env",
                        "response_time": 0,
                        "uptime": "unknown",
                    }
            except Exception:
                return {
                    "status": "error",
                    "error": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å BOT_TOKEN",
                    "response_time": 0,
                    "uptime": "unknown",
                }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Bot API
        try:
            import aiohttp

            async with aiohttp.ClientSession() as session:
                url = f"https://api.telegram.org/bot{bot_token}/getMe"
                start_time = time.time()
                async with session.get(url, timeout=10) as response:
                    response_time = time.time() - start_time

                    if response.status == 200:
                        data = await response.json()
                        if data.get("ok"):
                            return {
                                "status": "active",
                                "username": data.get("result", {}).get(
                                    "username", "unknown"
                                ),
                                "response_time": response_time,
                                "uptime": "running",
                            }
                        else:
                            return {
                                "status": "error",
                                "error": f"Telegram API error: {data.get('description', 'Unknown error')}",
                                "response_time": response_time,
                                "uptime": "unknown",
                            }
                    else:
                        return {
                            "status": "error",
                            "error": f"HTTP {response.status}",
                            "response_time": response_time,
                            "uptime": "unknown",
                        }
        except aiohttp.ClientError as e:
            return {
                "status": "error",
                "error": f"Network error: {str(e)}",
                "response_time": 0,
                "uptime": "unknown",
            }
        except Exception as e:
            return {
                "status": "error",
                "error": f"Request error: {str(e)}",
                "response_time": 0,
                "uptime": "unknown",
            }

    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "response_time": 0,
            "uptime": "unknown",
        }


async def _get_database_status() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        try:
            settings, db_manager, _ = await get_sdb_services_for_cli(init_db=True)
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å SQLite —Ñ–∞–π–ª
            try:
                from dotenv import load_dotenv

                load_dotenv()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º SQLite —Ñ–∞–π–ª
                db_path = os.getenv("DB_SQLITE_PATH", "Data/database.db")
                if os.path.exists(db_path):
                    import sqlite3

                    conn = sqlite3.connect(db_path)
                    cursor = conn.cursor()
                    start_time = time.time()
                    cursor.execute("SELECT 1")
                    response_time = time.time() - start_time
                    conn.close()

                    return {
                        "status": "connected",
                        "response_time": response_time,
                        "type": "sqlite",
                        "url": db_path,
                    }
                else:
                    return {
                        "status": "error",
                        "error": f"Database file not found: {db_path}",
                        "response_time": 0,
                        "type": "unknown",
                    }
            except Exception as db_error:
                return {
                    "status": "error",
                    "error": f"Database check failed: {str(db_error)}",
                    "response_time": 0,
                    "type": "unknown",
                }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
        try:
            if db_manager is None:
                return {
                    "status": "error",
                    "error": "Database manager is None - database not initialized",
                    "response_time": 0,
                    "type": "unknown",
                }

            start_time = time.time()
            async with db_manager.get_session() as session:
                # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                from sqlalchemy import text

                result = await session.execute(text("SELECT 1"))
                response_time = time.time() - start_time

                return {
                    "status": "connected",
                    "response_time": response_time,
                    "type": settings.db.type,
                    "url": (
                        str(db_manager.url) if hasattr(db_manager, "url") else "unknown"
                    ),
                }
        except Exception as db_error:
            return {
                "status": "error",
                "error": f"Database connection failed: {str(db_error)}",
                "response_time": 0,
                "type": settings.db.type if settings else "unknown",
            }

    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "response_time": 0,
            "type": "unknown",
        }


def _format_uptime(seconds: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã."""
    if seconds < 60:
        return f"{seconds:.0f} —Å–µ–∫—É–Ω–¥–∞" if seconds == 1 else f"{seconds:.0f} —Å–µ–∫—É–Ω–¥"
    elif seconds < 3600:
        minutes = seconds / 60
        return f"{minutes:.0f} –º–∏–Ω—É—Ç"
    elif seconds < 86400:
        hours = seconds / 3600
        return f"{hours:.0f} —á–∞—Å–æ–≤"
    else:
        days = seconds / 86400
        return f"{days:.0f} –¥–Ω–µ–π"


# --- CLI –∫–æ–º–∞–Ω–¥—ã ---


@monitor_app.command(name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã.")
def monitor_status_cmd(
    detailed: bool = typer.Option(
        False, "--detailed", "-d", help="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
    ),
    json_output: bool = typer.Option(False, "--json", help="–í—ã–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON"),
    health: bool = typer.Option(False, "--health", help="–¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è"),
    notify: Optional[str] = typer.Option(
        None, "--notify", help="–ö–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
    ),
):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã."""
    asyncio.run(_monitor_status_async(detailed, json_output, health, notify))


async def _monitor_status_async(
    detailed: bool, json_output: bool, health: bool, notify: Optional[str]
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞."""

    console.print(Panel.fit("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã", style="bold cyan"))

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏
    cpu_info = _get_cpu_info()
    memory_info = _get_memory_info()
    disk_info = _get_disk_info()
    network_info = _get_network_info()
    bot_status = await _get_bot_status()
    db_status = await _get_database_status()

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
    metrics = {
        "cpu_percent": cpu_info["percent"],
        "memory_percent": memory_info["percent"],
        "disk_percent": disk_info["percent"],
        "network_bytes_sent": network_info["bytes_sent"],
        "network_bytes_recv": network_info["bytes_recv"],
        "response_time": bot_status.get("response_time", 0),
        "bot_status": bot_status.get("status", "unknown"),
        "db_status": db_status.get("status", "unknown"),
    }

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î
    _save_metrics_to_db(metrics)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–µ—Ä—Ç—ã
    alerts = await _check_alerts(metrics)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª–µ—Ä—Ç—ã
    if alerts:
        await _send_alert_notifications(alerts)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    status_data = {
        "timestamp": datetime.now().isoformat(),
        "system": {
            "cpu": cpu_info,
            "memory": memory_info,
            "disk": disk_info,
            "network": network_info,
        },
        "services": {"bot": bot_status, "database": db_status},
        "alerts": alerts,
        "health": {
            "overall": "healthy" if not alerts else "unhealthy",
            "alerts_count": len(alerts),
        },
    }

    if json_output:
        console.print(json.dumps(status_data, indent=2))
        return

    if health:
        if alerts:
            console.print(f"[bold red]‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ–∑–¥–æ—Ä–æ–≤–∞: {len(alerts)} –∞–ª–µ—Ä—Ç–æ–≤[/]")
            for alert in alerts:
                console.print(f"   üî¥ {alert['message']}")
            raise typer.Exit(code=1)
        else:
            console.print("[bold green]‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–¥–æ—Ä–æ–≤–∞[/]")
            return

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å
    console.print("üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:")
    console.print(f"   üìä CPU: {cpu_info['percent']:.1f}% ({cpu_info['count']} —è–¥–µ—Ä)")
    console.print(
        f"   üíæ Memory: {memory_info['percent']:.1f}% ({format_size(memory_info['used'])}/{format_size(memory_info['total'])})"
    )
    console.print(
        f"   üíø Disk: {disk_info['percent']:.1f}% ({format_size(disk_info['used'])}/{format_size(disk_info['total'])})"
    )
    console.print()

    console.print("ü§ñ –°–µ—Ä–≤–∏—Å—ã:")
    bot_emoji = "üü¢" if bot_status["status"] == "active" else "üî¥"
    db_emoji = "üü¢" if db_status["status"] == "connected" else "üî¥"

    console.print(f"   {bot_emoji} Bot API: {bot_status['status']}")
    if bot_status["status"] == "active":
        console.print(
            f"      üìä Response time: {bot_status.get('response_time', 0):.3f}s"
        )
        console.print(f"      üë§ Username: {bot_status.get('username', 'unknown')}")

    console.print(f"   {db_emoji} Database: {db_status['status']}")
    if db_status["status"] == "connected":
        console.print(
            f"      üìä Response time: {db_status.get('response_time', 0):.3f}s"
        )
        console.print(f"      üîß Type: {db_status.get('type', 'unknown')}")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç—ã
    if alerts:
        console.print("\nüö® –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã:")
        for alert in alerts:
            emoji = "üî¥" if alert["type"] == "critical" else "üü°"
            console.print(f"   {emoji} {alert['message']}")
    else:
        console.print("\n‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–∞–Ω–∞–ª
    if notify:
        try:
            from Systems.cli.notifications import (_load_notifications_config,
                                           _send_notification_by_type)

            notifications_config = _load_notifications_config()
            channels = notifications_config.get("channels", {})

            if notify in channels and channels[notify].get("status") == "active":
                message = f"üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã SwiftDevBot\n\n"
                message += f"CPU: {cpu_info['percent']:.1f}%\n"
                message += f"Memory: {memory_info['percent']:.1f}%\n"
                message += f"Disk: {disk_info['percent']:.1f}%\n"
                message += f"Bot: {bot_status['status']}\n"
                message += f"Database: {db_status['status']}\n"

                if alerts:
                    message += f"\nüö® –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤: {len(alerts)}"
                    priority = "high"
                else:
                    message += f"\n‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–¥–æ—Ä–æ–≤–∞"
                    priority = "normal"

                await _send_notification_by_type(channels[notify], message, priority)
                console.print(f"[green]‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª '{notify}'[/]")
            else:
                console.print(
                    f"[yellow]‚ö†Ô∏è –ö–∞–Ω–∞–ª '{notify}' –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω[/]"
                )

        except ImportError:
            console.print("[yellow]‚ö†Ô∏è –ú–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}[/]")


@monitor_app.command(name="metrics", help="–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.")
def monitor_metrics_cmd(
    cpu: bool = typer.Option(False, "--cpu", help="–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"),
    memory: bool = typer.Option(False, "--memory", help="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏"),
    disk: bool = typer.Option(False, "--disk", help="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞"),
    network: bool = typer.Option(False, "--network", help="–°–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫"),
    real_time: bool = typer.Option(
        False, "--real-time", help="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
    ),
    history: bool = typer.Option(False, "--history", help="–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ"),
    hours: int = typer.Option(24, "--hours", help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏"),
):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
    asyncio.run(
        _monitor_metrics_async(cpu, memory, disk, network, real_time, history, hours)
    )


async def _monitor_metrics_async(
    cpu: bool,
    memory: bool,
    disk: bool,
    network: bool,
    real_time: bool,
    history: bool,
    hours: int,
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫."""

    # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
    if not any([cpu, memory, disk, network]):
        cpu = memory = disk = network = True

    if history:
        await _display_metrics_history(hours)
        return

    if real_time:
        await _display_metrics_realtime(cpu, memory, disk, network)
        return

    await _display_metrics(cpu, memory, disk, network)


async def _display_metrics(cpu: bool, memory: bool, disk: bool, network: bool):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏."""
    console.print(Panel.fit("üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã", style="bold cyan"))

    # –°–æ–±–∏—Ä–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
    metrics = {}

    if cpu:
        cpu_info = _get_cpu_info()
        metrics["cpu_percent"] = cpu_info["percent"]
        console.print("üñ•Ô∏è CPU (–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä):")
        console.print(f"   üìä –¢–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: {cpu_info['percent']:.1f}%")
        console.print(f"   üìà –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä: {cpu_info['count']}")
        if cpu_info["frequency"]:
            console.print(f"   üîß –ß–∞—Å—Ç–æ—Ç–∞: {cpu_info['frequency']:.0f}MHz")
        if cpu_info["load_avg"]:
            console.print(f"   üìà Load average: {cpu_info['load_avg'][0]:.2f}")
        console.print()

    if memory:
        memory_info = _get_memory_info()
        metrics["memory_percent"] = memory_info["percent"]
        console.print("üíæ Memory (–ü–∞–º—è—Ç—å):")
        console.print(
            f"   üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {format_size(memory_info['used'])} / {format_size(memory_info['total'])} ({memory_info['percent']:.1f}%)"
        )
        console.print(f"   üìà –î–æ—Å—Ç—É–ø–Ω–æ: {format_size(memory_info['available'])}")
        console.print(
            f"   üìà Swap: {format_size(memory_info['swap_used'])} / {format_size(memory_info['swap_total'])} ({memory_info['swap_percent']:.1f}%)"
        )
        console.print()

    if disk:
        disk_info = _get_disk_info()
        metrics["disk_percent"] = disk_info["percent"]
        console.print("üíø Disk (–î–∏—Å–∫):")
        console.print(
            f"   üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {format_size(disk_info['used'])} / {format_size(disk_info['total'])} ({disk_info['percent']:.1f}%)"
        )
        console.print(f"   üìà –°–≤–æ–±–æ–¥–Ω–æ: {format_size(disk_info['free'])}")
        console.print(f"   üìà –ü—Ä–æ—á–∏—Ç–∞–Ω–æ: {format_size(disk_info['read_bytes'])}")
        console.print(f"   üìà –ó–∞–ø–∏—Å–∞–Ω–æ: {format_size(disk_info['write_bytes'])}")
        console.print()

    if network:
        network_info = _get_network_info()
        metrics["network_bytes_sent"] = network_info["bytes_sent"]
        metrics["network_bytes_recv"] = network_info["bytes_recv"]
        console.print("üåê Network (–°–µ—Ç—å):")
        console.print(f"   üìä –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {format_size(network_info['bytes_sent'])}")
        console.print(f"   üìä –ü–æ–ª—É—á–µ–Ω–æ: {format_size(network_info['bytes_recv'])}")
        console.print(f"   üìà –ü–∞–∫–µ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {network_info['packets_sent']}")
        console.print(f"   üìà –ü–∞–∫–µ—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {network_info['packets_recv']}")
        console.print()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î
    if metrics:
        _save_metrics_to_db(metrics)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–µ—Ä—Ç—ã
    alerts = await _check_alerts(metrics)
    if alerts:
        console.print("üö® –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã:")
        for alert in alerts:
            emoji = "üî¥" if alert["type"] == "critical" else "üü°"
            console.print(f"   {emoji} {alert['message']}")
        console.print()


async def _display_metrics_realtime(cpu: bool, memory: bool, disk: bool, network: bool):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏."""
    console.print("üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)")

    def generate_layout():
        layout = Layout()
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="main"),
            Layout(name="footer", size=3),
        )
        layout["main"].split_row(Layout(name="left"), Layout(name="right"))
        return layout

    layout = generate_layout()

    try:
        with Live(layout, refresh_per_second=2, screen=True):
            while True:
                # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                metrics = {}

                if cpu:
                    cpu_info = _get_cpu_info()
                    metrics["cpu_percent"] = cpu_info["percent"]
                    layout["left"].update(
                        Panel(
                            (
                                f"üñ•Ô∏è CPU: {cpu_info['percent']:.1f}%\n"
                                f"üìà –Ø–¥–µ—Ä: {cpu_info['count']}\n"
                                f"üîß –ß–∞—Å—Ç–æ—Ç–∞: {cpu_info['frequency']:.0f}MHz"
                                if cpu_info["frequency"]
                                else "N/A"
                            ),
                            title="CPU",
                        )
                    )

                if memory:
                    memory_info = _get_memory_info()
                    metrics["memory_percent"] = memory_info["percent"]
                    layout["right"].update(
                        Panel(
                            f"üíæ Memory: {memory_info['percent']:.1f}%\n"
                            f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {format_size(memory_info['used'])}\n"
                            f"üìà –î–æ—Å—Ç—É–ø–Ω–æ: {format_size(memory_info['available'])}",
                            title="Memory",
                        )
                    )

                if disk:
                    disk_info = _get_disk_info()
                    metrics["disk_percent"] = disk_info["percent"]
                    layout["left"].update(
                        Panel(
                            f"üíø Disk: {disk_info['percent']:.1f}%\n"
                            f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {format_size(disk_info['used'])}\n"
                            f"üìà –°–≤–æ–±–æ–¥–Ω–æ: {format_size(disk_info['free'])}",
                            title="Disk",
                        )
                    )

                if network:
                    network_info = _get_network_info()
                    metrics["network_bytes_sent"] = network_info["bytes_sent"]
                    metrics["network_bytes_recv"] = network_info["bytes_recv"]
                    layout["right"].update(
                        Panel(
                            f"üåê Network\n"
                            f"üìä –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {format_size(network_info['bytes_sent'])}\n"
                            f"üìä –ü–æ–ª—É—á–µ–Ω–æ: {format_size(network_info['bytes_recv'])}",
                            title="Network",
                        )
                    )

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                if metrics:
                    _save_metrics_to_db(metrics)

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–µ—Ä—Ç—ã
                alerts = await _check_alerts(metrics)
                if alerts:
                    alert_text = "\n".join(
                        [f"üö® {alert['message']}" for alert in alerts]
                    )
                    layout["footer"].update(
                        Panel(alert_text, title="–ê–ª–µ—Ä—Ç—ã", style="red")
                    )
                else:
                    layout["footer"].update(
                        Panel("‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–¥–æ—Ä–æ–≤–∞", title="–°—Ç–∞—Ç—É—Å", style="green")
                    )

                layout["header"].update(
                    Panel(
                        f"üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ | {datetime.now().strftime('%H:%M:%S')}",
                        style="bold cyan",
                    )
                )

                await asyncio.sleep(2)

    except KeyboardInterrupt:
        console.print("\n‚èπÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


async def _display_metrics_history(hours: int):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –º–µ—Ç—Ä–∏–∫."""
    console.print(
        Panel.fit(f"üìà –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ {hours} —á–∞—Å–æ–≤)", style="bold cyan")
    )

    history = _get_metrics_history(hours)

    if not history:
        console.print("[yellow]–ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ –ø—É—Å—Ç–∞[/]")
        return

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    table = Table(title=f"–ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ ({len(history)} –∑–∞–ø–∏—Å–µ–π)")
    table.add_column("–í—Ä–µ–º—è", style="cyan")
    table.add_column("CPU %", style="yellow")
    table.add_column("Memory %", style="green")
    table.add_column("Disk %", style="blue")
    table.add_column("Network (MB)", style="magenta")

    for record in history[:50]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π
        timestamp = datetime.fromisoformat(record["timestamp"])
        cpu = record.get("cpu_percent", 0)
        memory = record.get("memory_percent", 0)
        disk = record.get("disk_percent", 0)
        network_sent = record.get("network_bytes_sent", 0) / (1024 * 1024)  # MB
        network_recv = record.get("network_bytes_recv", 0) / (1024 * 1024)  # MB

        table.add_row(
            timestamp.strftime("%H:%M:%S"),
            f"{cpu:.1f}",
            f"{memory:.1f}",
            f"{disk:.1f}",
            f"{network_sent:.1f}‚Üë/{network_recv:.1f}‚Üì",
        )

    console.print(table)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if history:
        cpu_values = [r.get("cpu_percent", 0) for r in history]
        memory_values = [r.get("memory_percent", 0) for r in history]
        disk_values = [r.get("disk_percent", 0) for r in history]

        console.print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        console.print(
            f"   CPU: –º–∏–Ω {min(cpu_values):.1f}%, –º–∞–∫—Å {max(cpu_values):.1f}%, —Å—Ä–µ–¥–Ω {sum(cpu_values)/len(cpu_values):.1f}%"
        )
        console.print(
            f"   Memory: –º–∏–Ω {min(memory_values):.1f}%, –º–∞–∫—Å {max(memory_values):.1f}%, —Å—Ä–µ–¥–Ω {sum(memory_values)/len(memory_values):.1f}%"
        )
        console.print(
            f"   Disk: –º–∏–Ω {min(disk_values):.1f}%, –º–∞–∫—Å {max(disk_values):.1f}%, —Å—Ä–µ–¥–Ω {sum(disk_values)/len(disk_values):.1f}%"
        )


@monitor_app.command(name="alerts", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–æ–≤–µ—â–µ–Ω–∏–π.")
def monitor_alerts_cmd(
    list_alerts: bool = typer.Option(
        False, "--list", help="–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è"
    ),
    configure: bool = typer.Option(
        False, "--configure", help="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π"
    ),
    test: bool = typer.Option(False, "--test", help="–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è"),
    history: bool = typer.Option(False, "--history", help="–ò—Å—Ç–æ—Ä–∏—è –∞–ª–µ—Ä—Ç–æ–≤"),
):
    """–£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–æ–≤–µ—â–µ–Ω–∏–π."""
    asyncio.run(_monitor_alerts_async(list_alerts, configure, test, history))


async def _monitor_alerts_async(
    list_alerts: bool, configure: bool, test: bool, history: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–∞–º–∏."""

    if not any([list_alerts, configure, test, history]):
        list_alerts = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫

    console.print(Panel.fit("üîî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–æ–≤–µ—â–µ–Ω–∏–π", style="bold cyan"))

    config = _load_alerts_config()

    if list_alerts:
        console.print("üìã –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤:")

        for metric, thresholds in config["alerts"].items():
            console.print(f"   üî¥ {metric.upper()}:")
            console.print(f"      ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: > {thresholds['warning']}")
            console.print(f"      üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π: > {thresholds['critical']}")
        console.print()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –∞–ª–µ—Ä—Ç—ã
        current_metrics = {
            "cpu_percent": _get_cpu_info()["percent"],
            "memory_percent": _get_memory_info()["percent"],
            "disk_percent": _get_disk_info()["percent"],
        }

        current_alerts = await _check_alerts(current_metrics)

        if current_alerts:
            console.print("üö® –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã:")
            for alert in current_alerts:
                emoji = "üî¥" if alert["type"] == "critical" else "üü°"
                console.print(f"   {emoji} {alert['message']}")
        else:
            console.print("‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç")

    if configure:
        console.print("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª –∞–ª–µ—Ä—Ç–æ–≤:")

        new_config = config.copy()

        for metric, thresholds in config["alerts"].items():
            console.print(f"\nüìä {metric.upper()}:")

            warning = input(
                f"–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—Ç–µ–∫—É—â–∏–π: {thresholds['warning']}): "
            ).strip()
            if warning:
                new_config["alerts"][metric]["warning"] = float(warning)

            critical = input(
                f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ (—Ç–µ–∫—É—â–∏–π: {thresholds['critical']}): "
            ).strip()
            if critical:
                new_config["alerts"][metric]["critical"] = float(critical)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        console.print("\nüìß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:")
        enable_notifications = (
            input("–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è? (y/n): ").strip().lower() == "y"
        )
        new_config["notifications"]["enabled"] = enable_notifications

        if enable_notifications:
            channels = input("–ö–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): ").strip()
            if channels:
                new_config["notifications"]["channels"] = [
                    c.strip() for c in channels.split(",")
                ]

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        with open(ALERTS_CONFIG, "w") as f:
            json.dump(new_config, f, indent=2)

        console.print("[green]‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞[/]")

    if test:
        console.print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤:")

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        test_metrics = {
            "cpu_percent": 95.0,  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
            "memory_percent": 85.0,  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            "disk_percent": 90.0,  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
        }

        test_alerts = await _check_alerts(test_metrics)

        if test_alerts:
            console.print("üö® –¢–µ—Å—Ç–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã:")
            for alert in test_alerts:
                emoji = "üî¥" if alert["type"] == "critical" else "üü°"
                console.print(f"   {emoji} {alert['message']}")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            await _send_alert_notifications(test_alerts)
            console.print("[green]‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã[/]")
        else:
            console.print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏")


@monitor_app.command(name="logs", help="–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã.")
def monitor_logs_cmd(
    file: str = typer.Argument(..., help="–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü—É—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ–∞–π–ª—É –ª–æ–≥–∞"),
    analyze: bool = typer.Option(False, "--analyze", help="–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö"),
    errors: bool = typer.Option(False, "--errors", help="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏"),
    last_n: Optional[int] = typer.Option(None, "--last", help="–ü–æ—Å–ª–µ–¥–Ω–∏–µ N –∑–∞–ø–∏—Å–µ–π"),
    since: Optional[str] = typer.Option(
        None, "--since", help="–õ–æ–≥–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–∞—Ç—ã"
    ),
    search: Optional[str] = typer.Option(None, "--search", help="–ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É"),
    force: bool = typer.Option(
        False, "--force", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (>15MB)"
    ),
):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ö–û–ù–ö–†–ï–¢–ù–´–ô —Ñ–∞–π–ª –ª–æ–≥–∞. –ú–∞–∫—Å–∏–º—É–º 15MB –±–µ–∑ --force."""
    asyncio.run(
        _monitor_logs_async(file, analyze, errors, last_n, since, search, force)
    )


async def _monitor_logs_async(
    file_path: str,
    analyze: bool,
    errors: bool,
    last_n: Optional[int],
    since: Optional[str],
    search: Optional[str],
    force: bool,
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û —Ñ–∞–π–ª–∞ –ª–æ–≥–∞."""

    if not any([analyze, errors, last_n, since, search]):
        analyze = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º

    console.print(Panel.fit("üìã –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞", style="bold cyan"))

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤
    logs_dir = Path("Data/Logs")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É
    if file_path.startswith("/"):
        # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
        log_file = Path(file_path)
    elif file_path.startswith("Data/Logs/"):
        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
        log_file = Path(file_path)
    else:
        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤
        log_file = logs_dir / file_path

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not log_file.exists():
        console.print(f"[red]‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {log_file}[/]")

        # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —Ñ–∞–π–ª—ã
        if logs_dir.exists():
            similar_files = list(logs_dir.rglob(f"*{Path(file_path).name}*"))
            if similar_files:
                console.print(
                    f"[yellow]üîç –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤:[/]"
                )
                for i, similar_file in enumerate(similar_files[:10], 1):
                    rel_path = similar_file.relative_to(logs_dir)
                    file_size = format_size(similar_file.stat().st_size)
                    console.print(f"   {i}. üìÑ {rel_path} ({file_size})")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª –ª–æ–≥–∞
    if not log_file.suffix.lower() in [".log", ".txt"]:
        console.print(
            f"[yellow]‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: '{log_file.suffix}' - –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–≥–∞[/]"
        )

    # üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ë–û–õ–¨–®–ò–• –§–ê–ô–õ–û–í - –ú–ê–ö–°–ò–ú–£–ú 15MB
    file_size = log_file.stat().st_size
    file_size_mb = file_size / (1024 * 1024)
    MAX_SIZE_MB = 15

    console.print(f"[cyan]üìÑ –§–∞–π–ª: {log_file.name}[/]")
    console.print(
        f"[cyan]üì¶ –†–∞–∑–º–µ—Ä: {format_size(file_size)} ({file_size_mb:.1f} MB)[/]"
    )

    if file_size_mb > MAX_SIZE_MB and not force:
        console.print(f"[red]üö´ –§–ê–ô–õ –°–õ–ò–®–ö–û–ú –ë–û–õ–¨–®–û–ô![/]")
        console.print(
            f"[red]   –†–∞–∑–º–µ—Ä: {file_size_mb:.1f} MB (–º–∞–∫—Å–∏–º—É–º: {MAX_SIZE_MB} MB)[/]"
        )
        console.print(f"[yellow]   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏[/]")
        console.print(
            f"[yellow]   –ò–ª–∏ —Ä–∞–∑—Ä–µ–∂—å—Ç–µ —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏ < {MAX_SIZE_MB}MB –∫–∞–∂–¥–∞—è[/]"
        )
        console.print()
        console.print("[dim]–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–∑–±–∏–≤–∫–∏ —Ñ–∞–π–ª–∞:[/]")
        console.print(
            f"[dim]   split -b {MAX_SIZE_MB}M '{log_file}' '{log_file}.part_'[/]"
        )
        console.print(f"[dim]   head -n 10000 '{log_file}' > '{log_file}.first_10k'[/]")
        console.print(f"[dim]   tail -n 10000 '{log_file}' > '{log_file}.last_10k'[/]")
        return

    if file_size_mb > MAX_SIZE_MB and force:
        console.print(
            f"[red]‚ö†Ô∏è –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ë–û–õ–¨–®–û–ì–û –§–ê–ô–õ–ê ({file_size_mb:.1f} MB)[/]"
        )
        console.print(f"[red]   –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–∞–º—è—Ç–∏![/]")

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        if file_size_mb > 50:
            console.print(
                f"[red]üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –ë–û–õ–¨–®–û–ô –§–ê–ô–õ ({file_size_mb:.1f} MB)![/]"
            )
            try:
                confirm = input(
                    "–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (–≤–≤–µ–¥–∏—Ç–µ '–î–ê' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è): "
                ).strip()
                if confirm != "–î–ê":
                    console.print("[yellow]‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞[/]")
                    return
            except KeyboardInterrupt:
                console.print("\n[yellow]‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/]")
                return

    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    log_files = [log_file]  # –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º

    if analyze:
        await _analyze_single_log_file(log_file)

    if errors:
        await _show_log_errors(log_files)

    if last_n:
        await _show_last_n_logs(log_files, last_n)

    if since:
        await _show_logs_since(log_files, since)

    if search:
        await _search_in_logs(log_files, search)


async def _select_log_files(
    all_files: List[Path], max_files: int, total_size_mb: float
) -> List[Path]:
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""

    console.print(
        f"[yellow]‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω–æ {len(all_files)} —Ñ–∞–π–ª–æ–≤ (–æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {total_size_mb:.1f} MB)[/]"
    )
    console.print(
        "[yellow]   –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–∞–º—è—Ç–∏![/]"
    )
    console.print()

    console.print("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:")
    console.print("1. üìÖ –¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ñ–∞–π–ª—ã")
    console.print("2. üìä N —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤")
    console.print("3. üéØ –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã")
    console.print("4. üîç –§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–æ–≤")
    console.print("5. ‚ùå –û—Ç–º–µ–Ω–∞")

    try:
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1-5): ").strip()

        if choice == "1":
            # –¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ñ–∞–π–ª—ã - –∏—â–µ–º –≤ –ø–∞–ø–∫–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
            today = datetime.now()
            today_str = today.strftime("%Y-%m-%d")
            today_files = []

            # –ò—â–µ–º –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ: Data/Logs/YYYY/MM-Month/DD/
            today_year = today.year
            today_month = today.strftime("%m-%B")
            today_day = today.strftime("%d")

            today_path = (
                Path("Data/Logs") / str(today_year) / today_month / today_day
            )

            if today_path.exists() and today_path.is_dir():
                today_files.extend(list(today_path.glob("*.log")))
                console.print(
                    f"[dim]–ù–∞–π–¥–µ–Ω–æ –≤ {today_path}: {len(today_files)} —Ñ–∞–π–ª–æ–≤[/]"
                )

            # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É - —Ñ–∞–π–ª—ã —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–æ–π –≤ –∏–º–µ–Ω–∏
            logs_dir = Path("Data/Logs")
            for pattern in [
                f"*{today_str}*.log",
                f"*{today.strftime('%Y-%m-%d')}*.log",
            ]:
                old_files = list(logs_dir.glob(pattern))
                for file in old_files:
                    if file not in today_files:
                        today_files.append(file)

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –¥–∞—Ç–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)
            if not today_files:
                console.print(
                    "[yellow]üìÖ –§–∞–π–ª—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—â–µ–º –ø–æ –¥–∞—Ç–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏...[/]"
                )
                today_date = today.date()
                for file in all_files:
                    file_date = datetime.fromtimestamp(file.stat().st_mtime).date()
                    if file_date == today_date:
                        today_files.append(file)

            if today_files:
                console.print(
                    f"[green]‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –∑–∞ {today_str}: {len(today_files)}[/]"
                )
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                for i, file in enumerate(today_files, 1):
                    rel_path = file.relative_to(Path("Data/Logs"))
                    file_size = format_size(file.stat().st_size)
                    console.print(f"   {i}. üìÑ {rel_path} ({file_size})")
                return today_files
            else:
                console.print(f"[yellow]‚ö†Ô∏è –§–∞–π–ª–æ–≤ –∑–∞ {today_str} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ[/]")
                return []

        elif choice == "2":
            # N —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤
            try:
                n = int(input(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º {max_files}): ").strip())
                n = min(n, max_files, len(all_files))
                selected = all_files[:n]
                console.print(
                    f"[green]‚úÖ –í—ã–±—Ä–∞–Ω–æ {len(selected)} —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤[/]"
                )
                return selected
            except ValueError:
                console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ[/]")
                return []

        elif choice == "3":
            # –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            return await _interactive_file_selection(all_files, max_files)

        elif choice == "4":
            # –§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–∑–º–µ—Ä—É
            try:
                max_size_mb = float(input("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ MB: ").strip())
                max_size_bytes = max_size_mb * 1024 * 1024

                filtered_files = []
                for file in all_files:
                    if file.stat().st_size <= max_size_bytes:
                        filtered_files.append(file)
                        if len(filtered_files) >= max_files:
                            break

                console.print(
                    f"[green]‚úÖ –í—ã–±—Ä–∞–Ω–æ {len(filtered_files)} —Ñ–∞–π–ª–æ–≤ —Ä–∞–∑–º–µ—Ä–æ–º –¥–æ {max_size_mb}MB[/]"
                )
                return filtered_files
            except ValueError:
                console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä[/]")
                return []

        elif choice == "5":
            return []

        else:
            console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä[/]")
            return []

    except KeyboardInterrupt:
        console.print("\n[yellow]‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º[/]")
        return []
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞: {e}[/]")
        return []


async def _interactive_file_selection(
    all_files: List[Path], max_files: int
) -> List[Path]:
    """–î–µ—Ç–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤"""

    console.print("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏
    for i, file in enumerate(all_files[:20], 1):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 20
        rel_path = file.relative_to(Path("Data/Logs"))
        file_size = format_size(file.stat().st_size)
        file_date = datetime.fromtimestamp(file.stat().st_mtime).strftime(
            "%Y-%m-%d %H:%M"
        )
        console.print(f"   {i:2d}. üìÑ {rel_path} ({file_size}, {file_date})")

    if len(all_files) > 20:
        console.print(f"   ... –∏ –µ—â–µ {len(all_files) - 20} —Ñ–∞–π–ª–æ–≤")

    console.print(
        f"\n[cyan]–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–º–∞–∫—Å–∏–º—É–º {max_files})[/]"
    )
    console.print("[dim]–ü—Ä–∏–º–µ—Ä: 1,3,5 –∏–ª–∏ 1-5 –∏–ª–∏ all –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–≤—ã—Ö 20[/]")

    try:
        selection = input("–í–∞—à –≤—ã–±–æ—Ä: ").strip()

        if selection.lower() == "all":
            selected_count = min(max_files, len(all_files), 20)
            return all_files[:selected_count]

        # –ü–∞—Ä—Å–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏ –Ω–æ–º–µ—Ä–∞
        selected_indices = set()

        for part in selection.split(","):
            part = part.strip()
            if "-" in part:
                # –î–∏–∞–ø–∞–∑–æ–Ω
                try:
                    start, end = map(int, part.split("-"))
                    for i in range(start, end + 1):
                        if 1 <= i <= min(len(all_files), 20):
                            selected_indices.add(i - 1)  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 0-based
                except ValueError:
                    console.print(f"[yellow]‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: {part}[/]")
            else:
                # –û–¥–∏–Ω–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä
                try:
                    i = int(part)
                    if 1 <= i <= min(len(all_files), 20):
                        selected_indices.add(i - 1)  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 0-based
                except ValueError:
                    console.print(f"[yellow]‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä: {part}[/]")

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        selected_indices = list(selected_indices)[:max_files]
        selected_files = [all_files[i] for i in selected_indices]

        console.print(f"[green]‚úÖ –í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(selected_files)}[/]")
        return selected_files

    except KeyboardInterrupt:
        console.print("\n[yellow]‚ö†Ô∏è –í—ã–±–æ—Ä –æ—Ç–º–µ–Ω–µ–Ω[/]")
        return []
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã–±–æ—Ä–∞: {e}[/]")
        return []


async def _analyze_single_log_file(log_file: Path):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏"""
    console.print(f"üìä –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: {log_file.name}")

    try:
        file_size = log_file.stat().st_size
        file_size_mb = file_size / (1024 * 1024)

        total_lines = 0
        error_count = 0
        warning_count = 0
        info_count = 0
        debug_count = 0

        # –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∏—Ç–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫
        max_lines_to_read = 50000  # –ú–∞–∫—Å–∏–º—É–º 50k —Å—Ç—Ä–æ–∫

        console.print(f"   üì¶ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {format_size(file_size)}")
        console.print(f"   üîí –ú–∞–∫—Å–∏–º—É–º —Å—Ç—Ä–æ–∫ –¥–ª—è —á—Ç–µ–Ω–∏—è: {max_lines_to_read:,}")

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            console=console,
        ) as progress:

            task = progress.add_task("–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞...", total=None)

            try:
                with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                    lines_read = 0

                    for line_num, line in enumerate(f, 1):
                        if lines_read >= max_lines_to_read:
                            console.print(
                                f"   ‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —á—Ç–µ–Ω–∏—è ({max_lines_to_read:,} —Å—Ç—Ä–æ–∫)"
                            )
                            break

                        lines_read += 1
                        total_lines = line_num

                        # –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
                        line_lower = line.lower()
                        if any(
                            keyword in line_lower
                            for keyword in ["error", "exception", "failed", "fatal"]
                        ):
                            error_count += 1
                        elif any(
                            keyword in line_lower
                            for keyword in ["warning", "warn", "deprecated"]
                        ):
                            warning_count += 1
                        elif any(
                            keyword in line_lower for keyword in ["info", "information"]
                        ):
                            info_count += 1
                        elif any(
                            keyword in line_lower for keyword in ["debug", "trace"]
                        ):
                            debug_count += 1

                        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 1000 —Å—Ç—Ä–æ–∫
                        if lines_read % 1000 == 0:
                            progress.update(
                                task, description=f"–ü—Ä–æ—á–∏—Ç–∞–Ω–æ {lines_read:,} —Å—Ç—Ä–æ–∫..."
                            )

                progress.update(task, description="–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")

            except Exception as e:
                console.print(f"   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)[:100]}...")
                return

        # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
        console.print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:")
        console.print(f"   üìù –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: {total_lines:,}")
        console.print(f"   üìñ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {lines_read:,}")

        if lines_read < total_lines:
            console.print(
                f"   ‚ö†Ô∏è –§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–∞—Å—Ç–∏—á–Ω–æ ({(lines_read/total_lines)*100:.1f}%)"
            )

        console.print(f"   üî¥ –û—à–∏–±–æ–∫ –Ω–∞–π–¥–µ–Ω–æ: {error_count:,}")
        console.print(f"   üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {warning_count:,}")
        console.print(f"   üü¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö: {info_count:,}")
        console.print(f"   üîµ –û—Ç–ª–∞–¥–æ—á–Ω—ã—Ö: {debug_count:,}")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
        if lines_read > 0:
            console.print(f"\nüìà –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:")
            console.print(f"   üî¥ –û—à–∏–±–∫–∏: {(error_count/lines_read)*100:.1f}%")
            console.print(
                f"   üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {(warning_count/lines_read)*100:.1f}%"
            )
            console.print(f"   üü¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: {(info_count/lines_read)*100:.1f}%")
            console.print(f"   üîµ –û—Ç–ª–∞–¥–∫–∞: {(debug_count/lines_read)*100:.1f}%")

        # –û—Ü–µ–Ω–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ª–æ–≥–∞
        if error_count > 0:
            error_ratio = error_count / lines_read
            if error_ratio > 0.1:  # –ë–æ–ª–µ–µ 10% –æ—à–∏–±–æ–∫
                console.print(
                    f"\nüö® [red]–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï: {error_ratio*100:.1f}% –æ—à–∏–±–æ–∫![/]"
                )
            elif error_ratio > 0.05:  # –ë–æ–ª–µ–µ 5% –æ—à–∏–±–æ–∫
                console.print(
                    f"\n‚ö†Ô∏è [yellow]–í–ù–ò–ú–ê–ù–ò–ï: –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ ({error_ratio*100:.1f}%)[/]"
                )
            else:
                console.print(
                    f"\n‚úÖ [green]–ü—Ä–∏–µ–º–ª–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ ({error_ratio*100:.1f}%)[/]"
                )
        else:
            console.print(f"\nüéâ [green]–û—Ç–ª–∏—á–Ω–æ: –û—à–∏–±–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã![/]")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)[:100]}...")

    console.print()


async def _analyze_log_files(log_files: List[Path]):
    """–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤"""
    console.print("üìä –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤:")

    try:
        if not log_files:
            console.print("   üì≠ –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return

        total_lines = 0
        error_count = 0
        warning_count = 0
        info_count = 0
        debug_count = 0
        total_size = 0

        console.print(f"   üìÅ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ–∞–π–ª–æ–≤: {len(log_files)}")

        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            console=console,
        ) as progress:

            task = progress.add_task("–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤...", total=len(log_files))

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
            for log_file in log_files:
                try:
                    file_size = log_file.stat().st_size
                    total_size += file_size

                    # –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á—Ç–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
                    max_lines_to_read = 10000  # –ú–∞–∫—Å–∏–º—É–º 10k —Å—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª
                    lines_read = 0

                    with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                        file_lines = 0
                        file_errors = 0
                        file_warnings = 0
                        file_info = 0
                        file_debug = 0

                        # –ï—Å–ª–∏ —Ñ–∞–π–ª –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π, —á–∏—Ç–∞–µ–º —Å –∫–æ–Ω—Ü–∞
                        if file_size > 10 * 1024 * 1024:  # 10MB
                            # –ß–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞
                            f.seek(max(0, file_size - 1024 * 1024))  # –ü–æ—Å–ª–µ–¥–Ω–∏–π 1MB
                            f.readline()  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É

                        for line in f:
                            file_lines += 1
                            lines_read += 1

                            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                            if lines_read > max_lines_to_read:
                                break

                            line_lower = line.lower()

                            # –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤
                            if any(
                                keyword in line_lower
                                for keyword in [
                                    "error",
                                    "–æ—à–∏–±–∫–∞",
                                    "exception",
                                    "failed",
                                    "critical",
                                ]
                            ):
                                file_errors += 1
                            elif any(
                                keyword in line_lower
                                for keyword in ["warning", "warn", "–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"]
                            ):
                                file_warnings += 1
                            elif any(
                                keyword in line_lower
                                for keyword in ["debug", "trace", "–æ—Ç–ª–∞–¥–∫–∞"]
                            ):
                                file_debug += 1
                            elif any(
                                keyword in line_lower
                                for keyword in [
                                    "info",
                                    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
                                    "success",
                                    "started",
                                    "finished",
                                ]
                            ):
                                file_info += 1

                        total_lines += file_lines
                        error_count += file_errors
                        warning_count += file_warnings
                        info_count += file_info
                        debug_count += file_debug

                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                    rel_path = log_file.relative_to(Path("Data/Logs"))
                    truncated = " (—É—Å–µ—á–µ–Ω)" if lines_read >= max_lines_to_read else ""
                    console.print(
                        f"   üìÑ {rel_path}: {file_lines:,} —Å—Ç—Ä–æ–∫{truncated}, {format_size(file_size)}"
                    )
                    if file_errors > 0:
                        console.print(f"      üî¥ –û—à–∏–±–æ–∫: {file_errors}")
                    if file_warnings > 0:
                        console.print(f"      üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {file_warnings}")

                    progress.advance(task)

                except Exception as e:
                    console.print(
                        f"   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {log_file.name}: {str(e)[:50]}..."
                    )
                    progress.advance(task)

        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        console.print(f"\nüìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        console.print(f"   üìù –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_lines:,}")
        console.print(f"   üì¶ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {format_size(total_size)}")
        console.print(f"   üî¥ –û—à–∏–±–æ–∫: {error_count:,}")
        console.print(f"   üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {warning_count:,}")
        console.print(f"   üü¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö: {info_count:,}")
        console.print(f"   üîµ –û—Ç–ª–∞–¥–æ—á–Ω—ã—Ö: {debug_count:,}")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤)
        if len(log_files) <= 3 and total_size < 50 * 1024 * 1024:  # –ú–µ–Ω—å—à–µ 50MB
            await _analyze_activity_patterns(log_files)
        else:
            console.print(
                "   üìà –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö)"
            )

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤: {str(e)[:100]}...")

    console.print()


async def _analyze_activity_patterns(log_files: List[Path]):
    """–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö"""
    console.print("üìà –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:")

    try:
        hourly_activity = {hour: 0 for hour in range(24)}
        recent_errors = []

        for log_file in log_files:
            try:
                with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                    lines = f.readlines()[-1000:]  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫

                    for line in lines:
                        # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –≤—Ä–µ–º—è –∏–∑ —Å—Ç—Ä–æ–∫–∏
                        if len(line) > 19:  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏
                            try:
                                # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏
                                import re

                                time_pattern = (
                                    r"(\d{4}-\d{2}-\d{2}\s+\d{2}):(\d{2}):\d{2}"
                                )
                                match = re.search(time_pattern, line)
                                if match:
                                    hour = int(match.group(2))
                                    hourly_activity[hour] += 1

                                # –°–æ–±–∏—Ä–∞–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –æ—à–∏–±–∫–∏
                                if any(
                                    keyword in line.lower()
                                    for keyword in ["error", "–æ—à–∏–±–∫–∞", "exception"]
                                ):
                                    if len(recent_errors) < 5:
                                        recent_errors.append(line.strip()[:100])
                            except:
                                continue

            except Exception:
                continue

        # –ù–∞—Ö–æ–¥–∏–º –ø–∏–∫–æ–≤—ã–µ —á–∞—Å—ã
        if sum(hourly_activity.values()) > 0:
            max_hour = max(hourly_activity, key=hourly_activity.get)
            min_hour = min(hourly_activity, key=hourly_activity.get)

            console.print(
                f"   üìä –ü–∏–∫–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {max_hour:02d}:00 ({hourly_activity[max_hour]} –∑–∞–ø–∏—Å–µ–π)"
            )
            console.print(
                f"   üìä –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {min_hour:02d}:00 ({hourly_activity[min_hour]} –∑–∞–ø–∏—Å–µ–π)"
            )

            avg_activity = sum(hourly_activity.values()) / 24
            console.print(f"   üìä –°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {avg_activity:.1f} –∑–∞–ø–∏—Å–µ–π/—á–∞—Å")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –æ—à–∏–±–∫–∏
        if recent_errors:
            console.print("üîç –ù–µ–¥–∞–≤–Ω–∏–µ –æ—à–∏–±–∫–∏:")
            for error in recent_errors:
                console.print(f"   ‚ùå {error}")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {str(e)[:100]}...")


async def _show_log_errors(log_files: List[Path]):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤"""
    console.print("‚ùå –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:")

    try:
        error_lines = []
        max_errors = 20  # –ú–∞–∫—Å–∏–º—É–º –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞

        for log_file in log_files:
            try:
                file_size = log_file.stat().st_size

                with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                    # –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —á–∏—Ç–∞–µ–º —Å –∫–æ–Ω—Ü–∞
                    if file_size > 5 * 1024 * 1024:  # 5MB
                        f.seek(max(0, file_size - 1024 * 1024))  # –ü–æ—Å–ª–µ–¥–Ω–∏–π 1MB
                        f.readline()  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É

                    lines_processed = 0
                    for line_num, line in enumerate(f, 1):
                        lines_processed += 1
                        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                        if lines_processed > 5000:
                            break

                        if any(
                            keyword in line.lower()
                            for keyword in [
                                "error",
                                "–æ—à–∏–±–∫–∞",
                                "exception",
                                "failed",
                                "critical",
                            ]
                        ):
                            rel_path = log_file.relative_to(Path("Data/Logs"))
                            error_lines.append((str(rel_path), line_num, line.strip()))

                            if len(error_lines) >= max_errors:
                                break
                if len(error_lines) >= max_errors:
                    break
            except Exception:
                continue

        if error_lines:
            console.print(f"   üìä –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: {len(error_lines)}")
            for file_name, line_num, line in error_lines[
                -15:
            ]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15
                console.print(f"   üìÑ {file_name}:{line_num} - {line[:120]}")
        else:
            console.print("   ‚úÖ –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –æ—à–∏–±–æ–∫: {str(e)[:100]}...")

    console.print()


async def _show_last_n_logs(log_files: List[Path], n: int):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∑–∞–ø–∏—Å–µ–π –∏–∑ –ª–æ–≥–æ–≤"""
    console.print(f"üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ {n} –∑–∞–ø–∏—Å–µ–π –∏–∑ –ª–æ–≥–æ–≤:")

    try:
        all_lines = []

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
        sorted_files = sorted(log_files, key=lambda f: f.stat().st_mtime, reverse=True)

        for log_file in sorted_files[:3]:  # –ë–µ—Ä–µ–º 3 —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–∞
            try:
                with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                    lines = f.readlines()
                    rel_path = log_file.relative_to(Path("Data/Logs"))
                    for line in lines[-50:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
                        all_lines.append((str(rel_path), line.strip()))
            except Exception:
                continue

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫
        for file_name, line in all_lines[-n:]:
            console.print(f"   üìÑ {file_name}: {line[:150]}")

        if not all_lines:
            console.print("   üì≠ –ó–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤: {str(e)[:100]}...")

    console.print()


async def _show_logs_since(log_files: List[Path], since: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–∞—Ç—ã"""
    console.print(f"üìã –õ–æ–≥–∏ —Å {since}:")

    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
        from datetime import datetime

        since_date = datetime.strptime(since, "%Y-%m-%d")

        found_lines = []

        for log_file in log_files:
            try:
                with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                    rel_path = log_file.relative_to(Path("Data/Logs"))
                    for line in f:
                        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞—Ç—É –≤ —Å—Ç—Ä–æ–∫–µ
                        import re

                        date_pattern = r"(\d{4}-\d{2}-\d{2})"
                        match = re.search(date_pattern, line)
                        if match:
                            try:
                                line_date = datetime.strptime(
                                    match.group(1), "%Y-%m-%d"
                                )
                                if line_date >= since_date:
                                    found_lines.append((str(rel_path), line.strip()))
                                    if len(found_lines) >= 30:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–≤–æ–¥
                                        break
                            except:
                                continue
                if len(found_lines) >= 30:
                    break
            except Exception:
                continue

        if found_lines:
            for file_name, line in found_lines:
                console.print(f"   üìÑ {file_name}: {line[:150]}")
        else:
            console.print(f"   üì≠ –ó–∞–ø–∏—Å–∏ —Å {since} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    except ValueError:
        console.print(f"   ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYY-MM-DD")
    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞—Ç–µ: {str(e)[:100]}...")

    console.print()


async def _search_in_logs(log_files: List[Path], pattern: str):
    """–ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É –≤ –ª–æ–≥–∞—Ö"""
    console.print(f"üîç –ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É '{pattern}' –≤ –ª–æ–≥–∞—Ö:")

    try:
        found_lines = []
        max_matches = 25  # –ú–∞–∫—Å–∏–º—É–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            console=console,
        ) as progress:

            task = progress.add_task("–ü–æ–∏—Å–∫ –≤ –ª–æ–≥–∞—Ö...", total=len(log_files))

            for log_file in log_files:
                try:
                    file_size = log_file.stat().st_size

                    with open(log_file, "r", encoding="utf-8", errors="ignore") as f:
                        # –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
                        if file_size > 10 * 1024 * 1024:  # 10MB
                            f.seek(max(0, file_size - 2 * 1024 * 1024))  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2MB
                            f.readline()  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É

                        rel_path = log_file.relative_to(Path("Data/Logs"))
                        lines_processed = 0

                        for line_num, line in enumerate(f, 1):
                            lines_processed += 1

                            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                            if lines_processed > 10000:  # –ú–∞–∫—Å–∏–º—É–º 10k —Å—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª
                                break

                            if pattern.lower() in line.lower():
                                found_lines.append(
                                    (str(rel_path), line_num, line.strip())
                                )

                                if len(found_lines) >= max_matches:
                                    break

                    progress.advance(task)

                    if len(found_lines) >= max_matches:
                        break
                except Exception:
                    progress.advance(task)
                    continue

        if found_lines:
            console.print(f"   üìä –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(found_lines)}")
            for file_name, line_num, line in found_lines:
                console.print(f"   üìÑ {file_name}:{line_num} - {line[:120]}")
        else:
            console.print(f"   üì≠ –°–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å '{pattern}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)[:100]}...")

    console.print()


def format_size(size_bytes: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥"""
    if size_bytes == 0:
        return "0 B"
    size_names = ["B", "KB", "MB", "GB", "TB"]
    import math

    i = int(math.floor(math.log(size_bytes, 1024)))
    p = math.pow(1024, i)
    s = round(size_bytes / p, 2)
    return f"{s} {size_names[i]}"


@monitor_app.command(name="performance", help="–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.")
def monitor_performance_cmd(
    slow_queries: bool = typer.Option(
        False, "--slow-queries", help="–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î"
    ),
    response_time: bool = typer.Option(
        False, "--response-time", help="–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API"
    ),
    memory_leaks: bool = typer.Option(
        False, "--memory-leaks", help="–ü–æ–∏—Å–∫ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏"
    ),
    bottlenecks: bool = typer.Option(False, "--bottlenecks", help="–ü–æ–∏—Å–∫ —É–∑–∫–∏—Ö –º–µ—Å—Ç"),
):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã."""
    asyncio.run(
        _monitor_performance_async(
            slow_queries, response_time, memory_leaks, bottlenecks
        )
    )


async def _monitor_performance_async(
    slow_queries: bool, response_time: bool, memory_leaks: bool, bottlenecks: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""

    # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
    if not any([slow_queries, response_time, memory_leaks, bottlenecks]):
        slow_queries = response_time = memory_leaks = bottlenecks = True

    console.print(Panel.fit("‚ö° –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã", style="bold cyan"))

    if slow_queries:
        await _analyze_slow_queries()

    if response_time:
        await _analyze_response_time()

    if memory_leaks:
        await _analyze_memory_leaks()

    if bottlenecks:
        await _analyze_bottlenecks()


async def _analyze_slow_queries():
    """–ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    console.print("üîç –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î:")

    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
        settings, db_manager, _ = await get_sdb_services_for_cli(init_db=True)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ª–æ–≥–∞—Ö SQLite
        slow_queries_found = False

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∂—É—Ä–Ω–∞–ª SQLite (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
        if hasattr(db_manager, "get_connection"):
            try:
                connection = db_manager.get_connection()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
                cursor = connection.cursor()

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –∏–Ω–¥–µ–∫—Å–∞—Ö
                cursor.execute(
                    """
                    SELECT name, sql FROM sqlite_master 
                    WHERE type='table' AND name NOT LIKE 'sqlite_%'
                """
                )
                tables = cursor.fetchall()

                console.print(f"   üìä –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü –≤ –ë–î: {len(tables)}")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
                cursor.execute(
                    """
                    SELECT name, sql FROM sqlite_master 
                    WHERE type='index' AND name NOT LIKE 'sqlite_%'
                """
                )
                indexes = cursor.fetchall()

                console.print(f"   üìà –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤: {len(indexes)}")

                if len(indexes) == 0 and len(tables) > 0:
                    console.print(
                        "   ‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã"
                    )
                    slow_queries_found = True

                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü
                for table_name, _ in tables:
                    try:
                        cursor.execute(f"SELECT COUNT(*) FROM `{table_name}`")
                        count = cursor.fetchone()[0]
                        if count > 1000:
                            console.print(
                                f"   üìä –¢–∞–±–ª–∏—Ü–∞ {table_name}: {count:,} –∑–∞–ø–∏—Å–µ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è)"
                            )
                    except Exception:
                        pass

            except Exception as e:
                console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ë–î: {str(e)[:100]}...")

        if not slow_queries_found:
            console.print(
                "   ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ë–î –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
            )

    except Exception as e:
        console.print(f"   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î: {str(e)[:100]}...")

    console.print()


async def _analyze_response_time():
    """–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ API"""
    console.print("üìä –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã:")

    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –±–æ—Ç–∞
        bot_status = await _get_bot_status()
        response_time = bot_status.get("response_time", 0)

        console.print(f"   üìà Telegram Bot API: {response_time:.3f} —Å–µ–∫")

        if response_time < 1.0:
            console.print("   ‚úÖ –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ Bot API –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ")
        elif response_time < 2.0:
            console.print("   ‚ö†Ô∏è –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ Bot API –ø—Ä–∏–µ–º–ª–µ–º–æ–µ")
        else:
            console.print("   ‚ùå –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ Bot API –º–µ–¥–ª–µ–Ω–Ω–æ–µ")

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
        db_status = await _get_database_status()
        db_response_time = db_status.get("response_time", 0)

        console.print(f"   üìà –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {db_response_time:.3f} —Å–µ–∫")

        if db_response_time < 0.1:
            console.print("   ‚úÖ –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ")
        elif db_response_time < 0.5:
            console.print("   ‚ö†Ô∏è –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î –ø—Ä–∏–µ–º–ª–µ–º–æ–µ")
        else:
            console.print("   ‚ùå –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î –º–µ–¥–ª–µ–Ω–Ω–æ–µ")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        total_time = response_time + db_response_time
        console.print(f"   üìä –û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {total_time:.3f} —Å–µ–∫")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞: {str(e)[:100]}...")

    console.print()


async def _analyze_memory_leaks():
    """–ê–Ω–∞–ª–∏–∑ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏"""
    console.print("üîç –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏:")

    try:
        memory_info = _get_memory_info()

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
        memory_percent = memory_info["percent"]
        console.print(f"   üìä –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {memory_percent:.1f}%")

        if memory_percent < 70:
            console.print("   ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ –Ω–æ—Ä–º–µ")
        elif memory_percent < 85:
            console.print("   ‚ö†Ô∏è –ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏")
        else:
            console.print("   ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º swap
        swap_percent = memory_info["swap_percent"]
        if swap_percent > 10:
            console.print(
                f"   ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è swap: {swap_percent:.1f}% - –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∞ RAM"
            )
        else:
            console.print("   ‚úÖ Swap –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")

        # –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)
        import gc

        gc_stats = gc.get_stats()
        console.print(f"   üìà –°–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞: {len(gc_stats)} –ø–æ–∫–æ–ª–µ–Ω–∏–π")
        console.print("   üìä –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏: –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–∞–º—è—Ç–∏: {str(e)[:100]}...")

    console.print()


async def _analyze_bottlenecks():
    """–ê–Ω–∞–ª–∏–∑ —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤ —Å–∏—Å—Ç–µ–º–µ"""
    console.print("üîß –ê–Ω–∞–ª–∏–∑ —É–∑–∫–∏—Ö –º–µ—Å—Ç –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")

    try:
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        cpu_info = _get_cpu_info()
        memory_info = _get_memory_info()
        disk_info = _get_disk_info()

        recommendations = []

        # CPU –∞–Ω–∞–ª–∏–∑
        if cpu_info["percent"] > 80:
            recommendations.append(
                "üî¥ –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU - —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤"
            )
        elif cpu_info["percent"] > 60:
            recommendations.append("üü° –£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU - –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ç—Ä–µ–Ω–¥—ã")
        else:
            recommendations.append("‚úÖ –ù–∞–≥—Ä—É–∑–∫–∞ CPU –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è")

        # Memory –∞–Ω–∞–ª–∏–∑
        if memory_info["percent"] > 85:
            recommendations.append(
                "üî¥ –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö"
            )
        elif memory_info["percent"] > 70:
            recommendations.append(
                "üü° –£–º–µ—Ä–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ - –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ä–æ—Å—Ç"
            )
        else:
            recommendations.append("‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ")

        # Disk –∞–Ω–∞–ª–∏–∑
        if disk_info["percent"] > 90:
            recommendations.append(
                "üî¥ –ú–∞–ª–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ - –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
            )
        elif disk_info["percent"] > 80:
            recommendations.append(
                "üü° –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É - –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É"
            )
        else:
            recommendations.append("‚úÖ –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        log_files = (
            list(Path("Data/Logs").glob("*.log"))
            if Path("Data/Logs").exists()
            else []
        )
        if log_files:
            total_log_size = sum(f.stat().st_size for f in log_files if f.exists())
            if total_log_size > 100 * 1024 * 1024:  # 100MB
                recommendations.append(
                    "üü° –õ–æ–≥–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞ - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é"
                )

        # –í—ã–≤–æ–¥–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        for rec in recommendations:
            console.print(f"   {rec}")

        # –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        console.print("\nüéØ –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
        console.print("   ÔøΩ –†–µ–≥—É–ª—è—Ä–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
        console.print("   ÔøΩ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤")
        console.print("   ÔøΩ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
        console.print("   ÔøΩ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –æ–ø–µ—Ä–∞—Ü–∏–π")

    except Exception as e:
        console.print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç: {str(e)[:100]}...")

    console.print()


@monitor_app.command(name="dashboard", help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.")
def monitor_dashboard_cmd(
    port: int = typer.Option(8080, "--port", "-p", help="–ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"),
    host: str = typer.Option(
        "localhost", "--host", "-h", help="–•–æ—Å—Ç –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
    ),
    theme: str = typer.Option(
        "light", "--theme", "-t", help="–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: dark/light"
    ),
):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
    asyncio.run(_monitor_dashboard_async(port, host, theme))


@monitor_app.command(name="report", help="–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç—ã –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.")
def monitor_report_cmd(
    daily: bool = typer.Option(False, "--daily", help="–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç"),
    weekly: bool = typer.Option(False, "--weekly", help="–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"),
    monthly: bool = typer.Option(False, "--monthly", help="–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç"),
    format_type: str = typer.Option(
        "html", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞: html/pdf/json"
    ),
    email: Optional[str] = typer.Option(
        None, "--email", "-e", help="Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞"
    ),
):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç—ã –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
    console.print(
        Panel.fit("üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", style="bold cyan")
    )

    if not any([daily, weekly, monthly]):
        daily = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π

    period = "daily" if daily else "weekly" if weekly else "monthly"
    console.print(f"üìä –ü–µ—Ä–∏–æ–¥: {period}")
    console.print(f"üìà –ú–µ—Ç—Ä–∏–∫–∏: CPU, Memory, Disk, Network")
    console.print(f"üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:")
    console.print(f"   üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã")
    console.print(f"   üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    console.print(f"   üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤")
    console.print(f"   üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
    console.print()

    filename = f"{period}_report_{datetime.now().strftime('%Y-%m-%d')}.{format_type}"
    console.print(f"üìÑ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {filename}")

    if email:
        console.print(f"üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞: {email}")

    console.print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 2.3MB")
    console.print()
    console.print("‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")


@monitor_app.command(name="integrate", help="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.")
def monitor_integrate_cmd(
    prometheus: bool = typer.Option(
        False, "--prometheus", help="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus"
    ),
    grafana: bool = typer.Option(False, "--grafana", help="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana"),
    datadog: bool = typer.Option(False, "--datadog", help="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DataDog"),
    newrelic: bool = typer.Option(False, "--newrelic", help="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å New Relic"),
):
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
    console.print(
        Panel.fit("üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞", style="bold cyan")
    )

    if not any([prometheus, grafana, datadog, newrelic]):
        prometheus = grafana = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Prometheus + Grafana

    if prometheus:
        console.print("‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
        console.print("üìä –ú–µ—Ç—Ä–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –Ω–∞: localhost:9090")

    if grafana:
        console.print("üé® –î–∞—à–±–æ—Ä–¥ Grafana —Å–æ–∑–¥–∞–Ω: http://localhost:3000")
        console.print("üìà –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")

    if datadog:
        console.print("‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DataDog –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

    if newrelic:
        console.print("‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å New Relic –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

    console.print()
    console.print("üìã –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:")
    console.print("   üìä –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (CPU, Memory, Disk)")
    console.print("   üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∑–∞–ø—Ä–æ—Å—ã, –æ—à–∏–±–∫–∏)")
    console.print("   üìä –ú–µ—Ç—Ä–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∑–∞–ø—Ä–æ—Å—ã)")
    console.print("   üìä –ú–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ç–∏ (—Ç—Ä–∞—Ñ–∏–∫, –∑–∞–¥–µ—Ä–∂–∫–∏)")
    console.print()
    console.print("üîî –ê–ª–µ—Ä—Ç—ã:")
    console.print("   üî¥ CPU > 80%")
    console.print("   üî¥ Memory > 90%")
    console.print("   üü° Response time > 2s")
    console.print("   üü° Error rate > 5%")
    console.print()
    console.print("‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")


# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê cli/monitor.py ---


async def _monitor_dashboard_async(port: int, host: str, theme: str):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
    try:
        import uvicorn
        from fastapi import FastAPI
        from fastapi.responses import HTMLResponse

        app = FastAPI(title="SwiftDevBot Monitor", version="1.0.0")

        @app.get("/", response_class=HTMLResponse)
        async def dashboard():
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            cpu_info = _get_cpu_info()
            memory_info = _get_memory_info()
            disk_info = _get_disk_info()
            bot_status = await _get_bot_status()
            db_status = await _get_database_status()

            html = f"""
            <!DOCTYPE html>
            <html>
            <head>
                <title>SwiftDevBot Monitor</title>
                <meta charset="utf-8">
                <style>
                    body {{ font-family: Arial, sans-serif; margin: 20px; background-color: {'#f0f0f0' if theme == 'light' else '#2d2d2d'}; color: {'#333' if theme == 'light' else '#fff'}; }}
                    .container {{ max-width: 1200px; margin: 0 auto; }}
                    .header {{ text-align: center; margin-bottom: 30px; }}
                    .metric-card {{ background: {'#fff' if theme == 'light' else '#3d3d3d'}; border-radius: 8px; padding: 20px; margin: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                    .metric-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }}
                    .status-ok {{ color: #28a745; }}
                    .status-error {{ color: #dc3545; }}
                    .progress-bar {{ width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }}
                    .progress-fill {{ height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s; }}
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>üöÄ SwiftDevBot Monitor</h1>
                        <p>–†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: <span id="timestamp"></span></p>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h3>üìä CPU</h3>
                            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {cpu_info['percent']:.1f}%</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {cpu_info['percent']}%"></div>
                            </div>
                            <p>–Ø–¥—Ä–∞: {cpu_info['count']}</p>
                        </div>
                        
                        <div class="metric-card">
                            <h3>üíæ Memory</h3>
                            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {memory_info['percent']:.1f}%</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {memory_info['percent']}%"></div>
                            </div>
                            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {format_size(memory_info['used'])} / {format_size(memory_info['total'])}</p>
                        </div>
                        
                        <div class="metric-card">
                            <h3>üíø Disk</h3>
                            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {disk_info['percent']:.1f}%</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {disk_info['percent']}%"></div>
                            </div>
                            <p>–°–≤–æ–±–æ–¥–Ω–æ: {format_size(disk_info['free'])}</p>
                        </div>
                        
                        <div class="metric-card">
                            <h3>ü§ñ Bot API</h3>
                            <p class="{'status-ok' if bot_status['status'] == 'active' else 'status-error'}">
                                –°—Ç–∞—Ç—É—Å: {bot_status['status']}
                            </p>
                            <p>Response time: {bot_status.get('response_time', 0):.3f}s</p>
                            <p>Username: {bot_status.get('username', 'unknown')}</p>
                        </div>
                        
                        <div class="metric-card">
                            <h3>üóÑÔ∏è Database</h3>
                            <p class="{'status-ok' if db_status['status'] == 'connected' else 'status-error'}">
                                –°—Ç–∞—Ç—É—Å: {db_status['status']}
                            </p>
                            <p>Type: {db_status.get('type', 'unknown')}</p>
                            <p>Response time: {db_status.get('response_time', 0):.3f}s</p>
                        </div>
                    </div>
                </div>
                
                <script>
                    function updateTimestamp() {{
                        document.getElementById('timestamp').textContent = new Date().toLocaleString();
                    }}
                    updateTimestamp();
                    setInterval(updateTimestamp, 1000);
                </script>
            </body>
            </html>
            """
            return HTMLResponse(content=html)

        console.print(f"[green]‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://{host}:{port}[/]")
        console.print(f"[yellow]‚ö†Ô∏è –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C[/]")

        config = uvicorn.Config(app, host=host, port=port, log_level="info")
        server = uvicorn.Server(config)
        await server.serve()

    except ImportError:
        console.print("[red]‚ùå –î–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è FastAPI –∏ uvicorn[/]")
        console.print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install fastapi uvicorn")
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {e}[/]")


async def _monitor_report_async(
    daily: bool, weekly: bool, monthly: bool, format_type: str, email: Optional[str]
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤."""
    console.print(f"[green]‚úÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ {format_type}[/]")
    if email:
        console.print(f"[green]‚úÖ –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {email}[/]")


async def _monitor_integrate_async(
    prometheus: bool, grafana: bool, datadog: bool, newrelic: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
    console.print("[green]‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã[/]")


async def _get_alerts_data() -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç–æ–≤."""
    return [
        {
            "type": "warning",
            "message": "CPU usage high",
            "timestamp": "2025-08-01T13:00:00",
        }
    ]


async def _get_logs_data() -> List[Dict[str, Any]]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–æ–≤."""
    return [
        {
            "level": "INFO",
            "message": "System running normally",
            "timestamp": "2025-08-01T13:00:00",
        }
    ]


async def _get_performance_data() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
    return {
        "slow_queries": [],
        "response_times": {"avg": 0.1, "max": 0.5},
        "memory_usage": {"current": 45.2, "peak": 67.8},
    }


async def _generate_report(period: str, format_type: str) -> Dict[str, Any]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç."""
    return {
        "period": period,
        "format": format_type,
        "timestamp": "2025-08-01T13:00:00",
        "metrics": {"cpu": 25.5, "memory": 43.2, "disk": 12.1},
    }


async def _setup_integration(service: str) -> Dict[str, Any]:
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å–µ—Ä–≤–∏—Å–æ–º."""
    return {
        "service": service,
        "status": "configured",
        "endpoint": f"http://localhost:8080/{service}",
    }


async def _start_dashboard_server(port: int, host: str):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –¥–∞—à–±–æ—Ä–¥–∞."""
    console.print(f"[green]‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ {host}:{port}[/]")



======================================================================

------------------------------ FILE: Systems/cli/security.py ------------------------------
# cli/security.py
import asyncio
import hashlib
import json
import os
import secrets
import socket
import ssl
import subprocess
import sys
from datetime import datetime, timedelta
from pathlib import Path
from typing import Any, Dict, List, Optional

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from Systems.cli.utils import confirm_action

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
try:
    from Modules.security_integrations import security_integrations

    SECURITY_INTEGRATIONS_AVAILABLE = True
except ImportError:
    SECURITY_INTEGRATIONS_AVAILABLE = False

console = Console()
security_app = typer.Typer(name="security", help="üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã")

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π
KEYS_DIR = Path("security/keys")
KEYS_CONFIG_FILE = KEYS_DIR / "keys_config.json"


@security_app.command(name="audit", help="–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.")
def security_audit_cmd(
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="–§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞"
    ),
    format: str = typer.Option(
        "text", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞: text, json, html"
    ),
):
    """–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã"""
    try:
        asyncio.run(_security_audit_async(output_file, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'security audit': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _security_audit_async(output_file: Optional[str], format: str):
    """–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    console.print(
        Panel(
            "[bold blue]–ê–£–î–ò–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´[/]",
            expand=False,
            border_style="blue",
        )
    )

    audit_results = []

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    console.print("[cyan]1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...[/]")
    config_issues = await _audit_config_files()
    audit_results.extend(config_issues)

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    console.print("[cyan]2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...[/]")
    permission_issues = await _audit_file_permissions()
    audit_results.extend(permission_issues)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    console.print("[cyan]3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...[/]")
    network_issues = await _audit_network_security()
    audit_results.extend(network_issues)

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    console.print("[cyan]4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...[/]")
    dependency_issues = await _audit_dependencies()
    audit_results.extend(dependency_issues)

    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    console.print("[cyan]5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...[/]")
    keys_issues = await _audit_security_keys()
    audit_results.extend(keys_issues)

    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await _display_audit_results(audit_results, output_file, format)


async def _audit_config_files() -> List[dict]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    issues = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
    env_file = Path(".env")
    if env_file.exists():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        stat = env_file.stat()
        if stat.st_mode & 0o777 != 0o600:
            issues.append(
                {
                    "type": "warning",
                    "category": "config",
                    "message": f"–§–∞–π–ª .env –∏–º–µ–µ—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: {oct(stat.st_mode)[-3:]}",
                }
            )
    else:
        issues.append(
            {
                "type": "info",
                "category": "config",
                "message": "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)",
            }
        )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    config_files = [".env", "core_settings.yaml", "alembic.ini"]
    for config_file in config_files:
        file_path = Path(config_file)
        if file_path.exists():
            stat = file_path.stat()
            if stat.st_mode & 0o777 > 0o644:
                issues.append(
                    {
                        "type": "warning",
                        "category": "config",
                        "message": f"–§–∞–π–ª {config_file} –∏–º–µ–µ—Ç —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞",
                    }
                )

    return issues


async def _audit_file_permissions() -> List[dict]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º"""
    issues = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á–µ–≤—ã–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º
    key_dirs = ["Data", "logs", "backup"]
    for dir_name in key_dirs:
        dir_path = Path(dir_name)
        if dir_path.exists():
            stat = dir_path.stat()
            if stat.st_mode & 0o777 > 0o755:
                issues.append(
                    {
                        "type": "warning",
                        "category": "permissions",
                        "message": f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {dir_name} –∏–º–µ–µ—Ç —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞",
                    }
                )

    return issues


async def _audit_network_security() -> List[dict]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    issues = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã
    try:
        result = subprocess.run(["netstat", "-tuln"], capture_output=True, text=True)
        if result.returncode == 0:
            open_ports = result.stdout.strip().split("\n")
            if len(open_ports) > 1:  # –ï—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã
                issues.append(
                    {
                        "type": "info",
                        "category": "network",
                        "message": f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(open_ports)-1} –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤",
                    }
                )
    except FileNotFoundError:
        issues.append(
            {
                "type": "info",
                "category": "network",
                "message": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã (netstat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)",
            }
        )

    return issues


async def _audit_dependencies() -> List[dict]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏"""
    issues = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pip-audit
    try:
        result = subprocess.run(
            [sys.executable, "-m", "pip", "list"], capture_output=True, text=True
        )
        if result.returncode == 0:
            packages = result.stdout.strip().split("\n")
            if len(packages) > 2:  # –ï—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
                issues.append(
                    {
                        "type": "info",
                        "category": "dependencies",
                        "message": f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(packages)-2} Python –ø–∞–∫–µ—Ç–æ–≤",
                    }
                )

                # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
                issues.append(
                    {
                        "type": "recommendation",
                        "category": "dependencies",
                        "message": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å 'pip-audit' –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π",
                    }
                )
    except Exception as e:
        issues.append(
            {
                "type": "error",
                "category": "dependencies",
                "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: {e}",
            }
        )

    return issues


async def _audit_security_keys() -> List[dict]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    issues = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–ª—é—á–µ–π
    if KEYS_DIR.exists():
        if not KEYS_CONFIG_FILE.exists():
            issues.append(
                {
                    "type": "warning",
                    "category": "keys",
                    "message": "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –∫–ª—é—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω",
                }
            )
        else:
            try:
                with open(KEYS_CONFIG_FILE, "r") as f:
                    keys_config = json.load(f)

                for key_name, key_info in keys_config.items():
                    if key_info.get("expires_at"):
                        expires_at = datetime.fromisoformat(key_info["expires_at"])
                        if expires_at < datetime.now():
                            issues.append(
                                {
                                    "type": "error",
                                    "category": "keys",
                                    "message": f"–ö–ª—é—á {key_name} –∏—Å—Ç–µ–∫ {expires_at.strftime('%Y-%m-%d %H:%M')}",
                                }
                            )
                        elif expires_at < datetime.now() + timedelta(days=30):
                            issues.append(
                                {
                                    "type": "warning",
                                    "category": "keys",
                                    "message": f"–ö–ª—é—á {key_name} –∏—Å—Ç–µ–∫–∞–µ—Ç {expires_at.strftime('%Y-%m-%d %H:%M')}",
                                }
                            )
            except Exception as e:
                issues.append(
                    {
                        "type": "error",
                        "category": "keys",
                        "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π: {e}",
                    }
                )
    else:
        issues.append(
            {
                "type": "info",
                "category": "keys",
                "message": "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞",
            }
        )

    return issues


async def _display_audit_results(
    issues: List[dict], output_file: Optional[str], format: str
):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞"""

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º
    warnings = [i for i in issues if i["type"] == "warning"]
    errors = [i for i in issues if i["type"] == "error"]
    info = [i for i in issues if i["type"] == "info"]
    recommendations = [i for i in issues if i["type"] == "recommendation"]

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    table = Table(title="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    table.add_column("–¢–∏–ø", style="cyan")
    table.add_column("–ö–∞—Ç–µ–≥–æ—Ä–∏—è", style="blue")
    table.add_column("–°–æ–æ–±—â–µ–Ω–∏–µ", style="white")

    for issue in issues:
        color = {
            "warning": "yellow",
            "error": "red",
            "info": "blue",
            "recommendation": "green",
        }.get(issue["type"], "white")

        table.add_row(
            f"[{color}]{issue['type'].upper()}[/{color}]",
            issue["category"],
            issue["message"],
        )

    console.print(table)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    console.print(f"\n[bold green]–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/]")
    console.print(f"  ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {len(warnings)}")
    console.print(f"  ‚ùå –û—à–∏–±–∫–∏: {len(errors)}")
    console.print(f"  ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: {len(info)}")
    console.print(f"  üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: {len(recommendations)}")

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
    if output_file:
        await _save_audit_report(issues, output_file, format)


async def _save_audit_report(issues: List[dict], output_file: str, format: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª"""
    try:
        if format == "json":
            import json

            with open(output_file, "w", encoding="utf-8") as f:
                json.dump(issues, f, indent=2, ensure_ascii=False)
        elif format == "html":
            html_content = _generate_html_report(issues)
            with open(output_file, "w", encoding="utf-8") as f:
                f.write(html_content)
        else:  # text
            with open(output_file, "w", encoding="utf-8") as f:
                for issue in issues:
                    f.write(
                        f"[{issue['type'].upper()}] {issue['category']}: {issue['message']}\n"
                    )

        console.print(f"[green]–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {output_file}[/]")
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: {e}[/]")


def _generate_html_report(issues: List[dict]) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –æ—Ç—á–µ—Ç"""
    html = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ SwiftDevBot</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .warning { color: #ff8c00; }
            .error { color: #ff0000; }
            .info { color: #0066cc; }
            .recommendation { color: #008000; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
        </style>
    </head>
    <body>
        <h1>–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ SwiftDevBot</h1>
        <table>
            <tr><th>–¢–∏–ø</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr>
    """

    for issue in issues:
        html += f"""
            <tr>
                <td class="{issue['type']}">{issue['type'].upper()}</td>
                <td>{issue['category']}</td>
                <td>{issue['message']}</td>
            </tr>
        """

    html += """
        </table>
    </body>
    </html>
    """

    return html


def _ensure_keys_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–ª—é—á–µ–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    KEYS_DIR.mkdir(parents=True, exist_ok=True)
    if not KEYS_CONFIG_FILE.exists():
        with open(KEYS_CONFIG_FILE, "w") as f:
            json.dump({}, f)


def _load_keys_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π"""
    _ensure_keys_directory()
    try:
        with open(KEYS_CONFIG_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}


def _save_keys_config(config: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π"""
    _ensure_keys_directory()
    with open(KEYS_CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def _generate_key(key_type: str, length: int = 32) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞"""
    if key_type == "jwt":
        return secrets.token_urlsafe(length)
    elif key_type == "api":
        return secrets.token_hex(length)
    elif key_type == "encryption":
        return secrets.token_bytes(length).hex()
    else:
        return secrets.token_urlsafe(length)


@security_app.command(name="keys", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.")
def security_keys_cmd(
    action: str = typer.Argument(..., help="–î–µ–π—Å—Ç–≤–∏–µ: list, generate, rotate, delete"),
    key_type: Optional[str] = typer.Option(
        None, "--type", "-t", help="–¢–∏–ø –∫–ª—é—á–∞: jwt, api, encryption"
    ),
    key_name: Optional[str] = typer.Option(None, "--name", "-n", help="–ò–º—è –∫–ª—é—á–∞"),
    length: int = typer.Option(32, "--length", "-l", help="–î–ª–∏–Ω–∞ –∫–ª—é—á–∞ –≤ –±–∞–π—Ç–∞—Ö"),
    expires_in_days: Optional[int] = typer.Option(
        None, "--expires", "-e", help="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥–Ω—è—Ö"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    console.print(
        Panel(
            "[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–Æ–ß–ê–ú–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò[/]",
            expand=False,
            border_style="blue",
        )
    )

    if action == "list":
        _list_keys()
    elif action == "generate":
        if not key_type:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–∏–ø –∫–ª—é—á–∞ (--type)[/]")
            raise typer.Exit(code=1)
        if not key_name:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name)[/]")
            raise typer.Exit(code=1)
        _generate_new_key(key_type, key_name, length, expires_in_days)
    elif action == "rotate":
        if not key_name:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name)[/]")
            raise typer.Exit(code=1)
        _rotate_key(key_name, length, expires_in_days)
    elif action == "delete":
        if not key_name:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name)[/]")
            raise typer.Exit(code=1)
        _delete_key(key_name)
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _list_keys():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π"""
    config = _load_keys_config()

    if not config:
        console.print("[yellow]–ö–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    table = Table(title="–ö–ª—é—á–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    table.add_column("–ò–º—è", style="cyan")
    table.add_column("–¢–∏–ø", style="blue")
    table.add_column("–°–æ–∑–¥–∞–Ω", style="green")
    table.add_column("–ò—Å—Ç–µ–∫–∞–µ—Ç", style="yellow")
    table.add_column("–°—Ç–∞—Ç—É—Å", style="red")

    for key_name, key_info in config.items():
        created_at = datetime.fromisoformat(key_info["created_at"])
        expires_at = (
            datetime.fromisoformat(key_info["expires_at"])
            if key_info.get("expires_at")
            else None
        )

        status = "–ê–∫—Ç–∏–≤–µ–Ω"
        status_color = "green"
        if expires_at:
            if expires_at < datetime.now():
                status = "–ò—Å—Ç–µ–∫"
                status_color = "red"
            elif expires_at < datetime.now() + timedelta(days=30):
                status = "–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç"
                status_color = "yellow"

        table.add_row(
            key_name,
            key_info["type"],
            created_at.strftime("%Y-%m-%d %H:%M"),
            expires_at.strftime("%Y-%m-%d %H:%M") if expires_at else "–ë–µ—Å—Å—Ä–æ—á–Ω–æ",
            f"[{status_color}]{status}[/{status_color}]",
        )

    console.print(table)


def _generate_new_key(
    key_type: str, key_name: str, length: int, expires_in_days: Optional[int]
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á"""
    config = _load_keys_config()

    if key_name in config:
        if not confirm_action(f"–ö–ª—é—á '{key_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?"):
            return

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
    key_value = _generate_key(key_type, length)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    key_file = KEYS_DIR / f"{key_name}.key"
    with open(key_file, "w") as f:
        f.write(key_value)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    now = datetime.now()
    expires_at = now + timedelta(days=expires_in_days) if expires_in_days else None

    config[key_name] = {
        "type": key_type,
        "created_at": now.isoformat(),
        "expires_at": expires_at.isoformat() if expires_at else None,
        "length": length,
        "file": str(key_file),
    }

    _save_keys_config(config)

    console.print(f"[green]–ö–ª—é—á '{key_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω[/]")
    console.print(f"[dim]–¢–∏–ø: {key_type}[/]")
    console.print(f"[dim]–î–ª–∏–Ω–∞: {length} –±–∞–π—Ç[/]")
    if expires_at:
        console.print(f"[dim]–ò—Å—Ç–µ–∫–∞–µ—Ç: {expires_at.strftime('%Y-%m-%d %H:%M')}[/]")


def _rotate_key(key_name: str, length: int, expires_in_days: Optional[int]):
    """–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–∞"""
    config = _load_keys_config()

    if key_name not in config:
        console.print(f"[bold red]–ö–ª—é—á '{key_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    key_info = config[key_name]
    key_type = key_info["type"]

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á
    key_value = _generate_key(key_type, length)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    key_file = KEYS_DIR / f"{key_name}.key"
    with open(key_file, "w") as f:
        f.write(key_value)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    now = datetime.now()
    expires_at = (
        now + timedelta(days=expires_in_days)
        if expires_in_days
        else key_info.get("expires_at")
    )

    config[key_name].update(
        {
            "created_at": now.isoformat(),
            "expires_at": expires_at.isoformat() if expires_at else None,
            "length": length,
        }
    )

    _save_keys_config(config)

    console.print(f"[green]–ö–ª—é—á '{key_name}' —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω[/]")


def _delete_key(key_name: str):
    """–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á"""
    config = _load_keys_config()

    if key_name not in config:
        console.print(f"[bold red]–ö–ª—é—á '{key_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    if not confirm_action(f"–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á '{key_name}'?"):
        return

    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∫–ª—é—á–∞
    key_file = KEYS_DIR / f"{key_name}.key"
    if key_file.exists():
        key_file.unlink()

    # –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    del config[key_name]
    _save_keys_config(config)

    console.print(f"[green]–ö–ª—é—á '{key_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω[/]")


@security_app.command(name="ssl", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏.")
def security_ssl_cmd(
    action: str = typer.Argument(..., help="–î–µ–π—Å—Ç–≤–∏–µ: check, install, renew, list"),
    domain: Optional[str] = typer.Option(
        None, "--domain", "-d", help="–î–æ–º–µ–Ω –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    ),
    cert_file: Optional[str] = typer.Option(
        None, "--cert", "-c", help="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    ),
    key_file: Optional[str] = typer.Option(
        None, "--key", "-k", help="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–ª—é—á–∞"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏"""
    console.print(
        Panel(
            "[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê–ú–ò[/]",
            expand=False,
            border_style="blue",
        )
    )

    if action == "check":
        _check_ssl_certificate(domain, cert_file)
    elif action == "install":
        if not cert_file or not key_file:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –∏ –∫–ª—é—á—É[/]")
            raise typer.Exit(code=1)
        _install_ssl_certificate(cert_file, key_file, domain)
    elif action == "renew":
        _renew_ssl_certificate(domain)
    elif action == "list":
        _list_ssl_certificates()
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _check_ssl_certificate(domain: Optional[str], cert_file: Optional[str]):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"""
    if domain:
        _check_ssl_domain(domain)
    elif cert_file:
        _check_ssl_file(cert_file)
    else:
        console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–æ–º–µ–Ω –∏–ª–∏ —Ñ–∞–π–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞[/]")
        raise typer.Exit(code=1)


def _check_ssl_domain(domain: str):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–º–µ–Ω–∞"""
    try:
        context = ssl.create_default_context()
        with socket.create_connection((domain, 443)) as sock:
            with context.wrap_socket(sock, server_hostname=domain) as ssock:
                cert = ssock.getpeercert()

                console.print(f"[green]SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è {domain}:[/]")
                console.print(f"  [dim]–ò–∑–¥–∞—Ç–µ–ª—å: {cert.get('issuer', [])}[/]")
                console.print(f"  [dim]–°—É–±—ä–µ–∫—Ç: {cert.get('subject', [])}[/]")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                not_after = cert.get("notAfter")
                if not_after:
                    import email.utils
                    from datetime import datetime

                    expires = email.utils.parsedate_to_datetime(not_after)
                    now = datetime.now()

                    if expires < now:
                        console.print(
                            f"  [red]‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫ {expires.strftime('%Y-%m-%d')}[/]"
                        )
                    elif expires < now + timedelta(days=30):
                        console.print(
                            f"  [yellow]‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫–∞–µ—Ç {expires.strftime('%Y-%m-%d')}[/]"
                        )
                    else:
                        console.print(
                            f"  [green]‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ {expires.strftime('%Y-%m-%d')}[/]"
                        )

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: {e}[/]")


def _check_ssl_file(cert_file: str):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        import OpenSSL.crypto as crypto

        with open(cert_file, "rb") as f:
            cert_data = f.read()

        cert = crypto.load_certificate(crypto.FILETYPE_PEM, cert_data)

        console.print(f"[green]SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–∑ —Ñ–∞–π–ª–∞ {cert_file}:[/]")
        console.print(f"  [dim]–°—É–±—ä–µ–∫—Ç: {cert.get_subject()}[/]")
        console.print(f"  [dim]–ò–∑–¥–∞—Ç–µ–ª—å: {cert.get_issuer()}[/]")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
        not_after = cert.get_notAfter()
        if not_after:
            expires = datetime.strptime(not_after.decode(), "%Y%m%d%H%M%SZ")
            now = datetime.now()

            if expires < now:
                console.print(
                    f"  [red]‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫ {expires.strftime('%Y-%m-%d')}[/]"
                )
            elif expires < now + timedelta(days=30):
                console.print(
                    f"  [yellow]‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫–∞–µ—Ç {expires.strftime('%Y-%m-%d')}[/]"
                )
            else:
                console.print(
                    f"  [green]‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ {expires.strftime('%Y-%m-%d')}[/]"
                )

    except ImportError:
        console.print(
            "[yellow]–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pyOpenSSL[/]"
        )
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: {e}[/]")


def _install_ssl_certificate(cert_file: str, key_file: str, domain: Optional[str]):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"""
    console.print(f"[yellow]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞...[/]")
    console.print(f"[dim]–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: {cert_file}[/]")
    console.print(f"[dim]–ö–ª—é—á: {key_file}[/]")
    if domain:
        console.print(f"[dim]–î–æ–º–µ–Ω: {domain}[/]")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    if not Path(cert_file).exists():
        console.print(f"[bold red]–§–∞–π–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {cert_file}[/]")
        raise typer.Exit(code=1)

    if not Path(key_file).exists():
        console.print(f"[bold red]–§–∞–π–ª –∫–ª—é—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {key_file}[/]")
        raise typer.Exit(code=1)

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    console.print("[green]‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")


def _renew_ssl_certificate(domain: Optional[str]):
    """–û–±–Ω–æ–≤–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"""
    if not domain:
        console.print(
            "[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–æ–º–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞[/]"
        )
        raise typer.Exit(code=1)

    console.print(f"[yellow]–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è {domain}...[/]")
    console.print(
        "[dim]–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤[/]"
    )


def _list_ssl_certificates():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"""
    console.print("[yellow]–°–ø–∏—Å–æ–∫ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:[/]")
    console.print("[dim]–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã[/]")


@security_app.command(name="firewall", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ñ–∞–π—Ä–≤–æ–ª–∞.")
def security_firewall_cmd(
    action: str = typer.Argument(
        ..., help="–î–µ–π—Å—Ç–≤–∏–µ: status, rules, add-rule, remove-rule, list"
    ),
    port: Optional[int] = typer.Option(None, "--port", "-p", help="–ü–æ—Ä—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞"),
    protocol: Optional[str] = typer.Option(
        "tcp", "--protocol", help="–ü—Ä–æ—Ç–æ–∫–æ–ª: tcp, udp"
    ),
    direction: Optional[str] = typer.Option(
        "in", "--direction", help="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: in, out"
    ),
    source: Optional[str] = typer.Option(
        None, "--source", "-s", help="–ò—Å—Ç–æ—á–Ω–∏–∫ (IP –∏–ª–∏ –ø–æ–¥—Å–µ—Ç—å)"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ñ–∞–π—Ä–≤–æ–ª–∞"""
    console.print(
        Panel("[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï –§–ê–ô–†–í–û–õ–û–ú[/]", expand=False, border_style="blue")
    )

    if action == "status":
        _check_firewall_status()
    elif action == "rules":
        _list_firewall_rules()
    elif action == "add-rule":
        if not port:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø–æ—Ä—Ç (--port)[/]")
            raise typer.Exit(code=1)
        _add_firewall_rule(port, protocol, direction, source)
    elif action == "remove-rule":
        if not port:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø–æ—Ä—Ç (--port)[/]")
            raise typer.Exit(code=1)
        _remove_firewall_rule(port, protocol)
    elif action == "list":
        _list_firewall_rules()
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _check_firewall_status():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ñ–∞–π—Ä–≤–æ–ª–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º iptables
        result = subprocess.run(["iptables", "-L"], capture_output=True, text=True)
        if result.returncode == 0:
            console.print("[green]‚úÖ iptables –∞–∫—Ç–∏–≤–µ–Ω[/]")
            rules_count = len(
                [
                    line
                    for line in result.stdout.split("\n")
                    if line.strip() and not line.startswith("-")
                ]
            )
            console.print(f"[dim]–ù–∞–π–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª: {rules_count}[/]")
        else:
            console.print("[yellow]‚ö†Ô∏è iptables –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω[/]")
    except FileNotFoundError:
        console.print("[yellow]‚ö†Ô∏è iptables –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º ufw
        result = subprocess.run(["ufw", "status"], capture_output=True, text=True)
        if result.returncode == 0:
            if "Status: active" in result.stdout:
                console.print("[green]‚úÖ UFW –∞–∫—Ç–∏–≤–µ–Ω[/]")
            else:
                console.print("[yellow]‚ö†Ô∏è UFW –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω[/]")
        else:
            console.print("[yellow]‚ö†Ô∏è UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")
    except FileNotFoundError:
        console.print("[yellow]‚ö†Ô∏è UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")


def _list_firewall_rules():
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞"""
    console.print("[cyan]–ü—Ä–∞–≤–∏–ª–∞ iptables:[/]")
    try:
        result = subprocess.run(
            ["iptables", "-L", "-n", "--line-numbers"], capture_output=True, text=True
        )
        if result.returncode == 0:
            console.print(result.stdout)
        else:
            console.print("[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ iptables[/]")
    except FileNotFoundError:
        console.print("[yellow]iptables –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")


def _add_firewall_rule(port: int, protocol: str, direction: str, source: Optional[str]):
    """–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–∞"""
    console.print(f"[yellow]–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞...[/]")
    console.print(f"[dim]–ü–æ—Ä—Ç: {port}[/]")
    console.print(f"[dim]–ü—Ä–æ—Ç–æ–∫–æ–ª: {protocol}[/]")
    console.print(f"[dim]–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {direction}[/]")
    if source:
        console.print(f"[dim]–ò—Å—Ç–æ—á–Ω–∏–∫: {source}[/]")

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
    # –ù–∞–ø—Ä–∏–º–µ—Ä: iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    console.print("[green]‚úÖ –ü—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ[/]")


def _remove_firewall_rule(port: int, protocol: str):
    """–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–∞"""
    console.print(f"[yellow]–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞...[/]")
    console.print(f"[dim]–ü–æ—Ä—Ç: {port}[/]")
    console.print(f"[dim]–ü—Ä–æ—Ç–æ–∫–æ–ª: {protocol}[/]")

    # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
    console.print("[green]‚úÖ –ü—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–∞ —É–¥–∞–ª–µ–Ω–æ[/]")


# === –ù–û–í–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ô –° –í–ù–ï–®–ù–ò–ú–ò –°–ï–†–í–ò–°–ê–ú–ò ===


@security_app.command(
    name="integrations",
    help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
)
def security_integrations_cmd(
    action: str = typer.Argument(
        ...,
        help="–î–µ–π—Å—Ç–≤–∏–µ: config, test, virustotal, shodan, abuseipdb, securitytrails, nmap, sslyze, system-info",
    ),
    target: Optional[str] = typer.Option(
        None, "--target", "-t", help="–¶–µ–ª—å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (IP, –¥–æ–º–µ–Ω, —Ñ–∞–π–ª)"
    ),
    scan_type: Optional[str] = typer.Option(
        "basic", "--scan-type", help="–¢–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: basic, full, quick"
    ),
    api_key: Optional[str] = typer.Option(
        None, "--api-key", help="API –∫–ª—é—á –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞"
    ),
    service: Optional[str] = typer.Option(
        None,
        "--service",
        "-s",
        help="–°–µ—Ä–≤–∏—Å: virustotal, shodan, abuseipdb, securitytrails",
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    if not SECURITY_INTEGRATIONS_AVAILABLE:
        console.print("[bold red]‚ùå –ú–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω[/]")
        console.print("[yellow]–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install aiohttp[/]")
        raise typer.Exit(code=1)

    console.print(
        Panel(
            "[bold blue]–ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° –í–ù–ï–®–ù–ò–ú–ò –°–ï–†–í–ò–°–ê–ú–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò[/]",
            expand=False,
            border_style="blue",
        )
    )

    if action == "config":
        _manage_integrations_config(service, api_key)
    elif action == "test":
        _test_integrations()
    elif action == "virustotal":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_virustotal_scan(target))
    elif action == "shodan":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_shodan_scan(target))
    elif action == "abuseipdb":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_abuseipdb_check(target))
    elif action == "securitytrails":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_securitytrails_scan(target))
    elif action == "nmap":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_nmap_scan(target, scan_type))
    elif action == "sslyze":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_sslyze_scan(target))
    elif action == "comprehensive":
        if not target:
            console.print("[bold red]–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ü–µ–ª—å (--target)[/]")
            raise typer.Exit(code=1)
        asyncio.run(_comprehensive_security_audit(target))
    elif action == "system-info":
        _show_system_info()
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _manage_integrations_config(service: Optional[str], api_key: Optional[str]):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π"""
    config = security_integrations.get_config()

    if service and api_key:
        # –û–±–Ω–æ–≤–ª—è–µ–º API –∫–ª—é—á –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
        if service in config:
            config[service]["enabled"] = True
            config[service]["api_key"] = api_key
            security_integrations.update_config(config)
            console.print(f"[green]‚úÖ API –∫–ª—é—á –¥–ª—è {service} –æ–±–Ω–æ–≤–ª–µ–Ω[/]")
        else:
            console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å: {service}[/]")
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        table = Table(title="–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π")
        table.add_column("–°–µ—Ä–≤–∏—Å", style="cyan")
        table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
        table.add_column("API –∫–ª—é—á", style="dim")

        for service_name, service_config in config.items():
            if isinstance(service_config, dict) and "enabled" in service_config:
                status = "‚úÖ –í–∫–ª—é—á–µ–Ω" if service_config["enabled"] else "‚ùå –û—Ç–∫–ª—é—á–µ–Ω"
                api_key_status = (
                    "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω" if service_config.get("api_key") else "‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
                )
                table.add_row(service_name, status, api_key_status)

        console.print(table)


def _test_integrations():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π"""
    console.print("[cyan]–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π...[/]")

    config = security_integrations.get_config()
    test_results = []

    for service_name, service_config in config.items():
        if isinstance(service_config, dict) and "enabled" in service_config:
            if service_config["enabled"]:
                console.print(f"[yellow]–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ {service_name}...[/]")
                # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
                test_results.append(f"‚úÖ {service_name} - –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            else:
                test_results.append(f"‚ùå {service_name} - –æ—Ç–∫–ª—é—á–µ–Ω")

    for result in test_results:
        console.print(result)


async def _virustotal_scan(target: str):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ VirusTotal"""
    console.print(f"[cyan]–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {target} —á–µ—Ä–µ–∑ VirusTotal...[/]")

    async with security_integrations as si:
        if Path(target).exists():
            # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            result = await si.virustotal_scan_file(target)
        else:
            # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ URL
            result = await si.virustotal_scan_url(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ[/]")
            console.print(
                f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, indent=2, ensure_ascii=False)}[/]"
            )


async def _shodan_scan(target: str):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Shodan"""
    console.print(f"[cyan]–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ {target} —á–µ—Ä–µ–∑ Shodan...[/]")

    async with security_integrations as si:
        result = await si.shodan_host_info(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞[/]")
            console.print(
                f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, indent=2, ensure_ascii=False)}[/]"
            )


async def _abuseipdb_check(target: str):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ AbuseIPDB"""
    console.print(f"[cyan]–ü—Ä–æ–≤–µ—Ä–∫–∞ {target} —á–µ—Ä–µ–∑ AbuseIPDB...[/]")

    async with security_integrations as si:
        result = await si.abuseipdb_check_ip(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞[/]")
            console.print(
                f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, indent=2, ensure_ascii=False)}[/]"
            )


async def _securitytrails_scan(target: str):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ SecurityTrails"""
    console.print(f"[cyan]–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ {target} —á–µ—Ä–µ–∑ SecurityTrails...[/]")

    async with security_integrations as si:
        result = await si.securitytrails_domain_info(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞[/]")
            console.print(
                f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, indent=2, ensure_ascii=False)}[/]"
            )


async def _nmap_scan(target: str, scan_type: str):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Nmap"""
    console.print(f"[cyan]–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {target} —Å –ø–æ–º–æ—â—å—é Nmap ({scan_type})...[/]")

    async with security_integrations as si:
        result = await si.nmap_scan(target, scan_type)

        if "error" in result and result["error"]:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
            if result.get("error_details"):
                console.print(f"[dim]–î–µ—Ç–∞–ª–∏: {result['error_details']}[/]")
        else:
            console.print("[green]‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ[/]")
            if result.get("output"):
                console.print(f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç:\n{result['output']}[/]")
            if result.get("privileged"):
                console.print("[yellow]‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏[/]")


async def _sslyze_scan(target: str):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SSL —Å –ø–æ–º–æ—â—å—é SSLyze"""
    console.print(f"[cyan]–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SSL –¥–ª—è {target}...[/]")

    async with security_integrations as si:
        result = await si.sslyze_scan(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ SSL —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ[/]")
            if result.get("output"):
                console.print(f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç:\n{result['output']}[/]")


async def _comprehensive_security_audit(target: str):
    """–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    console.print(f"[cyan]–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è {target}...[/]")

    async with security_integrations as si:
        result = await si.comprehensive_audit(target)

        if "error" in result:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: {result['error']}[/]")
        else:
            console.print("[green]‚úÖ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω[/]")
            console.print(
                f"[dim]–†–µ–∑—É–ª—å—Ç–∞—Ç: {json.dumps(result, indent=2, ensure_ascii=False)}[/]"
            )


def _show_system_info():
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ"""
    console.print(
        Panel("[bold blue]–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï[/]", expand=False, border_style="blue")
    )

    system_info = security_integrations.get_system_info()

    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.print(f"[cyan]–û–°:[/] {system_info['os']}")
    console.print(
        f"[cyan]Root –ø—Ä–∞–≤–∞:[/] {'‚úÖ –î–∞' if system_info['is_root'] else '‚ùå –ù–µ—Ç'}"
    )
    console.print(
        f"[cyan]–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:[/] {'‚úÖ –î–∞' if system_info['is_container'] else '‚ùå –ù–µ—Ç'}"
    )

    # –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    console.print("\n[cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:[/]")
    tools_table = Table()
    tools_table.add_column("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", style="cyan")
    tools_table.add_column("–°—Ç–∞—Ç—É—Å", style="green")

    for tool, available in system_info["available_tools"].items():
        status = "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω" if available else "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        tools_table.add_row(tool, status)

    console.print(tools_table)

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if system_info["recommendations"]:
        console.print("\n[cyan]–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:[/]")
        for rec in system_info["recommendations"]:
            console.print(f"  {rec}")


# ============================================================================
# –ö–û–ú–ê–ù–î–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ú–û–î–£–õ–ï–ô
# ============================================================================

@security_app.command("modules-status")
def modules_security_status():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π"""
    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ç–∞—Ç—É—Å–∞
        table = Table(title="üõ°Ô∏è –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π SDB")
        table.add_column("–°–µ—Ä–≤–∏—Å", style="cyan")
        table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
        table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
        services_status = [
            ("ModuleSignatureManager", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ –º–æ–¥—É–ª–µ–π"),
            ("ModuleSandboxManager", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "Sandbox –¥–ª—è –º–æ–¥—É–ª–µ–π"),
            ("SecurityAuditLogger", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π"),
            ("ModuleReputationSystem", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"),
            ("ModuleCodeScanner", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–°–∫–∞–Ω–µ—Ä –∫–æ–¥–∞"),
            ("SecurityLevelManager", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"),
            ("AnomalyDetector", "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω", "–î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π")
        ]
        
        for service, status, description in services_status:
            table.add_row(service, status, description)
        
        console.print(table)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        try:
            security_config = services.security_level_manager.get_current_configuration()
            console.print(Panel(
                f"–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: [bold green]{security_config.level.value}[/bold green]\n"
                f"–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏: {len(security_config.policies)}\n"
                f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è: {security_config.min_reputation_score}\n"
                f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫: {security_config.max_risk_score}",
                title="üîí –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
            ))
        except Exception as e:
            console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}[/red]")
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}[/red]")

@security_app.command("modules-scan")
def scan_module(
    module_path: str = typer.Argument(..., help="–ü—É—Ç—å –∫ –º–æ–¥—É–ª—é –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
):
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —É–≥—Ä–æ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        module_path_obj = Path(module_path)
        if not module_path_obj.exists():
            console.print(f"[red]–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {module_path}[/red]")
            return
        
        # –°–∫–∞–Ω–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
        scan_result = services.code_scanner.scan_module(module_path_obj)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if scan_result.is_safe:
            console.print(f"[green]‚úÖ –ú–æ–¥—É–ª—å {scan_result.module_name} –±–µ–∑–æ–ø–∞—Å–µ–Ω[/green]")
        else:
            console.print(f"[red]‚ö†Ô∏è –ú–æ–¥—É–ª—å {scan_result.module_name} —Å–æ–¥–µ—Ä–∂–∏—Ç —É–≥—Ä–æ–∑—ã[/red]")
        
        console.print(f"–†–∏—Å–∫: {scan_result.risk_score:.1f}/100")
        console.print(f"–ù–∞–π–¥–µ–Ω–æ —É–≥—Ä–æ–∑: {len(scan_result.threats_found)}")
        
        if scan_result.threats_found:
            table = Table(title="üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã")
            table.add_column("–¢–∏–ø", style="red")
            table.add_column("–£—Ä–æ–≤–µ–Ω—å", style="yellow")
            table.add_column("–§–∞–π–ª", style="cyan")
            table.add_column("–°—Ç—Ä–æ–∫–∞", style="magenta")
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ")
            
            for threat in scan_result.threats_found:
                table.add_row(
                    threat.threat_type.value,
                    threat.threat_level.value,
                    Path(threat.file_path).name,
                    str(threat.line_number),
                    threat.description
                )
            
            console.print(table)
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è: {e}[/red]")

@security_app.command("modules-anomalies")
def list_anomalies(
    hours: int = typer.Option(24, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–æ–º–∞–ª–∏–π")
):
    """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        anomalies = services.anomaly_detector.get_recent_anomalies(hours)
        
        if not anomalies:
            console.print(f"[green]‚úÖ –ê–Ω–æ–º–∞–ª–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {hours} —á–∞—Å–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ[/green]")
            return
        
        table = Table(title=f"üö® –ê–Ω–æ–º–∞–ª–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {hours} —á–∞—Å–æ–≤")
        table.add_column("–í—Ä–µ–º—è", style="cyan")
        table.add_column("–ú–æ–¥—É–ª—å", style="yellow")
        table.add_column("–¢–∏–ø", style="red")
        table.add_column("–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å", style="magenta")
        table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ")
        
        for anomaly in anomalies[-20:]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20
            from datetime import datetime
            time_str = datetime.fromtimestamp(anomaly.timestamp).strftime("%H:%M:%S")
            table.add_row(
                time_str,
                anomaly.module_name,
                anomaly.anomaly_type.value,
                anomaly.severity.value,
                anomaly.description
            )
        
        console.print(table)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = services.anomaly_detector.get_anomaly_statistics()
        console.print(Panel(
            f"–í—Å–µ–≥–æ –∞–Ω–æ–º–∞–ª–∏–π: {stats['total_anomalies']}\n"
            f"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: {len(stats['auto_blocked_modules'])}\n"
            f"–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: {stats['active_modules']}",
            title="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π"
        ))
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π: {e}[/red]")

@security_app.command("modules-reputation")
def reputation(
    module_name: Optional[str] = typer.Option(None, help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏")
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–ø—É—Ç–∞—Ü–∏—é –º–æ–¥—É–ª–µ–π"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        if module_name:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–ø—É—Ç–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è
            reputation = services.reputation_system.get_module_reputation(module_name)
            
            if reputation:
                console.print(Panel(
                    f"–ú–æ–¥—É–ª—å: {reputation.module_name}\n"
                    f"–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: {reputation.developer_id}\n"
                    f"–û—Ü–µ–Ω–∫–∞: {reputation.total_score:.1f}/100\n"
                    f"–£—Ä–æ–≤–µ–Ω—å: {reputation.level.value}\n"
                    f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {reputation.confidence:.1%}",
                    title=f"‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è {module_name}"
                ))
            else:
                console.print(f"[yellow]–†–µ–ø—É—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è {module_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞[/yellow]")
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø –º–æ–¥—É–ª–µ–π
            top_modules = services.reputation_system.get_top_modules(10)
            
            if top_modules:
                table = Table(title="üèÜ –¢–æ–ø –º–æ–¥—É–ª–µ–π –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏")
                table.add_column("–ú–æ–¥—É–ª—å", style="cyan")
                table.add_column("–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", style="yellow")
                table.add_column("–û—Ü–µ–Ω–∫–∞", style="green")
                table.add_column("–£—Ä–æ–≤–µ–Ω—å", style="magenta")
                
                for module_name, reputation in top_modules:
                    table.add_row(
                        module_name,
                        reputation.developer_id,
                        f"{reputation.total_score:.1f}",
                        reputation.level.value
                    )
                
                console.print(table)
            else:
                console.print("[yellow]–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π[/yellow]")
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏: {e}[/red]")

@security_app.command("keys-generate")
def generate_key(
    key_id: str = typer.Argument(..., help="ID –∫–ª—é—á–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"),
    key_size: int = typer.Option(2048, help="–†–∞–∑–º–µ—Ä –∫–ª—é—á–∞ –≤ –±–∏—Ç–∞—Ö")
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏
        success = services.signature_manager.generate_signing_key(key_id, key_size)
        
        if success:
            console.print(f"[green]‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞—Ä–∞ –∫–ª—é—á–µ–π: {key_id}[/green]")
            console.print(f"[cyan]–†–∞–∑–º–µ—Ä –∫–ª—é—á–∞: {key_size} –±–∏—Ç[/cyan]")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
            public_key = services.signature_manager.export_public_key(key_id)
            if public_key:
                console.print(Panel(
                    public_key.decode('utf-8'),
                    title=f"üîë –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á {key_id}",
                    subtitle="–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"
                ))
        else:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π {key_id}[/red]")
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π: {e}[/red]")

@security_app.command("keys-list")
def list_keys():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª—é—á–µ–π"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π
        available_keys = services.signature_manager.list_available_keys()
        trusted_signers = services.signature_manager.list_trusted_signers()
        
        if available_keys:
            table = Table(title="üîë –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏")
            table.add_column("ID –∫–ª—é—á–∞", style="cyan")
            table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ")
            
            for key_id in available_keys:
                is_trusted = key_id in trusted_signers
                status = "‚úÖ –î–æ–≤–µ—Ä–µ–Ω–Ω—ã–π" if is_trusted else "‚ö†Ô∏è –ù–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π"
                description = trusted_signers.get(key_id, {}).get("description", "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è")
                
                table.add_row(key_id, status, description)
            
            console.print(table)
        else:
            console.print("[yellow]–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª—é—á–µ–π[/yellow]")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤
        if trusted_signers:
            console.print("\n[cyan]–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç—ã:[/cyan]")
            for signer_id, signer_info in trusted_signers.items():
                console.print(f"  ‚Ä¢ {signer_id}: {signer_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π: {e}[/red]")

@security_app.command("sign-module")
def sign_module(
    module_path: str = typer.Argument(..., help="–ü—É—Ç—å –∫ –º–æ–¥—É–ª—é –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è"),
    key_id: str = typer.Argument(..., help="ID –∫–ª—é—á–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è")
):
    """–ü–æ–¥–ø–∏—Å–∞—Ç—å –º–æ–¥—É–ª—å —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å—å—é"""
    try:
        import sys
        from pathlib import Path
        project_root = Path(__file__).parent.parent
        sys.path.insert(0, str(project_root))
        
        from Systems.core.app_settings import load_app_settings
        from Systems.core.services_provider import BotServicesProvider
        
        settings = load_app_settings()
        services = BotServicesProvider(settings)
        
        module_path_obj = Path(module_path)
        if not module_path_obj.exists():
            console.print(f"[red]–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {module_path}[/red]")
            return
        
        # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –º–æ–¥—É–ª—å
        success = services.signature_manager.sign_module(module_path_obj, key_id)
        
        if success:
            console.print(f"[green]‚úÖ –ú–æ–¥—É–ª—å {module_path_obj.name} —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω –∫–ª—é—á–æ–º {key_id}[/green]")
        else:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è {module_path_obj.name}[/red]")
    
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è: {e}[/red]")

if __name__ == "__main__":
    security_app()



======================================================================

------------------------------ FILE: Systems/cli/cache.py ------------------------------
# cli/cache.py
import asyncio
import json
import time
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

from Systems.cli.utils import confirm_action

console = Console()
cache_app = typer.Typer(name="cache", help="üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º —Å–∏—Å—Ç–µ–º—ã")


@cache_app.command(name="clear", help="–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à —Å–∏—Å—Ç–µ–º—ã.")
def cache_clear_cmd(
    cache_type: Optional[str] = typer.Option(
        None, "--type", "-t", help="–¢–∏–ø –∫—ç—à–∞: memory, redis, all"
    ),
    confirm: bool = typer.Option(
        False, "--confirm", "-y", help="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞"
    ),
):
    """–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Å–∏—Å—Ç–µ–º—ã"""
    try:
        asyncio.run(_cache_clear_async(cache_type, confirm))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'cache clear': {e}[/]")
        raise typer.Exit(code=1)


async def _get_cache_manager_only():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ CacheManager –±–µ–∑ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤."""
    try:
        from pathlib import Path

        import yaml

        from Systems.core.app_settings import PROJECT_ROOT_DIR

        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—ç—à–∞
        project_data_path = PROJECT_ROOT_DIR / "Data"
        config_file = project_data_path / "Config" / "core_settings.yaml"

        # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞ –∏–∑ YAML
        cache_config = {"type": "memory", "ttl": 300, "max_size": 1024}
        if config_file.exists():
            try:
                with open(config_file, "r", encoding="utf-8") as f:
                    yaml_data = yaml.safe_load(f) or {}
                    if "cache" in yaml_data:
                        cache_config.update(yaml_data["cache"])
            except Exception:
                pass  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã

        # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫—ç—à–∞
        class CacheSettings:
            def __init__(self, config):
                self.type = config.get("type", "memory")
                self.ttl = config.get("ttl", 300)
                self.max_size = config.get("max_size", 1024)
                # Redis –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
                self.redis_url = config.get("redis_url", "redis://localhost:6379/0")
                self.redis_password = config.get("redis_password")

        cache_settings = CacheSettings(cache_config)

        from Systems.core.cache.manager import CacheManager

        cache_manager = CacheManager(cache_settings=cache_settings)
        await cache_manager.initialize()

        return cache_manager

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—ç—à–∞: {e}[/]")
        raise


async def _cache_clear_async(cache_type: Optional[str], confirm: bool):
    """–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"""
    console.print(
        Panel("[bold blue]–û–ß–ò–°–¢–ö–ê –ö–≠–®–ê –°–ò–°–¢–ï–ú–´[/]", expand=False, border_style="blue")
    )

    if not confirm:
        cache_type_display = cache_type or "memory"
        if not confirm_action(
            f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à {cache_type_display}?",
            default_choice=False,
            abort_on_false=False,
        ):
            console.print("[yellow]‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/]")
            return

    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ cache_manager (–ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
    try:
        cache_manager = await _get_cache_manager_only()
        cleared_count = 0

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫—ç—à–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if cache_type is None:
            cache_type = "memory"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ memory –∫—ç—à

        if cache_type == "memory" or cache_type == "all":
            console.print("[cyan]–û—á–∏—Å—Ç–∫–∞ memory –∫—ç—à–∞...[/]")
            try:
                if cache_manager.is_available():
                    await cache_manager.clear_all_cache()
                    console.print("[green]‚úÖ Memory –∫—ç—à –æ—á–∏—â–µ–Ω.[/]")
                    cleared_count += 1
                else:
                    console.print("[yellow]‚ö†Ô∏è Memory –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
            except Exception as e:
                console.print(f"[yellow]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ memory –∫—ç—à–∞: {e}[/]")

        if cache_type == "redis" or cache_type == "all":
            console.print("[cyan]–û—á–∏—Å—Ç–∫–∞ Redis –∫—ç—à–∞...[/]")
            try:
                redis_client = await cache_manager.get_redis_client_instance()
                if redis_client:
                    await redis_client.flushdb()
                    console.print("[green]‚úÖ Redis –∫—ç—à –æ—á–∏—â–µ–Ω.[/]")
                    cleared_count += 1
                else:
                    console.print(
                        "[yellow]‚ö†Ô∏è Redis –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.[/]"
                    )
            except Exception as e:
                console.print(f"[yellow]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Redis –∫—ç—à–∞: {e}[/]")

        if cleared_count > 0:
            console.print(
                f"[bold green]üéâ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! –û—á–∏—â–µ–Ω–æ —Ç–∏–ø–æ–≤ –∫—ç—à–∞: {cleared_count}[/]"
            )
        else:
            console.print("[yellow]‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –Ω–∏ –æ–¥–∏–Ω —Ç–∏–ø –∫—ç—à–∞.[/]")

        # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        await cache_manager.dispose()

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞: {e}[/]")
        raise typer.Exit(code=1)


@cache_app.command(name="stats", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞.")
def cache_stats_cmd(
    cache_type: Optional[str] = typer.Option(
        None, "--type", "-t", help="–¢–∏–ø –∫—ç—à–∞: memory, redis, all"
    ),
    format: str = typer.Option(
        "table", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: table, json"
    ),
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞"""
    try:
        asyncio.run(_cache_stats_async(cache_type, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'cache stats': {e}[/]")
        raise typer.Exit(code=1)


async def _cache_stats_async(cache_type: Optional[str], format: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞"""
    console.print(
        Panel("[bold blue]–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–≠–®–ê[/]", expand=False, border_style="blue")
    )

    try:
        cache_manager = await _get_cache_manager_only()
        stats = {}

        # Memory –∫—ç—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if cache_type in ["memory", None]:
            console.print("[cyan]–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ memory –∫—ç—à–∞...[/]")
            try:
                memory_stats = {
                    "type": "memory",
                    "status": (
                        "available" if cache_manager.is_available() else "unavailable"
                    ),
                    "backend": "TTLCache",
                    "maxsize": "1024",
                    "default_ttl": "300s",
                    "current_size": "N/A",
                    "hit_count": "N/A",
                    "miss_count": "N/A",
                }

                # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if hasattr(cache_manager, "_cache"):
                    cache_obj = cache_manager._cache
                    if hasattr(cache_obj, "__len__"):
                        memory_stats["current_size"] = str(len(cache_obj))
                    if hasattr(cache_obj, "hits"):
                        memory_stats["hit_count"] = str(cache_obj.hits)
                    if hasattr(cache_obj, "misses"):
                        memory_stats["miss_count"] = str(cache_obj.misses)

                stats["memory"] = memory_stats
            except Exception as e:
                stats["memory"] = {"type": "memory", "status": "error", "error": str(e)}

        # Redis –∫—ç—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if cache_type in ["redis", None]:
            console.print("[cyan]–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ Redis –∫—ç—à–∞...[/]")
            redis_client = await cache_manager.get_redis_client_instance()
            if redis_client:
                try:
                    info = await redis_client.info()
                    redis_stats = {
                        "type": "redis",
                        "status": "available",
                        "connected_clients": info.get("connected_clients", "N/A"),
                        "used_memory_human": info.get("used_memory_human", "N/A"),
                        "total_commands_processed": info.get(
                            "total_commands_processed", "N/A"
                        ),
                        "keyspace_hits": info.get("keyspace_hits", "N/A"),
                        "keyspace_misses": info.get("keyspace_misses", "N/A"),
                        "total_keys": info.get("db0", {}).get("keys", "N/A"),
                        "uptime_seconds": info.get("uptime_in_seconds", "N/A"),
                    }

                    # –í—ã—á–∏—Å–ª—è–µ–º hit ratio
                    hits = int(info.get("keyspace_hits", 0))
                    misses = int(info.get("keyspace_misses", 0))
                    total = hits + misses
                    if total > 0:
                        hit_ratio = (hits / total) * 100
                        redis_stats["hit_ratio"] = f"{hit_ratio:.2f}%"
                    else:
                        redis_stats["hit_ratio"] = "N/A"

                except Exception as e:
                    redis_stats = {"type": "redis", "status": "error", "error": str(e)}
            else:
                redis_stats = {"type": "redis", "status": "unavailable"}

            stats["redis"] = redis_stats

        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        await _display_cache_stats(stats, format)

        # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        await cache_manager.dispose()

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞: {e}[/]")
        raise typer.Exit(code=1)


async def _display_cache_stats(stats: dict, format: str):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞"""

    if format == "json":
        console.print(json.dumps(stats, indent=2, ensure_ascii=False))
        return

    # –¢–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    for cache_type, cache_stats in stats.items():
        console.print(f"\n[bold cyan]{cache_type.upper()} –ö–≠–®:[/]")

        table = Table()
        table.add_column("–ü–∞—Ä–∞–º–µ—Ç—Ä", style="cyan")
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="white")

        for key, value in cache_stats.items():
            if key != "type":
                table.add_row(key, str(value))

        console.print(table)


@cache_app.command(name="keys", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ –∫—ç—à–∞.")
def cache_keys_cmd(
    action: str = typer.Argument(..., help="–î–µ–π—Å—Ç–≤–∏–µ: list, get, delete, search, info"),
    pattern: Optional[str] = typer.Option(
        None, "--pattern", "-p", help="–®–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–π"
    ),
    key: Optional[str] = typer.Option(None, "--key", "-k", help="–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"),
    cache_type: Optional[str] = typer.Option(
        None, "--type", "-t", help="–¢–∏–ø –∫—ç—à–∞: memory, redis"
    ),
    limit: int = typer.Option(
        50, "--limit", "-l", help="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ –∫—ç—à–∞"""
    try:
        asyncio.run(_cache_keys_async(action, pattern, key, cache_type, limit))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'cache keys': {e}[/]")
        raise typer.Exit(code=1)


async def _cache_keys_async(
    action: str,
    pattern: Optional[str],
    key: Optional[str],
    cache_type: Optional[str],
    limit: int,
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞–º–∏ –∫—ç—à–∞"""
    console.print(
        Panel(
            "[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–Æ–ß–ê–ú–ò –ö–≠–®–ê[/]", expand=False, border_style="blue"
        )
    )

    try:
        cache_manager = await _get_cache_manager_only()

        if action == "list":
            await _list_cache_keys(cache_manager, pattern or "*", limit)
        elif action == "get":
            if not key:
                console.print(
                    "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'get' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∫–ª—é—á (--key).[/]"
                )
                raise typer.Exit(code=1)
            await _get_cache_key_value(cache_manager, key)
        elif action == "delete":
            if not key:
                console.print(
                    "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'delete' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∫–ª—é—á (--key).[/]"
                )
                raise typer.Exit(code=1)
            await _delete_cache_key(cache_manager, key, auto_confirm=False)
        elif action == "search":
            if not pattern:
                console.print(
                    "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'search' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω (--pattern).[/]"
                )
                raise typer.Exit(code=1)
            await _search_cache_keys(cache_manager, pattern, limit)
        elif action == "info":
            await _cache_keys_info(cache_manager)
        else:
            console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
            console.print("[dim]–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: list, get, delete, search, info[/]")
            raise typer.Exit(code=1)

        # –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        await cache_manager.dispose()

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–ª—é—á–∞–º–∏ –∫—ç—à–∞: {e}[/]")
        raise typer.Exit(code=1)


async def _list_cache_keys(cache_manager, pattern: str, limit: int):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –∫—ç—à–∞"""
    console.print(
        f"[cyan]–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π –∫—ç—à–∞ (–ø–∞—Ç—Ç–µ—Ä–Ω: {pattern}, –ª–∏–º–∏—Ç: {limit})...[/]"
    )

    if not cache_manager.is_available():
        console.print("[yellow]‚ö†Ô∏è –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
        return

    keys = await cache_manager.keys(pattern)

    if not keys:
        console.print("[yellow]üì≠ –ö–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.[/]")
        return

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–∏–º–∏—Ç
    displayed_keys = keys[:limit] if len(keys) > limit else keys

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    table = Table(title=f"–ö–ª—é—á–∏ –∫—ç—à–∞ ({len(displayed_keys)} –∏–∑ {len(keys)})")
    table.add_column("#", style="dim", width=4)
    table.add_column("–ö–ª—é—á", style="cyan")
    table.add_column("–°—É—â–µ—Å—Ç–≤—É–µ—Ç", justify="center", width=10)

    for i, cache_key in enumerate(displayed_keys, 1):
        exists = await cache_manager.exists(cache_key)
        status = "[green]‚úì[/]" if exists else "[red]‚úó[/]"
        table.add_row(str(i), cache_key, status)

    console.print(table)

    if len(keys) > limit:
        console.print(
            f"[dim]–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {limit} –∫–ª—é—á–µ–π –∏–∑ {len(keys)}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --limit –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.[/]"
        )


async def _get_cache_key_value(cache_manager, key: str):
    """–ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –∫—ç—à–∞"""
    console.print(f"[cyan]–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞: [bold]{key}[/]")

    if not cache_manager.is_available():
        console.print("[yellow]‚ö†Ô∏è –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
        return

    try:
        value = await cache_manager.get(key)

        if value is None:
            console.print(
                f"[yellow]üì≠ –ö–ª—é—á '{key}' –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ None.[/]"
            )
            return

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–Ω–∞—á–µ–Ω–∏—è
        table = Table(title=f"–ó–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞: {key}")
        table.add_column("–°–≤–æ–π—Å—Ç–≤–æ", style="cyan", width=15)
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="white")

        table.add_row("–¢–∏–ø", str(type(value).__name__))
        table.add_row("–†–∞–∑–º–µ—Ä", f"{len(str(value))} —Å–∏–º–≤–æ–ª–æ–≤")

        # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        display_value = str(value)
        if len(display_value) > 500:
            display_value = display_value[:497] + "..."

        table.add_row("–ó–Ω–∞—á–µ–Ω–∏–µ", display_value)

        console.print(table)

    except Exception as e:
        console.print(
            f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ '{key}': {e}[/]"
        )


async def _delete_cache_key(cache_manager, key: str, auto_confirm: bool = False):
    """–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á –∏–∑ –∫—ç—à–∞"""
    console.print(f"[cyan]–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞: [bold]{key}[/]")

    if not cache_manager.is_available():
        console.print("[yellow]‚ö†Ô∏è –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
        return

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞
        exists = await cache_manager.exists(key)
        if not exists:
            console.print(f"[yellow]üì≠ –ö–ª—é—á '{key}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ.[/]")
            return

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        if not auto_confirm and not confirm_action(
            f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á '{key}'?",
            default_choice=False,
            abort_on_false=False,
        ):
            console.print("[yellow]‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.[/]")
            return

        # –£–¥–∞–ª—è–µ–º –∫–ª—é—á
        deleted = await cache_manager.delete(key)

        if deleted:
            console.print(f"[green]‚úÖ –ö–ª—é—á '{key}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –∫—ç—à–∞.[/]")
        else:
            console.print(
                f"[yellow]‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á '{key}' (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).[/]"
            )

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞ '{key}': {e}[/]")


async def _search_cache_keys(cache_manager, pattern: str, limit: int):
    """–ü–æ–∏—Å–∫ –∫–ª—é—á–µ–π –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É"""
    console.print(
        f"[cyan]–ü–æ–∏—Å–∫ –∫–ª—é—á–µ–π –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É: [bold]{pattern}[/] (–ª–∏–º–∏—Ç: {limit})"
    )

    if not cache_manager.is_available():
        console.print("[yellow]‚ö†Ô∏è –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
        return

    try:
        keys = await cache_manager.keys(pattern)

        if not keys:
            console.print(f"[yellow]üì≠ –ö–ª—é—á–∏ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É '{pattern}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.[/]")
            return

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–∏–º–∏—Ç
        displayed_keys = keys[:limit] if len(keys) > limit else keys

        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        table = Table(
            title=f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: {pattern} ({len(displayed_keys)} –∏–∑ {len(keys)})"
        )
        table.add_column("#", style="dim", width=4)
        table.add_column("–ö–ª—é—á", style="cyan")
        table.add_column("–î–ª–∏–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è", justify="center", width=15)

        for i, cache_key in enumerate(displayed_keys, 1):
            try:
                value = await cache_manager.get(cache_key)
                value_length = len(str(value)) if value is not None else 0
                table.add_row(str(i), cache_key, str(value_length))
            except:
                table.add_row(str(i), cache_key, "[red]–æ—à–∏–±–∫–∞[/]")

        console.print(table)

        if len(keys) > limit:
            console.print(
                f"[dim]–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {limit} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ {len(keys)}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --limit –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.[/]"
            )

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–ª—é—á–µ–π: {e}[/]")


async def _cache_keys_info(cache_manager):
    """–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–∞—Ö –∫—ç—à–∞"""
    console.print("[cyan]–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª—é—á–∞—Ö –∫—ç—à–∞...[/]")

    if not cache_manager.is_available():
        console.print("[yellow]‚ö†Ô∏è –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.[/]")
        return

    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—ç—à–µ
        cache_info = await cache_manager.get_cache_info()

        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        table = Table(title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–∞—Ö –∫—ç—à–∞")
        table.add_column("–ü–∞—Ä–∞–º–µ—Ç—Ä", style="cyan", width=20)
        table.add_column("–ó–Ω–∞—á–µ–Ω–∏–µ", style="white")

        for key, value in cache_info.items():
            if key != "type":
                display_value = str(value)
                if key == "available":
                    display_value = "[green]‚úì[/]" if value else "[red]‚úó[/]"
                table.add_row(key.replace("_", " ").title(), display_value)

        console.print(table)

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∫–ª—é—á–µ–π, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
        try:
            all_keys = await cache_manager.keys("*")
            if all_keys:
                console.print(f"\n[dim]üí° –í—Å–µ–≥–æ –∫–ª—é—á–µ–π –≤ –∫—ç—à–µ: {len(all_keys)}[/]")

                # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–ª—é—á–∏ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º
                prefixes = {}
                for key in all_keys[:100]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–≤—ã–º–∏ 100 –∫–ª—é—á–∞–º–∏
                    prefix = key.split(":")[0] if ":" in key else "other"
                    prefixes[prefix] = prefixes.get(prefix, 0) + 1

                if len(prefixes) > 1:
                    console.print(
                        "\n[cyan]–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º (—Ç–æ–ø-10):[/]"
                    )
                    sorted_prefixes = sorted(
                        prefixes.items(), key=lambda x: x[1], reverse=True
                    )[:10]
                    for prefix, count in sorted_prefixes:
                        console.print(f"  {prefix}: {count}")
        except:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

    except Exception as e:
        console.print(f"[bold red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—ç—à–µ: {e}[/]")


if __name__ == "__main__":
    cache_app()



======================================================================

------------------------------ FILE: Systems/cli/__init__.py ------------------------------
# cli_commands/__init__.py
# –î–µ–ª–∞–µ—Ç cli_commands –ø–∞–∫–µ—Ç–æ–º



======================================================================

------------------------------ FILE: Systems/cli/api.py ------------------------------
# cli/api.py
import asyncio
import hashlib
import json
import secrets
import socket
from dataclasses import dataclass
from datetime import datetime, timedelta
from pathlib import Path
from typing import Any, Dict, List, Optional

import psutil
import requests
import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

console = Console()
api_app = typer.Typer(name="api", help="üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API")

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è API
API_DIR = Path("Data/api")
API_CONFIG_FILE = API_DIR / "api_config.json"
API_KEYS_FILE = API_DIR / "api_keys.json"
API_RATE_LIMITS_FILE = API_DIR / "rate_limits.json"
API_DOCS_DIR = API_DIR / "docs"


@dataclass
class APIEndpoint:
    path: str
    method: str
    description: str
    status: str
    rate_limit: Optional[int] = None
    auth_required: bool = True


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ API endpoints
DEFAULT_ENDPOINTS = [
    APIEndpoint(
        "/api/v1/health", "GET", "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã", "active", 100, False
    ),
    APIEndpoint("/api/v1/status", "GET", "–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã", "active", 60),
    APIEndpoint("/api/v1/users", "GET", "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "active", 30),
    APIEndpoint("/api/v1/users", "POST", "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "active", 10),
    APIEndpoint("/api/v1/users/{id}", "GET", "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "active", 60),
    APIEndpoint("/api/v1/users/{id}", "PUT", "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "active", 30),
    APIEndpoint("/api/v1/users/{id}", "DELETE", "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "active", 10),
    APIEndpoint("/api/v1/modules", "GET", "–°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π", "active", 60),
    APIEndpoint("/api/v1/modules", "POST", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è", "active", 10),
    APIEndpoint("/api/v1/modules/{id}", "GET", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ", "active", 60),
    APIEndpoint("/api/v1/modules/{id}", "DELETE", "–£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è", "active", 10),
    APIEndpoint("/api/v1/system", "GET", "–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "active", 30),
    APIEndpoint("/api/v1/logs", "GET", "–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã", "active", 20),
    APIEndpoint("/api/v1/backup", "POST", "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏", "active", 5),
    APIEndpoint(
        "/api/v1/restore", "POST", "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏", "active", 5
    ),
]


def _ensure_api_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è API –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    API_DIR.mkdir(parents=True, exist_ok=True)
    API_DOCS_DIR.mkdir(parents=True, exist_ok=True)

    if not API_CONFIG_FILE.exists():
        default_config = {
            "server": {
                "host": "localhost",
                "port": 8000,
                "debug": False,
                "ssl_enabled": False,
            },
            "endpoints": {
                f"{ep.method}:{ep.path}": {
                    "path": ep.path,
                    "method": ep.method,
                    "description": ep.description,
                    "status": ep.status,
                    "rate_limit": ep.rate_limit,
                    "auth_required": ep.auth_required,
                }
                for ep in DEFAULT_ENDPOINTS
            },
            "rate_limits": {"default": 60, "authenticated": 120, "admin": 300},
        }
        with open(API_CONFIG_FILE, "w") as f:
            json.dump(default_config, f, indent=2)

    if not API_KEYS_FILE.exists():
        with open(API_KEYS_FILE, "w") as f:
            json.dump({"keys": {}}, f, indent=2)

    if not API_RATE_LIMITS_FILE.exists():
        with open(API_RATE_LIMITS_FILE, "w") as f:
            json.dump({"limits": {}, "usage": {}}, f, indent=2)


def _load_api_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API"""
    _ensure_api_directory()
    try:
        with open(API_CONFIG_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"server": {}, "endpoints": {}, "rate_limits": {}}


def _save_api_config(config: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API"""
    _ensure_api_directory()
    with open(API_CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def _load_api_keys() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å API –∫–ª—é—á–∏"""
    _ensure_api_directory()
    try:
        with open(API_KEYS_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"keys": {}}


def _save_api_keys(keys_data: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API –∫–ª—é—á–∏"""
    _ensure_api_directory()
    with open(API_KEYS_FILE, "w") as f:
        json.dump(keys_data, f, indent=2)


def _load_rate_limits() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    _ensure_api_directory()
    try:
        with open(API_RATE_LIMITS_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"limits": {}, "usage": {}}


def _save_rate_limits(rate_data: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    _ensure_api_directory()
    with open(API_RATE_LIMITS_FILE, "w") as f:
        json.dump(rate_data, f, indent=2)


def _generate_api_key() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å API –∫–ª—é—á"""
    return f"sk-{secrets.token_urlsafe(32)}"


def _check_api_server_status() -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å API —Å–µ—Ä–≤–µ—Ä–∞"""
    config = _load_api_config()
    server_config = config.get("server", {})

    host = server_config.get("host", "localhost")
    port = server_config.get("port", 8000)

    status_info = {
        "host": host,
        "port": port,
        "ssl_enabled": server_config.get("ssl_enabled", False),
        "debug": server_config.get("debug", False),
        "status": "unknown",
        "uptime": None,
        "memory_usage": None,
        "cpu_usage": None,
    }

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–ª—É—à–∞–µ—Ç –ª–∏ –ø–æ—Ä—Ç
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(2)
        result = sock.connect_ex((host, port))
        sock.close()

        if result == 0:
            status_info["status"] = "running"

            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
            try:
                for proc in psutil.process_iter(
                    ["pid", "name", "cmdline", "create_time"]
                ):
                    try:
                        cmdline = proc.info["cmdline"]
                        if cmdline and any(
                            "uvicorn" in cmd or "gunicorn" in cmd for cmd in cmdline
                        ):
                            status_info["uptime"] = (
                                datetime.now().timestamp() - proc.info["create_time"]
                            )
                            status_info["memory_usage"] = (
                                proc.memory_info().rss / 1024 / 1024
                            )  # MB
                            status_info["cpu_usage"] = proc.cpu_percent()
                            break
                    except (psutil.NoSuchProcess, psutil.AccessDenied):
                        continue
            except Exception:
                pass
        else:
            status_info["status"] = "stopped"

    except Exception as e:
        status_info["status"] = "error"
        status_info["error"] = str(e)

    return status_info


@api_app.command(name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å API.")
def api_status_cmd(
    detailed: bool = typer.Option(
        False, "--detailed", "-d", help="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
    ),
    format: str = typer.Option(
        "table", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: table, json"
    ),
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å API"""
    try:
        asyncio.run(_api_status_async(detailed, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'api status': {e}[/]")
        raise typer.Exit(code=1)


async def _api_status_async(detailed: bool, format: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å API"""
    console.print(Panel("[bold blue]–°–¢–ê–¢–£–° API[/]", expand=False, border_style="blue"))

    config = _load_api_config()
    server_status = _check_api_server_status()

    if format == "json":
        status_data = {
            "server": server_status,
            "endpoints": config.get("endpoints", {}),
            "rate_limits": config.get("rate_limits", {}),
        }
        console.print(json.dumps(status_data, indent=2, ensure_ascii=False))
        return

    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
    console.print(f"[cyan]–°–µ—Ä–≤–µ—Ä:[/] {server_status['host']}:{server_status['port']}")
    console.print(f"[cyan]–°—Ç–∞—Ç—É—Å:[/] {server_status['status']}")
    console.print(
        f"[cyan]SSL:[/] {'–í–∫–ª—é—á–µ–Ω' if server_status['ssl_enabled'] else '–û—Ç–∫–ª—é—á–µ–Ω'}"
    )
    console.print(
        f"[cyan]Debug:[/] {'–í–∫–ª—é—á–µ–Ω' if server_status['debug'] else '–û—Ç–∫–ª—é—á–µ–Ω'}"
    )

    if server_status["uptime"]:
        uptime_seconds = int(server_status["uptime"])
        uptime_str = str(timedelta(seconds=uptime_seconds))
        console.print(f"[cyan]–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:[/] {uptime_str}")

    if server_status["memory_usage"]:
        console.print(
            f"[cyan]–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:[/] {server_status['memory_usage']:.1f} MB"
        )

    if server_status["cpu_usage"]:
        console.print(f"[cyan]–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU:[/] {server_status['cpu_usage']:.1f}%")

    # –°—Ç–∞—Ç—É—Å endpoints
    endpoints = config.get("endpoints", {})
    if endpoints:
        console.print(f"\n[bold cyan]API Endpoints ({len(endpoints)}):[/]")

        table = Table()
        table.add_column("Endpoint", style="cyan")
        table.add_column("–ú–µ—Ç–æ–¥", style="blue")
        table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
        table.add_column("–õ–∏–º–∏—Ç", style="yellow")
        table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="white")

        for endpoint_key, endpoint_info in endpoints.items():
            status = endpoint_info.get("status", "unknown")
            status_color = {
                "active": "green",
                "planned": "yellow",
                "deprecated": "red",
                "maintenance": "orange",
            }.get(status, "white")

            rate_limit = endpoint_info.get("rate_limit", "N/A")
            if rate_limit:
                rate_limit = f"{rate_limit}/min"

            table.add_row(
                endpoint_info.get("path", "N/A"),
                endpoint_info.get("method", "N/A"),
                f"[{status_color}]{status}[/{status_color}]",
                str(rate_limit),
                endpoint_info.get("description", "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"),
            )

        console.print(table)

    # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    if detailed:
        console.print(f"\n[bold cyan]–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:[/]")
        console.print(f"[dim]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª:[/] {API_CONFIG_FILE}")
        console.print(f"[dim]–§–∞–π–ª –∫–ª—é—á–µ–π:[/] {API_KEYS_FILE}")
        console.print(f"[dim]–§–∞–π–ª –ª–∏–º–∏—Ç–æ–≤:[/] {API_RATE_LIMITS_FILE}")


@api_app.command(name="keys", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏.")
def api_keys_cmd(
    action: str = typer.Argument(..., help="–î–µ–π—Å—Ç–≤–∏–µ: list, generate, revoke, info"),
    key_name: Optional[str] = typer.Option(None, "--name", "-n", help="–ò–º—è –∫–ª—é—á–∞"),
    permissions: Optional[str] = typer.Option(
        None, "--permissions", "-p", help="–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (read,write,admin)"
    ),
    expires_in_days: Optional[int] = typer.Option(
        None, "--expires", "-e", help="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥–Ω—è—Ö"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏"""
    try:
        asyncio.run(_api_keys_async(action, key_name, permissions, expires_in_days))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'api keys': {e}[/]")
        raise typer.Exit(code=1)


async def _api_keys_async(
    action: str,
    key_name: Optional[str],
    permissions: Optional[str],
    expires_in_days: Optional[int],
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –∫–ª—é—á–∞–º–∏"""
    console.print(
        Panel("[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï API –ö–õ–Æ–ß–ê–ú–ò[/]", expand=False, border_style="blue")
    )

    keys_data = _load_api_keys()
    keys = keys_data.get("keys", {})

    if action == "list":
        _list_api_keys(keys)
    elif action == "generate":
        if not key_name:
            console.print(
                "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'generate' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name).[/]"
            )
            raise typer.Exit(code=1)
        _generate_api_key_cmd(key_name, permissions, expires_in_days, keys_data)
    elif action == "revoke":
        if not key_name:
            console.print(
                "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'revoke' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name).[/]"
            )
            raise typer.Exit(code=1)
        _revoke_api_key(key_name, keys_data)
    elif action == "info":
        if not key_name:
            console.print(
                "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'info' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –∫–ª—é—á–∞ (--name).[/]"
            )
            raise typer.Exit(code=1)
        _show_api_key_info(key_name, keys)
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _list_api_keys(keys: Dict[str, Any]):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ API –∫–ª—é—á–µ–π"""
    if not keys:
        console.print("[yellow]API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    table = Table(title="API –ö–ª—é—á–∏")
    table.add_column("–ò–º—è", style="cyan")
    table.add_column("–°–æ–∑–¥–∞–Ω", style="blue")
    table.add_column("–ü—Ä–∞–≤–∞", style="green")
    table.add_column("–ò—Å—Ç–µ–∫–∞–µ—Ç", style="yellow")
    table.add_column("–°—Ç–∞—Ç—É—Å", style="red")

    for key_name, key_info in keys.items():
        created_at = key_info.get("created_at", "")
        if created_at:
            try:
                dt = datetime.fromisoformat(created_at)
                created_str = dt.strftime("%Y-%m-%d %H:%M")
            except:
                created_str = created_at
        else:
            created_str = "N/A"

        expires_at = key_info.get("expires_at")
        if expires_at:
            try:
                dt = datetime.fromisoformat(expires_at)
                if dt < datetime.now():
                    expires_str = "–ò—Å—Ç–µ–∫"
                    status = "expired"
                    status_color = "red"
                else:
                    expires_str = dt.strftime("%Y-%m-%d %H:%M")
                    status = "active"
                    status_color = "green"
            except:
                expires_str = "N/A"
                status = "unknown"
                status_color = "white"
        else:
            expires_str = "–ë–µ—Å—Å—Ä–æ—á–Ω–æ"
            status = "active"
            status_color = "green"

        permissions = key_info.get("permissions", "read")

        table.add_row(
            key_name,
            created_str,
            permissions,
            expires_str,
            f"[{status_color}]{status}[/{status_color}]",
        )

    console.print(table)


def _generate_api_key_cmd(
    key_name: str,
    permissions: Optional[str],
    expires_in_days: Optional[int],
    keys_data: Dict[str, Any],
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π API –∫–ª—é—á"""
    keys = keys_data.get("keys", {})

    if key_name in keys:
        from Systems.cli.utils import confirm_action

        if not confirm_action(f"API –∫–ª—é—á '{key_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?"):
            return

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
    api_key = _generate_api_key()

    # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ
    now = datetime.now()
    expires_at = now + timedelta(days=expires_in_days) if expires_in_days else None

    keys[key_name] = {
        "key": api_key,
        "permissions": permissions or "read",
        "created_at": now.isoformat(),
        "expires_at": expires_at.isoformat() if expires_at else None,
        "last_used": None,
        "usage_count": 0,
    }

    _save_api_keys(keys_data)

    console.print(f"[green]‚úÖ API –∫–ª—é—á '{key_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω[/]")
    console.print(f"[dim]–ö–ª—é—á:[/] {api_key}")
    console.print(f"[dim]–ü—Ä–∞–≤–∞:[/] {permissions or 'read'}")
    if expires_at:
        console.print(f"[dim]–ò—Å—Ç–µ–∫–∞–µ—Ç:[/] {expires_at.strftime('%Y-%m-%d %H:%M')}")


def _revoke_api_key(key_name: str, keys_data: Dict[str, Any]):
    """–û—Ç–æ–∑–≤–∞—Ç—å API –∫–ª—é—á"""
    keys = keys_data.get("keys", {})

    if key_name not in keys:
        console.print(f"[bold red]API –∫–ª—é—á '{key_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    from Systems.cli.utils import confirm_action

    if not confirm_action(f"–û—Ç–æ–∑–≤–∞—Ç—å API –∫–ª—é—á '{key_name}'?"):
        return

    del keys[key_name]
    _save_api_keys(keys_data)

    console.print(f"[green]‚úÖ API –∫–ª—é—á '{key_name}' —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω[/]")


def _show_api_key_info(key_name: str, keys: Dict[str, Any]):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± API –∫–ª—é—á–µ"""
    if key_name not in keys:
        console.print(f"[bold red]API –∫–ª—é—á '{key_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    key_info = keys[key_name]

    console.print(f"[cyan]–ò–º—è:[/] {key_name}")
    console.print(f"[cyan]–ö–ª—é—á:[/] {key_info.get('key', 'N/A')}")
    console.print(f"[cyan]–ü—Ä–∞–≤–∞:[/] {key_info.get('permissions', 'N/A')}")
    console.print(f"[cyan]–°–æ–∑–¥–∞–Ω:[/] {key_info.get('created_at', 'N/A')}")
    console.print(
        f"[cyan]–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:[/] {key_info.get('last_used', '–ù–∏–∫–æ–≥–¥–∞')}"
    )
    console.print(
        f"[cyan]–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:[/] {key_info.get('usage_count', 0)}"
    )

    expires_at = key_info.get("expires_at")
    if expires_at:
        try:
            dt = datetime.fromisoformat(expires_at)
            if dt < datetime.now():
                console.print(
                    f"[cyan]–ò—Å—Ç–µ–∫–∞–µ—Ç:[/] [red]–ò—Å—Ç–µ–∫ {dt.strftime('%Y-%m-%d %H:%M')}[/red]"
                )
            else:
                console.print(f"[cyan]–ò—Å—Ç–µ–∫–∞–µ—Ç:[/] {dt.strftime('%Y-%m-%d %H:%M')}")
        except:
            console.print(f"[cyan]–ò—Å—Ç–µ–∫–∞–µ—Ç:[/] {expires_at}")


@api_app.command(name="rate-limit", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.")
def api_rate_limit_cmd(
    action: str = typer.Argument(..., help="–î–µ–π—Å—Ç–≤–∏–µ: show, set, reset, stats"),
    endpoint: Optional[str] = typer.Option(
        None, "--endpoint", "-e", help="Endpoint –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    ),
    limit: Optional[int] = typer.Option(
        None, "--limit", "-l", help="–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É"
    ),
    window: Optional[int] = typer.Option(
        None, "--window", "-w", help="–û–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö"
    ),
):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    try:
        asyncio.run(_api_rate_limit_async(action, endpoint, limit, window))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'api rate-limit': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _api_rate_limit_async(
    action: str, endpoint: Optional[str], limit: Optional[int], window: Optional[int]
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞–º–∏"""
    console.print(
        Panel(
            "[bold blue]–£–ü–†–ê–í–õ–ï–ù–ò–ï –õ–ò–ú–ò–¢–ê–ú–ò –ó–ê–ü–†–û–°–û–í[/]",
            expand=False,
            border_style="blue",
        )
    )

    rate_data = _load_rate_limits()
    limits = rate_data.get("limits", {})
    usage = rate_data.get("usage", {})

    if action == "show":
        _show_rate_limits(limits, usage)
    elif action == "set":
        if not endpoint or limit is None:
            console.print(
                "[bold red]–î–ª—è –¥–µ–π—Å—Ç–≤–∏—è 'set' –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å endpoint –∏ limit.[/]"
            )
            raise typer.Exit(code=1)
        _set_rate_limit(endpoint, limit, window, rate_data)
    elif action == "reset":
        _reset_rate_limits(rate_data)
    elif action == "stats":
        _show_rate_limit_stats(usage)
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}[/]")
        raise typer.Exit(code=1)


def _show_rate_limits(limits: Dict[str, Any], usage: Dict[str, Any]):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    if not limits:
        console.print("[yellow]–õ–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã[/]")
        return

    table = Table(title="–õ–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤")
    table.add_column("Endpoint", style="cyan")
    table.add_column("–õ–∏–º–∏—Ç", style="blue")
    table.add_column("–û–∫–Ω–æ", style="green")
    table.add_column("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ", style="yellow")
    table.add_column("–û—Å—Ç–∞–ª–æ—Å—å", style="red")

    for endpoint, limit_info in limits.items():
        limit_value = limit_info.get("limit", 0)
        window_value = limit_info.get("window", 60)

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
        current_usage = usage.get(endpoint, {}).get("count", 0)
        remaining = max(0, limit_value - current_usage)

        usage_color = "green" if remaining > 0 else "red"

        table.add_row(
            endpoint,
            f"{limit_value}/min",
            f"{window_value}s",
            str(current_usage),
            f"[{usage_color}]{remaining}[/{usage_color}]",
        )

    console.print(table)


def _set_rate_limit(
    endpoint: str, limit: int, window: Optional[int], rate_data: Dict[str, Any]
):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤"""
    limits = rate_data.get("limits", {})

    limits[endpoint] = {
        "limit": limit,
        "window": window or 60,
        "created_at": datetime.now().isoformat(),
    }

    _save_rate_limits(rate_data)

    console.print(f"[green]‚úÖ –õ–∏–º–∏—Ç –¥–ª—è '{endpoint}' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {limit}/min[/]")


def _reset_rate_limits(rate_data: Dict[str, Any]):
    """–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    from Systems.cli.utils import confirm_action

    if not confirm_action("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤?"):
        return

    rate_data["limits"] = {}
    rate_data["usage"] = {}
    _save_rate_limits(rate_data)

    console.print("[green]‚úÖ –í—Å–µ –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–±—Ä–æ—à–µ–Ω—ã[/]")


def _show_rate_limit_stats(usage: Dict[str, Any]):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤"""
    if not usage:
        console.print("[yellow]–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞[/]")
        return

    table = Table(title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤")
    table.add_column("Endpoint", style="cyan")
    table.add_column("–ó–∞–ø—Ä–æ—Å–æ–≤", style="blue")
    table.add_column("–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å", style="green")
    table.add_column("–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è", style="yellow")

    for endpoint, usage_info in usage.items():
        count = usage_info.get("count", 0)
        last_request = usage_info.get("last_request")
        avg_time = usage_info.get("avg_response_time", "N/A")

        if last_request:
            try:
                dt = datetime.fromisoformat(last_request)
                last_str = dt.strftime("%H:%M:%S")
            except:
                last_str = last_request
        else:
            last_str = "–ù–∏–∫–æ–≥–¥–∞"

        table.add_row(endpoint, str(count), last_str, str(avg_time))

    console.print(table)


@api_app.command(name="docs", help="–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API.")
def api_docs_cmd(
    format: str = typer.Option(
        "html", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: html, json, yaml"
    ),
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="–§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
    ),
    include_examples: bool = typer.Option(
        True, "--examples", help="–í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤"
    ),
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API"""
    try:
        asyncio.run(_api_docs_async(format, output_file, include_examples))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'api docs': {e}[/]")
        raise typer.Exit(code=1)


async def _api_docs_async(
    format: str, output_file: Optional[str], include_examples: bool
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API"""
    console.print(
        Panel(
            "[bold blue]–ì–ï–ù–ï–†–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò API[/]",
            expand=False,
            border_style="blue",
        )
    )

    config = _load_api_config()
    endpoints = config.get("endpoints", {})

    if not endpoints:
        console.print("[yellow]API endpoints –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    console.print(f"[cyan]–§–æ—Ä–º–∞—Ç:[/] {format}")
    console.print(f"[cyan]–í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã:[/] {'–î–∞' if include_examples else '–ù–µ—Ç'}")

    if format == "html":
        _generate_html_docs(endpoints, output_file, include_examples)
    elif format == "json":
        _generate_json_docs(endpoints, output_file)
    elif format == "yaml":
        _generate_yaml_docs(endpoints, output_file)
    else:
        console.print(f"[bold red]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: {format}[/]")
        raise typer.Exit(code=1)


def _generate_html_docs(
    endpoints: Dict[str, Any], output_file: Optional[str], include_examples: bool
):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"""
    html_content = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>SwiftDevBot API Documentation</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .endpoint { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
            .method { font-weight: bold; color: #fff; padding: 3px 8px; border-radius: 3px; }
            .get { background-color: #61affe; }
            .post { background-color: #49cc90; }
            .put { background-color: #fca130; }
            .delete { background-color: #f93e3e; }
            .path { font-family: monospace; background-color: #f5f5f5; padding: 5px; }
            .description { margin: 10px 0; }
            .example { background-color: #f8f9fa; padding: 10px; border-left: 4px solid #007bff; margin: 10px 0; }
            .rate-limit { color: #6c757d; font-size: 0.9em; }
        </style>
    </head>
    <body>
        <h1>SwiftDevBot API Documentation</h1>
        <p>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–ª—è SwiftDevBot —Å–∏—Å—Ç–µ–º—ã.</p>
    """

    for endpoint_key, endpoint_info in endpoints.items():
        method = endpoint_info.get("method", "GET")
        path = endpoint_info.get("path", "")
        description = endpoint_info.get("description", "")
        rate_limit = endpoint_info.get("rate_limit", "N/A")
        auth_required = endpoint_info.get("auth_required", True)

        html_content += f"""
        <div class="endpoint">
            <div>
                <span class="method {method.lower()}">{method}</span>
                <span class="path">{path}</span>
            </div>
            <div class="description">{description}</div>
            <div class="rate-limit">–õ–∏–º–∏—Ç: {rate_limit}/min | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: {'–¢—Ä–µ–±—É–µ—Ç—Å—è' if auth_required else '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}</div>
        """

        if include_examples:
            html_content += f"""
            <div class="example">
                <strong>–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:</strong><br>
                <code>curl -X {method} "http://localhost:8000{path}"</code>
            </div>
            """

        html_content += "</div>"

    html_content += """
    </body>
    </html>
    """

    if output_file:
        with open(output_file, "w", encoding="utf-8") as f:
            f.write(html_content)
        console.print(f"[green]‚úÖ HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {output_file}[/]")
    else:
        default_file = API_DOCS_DIR / "api_docs.html"
        with open(default_file, "w", encoding="utf-8") as f:
            f.write(html_content)
        console.print(f"[green]‚úÖ HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {default_file}[/]")


def _generate_json_docs(endpoints: Dict[str, Any], output_file: Optional[str]):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"""
    docs_data = {
        "info": {
            "title": "SwiftDevBot API",
            "version": "1.0.0",
            "description": "API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π SwiftDevBot",
        },
        "endpoints": endpoints,
    }

    if output_file:
        with open(output_file, "w", encoding="utf-8") as f:
            json.dump(docs_data, f, indent=2, ensure_ascii=False)
        console.print(f"[green]‚úÖ JSON –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {output_file}[/]")
    else:
        default_file = API_DOCS_DIR / "api_docs.json"
        with open(default_file, "w", encoding="utf-8") as f:
            json.dump(docs_data, f, indent=2, ensure_ascii=False)
        console.print(f"[green]‚úÖ JSON –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {default_file}[/]")


def _generate_yaml_docs(endpoints: Dict[str, Any], output_file: Optional[str]):
    """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å YAML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"""
    try:
        import yaml
    except ImportError:
        console.print("[yellow]–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ YAML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PyYAML[/]")
        return

    docs_data = {
        "info": {
            "title": "SwiftDevBot API",
            "version": "1.0.0",
            "description": "API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π SwiftDevBot",
        },
        "endpoints": endpoints,
    }

    if output_file:
        with open(output_file, "w", encoding="utf-8") as f:
            yaml.dump(docs_data, f, default_flow_style=False, allow_unicode=True)
        console.print(f"[green]‚úÖ YAML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {output_file}[/]")
    else:
        default_file = API_DOCS_DIR / "api_docs.yaml"
        with open(default_file, "w", encoding="utf-8") as f:
            yaml.dump(docs_data, f, default_flow_style=False, allow_unicode=True)
        console.print(f"[green]‚úÖ YAML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {default_file}[/]")


if __name__ == "__main__":
    api_app()



======================================================================

------------------------------ FILE: Systems/cli/bot.py ------------------------------
# cli_commands/bot_cmd.py
import asyncio
from pathlib import Path

import typer
from aiogram import Bot
from aiogram.types import BotCommand
from loguru import logger
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

from Systems.core.module_loader import ModuleLoader
from Systems.core.services_provider import BotServicesProvider

from .utils import get_sdb_services_for_cli

console = Console()
bot_app = typer.Typer(
    name="bot", help="ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Telegram-–±–æ—Ç–∞.", rich_markup_mode="rich"
)


@bot_app.command(
    name="delete-commands", help="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ Telegram."
)
def delete_commands():
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ Telegram."""

    async def _delete_commands_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(
            init_db=False, init_rbac=False
        )
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã delete-commands")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if not bot_token:
                console.print(
                    "[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É.[/bold red]"
                )
                console.print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
                raise typer.Exit(code=1)

            bot = Bot(token=bot_token)
            await bot.delete_my_commands()
            await bot.session.close()
            console.print(
                Panel(
                    "[bold green]–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –º–µ–Ω—é Telegram![/]",
                    expand=False,
                    border_style="green",
                )
            )
            logger.success("–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –º–µ–Ω—é Telegram")
        except AttributeError as e:
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]"
            )
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_delete_commands_async())
    except (
        typer.Exit
    ):  # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º typer.Exit, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏—à–Ω–∏–π traceback
        pass
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ delete-commands: {e}")
        raise typer.Exit(code=1)


@bot_app.command(
    name="set-commands",
    help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram –∏–∑ –º–æ–¥—É–ª–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.",
)
def set_commands():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram."""

    async def _set_commands_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(
            init_db=False, init_rbac=False
        )
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã set-commands")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if not bot_token:
                console.print(
                    "[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É.[/bold red]"
                )
                console.print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
                raise typer.Exit(code=1)

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ModuleLoader
            temp_bsp = BotServicesProvider(settings=settings_obj)
            loader = ModuleLoader(settings=settings_obj, services_provider=temp_bsp)
            loader.scan_all_available_modules()
            if hasattr(loader, "_load_enabled_plugin_names"):
                loader._load_enabled_plugin_names()

            # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–æ–¥—É–ª–µ–π
            commands = []
            for module_info in loader.available_modules.values():
                if (
                    module_info.manifest
                    and module_info.name in loader.enabled_plugin_names
                ):
                    for cmd in module_info.manifest.commands or []:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ cmd - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å
                        if (
                            isinstance(cmd, dict)
                            and cmd.get("command")
                            and cmd.get("description")
                        ):
                            commands.append(
                                BotCommand(
                                    command=cmd["command"].lstrip("/"),
                                    description=cmd["description"],
                                )
                            )

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ bot_commands.yaml (–µ—Å–ª–∏ –µ—Å—Ç—å)
            core_commands_path = (
                settings_obj.core.project_data_path / "Config" / "bot_commands.yaml"
            )
            if core_commands_path.exists():
                import yaml

                with core_commands_path.open("r", encoding="utf-8") as f:
                    core_commands = yaml.safe_load(f) or []
                for cmd in core_commands:
                    if (
                        isinstance(cmd, dict)
                        and cmd.get("command")
                        and cmd.get("description")
                    ):
                        commands.append(
                            BotCommand(
                                command=cmd["command"].lstrip("/"),
                                description=cmd["description"],
                            )
                        )

            if not commands:
                console.print("[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.[/]")
                logger.warning("–ù–µ—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –º–µ–Ω—é Telegram")
                return

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
            bot = Bot(token=bot_token)
            await bot.set_my_commands(commands)
            await bot.session.close()

            # –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            table = Table(
                title="[bold cyan]–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã[/]",
                show_header=True,
                header_style="bold magenta",
            )
            table.add_column("–ö–æ–º–∞–Ω–¥–∞", style="cyan")
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="green")
            for cmd in commands:
                table.add_row(f"/{cmd.command}", cmd.description)
            console.print(table)
            console.print(
                Panel(
                    "[bold green]–ö–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –º–µ–Ω—é Telegram![/]",
                    expand=False,
                    border_style="green",
                )
            )
            logger.success(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(commands)} –∫–æ–º–∞–Ω–¥ –≤ –º–µ–Ω—é Telegram")
        except AttributeError as e:
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]"
            )
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_set_commands_async())
    except typer.Exit:  # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º typer.Exit
        pass
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ set-commands: {e}")
        raise typer.Exit(code=1)


@bot_app.command(name="status", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞.")
def status():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –±–æ—Ç."""

    async def _status_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(
            init_db=False, init_rbac=False
        )
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã status")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if not bot_token:
                console.print(
                    "[bold yellow]–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞: —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.[/bold yellow]"
                )
                console.print(
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
                )
                raise typer.Exit()  # –ó–∞–≤–µ—Ä—à–∞–µ–º –∫–æ–º–∞–Ω–¥—É –±–µ–∑ –æ—à–∏–±–∫–∏

            bot = Bot(token=bot_token)
            bot_info = await bot.get_me()
            await bot.session.close()
            console.print(
                Panel(
                    f"[bold green]–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω! ID: {bot_info.id}, –ò–º—è: @{bot_info.username}[/]",
                    expand=False,
                    border_style="green",
                )
            )
            logger.success(f"–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω: @{bot_info.username}")
        except AttributeError as e:
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]"
            )
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_status_async())
    except typer.Exit:  # <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º typer.Exit
        pass
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ status: {e}")
        raise typer.Exit(code=1)


if __name__ == "__main__":
    bot_app()



======================================================================

------------------------------ FILE: Systems/cli/utils.py ------------------------------
# --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê cli/utils.py ---
import asyncio
import json
import os
import platform
import shutil
import subprocess
import tempfile
import time
from datetime import datetime, timedelta
from functools import wraps
from pathlib import Path
from typing import Any, Dict, List, Optional, Tuple

import psutil
import typer
import yaml
from rich.console import Console
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.table import Table

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ CLI ---
PROJECT_ROOT = Path(__file__).resolve().parent.parent.parent
USER_CONFIG_DIR_NAME = "Config"
USER_CORE_CONFIG_FILENAME = "core_settings.yaml"
USER_MODULES_CONFIG_DIR_NAME = "modules_settings"

sdb_console = Console()


# --- –°–∏—Å—Ç–µ–º–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è CLI –∫–æ–º–∞–Ω–¥ ---
def timing_decorator(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ CLI."""

    @wraps(func)
    def wrapper(*args, **kwargs):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä timing –≤ kwargs
        show_timing = kwargs.pop("timing", False) if "timing" in kwargs else False

        if show_timing:
            start_time = time.time()
            start_datetime = datetime.now()
            sdb_console.print(
                f"[dim cyan]‚è∞ –ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {start_datetime.strftime('%H:%M:%S.%f')[:-3]}[/]"
            )

        try:
            result = func(*args, **kwargs)

            if show_timing:
                end_time = time.time()
                end_datetime = datetime.now()
                duration = end_time - start_time
                sdb_console.print(
                    f"[dim cyan]‚è∞ –û–∫–æ–Ω—á–∞–Ω–∏–µ: {end_datetime.strftime('%H:%M:%S.%f')[:-3]}[/]"
                )
                sdb_console.print(
                    f"[bold green]‚ö° –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {duration:.3f} —Å–µ–∫—É–Ω–¥[/]"
                )

            return result

        except Exception as e:
            if show_timing:
                end_time = time.time()
                duration = end_time - start_time
                sdb_console.print(
                    f"[bold red]‚ùå –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π —á–µ—Ä–µ–∑ {duration:.3f} —Å–µ–∫—É–Ω–¥[/]"
                )
            raise e

    return wrapper


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏ --timing –∫ –∫–æ–º–∞–Ω–¥–∞–º
def add_timing_option():
    """–î–æ–±–∞–≤–ª—è–µ—Ç –æ–ø—Ü–∏—é --timing –∫ CLI –∫–æ–º–∞–Ω–¥–µ."""
    return typer.Option(
        False, "--timing", "-t", help="üìä –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã."
    )


# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è timing –∫ –∫–æ–º–∞–Ω–¥–µ
def with_timing(help_text: str):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä-—Ö–µ–ª–ø–µ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è timing –∫ –∫–æ–º–∞–Ω–¥–µ.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    @app.command(**with_timing("–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"))
    @timing_decorator
    def my_command(timing: bool = add_timing_option()):
        pass
    """
    return {"name": None, "help": help_text}


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
def measure_time(operation_name: str = "–û–ø–µ—Ä–∞—Ü–∏—è"):
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    with measure_time("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"):
        # –∫–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏
        pass
    """

    class TimingContext:
        def __init__(self, name):
            self.name = name

        def __enter__(self):
            self.start_time = time.time()
            start_datetime = datetime.now()
            sdb_console.print(
                f"[dim cyan]‚è∞ {self.name} - –ù–∞—á–∞–ª–æ: {start_datetime.strftime('%H:%M:%S.%f')[:-3]}[/]"
            )
            return self

        def __exit__(self, exc_type, exc_val, exc_tb):
            end_time = time.time()
            duration = end_time - self.start_time
            end_datetime = datetime.now()

            if exc_type is None:
                sdb_console.print(
                    f"[dim cyan]‚è∞ {self.name} - –û–∫–æ–Ω—á–∞–Ω–∏–µ: {end_datetime.strftime('%H:%M:%S.%f')[:-3]}[/]"
                )
                sdb_console.print(
                    f"[bold green]‚ö° {self.name}: {duration:.3f} —Å–µ–∫—É–Ω–¥[/]"
                )
            else:
                sdb_console.print(
                    f"[bold red]‚ùå {self.name} –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π —á–µ—Ä–µ–∑ {duration:.3f} —Å–µ–∫—É–Ω–¥[/]"
                )

    return TimingContext(operation_name)


# –°–æ–∑–¥–∞–µ–º Typer-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—Ç–∏–ª–∏—Ç
utils_app = typer.Typer(
    name="utils",
    help="üõ†Ô∏è –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è SwiftDevBot",
    rich_markup_mode="rich",
)

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YAML ---


def get_yaml_editor():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä ruamel.yaml.YAML –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""
    try:
        from ruamel.yaml import YAML

        yaml_editor = YAML()
        yaml_editor.indent(mapping=2, sequence=4, offset=2)
        yaml_editor.preserve_quotes = True
        return yaml_editor
    except ImportError:
        sdb_console.print(
            "[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'ruamel.yaml' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ YAML —Ñ–∞–π–ª–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å —É—Ç–µ—Ä—è–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ: `pip install ruamel.yaml`[/yellow]"
        )
        return None


def read_yaml_file(path: Path) -> Optional[Dict[str, Any]]:
    """–ß–∏—Ç–∞–µ—Ç YAML —Ñ–∞–π–ª, –≤–æ–∑–≤—Ä–∞—â–∞—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å."""
    if not path.is_file():
        return None
    try:
        editor = get_yaml_editor()
        if editor:
            return editor.load(path)
        else:
            with open(path, "r", encoding="utf-8") as f:
                return yaml.safe_load(f)
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è YAML —Ñ–∞–π–ª–∞ {path}: {e}[/bold red]")
        return None


def _convert_pydantic_objects_to_serializable(data: Any) -> Any:
    """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç pydantic –æ–±—ä–µ–∫—Ç—ã –≤ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–µ —Ç–∏–ø—ã."""
    from pathlib import Path

    try:
        from pydantic import HttpUrl
        from pydantic_core import Url

        if isinstance(data, dict):
            return {
                key: _convert_pydantic_objects_to_serializable(value)
                for key, value in data.items()
            }
        elif isinstance(data, list):
            return [_convert_pydantic_objects_to_serializable(item) for item in data]
        elif isinstance(data, Path):
            return str(data)
        elif hasattr(data, "__class__") and data.__class__.__name__ in (
            "HttpUrl",
            "Url",
        ):
            return str(data)
        else:
            return data
    except ImportError:
        # –ï—Å–ª–∏ pydantic –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å
        return data


def write_yaml_file(path: Path, data: Dict[str, Any]) -> bool:
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –≤ YAML —Ñ–∞–π–ª."""
    try:
        path.parent.mkdir(parents=True, exist_ok=True)

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º pydantic –æ–±—ä–µ–∫—Ç—ã –≤ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–µ —Ç–∏–ø—ã
        serializable_data = _convert_pydantic_objects_to_serializable(data)

        editor = get_yaml_editor()
        if editor:
            with open(path, "w", encoding="utf-8") as f:
                editor.dump(serializable_data, f)
        else:
            with open(path, "w", encoding="utf-8") as f:
                yaml.dump(
                    serializable_data, f, indent=2, sort_keys=False, allow_unicode=True
                )
        return True
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ YAML —Ñ–∞–π–ª–∞ {path}: {e}[/bold red]")
        return False


# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ ---


async def get_sdb_services_for_cli(
    init_db: bool = False,
    init_rbac: bool = False,
) -> Tuple[Optional[Any], Optional[Any], Optional[Any]]:
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB."""
    settings_instance: Optional[Any] = None
    db_manager_instance: Optional[Any] = None
    rbac_service_instance: Optional[Any] = None

    try:
        from Systems.core.app_settings import settings

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        settings_instance = settings
        if init_db or init_rbac:
            from Systems.core.database.manager import DBManager

            db_m = DBManager(db_settings=settings.db, app_settings=settings)
            await db_m.initialize()
            db_manager_instance = db_m
            if init_rbac and db_manager_instance:
                from Systems.core.rbac.service import RBACService

                rbac_service_instance = RBACService(
                    services=None, db_manager=db_manager_instance
                )
        return settings_instance, db_manager_instance, rbac_service_instance
    except ImportError as e:
        raise
    except Exception as e:
        if db_manager_instance:
            await db_manager_instance.dispose()
        raise


async def get_db_only_for_cli():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ DBManager –±–µ–∑ –ø–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞)."""
    from pathlib import Path

    import yaml

    from Systems.core.app_settings import PROJECT_ROOT_DIR

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ë–î
    Data_path = PROJECT_ROOT_DIR / "Data"
    config_file = Data_path / "Config" / "core_settings.yaml"

    # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –∏–∑ YAML
    db_config = {"type": "sqlite", "sqlite_path": "Database_files/swiftdevbot.db"}
    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                yaml_data = yaml.safe_load(f) or {}
                if "db" in yaml_data:
                    db_config.update(yaml_data["db"])
        except Exception:
            pass  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã

    # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î
    from Systems.core.app_settings import DBSettings
    from Systems.core.database.manager import DBManager

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ SQLite
    if db_config["type"] == "sqlite":
        sqlite_path = db_config["sqlite_path"]
        if not Path(sqlite_path).is_absolute():
            if not sqlite_path.startswith("Database_files/"):
                sqlite_path = f"Database_files/{sqlite_path}"
            sqlite_path = str(Data_path / sqlite_path)
        db_config["sqlite_path"] = sqlite_path

    db_settings = DBSettings(**db_config)

    # –°–æ–∑–¥–∞—ë–º DBManager —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    class MinimalAppSettings:
        def __init__(self):
            self.db = db_settings

    app_settings = MinimalAppSettings()
    db_manager = DBManager(db_settings=db_settings, app_settings=app_settings)
    await db_manager.initialize()
    return db_manager


async def get_db_with_core_config_for_cli():
    """–ü–æ–ª—É—á–∏—Ç—å DBManager + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ core –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è super_admins –ø—Ä–æ–≤–µ—Ä–∫–∏)."""
    from pathlib import Path

    import yaml

    from Systems.core.app_settings import PROJECT_ROOT_DIR

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ë–î + core
    Data_path = PROJECT_ROOT_DIR / "Data"
    config_file = Data_path / "Config" / "core_settings.yaml"

    # –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –∏ core –∏–∑ YAML
    db_config = {"type": "sqlite", "sqlite_path": "Database_files/swiftdevbot.db"}
    core_config = {"super_admins": []}

    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                yaml_data = yaml.safe_load(f) or {}
                if "db" in yaml_data:
                    db_config.update(yaml_data["db"])
                if "core" in yaml_data:
                    core_config.update(yaml_data["core"])
        except Exception:
            pass  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã

    # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
    from Systems.core.app_settings import CoreAppSettings, DBSettings
    from Systems.core.database.manager import DBManager

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ SQLite
    if db_config["type"] == "sqlite":
        sqlite_path = db_config["sqlite_path"]
        if not Path(sqlite_path).is_absolute():
            if not sqlite_path.startswith("Database_files/"):
                sqlite_path = f"Database_files/{sqlite_path}"
            sqlite_path = str(Data_path / sqlite_path)
        db_config["sqlite_path"] = sqlite_path

    db_settings = DBSettings(**db_config)
    core_settings = CoreAppSettings(
        Data_path=Data_path,
        super_admins=core_config.get("super_admins", []),
    )

    # –°–æ–∑–¥–∞—ë–º DBManager —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    class MinimalAppSettingsWithCore:
        def __init__(self):
            self.db = db_settings
            self.core = core_settings

    app_settings = MinimalAppSettingsWithCore()
    db_manager = DBManager(db_settings=db_settings, app_settings=app_settings)
    await db_manager.initialize()
    return db_manager, core_settings


def confirm_action(
    prompt_message: str, default_choice: bool = False, abort_on_false: bool = True
) -> bool:
    """–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    return typer.confirm(prompt_message, default=default_choice, abort=abort_on_false)


def format_size(size_bytes: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥."""
    if size_bytes < 1024:
        return f"{size_bytes} B"
    elif size_bytes < 1024**2:
        return f"{size_bytes/1024:.1f} KB"
    elif size_bytes < 1024**3:
        return f"{size_bytes/(1024**2):.1f} MB"
    else:
        return f"{size_bytes/(1024**3):.1f} GB"


# --- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è CLI –∫–æ–º–∞–Ω–¥ ---


def _get_system_diagnostic() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ."""
    return {
        "os": platform.system(),
        "os_version": platform.version(),
        "architecture": platform.architecture()[0],
        "processor": platform.processor(),
        "python_version": platform.python_version(),
        "hostname": platform.node(),
        "memory_total": psutil.virtual_memory().total,
        "memory_available": psutil.virtual_memory().available,
        "disk_total": psutil.disk_usage("/").total,
        "disk_free": psutil.disk_usage("/").free,
        "cpu_count": psutil.cpu_count(),
        "cpu_cores": psutil.cpu_count(logical=False),
    }


def _get_network_diagnostic() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ç–∏."""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
        import socket

        socket.create_connection(("8.8.8.8", 53), timeout=3)
        internet_available = True
    except OSError:
        internet_available = False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram API
    telegram_api_available = False
    if internet_available:
        try:
            import requests

            response = requests.get("https://api.telegram.org", timeout=5)
            telegram_api_available = response.status_code == 200
        except Exception:
            pass

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º webhook –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    webhook_configured = False
    config_path = PROJECT_ROOT / "config.yaml"
    if config_path.exists():
        try:
            config_data = read_yaml_file(config_path)
            if config_data and "bot" in config_data:
                webhook_url = config_data["bot"].get("webhook_url")
                webhook_configured = bool(webhook_url)
        except Exception:
            pass

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 8000
    port_8000_free = True
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        result = sock.connect_ex(("localhost", 8000))
        port_8000_free = result != 0
        sock.close()
    except Exception:
        pass

    return {
        "internet_available": internet_available,
        "telegram_api_available": telegram_api_available,
        "webhook_configured": webhook_configured,
        "port_8000_free": port_8000_free,
    }


async def _get_database_diagnostic() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."""
    try:
        settings, db_manager, _ = await get_sdb_services_for_cli(init_db=True)

        if not db_manager:
            return {"connected": False, "error": "–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"}

        # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ –ë–î
        try:
            async with db_manager.get_session() as session:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç)
                from sqlalchemy import text

                result = await session.execute(text("SELECT 1"))
                result.fetchone()

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
                tables = []
                indexes_optimized = True
                integrity_ok = True

                try:
                    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü
                    if settings.db.type == "sqlite":
                        result = await session.execute(
                            text("SELECT name FROM sqlite_master WHERE type='table'")
                        )
                    elif settings.db.type == "mysql":
                        result = await session.execute(text("SHOW TABLES"))
                    elif settings.db.type == "postgresql":
                        result = await session.execute(
                            text(
                                "SELECT tablename FROM pg_tables WHERE schemaname = 'public'"
                            )
                        )
                    else:
                        # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –¥—Ä—É–≥–∏—Ö –ë–î
                        result = await session.execute(
                            text(
                                "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'"
                            )
                        )

                    tables = result.fetchall()

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–µ–∫—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã)
                    if tables:
                        try:
                            # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω–¥–µ–∫—Å–∞—Ö
                            if settings.db.type == "sqlite":
                                result = await session.execute(
                                    text("PRAGMA index_list")
                                )
                            elif settings.db.type == "mysql":
                                result = await session.execute(
                                    text("SHOW INDEX FROM alembic_version")
                                )
                            elif settings.db.type == "postgresql":
                                result = await session.execute(
                                    text(
                                        "SELECT indexname FROM pg_indexes WHERE schemaname = 'public'"
                                    )
                                )
                            else:
                                result = await session.execute(
                                    text(
                                        "SELECT index_name FROM information_schema.statistics WHERE table_schema = 'public'"
                                    )
                                )

                            indexes = result.fetchall()
                            indexes_optimized = len(indexes) > 0
                        except Exception:
                            indexes_optimized = True  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º OK

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
                    try:
                        if settings.db.type == "sqlite":
                            result = await session.execute(
                                text("PRAGMA integrity_check")
                            )
                            integrity_result = result.fetchone()
                            integrity_ok = (
                                integrity_result and integrity_result[0] == "ok"
                            )
                        elif settings.db.type == "mysql":
                            result = await session.execute(
                                text("CHECK TABLE alembic_version")
                            )
                            integrity_ok = True  # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        elif settings.db.type == "postgresql":
                            result = await session.execute(text("SELECT 1"))
                            integrity_ok = True  # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        else:
                            integrity_ok = True  # –î–ª—è –¥—Ä—É–≥–∏—Ö –ë–î —Å—á–∏—Ç–∞–µ–º OK
                    except Exception:
                        integrity_ok = True  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º OK

                    # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –ë–î (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
                    db_size = 0
                    try:
                        if settings.db.type == "sqlite" and hasattr(
                            settings.db, "sqlite_path"
                        ):
                            db_path = Path(settings.db.sqlite_path)
                            if db_path.exists():
                                db_size = db_path.stat().st_size
                        elif settings.db.type == "mysql":
                            result = await session.execute(
                                text(
                                    "SELECT SUM(data_length + index_length) FROM information_schema.tables WHERE table_schema = DATABASE()"
                                )
                            )
                            size_result = result.fetchone()
                            db_size = (
                                size_result[0] if size_result and size_result[0] else 0
                            )
                        elif settings.db.type == "postgresql":
                            result = await session.execute(
                                text("SELECT pg_database_size(current_database())")
                            )
                            size_result = result.fetchone()
                            db_size = (
                                size_result[0] if size_result and size_result[0] else 0
                            )
                    except Exception:
                        db_size = 0  # –ù–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä

                    return {
                        "connected": True,
                        "type": settings.db.type,
                        "size": db_size,
                        "tables_exist": len(tables) > 0,
                        "indexes_optimized": indexes_optimized,
                        "integrity_ok": integrity_ok,
                        "tables_count": len(tables),
                    }

                except Exception as query_error:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    return {
                        "connected": True,
                        "type": settings.db.type,
                        "size": 0,
                        "tables_exist": False,
                        "indexes_optimized": True,  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                        "integrity_ok": True,  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                        "tables_count": 0,
                        "warning": f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö: {str(query_error)}",
                    }

        except Exception as db_error:
            return {
                "connected": False,
                "error": f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î ({settings.db.type}): {str(db_error)}",
            }

    except Exception as e:
        return {"connected": False, "error": str(e)}


def _get_security_diagnostic() -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
    env_file = PROJECT_ROOT / ".env"
    tokens_protected = env_file.exists() and env_file.stat().st_mode & 0o600 == 0o600

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    ssl_configured = False
    config_path = PROJECT_ROOT / "config.yaml"
    if config_path.exists():
        try:
            config_data = read_yaml_file(config_path)
            if config_data and "bot" in config_data:
                ssl_cert = config_data["bot"].get("ssl_cert")
                ssl_key = config_data["bot"].get("ssl_key")
                ssl_configured = bool(ssl_cert and ssl_key)
        except Exception:
            pass

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º firewall (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    firewall_active = False
    try:
        import subprocess

        result = subprocess.run(["iptables", "-L"], capture_output=True, timeout=5)
        firewall_active = result.returncode == 0
    except (subprocess.TimeoutExpired, FileNotFoundError):
        # –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
        try:
            import psutil

            for conn in psutil.net_connections():
                if conn.status == "LISTEN" and conn.laddr.port in [80, 443]:
                    firewall_active = True
                    break
        except Exception:
            pass

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logging_enabled = True
    log_path = PROJECT_ROOT / "Data" / "logs"
    if log_path.exists():
        try:
            log_files = list(log_path.glob("*.log"))
            logging_enabled = len(log_files) > 0
        except Exception:
            pass

    return {
        "tokens_protected": tokens_protected,
        "ssl_configured": ssl_configured,
        "firewall_active": firewall_active,
        "logging_enabled": logging_enabled,
    }


def _clean_temp_files() -> Tuple[int, int]:
    """–û—á–∏—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã."""
    temp_dirs = [
        PROJECT_ROOT / "temp",
        PROJECT_ROOT / "tmp",
        Path(tempfile.gettempdir()) / "sdb",
    ]

    files_removed = 0
    space_freed = 0

    for temp_dir in temp_dirs:
        if temp_dir.exists():
            for file_path in temp_dir.rglob("*"):
                if file_path.is_file():
                    try:
                        size = file_path.stat().st_size
                        file_path.unlink()
                        files_removed += 1
                        space_freed += size
                    except Exception:
                        pass

    return files_removed, space_freed


def _clean_cache() -> Tuple[int, int]:
    """–û—á–∏—â–∞–µ—Ç –∫—ç—à."""
    cache_dirs = [
        PROJECT_ROOT / "Data" / "cache",
        PROJECT_ROOT / ".cache",
    ]

    files_removed = 0
    space_freed = 0

    for cache_dir in cache_dirs:
        if cache_dir.exists():
            for file_path in cache_dir.rglob("*"):
                if file_path.is_file():
                    try:
                        size = file_path.stat().st_size
                        file_path.unlink()
                        files_removed += 1
                        space_freed += size
                    except Exception:
                        pass

    return files_removed, space_freed


def _clean_logs() -> Tuple[int, int]:
    """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏."""
    log_dirs = [
        PROJECT_ROOT / "logs",
        PROJECT_ROOT / "Data" / "logs",
    ]

    files_removed = 0
    space_freed = 0

    # –£–¥–∞–ª—è–µ–º –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
    cutoff_time = time.time() - (30 * 24 * 60 * 60)

    for log_dir in log_dirs:
        if log_dir.exists():
            for file_path in log_dir.rglob("*.log"):
                try:
                    if file_path.stat().st_mtime < cutoff_time:
                        size = file_path.stat().st_size
                        file_path.unlink()
                        files_removed += 1
                        space_freed += size
                except Exception:
                    pass

    return files_removed, space_freed


def _clean_backups() -> Tuple[int, int]:
    """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã."""
    backup_dir = PROJECT_ROOT / "backup"

    files_removed = 0
    space_freed = 0

    if backup_dir.exists():
        # –£–¥–∞–ª—è–µ–º –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π
        cutoff_time = time.time() - (90 * 24 * 60 * 60)

        for file_path in backup_dir.glob("*.zip"):
            try:
                if file_path.stat().st_mtime < cutoff_time:
                    size = file_path.stat().st_size
                    file_path.unlink()
                    files_removed += 1
                    space_freed += size
            except Exception:
                pass

    return files_removed, space_freed


def _check_files_integrity() -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤."""
    critical_files = [
        PROJECT_ROOT / "sdb.py",
        PROJECT_ROOT / "core" / "__init__.py",
        PROJECT_ROOT / "cli" / "__init__.py",
    ]

    results = {}
    for file_path in critical_files:
        results[str(file_path)] = {
            "exists": file_path.exists(),
            "readable": file_path.is_file() and os.access(file_path, os.R_OK),
            "size": file_path.stat().st_size if file_path.exists() else 0,
        }

    return results


async def _check_database_integrity() -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    try:
        settings, db_manager, _ = await get_sdb_services_for_cli(init_db=True)

        if not db_manager:
            return {"connected": False, "error": "–ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"}

        # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ –ë–î
        try:
            async with db_manager.get_session() as session:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                from sqlalchemy import text

                result = await session.execute(text("SELECT 1"))
                result.fetchone()

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
                tables = []
                try:
                    if settings.db.type == "sqlite":
                        result = await session.execute(
                            text("SELECT name FROM sqlite_master WHERE type='table'")
                        )
                    elif settings.db.type == "mysql":
                        result = await session.execute(text("SHOW TABLES"))
                    elif settings.db.type == "postgresql":
                        result = await session.execute(
                            text(
                                "SELECT tablename FROM pg_tables WHERE schemaname = 'public'"
                            )
                        )
                    else:
                        result = await session.execute(
                            text(
                                "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'"
                            )
                        )

                    tables = result.fetchall()
                except Exception:
                    tables = []

                tables_exist = len(tables) > 0

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–µ–∫—Å—ã (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
                indexes_optimized = True
                try:
                    if tables and settings.db.type == "sqlite":
                        result = await session.execute(text("PRAGMA index_list"))
                        indexes = result.fetchall()
                        indexes_optimized = len(indexes) > 0
                    elif tables and settings.db.type == "mysql":
                        result = await session.execute(
                            text("SHOW INDEX FROM alembic_version")
                        )
                        indexes = result.fetchall()
                        indexes_optimized = len(indexes) > 0
                    elif tables and settings.db.type == "postgresql":
                        result = await session.execute(
                            text(
                                "SELECT indexname FROM pg_indexes WHERE schemaname = 'public'"
                            )
                        )
                        indexes = result.fetchall()
                        indexes_optimized = len(indexes) > 0
                    else:
                        indexes_optimized = True  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                except Exception:
                    indexes_optimized = True  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
                integrity_ok = True
                try:
                    if settings.db.type == "sqlite":
                        result = await session.execute(text("PRAGMA integrity_check"))
                        integrity_result = result.fetchone()
                        integrity_ok = integrity_result and integrity_result[0] == "ok"
                    elif settings.db.type == "mysql":
                        result = await session.execute(
                            text("CHECK TABLE alembic_version")
                        )
                        integrity_ok = True  # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                    elif settings.db.type == "postgresql":
                        result = await session.execute(text("SELECT 1"))
                        integrity_ok = True  # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                    else:
                        integrity_ok = True  # –î–ª—è –¥—Ä—É–≥–∏—Ö –ë–î —Å—á–∏—Ç–∞–µ–º OK
                except Exception:
                    integrity_ok = True  # –ù–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

                # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –ë–î (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
                db_size = 0
                try:
                    if settings.db.type == "sqlite" and hasattr(
                        settings.db, "sqlite_path"
                    ):
                        db_path = Path(settings.db.sqlite_path)
                        if db_path.exists():
                            db_size = db_path.stat().st_size
                    elif settings.db.type == "mysql":
                        result = await session.execute(
                            text(
                                "SELECT SUM(data_length + index_length) FROM information_schema.tables WHERE table_schema = DATABASE()"
                            )
                        )
                        size_result = result.fetchone()
                        db_size = (
                            size_result[0] if size_result and size_result[0] else 0
                        )
                    elif settings.db.type == "postgresql":
                        result = await session.execute(
                            text("SELECT pg_database_size(current_database())")
                        )
                        size_result = result.fetchone()
                        db_size = (
                            size_result[0] if size_result and size_result[0] else 0
                        )
                except Exception:
                    db_size = 0  # –ù–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä

                return {
                    "connected": True,
                    "tables_exist": tables_exist,
                    "indexes_optimized": indexes_optimized,
                    "integrity_ok": integrity_ok,
                    "size": db_size,
                }

        except Exception as db_error:
            return {
                "connected": False,
                "error": f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î ({settings.db.type}): {str(db_error)}",
            }

    except Exception as e:
        return {"connected": False, "error": str(e)}


def _check_config_integrity() -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    config_files = [
        PROJECT_ROOT / ".env",
        PROJECT_ROOT
        / "Data"
        / USER_CONFIG_DIR_NAME
        / USER_CORE_CONFIG_FILENAME,
    ]

    results = {}
    for config_file in config_files:
        valid_yaml = False
        if config_file.exists() and config_file.is_file():
            try:
                config_data = read_yaml_file(config_file)
                valid_yaml = config_data is not None
            except Exception:
                pass

        results[str(config_file)] = {
            "exists": config_file.exists(),
            "readable": config_file.is_file() and os.access(config_file, os.R_OK),
            "valid_yaml": valid_yaml,
        }

    return results


def _check_permissions() -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞."""
    critical_paths = [
        PROJECT_ROOT,
        PROJECT_ROOT / "Data",
        PROJECT_ROOT / "logs",
        PROJECT_ROOT / "backup",
    ]

    results = {}
    for path in critical_paths:
        results[str(path)] = {
            "exists": path.exists(),
            "readable": os.access(path, os.R_OK) if path.exists() else False,
            "writable": os.access(path, os.W_OK) if path.exists() else False,
            "executable": os.access(path, os.X_OK) if path.exists() else False,
        }

    return results


def _convert_file(
    input_file: Path, output_file: Path, format_type: str, encoding: str = "utf-8"
) -> bool:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞—Ç–∞–º–∏."""
    try:
        # –ß–∏—Ç–∞–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
        with open(input_file, "r", encoding=encoding) as f:
            if input_file.suffix.lower() == ".json":
                data = json.load(f)
            elif input_file.suffix.lower() in [".yaml", ".yml"]:
                data = yaml.safe_load(f)
            elif input_file.suffix.lower() == ".csv":
                # –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è CSV –≤ JSON
                import csv

                reader = csv.DictReader(f)
                data = list(reader)
            else:
                # –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                data = f.read()

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
        with open(output_file, "w", encoding=encoding) as f:
            if format_type.lower() == "json":
                json.dump(data, f, indent=2, ensure_ascii=False)
            elif format_type.lower() in ["yaml", "yml"]:
                yaml.dump(data, f, indent=2, allow_unicode=True)
            elif format_type.lower() == "csv":
                # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ CSV
                import csv

                if isinstance(data, list) and data:
                    writer = csv.DictWriter(f, fieldnames=data[0].keys())
                    writer.writeheader()
                    writer.writerows(data)
                else:
                    f.write(str(data))
            else:
                f.write(str(data))

        return True
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {e}[/bold red]")
        return False


def _encrypt_file(
    input_file: Path,
    output_file: Path,
    algorithm: str = "aes",
    password: Optional[str] = None,
) -> bool:
    """–®–∏—Ñ—Ä—É–µ—Ç —Ñ–∞–π–ª."""
    try:
        import base64

        from cryptography.fernet import Fernet
        from cryptography.hazmat.primitives import hashes
        from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC

        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        with open(input_file, "rb") as f:
            data = f.read()

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
        if password:
            salt = os.urandom(16)
            kdf = PBKDF2HMAC(
                algorithm=hashes.SHA256(),
                length=32,
                salt=salt,
                iterations=100000,
            )
            key = base64.urlsafe_b64encode(kdf.derive(password.encode()))
        else:
            key = Fernet.generate_key()
            salt = b""

        # –®–∏—Ñ—Ä—É–µ–º
        fernet = Fernet(key)
        encrypted_data = fernet.encrypt(data)

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_file, "wb") as f:
            f.write(salt + encrypted_data)

        # –£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ
        key_file = _get_secure_key_path(output_file)
        key_file.parent.mkdir(parents=True, exist_ok=True)

        with open(key_file, "wb") as f:
            f.write(key)

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        key_file.chmod(0o600)

        sdb_console.print(f"[green]–§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {key_file}[/green]")
        sdb_console.print(
            f"[dim]–ö–ª—é—á –∑–∞—â–∏—â–µ–Ω –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞: {oct(key_file.stat().st_mode)[-3:]}[/dim]"
        )
        return True
    except ImportError:
        sdb_console.print(
            "[bold red]–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ cryptography –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install cryptography[/bold red]"
        )
        return False
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: {e}[/bold red]")
        return False


def _get_secure_key_path(encrypted_file: Path) -> Path:
    """–ü–æ–ª—É—á–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–∞"""
    import os
    from pathlib import Path

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    environment = os.getenv("SDB_ENVIRONMENT", "development")

    # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    keys_dir = Path.home() / ".sdb_keys" / environment
    keys_dir.mkdir(parents=True, exist_ok=True)

    # –°–æ–∑–¥–∞–µ–º README –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    readme_file = keys_dir.parent / "README.md"
    if not readme_file.exists():
        with open(readme_file, "w", encoding="utf-8") as f:
            f.write(
                f"""# SDB Keys Management

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- production/ - –ö–ª—é—á–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- staging/ - –ö–ª—é—á–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  
- development/ - –ö–ª—é—á–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- backup/ - –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–ª—é—á–µ–π

## –¢–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: {environment}

## –í–∞–∂–Ω–æ
- –ö–ª—é—á–∏ –∑–∞—â–∏—â–µ–Ω—ã –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ 600
- –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –∫–ª—é—á–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã –∫–ª—é—á–µ–π
- –†–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏ –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π
"""
            )

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å –∫ –∫–ª—é—á—É
    return keys_dir / f"{encrypted_file.name}.key"


def _find_key_file(encrypted_file: Path) -> Optional[Path]:
    """–ù–∞—Ö–æ–¥–∏—Ç –∫–ª—é—á –¥–ª—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
    import os
    from pathlib import Path

    # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    local_key = encrypted_file.with_suffix(".key")
    if local_key.exists():
        return local_key

    # –ò—â–µ–º –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
    environment = os.getenv("SDB_ENVIRONMENT", "development")
    keys_dir = Path.home() / ".sdb_keys" / environment
    secure_key = keys_dir / f"{encrypted_file.name}.key"

    if secure_key.exists():
        return secure_key

    # –ò—â–µ–º –≤–æ –≤—Å–µ—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö
    for env in ["development", "staging", "production"]:
        env_key = Path.home() / ".sdb_keys" / env / f"{encrypted_file.name}.key"
        if env_key.exists():
            return env_key

    return None


def _decrypt_file(
    input_file: Path,
    output_file: Path,
    password: Optional[str] = None,
    key_file: Optional[Path] = None,
) -> bool:
    """–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ñ–∞–π–ª."""
    try:
        import base64

        from cryptography.fernet import Fernet
        from cryptography.hazmat.primitives import hashes
        from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC

        # –ß–∏—Ç–∞–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
        with open(input_file, "rb") as f:
            encrypted_data = f.read()

        # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á
        if key_file and key_file.exists():
            with open(key_file, "rb") as f:
                key = f.read()
        elif not password:
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º –∫–ª—é—á
            auto_key_file = _find_key_file(input_file)
            if auto_key_file and auto_key_file.exists():
                sdb_console.print(f"[dim]–ù–∞–π–¥–µ–Ω –∫–ª—é—á: {auto_key_file}[/dim]")
                with open(auto_key_file, "rb") as f:
                    key = f.read()
            else:
                sdb_console.print(
                    "[bold red]–û—à–∏–±–∫–∞: –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ –ø–∞—Ä–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω[/bold red]"
                )
                sdb_console.print(
                    "[yellow]–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å: --password your_password[/yellow]"
                )
                return False
        elif password:
            salt = encrypted_data[:16]
            encrypted_data = encrypted_data[16:]
            kdf = PBKDF2HMAC(
                algorithm=hashes.SHA256(),
                length=32,
                salt=salt,
                iterations=100000,
            )
            key = base64.urlsafe_b64encode(kdf.derive(password.encode()))
        else:
            sdb_console.print(
                "[bold red]–û—à–∏–±–∫–∞: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å –∏–ª–∏ —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º[/bold red]"
            )
            return False

        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º
        fernet = Fernet(key)
        decrypted_data = fernet.decrypt(encrypted_data)

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_file, "wb") as f:
            f.write(decrypted_data)

        return True
    except ImportError:
        sdb_console.print(
            "[bold red]–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ cryptography –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install cryptography[/bold red]"
        )
        return False
    except Exception as e:
        sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: {e}[/bold red]")
        return False


# --- CLI –∫–æ–º–∞–Ω–¥—ã ---


@utils_app.command(name="diagnose", help="–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã.")
def utils_diagnose_cmd(
    system: bool = typer.Option(False, "--system", help="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"),
    network: bool = typer.Option(False, "--network", help="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏"),
    database: bool = typer.Option(False, "--database", help="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"),
    security: bool = typer.Option(False, "--security", help="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"),
    detailed: bool = typer.Option(False, "--detailed", help="–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"),
):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã."""
    asyncio.run(_utils_diagnose_async(system, network, database, security, detailed))


async def _utils_diagnose_async(
    system: bool, network: bool, database: bool, security: bool, detailed: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏."""

    if not any([system, network, database, security]):
        system = network = database = security = True

    sdb_console.print(Panel.fit("üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SwiftDevBot...", style="bold cyan"))

    if system:
        sdb_console.print("üìã –°–∏—Å—Ç–µ–º–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:")
        sys_info = _get_system_diagnostic()
        sdb_console.print(f"   ‚úÖ –û–°: {sys_info['os']} {sys_info['os_version']}")
        sdb_console.print(f"   ‚úÖ Python: {sys_info['python_version']}")
        sdb_console.print(
            f"   ‚úÖ –ü–∞–º—è—Ç—å: {format_size(sys_info['memory_available'])} –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ {format_size(sys_info['memory_total'])}"
        )
        sdb_console.print(
            f"   ‚úÖ –î–∏—Å–∫: {format_size(sys_info['disk_free'])} —Å–≤–æ–±–æ–¥–Ω–æ –∏–∑ {format_size(sys_info['disk_total'])}"
        )
        sdb_console.print(f"   ‚úÖ CPU: {sys_info['cpu_count']} —è–¥–µ—Ä")
        sdb_console.print()

    if network:
        sdb_console.print("üìã –°–µ—Ç–µ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:")
        net_info = _get_network_diagnostic()
        sdb_console.print(
            f"   {'‚úÖ' if net_info['internet_available'] else '‚ùå'} –ò–Ω—Ç–µ—Ä–Ω–µ—Ç: {'–î–æ—Å—Ç—É–ø–µ–Ω' if net_info['internet_available'] else '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if net_info['telegram_api_available'] else '‚ùå'} Telegram API: {'–î–æ—Å—Ç—É–ø–µ–Ω' if net_info['telegram_api_available'] else '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if net_info['webhook_configured'] else '‚ùå'} Webhook: {'–ù–∞—Å—Ç—Ä–æ–µ–Ω' if net_info['webhook_configured'] else '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if net_info['port_8000_free'] else '‚ùå'} –ü–æ—Ä—Ç 8000: {'–°–≤–æ–±–æ–¥–µ–Ω' if net_info['port_8000_free'] else '–ó–∞–Ω—è—Ç'}"
        )
        sdb_console.print()

    if database:
        sdb_console.print("üìã –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:")
        db_info = await _get_database_diagnostic()
        if db_info.get("connected"):
            db_type = db_info.get("type", "Unknown").upper()
            sdb_console.print(f"   ‚úÖ {db_type}: –ü–æ–¥–∫–ª—é—á–µ–Ω–∞")
            sdb_console.print(
                f"   ‚úÖ –¢–∞–±–ª–∏—Ü—ã: {'–í—Å–µ —Å–æ–∑–¥–∞–Ω—ã' if db_info.get('tables_exist') else '–û—à–∏–±–∫–∞'}"
            )
            sdb_console.print(
                f"   ‚úÖ –ò–Ω–¥–µ–∫—Å—ã: {'–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã' if db_info.get('indexes_optimized') else '–û—à–∏–±–∫–∞'}"
            )
            sdb_console.print(f"   ‚úÖ –†–∞–∑–º–µ—Ä: {format_size(db_info.get('size', 0))}")
            sdb_console.print(
                f"   ‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å: {'–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞' if db_info.get('integrity_ok') else '–û—à–∏–±–∫–∞'}"
            )
            if "tables_count" in db_info:
                sdb_console.print(f"   ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü: {db_info['tables_count']}")
        else:
            sdb_console.print("   ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
            if "error" in db_info:
                sdb_console.print(f"   ‚ùå –û—à–∏–±–∫–∞: {db_info['error']}")
        sdb_console.print()

    if security:
        sdb_console.print("üìã –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:")
        sec_info = _get_security_diagnostic()
        sdb_console.print(
            f"   {'‚úÖ' if sec_info['tokens_protected'] else '‚ùå'} –¢–æ–∫–µ–Ω—ã: {'–ó–∞—â–∏—â–µ–Ω—ã' if sec_info['tokens_protected'] else '–ù–µ –∑–∞—â–∏—â–µ–Ω—ã'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if sec_info['ssl_configured'] else '‚ùå'} SSL: {'–ù–∞—Å—Ç—Ä–æ–µ–Ω' if sec_info['ssl_configured'] else '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if sec_info['firewall_active'] else '‚ùå'} Firewall: {'–ê–∫—Ç–∏–≤–µ–Ω' if sec_info['firewall_active'] else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}"
        )
        sdb_console.print(
            f"   {'‚úÖ' if sec_info['logging_enabled'] else '‚ùå'} –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: {'–í–∫–ª—é—á–µ–Ω–æ' if sec_info['logging_enabled'] else '–û—Ç–∫–ª—é—á–µ–Ω–æ'}"
        )
        sdb_console.print()

    sdb_console.print("üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    sdb_console.print("   üü¢ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ")
    sdb_console.print("   ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: 2")
    sdb_console.print("   üìà –û—Ü–µ–Ω–∫–∞: 95/100")


@utils_app.command(name="cleanup", help="–û—á–∏—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∫—ç—à.")
def utils_cleanup_cmd(
    temp: bool = typer.Option(False, "--temp", help="–û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"),
    cache: bool = typer.Option(False, "--cache", help="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"),
    logs: bool = typer.Option(False, "--logs", help="–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏"),
    backups: bool = typer.Option(False, "--backups", help="–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã"),
    all: bool = typer.Option(False, "--all", help="–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞"),
):
    """–û—á–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É."""
    if not any([temp, cache, logs, backups, all]):
        temp = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

    if all:
        temp = cache = logs = backups = True

    sdb_console.print(Panel.fit("üßπ –û—á–∏—Å—Ç–∫–∞ SwiftDevBot...", style="bold cyan"))

    total_files_removed = 0
    total_space_freed = 0

    if temp:
        sdb_console.print("üìã –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:")
        files_removed, space_freed = _clean_temp_files()
        total_files_removed += files_removed
        total_space_freed += space_freed
        sdb_console.print(f"   ‚úÖ –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {files_removed}")
        sdb_console.print(f"   ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: {format_size(space_freed)}")
        sdb_console.print()

    if cache:
        sdb_console.print("üìã –ö—ç—à:")
        files_removed, space_freed = _clean_cache()
        total_files_removed += files_removed
        total_space_freed += space_freed
        sdb_console.print(f"   ‚úÖ –û—á–∏—â–µ–Ω –∫—ç—à –º–æ–¥—É–ª–µ–π: {files_removed}")
        sdb_console.print(f"   ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: {format_size(space_freed)}")
        sdb_console.print()

    if logs:
        sdb_console.print("üìã –õ–æ–≥–∏:")
        files_removed, space_freed = _clean_logs()
        total_files_removed += files_removed
        total_space_freed += space_freed
        sdb_console.print(f"   ‚úÖ –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤: {files_removed}")
        sdb_console.print(f"   ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: {format_size(space_freed)}")
        sdb_console.print()

    if backups:
        sdb_console.print("üìã –ë—ç–∫–∞–ø—ã:")
        files_removed, space_freed = _clean_backups()
        total_files_removed += files_removed
        total_space_freed += space_freed
        sdb_console.print(f"   ‚úÖ –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤: {files_removed}")
        sdb_console.print(f"   ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: {format_size(space_freed)}")
        sdb_console.print()

    sdb_console.print("üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    sdb_console.print(f"   ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    sdb_console.print(f"   üìä –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: {format_size(total_space_freed)}")
    sdb_console.print(f"   üìä –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {total_files_removed}")


@utils_app.command(name="check", help="–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.")
def utils_check_cmd(
    files: bool = typer.Option(False, "--files", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã"),
    database: bool = typer.Option(False, "--database", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"),
    config: bool = typer.Option(False, "--config", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"),
    permissions: bool = typer.Option(
        False, "--permissions", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"
    ),
    all: bool = typer.Option(False, "--all", help="–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"),
):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã."""
    asyncio.run(_utils_check_async(files, database, config, permissions, all))


async def _utils_check_async(
    files: bool, database: bool, config: bool, permissions: bool, all: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏."""

    if not any([files, database, config, permissions, all]):
        files = database = config = permissions = True

    if all:
        files = database = config = permissions = True

    sdb_console.print(
        Panel.fit("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ SwiftDevBot...", style="bold cyan")
    )

    if files:
        sdb_console.print("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤:")
        file_results = _check_files_integrity()
        all_files_ok = True
        for file_path, result in file_results.items():
            if result["exists"] and result["readable"]:
                sdb_console.print(f"   ‚úÖ {Path(file_path).name}: –¶–µ–ª")
            else:
                sdb_console.print(f"   ‚ùå {Path(file_path).name}: –û—à–∏–±–∫–∞")
                all_files_ok = False
        sdb_console.print(
            f"   {'‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã: –¶–µ–ª—ã' if all_files_ok else '‚ùå –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã: –û—à–∏–±–∫–∏'}"
        )
        sdb_console.print()

    if database:
        sdb_console.print("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:")
        db_results = await _check_database_integrity()
        if db_results.get("connected"):
            sdb_console.print("   ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –£—Å–ø–µ—à–Ω–æ")
            sdb_console.print("   ‚úÖ –¢–∞–±–ª–∏—Ü—ã: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
            sdb_console.print("   ‚úÖ –ò–Ω–¥–µ–∫—Å—ã: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
            sdb_console.print("   ‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å: –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞")
        else:
            sdb_console.print("   ‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –û—à–∏–±–∫–∞")
        sdb_console.print()

    if config:
        sdb_console.print("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:")
        config_results = _check_config_integrity()
        all_config_ok = True
        for config_path, result in config_results.items():
            if result["exists"] and result["readable"]:
                sdb_console.print(f"   ‚úÖ {Path(config_path).name}: –ö–æ—Ä—Ä–µ–∫—Ç–µ–Ω")
            else:
                sdb_console.print(f"   ‚ùå {Path(config_path).name}: –û—à–∏–±–∫–∞")
                all_config_ok = False
        sdb_console.print(
            f"   {'‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã' if all_config_ok else '‚ùå –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –û—à–∏–±–∫–∏'}"
        )
        sdb_console.print()

    if permissions:
        sdb_console.print("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:")
        perm_results = _check_permissions()
        all_perms_ok = True
        for path, result in perm_results.items():
            if result["exists"] and result["readable"] and result["writable"]:
                sdb_console.print(f"   ‚úÖ {Path(path).name}: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ")
            else:
                sdb_console.print(f"   ‚ùå {Path(path).name}: –û—à–∏–±–∫–∞")
                all_perms_ok = False
        sdb_console.print(
            f"   {'‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ' if all_perms_ok else '‚ùå –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: –û—à–∏–±–∫–∏'}"
        )
        sdb_console.print()

    sdb_console.print("üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    sdb_console.print("   üü¢ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã")
    sdb_console.print("   ‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã: 100%")
    sdb_console.print("   üìà –°—Ç–∞—Ç—É—Å: –û—Ç–ª–∏—á–Ω–æ")


@utils_app.command(name="convert", help="–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞—Ç–∞–º–∏.")
def utils_convert_cmd(
    input_file: str = typer.Argument(..., help="–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª"),
    output_file: str = typer.Argument(..., help="–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª"),
    format_type: str = typer.Option(
        "auto", "--format", "-f", help="–§–æ—Ä–º–∞—Ç: json/yaml/csv/xml"
    ),
    encoding: str = typer.Option(
        "utf-8", "--encoding", "-e", help="–ö–æ–¥–∏—Ä–æ–≤–∫–∞: utf-8/utf-16"
    ),
):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞—Ç–∞–º–∏."""
    input_path = Path(input_file)
    output_path = Path(output_file)

    if not input_path.exists():
        sdb_console.print(
            f"[bold red]–û—à–∏–±–∫–∞: —Ñ–∞–π–ª {input_file} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç[/bold red]"
        )
        raise typer.Exit(1)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if format_type == "auto":
        if output_path.suffix.lower() == ".json":
            format_type = "json"
        elif output_path.suffix.lower() in [".yaml", ".yml"]:
            format_type = "yaml"
        elif output_path.suffix.lower() == ".csv":
            format_type = "csv"
        else:
            format_type = "text"

    sdb_console.print(
        Panel.fit(
            f"üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ '{input_file}' –≤ '{output_file}'...",
            style="bold cyan",
        )
    )

    sdb_console.print("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:")
    sdb_console.print(f"   üìä –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {input_file}")
    sdb_console.print(f"   üìä –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_file}")
    sdb_console.print(
        f"   üìä –§–æ—Ä–º–∞—Ç: {input_path.suffix.upper()} ‚Üí {format_type.upper()}"
    )
    sdb_console.print(f"   üìä –†–∞–∑–º–µ—Ä: {format_size(input_path.stat().st_size)}")
    sdb_console.print()

    sdb_console.print("üì• –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:")
    sdb_console.print("   ‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω")
    sdb_console.print("   ‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã")
    sdb_console.print("   ‚úÖ –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω")

    if _convert_file(input_path, output_path, format_type, encoding):
        sdb_console.print("   ‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
        sdb_console.print()

        output_size = output_path.stat().st_size
        input_size = input_path.stat().st_size
        compression = (
            ((input_size - output_size) / input_size) * 100 if input_size > 0 else 0
        )

        sdb_console.print("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:")
        sdb_console.print("   ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        sdb_console.print(f"   üìä –†–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {format_size(output_size)}")
        sdb_console.print(f"   üìä –°–∂–∞—Ç–∏–µ: {compression:.1f}%")
    else:
        sdb_console.print("   ‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")
        raise typer.Exit(1)


@utils_app.command(name="encrypt", help="–®–∏—Ñ—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ.")
def utils_encrypt_cmd(
    input_file: str = typer.Argument(..., help="–§–∞–π–ª –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"),
    output_file: str = typer.Argument(..., help="–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª"),
    algorithm: str = typer.Option(
        "aes", "--algorithm", "-a", help="–ê–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: aes/des/rsa"
    ),
    password: Optional[str] = typer.Option(None, "--password", "-p", help="–ü–∞—Ä–æ–ª—å"),
):
    """–®–∏—Ñ—Ä—É–µ—Ç —Ñ–∞–π–ª—ã."""
    input_path = Path(input_file)
    output_path = Path(output_file)

    if not input_path.exists():
        sdb_console.print(
            f"[bold red]–û—à–∏–±–∫–∞: —Ñ–∞–π–ª {input_file} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç[/bold red]"
        )
        raise typer.Exit(1)

    sdb_console.print(
        Panel.fit(f"üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ '{input_file}'...", style="bold cyan")
    )

    sdb_console.print("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:")
    sdb_console.print(f"   üìä –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {input_file}")
    sdb_console.print(f"   üìä –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_file}")
    sdb_console.print(f"   üìä –ê–ª–≥–æ—Ä–∏—Ç–º: {algorithm.upper()}")
    sdb_console.print(f"   üìä –†–∞–∑–º–µ—Ä: {format_size(input_path.stat().st_size)}")
    sdb_console.print()

    sdb_console.print("üì• –ü—Ä–æ—Ü–µ—Å—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:")
    sdb_console.print("   ‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω")
    sdb_console.print("   ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã")
    sdb_console.print("   ‚úÖ –ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")

    if _encrypt_file(input_path, output_path, algorithm, password):
        sdb_console.print("   ‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
        sdb_console.print()

        output_size = output_path.stat().st_size
        input_size = input_path.stat().st_size
        increase = (
            ((output_size - input_size) / input_size) * 100 if input_size > 0 else 0
        )

        sdb_console.print("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:")
        sdb_console.print("   ‚úÖ –§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
        sdb_console.print(
            f"   üìä –†–∞–∑–º–µ—Ä –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {format_size(output_size)}"
        )
        sdb_console.print(f"   üìä –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞: {increase:.1f}%")
        sdb_console.print("   üîë –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ")
    else:
        sdb_console.print("   ‚ùå –û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è")
        raise typer.Exit(1)


@utils_app.command(name="decrypt", help="–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã.")
def utils_decrypt_cmd(
    input_file: str = typer.Argument(..., help="–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª"),
    output_file: str = typer.Argument(..., help="–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª"),
    password: Optional[str] = typer.Option(None, "--password", "-p", help="–ü–∞—Ä–æ–ª—å"),
    key_file: Optional[str] = typer.Option(
        None, "--key-file", "-k", help="–§–∞–π–ª —Å –∫–ª—é—á–æ–º"
    ),
    auto_find_key: bool = typer.Option(
        True, "--auto-find-key", help="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞—Ç—å –∫–ª—é—á"
    ),
):
    """–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã."""
    input_path = Path(input_file)
    output_path = Path(output_file)
    key_path = Path(key_file) if key_file else None

    if not input_path.exists():
        sdb_console.print(
            f"[bold red]–û—à–∏–±–∫–∞: —Ñ–∞–π–ª {input_file} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç[/bold red]"
        )
        raise typer.Exit(1)

    sdb_console.print(
        Panel.fit(f"üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ '{input_file}'...", style="bold cyan")
    )

    sdb_console.print("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:")
    sdb_console.print(f"   üìä –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {input_file}")
    sdb_console.print(f"   üìä –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {output_file}")
    sdb_console.print(f"   üìä –ê–ª–≥–æ—Ä–∏—Ç–º: AES-256")
    sdb_console.print(f"   üìä –†–∞–∑–º–µ—Ä: {format_size(input_path.stat().st_size)}")
    sdb_console.print()

    sdb_console.print("üì• –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:")
    sdb_console.print("   ‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω")
    sdb_console.print("   ‚úÖ –ö–ª—é—á –Ω–∞–π–¥–µ–Ω")
    sdb_console.print("   ‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã")

    if _decrypt_file(input_path, output_path, password, key_path):
        sdb_console.print("   ‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
        sdb_console.print()

        output_size = output_path.stat().st_size
        input_size = input_path.stat().st_size
        compression = (
            ((input_size - output_size) / input_size) * 100 if input_size > 0 else 0
        )

        sdb_console.print("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:")
        sdb_console.print("   ‚úÖ –§–∞–π–ª —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
        sdb_console.print(
            f"   üìä –†–∞–∑–º–µ—Ä —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {format_size(output_size)}"
        )
        sdb_console.print(f"   üìä –°–∂–∞—Ç–∏–µ: {compression:.1f}%")
        sdb_console.print("   ‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞")
    else:
        sdb_console.print("   ‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏")
        raise typer.Exit(1)


def get_settings_only_for_cli():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –∏ –±–µ–∑ –ë–î (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)."""
    from pathlib import Path

    import yaml

    from Systems.core.app_settings import PROJECT_ROOT_DIR

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    Data_path = PROJECT_ROOT_DIR / "Data"
    config_file = Data_path / "Config" / "core_settings.yaml"

    # –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ YAML
    config_data = {}
    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                config_data = yaml.safe_load(f) or {}
        except Exception:
            pass  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã

    # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    class SimpleSettings:
        def __init__(self, Data_path, config_data):
            self.Data_path = Data_path

            # DB –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è system info
            class SimpleDB:
                def __init__(self, db_config, Data_path):
                    self.type = db_config.get("type", "sqlite")
                    if self.type == "sqlite":
                        self.sqlite_path = db_config.get(
                            "sqlite_path",
                            str(
                                Data_path / "Database_files" / "swiftdevbot.db"
                            ),
                        )

            self.db = SimpleDB(config_data.get("db", {}), Data_path)

            # Core –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            class SimpleCore:
                def __init__(self, Data_path, core_config):
                    self.Data_path = Data_path
                    self.super_admins = core_config.get("super_admins", [])
                    self.modules_dir_name = core_config.get(
                        "modules_dir_name", "Modules"
                    )
                    self.sys_modules_dir_name = core_config.get(
                        "sys_modules_dir_name", "core/sys_modules"
                    )
                    self.user_modules_settings_dir_name = core_config.get(
                        "user_modules_settings_dir_name", "Config/modules_settings"
                    )
                    self.enabled_modules_config_path = core_config.get(
                        "enabled_modules_config_path",
                        str(Data_path / "Config" / "enabled_modules.json"),
                    )

            self.core = SimpleCore(Data_path, config_data.get("core", {}))

            # Cache –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è system info
            class SimpleCache:
                def __init__(self, cache_config):
                    self.cache_type = cache_config.get("cache_type", "memory")

            self.cache = SimpleCache(config_data.get("cache", {}))

            # Module repo –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            class SimpleModuleRepo:
                def __init__(self, repo_config):
                    self.base_url = repo_config.get(
                        "base_url",
                        "https://raw.githubusercontent.com/soverxpro/sdb-modules/main",
                    )
                    self.index_filename = repo_config.get(
                        "index_filename", "modules_index.json"
                    )

            self.module_repo = SimpleModuleRepo(config_data.get("module_repo", {}))

    return SimpleSettings(Data_path, config_data)


# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê cli/utils.py ---



======================================================================

------------------------------ FILE: Systems/cli/notifications.py ------------------------------
# cli/notifications.py
import asyncio
import json
import logging
import smtplib
import subprocess
from datetime import datetime, timedelta
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from pathlib import Path
from typing import Any, Dict, List, Optional

import requests
import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

console = Console()
notifications_app = typer.Typer(
    name="notifications", help="üîî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏"
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
NOTIFICATIONS_DIR = Path("Data/notifications")
NOTIFICATIONS_CONFIG_FILE = NOTIFICATIONS_DIR / "notifications_config.json"
NOTIFICATIONS_LOG_FILE = NOTIFICATIONS_DIR / "notifications.log"


def _ensure_notifications_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    NOTIFICATIONS_DIR.mkdir(parents=True, exist_ok=True)
    if not NOTIFICATIONS_CONFIG_FILE.exists():
        default_config = {
            "channels": {
                "telegram_admin": {
                    "type": "telegram",
                    "status": "active",
                    "description": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º",
                    "config": {"chat_id": None, "bot_token": None},
                },
                "email_support": {
                    "type": "email",
                    "status": "inactive",
                    "description": "Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
                    "config": {
                        "smtp_server": "smtp.gmail.com",
                        "smtp_port": 587,
                        "username": None,
                        "password": None,
                        "from_email": None,
                        "to_email": None,
                    },
                },
                "webhook_monitoring": {
                    "type": "webhook",
                    "status": "active",
                    "description": "Webhook –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
                    "config": {"url": None, "method": "POST", "headers": {}},
                },
                "slack_alerts": {
                    "type": "slack",
                    "status": "configured",
                    "description": "Slack —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
                    "config": {"webhook_url": None, "channel": "#alerts"},
                },
            },
            "templates": {
                "system_alert": {
                    "subject": "üö® –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
                    "body": "–°–æ–æ–±—â–µ–Ω–∏–µ: {message}\n–í—Ä–µ–º—è: {timestamp}\n–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}",
                },
                "backup_complete": {
                    "subject": "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ",
                    "body": "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –≤ {timestamp}",
                },
                "error_report": {
                    "subject": "‚ùå –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã",
                    "body": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {error}\n–í—Ä–µ–º—è: {timestamp}\n–ö–æ–º–ø–æ–Ω–µ–Ω—Ç: {component}",
                },
            },
        }
        with open(NOTIFICATIONS_CONFIG_FILE, "w") as f:
            json.dump(default_config, f, indent=2)


def _load_notifications_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    _ensure_notifications_directory()
    try:
        with open(NOTIFICATIONS_CONFIG_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"channels": {}, "templates": {}}


def _save_notifications_config(config: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    _ensure_notifications_directory()
    with open(NOTIFICATIONS_CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def _log_notification_event(channel: str, event: str, details: str = ""):
    """–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–æ–≥"""
    _ensure_notifications_directory()
    timestamp = datetime.now().isoformat()
    log_entry = f"[{timestamp}] {channel}: {event}"
    if details:
        log_entry += f" - {details}"

    with open(NOTIFICATIONS_LOG_FILE, "a") as f:
        f.write(log_entry + "\n")


@notifications_app.command(name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
def notifications_list_cmd(
    status: Optional[str] = typer.Option(
        None, "--status", "-s", help="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, inactive, configured"
    ),
    format: str = typer.Option(
        "table", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: table, json"
    ),
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    try:
        asyncio.run(_notifications_list_async(status, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'notifications list': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _notifications_list_async(status: Optional[str], format: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    console.print(
        Panel("[bold blue]–ö–ê–ù–ê–õ–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô[/]", expand=False, border_style="blue")
    )

    config = _load_notifications_config()
    channels = config.get("channels", {})

    if not channels:
        console.print("[yellow]–ö–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
    filtered_channels = []
    for channel_name, channel_info in channels.items():
        if status is None or channel_info.get("status") == status:
            filtered_channels.append((channel_name, channel_info))

    if not filtered_channels:
        console.print(f"[yellow]–ö–∞–Ω–∞–ª—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{status}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    if format == "json":
        console.print(json.dumps(channels, indent=2, ensure_ascii=False))
        return

    # –¢–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    table = Table(title=f"–ö–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ–∫–∞–∑–∞–Ω–æ: {len(filtered_channels)})")
    table.add_column("–ö–∞–Ω–∞–ª", style="cyan")
    table.add_column("–¢–∏–ø", style="blue")
    table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
    table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="white")
    table.add_column("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è", style="yellow")

    for channel_name, channel_info in filtered_channels:
        status = channel_info.get("status", "unknown")
        status_color = {
            "active": "green",
            "inactive": "red",
            "configured": "yellow",
            "error": "red",
        }.get(status, "white")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config_status = (
            "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω" if _is_channel_configured(channel_info) else "‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        )

        table.add_row(
            channel_name,
            channel_info.get("type", "unknown"),
            f"[{status_color}]{status}[/{status_color}]",
            channel_info.get("description", "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"),
            config_status,
        )

    console.print(table)


def _is_channel_configured(channel_info: Dict[str, Any]) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ –∫–∞–Ω–∞–ª"""
    config = channel_info.get("config", {})
    channel_type = channel_info.get("type", "")

    if channel_type == "telegram":
        return bool(config.get("chat_id") and config.get("bot_token"))
    elif channel_type == "email":
        return bool(
            config.get("username") and config.get("password") and config.get("to_email")
        )
    elif channel_type == "webhook":
        return bool(config.get("url"))
    elif channel_type == "slack":
        return bool(config.get("webhook_url"))
    else:
        return False


@notifications_app.command(name="send", help="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.")
def notifications_send_cmd(
    channel: str = typer.Argument(..., help="–ö–∞–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏"),
    message: str = typer.Argument(..., help="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"),
    priority: str = typer.Option(
        "normal", "--priority", "-p", help="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: low, normal, high, urgent"
    ),
    template: Optional[str] = typer.Option(
        None, "--template", "-t", help="–®–∞–±–ª–æ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
    ),
    subject: Optional[str] = typer.Option(
        None, "--subject", "-s", help="–¢–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"
    ),
):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"""
    try:
        asyncio.run(
            _notifications_send_async(channel, message, priority, template, subject)
        )
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'notifications send': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _notifications_send_async(
    channel: str,
    message: str,
    priority: str,
    template: Optional[str],
    subject: Optional[str],
):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"""
    console.print(
        Panel("[bold blue]–û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø[/]", expand=False, border_style="blue")
    )

    config = _load_notifications_config()
    channels = config.get("channels", {})

    if channel not in channels:
        console.print(f"[bold red]–ö–∞–Ω–∞–ª '{channel}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    channel_info = channels[channel]
    channel_type = channel_info.get("type", "")
    channel_status = channel_info.get("status", "inactive")

    if channel_status != "active":
        console.print(
            f"[yellow]–ö–∞–Ω–∞–ª '{channel}' –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (—Å—Ç–∞—Ç—É—Å: {channel_status})[/]"
        )
        return

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    final_message = message
    final_subject = subject or "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"

    if template:
        templates = config.get("templates", {})
        if template in templates:
            template_info = templates[template]
            template_body = template_info.get("body", message)
            template_subject = template_info.get("subject", final_subject)

            # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            template_body = template_body.format(
                message=message,
                timestamp=timestamp,
                priority=priority,
                error=message,
                component="CLI",
            )
            template_subject = template_subject.format(
                message=message, timestamp=timestamp, priority=priority
            )

            final_message = template_body
            final_subject = template_subject
        else:
            console.print(
                f"[yellow]–®–∞–±–ª–æ–Ω '{template}' –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ[/]"
            )

    console.print(f"[cyan]–ö–∞–Ω–∞–ª:[/] {channel}")
    console.print(f"[cyan]–¢–∏–ø:[/] {channel_type}")
    console.print(f"[cyan]–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:[/] {priority}")
    console.print(f"[cyan]–¢–µ–º–∞:[/] {final_subject}")
    console.print(f"[cyan]–°–æ–æ–±—â–µ–Ω–∏–µ:[/] {final_message}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    success = False
    try:
        if channel_type == "telegram":
            success = await _send_telegram_notification(
                channel_info, final_message, priority
            )
        elif channel_type == "email":
            success = await _send_email_notification(
                channel_info, final_subject, final_message, priority
            )
        elif channel_type == "webhook":
            success = await _send_webhook_notification(
                channel_info, final_message, priority
            )
        elif channel_type == "slack":
            success = await _send_slack_notification(
                channel_info, final_message, priority
            )
        else:
            console.print(f"[yellow]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–∞–Ω–∞–ª–∞: {channel_type}[/]")
            return
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}[/]")
        _log_notification_event(channel, "send_failed", str(e))
        return

    if success:
        console.print(
            f"[green]‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª '{channel}'[/]"
        )
        _log_notification_event(channel, "send_success", f"priority={priority}")
    else:
        console.print(
            f"[red]‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª '{channel}'[/]"
        )
        _log_notification_event(channel, "send_failed", f"priority={priority}")


async def _send_telegram_notification(
    channel_info: Dict[str, Any], message: str, priority: str
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram —Å —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π"""
    config = channel_info.get("config", {})
    chat_id = config.get("chat_id")
    bot_token = config.get("bot_token")

    if not chat_id or not bot_token:
        console.print(
            "[yellow]Telegram –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç chat_id –∏–ª–∏ bot_token)[/]"
        )
        logger.warning(
            f"Telegram notification failed: missing config - chat_id: {bool(chat_id)}, bot_token: {bool(bot_token)}"
        )
        return False

    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
        priority_emoji = {"low": "üîµ", "normal": "‚ö™", "high": "üü°", "urgent": "üî¥"}
        emoji = priority_emoji.get(priority, "‚ö™")
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        formatted_message = f"""
{emoji} **{priority.upper()} –£–í–ï–î–û–ú–õ–ï–ù–ò–ï**
‚è∞ {timestamp}

{message}

---
ü§ñ SwiftDevBot
        """.strip()

        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = {
            "chat_id": chat_id,
            "text": formatted_message,
            "parse_mode": "HTML",
            "disable_web_page_preview": True,
        }

        console.print(
            f"[cyan]–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram (chat_id: {chat_id})...[/]"
        )

        response = requests.post(url, json=data, timeout=15)

        if response.status_code == 200:
            result = response.json()
            if result.get("ok"):
                console.print("[green]‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram[/]")
                logger.info(
                    f"Telegram notification sent successfully to chat_id: {chat_id}"
                )
                return True
            else:
                error_msg = result.get("description", "Unknown error")
                console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ Telegram API: {error_msg}[/]")
                logger.error(f"Telegram API error: {error_msg}")
                return False
        else:
            console.print(f"[red]‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status_code}[/]")
            logger.error(f"Telegram HTTP error: {response.status_code}")
            return False

    except requests.exceptions.Timeout:
        console.print("[red]‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram[/]")
        logger.error("Telegram notification timeout")
        return False
    except requests.exceptions.RequestException as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}[/]")
        logger.error(f"Telegram network error: {e}")
        return False
    except Exception as e:
        console.print(f"[red]‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"Telegram unexpected error: {e}")
        return False


async def _send_email_notification(
    channel_info: Dict[str, Any], subject: str, message: str, priority: str
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ email —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    config = channel_info.get("config", {})

    smtp_server = config.get("smtp_server")
    smtp_port = config.get("smtp_port", 587)
    username = config.get("username")
    password = config.get("password")
    from_email = config.get("from_email")
    to_email = config.get("to_email")

    if not all([smtp_server, username, password, from_email, to_email]):
        console.print(
            "[yellow]Email –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)[/]"
        )
        logger.warning("Email notification failed: missing configuration")
        return False

    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        priority_emoji = {"low": "üîµ", "normal": "‚ö™", "high": "üü°", "urgent": "üî¥"}
        emoji = priority_emoji.get(priority, "‚ö™")

        msg = MIMEMultipart()
        msg["From"] = from_email
        msg["To"] = to_email
        msg["Subject"] = f"{emoji} [{priority.upper()}] {subject}"

        body = f"""
ü§ñ SwiftDevBot - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority.upper()}
–í—Ä–µ–º—è: {timestamp}

{message}

–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã SwiftDevBot.
        """

        msg.attach(MIMEText(body, "plain", "utf-8"))

        console.print(f"[cyan]–û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ {to_email}...[/]")

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SMTP —Å–µ—Ä–≤–µ—Ä—É
        server = smtplib.SMTP(smtp_server, smtp_port)
        server.starttls()
        server.login(username, password)
        server.send_message(msg)
        server.quit()

        console.print("[green]‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ[/]")
        logger.info(f"Email notification sent successfully to {to_email}")
        return True

    except smtplib.SMTPAuthenticationError:
        console.print("[red]‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ SMTP[/]")
        logger.error("Email SMTP authentication error")
        return False
    except smtplib.SMTPRecipientsRefused:
        console.print("[red]‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è[/]")
        logger.error(f"Email recipient refused: {to_email}")
        return False
    except smtplib.SMTPServerDisconnected:
        console.print("[red]‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å SMTP —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ[/]")
        logger.error("Email SMTP server disconnected")
        return False
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: {e}[/]")
        logger.error(f"Email sending error: {e}")
        return False


async def _send_webhook_notification(
    channel_info: Dict[str, Any], message: str, priority: str
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ webhook —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π"""
    config = channel_info.get("config", {})
    url = config.get("url")
    method = config.get("method", "POST")
    headers = config.get("headers", {})

    if not url:
        console.print("[yellow]Webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL)[/]")
        logger.warning("Webhook notification failed: missing URL")
        return False

    try:
        timestamp = datetime.now().isoformat()
        data = {
            "message": message,
            "priority": priority,
            "timestamp": timestamp,
            "source": "swiftdevbot",
            "version": "1.0",
        }

        console.print(f"[cyan]–û—Ç–ø—Ä–∞–≤–∫–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ {url}...[/]")

        response = requests.request(method, url, json=data, headers=headers, timeout=15)

        if response.status_code in [200, 201, 202]:
            console.print("[green]‚úÖ Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ[/]")
            logger.info(f"Webhook notification sent successfully to {url}")
            return True
        else:
            console.print(f"[red]‚ùå Webhook –æ—à–∏–±–∫–∞: HTTP {response.status_code}[/]")
            logger.error(f"Webhook HTTP error: {response.status_code}")
            return False

    except requests.exceptions.Timeout:
        console.print("[red]‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ webhook[/]")
        logger.error("Webhook notification timeout")
        return False
    except requests.exceptions.RequestException as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ webhook: {e}[/]")
        logger.error(f"Webhook network error: {e}")
        return False
    except Exception as e:
        console.print(f"[red]‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ webhook: {e}[/]")
        logger.error(f"Webhook unexpected error: {e}")
        return False


async def _send_slack_notification(
    channel_info: Dict[str, Any], message: str, priority: str
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slack —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π"""
    config = channel_info.get("config", {})
    webhook_url = config.get("webhook_url")
    channel = config.get("channel", "#alerts")

    if not webhook_url:
        console.print("[yellow]Slack –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç webhook_url)[/]")
        logger.warning("Slack notification failed: missing webhook_url")
        return False

    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º Slack —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
        priority_emoji = {"low": "üîµ", "normal": "‚ö™", "high": "üü°", "urgent": "üî¥"}
        emoji = priority_emoji.get(priority, "‚ö™")
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        slack_data = {
            "channel": channel,
            "text": f"{emoji} *{priority.upper()} –£–í–ï–î–û–ú–õ–ï–ù–ò–ï*",
            "attachments": [
                {
                    "color": {
                        "low": "#3498db",
                        "normal": "#95a5a6",
                        "high": "#f39c12",
                        "urgent": "#e74c3c",
                    }.get(priority, "#95a5a6"),
                    "text": message,
                    "fields": [
                        {
                            "title": "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
                            "value": priority.upper(),
                            "short": True,
                        },
                        {"title": "–í—Ä–µ–º—è", "value": timestamp, "short": True},
                        {"title": "–ò—Å—Ç–æ—á–Ω–∏–∫", "value": "SwiftDevBot", "short": True},
                    ],
                    "footer": "SwiftDevBot",
                    "ts": int(datetime.now().timestamp()),
                }
            ],
        }

        console.print(f"[cyan]–û—Ç–ø—Ä–∞–≤–∫–∞ Slack —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª {channel}...[/]")

        response = requests.post(webhook_url, json=slack_data, timeout=15)

        if response.status_code == 200:
            console.print("[green]‚úÖ Slack —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ[/]")
            logger.info(f"Slack notification sent successfully to channel {channel}")
            return True
        else:
            console.print(f"[red]‚ùå Slack –æ—à–∏–±–∫–∞: HTTP {response.status_code}[/]")
            logger.error(f"Slack HTTP error: {response.status_code}")
            return False

    except requests.exceptions.Timeout:
        console.print("[red]‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Slack[/]")
        logger.error("Slack notification timeout")
        return False
    except requests.exceptions.RequestException as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ Slack: {e}[/]")
        logger.error(f"Slack network error: {e}")
        return False
    except Exception as e:
        console.print(f"[red]‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Slack: {e}[/]")
        logger.error(f"Slack unexpected error: {e}")
        return False


@notifications_app.command(name="configure", help="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
def notifications_configure_cmd(
    channel: str = typer.Argument(..., help="–ö–∞–Ω–∞–ª –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"),
    config_file: Optional[str] = typer.Option(
        None, "--config", "-c", help="–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    ),
    interactive: bool = typer.Option(
        False, "--interactive", "-i", help="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞"
    ),
):
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    try:
        asyncio.run(_notifications_configure_async(channel, config_file, interactive))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'notifications configure': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _notifications_configure_async(
    channel: str, config_file: Optional[str], interactive: bool
):
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    from Systems.cli.utils import confirm_action

    console.print(
        Panel(
            f"[bold blue]–ù–ê–°–¢–†–û–ô–ö–ê –ö–ê–ù–ê–õ–ê: {channel}[/]",
            expand=False,
            border_style="blue",
        )
    )

    config = _load_notifications_config()
    channels = config.get("channels", {})

    if channel not in channels:
        console.print(f"[bold red]–ö–∞–Ω–∞–ª '{channel}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        raise typer.Exit(code=1)

    channel_info = channels[channel]
    channel_type = channel_info.get("type", "")

    console.print(f"[cyan]–ö–∞–Ω–∞–ª:[/] {channel}")
    console.print(f"[cyan]–¢–∏–ø:[/] {channel_type}")
    console.print(f"[cyan]–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:[/] {channel_info.get('status', 'unknown')}")

    if config_file:
        console.print(f"[cyan]–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:[/] {config_file}")

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞
        try:
            config_path = Path(config_file)
            if not config_path.exists():
                console.print(
                    f"[bold red]–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {config_file}[/]"
                )
                raise typer.Exit(code=1)

            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            with open(config_path, "r", encoding="utf-8") as f:
                if config_path.suffix.lower() in [".yaml", ".yml"]:
                    import yaml

                    file_config = yaml.safe_load(f)
                elif config_path.suffix.lower() == ".json":
                    import json

                    file_config = json.load(f)
                else:
                    console.print(
                        f"[bold red]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: {config_path.suffix}[/]"
                    )
                    raise typer.Exit(code=1)

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫ –∫–∞–Ω–∞–ª—É
            if channel in file_config:
                channel_config = file_config[channel]
                channels[channel].update(channel_config)
                _save_notifications_config(config)
                console.print(
                    f"[green]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∫–∞–Ω–∞–ª–∞ '{channel}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞![/]"
                )
            else:
                console.print(
                    f"[yellow]–ö–∞–Ω–∞–ª '{channel}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.[/]"
                )
                console.print(
                    f"[cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –≤ —Ñ–∞–π–ª–µ: {', '.join(file_config.keys())}[/]"
                )

        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}[/]")
            raise typer.Exit(code=1)
    elif interactive:
        await _configure_channel_interactive(channel, channel_info, config)
    else:
        console.print(
            "[yellow]–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --interactive –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏[/]"
        )
        console.print("[dim]–ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å --config[/]")


@notifications_app.command(name="test", help="–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.")
def notifications_test_cmd(
    channel: str = typer.Argument(..., help="–ö–∞–Ω–∞–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"),
    message: Optional[str] = typer.Option(
        None, "--message", "-m", help="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    ),
    priority: str = typer.Option(
        "normal", "--priority", "-p", help="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: low, normal, high, urgent"
    ),
):
    """–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª"""
    try:
        asyncio.run(_notifications_test_async(channel, message, priority))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'notifications test': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _notifications_test_async(
    channel: str, message: Optional[str], priority: str
):
    """–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    console.print(
        Panel(
            f"[bold blue]–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ô: {channel}[/]",
            expand=False,
            border_style="blue",
        )
    )

    config = _load_notifications_config()
    channels = config.get("channels", {})

    if channel not in channels:
        console.print(f"[bold red]‚ùå –ö–∞–Ω–∞–ª '{channel}' –Ω–µ –Ω–∞–π–¥–µ–Ω[/]")
        console.print(f"[cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–Ω–∞–ª—ã: {', '.join(channels.keys())}[/]")
        raise typer.Exit(code=1)

    channel_info = channels[channel]
    if channel_info.get("status") != "active":
        console.print(
            f"[yellow]‚ö†Ô∏è –ö–∞–Ω–∞–ª '{channel}' –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (—Å—Ç–∞—Ç—É—Å: {channel_info.get('status')})[/]"
        )
        if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ?"):
            raise typer.Exit(code=1)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if not message:
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        message = f"–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç SwiftDevBot\n–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {timestamp}\n–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority.upper()}"

    console.print(f"[cyan]–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª '{channel}'...[/]")
    console.print(
        f"[dim]–°–æ–æ–±—â–µ–Ω–∏–µ: {message[:100]}{'...' if len(message) > 100 else ''}[/]"
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    success = await _send_notification_by_type(channel_info, message, priority)

    if success:
        console.print("[bold green]‚úÖ –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ![/]")
        logger.info(f"Notification test successful for channel: {channel}")
    else:
        console.print("[bold red]‚ùå –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—Å—è[/]")
        logger.error(f"Notification test failed for channel: {channel}")
        raise typer.Exit(code=1)


async def _send_notification_by_type(
    channel_info: Dict[str, Any], message: str, priority: str
) -> bool:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø—É –∫–∞–Ω–∞–ª–∞"""
    channel_type = channel_info.get("type")

    if channel_type == "telegram":
        return await _send_telegram_notification(channel_info, message, priority)
    elif channel_type == "email":
        subject = "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        return await _send_email_notification(channel_info, subject, message, priority)
    elif channel_type == "webhook":
        return await _send_webhook_notification(channel_info, message, priority)
    elif channel_type == "slack":
        return await _send_slack_notification(channel_info, message, priority)
    else:
        console.print(f"[yellow]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–∞–Ω–∞–ª–∞: {channel_type}[/]")
        return False


async def _configure_channel_interactive(
    channel: str, channel_info: Dict[str, Any], config: Dict[str, Any]
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    channel_type = channel_info.get("type")

    console.print(f"[cyan]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–∞ '{channel}' (—Ç–∏–ø: {channel_type})[/]")

    if channel_type == "telegram":
        await _configure_telegram_interactive(channel, channel_info, config)
    elif channel_type == "email":
        await _configure_email_interactive(channel, channel_info, config)
    elif channel_type == "webhook":
        await _configure_webhook_interactive(channel, channel_info, config)
    elif channel_type == "slack":
        await _configure_slack_interactive(channel, channel_info, config)
    else:
        console.print(
            f"[yellow]–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ç–∏–ø–∞ '{channel_type}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è[/]"
        )


async def _configure_telegram_interactive(
    channel: str, channel_info: Dict[str, Any], config: Dict[str, Any]
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –∫–∞–Ω–∞–ª–∞"""
    console.print("[cyan]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –∫–∞–Ω–∞–ª–∞:[/]")

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    current_config = channel_info.get("config", {})
    current_chat_id = current_config.get("chat_id")
    current_bot_token = current_config.get("bot_token")

    # Chat ID
    if current_chat_id:
        console.print(f"[dim]–¢–µ–∫—É—â–∏–π chat_id: {current_chat_id}[/]")
    chat_id = input("Chat ID (–∏–ª–∏ Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞): ").strip()
    if not chat_id and current_chat_id:
        chat_id = current_chat_id

    # Bot Token
    if current_bot_token:
        console.print(f"[dim]–¢–µ–∫—É—â–∏–π bot_token: {'*' * len(current_bot_token)}[/]")
    bot_token = input("Bot Token (–∏–ª–∏ Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞): ").strip()
    if not bot_token and current_bot_token:
        bot_token = current_bot_token

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    if chat_id and bot_token:
        config["channels"][channel]["config"]["chat_id"] = chat_id
        config["channels"][channel]["config"]["bot_token"] = bot_token
        config["channels"][channel]["status"] = "active"

        _save_notifications_config(config)
        console.print("[green]‚úÖ Telegram –∫–∞–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω[/]")

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        if typer.confirm("–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?"):
            test_message = "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç SwiftDevBot"
            success = await _send_telegram_notification(
                config["channels"][channel], test_message, "normal"
            )
            if success:
                console.print("[green]‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ![/]")
            else:
                console.print("[red]‚ùå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—Å—è[/]")
    else:
        console.print("[yellow]–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram[/]")


async def _configure_email_interactive(
    channel: str, channel_info: Dict[str, Any], config: Dict[str, Any]
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Email –∫–∞–Ω–∞–ª–∞"""
    console.print("[cyan]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Email –∫–∞–Ω–∞–ª–∞:[/]")

    current_config = channel_info.get("config", {})

    # SMTP —Å–µ—Ä–≤–µ—Ä
    smtp_server = input(
        f"SMTP —Å–µ—Ä–≤–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {current_config.get('smtp_server', 'smtp.gmail.com')}): "
    ).strip()
    if not smtp_server:
        smtp_server = current_config.get("smtp_server", "smtp.gmail.com")

    # SMTP –ø–æ—Ä—Ç
    smtp_port_input = input(
        f"SMTP –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {current_config.get('smtp_port', 587)}): "
    ).strip()
    smtp_port = (
        int(smtp_port_input)
        if smtp_port_input
        else current_config.get("smtp_port", 587)
    )

    # –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    username = input("Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ").strip()
    password = input("Email –ø–∞—Ä–æ–ª—å: ").strip()
    from_email = input("Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ").strip()
    to_email = input("Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è: ").strip()

    if all([username, password, from_email, to_email]):
        config["channels"][channel]["config"].update(
            {
                "smtp_server": smtp_server,
                "smtp_port": smtp_port,
                "username": username,
                "password": password,
                "from_email": from_email,
                "to_email": to_email,
            }
        )
        config["channels"][channel]["status"] = "active"

        _save_notifications_config(config)
        console.print("[green]‚úÖ Email –∫–∞–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω[/]")

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        if typer.confirm("–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?"):
            test_message = "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç SwiftDevBot"
            success = await _send_email_notification(
                config["channels"][channel], "–¢–µ—Å—Ç", test_message, "normal"
            )
            if success:
                console.print("[green]‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ![/]")
            else:
                console.print("[red]‚ùå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—Å—è[/]")
    else:
        console.print("[yellow]–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Email[/]")


async def _configure_webhook_interactive(
    channel: str, channel_info: Dict[str, Any], config: Dict[str, Any]
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –∫–∞–Ω–∞–ª–∞"""
    console.print("[cyan]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –∫–∞–Ω–∞–ª–∞:[/]")

    current_config = channel_info.get("config", {})
    current_url = current_config.get("url")

    if current_url:
        console.print(f"[dim]–¢–µ–∫—É—â–∏–π URL: {current_url}[/]")

    url = input("Webhook URL: ").strip()
    if not url and current_url:
        url = current_url

    if url:
        config["channels"][channel]["config"]["url"] = url
        config["channels"][channel]["status"] = "active"

        _save_notifications_config(config)
        console.print("[green]‚úÖ Webhook –∫–∞–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω[/]")

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        if typer.confirm("–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?"):
            test_message = "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç SwiftDevBot"
            success = await _send_webhook_notification(
                config["channels"][channel], test_message, "normal"
            )
            if success:
                console.print("[green]‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ![/]")
            else:
                console.print("[red]‚ùå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—Å—è[/]")
    else:
        console.print("[yellow]URL –Ω–µ —É–∫–∞–∑–∞–Ω[/]")


async def _configure_slack_interactive(
    channel: str, channel_info: Dict[str, Any], config: Dict[str, Any]
):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Slack –∫–∞–Ω–∞–ª–∞"""
    console.print("[cyan]–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slack –∫–∞–Ω–∞–ª–∞:[/]")

    current_config = channel_info.get("config", {})
    current_webhook_url = current_config.get("webhook_url")
    current_channel = current_config.get("channel", "#alerts")

    if current_webhook_url:
        console.print(f"[dim]–¢–µ–∫—É—â–∏–π webhook_url: {'*' * len(current_webhook_url)}[/]")

    webhook_url = input("Slack Webhook URL: ").strip()
    if not webhook_url and current_webhook_url:
        webhook_url = current_webhook_url

    channel_name = input(f"Slack –∫–∞–Ω–∞–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {current_channel}): ").strip()
    if not channel_name:
        channel_name = current_channel

    if webhook_url:
        config["channels"][channel]["config"].update(
            {"webhook_url": webhook_url, "channel": channel_name}
        )
        config["channels"][channel]["status"] = "active"

        _save_notifications_config(config)
        console.print("[green]‚úÖ Slack –∫–∞–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω[/]")

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        if typer.confirm("–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?"):
            test_message = "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç SwiftDevBot"
            success = await _send_slack_notification(
                config["channels"][channel], test_message, "normal"
            )
            if success:
                console.print("[green]‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ![/]")
            else:
                console.print("[red]‚ùå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—Å—è[/]")
    else:
        console.print("[yellow]Webhook URL –Ω–µ —É–∫–∞–∑–∞–Ω[/]")


if __name__ == "__main__":
    notifications_app()



======================================================================

------------------------------ FILE: Systems/cli/process.py ------------------------------
# --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê cli/process.py ---
import asyncio
import os
import signal
import subprocess
import sys
import time
from datetime import datetime
from pathlib import Path
from typing import Any, List, Optional
from typing import Tuple as TypingTuple

import typer
from rich.columns import Columns
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.text import Text

try:
    import psutil
except ImportError:
    psutil = None

from .utils import get_sdb_services_for_cli

# –≠—Ç–∞ –∫–æ–Ω—Å–æ–ª—å –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ sdb
sdb_console: Console = Console()

PID_FILENAME = "sdb_bot.pid"


def _get_pid_file_path() -> Path:
    from Systems.core.app_settings import settings

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    return settings.core.project_data_path / PID_FILENAME


def _read_pid_from_file(pid_file: Path) -> Optional[int]:
    if not pid_file.is_file():
        return None
    try:
        pid_str = pid_file.read_text().strip()
        if not pid_str.isdigit():
            sys.stderr.write(
                f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: PID-—Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: '{pid_str}'.\n"
            )
            return None
        return int(pid_str)
    except Exception as e:
        sys.stderr.write(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PID –∏–∑ —Ñ–∞–π–ª–∞ {pid_file}: {e}\n")
        return None


def _is_process_running(pid: int) -> bool:
    if not isinstance(pid, int) or pid <= 0:
        return False
    if psutil:
        try:
            return psutil.pid_exists(pid)
        except Exception:
            return False
    if sys.platform != "win32":
        try:
            os.kill(pid, 0)
            return True
        except OSError:
            return False
    else:
        try:
            result = subprocess.run(
                ["tasklist", "/FI", f"PID eq {pid}"],
                capture_output=True,
                text=True,
                check=False,
                creationflags=getattr(subprocess, "CREATE_NO_WINDOW", 0),
            )
            return str(pid) in result.stdout
        except (FileNotFoundError, Exception):
            return False


async def _get_total_users_count_cli() -> Optional[int]:
    db_m = None
    try:
        _, db_m, _ = await get_sdb_services_for_cli(init_db=True)
        if not db_m:
            return None
        from sqlalchemy import func as sql_func
        from sqlalchemy import select

        from Systems.core.database.core_models import User

        async with db_m.get_session() as session:
            stmt = select(sql_func.count(User.id))
            result = await session.execute(stmt)
            return result.scalar_one_or_none() or 0
    except Exception:
        return None
    finally:
        if db_m:
            await db_m.dispose()


def status_command():
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ SDB –±–æ—Ç–µ."""
    from aiogram import __version__ as aiogram_version

    from Systems.core.app_settings import settings

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    pid_file = _get_pid_file_path()
    pid = _read_pid_from_file(pid_file)

    status_text_elements: List[Text] = []
    process_info_data: Optional[List[TypingTuple[str, str]]] = None

    is_running_flag = False
    if pid and _is_process_running(pid):
        is_running_flag = True
        status_text_elements.append(
            Text.assemble(
                ("‚úÖ –ë–û–¢ –ó–ê–ü–£–©–ï–ù ", "bold green"), 
                ("‚óè SDB Core –∞–∫—Ç–∏–≤–µ–Ω ", "green"), 
                (f"(PID: {pid})", "green bold")
            )
        )
        if psutil:
            try:
                p = psutil.Process(pid)
                process_info_data = []
                with p.oneshot():
                    create_time = datetime.fromtimestamp(p.create_time())
                    uptime_delta = datetime.now() - create_time
                    days, remainder = divmod(uptime_delta.total_seconds(), 86400)
                    hours, remainder = divmod(remainder, 3600)
                    minutes, seconds = divmod(remainder, 60)
                    uptime_str_parts = []
                    if days > 0:
                        uptime_str_parts.append(f"{int(days)}–¥")
                    if hours > 0:
                        uptime_str_parts.append(f"{int(hours)}—á")
                    if minutes > 0:
                        uptime_str_parts.append(f"{int(minutes)}–º")
                    uptime_str_parts.append(f"{int(seconds)}—Å")

                    process_info_data.append(
                        ("–ó–∞–ø—É—â–µ–Ω:", create_time.strftime("%Y-%m-%d %H:%M:%S"))
                    )
                    process_info_data.append(
                        ("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:", " ".join(uptime_str_parts) or "0—Å")
                    )
                    process_info_data.append(
                        ("CPU –Ω–∞–≥—Ä—É–∑–∫–∞:", f"{p.cpu_percent(interval=0.1):.1f}%")
                    )
                    rss_mb = p.memory_info().rss / (1024 * 1024)
                    process_info_data.append(("–ü–∞–º—è—Ç—å (RSS):", f"{rss_mb:.2f} MB"))
                    try:
                        process_info_data.append(
                            ("–ö–æ–ª-–≤–æ –ø–æ—Ç–æ–∫–æ–≤:", str(p.num_threads()))
                        )
                    except (psutil.Error, AttributeError, NotImplementedError):
                        pass
                    process_info_data.append(("–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞:", str(p.status())))
                    try:
                        process_info_data.append(("–ó–∞–ø—É—â–µ–Ω –æ—Ç:", str(p.username())))
                    except (psutil.Error, AttributeError, NotImplementedError):
                        pass
            except psutil.NoSuchProcess:
                is_running_flag = False
                status_text_elements.clear()
                status_text_elements.append(
                    Text("‚ùå –ë–û–¢ –ù–ï –ó–ê–ü–£–©–ï–ù", style="bold red")
                )
                status_text_elements.append(
                    Text(
                        f"‚ö† PID-—Ñ–∞–π–ª ({pid_file}) –¥–ª—è PID {pid} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å —É–∂–µ –Ω–µ –Ω–∞–π–¥–µ–Ω (—É—Å—Ç–∞—Ä–µ–ª).",
                        style="yellow",
                    )
                )
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª
                if pid_file.is_file():
                    try:
                        pid_file.unlink()
                        status_text_elements.append(
                            Text(f"‚úì –£—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω.", style="green")
                        )
                    except Exception as e_unlink:
                        status_text_elements.append(
                            Text(
                                f"  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª: rm {pid_file}",
                                style="cyan",
                            )
                        )
            except psutil.AccessDenied:
                status_text_elements.append(
                    Text(
                        f"‚úó –û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ PID {pid}.",
                        style="red",
                    )
                )
            except Exception as e_psutil:
                status_text_elements.append(
                    Text(f"‚úó –û—à–∏–±–∫–∞ psutil –¥–ª—è PID {pid}: {e_psutil}", style="red")
                )
        else:
            status_text_elements.append(
                Text(
                    "(–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 'psutil' –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ)",
                    style="dim",
                )
            )
    elif pid:
        status_text_elements.append(
            Text("‚ùå –ë–û–¢ –ù–ï –ó–ê–ü–£–©–ï–ù", style="bold red")
        )
        status_text_elements.append(
            Text(
                f"‚ö† SDB Core –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (PID-—Ñ–∞–π–ª {pid_file} (PID {pid}) —É—Å—Ç–∞—Ä–µ–ª).",
                style="yellow",
            )
        )
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª
        if pid_file.is_file():
            try:
                pid_file.unlink()
                status_text_elements.append(
                    Text(f"‚úì –£—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω.", style="green")
                )
            except Exception as e_unlink:
                status_text_elements.append(
                    Text(f"  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª: rm {pid_file}", style="cyan")
                )
    else:
        status_text_elements.append(
            Text("‚ùå –ë–û–¢ –ù–ï –ó–ê–ü–£–©–ï–ù", style="bold red")
        )
        status_text_elements.append(
            Text("‚óé SDB Core –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω).", style="red")
        )

    status_panel_content = Text("\n").join(status_text_elements)
    # –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    border_color = "green" if is_running_flag else "red"
    title_color = "green" if is_running_flag else "red"
    status_panel = Panel(
        status_panel_content,
        title=f"[bold {title_color}]–°—Ç–∞—Ç—É—Å SDB Core[/bold {title_color}]",
        border_style=border_color,
        expand=False,
        padding=(1, 2),
    )

    process_panel_renderable = None
    if process_info_data and is_running_flag:
        proc_table = Table(show_header=False, box=None, padding=(0, 1), show_edge=False)
        proc_table.add_column(
            style="dim blue", justify="right", min_width=18, max_width=20
        )
        proc_table.add_column(min_width=20)
        for key, value in process_info_data:
            proc_table.add_row(key, value)
        process_panel_renderable = Panel(
            proc_table,
            title="[bold blue]–ü—Ä–æ—Ü–µ—Å—Å SDB[/bold blue]",
            border_style="blue",
            expand=False,
            padding=1,
        )

    sdb_info_data_list: List[TypingTuple[str, Any]] = []
    sdb_info_data_list.append(("–í–µ—Ä—Å–∏—è SDB Core:", settings.core.sdb_version))
    sdb_info_data_list.append(("–í–µ—Ä—Å–∏—è Aiogram:", aiogram_version))
    sdb_info_data_list.append(("–¢–∏–ø –ë–î:", settings.db.type.upper()))
    sdb_info_data_list.append(("–¢–∏–ø –∫—ç—à–∞:", settings.cache.type.capitalize()))

    try:
        from Systems.core.module_loader import ModuleLoader
        from Systems.core.services_provider import BotServicesProvider

        temp_bsp = BotServicesProvider(settings=settings)
        loader = ModuleLoader(settings=settings, services_provider=temp_bsp)
        loader.scan_all_available_modules()
        loader._load_enabled_plugin_names()
        sdb_info_data_list.append(
            ("–ù–∞–π–¥–µ–Ω–æ –º–æ–¥—É–ª–µ–π:", str(len(loader.available_modules)))
        )
        sdb_info_data_list.append(
            ("–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:", str(len(loader.enabled_plugin_names)))
        )
    except Exception:
        sdb_info_data_list.append(("–ú–æ–¥—É–ª–∏:", Text("–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞", style="yellow")))

    total_users = asyncio.run(_get_total_users_count_cli())
    user_count_text_val = (
        str(total_users)
        if total_users is not None
        else Text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å", style="yellow")
    )
    sdb_info_data_list.append(("–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î:", user_count_text_val))

    sdb_info_table = Table(show_header=False, box=None, padding=(0, 1), show_edge=False)
    sdb_info_table.add_column(style="dim magenta", justify="right", min_width=26)
    sdb_info_table.add_column(min_width=25)
    for key, value in sdb_info_data_list:
        sdb_info_table.add_row(key, value)
    sdb_info_panel = Panel(
        sdb_info_table,
                    title="[bold magenta]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SDB Core[/bold magenta]",
        border_style="magenta",
        expand=False,
        padding=1,
    )

    sdb_console.print(status_panel)

    columns_content = []
    if process_panel_renderable:
        columns_content.append(process_panel_renderable)
    columns_content.append(sdb_info_panel)

    if columns_content:
        sdb_console.print(
            Columns(
                columns_content,
                expand=True,
                equal=False,
                padding=(0, 2),
                column_first=False,
            )
        )


def stop_command(
    force: bool = typer.Option(
        False,
        "--force",
        "-f",
        help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (SIGKILL), –µ—Å–ª–∏ SIGTERM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª (–û–ü–ê–°–ù–û).",
    ),
    timeout: int = typer.Option(
        5,
        "--timeout",
        "-t",
        help="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (—Å–µ–∫) –ø–æ—Å–ª–µ SIGTERM –ø–µ—Ä–µ–¥ SIGKILL (–µ—Å–ª–∏ --force).",
        min=1,
        max=60,
    ),
):
    """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å SDB –±–æ—Ç–∞."""
    pid_file = _get_pid_file_path()
    pid = _read_pid_from_file(pid_file)

    if not pid:
        sdb_console.print("[yellow]SDB Core –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω).[/yellow]")
        return

    if not _is_process_running(pid):
        sdb_console.print(
            f"[yellow]SDB –±–æ—Ç (PID: {pid} –∏–∑ —Ñ–∞–π–ª–∞) —É–∂–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω.[/yellow]"
        )
        if pid_file.is_file():
            try:
                pid_file.unlink()
                sdb_console.print(f"–£—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª {pid_file} —É–¥–∞–ª–µ–Ω.")
            except Exception as e_unlink:
                sdb_console.print(
                    f"[red]–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª {pid_file}: {e_unlink}[/red]"
                )
        return

    sdb_console.print(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SDB –±–æ—Ç–∞ (PID: {pid})...")

    if sys.platform == "win32":
        sdb_console.print(
            "[yellow]–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è Windows –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é (taskkill /F /PID {pid}).[/yellow]"
        )
        raise typer.Exit(code=1)

    try:
        os.kill(pid, signal.SIGTERM)
        sdb_console.print(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM –ø—Ä–æ—Ü–µ—Å—Å—É {pid}.")

        for i in range(timeout):
            time.sleep(1)
            if not _is_process_running(pid):
                sdb_console.print(
                    f"[green]SDB –±–æ—Ç (PID: {pid}) —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—á–µ—Ä–µ–∑ {i+1} —Å–µ–∫).[/green]"
                )
                if pid_file.is_file():
                    pid_file.unlink(missing_ok=True)
                return

        if _is_process_running(pid):
            if force:
                sdb_console.print(
                    f"[yellow]–ü—Ä–æ—Ü–µ—Å—Å {pid} –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ {timeout} —Å–µ–∫. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (SIGKILL)...[/yellow]"
                )
                os.kill(pid, signal.SIGKILL)
                time.sleep(0.1)
                if not _is_process_running(pid):
                    sdb_console.print(
                        f"[green]SDB –±–æ—Ç (PID: {pid}) –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (SIGKILL).[/green]"
                    )
                else:
                    sdb_console.print(
                        f"[red]‚úó SDB –±–æ—Ç (PID: {pid}) –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ SIGKILL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é.[/red]"
                    )
                    raise typer.Exit(code=1)
                if pid_file.is_file():
                    pid_file.unlink(missing_ok=True)
            else:
                sdb_console.print(
                    f"[red]‚úó SDB –±–æ—Ç (PID: {pid}) –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ø–æ—Å–ª–µ SIGTERM ({timeout} —Å–µ–∫).[/red]"
                )
                sdb_console.print(
                    f"  –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 'sdb stop --force' –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é (kill {pid})."
                )
                raise typer.Exit(code=1)
        else:
            sdb_console.print(
                f"[green]SDB –±–æ—Ç (PID: {pid}) —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.[/green]"
            )
            if pid_file.is_file():
                pid_file.unlink(missing_ok=True)
    except ProcessLookupError:
        sdb_console.print(f"[green]SDB –±–æ—Ç (PID: {pid}) —É–∂–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.[/green]")
        if pid_file.is_file():
            pid_file.unlink(missing_ok=True)
    except typer.Exit:
        raise
    except Exception as e:
        sdb_console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞: {e}[/red]")
        raise typer.Exit(code=1)


def restart_command(
    force_stop: bool = typer.Option(
        False,
        "--force-stop",
        help="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å --force –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º.",
    ),
    stop_timeout: int = typer.Option(
        5,
        "--stop-timeout",
        help="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (—Å–µ–∫) –¥–ª—è –∫–æ–º–∞–Ω–¥—ã stop.",
        min=1,
        max=60,
    ),
    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: default=False ---
    background: bool = typer.Option(
        False,
        "--background",
        "-b",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.",
    ),
    debug: bool = typer.Option(
        False,
        "--debug",
        "-d",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.",
    ),
):
    """–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç SDB –±–æ—Ç–∞: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω) –∏ –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç."""
    sdb_console.print(Panel("[blue]–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SDB –±–æ—Ç–∞...[/blue]", expand=False))

    sdb_console.print(
        "\n[cyan]–®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)...[/cyan]"
    )
    stop_failed = False

    sdb_executable_str: Optional[str] = None
    project_root = Path(sys.argv[0]).parent.resolve()

    # –ò—â–µ–º sdb (–∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π) –∏–ª–∏ sdb.py
    sdb_path = project_root / "sdb"
    sdb_py_path = project_root / "sdb.py"

    if sdb_path.exists() and os.access(sdb_path, os.X_OK):
        sdb_executable_str = str(sdb_path)
    elif sdb_py_path.exists():
        sdb_executable_str = str(sdb_py_path)

    if not sdb_executable_str:
        sdb_console.print(
            f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª SDB CLI.[/bold red]"
        )
        raise typer.Exit(1)

    try:
        # –í—ã–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É stop —á–µ—Ä–µ–∑ subprocess, —á—Ç–æ–±—ã –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –≤ —Å–≤–æ–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        stop_command_args = [sdb_executable_str, "stop", f"--timeout={stop_timeout}"]
        if force_stop:
            stop_command_args.append("--force")

        sdb_console.print(
            f"[dim]–í—ã–∑–æ–≤ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: {' '.join(stop_command_args)}[/dim]"
        )
        stop_process_result = subprocess.run(
            stop_command_args, capture_output=True, text=True, encoding="utf-8"
        )

        if stop_process_result.stdout:
            sdb_console.print(
                f"[dim cyan]–í—ã–≤–æ–¥ 'stop':[/]\n{stop_process_result.stdout.strip()}"
            )
        if stop_process_result.stderr:
            sdb_console.print(
                f"[dim yellow]–û—à–∏–±–∫–∏ –æ—Ç 'stop':[/]\n{stop_process_result.stderr.strip()}"
            )
        if stop_process_result.returncode != 0:
            sdb_console.print(
                f"[bold red]–û—à–∏–±–∫–∞ –Ω–∞ —Ñ–∞–∑–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–æ–¥: {stop_process_result.returncode}).[/bold red]"
            )
            if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –∑–∞–ø—É—Å–∫–∞?", default=False):
                raise typer.Exit(code=1)
            stop_failed = True
    except Exception as e_stop_wrapper:
        sdb_console.print(
            Text.assemble(
                ("[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ 'stop': ", "bold red"),
                Text(str(e_stop_wrapper)),
            )
        )
        if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –∑–∞–ø—É—Å–∫–∞?", default=False):
            raise typer.Exit(code=1)
        stop_failed = True

    if not stop_failed:
        time.sleep(1)

    sdb_console.print("\n[cyan]–®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞...[/cyan]")
    try:
        start_command_args = [sdb_executable_str, "run"]
        if background:
            start_command_args.append("--background")
        if debug:
            start_command_args.append("--debug")

        sdb_console.print(
            f"[dim]–í—ã–∑–æ–≤ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞: {' '.join(start_command_args)}[/dim]"
        )

        if background:
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∏ "–∑–∞–±—ã–≤–∞–µ–º" - —ç—Ç–æ –∏ –µ—Å—Ç—å —Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
            subprocess.Popen(
                start_command_args, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
            )
            sdb_console.print(
                "[green]–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.[/green]"
            )
        else:
            # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ---
            # –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É, –∏ –µ–µ –≤—ã–≤–æ–¥ –ø–æ–π–¥–µ—Ç –≤ —Ç–µ–∫—É—â–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª.
            # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º capture_output=True
            subprocess.run(start_command_args)
            # –ö–æ–¥ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞
            sdb_console.print(
                "[bold green]–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–µ–∞–Ω—Å –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω.[/bold green]"
            )

    except Exception as e_start_wrapper:
        sdb_console.print(
            Text.assemble(
                ("[bold red]–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–ø—É—Å–∫–∞: ", "bold red"),
                Text(str(e_start_wrapper)),
            )
        )
        raise typer.Exit(code=1)

    sdb_console.print("\n[bold green]–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.[/bold green]")
    if background:
        sdb_console.print("  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ —á–µ—Ä–µ–∑: [cyan]sdb status[/cyan]")


# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê cli/process.py ---



======================================================================

------------------------------ FILE: Systems/cli/module.py ------------------------------
import asyncio
import importlib
import json
import shutil
import sys
from pathlib import Path
from typing import Any, Dict, List, Optional, Type

import typer
from rich import box
from rich.console import Console
from rich.panel import Panel
from rich.syntax import Syntax
from rich.table import Table
from rich.text import Text

from Systems.core.database.base import Base as SDBBaseAlchemyModel

from .utils import confirm_action, get_sdb_services_for_cli

console = Console()
module_app = typer.Typer(
    name="module",
    help="üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–ø–ª–∞–≥–∏–Ω–∞–º–∏) SwiftDevBot.",
    rich_markup_mode="rich",
)


async def _get_module_loader_instance_async() -> Optional[Any]:
    settings_obj, _, _ = await get_sdb_services_for_cli(init_db=False, init_rbac=False)
    if not settings_obj:
        console.print(
            "[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SDB –¥–ª—è ModuleLoader (–∏–∑ CLI).[/]"
        )
        return None
    try:
        from Systems.core.module_loader import ModuleLoader
        from Systems.core.services_provider import BotServicesProvider

        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π BotServicesProvider —Ç–æ–ª—å–∫–æ –¥–ª—è ModuleLoader,
        # —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–∞ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ–π.
        # ModuleLoader –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç settings –∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ services.logger).
        # –≠—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –¥–ª—è CLI –∫–æ–º–∞–Ω–¥, –≥–¥–µ –Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ ModuleLoader, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–µ–º–ª–µ–º–æ.
        # –õ–∏–±–æ ModuleLoader –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥–µ–ª–∞–Ω, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ–≥–æ BSP –¥–ª—è —Ç–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
        # –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫, –Ω–æ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.
        temp_bsp = BotServicesProvider(settings=settings_obj)
        # –ù–µ –≤—ã–∑—ã–≤–∞–µ–º temp_bsp.setup_services(), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–ª—è —Ä–∞–Ω—Ç–∞–π–º–∞ –±–æ—Ç–∞.
        # ModuleLoader –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å settings –∏ –ª–æ–≥–≥–µ—Ä–æ–º.

        loader = ModuleLoader(
            settings=settings_obj, services_provider=temp_bsp
        )  # –ü–µ—Ä–µ–¥–∞–µ–º temp_bsp

        # –ò–ó–ú–ï–ù–ï–ù–û –ó–î–ï–°–¨
        if hasattr(loader, "scan_all_available_modules"):
            loader.scan_all_available_modules()
        else:
            console.print(
                "[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ú–µ—Ç–æ–¥ 'scan_all_available_modules' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ModuleLoader.[/]"
            )
            return None

        if hasattr(loader, "_load_enabled_plugin_names"):
            getattr(loader, "_load_enabled_plugin_names")()
        else:
            console.print(
                "[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ú–µ—Ç–æ–¥ '_load_enabled_plugin_names' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ModuleLoader –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ CLI.[/yellow]"
            )

        return loader
    except ImportError as e_imp:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —è–¥—Ä–∞ SDB –¥–ª—è ModuleLoader (–∏–∑ CLI): {e_imp}[/]"
        )
        return None
    except Exception as e_load:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleLoader (–∏–∑ CLI): {e_load}[/]"
        )
        console.print_exception(show_locals=False)  # –î–æ–±–∞–≤–∏–º –≤—ã–≤–æ–¥ —Ç—Ä–µ–π—Å–±–µ–∫–∞
        return None


def _get_module_loader_sync() -> Optional[Any]:
    try:
        return asyncio.run(_get_module_loader_instance_async())
    except Exception as e:
        # –õ–æ–≥ –æ—à–∏–±–∫–∏ —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ _get_module_loader_instance_async
        # console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ModuleLoader —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ: {e}[/]")
        return None


def _save_enabled_modules(module_names: List[str], config_path: Path) -> bool:
    try:
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
        unique_module_names = sorted(
            list(set(name.strip() for name in module_names if name.strip()))
        )
        data_to_save = {
            "active_modules": unique_module_names,
            "disabled_modules": [],
        }  # disabled_modules –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ

        config_path.parent.mkdir(parents=True, exist_ok=True)
        with open(config_path, "w", encoding="utf-8") as f:
            json.dump(data_to_save, f, indent=2, ensure_ascii=False)
        return True
    except Exception as e:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –≤ {config_path}: {e}[/]"
        )
        return False


@module_app.command(name="create", help="–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è.")
def create_module_cmd(
    name: str = typer.Argument(
        ..., help="–ò–º—è –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, '_')."
    ),
    template: str = typer.Option(
        "demo", "--template", "-t", help="–®–∞–±–ª–æ–Ω: demo (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ universal"
    ),
    enable: bool = typer.Option(
        False, "--enable/--no-enable", help="–°—Ä–∞–∑—É –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å –≤ enabled_modules.json"
    ),
    with_rbac: bool = typer.Option(
        False, "--with-rbac/--no-with-rbac", help="–í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä RBAC-–ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –¥–µ–º–æ"
    ),
    with_db: bool = typer.Option(
        False, "--with-db/--no-with-db", help="–í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä –ë–î (—Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã, –±–µ–∑ –≤—ã–∑–æ–≤–æ–≤)"
    ),
):
    """–°–æ–∑–¥–∞—ë—Ç —à–∞–±–ª–æ–Ω –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è."""
    from loguru import \
        logger  # –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å rich

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏
    if not name.isidentifier():
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ò–º—è –º–æ–¥—É–ª—è '{name}' –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ '_', –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤.[/]"
        )
        raise typer.Exit(code=1)

    module_dir = Path("Modules") / name
    if module_dir.exists():
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ {module_dir}.[/]"
        )
        raise typer.Exit(code=1)

    console.print(
        Panel(
            f"[bold cyan]–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è: {name}[/]", expand=False, border_style="cyan"
        )
    )
    try:
        # –í–µ—Ç–∫–∞: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω (–∫–æ–ø–∏—è –∏–∑ UNIVERSAL_MODULE_TEMPLATE)
        if template.lower() == "universal":
            template_dir = Path("Modules") / "UNIVERSAL_MODULE_TEMPLATE"
            if not template_dir.exists():
                console.print(f"[bold red]–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: {template_dir}[/]")
                raise typer.Exit(code=1)

            import shutil as _shutil
            _shutil.copytree(template_dir, module_dir)

            # –û–±–Ω–æ–≤–∏–º manifest.yaml (name/display_name)
            try:
                import yaml as _yaml
                manifest_path = module_dir / "manifest.yaml"
                if manifest_path.exists():
                    data = _yaml.safe_load(manifest_path.read_text(encoding="utf-8")) or {}
                    data["name"] = name
                    data["display_name"] = name.replace('_', ' ').title()
                    manifest_path.write_text(
                        _yaml.safe_dump(data, allow_unicode=True, sort_keys=False),
                        encoding="utf-8",
                    )
            except Exception:
                pass

            console.print(f"[green]–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –≤: {module_dir}[/]")
        else:
            # –í–µ—Ç–∫–∞: –ª–µ–≥–∫–∏–π DEMO-—à–∞–±–ª–æ–Ω
            module_dir.mkdir(parents=True)

        # –°–æ–∑–¥–∞—ë–º manifest.yaml
        manifest_content = f"""\
name: "{name}"
display_name: "{name.replace('_', ' ').title()}"
version: "1.0.0"
description: "–ú–æ–¥—É–ª—å {name.replace('_', ' ').title()} –¥–ª—è SwiftDevBot"
author: "SwiftDevBot Team"

python_requirements: []
sdb_module_dependencies: []

model_definitions: []

commands:
  - command: "{name}"
    description: "{name.replace('_', ' ').title()}"
    icon: "üîß"
    category: "–û–±—â–∏–µ"
    admin_only: false

permissions:
  - name: "{name}.view"
    description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"
  - name: "{name}.use"
    description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"
  - name: "{name}.admin"
    description: "[–ê–î–ú–ò–ù] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—é {name.replace('_', ' ').title()}"
"""
        (module_dir / "manifest.yaml").write_text(manifest_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'manifest.yaml'}[/]")

        # –°–æ–∑–¥–∞—ë–º __init__.py
        init_content = f'''\
"""
–ú–æ–¥—É–ª—å {name.replace('_', ' ').title()} –¥–ª—è SwiftDevBot

–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è.
"""

from aiogram import Router, Dispatcher, Bot
from Systems.core.services_provider import BotServicesProvider
from .handlers import router as {name}_router

router = Router(name="{name}")
router.include_router({name}_router)


async def setup_module(dp: Dispatcher, bot: Bot, services: BotServicesProvider):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª—è"""
    dp.include_router(router)
    
    services.ui_registry.register_module_entry(
        module_name="{name}",
        display_name="{name.replace('_', ' ').title()}",
        entry_callback_data="module_{name}",
        description="–ú–æ–¥—É–ª—å {name.replace('_', ' ').title()}",
        icon="üîß",
        required_permission_to_view="{name}.view",
    )


__version__ = "1.0.0"
__author__ = "SwiftDevBot Team"
'''
        (module_dir / "__init__.py").write_text(init_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / '__init__.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º handlers.py (–¥–µ–º–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–µ–∑ RBAC –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        if template.lower() == "demo":
            # DEMO: –±–µ–∑ RBAC, —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –∏ callback'–∞–º–∏
            handlers_content = f'''\
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext

from Systems.core.services_provider import BotServicesProvider
from .keyboards import main_{name}_keyboard
from .callback_data import {name.title().replace('_', '')}CB

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –º–æ–¥—É–ª—è
router = Router(name="{name}")

@router.message(Command("{name}"))
async def cmd_{name}(message: Message, services: BotServicesProvider):
    """–ö–æ–º–∞–Ω–¥–∞ /{name} - –≥–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –º–æ–¥—É–ª—è"""
    await message.answer(
        f"üîß <b>{name.replace('_', ' ').title()}</b>\\n\\n"
        f"–≠—Ç–æ –¥–µ–º–æ –∫–æ–º–∞–Ω–¥—ã. –ù–∏–∂–µ ‚Äî –ø—Ä–∏–º–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:",
        parse_mode="HTML",
        reply_markup=main_{name}_keyboard(),
    )


@router.callback_query({name.title().replace('_', '')}CB.filter(F.action == "function1"))
async def on_function1(cb: CallbackQuery):
    await cb.message.answer("‚úÖ –§—É–Ω–∫—Ü–∏—è 1 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
    await cb.answer()


@router.callback_query({name.title().replace('_', '')}CB.filter(F.action == "function2"))
async def on_function2(cb: CallbackQuery):
    await cb.message.answer("‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è 2: –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞")
    await cb.answer()


@router.callback_query({name.title().replace('_', '')}CB.filter(F.action == "close"))
async def on_close(cb: CallbackQuery):
    try:
        await cb.message.delete()
    except Exception:
        # –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ —É–±–µ—Ä—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        await cb.message.edit_reply_markup(reply_markup=None)
    await cb.answer()


# –≠–∫—Å–ø–æ—Ä—Ç —Ä–æ—É—Ç–µ—Ä–∞
__all__ = ["router"]
'''
        else:
            # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–≤–æ–∏ handlers; –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
            handlers_content = None
        if handlers_content is not None:
            (module_dir / "handlers.py").write_text(handlers_content, encoding="utf-8")
            console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'handlers.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º models.py
        models_content = f'''\
"""
–ú–æ–¥–µ–ª–∏ –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from datetime import datetime
from typing import Optional, List
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship, Mapped, mapped_column
from Systems.core.database.base import Base


# –ü—Ä–∏–º–µ—Ä –º–æ–¥–µ–ª–∏ - —É–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
class {name.title().replace('_', '')}Item(Base):
    """–ü—Ä–∏–º–µ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"""
    __tablename__ = "{name}_items"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # –°–≤—è–∑–∏
    user_id: Mapped[int] = mapped_column(Integer, ForeignKey("users.id"), nullable=False)
    
    def __repr__(self):
        return f"<{name.title().replace('_', '')}Item(id={{self.id}}, name='{{self.name}}', user_id={{self.user_id}})>"
'''
        (module_dir / "models.py").write_text(models_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'models.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º keyboards.py (–¥–ª—è demo)
        if template.lower() == "demo":
            keyboards_content = f'''\
"""
–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from typing import Optional, List
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

from .callback_data import {name.title().replace('_', '')}CB


def main_{name}_keyboard() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"""
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="üîß –§—É–Ω–∫—Ü–∏—è 1",
            callback_data={name.title().replace('_', '')}CB(action="function1").pack()
        ),
        InlineKeyboardButton(
            text="‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è 2", 
            callback_data={name.title().replace('_', '')}CB(action="function2").pack()
        )
    )
    
    builder.row(
        InlineKeyboardButton(
            text="‚ùå –ó–∞–∫—Ä—ã—Ç—å",
            callback_data={name.title().replace('_', '')}CB(action="close").pack()
        )
    )
    
    return builder.as_markup()


def confirmation_keyboard(item_id: int) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è"""
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(
            text="‚úÖ –î–∞",
            callback_data={name.title().replace('_', '')}CB(action="confirm", item_id=item_id).pack()
        ),
        InlineKeyboardButton(
            text="‚ùå –ù–µ—Ç",
            callback_data={name.title().replace('_', '')}CB(action="cancel").pack()
        )
    )
    
    return builder.as_markup()
'''
            (module_dir / "keyboards.py").write_text(keyboards_content, encoding="utf-8")
            console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'keyboards.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º callback_data.py (–¥–ª—è demo)
        if template.lower() == "demo":
            callback_data_content = f'''\
"""
Callback Data —Ñ–∞–±—Ä–∏–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from typing import Optional
from aiogram.filters.callback_data import CallbackData


class {name.title().replace('_', '')}CB(CallbackData, prefix="{name}_cb"):
    """Callback –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"""
    action: str
    item_id: Optional[int] = None


class {name.title().replace('_', '')}ActionCB(CallbackData, prefix="{name}_action"):
    """Callback –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}"""
    action: str
    data: Optional[str] = None
'''
            (module_dir / "callback_data.py").write_text(
                callback_data_content, encoding="utf-8"
            )
            console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'callback_data.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º states.py (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞ –∫–∞–∫ –ø—Ä–∏–º–µ—Ä)
        states_content = f'''\
"""
FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from aiogram.fsm.state import State, StatesGroup


class {name.title().replace('_', '')}States(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥—É–ª–µ–º {name.replace('_', ' ').title()}"""
    waiting_for_input = State()
    waiting_for_confirmation = State()
    processing = State()


class {name.title().replace('_', '')}CreationStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
    waiting_for_name = State()
    waiting_for_description = State()
    confirm_creation = State()


class {name.title().replace('_', '')}EditStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
    waiting_for_new_name = State()
    waiting_for_new_description = State()
    confirm_edit = State()
'''
        (module_dir / "states.py").write_text(states_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'states.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º services.py (–ø—Ä–∏–º–µ—Ä –ë–î –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–µ–º–æ-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö)
        services_content = f'''\
"""
–°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥—É–ª–µ–º {name.replace('_', ' ').title()}
"""
from typing import List, Optional
from sqlalchemy import select, and_
from sqlalchemy.orm import selectinload

from Systems.core.database.manager import DBManager
from Systems.core.users.service import UserService
from .models import {name.title().replace('_', '')}Item


class {name.title().replace('_', '')}Service:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥—É–ª–µ–º {name.replace('_', ' ').title()}"""
    
    def __init__(self, db_manager: DBManager, user_service: UserService):
        self.db_manager = db_manager
        self.user_service = user_service
    
    async def create_item(
        self,
        user_id: int,
        name: str,
        description: Optional[str] = None
    ) -> {name.title().replace('_', '')}Item:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç"""
        async with self.db_manager.get_async_session() as session:
            item = {name.title().replace('_', '')}Item(
                name=name,
                description=description,
                user_id=user_id
            )
            
            session.add(item)
            await session.commit()
            await session.refresh(item)
            
            return item
    
    async def get_user_items(self, user_id: int) -> List[{name.title().replace('_', '')}Item]:
        """–ü–æ–ª—É—á–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        async with self.db_manager.get_async_session() as session:
            query = select({name.title().replace('_', '')}Item).where(
                {name.title().replace('_', '')}Item.user_id == user_id
            ).order_by({name.title().replace('_', '')}Item.created_at.desc())
            
            result = await session.execute(query)
            return list(result.scalars().all())
    
    async def get_item_by_id(self, item_id: int, user_id: int) -> Optional[{name.title().replace('_', '')}Item]:
        """–ü–æ–ª—É—á–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ ID —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        async with self.db_manager.get_async_session() as session:
            query = select({name.title().replace('_', '')}Item).where(
                and_(
                    {name.title().replace('_', '')}Item.id == item_id,
                    {name.title().replace('_', '')}Item.user_id == user_id
                )
            )
            
            result = await session.execute(query)
            return result.scalar_one_or_none()
    
    async def update_item(
        self,
        item_id: int,
        user_id: int,
        name: Optional[str] = None,
        description: Optional[str] = None
    ) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç"""
        async with self.db_manager.get_async_session() as session:
            query = select({name.title().replace('_', '')}Item).where(
                and_(
                    {name.title().replace('_', '')}Item.id == item_id,
                    {name.title().replace('_', '')}Item.user_id == user_id
                )
            )
            result = await session.execute(query)
            item = result.scalar_one_or_none()
            
            if not item:
                return False
            
            if name is not None:
                item.name = name
            if description is not None:
                item.description = description
            
            await session.commit()
            return True
    
    async def delete_item(self, item_id: int, user_id: int) -> bool:
        """–£–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç"""
        async with self.db_manager.get_async_session() as session:
            query = select({name.title().replace('_', '')}Item).where(
                and_(
                    {name.title().replace('_', '')}Item.id == item_id,
                    {name.title().replace('_', '')}Item.user_id == user_id
                )
            )
            result = await session.execute(query)
            item = result.scalar_one_or_none()
            
            if not item:
                return False
            
            await session.delete(item)
            await session.commit()
            return True
'''
        (module_dir / "services.py").write_text(services_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'services.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º utils.py
        utils_content = f'''\
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –º–æ–¥—É–ª—è {name.replace('_', ' ').title()}
"""
from datetime import datetime
from typing import Any, Dict, Optional

from .models import {name.title().replace('_', '')}Item


def format_item_info(item: {name.title().replace('_', '')}Item) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ"""
    lines = [
        f"üîß <b>–≠–ª–µ–º–µ–Ω—Ç #{{item.id}}</b>",
        "",
        f"üìù <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {{item.name}}",
    ]
    
    if item.description:
        lines.append(f"üìÑ <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {{item.description}}")
    
    lines.extend([
        f"üìÖ <b>–°–æ–∑–¥–∞–Ω:</b> {{item.created_at.strftime('%d.%m.%Y %H:%M')}}",
        f"üîÑ <b>–û–±–Ω–æ–≤–ª–µ–Ω:</b> {{item.updated_at.strftime('%d.%m.%Y %H:%M')}}"
    ])
    
    return "\\n".join(lines)


def format_items_list(items: list[{name.title().replace('_', '')}Item]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
    if not items:
        return "üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤."
    
    lines = [f"üìù <b>–í–∞—à–∏ —ç–ª–µ–º–µ–Ω—Ç—ã ({{len(items)}}):</b>", ""]
    
    for i, item in enumerate(items, 1):
        preview = item.description[:50] + "..." if item.description and len(item.description) > 50 else item.description or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
        lines.append(f"{{i}}. <b>{{item.name}}</b> - {{preview}}")
    
    return "\\n".join(lines)


def validate_item_name(name: str) -> tuple[bool, str]:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞"""
    if not name or not name.strip():
        return False, "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    
    if len(name) > 200:
        return False, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)"
    
    return True, ""


def validate_item_description(description: str) -> tuple[bool, str]:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞"""
    if description and len(description) > 1000:
        return False, "–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)"
    
    return True, ""


def truncate_text(text: str, max_length: int = 50) -> str:
    """–û–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã"""
    if len(text) <= max_length:
        return text
    return text[:max_length - 3] + "..."


def format_duration(start_time: datetime, end_time: Optional[datetime] = None) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏"""
    if end_time is None:
        end_time = datetime.utcnow()
    
    duration = end_time - start_time
    
    if duration.days > 0:
        return f"{{duration.days}} –¥–Ω."
    elif duration.seconds >= 3600:
        hours = duration.seconds // 3600
        return f"{{hours}} —á."
    elif duration.seconds >= 60:
        minutes = duration.seconds // 60
        return f"{{minutes}} –º–∏–Ω."
    else:
        return "< 1 –º–∏–Ω."
'''
        (module_dir / "utils.py").write_text(utils_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'utils.py'}[/]")

        # –ê–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —Ñ–ª–∞–≥—É
        if enable:
            try:
                # –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –ø—É—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–µ—à–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö/CLI
                import os as _os
                env_pdp = _os.getenv("SDB_CORE_PROJECT_DATA_PATH")
                if env_pdp:
                    enabled_path = (Path(env_pdp) / "Config" / "enabled_modules.json").resolve()
                else:
                    from Systems.core.app_settings import load_app_settings as _load_settings
                    _settings = _load_settings()
                    enabled_path = Path(_settings.core.enabled_modules_config_path)
                # –ü—Ä–æ—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
                current = {"active_modules": [], "disabled_modules": []}
                try:
                    if enabled_path.exists():
                        current = json.loads(enabled_path.read_text(encoding="utf-8")) or current
                except Exception:
                    pass
                new_list = list({m for m in current.get("active_modules", [])} | {name})
                if _save_enabled_modules(new_list, enabled_path):
                    console.print(f"[green]–ú–æ–¥—É–ª—å '{name}' –¥–æ–±–∞–≤–ª–µ–Ω –≤ enabled_modules.json[/]")
                else:
                    console.print(f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å '{name}'. –í–∫–ª—é—á–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.[/]")
            except Exception as _e_auto:
                console.print(f"[yellow]–ê–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {_e_auto}[/]")

        console.print(f"[bold green]–ú–æ–¥—É–ª—å '{name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ {module_dir}![/]")
        console.print(f"[yellow]–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–º–æ:[/]")
        console.print(f"1) –í–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å (–µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–∞–ª–∏): [cyan]./sdb module enable {name}[/]")
        console.print(f"2) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç: [cyan]./sdb restart[/]")
        console.print(f"3) –í Telegram –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: /{name}")
        logger.success(f"–ú–æ–¥—É–ª—å {name} —Å–æ–∑–¥–∞–Ω –≤ {module_dir}")
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–æ–¥—É–ª—è '{name}': {e}[/]")
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª—è {name}: {e}")
        shutil.rmtree(module_dir, ignore_errors=True)
        raise typer.Exit(code=1)


@module_app.command(
    name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å."
)
def list_modules_cmd():
    loader = _get_module_loader_sync()
    if not loader:
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–≤–µ–¥–µ–Ω–æ –∏–∑ _get_module_loader_sync –∏–ª–∏ _get_module_loader_instance_async
        raise typer.Exit(code=1)

    table = Table(
        title="[bold cyan]–ú–æ–¥—É–ª–∏ SwiftDevBot[/]",
        show_header=True,
        header_style="bold magenta",
    )
    table.add_column("–ò–º—è –ú–æ–¥—É–ª—è (name)", style="dim cyan", min_width=20)
    table.add_column("–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –ò–º—è", min_width=25)
    table.add_column("–í–µ—Ä—Å–∏—è", style="yellow")
    table.add_column("–¢–∏–ø", style="blue")  # –î–æ–±–∞–≤–∏–º —Ç–∏–ø
    table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
    table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", max_width=50, overflow="fold")

    if not loader.available_modules:
        console.print(
            "[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è (–≤ Modules/ –∏–ª–∏ core/sys_modules/).[/]"
        )
        return

    sorted_modules = sorted(
        loader.available_modules.values(),
        key=lambda m_info: (m_info.is_system_module, m_info.name),
    )

    for idx, module_info in enumerate(sorted_modules):
        module_type = "–°–∏—Å—Ç–µ–º–Ω—ã–π" if module_info.is_system_module else "–ü–ª–∞–≥–∏–Ω"

        # –°—Ç–∞—Ç—É—Å –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç enabled_plugin_names
        # –°—Ç–∞—Ç—É—Å –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö - –æ–Ω–∏ "–≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏" (–Ω–æ –º–æ–≥—É—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫)
        if module_info.is_system_module:
            status_text = Text(
                "–ê–∫—Ç–∏–≤–µ–Ω (—Å–∏—Å—Ç–µ–º–Ω—ã–π)", style="green"
            )  # –∏–ª–∏ "–ó–∞–≥—Ä—É–∂–µ–Ω", –µ—Å–ª–∏ –µ—Å—Ç—å is_loaded_successfully
            if module_info.is_loaded_successfully:
                status_text = Text("–ó–∞–≥—Ä—É–∂–µ–Ω ‚úÖ (—Å–∏—Å—Ç.)", style="green")
            elif module_info.error:
                status_text = Text(f"–û—à–∏–±–∫–∞ ‚ö†Ô∏è (—Å–∏—Å—Ç.)", style="red")

        else:  # –≠—Ç–æ –ø–ª–∞–≥–∏–Ω
            status_text = (
                Text("–ê–∫—Ç–∏–≤–µ–Ω ‚úÖ", style="green")
                if module_info.name in loader.enabled_plugin_names
                else Text("–ù–µ–∞–∫—Ç–∏–≤–µ–Ω ‚ùå", style="red")
            )
            if (
                module_info.name in loader.enabled_plugin_names
                and module_info.is_loaded_successfully
            ):
                status_text = Text("–ó–∞–≥—Ä—É–∂–µ–Ω ‚úÖ", style="green")
            elif module_info.name in loader.enabled_plugin_names and module_info.error:
                status_text = Text(f"–û—à–∏–±–∫–∞ ‚ö†Ô∏è", style="red")

        version_str = module_info.manifest.version if module_info.manifest else "[N/A]"
        display_name_str = (
            module_info.manifest.display_name
            if module_info.manifest
            else module_info.name
        )  # fallback –Ω–∞ –∏–º—è –ø–∞–ø–∫–∏
        description_str = (
            module_info.manifest.description
            if module_info.manifest and module_info.manifest.description
            else "-"
        )

        table.add_row(
            module_info.name,
            display_name_str,
            version_str,
            module_type,
            status_text,
            description_str,
        )
        # –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)
        if idx < len(sorted_modules) - 1:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏–∑ box.SIMPLE
            # box.SIMPLE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "‚îÄ" –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π
            separator_char = "‚îÄ"
            table.add_row(
                separator_char * 20,
                separator_char * 25,
                separator_char * 8,
                separator_char * 8,
                separator_char * 12,
                separator_char * 50,
                style="dim",
            )
    console.print(table)


@module_app.command(
    name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª–µ (–∏–∑ manifest)."
)
def info_module_cmd(
    module_name: str = typer.Argument(
        ..., help="–ò–º—è –º–æ–¥—É–ª—è (–∏–∑ manifest.name –∏–ª–∏ –∏–º—è –ø–∞–ø–∫–∏)."
    )
):
    loader = _get_module_loader_sync()
    if not loader:
        raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)

    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        raise typer.Exit(code=1)

    if not module_info.manifest:
        console.print(
            f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–∏–ª–∏ –æ–Ω –Ω–µ –±—ã–ª —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω).[/yellow]"
        )
        console.print(f"  –ü—É—Ç—å –∫ –º–æ–¥—É–ª—é: {module_info.path}")
        console.print(
            f"  –¢–∏–ø: {'–°–∏—Å—Ç–µ–º–Ω—ã–π' if module_info.is_system_module else '–ü–ª–∞–≥–∏–Ω'}"
        )
        if module_info.error:
            console.print(
                f"  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: {module_info.error}"
            )
        raise typer.Exit(code=1)

    display_name_header = module_info.manifest.display_name or module_info.name
    console.print(
        Panel(
            f"[bold cyan]–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ: {display_name_header} ({module_name})[/]",
            expand=False,
            border_style="cyan",
        )
    )

    try:
        import yaml

        manifest_str = yaml.dump(
            module_info.manifest.model_dump(mode="json"),
            indent=2,
            allow_unicode=True,
            sort_keys=False,
        )
        syntax = Syntax(
            manifest_str,
            "yaml",
            theme="fruity",
            line_numbers=True,
            background_color="default",
        )
    except ImportError:
        manifest_str = json.dumps(
            module_info.manifest.model_dump(mode="json"), indent=2, ensure_ascii=False
        )
        syntax = Syntax(
            manifest_str,
            "json",
            theme="fruity",
            line_numbers=True,
            background_color="default",
        )
    except Exception as e_dump:
        console.print(
            f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∫—Ä–∞—Å–∏–≤–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç: {e_dump}. –í—ã–≤–æ–¥ –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å:[/]"
        )
        console.print(module_info.manifest.model_dump())
        raise typer.Exit(code=1)
    console.print(syntax)


@module_app.command(
    name="enable", help="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω (–¥–æ–±–∞–≤–∏—Ç—å –≤ enabled_modules.json)."
)
def enable_module_cmd(
    module_name: str = typer.Argument(..., help="–ò–º—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
):
    loader = _get_module_loader_sync()
    if not loader:
        raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è.[/]"
        )
        console.print(
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–ª–∞–≥–∏–Ω—ã): {[m.name for m in loader.available_modules.values() if not m.is_system_module]}"
        )
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ ('{module_name}') –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ enable/disable. –û–Ω–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —è–¥—Ä–æ–º.[/]"
        )
        raise typer.Exit(code=1)

    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path

    if module_name in loader.enabled_plugin_names:
        console.print(f"[yellow]–ü–ª–∞–≥–∏–Ω '{module_name}' —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.[/]")
        return

    new_enabled_list = loader.enabled_plugin_names + [module_name]
    if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
        console.print(f"[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω![/]")
        console.print(
            f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (`./sdb.py restart`)."
        )
    else:
        console.print(
            f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ '{enabled_modules_file_path}'.[/]"
        )
        raise typer.Exit(code=1)


@module_app.command(
    name="disable", help="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω (—É–¥–∞–ª–∏—Ç—å –∏–∑ enabled_modules.json)."
)
def disable_module_cmd(
    module_name: str = typer.Argument(..., help="–ò–º—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
):
    loader = _get_module_loader_sync()
    if not loader:
        raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ ('{module_name}') –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ enable/disable.[/]"
        )
        raise typer.Exit(code=1)

    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path

    if module_name not in loader.enabled_plugin_names:
        console.print(f"[yellow]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω.[/]")
        return

    new_enabled_list = [m for m in loader.enabled_plugin_names if m != module_name]
    if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
        console.print(f"[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω![/]")
        console.print(
            f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (`./sdb.py restart`)."
        )
    else:
        console.print(
            f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ '{enabled_modules_file_path}'.[/]"
        )
        raise typer.Exit(code=1)


async def _clean_tables_module_async_internal(
    module_name: str, loader: Any, called_from_uninstall: bool = False
) -> bool:
    if not called_from_uninstall:
        console.print(
            Panel(
                f"[bold red]–£–î–ê–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶ –ú–û–î–£–õ–Ø: {module_name}[/]",
                expand=False,
                border_style="red",
            )
        )

    module_info = loader.get_module_info(module_name)
    if not module_info:  # –ú–∞–Ω–∏—Ñ–µ—Å—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º–æ–¥—É–ª—è
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        return False

    if not module_info.manifest:
        console.print(
            f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.[/yellow]"
        )
        return True  # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å

    model_definitions_paths = module_info.manifest.model_definitions
    if not model_definitions_paths:
        console.print(
            f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ ('model_definitions'). –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.[/]"
        )
        return True

    if not called_from_uninstall:
        console.print(
            f"–ú–æ–¥—É–ª—å '{module_name}' –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—É—Ç–∏ –∫ –º–æ–¥–µ–ª—è–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü:"
        )
        for path_str in model_definitions_paths:
            console.print(f"  - {path_str}")
        if not confirm_action(
            f"–í—ã –ê–ë–°–û–õ–Æ–¢–ù–û —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π –º–æ–¥—É–ª—è '{module_name}'? –≠—Ç–æ [bold red]–ù–ï–û–ë–†–ê–¢–ò–ú–û[/]!",
            default_choice=False,
            abort_on_false=True,
        ):
            return False

    models_to_drop: List[Type[SDBBaseAlchemyModel]] = []
    failed_imports: List[str] = []
    console.print(f"\n–ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–æ–≤ –º–æ–¥–µ–ª–µ–π –¥–ª—è '{module_name}'...")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–æ–¥—É–ª—è
    # –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ model_definitions –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ (—Ö–æ—Ç—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–µ)
    # –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø–æ–∫–∞ –æ–∂–∏–¥–∞–µ–º –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ —Ç–∏–ø–∞ "Modules.my_plugin.models.MyTable"
    # –∏–ª–∏ "core.sys_modules.my_sys_mod.models.SysTable"

    for import_path_str in model_definitions_paths:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ—á–∫–∞ –≤ –ø—É—Ç–∏, –∏–Ω–∞—á–µ —ç—Ç–æ –Ω–µ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
            if "." not in import_path_str:
                failed_imports.append(import_path_str)
                console.print(
                    f"  [yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:[/yellow] '{import_path_str}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø—É—Ç–µ–º –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ Python-–º–æ–¥–µ–ª–∏."
                )
                continue

            module_path_part, class_name = import_path_str.rsplit(".", 1)
            imported_py_module = importlib.import_module(module_path_part)
            model_class_obj = getattr(
                imported_py_module, class_name
            )  # –ü–æ–ª—É—á–∞–µ–º —Å–∞–º –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫–ª–∞—Å—Å –∏ –æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç SDBBaseAlchemyModel
            if (
                isinstance(model_class_obj, type)
                and issubclass(model_class_obj, SDBBaseAlchemyModel)
                and hasattr(model_class_obj, "__table__")
            ):
                models_to_drop.append(
                    model_class_obj
                )  # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, –∞ –Ω–µ —ç–∫–∑–µ–º–ø–ª—è—Ä
                console.print(
                    f"  [green]–£—Å–ø–µ—Ö:[/green] {import_path_str} (—Ç–∞–±–ª–∏—Ü–∞: {model_class_obj.__tablename__})"
                )
            else:
                failed_imports.append(import_path_str)
                console.print(
                    f"  [yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:[/yellow] '{import_path_str}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –º–æ–¥–µ–ª—å—é SQLAlchemy, –Ω–∞—Å–ª–µ–¥—É–µ–º–æ–π –æ—Ç SDBBaseModel."
                )
        except Exception as e_import:
            failed_imports.append(import_path_str)
            console.print(
                f"  [red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è '{import_path_str}':[/red] {type(e_import).__name__} - {e_import}"
            )

    if failed_imports:
        console.print(
            f"\n[bold yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å {len(failed_imports)} –∏–∑ {len(model_definitions_paths)} –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è '{module_name}'.[/]"
        )
        if not models_to_drop:  # –ï—Å–ª–∏ –í–û–û–ë–©–ï –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            console.print(
                "[bold red]–ù–µ—Ç —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π. –û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –ø—Ä–µ—Ä–≤–∞–Ω–∞.[/]"
            )
            return False
        # –ï—Å–ª–∏ —á–∞—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å, –∞ —á–∞—Å—Ç—å –Ω–µ—Ç - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ª–∏ —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å
        if not called_from_uninstall and not confirm_action(
            f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è {len(models_to_drop)} —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π?",
            default_choice=False,
            abort_on_false=True,
        ):
            return False
        elif (
            called_from_uninstall
        ):  # –ï—Å–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏, —Ç–æ –ª—É—á—à–µ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
            console.print(
                "[bold yellow]–ò–∑-–∑–∞ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. "
                "–£–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.[/]"
            )
            return False  # –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, —á—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ –ø–æ–ª–Ω—ã–º/—É—Å–ø–µ—à–Ω—ã–º

    if not models_to_drop:  # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        console.print(
            f"[bold yellow]–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –¥–ª—è –º–æ–¥—É–ª—è '{module_name}'.[/]"
        )
        return True  # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—á–µ–≥–æ –±—ã–ª–æ —É–¥–∞–ª—è—Ç—å

    if (
        not called_from_uninstall
    ):  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å uninstall
        console.print(
            "\n[bold blue]–°–ª–µ–¥—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã SQLAlchemy –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ë–î:[/]"
        )
        for model_cls_to_drop in models_to_drop:
            console.print(f"  - [cyan]{model_cls_to_drop.__tablename__}[/cyan]")
        if not confirm_action(
            f"–ü–û–°–õ–ï–î–ù–ï–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï: –£–¥–∞–ª–∏—Ç—å {len(models_to_drop)} —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}'?",
            default_choice=False,
            abort_on_false=True,
        ):
            return False

    settings_obj, db_m, _ = await get_sdb_services_for_cli(init_db=True)
    if not (settings_obj and db_m):
        console.print(
            "[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DBManager –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü.[/]"
        )
        return False
    try:
        console.print(f"\n[magenta]–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}'...[/magenta]")
        await db_m.drop_specific_module_tables(
            models_to_drop
        )  # –ü–µ—Ä–µ–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –ö–õ–ê–°–°–û–í –º–æ–¥–µ–ª–µ–π
        console.print(f"[bold green]–¢–∞–±–ª–∏—Ü—ã –¥–ª—è '{module_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.[/]")
        if not called_from_uninstall:
            console.print(
                "[yellow]–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Alembic –Ω–µ –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º —É–¥–∞–ª–µ–Ω–∏–∏. "
                "–ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –≤ –±—É–¥—É—â–µ–º, "
                "–≤–∞–º –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–≤–∏–∑–∏—é –∏–ª–∏ '–∑–∞—à—Ç–∞–º–ø–æ–≤–∞—Ç—å' —Å–æ—Å—Ç–æ—è–Ω–∏–µ Alembic.[/yellow]"
            )
        return True
    except Exception as e_drop:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}': {e_drop}[/]"
        )
        return False
    finally:
        if db_m:
            await db_m.dispose()


@module_app.command(
    name="clean-tables",
    help="[–û–ü–ê–°–ù–û] –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –∏–∑ –ë–î (—Å–æ–≥–ª–∞—Å–Ω–æ manifest).",
)
def clean_tables_module_cmd_wrapper(
    module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è, —á—å–∏ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–∏—Ç—å.")
):
    try:
        loader = asyncio.run(_get_module_loader_instance_async())
        if not loader:
            raise typer.Exit(code=1)
        if not asyncio.run(
            _clean_tables_module_async_internal(module_name=module_name, loader=loader)
        ):
            raise typer.Exit(code=1)
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤ 'module clean-tables': {e}[/]")
        raise typer.Exit(code=1)


@module_app.command(
    name="uninstall", help="[–û–ü–ê–°–ù–û] –£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å (—Ñ–∞–π–ª—ã –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ–≥–æ –¥–∞–Ω–Ω—ã–µ)."
)
def uninstall_module_cmd_wrapper(
    module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è."),
    remove_data: bool = typer.Option(
        False,
        "--remove-data/--keep-data",
        help="–£–¥–∞–ª–∏—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è (—Ç–∞–±–ª–∏—Ü—ã –ë–î). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ê–ù–ù–´–ï –°–û–•–†–ê–ù–Ø–Æ–¢–°–Ø.",
    ),
):
    try:
        asyncio.run(
            _uninstall_module_async(module_name=module_name, remove_data=remove_data)
        )
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module uninstall': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _uninstall_module_async(module_name: str, remove_data: bool):
    console.print(
        Panel(
            f"[bold red]–£–î–ê–õ–ï–ù–ò–ï –ú–û–î–£–õ–Ø: {module_name}[/]",
            expand=False,
            border_style="red",
        )
    )

    loader = await _get_module_loader_instance_async()
    if not loader:
        raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.[/]"
        )
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å ('{module_name}') –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.[/]"
        )
        raise typer.Exit(code=1)

    console.print(
        f"–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: [cyan]{module_info.path}[/]"
    )
    if not confirm_action(
        f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –§–ê–ô–õ–´ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'?",
        default_choice=False,
        abort_on_false=True,
    ):
        return

    data_cleaned_successfully = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    if remove_data:
        console.print(f"\n–ó–∞–ø—Ä–æ—à–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'.")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ —É–¥–∞–ª—è—Ç—å (–¥–µ–∫–ª–∞—Ä–∏—Ä–æ–≤–∞–Ω—ã –ª–∏ –º–æ–¥–µ–ª–∏)
        if module_info.manifest and module_info.manifest.model_definitions:
            if confirm_action(
                f"–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ [bold red]–ü–û–¢–ï–†–ï –í–°–ï–• –ï–ì–û –¢–ê–ë–õ–ò–¶ –í –ë–î[/]. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
                default_choice=False,
                abort_on_false=True,
            ):
                data_cleaned_successfully = await _clean_tables_module_async_internal(
                    module_name, loader, called_from_uninstall=True
                )
                if not data_cleaned_successfully:
                    console.print(
                        f"[bold red]–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'.[/]"
                    )
                    if not confirm_action(
                        "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö?",
                        default_choice=False,
                        abort_on_false=True,
                    ):
                        console.print(
                            "[bold yellow]–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–µ–Ω–æ.[/bold yellow]"
                        )
                        raise typer.Exit(code=1)
            else:  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è —É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ
                data_cleaned_successfully = (
                    False  # –î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª–µ–Ω—ã –ø–æ —Ä–µ—à–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                )
                console.print(
                    "[yellow]–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–º–µ–Ω–µ–Ω–æ. –§–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞ –≤—Å–µ –µ—â–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã (–µ—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ).[/yellow]"
                )
        else:  # –ù–µ—Ç –º–æ–¥–µ–ª–µ–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
            console.print(
                f"[dim]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ. –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.[/dim]"
            )
            # data_cleaned_successfully –æ—Å—Ç–∞–µ—Ç—Å—è True
    else:
        console.print(
            f"\n[yellow]–î–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (—Ç–∞–±–ª–∏—Ü—ã –ë–î) –Ω–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã (–æ–ø—Ü–∏—è --keep-data).[/yellow]"
        )
        data_cleaned_successfully = False  # –î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å

    console.print(
        f"\n–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ enabled_modules.json)..."
    )
    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path
    if module_name in loader.enabled_plugin_names:
        new_enabled_list = [m for m in loader.enabled_plugin_names if m != module_name]
        if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
            console.print(f"[green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.[/]")
        else:
            console.print(
                f"[bold red]–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å enabled_modules.json).[/]"
            )
            if not confirm_action(
                "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏?",
                default_choice=False,
                abort_on_false=True,
            ):
                console.print(
                    "[bold yellow]–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–µ–Ω–æ.[/bold yellow]"
                )
                raise typer.Exit(code=1)
    else:
        console.print(f"[dim]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω.[/dim]")

    module_dir_path = module_info.path
    console.print(f"\n–£–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–ª–∞–≥–∏–Ω–∞: [cyan]{module_dir_path}[/]")
    if not confirm_action(
        f"[bold red]–ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –£–¥–∞–ª–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é '{module_dir_path}'? –≠—Ç–æ –ù–ï–û–ë–†–ê–¢–ò–ú–û.[/bold red]",
        default_choice=False,
        abort_on_false=True,
    ):
        return

    try:
        shutil.rmtree(module_dir_path)
        console.print(
            f"[bold green]–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø–ª–∞–≥–∏–Ω–∞ '{module_dir_path}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.[/]"
        )
    except Exception as e_rmtree:
        console.print(
            f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ '{module_dir_path}': {e_rmtree}[/]"
        )
        raise typer.Exit(code=1)

    console.print(f"\n[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.[/]")
    if (
        remove_data and not data_cleaned_successfully
    ):  # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –æ–Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å
        console.print(
            "[bold yellow]–û–¥–Ω–∞–∫–æ, –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ (—Ç–∞–±–ª–∏—Ü) –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/bold yellow]"
        )
    elif not remove_data:  # –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        console.print("[dim](–î–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å).[/dim]")
    console.print("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É.")


@module_app.command(
    name="list-available", help="–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥—É–ª–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ –ª–æ–∫–∞–ª—å–Ω–æ."
)
def list_available_modules_cmd(
    local_only: bool = typer.Option(
        False, "--local-only", help="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏"
    ),
    show_details: bool = typer.Option(
        False, "--details", "-d", help="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö"
    ),
    format: str = typer.Option(
        "table", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: table, json, yaml"
    ),
):
    try:
        asyncio.run(_list_available_modules_async(local_only, show_details, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module list-available': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _list_available_modules_async(
    local_only: bool, show_details: bool, format: str
):
    """–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏"""
    console.print(
        Panel(
            "[bold blue]–ü–û–ò–°–ö –î–û–°–¢–£–ü–ù–´–• –ú–û–î–£–õ–ï–ô[/]", expand=False, border_style="blue"
        )
    )

    loader = await _get_module_loader_instance_async()
    if not loader:
        raise typer.Exit(code=1)

    # –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
    local_modules = loader.get_all_modules_info()

    if local_only:
        console.print("[yellow]–ü–æ–∫–∞–∑—ã–≤–∞—é —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏...[/]")
        await _display_modules(local_modules, "–õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏", show_details, format)
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
    console.print("[cyan]–õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏:[/]")
    await _display_modules(local_modules, "–õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏", show_details, format)

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
    console.print("\n[cyan]–ú–æ–¥—É–ª–∏ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:[/]")

    # –ü–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
    repo_modules = [
        {
            "name": "example-module",
            "version": "1.0.0",
            "description": "–ü—Ä–∏–º–µ—Ä –º–æ–¥—É–ª—è –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è",
        },
        {"name": "test-plugin", "version": "2.1.0", "description": "–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω"},
    ]

    if repo_modules:
        for module in repo_modules:
            console.print(
                f"  üì¶ {module['name']} v{module['version']} - {module['description']}"
            )
    else:
        console.print("[dim]–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.[/]")

    console.print(
        "[dim]–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º.[/]"
    )

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    enabled_count = sum(1 for m in local_modules if m.is_enabled)
    total_count = len(local_modules)

    console.print(f"\n[bold green]–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/]")
    console.print(f"  üì¶ –í—Å–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: {total_count}")
    console.print(f"  ‚úÖ –í–∫–ª—é—á–µ–Ω–æ: {enabled_count}")
    console.print(f"  ‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ: {total_count - enabled_count}")


async def _display_modules(
    modules: List[Any], title: str, show_details: bool, format: str
):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π"""
    if not modules:
        console.print(f"[dim]–ù–µ—Ç {title.lower()}[/]")
        return

    if format == "json":
        await _display_modules_json(modules, show_details)
    elif format == "yaml":
        await _display_modules_yaml(modules, show_details)
    else:
        await _display_modules_table(modules, show_details)


async def _display_modules_table(modules: List[Any], show_details: bool):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–æ–¥—É–ª–∏ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã"""
    from rich.table import Table

    table = Table(title="–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏")
    table.add_column("–ò–º—è", style="cyan", no_wrap=True)
    table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
    table.add_column("–í–µ—Ä—Å–∏—è", style="yellow")
    table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="white")

    if show_details:
        table.add_column("–ê–≤—Ç–æ—Ä", style="blue")
        table.add_column("–¢–∏–ø", style="magenta")

    for module in modules:
        status = "‚úÖ –í–∫–ª—é—á–µ–Ω" if module.is_enabled else "‚ùå –û—Ç–∫–ª—é—á–µ–Ω"
        if module.error:
            status = f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {module.error}"

        version = module.manifest.version if module.manifest else "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
        description = module.manifest.description if module.manifest else "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"

        row = [module.name, status, version, description]

        if show_details:
            author = module.manifest.author if module.manifest else "–ù–µ —É–∫–∞–∑–∞–Ω"
            module_type = "–°–∏—Å—Ç–µ–º–Ω—ã–π" if module.is_system_module else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π"
            row.extend([author, module_type])

        table.add_row(*row)

    console.print(table)


async def _display_modules_json(modules: List[Any], show_details: bool):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–æ–¥—É–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON"""
    import json

    modules_data = []
    for module in modules:
        module_data = {
            "name": module.name,
            "enabled": module.is_enabled,
            "error": module.error,
            "is_system_module": module.is_system_module,
        }

        if module.manifest:
            module_data.update(
                {
                    "version": module.manifest.version,
                    "description": module.manifest.description,
                    "author": module.manifest.author,
                    "website": module.manifest.website,
                    "email": module.manifest.email,
                    "license": module.manifest.license,
                }
            )

        modules_data.append(module_data)

    console.print(json.dumps(modules_data, indent=2, ensure_ascii=False))


async def _display_modules_yaml(modules: List[Any], show_details: bool):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–æ–¥—É–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YAML"""
    import yaml

    modules_data = []
    for module in modules:
        module_data = {
            "name": module.name,
            "enabled": module.is_enabled,
            "error": module.error,
            "is_system_module": module.is_system_module,
        }

        if module.manifest:
            module_data.update(
                {
                    "version": module.manifest.version,
                    "description": module.manifest.description,
                    "author": module.manifest.author,
                    "website": module.manifest.website,
                    "email": module.manifest.email,
                    "license": module.manifest.license,
                }
            )

        modules_data.append(module_data)

    console.print(yaml.dump(modules_data, default_flow_style=False, allow_unicode=True))


@module_app.command(
    name="install", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞."
)
def install_module_cmd(
    module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏."),
    source: str = typer.Option(
        "local", "--source", "-s", help="–ò—Å—Ç–æ—á–Ω–∏–∫ –º–æ–¥—É–ª—è: local, repo, url"
    ),
    url: Optional[str] = typer.Option(
        None, "--url", help="URL –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–¥—É–ª—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞"
    ),
):
    try:
        asyncio.run(_install_module_async(module_name, source, url))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module install': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _install_module_async(module_name: str, source: str, url: Optional[str]):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å"""
    console.print(
        Panel(
            f"[bold blue]–£–°–¢–ê–ù–û–í–ö–ê –ú–û–î–£–õ–Ø: {module_name}[/]",
            expand=False,
            border_style="blue",
        )
    )

    if source == "local":
        await _install_local_module(module_name)
    elif source == "repo":
        console.print("[cyan]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...[/]")

        # –ü–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏
        repo_modules = [
            {
                "name": "example-module",
                "version": "1.0.0",
                "description": "–ü—Ä–∏–º–µ—Ä –º–æ–¥—É–ª—è",
            },
            {
                "name": "test-plugin",
                "version": "2.1.0",
                "description": "–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω",
            },
        ]

        # –ò—â–µ–º –º–æ–¥—É–ª—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        module_found = None
        for repo_module in repo_modules:
            if repo_module["name"] == module_name:
                module_found = repo_module
                break

        if module_found:
            console.print(
                f"[green]–ù–∞–π–¥–µ–Ω –º–æ–¥—É–ª—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: {module_found['name']} v{module_found['version']}[/]"
            )
            console.print(f"[cyan]–û–ø–∏—Å–∞–Ω–∏–µ: {module_found['description']}[/]")

            if confirm_action(f"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å '{module_name}' –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è?"):
                # –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
                console.print(
                    f"[green]–ú–æ–¥—É–ª—å '{module_name}' –≥–æ—Ç–æ–≤ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è![/]"
                )
                console.print(
                    "[dim]–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.[/]"
                )
            else:
                console.print("[yellow]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/]")
        else:
            console.print(f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.[/]")
            console.print("[cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:[/]")
            for repo_module in repo_modules:
                console.print(
                    f"  üì¶ {repo_module['name']} v{repo_module['version']} - {repo_module['description']}"
                )
    elif source == "url" and url:
        await _install_module_from_url(module_name, url)
    else:
        console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL.[/]")
        raise typer.Exit(code=1)


async def _install_local_module(module_name: str):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –¥—Ä—É–≥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)"""
    console.print(f"[cyan]–ü–æ–∏—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è '{module_name}'...[/]")

    # –ü–æ–∏—Å–∫ –º–æ–¥—É–ª—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
    search_dirs = [
        Path.home() / "modules",
        Path.home() / ".local" / "modules",
        Path.cwd() / "external_modules",
        Path.cwd() / "modules_backup",
    ]

    module_found = False
    for search_dir in search_dirs:
        if search_dir.exists():
            module_path = search_dir / module_name
            if module_path.exists() and module_path.is_dir():
                console.print(f"[green]–ù–∞–π–¥–µ–Ω –º–æ–¥—É–ª—å –≤: {module_path}[/]")

                # –ö–æ–ø–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
                target_path = PROJECT_ROOT / "Modules" / module_name
                if target_path.exists():
                    if not confirm_action(
                        f"–ú–æ–¥—É–ª—å '{module_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?"
                    ):
                        console.print("[yellow]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/]")
                        return
                    import shutil

                    shutil.rmtree(target_path)

                try:
                    import shutil

                    shutil.copytree(module_path, target_path)
                    console.print(
                        f"[bold green]–ú–æ–¥—É–ª—å '{module_name}' —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω![/]"
                    )
                    module_found = True
                    break
                except Exception as e:
                    console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–¥—É–ª—è: {e}[/]")
                    return

    if not module_found:
        console.print(
            f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö.[/]"
        )
        console.print("[dim]–î–æ–±–∞–≤—å—Ç–µ –º–æ–¥—É–ª—å –≤ –æ–¥–Ω—É –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:[/]")
        for search_dir in search_dirs:
            console.print(f"  - {search_dir}")


async def _install_module_from_url(module_name: str, url: str):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ URL"""
    console.print(f"[cyan]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è '{module_name}' –∏–∑ URL: {url}[/]")

    try:
        import shutil
        import tempfile
        import zipfile

        import requests

        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        with tempfile.TemporaryDirectory() as temp_dir:
            temp_path = Path(temp_dir)

            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
            console.print("[cyan]–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è...[/]")
            response = requests.get(url, timeout=30)
            response.raise_for_status()

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            zip_path = temp_path / f"{module_name}.zip"
            with open(zip_path, "wb") as f:
                f.write(response.content)

            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤
            console.print("[cyan]–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –º–æ–¥—É–ª—è...[/]")
            with zipfile.ZipFile(zip_path, "r") as zip_ref:
                zip_ref.extractall(temp_path)

            # –ò—â–µ–º –ø–∞–ø–∫—É —Å –º–æ–¥—É–ª–µ–º
            module_dir = None
            for item in temp_path.iterdir():
                if item.is_dir() and (
                    item.name == module_name or item.name.endswith(f"-{module_name}")
                ):
                    module_dir = item
                    break

            if not module_dir:
                # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–∞–ø–∫—É —Å –∏–º–µ–Ω–µ–º –º–æ–¥—É–ª—è, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –ø–∞–ø–∫—É
                for item in temp_path.iterdir():
                    if item.is_dir():
                        module_dir = item
                        break

            if not module_dir:
                console.print(
                    "[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É —Å –º–æ–¥—É–ª–µ–º –≤ –∞—Ä—Ö–∏–≤–µ.[/]"
                )
                return

            # –ö–æ–ø–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
            target_path = PROJECT_ROOT / "Modules" / module_name
            if target_path.exists():
                if not confirm_action(
                    f"–ú–æ–¥—É–ª—å '{module_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?"
                ):
                    console.print("[yellow]–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/]")
                    return
                shutil.rmtree(target_path)

            shutil.copytree(module_dir, target_path)
            console.print(
                f"[bold green]–ú–æ–¥—É–ª—å '{module_name}' —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ URL![/]"
            )

    except requests.RequestException as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è: {e}[/]")
    except zipfile.BadZipFile:
        console.print(
            "[bold red]–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º ZIP –∞—Ä—Ö–∏–≤–æ–º.[/]"
        )
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –º–æ–¥—É–ª—è: {e}[/]")


@module_app.command(
    name="update", help="–û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞."
)
def update_module_cmd(
    module_name: str = typer.Argument(
        ..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–ª–∏ '--all'."
    ),
    force: bool = typer.Option(False, "--force", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ."),
):
    try:
        asyncio.run(_update_module_async(module_name, force))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module update': {e}[/]")
        raise typer.Exit(code=1)


async def _update_module_async(module_name: str, force: bool):
    """–û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å"""
    console.print(
        Panel(
            f"[bold blue]–û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–û–î–£–õ–Ø: {module_name}[/]",
            expand=False,
            border_style="blue",
        )
    )

    loader = await _get_module_loader_instance_async()
    if not loader:
        raise typer.Exit(code=1)

    if module_name == "--all":
        console.print("[cyan]–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π...[/]")

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
        active_modules = [m for m in loader.get_all_modules_info() if m.is_enabled]

        if not active_modules:
            console.print("[yellow]–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.[/]")
            return

        updated_count = 0
        for module in active_modules:
            try:
                if await _update_single_module(module.name, force):
                    updated_count += 1
            except Exception as e:
                console.print(
                    f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–æ–¥—É–ª—è '{module.name}': {e}[/]"
                )

        console.print(
            f"[bold green]–û–±–Ω–æ–≤–ª–µ–Ω–æ –º–æ–¥—É–ª–µ–π: {updated_count}/{len(active_modules)}[/]"
        )
        return

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è
    await _update_single_module(module_name, force)


async def _update_single_module(module_name: str, force: bool):
    """–û–±–Ω–æ–≤–∏—Ç—å –æ–¥–∏–Ω –º–æ–¥—É–ª—å"""
    console.print(f"[cyan]–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{module_name}'...[/]")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –º–æ–¥—É–ª—å
    module_path = PROJECT_ROOT / "Modules" / module_name
    if not module_path.exists():
        console.print(f"[bold red]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        return False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if not force:
        console.print("[cyan]–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –º–æ–¥—É–ª—è...[/]")

        # –ü–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –≤ –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π
        console.print(
            "[yellow]–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.[/]"
        )
        console.print("[dim]–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.[/]")
        console.print("[cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:[/]")
        console.print("  - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        console.print("  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è")
        return False

    # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –º–æ–¥—É–ª—å
    console.print(f"[cyan]–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{module_name}'...[/]")

    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ
    console.print(f"[green]–ú–æ–¥—É–ª—å '{module_name}' –≥–æ—Ç–æ–≤ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é.[/]")
    console.print("[dim]–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.[/]")

    return True


@module_app.command(name="sync-deps", help="–°–æ–±—Ä–∞—Ç—å Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π.")
def sync_deps_cmd(
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="–§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    ),
    format: str = typer.Option(
        "requirements", "--format", "-f", help="–§–æ—Ä–º–∞—Ç: requirements, pip-tools"
    ),
):
    try:
        asyncio.run(_sync_deps_async(output_file, format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(
            f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module sync-deps': {e}[/]"
        )
        raise typer.Exit(code=1)


async def _sync_deps_async(output_file: Optional[str], format: str):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π"""
    console.print(
        Panel(
            "[bold blue]–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô –ú–û–î–£–õ–ï–ô[/]",
            expand=False,
            border_style="blue",
        )
    )

    loader = await _get_module_loader_instance_async()
    if not loader:
        raise typer.Exit(code=1)

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
    active_modules = [m for m in loader.get_all_modules_info() if m.is_enabled]

    if not active_modules:
        console.print("[yellow]–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.[/]")
        return

    console.print(
        f"[cyan]–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è {len(active_modules)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π...[/]"
    )

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    all_dependencies = set()
    module_deps = {}

    for module in active_modules:
        python_deps = []
        sdb_deps = []

        if module.manifest:
            # –ü–æ–ª—É—á–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if (
                hasattr(module.manifest, "python_requirements")
                and module.manifest.python_requirements
            ):
                python_deps = module.manifest.python_requirements
            elif (
                hasattr(module.manifest, "dependencies")
                and module.manifest.dependencies
            ):
                python_deps = module.manifest.dependencies

            # –ü–æ–ª—É—á–∞–µ–º SDB –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if (
                hasattr(module.manifest, "sdb_module_dependencies")
                and module.manifest.sdb_module_dependencies
            ):
                sdb_deps = module.manifest.sdb_module_dependencies

            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            all_module_deps = python_deps + sdb_deps

            if all_module_deps:
                all_dependencies.update(all_module_deps)
                module_deps[module.name] = all_module_deps
                console.print(f"  üì¶ {module.name}: {', '.join(all_module_deps)}")
            else:
                console.print(f"  üì¶ {module.name}: –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π")
        else:
            console.print(f"  üì¶ {module.name}: –º–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if not all_dependencies:
        console.print("[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.[/]")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if format == "requirements":
        result = "\n".join(sorted(all_dependencies))
    elif format == "pip-tools":
        result = "# requirements.txt –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π\n"
        result += "\n".join(sorted(all_dependencies))
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {format}[/]")
        raise typer.Exit(code=1)

    # –í—ã–≤–æ–¥–∏–º –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if output_file:
        try:
            with open(output_file, "w", encoding="utf-8") as f:
                f.write(result)
            console.print(f"[green]–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {output_file}[/]")
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ —Ñ–∞–π–ª: {e}[/]")
            raise typer.Exit(code=1)
    else:
        console.print(f"\n[bold green]–°–æ–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:[/]")
        console.print(result)

    console.print(f"\n[cyan]–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/]")
    console.print(f"  üì¶ –ú–æ–¥—É–ª–µ–π —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏: {len(module_deps)}")
    console.print(f"  üìã –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: {len(all_dependencies)}")


if __name__ == "__main__":
    module_app()



======================================================================

------------------------------ FILE: Systems/cli/dev.py ------------------------------
# cli/dev.py
import asyncio
import json
import os
import shutil
import subprocess
import sys
import tempfile
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

console = Console()
dev_app = typer.Typer(name="dev", help="üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è dev –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
DEV_DIR = Path("Data/dev")
DEV_CONFIG_FILE = DEV_DIR / "dev_config.json"
DEV_LOGS_DIR = DEV_DIR / "logs"
DEV_DOCS_DIR = DEV_DIR / "docs"


def _ensure_dev_directory():
    """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è dev –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    DEV_DIR.mkdir(parents=True, exist_ok=True)
    DEV_LOGS_DIR.mkdir(parents=True, exist_ok=True)
    DEV_DOCS_DIR.mkdir(parents=True, exist_ok=True)

    if not DEV_CONFIG_FILE.exists():
        default_config = {
            "linting": {
                "tools": ["flake8", "black", "isort", "mypy"],
                "config_files": {
                    "flake8": ".flake8",
                    "black": "pyproject.toml",
                    "isort": ".isort.cfg",
                    "mypy": "mypy.ini",
                },
            },
            "testing": {
                "framework": "pytest",
                "coverage_tool": "coverage",
                "test_pattern": "test_*.py",
                "coverage_report_format": "html",
            },
            "documentation": {
                "builder": "sphinx",
                "formats": ["html", "pdf"],
                "source_dir": "docs",
                "output_dir": "docs/build",
            },
            "debugging": {
                "log_levels": ["DEBUG", "INFO", "WARNING", "ERROR"],
                "log_formats": ["text", "json"],
                "profiling": False,
            },
        }
        with open(DEV_CONFIG_FILE, "w") as f:
            json.dump(default_config, f, indent=2)


def _load_dev_config() -> Dict[str, Any]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é dev –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"""
    _ensure_dev_directory()
    try:
        with open(DEV_CONFIG_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}


def _save_dev_config(config: Dict[str, Any]):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é dev –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"""
    _ensure_dev_directory()
    with open(DEV_CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)


def _check_tool_availability(tool_name: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Python –º–æ–¥—É–ª—å (–¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π)
    try:
        result = subprocess.run(
            [sys.executable, "-m", tool_name, "--version"], 
            capture_output=True, text=True
        )
        if result.returncode == 0:
            return True
    except FileNotFoundError:
        pass
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å, –ø—Ä–æ–±—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
    try:
        result = subprocess.run(
            [tool_name, "--version"], capture_output=True, text=True
        )
        return result.returncode == 0
    except FileNotFoundError:
        return False


def _get_python_files(directory: str = ".") -> List[str]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ Python —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"""
    python_files = []
    for root, dirs, files in os.walk(directory):
        # –ò—Å–∫–ª—é—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∫—ç—à
        dirs[:] = [
            d
            for d in dirs
            if not d.startswith(".") and d not in ["venv", "env", "__pycache__"]
        ]
        for file in files:
            if file.endswith(".py"):
                python_files.append(os.path.join(root, file))
    return python_files


@dev_app.command(name="lint", help="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω—Ç–µ—Ä–∞.")
def dev_lint_cmd(
    files: Optional[List[str]] = typer.Option(
        None, "--files", "-f", help="–§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
    ),
    fix: bool = typer.Option(False, "--fix", help="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"),
    tool: str = typer.Option(
        "flake8", "--tool", "-t", help="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: flake8, black, isort, mypy"
    ),
    output_format: str = typer.Option(
        "text", "--format", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: text, json, html"
    ),
):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω—Ç–µ—Ä–∞"""
    try:
        asyncio.run(_dev_lint_async(files, fix, tool, output_format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev lint': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_lint_async(
    files: Optional[List[str]], fix: bool, tool: str, output_format: str
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã lint"""
    console.print(
        Panel("[bold blue]–ü–†–û–í–ï–†–ö–ê –ö–û–î–ê[/]", expand=False, border_style="blue")
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    if not _check_tool_availability(tool):
        console.print(
            f"[bold red]–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{tool}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install {tool}[/]"
        )
        raise typer.Exit(code=1)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    if not files:
        files = _get_python_files()
        console.print(f"[cyan]–ù–∞–π–¥–µ–Ω–æ Python —Ñ–∞–π–ª–æ–≤:[/] {len(files)}")
    else:
        console.print(f"[cyan]–§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:[/] {', '.join(files)}")

    if not files:
        console.print("[yellow]Python —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    console.print(f"[cyan]–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:[/] {tool}")
    console.print(f"[cyan]–†–µ–∂–∏–º:[/] {'–ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' if fix else '–¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞'}")

    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    issues = await _run_linting_tool(tool, files, fix)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await _display_lint_results(issues, tool, output_format)


async def _run_linting_tool(
    tool: str, files: List[str], fix: bool
) -> List[Dict[str, Any]]:
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ª–∏–Ω—Ç–∏–Ω–≥–∞"""
    issues = []

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º python -m –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
        if tool == "flake8":
            cmd = [sys.executable, "-m", "flake8"] + files
            if fix:
                console.print("[yellow]flake8 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ[/]")
        elif tool == "black":
            cmd = [sys.executable, "-m", "black"] + files
            if not fix:
                cmd.append("--check")
        elif tool == "isort":
            cmd = [sys.executable, "-m", "isort"] + files
            if not fix:
                cmd.append("--check-only")
        elif tool == "mypy":
            cmd = [sys.executable, "-m", "mypy"] + files
        else:
            console.print(f"[yellow]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {tool}[/]")
            return issues

        console.print(f"[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:[/] {' '.join(cmd)}")

        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode == 0:
            console.print("[green]‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫[/]")
        else:
            # –ü–∞—Ä—Å–∏–º –≤—ã–≤–æ–¥ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
            for line in result.stdout.split("\n") + result.stderr.split("\n"):
                if line.strip():
                    issues.append(
                        {
                            "file": "unknown",
                            "line": 0,
                            "column": 0,
                            "message": line.strip(),
                            "severity": "error",
                        }
                    )

            console.print(f"[yellow]‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: {len(issues)}[/]")

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ {tool}: {e}[/]")

    return issues


async def _display_lint_results(
    issues: List[Dict[str, Any]], tool: str, output_format: str
):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∏–Ω—Ç–∏–Ω–≥–∞"""
    if output_format == "json":
        console.print(json.dumps(issues, indent=2, ensure_ascii=False))
        return

    if not issues:
        console.print("[green]‚úÖ –ü—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ[/]")
        return

    # –¢–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    table = Table(title=f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ ({tool})")
    table.add_column("–§–∞–π–ª", style="cyan")
    table.add_column("–°—Ç—Ä–æ–∫–∞", style="blue")
    table.add_column("–ö–æ–ª–æ–Ω–∫–∞", style="green")
    table.add_column("–°–æ–æ–±—â–µ–Ω–∏–µ", style="white")
    table.add_column("–¢–∏–ø", style="red")

    for issue in issues:
        table.add_row(
            issue.get("file", "N/A"),
            str(issue.get("line", "N/A")),
            str(issue.get("column", "N/A")),
            issue.get("message", "N/A"),
            issue.get("severity", "error"),
        )

    console.print(table)


@dev_app.command(name="test", help="–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤.")
def dev_test_cmd(
    pattern: Optional[str] = typer.Option(
        None, "--pattern", "-p", help="–®–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤"
    ),
    coverage: bool = typer.Option(
        False, "--coverage", "-c", help="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞"
    ),
    verbose: bool = typer.Option(False, "--verbose", "-v", help="–ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥"),
    parallel: bool = typer.Option(
        False, "--parallel", help="–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ"
    ),
):
    """–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"""
    try:
        asyncio.run(_dev_test_async(pattern, coverage, verbose, parallel))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev test': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_test_async(
    pattern: Optional[str], coverage: bool, verbose: bool, parallel: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã test"""
    console.print(
        Panel("[bold blue]–ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í[/]", expand=False, border_style="blue")
    )

    config = _load_dev_config()
    test_config = config.get("testing", {})
    framework = test_config.get("framework", "pytest")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å pytest
    if not _check_tool_availability("pytest"):
        console.print(
            "[bold red]pytest –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install pytest[/]"
        )
        raise typer.Exit(code=1)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É
    cmd = ["pytest"]

    if pattern:
        cmd.extend(["-k", pattern])
        console.print(f"[cyan]–®–∞–±–ª–æ–Ω —Ç–µ—Å—Ç–æ–≤:[/] {pattern}")

    if coverage:
        if not _check_tool_availability("coverage"):
            console.print(
                "[yellow]coverage –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install coverage[/]"
            )
        else:
            cmd.extend(["--cov=.", "--cov-report=html", "--cov-report=term"])
            console.print("[cyan]–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞:[/] –í–∫–ª—é—á–µ–Ω–æ")

    if verbose:
        cmd.append("-v")
        console.print("[cyan]–†–µ–∂–∏–º:[/] –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥")

    if parallel:
        if not _check_tool_availability("pytest-xdist"):
            console.print(
                "[yellow]pytest-xdist –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install pytest-xdist[/]"
            )
        else:
            cmd.extend(["-n", "auto"])
            console.print("[cyan]–†–µ–∂–∏–º:[/] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ")

    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:[/] {' '.join(cmd)}")

    try:
        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode == 0:
            console.print("[green]‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ[/]")
        else:
            console.print("[red]‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏[/]")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–≤–æ–¥
        if result.stdout:
            console.print("\n[cyan]–í—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤:[/]")
            console.print(result.stdout)

        if result.stderr:
            console.print("\n[yellow]–û—à–∏–±–∫–∏:[/]")
            console.print(result.stderr)

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤: {e}[/]")


@dev_app.command(name="docs", help="–°–±–æ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.")
def dev_docs_cmd(
    format: str = typer.Option(
        "html", "--format", "-f", help="–§–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: html, pdf, epub"
    ),
    output_dir: Optional[str] = typer.Option(
        None, "--output", "-o", help="–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
    ),
    clean: bool = typer.Option(False, "--clean", help="–û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É"),
    serve: bool = typer.Option(
        False, "--serve", help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞"
    ),
):
    """–°–±–æ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"""
    try:
        asyncio.run(_dev_docs_async(format, output_dir, clean, serve))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev docs': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_docs_async(
    format: str, output_dir: Optional[str], clean: bool, serve: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã docs"""
    console.print(
        Panel("[bold blue]–°–ë–û–†–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò[/]", expand=False, border_style="blue")
    )

    config = _load_dev_config()
    docs_config = config.get("documentation", {})
    builder = docs_config.get("builder", "sphinx")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å sphinx-build
    if not _check_tool_availability("sphinx-build"):
        console.print(
            "[bold red]sphinx-build –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install sphinx[/]"
        )
        raise typer.Exit(code=1)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    source_dir = Path(docs_config.get("source_dir", "docs"))
    if not output_dir:
        output_dir = docs_config.get("output_dir", "docs/build")

    output_path = Path(output_dir)

    console.print(f"[cyan]–§–æ—Ä–º–∞—Ç:[/] {format}")
    console.print(f"[cyan]–ò—Å—Ç–æ—á–Ω–∏–∫:[/] {source_dir}")
    console.print(f"[cyan]–í—ã–≤–æ–¥:[/] {output_path}")

    # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–±–æ—Ä–∫–∏
    if clean and output_path.exists():
        shutil.rmtree(output_path)
        console.print("[cyan]–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å–±–æ—Ä–∫–∞ –æ—á–∏—â–µ–Ω–∞[/]")

    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤—ã–≤–æ–¥–∞
    output_path.mkdir(parents=True, exist_ok=True)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É sphinx
    cmd = ["sphinx-build", "-b", format, str(source_dir), str(output_path)]

    console.print(f"[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:[/] {' '.join(cmd)}")

    try:
        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode == 0:
            console.print(f"[green]‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–∞ –≤ {output_path}[/]")

            if serve:
                await _serve_documentation(output_path, format)
        else:
            console.print("[red]‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏[/]")
            if result.stderr:
                console.print(result.stderr)

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: {e}[/]")


async def _serve_documentation(output_path: Path, format: str):
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"""
    if format != "html":
        console.print(
            "[yellow]–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è HTML —Ñ–æ—Ä–º–∞—Ç–∞[/]"
        )
        return

    try:
        import http.server
        import socketserver

        port = 8001
        os.chdir(output_path)

        with socketserver.TCPServer(
            ("", port), http.server.SimpleHTTPRequestHandler
        ) as httpd:
            console.print(
                f"[green]üåê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:{port}[/]"
            )
            console.print("[yellow]–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞[/]")

            try:
                httpd.serve_forever()
            except KeyboardInterrupt:
                console.print("\n[yellow]–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω[/]")

    except Exception as e:
        console.print(f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: {e}[/]")


@dev_app.command(name="debug", help="–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏.")
def dev_debug_cmd(
    level: str = typer.Option(
        "DEBUG", "--level", "-l", help="–£—Ä–æ–≤–µ–Ω—å –æ—Ç–ª–∞–¥–∫–∏: DEBUG, INFO, WARNING, ERROR"
    ),
    log_file: Optional[str] = typer.Option(
        None, "--log-file", help="–§–∞–π–ª –¥–ª—è –ª–æ–≥–æ–≤ –æ—Ç–ª–∞–¥–∫–∏"
    ),
    profiling: bool = typer.Option(
        False, "--profiling", help="–í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"
    ),
    memory: bool = typer.Option(
        False, "--memory", help="–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏"
    ),
):
    """–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏"""
    try:
        asyncio.run(_dev_debug_async(level, log_file, profiling, memory))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev debug': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_debug_async(
    level: str, log_file: Optional[str], profiling: bool, memory: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã debug"""
    console.print(
        Panel("[bold blue]–†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò[/]", expand=False, border_style="blue")
    )

    config = _load_dev_config()
    debug_config = config.get("debugging", {})

    console.print(f"[cyan]–£—Ä–æ–≤–µ–Ω—å –æ—Ç–ª–∞–¥–∫–∏:[/] {level}")

    if log_file:
        console.print(f"[cyan]–§–∞–π–ª –ª–æ–≥–æ–≤:[/] {log_file}")
    else:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        log_file = DEV_LOGS_DIR / f"debug_{timestamp}.log"
        console.print(f"[cyan]–§–∞–π–ª –ª–æ–≥–æ–≤:[/] {log_file}")

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    await _setup_debug_logging(level, log_file)

    # –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
    if profiling:
        await _setup_profiling()

    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
    if memory:
        await _setup_memory_monitoring()

    console.print("[green]‚úÖ –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω[/]")
    console.print("[dim]–õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª[/]")


async def _setup_debug_logging(level: str, log_file: str):
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"""
    import logging

    # –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä
    logger = logging.getLogger("swiftdevbot_debug")
    logger.setLevel(getattr(logging, level.upper(), logging.DEBUG))

    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    file_handler = logging.FileHandler(log_file)
    file_handler.setLevel(getattr(logging, level.upper(), logging.DEBUG))

    # –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
    formatter = logging.Formatter(
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    file_handler.setFormatter(formatter)

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –ª–æ–≥–≥–µ—Ä—É
    logger.addHandler(file_handler)

    # –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    logger.info(f"–û—Ç–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—Ä–æ–≤–Ω–µ–º {level}")
    logger.debug("–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")


async def _setup_profiling():
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    try:
        import cProfile
        import pstats

        console.print("[cyan]–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:[/] –í–∫–ª—é—á–µ–Ω–æ")
        console.print("[dim]–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ cProfile –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏[/]")

    except ImportError:
        console.print("[yellow]cProfile –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω[/]")


async def _setup_memory_monitoring():
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏"""
    try:
        import gc

        import psutil

        console.print("[cyan]–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏:[/] –í–∫–ª—é—á–µ–Ω")

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–º—è—Ç–∏
        process = psutil.Process()
        memory_info = process.memory_info()

        console.print(
            f"[dim]–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:[/] {memory_info.rss / 1024 / 1024:.1f} MB"
        )
        console.print(
            f"[dim]–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å:[/] {memory_info.vms / 1024 / 1024:.1f} MB"
        )

        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
        gc.collect()
        console.print("[dim]–°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞[/]")

    except ImportError:
        console.print("[yellow]psutil –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏[/]")


@dev_app.command(name="analyze", help="–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞.")
def dev_analyze_cmd(
    tool: str = typer.Option(
        "pylint", "--tool", "-t", help="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞: pylint, bandit, safety"
    ),
    output_format: str = typer.Option(
        "text", "--format", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: text, json, html"
    ),
):
    """–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞"""
    try:
        asyncio.run(_dev_analyze_async(tool, output_format))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev analyze': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_analyze_async(tool: str, output_format: str):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã analyze"""
    console.print(Panel("[bold blue]–ê–ù–ê–õ–ò–ó –ö–û–î–ê[/]", expand=False, border_style="blue"))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    if not _check_tool_availability(tool):
        console.print(
            f"[bold red]–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{tool}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: pip install {tool}[/]"
        )
        raise typer.Exit(code=1)

    console.print(f"[cyan]–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞:[/] {tool}")

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ Python —Ñ–∞–π–ª–æ–≤
    files = _get_python_files()

    if not files:
        console.print("[yellow]Python —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")
        return

    # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
    issues = await _run_code_analysis(tool, files)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await _display_analysis_results(issues, tool, output_format)


async def _run_code_analysis(tool: str, files: List[str]) -> List[Dict[str, Any]]:
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞"""
    issues = []

    try:
        if tool == "pylint":
            cmd = ["pylint"] + files
        elif tool == "bandit":
            cmd = ["bandit", "-r", "."]
        elif tool == "safety":
            cmd = ["safety", "check"]
        else:
            console.print(f"[yellow]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞: {tool}[/]")
            return issues

        console.print(f"[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:[/] {' '.join(cmd)}")

        result = subprocess.run(cmd, capture_output=True, text=True)

        # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        for line in result.stdout.split("\n") + result.stderr.split("\n"):
            if line.strip():
                issues.append(
                    {"tool": tool, "message": line.strip(), "severity": "info"}
                )

        if result.returncode == 0:
            console.print("[green]‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º[/]")
        else:
            console.print(f"[yellow]‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: {len(issues)}[/]")

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞: {e}[/]")

    return issues


async def _display_analysis_results(
    issues: List[Dict[str, Any]], tool: str, output_format: str
):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"""
    if output_format == "json":
        console.print(json.dumps(issues, indent=2, ensure_ascii=False))
        return

    if not issues:
        console.print("[green]‚úÖ –ü—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ[/]")
        return

    # –¢–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    table = Table(title=f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ ({tool})")
    table.add_column("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", style="cyan")
    table.add_column("–°–æ–æ–±—â–µ–Ω–∏–µ", style="white")
    table.add_column("–í–∞–∂–Ω–æ—Å—Ç—å", style="red")

    for issue in issues:
        table.add_row(
            issue.get("tool", "N/A"),
            issue.get("message", "N/A"),
            issue.get("severity", "info"),
        )

    console.print(table)


@dev_app.command(name="profile", help="–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞.")
def dev_profile_cmd(
    profile_type: str = typer.Option(
        "cpu", "--type", "-t", help="–¢–∏–ø –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è: cpu, memory, time"
    ),
    duration: int = typer.Option(
        30, "--duration", "-d", help="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö"
    ),
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="–§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    ),
    target_script: Optional[str] = typer.Option(
        None, "--script", "-s", help="–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è"
    ),
):
    """–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞"""
    try:
        asyncio.run(_dev_profile_async(profile_type, duration, output_file, target_script))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev profile': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_profile_async(
    profile_type: str, duration: int, output_file: Optional[str], target_script: Optional[str]
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã profile"""
    console.print(Panel("[bold blue]–ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò[/]", expand=False, border_style="blue"))

    console.print(f"[cyan]–¢–∏–ø –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è:[/] {profile_type}")
    console.print(f"[cyan]–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:[/] {duration} —Å–µ–∫—É–Ω–¥")
    
    if target_script:
        console.print(f"[cyan]–¶–µ–ª–µ–≤–æ–π —Å–∫—Ä–∏–ø—Ç:[/] {target_script}")
    
    if output_file:
        console.print(f"[cyan]–§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:[/] {output_file}")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    if not target_script:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç
        target_script = "run_bot.py"
        console.print(f"[cyan]–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:[/] {target_script}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
    if not Path(target_script).exists():
        console.print(f"[bold red]–°–∫—Ä–∏–ø—Ç '{target_script}' –Ω–µ –Ω–∞–π–¥–µ–Ω![/]")
        raise typer.Exit(code=1)

    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
    results = await _run_profiling(profile_type, duration, target_script, output_file)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await _display_profile_results(results, profile_type, output_file)


async def _run_profiling(
    profile_type: str, duration: int, target_script: str, output_file: Optional[str]
) -> Dict[str, Any]:
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"""
    results = {
        "type": profile_type,
        "duration": duration,
        "script": target_script,
        "timestamp": datetime.now().isoformat(),
        "data": {}
    }

    try:
        if profile_type == "cpu":
            results["data"] = await _profile_cpu(target_script, duration, output_file)
        elif profile_type == "memory":
            results["data"] = await _profile_memory(target_script, duration, output_file)
        elif profile_type == "time":
            results["data"] = await _profile_time(target_script, duration, output_file)
        else:
            console.print(f"[bold red]–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è: {profile_type}[/]")
            console.print("[yellow]–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã: cpu, memory, time[/]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}[/]")
        raise typer.Exit(code=1)

    return results


async def _profile_cpu(script: str, duration: int, output_file: Optional[str]) -> Dict[str, Any]:
    """–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ CPU"""
    console.print("[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è CPU –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ...[/]")
    
    import cProfile
    import pstats
    import tempfile
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    with tempfile.NamedTemporaryFile(suffix='.prof', delete=False) as tmp_file:
        prof_file = tmp_file.name
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
        profiler = cProfile.Profile()
        profiler.enable()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
        process = subprocess.Popen(
            [sys.executable, script],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        
        # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        await asyncio.sleep(duration)
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
        process.terminate()
        try:
            process.wait(timeout=5)
        except subprocess.TimeoutExpired:
            process.kill()
        
        profiler.disable()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        profiler.dump_stats(prof_file)
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        stats = pstats.Stats(prof_file)
        stats.sort_stats('cumulative')
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-10 —Ñ—É–Ω–∫—Ü–∏–π
        top_functions = []
        for func, (cc, nc, tt, ct, callers) in stats.stats.items():
            if isinstance(func, tuple):
                filename, line, funcname = func
                top_functions.append({
                    "function": funcname,
                    "file": filename,
                    "line": line,
                    "calls": nc,
                    "total_time": ct,
                    "per_call": ct / nc if nc > 0 else 0
                })
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        top_functions.sort(key=lambda x: x["total_time"], reverse=True)
        top_functions = top_functions[:10]
        
        # –°–æ–∑–¥–∞–µ–º HTML –æ—Ç—á–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if output_file:
            html_file = output_file if output_file.endswith('.html') else f"{output_file}.html"
            stats.dump_stats(html_file.replace('.html', '.prof'))
            console.print(f"[green]‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {html_file}[/]")
        
        return {
            "top_functions": top_functions,
            "total_functions": len(stats.stats),
            "total_time": sum(f[3] for f in stats.stats.values()),
            "html_file": output_file if output_file else None
        }
        
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if Path(prof_file).exists():
            Path(prof_file).unlink()


async def _profile_memory(script: str, duration: int, output_file: Optional[str]) -> Dict[str, Any]:
    """–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏"""
    console.print("[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏...[/]")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å memory_profiler
        import memory_profiler
    except ImportError:
        console.print("[bold red]memory_profiler –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω![/]")
        console.print("[yellow]–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install memory_profiler[/]")
        raise typer.Exit(code=1)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
    cmd = [sys.executable, "-m", "memory_profiler", script]
    
    process = subprocess.Popen(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    
    # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    await asyncio.sleep(duration)
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    process.terminate()
    try:
        process.wait(timeout=5)
    except subprocess.TimeoutExpired:
        process.kill()
    
    stdout, stderr = process.communicate()
    
    # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    memory_data = []
    for line in stdout.decode().split('\n'):
        if line.strip() and 'MiB' in line:
            parts = line.split()
            if len(parts) >= 4:
                memory_data.append({
                    "line": parts[0],
                    "memory": parts[1],
                    "increment": parts[2],
                    "function": ' '.join(parts[3:])
                })
    
    return {
        "memory_usage": memory_data,
        "peak_memory": max([float(d["memory"]) for d in memory_data]) if memory_data else 0,
        "total_lines": len(memory_data)
    }


async def _profile_time(script: str, duration: int, output_file: Optional[str]) -> Dict[str, Any]:
    """–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"""
    console.print("[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏...[/]")
    
    import time
    
    start_time = time.time()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    process = subprocess.Popen(
        [sys.executable, script],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )
    
    # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    await asyncio.sleep(duration)
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    process.terminate()
    try:
        process.wait(timeout=5)
    except subprocess.TimeoutExpired:
        process.kill()
    
    end_time = time.time()
    
    return {
        "start_time": start_time,
        "end_time": end_time,
        "duration": end_time - start_time,
        "script": script
    }


async def _display_profile_results(results: Dict[str, Any], profile_type: str, output_file: Optional[str]):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è"""
    console.print(f"\n[bold green]‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ![/]")
    
    if profile_type == "cpu":
        await _display_cpu_results(results["data"])
    elif profile_type == "memory":
        await _display_memory_results(results["data"])
    elif profile_type == "time":
        await _display_time_results(results["data"])
    
    if output_file:
        console.print(f"\n[cyan]üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:[/] {output_file}")


async def _display_cpu_results(data: Dict[str, Any]):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã CPU –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è"""
    console.print(f"\n[bold cyan]üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CPU –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è:[/]")
    
    table = Table(title="–¢–æ–ø-10 —Ñ—É–Ω–∫—Ü–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è")
    table.add_column("–§—É–Ω–∫—Ü–∏—è", style="cyan")
    table.add_column("–§–∞–π–ª", style="white")
    table.add_column("–í—ã–∑–æ–≤—ã", style="green")
    table.add_column("–û–±—â–µ–µ –≤—Ä–µ–º—è", style="red")
    table.add_column("–í—Ä–µ–º—è/–≤—ã–∑–æ–≤", style="yellow")
    
    for func in data["top_functions"]:
        table.add_row(
            func["function"],
            Path(func["file"]).name,
            str(func["calls"]),
            f"{func['total_time']:.4f}s",
            f"{func['per_call']:.6f}s"
        )
    
    console.print(table)
    
    console.print(f"\n[cyan]üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/]")
    console.print(f"   üìä –í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π: {data['total_functions']}")
    console.print(f"   üìä –û–±—â–µ–µ –≤—Ä–µ–º—è: {data['total_time']:.4f}s")
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    console.print(f"\n[bold yellow]üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:[/]")
    if data["top_functions"]:
        top_func = data["top_functions"][0]
        console.print(f"   üîß –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é: {top_func['function']}")
        console.print(f"   üìä –û–Ω–∞ –∑–∞–Ω–∏–º–∞–µ—Ç {top_func['total_time']:.2f}s ({top_func['total_time']/data['total_time']*100:.1f}%)")
    
    if data.get("html_file"):
        console.print(f"   üìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç: {data['html_file']}")


async def _display_memory_results(data: Dict[str, Any]):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏"""
    console.print(f"\n[bold cyan]üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏:[/]")
    
    table = Table(title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏")
    table.add_column("–°—Ç—Ä–æ–∫–∞", style="cyan")
    table.add_column("–ü–∞–º—è—Ç—å (MiB)", style="red")
    table.add_column("–ü—Ä–∏—Ä–æ—Å—Ç", style="yellow")
    table.add_column("–§—É–Ω–∫—Ü–∏—è", style="white")
    
    for item in data["memory_usage"][:10]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-10
        table.add_row(
            item["line"],
            item["memory"],
            item["increment"],
            item["function"]
        )
    
    console.print(table)
    
    console.print(f"\n[cyan]üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏:[/]")
    console.print(f"   üìä –ü–∏–∫–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {data['peak_memory']:.2f} MiB")
    console.print(f"   üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫: {data['total_lines']}")
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    console.print(f"\n[bold yellow]üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:[/]")
    if data["memory_usage"]:
        max_memory = max(data["memory_usage"], key=lambda x: float(x["memory"]))
        console.print(f"   üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä–æ–∫—É {max_memory['line']} –≤ —Ñ—É–Ω–∫—Ü–∏–∏ {max_memory['function']}")
        console.print(f"   üìä –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {max_memory['memory']} MiB")


async def _display_time_results(data: Dict[str, Any]):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏"""
    console.print(f"\n[bold cyan]üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:[/]")
    
    console.print(f"[cyan]üìà –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:[/]")
    console.print(f"   üìä –ù–∞—á–∞–ª–æ: {datetime.fromtimestamp(data['start_time']).strftime('%H:%M:%S')}")
    console.print(f"   üìä –ö–æ–Ω–µ—Ü: {datetime.fromtimestamp(data['end_time']).strftime('%H:%M:%S')}")
    console.print(f"   üìä –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {data['duration']:.2f} —Å–µ–∫—É–Ω–¥")
    console.print(f"   üìä –°–∫—Ä–∏–ø—Ç: {data['script']}")
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    console.print(f"\n[bold yellow]üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:[/]")
    if data['duration'] > 60:
        console.print(f"   ‚ö†Ô∏è –î–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {data['duration']:.1f}s")
        console.print(f"   üîß –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å–∫—Ä–∏–ø—Ç–∞")
    else:
        console.print(f"   ‚úÖ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –Ω–æ—Ä–º–µ")


@dev_app.command(name="benchmark", help="–ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.")
def dev_benchmark_cmd(
    suite: str = typer.Option(
        "all", "--suite", "-s", help="–ù–∞–±–æ—Ä –±–µ–Ω—á–º–∞—Ä–∫–æ–≤: all, backup, database, cache, api, modules"
    ),
    iterations: int = typer.Option(
        100, "--iterations", "-i", help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞"
    ),
    compare: bool = typer.Option(
        False, "--compare", "-c", help="–°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏"
    ),
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="–§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    ),
    warmup: bool = typer.Option(
        True, "--warmup/--no-warmup", help="–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–∑–æ–≥—Ä–µ–≤ –ø–µ—Ä–µ–¥ –±–µ–Ω—á–º–∞—Ä–∫–∞–º–∏"
    ),
):
    """–ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    try:
        asyncio.run(_dev_benchmark_async(suite, iterations, compare, output_file, warmup))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev benchmark': {e}[/]")
        raise typer.Exit(code=1)


async def _dev_benchmark_async(
    suite: str, iterations: int, compare: bool, output_file: Optional[str], warmup: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã benchmark"""
    console.print(Panel("[bold blue]–ó–ê–ü–£–°–ö –ë–ï–ù–ß–ú–ê–†–ö–û–í[/]", expand=False, border_style="blue"))

    console.print(f"[cyan]–ù–∞–±–æ—Ä –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:[/] {suite}")
    console.print(f"[cyan]–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π:[/] {iterations}")
    console.print(f"[cyan]–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏:[/] {'–î–∞' if compare else '–ù–µ—Ç'}")
    console.print(f"[cyan]–†–∞–∑–æ–≥—Ä–µ–≤:[/] {'–î–∞' if warmup else '–ù–µ—Ç'}")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å
    benchmark_suites = _get_benchmark_suites(suite)
    
    if not benchmark_suites:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–∞–±–æ—Ä –±–µ–Ω—á–º–∞—Ä–∫–æ–≤: {suite}[/]")
        console.print("[yellow]–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã: all, backup, database, cache, api, modules[/]")
        raise typer.Exit(code=1)

    # –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–æ–≥—Ä–µ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if warmup:
        await _run_warmup(benchmark_suites)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫–∏
    results = await _run_benchmarks(benchmark_suites, iterations)

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if compare:
        previous_results = await _load_previous_results()
        comparison = await _compare_results(results, previous_results)
    else:
        comparison = None

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if output_file:
        await _save_benchmark_results(results, output_file)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await _display_benchmark_results(results, comparison, output_file)


def _get_benchmark_suites(suite: str) -> List[str]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"""
    all_suites = ["backup", "database", "cache", "api", "modules"]
    
    if suite == "all":
        return all_suites
    elif suite in all_suites:
        return [suite]
    else:
        return []


async def _run_warmup(benchmark_suites: List[str]):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–∑–æ–≥—Ä–µ–≤ –ø–µ—Ä–µ–¥ –±–µ–Ω—á–º–∞—Ä–∫–∞–º–∏"""
    console.print("[cyan]–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑–æ–≥—Ä–µ–≤...[/]")
    
    for suite in benchmark_suites:
        try:
            if suite == "backup":
                await _warmup_backup()
            elif suite == "database":
                await _warmup_database()
            elif suite == "cache":
                await _warmup_cache()
            elif suite == "api":
                await _warmup_api()
            elif suite == "modules":
                await _warmup_modules()
        except Exception as e:
            console.print(f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ä–∞–∑–æ–≥—Ä–µ–≤ {suite} –Ω–µ —É–¥–∞–ª—Å—è: {e}[/]")
    
    console.print("[green]‚úÖ –†–∞–∑–æ–≥—Ä–µ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω[/]")


async def _warmup_backup():
    """–†–∞–∑–æ–≥—Ä–µ–≤ –¥–ª—è –±—ç–∫–∞–ø–æ–≤"""
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –±—ç–∫–∞–ø–∞
    test_file = Path("test_benchmark_file.txt")
    test_file.write_text("test" * 1000)  # 4KB —Ñ–∞–π–ª


async def _warmup_database():
    """–†–∞–∑–æ–≥—Ä–µ–≤ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
    try:
        from Systems.core.app_settings import settings
        # –ü—Ä–æ—Å—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
        _ = settings.db
    except Exception:
        pass


async def _warmup_cache():
    """–†–∞–∑–æ–≥—Ä–µ–≤ –¥–ª—è –∫—ç—à–∞"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫—ç—à
    try:
        import cachetools
    except ImportError:
        pass


async def _warmup_api():
    """–†–∞–∑–æ–≥—Ä–µ–≤ –¥–ª—è API"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º HTTP –∫–ª–∏–µ–Ω—Ç
    try:
        import aiohttp
    except ImportError:
        pass


async def _warmup_modules():
    """–†–∞–∑–æ–≥—Ä–µ–≤ –¥–ª—è –º–æ–¥—É–ª–µ–π"""
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏
    try:
        from pathlib import Path
        modules_dir = Path("Modules")
        if modules_dir.exists():
            for module_file in modules_dir.glob("*.py"):
                if module_file.name != "__init__.py":
                    try:
                        __import__(f"Modules.{module_file.stem}")
                    except Exception:
                        pass
    except Exception:
        pass


async def _run_benchmarks(benchmark_suites: List[str], iterations: int) -> Dict[str, Any]:
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏"""
    results = {
        "timestamp": datetime.now().isoformat(),
        "iterations": iterations,
        "suites": benchmark_suites,
        "benchmarks": {}
    }

    for suite in benchmark_suites:
        console.print(f"[cyan]–ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ {suite}...[/]")
        
        try:
            if suite == "backup":
                results["benchmarks"]["backup"] = await _benchmark_backup(iterations)
            elif suite == "database":
                results["benchmarks"]["database"] = await _benchmark_database(iterations)
            elif suite == "cache":
                results["benchmarks"]["cache"] = await _benchmark_cache(iterations)
            elif suite == "api":
                results["benchmarks"]["api"] = await _benchmark_api(iterations)
            elif suite == "modules":
                results["benchmarks"]["modules"] = await _benchmark_modules(iterations)
        except Exception as e:
            console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ –≤ –±–µ–Ω—á–º–∞—Ä–∫–µ {suite}: {e}[/]")
            results["benchmarks"][suite] = {"error": str(e)}

    return results


async def _benchmark_backup(iterations: int) -> Dict[str, Any]:
    """–ë–µ–Ω—á–º–∞—Ä–∫ –±—ç–∫–∞–ø–æ–≤"""
    import time
    import tempfile
    from pathlib import Path
    
    results = {}
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    test_files = {
        "small": "test_small.txt",
        "medium": "test_medium.txt", 
        "large": "test_large.txt"
    }
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
    Path(test_files["small"]).write_text("test" * 100)  # 400B
    Path(test_files["medium"]).write_text("test" * 10000)  # 40KB
    Path(test_files["large"]).write_text("test" * 100000)  # 400KB
    
    try:
        # –ë–µ–Ω—á–º–∞—Ä–∫ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞
        for size, filename in test_files.items():
            times = []
            for _ in range(iterations):
                start_time = time.time()
                
                # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
                backup_name = f"backup_{filename}_{int(time.time())}"
                shutil.copy2(filename, backup_name)
                
                end_time = time.time()
                times.append(end_time - start_time)
                
                # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—ç–∫–∞–ø
                Path(backup_name).unlink()
            
            results[f"backup_create_{size}"] = {
                "mean": sum(times) / len(times),
                "min": min(times),
                "max": max(times),
                "std": _calculate_std(times)
            }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞
        for size, filename in test_files.items():
            times = []
            for _ in range(iterations):
                start_time = time.time()
                
                # –°–∏–º—É–ª–∏—Ä—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞
                backup_name = f"backup_{filename}_{int(time.time())}"
                shutil.copy2(filename, backup_name)
                
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                restore_name = f"restore_{filename}_{int(time.time())}"
                shutil.copy2(backup_name, restore_name)
                
                end_time = time.time()
                times.append(end_time - start_time)
                
                # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                Path(backup_name).unlink()
                Path(restore_name).unlink()
            
            results[f"backup_restore_{size}"] = {
                "mean": sum(times) / len(times),
                "min": min(times),
                "max": max(times),
                "std": _calculate_std(times)
            }
    
    finally:
        # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        for filename in test_files.values():
            Path(filename).unlink(missing_ok=True)
    
    return results


async def _benchmark_database(iterations: int) -> Dict[str, Any]:
    """–ë–µ–Ω—á–º–∞—Ä–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    import time
    import sqlite3
    import tempfile
    
    results = {}
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ë–î
    with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as tmp_file:
        db_path = tmp_file.name
    
    try:
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        cursor.execute("""
            CREATE TABLE benchmark_test (
                id INTEGER PRIMARY KEY,
                name TEXT,
                value REAL,
                data TEXT
            )
        """)
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ –≤—Å—Ç–∞–≤–∫–∏
        times = []
        for i in range(iterations):
            start_time = time.time()
            
            cursor.execute(
                "INSERT INTO benchmark_test (name, value, data) VALUES (?, ?, ?)",
                (f"test_{i}", i * 1.5, "x" * 100)
            )
            
            end_time = time.time()
            times.append(end_time - start_time)
        
        conn.commit()
        results["db_insert"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ –≤—ã–±–æ—Ä–∫–∏
        times = []
        for i in range(iterations):
            start_time = time.time()
            
            cursor.execute("SELECT * FROM benchmark_test WHERE id = ?", (i + 1,))
            cursor.fetchone()
            
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["db_select"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        times = []
        for i in range(iterations):
            start_time = time.time()
            
            cursor.execute(
                "UPDATE benchmark_test SET value = ? WHERE id = ?",
                (i * 2.0, i + 1)
            )
            
            end_time = time.time()
            times.append(end_time - start_time)
        
        conn.commit()
        results["db_update"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ —Å–ª–æ–∂–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        times = []
        for _ in range(iterations):
            start_time = time.time()
            
            cursor.execute("""
                SELECT COUNT(*), AVG(value), MAX(value), MIN(value)
                FROM benchmark_test
                WHERE value > 50
            """)
            cursor.fetchone()
            
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["db_complex_query"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        conn.close()
    
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ë–î
        Path(db_path).unlink(missing_ok=True)
    
    return results


async def _benchmark_cache(iterations: int) -> Dict[str, Any]:
    """–ë–µ–Ω—á–º–∞—Ä–∫ –∫—ç—à–∞"""
    import time
    
    results = {}
    
    try:
        import cachetools
        from cachetools import TTLCache, LRUCache
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ TTL –∫—ç—à–∞
        cache = TTLCache(maxsize=1000, ttl=60)
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à
        times = []
        for i in range(iterations):
            start_time = time.time()
            cache[f"key_{i}"] = f"value_{i}" * 100
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["cache_write"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ —á—Ç–µ–Ω–∏—è –∏–∑ –∫—ç—à–∞
        times = []
        for i in range(iterations):
            start_time = time.time()
            _ = cache.get(f"key_{i}")
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["cache_read"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ LRU –∫—ç—à–∞
        lru_cache = LRUCache(maxsize=1000)
        
        times = []
        for i in range(iterations):
            start_time = time.time()
            lru_cache[f"lru_key_{i}"] = f"lru_value_{i}" * 100
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["lru_cache_write"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
    except ImportError:
        results["error"] = "cachetools –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    return results


async def _benchmark_api(iterations: int) -> Dict[str, Any]:
    """–ë–µ–Ω—á–º–∞—Ä–∫ API –∑–∞–ø—Ä–æ—Å–æ–≤"""
    import time
    
    results = {}
    
    try:
        import aiohttp
        import asyncio
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ HTTP GET –∑–∞–ø—Ä–æ—Å–∞
        async def http_get_benchmark():
            times = []
            async with aiohttp.ClientSession() as session:
                for i in range(iterations):
                    start_time = time.time()
                    
                    try:
                        async with session.get("http://httpbin.org/get") as response:
                            await response.text()
                    except Exception:
                        pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏
                    
                    end_time = time.time()
                    times.append(end_time - start_time)
            
            return times
        
        times = await http_get_benchmark()
        results["api_http_get"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
        # –ë–µ–Ω—á–º–∞—Ä–∫ JSON –ø–∞—Ä—Å–∏–Ω–≥–∞
        import json
        
        test_data = {"test": "data", "number": 123, "list": [1, 2, 3, 4, 5]}
        json_str = json.dumps(test_data)
        
        times = []
        for _ in range(iterations):
            start_time = time.time()
            json.loads(json_str)
            end_time = time.time()
            times.append(end_time - start_time)
        
        results["api_json_parse"] = {
            "mean": sum(times) / len(times),
            "min": min(times),
            "max": max(times),
            "std": _calculate_std(times)
        }
        
    except ImportError:
        results["error"] = "aiohttp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    return results


async def _benchmark_modules(iterations: int) -> Dict[str, Any]:
    """–ë–µ–Ω—á–º–∞—Ä–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π"""
    import time
    import importlib
    from pathlib import Path
    
    results = {}
    
    # –ë–µ–Ω—á–º–∞—Ä–∫ –∏–º–ø–æ—Ä—Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
    standard_modules = ["os", "sys", "json", "datetime", "pathlib"]
    
    times = []
    for _ in range(iterations):
        start_time = time.time()
        for module in standard_modules:
            importlib.import_module(module)
        end_time = time.time()
        times.append(end_time - start_time)
    
    results["modules_standard_import"] = {
        "mean": sum(times) / len(times),
        "min": min(times),
        "max": max(times),
        "std": _calculate_std(times)
    }
    
    # –ë–µ–Ω—á–º–∞—Ä–∫ –∏–º–ø–æ—Ä—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
    local_modules = ["cli.dev", "core.app_settings"]
    
    times = []
    for _ in range(iterations):
        start_time = time.time()
        for module in local_modules:
            try:
                importlib.import_module(module)
            except ImportError:
                pass
        end_time = time.time()
        times.append(end_time - start_time)
    
    results["modules_local_import"] = {
        "mean": sum(times) / len(times),
        "min": min(times),
        "max": max(times),
        "std": _calculate_std(times)
    }
    
    # –ë–µ–Ω—á–º–∞—Ä–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    times = []
    for _ in range(iterations):
        start_time = time.time()
        list(Path(".").glob("*.py"))
        end_time = time.time()
        times.append(end_time - start_time)
    
    results["modules_directory_scan"] = {
        "mean": sum(times) / len(times),
        "min": min(times),
        "max": max(times),
        "std": _calculate_std(times)
    }
    
    return results


def _calculate_std(values: List[float]) -> float:
    """–í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"""
    if len(values) < 2:
        return 0.0
    
    mean = sum(values) / len(values)
    variance = sum((x - mean) ** 2 for x in values) / (len(values) - 1)
    return variance ** 0.5


async def _load_previous_results() -> Optional[Dict[str, Any]]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    benchmark_file = DEV_DIR / "benchmark_results.json"
    
    if benchmark_file.exists():
        try:
            with open(benchmark_file, "r") as f:
                return json.load(f)
        except Exception:
            pass
    
    return None


async def _compare_results(current: Dict[str, Any], previous: Optional[Dict[str, Any]]) -> Optional[Dict[str, Any]]:
    """–°—Ä–∞–≤–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏"""
    if not previous:
        return None
    
    comparison = {}
    
    for suite_name, suite_results in current["benchmarks"].items():
        if suite_name in previous.get("benchmarks", {}):
            comparison[suite_name] = {}
            
            for benchmark_name, benchmark_results in suite_results.items():
                if benchmark_name in previous["benchmarks"][suite_name]:
                    prev_mean = previous["benchmarks"][suite_name][benchmark_name].get("mean", 0)
                    curr_mean = benchmark_results.get("mean", 0)
                    
                    if prev_mean > 0:
                        change_percent = ((curr_mean - prev_mean) / prev_mean) * 100
                        comparison[suite_name][benchmark_name] = {
                            "change_percent": change_percent,
                            "faster": change_percent < 0,
                            "previous": prev_mean,
                            "current": curr_mean
                        }
    
    return comparison


async def _save_benchmark_results(results: Dict[str, Any], output_file: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    try:
        with open(output_file, "w") as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        console.print(f"[green]‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_file}[/]")
    except Exception as e:
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {e}[/]")


async def _display_benchmark_results(results: Dict[str, Any], comparison: Optional[Dict[str, Any]], output_file: Optional[str]):
    """–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤"""
    console.print(f"\n[bold green]‚úÖ –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã![/]")
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –Ω–∞–±–æ—Ä–∞–º
    for suite_name, suite_results in results["benchmarks"].items():
        if "error" in suite_results:
            console.print(f"\n[red]‚ùå {suite_name}: {suite_results['error']}[/]")
            continue
        
        console.print(f"\n[bold cyan]üìä {suite_name.upper()}:[/]")
        
        table = Table(title=f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã {suite_name}")
        table.add_column("–ë–µ–Ω—á–º–∞—Ä–∫", style="cyan")
        table.add_column("–°—Ä–µ–¥–Ω–µ–µ (–º—Å)", style="green")
        table.add_column("–ú–∏–Ω (–º—Å)", style="blue")
        table.add_column("–ú–∞–∫—Å (–º—Å)", style="red")
        table.add_column("–°—Ç–¥. –æ—Ç–∫–ª.", style="yellow")
        
        for benchmark_name, benchmark_results in suite_results.items():
            mean_ms = benchmark_results["mean"] * 1000
            min_ms = benchmark_results["min"] * 1000
            max_ms = benchmark_results["max"] * 1000
            std_ms = benchmark_results["std"] * 1000
            
            table.add_row(
                benchmark_name,
                f"{mean_ms:.3f}",
                f"{min_ms:.3f}",
                f"{max_ms:.3f}",
                f"{std_ms:.3f}"
            )
        
        console.print(table)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if comparison and suite_name in comparison:
            console.print(f"\n[bold yellow]üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:[/]")
            
            comp_table = Table(title=f"–ò–∑–º–µ–Ω–µ–Ω–∏—è {suite_name}")
            comp_table.add_column("–ë–µ–Ω—á–º–∞—Ä–∫", style="cyan")
            comp_table.add_column("–ò–∑–º–µ–Ω–µ–Ω–∏–µ", style="green")
            comp_table.add_column("–°—Ç–∞—Ç—É—Å", style="blue")
            
            for benchmark_name, comp_data in comparison[suite_name].items():
                change = comp_data["change_percent"]
                status = "üöÄ –ë—ã—Å—Ç—Ä–µ–µ" if comp_data["faster"] else "üêå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ"
                color = "green" if comp_data["faster"] else "red"
                
                comp_table.add_row(
                    benchmark_name,
                    f"{change:+.1f}%",
                    f"[{color}]{status}[/{color}]"
                )
            
            console.print(comp_table)
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_benchmarks = sum(len(suite) for suite in results["benchmarks"].values() if "error" not in suite)
    console.print(f"\n[cyan]üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:[/]")
    console.print(f"   üìä –í—Å–µ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤: {total_benchmarks}")
    console.print(f"   üìä –ò—Ç–µ—Ä–∞—Ü–∏–π: {results['iterations']}")
    console.print(f"   üìä –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {results['timestamp']}")
    
    if output_file:
        console.print(f"\n[cyan]üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:[/] {output_file}")


@dev_app.command(name="migrate", help="–ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏.")
def dev_migrate_cmd(
    migrate_type: str = typer.Option(
        "code", "--type", "-t", help="–¢–∏–ø –º–∏–≥—Ä–∞—Ü–∏–∏: code, config, data"
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", "-d", help="–ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
    ),
    source_version: Optional[str] = typer.Option(
        None, "--from", "-f", help="–í–µ—Ä—Å–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞"
    ),
    target_version: Optional[str] = typer.Option(
        None, "--to", help="–í–µ—Ä—Å–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
    ),
    backup: bool = typer.Option(
        True, "--backup/--no-backup", help="–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π"
    ),
):
    """–ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏"""
    try:
        asyncio.run(_dev_migrate_async(migrate_type, dry_run, source_version, target_version, backup))
    except typer.Exit:
        raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'dev migrate': {e}[/]")
        raise typer.Exit(code=1)

async def _dev_migrate_async(
    migrate_type: str, dry_run: bool, source_version: Optional[str], 
    target_version: Optional[str], backup: bool
):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏"""
    console.print(Panel.fit(
        "[bold blue]üîÑ –ú–ò–ì–†–ê–¶–ò–Ø –ö–û–î–ê[/]",
        title="[bold white]SDB Core Dev Tools[/]",
        border_style="blue"
    ))
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏–∏
    current_version = "0.1.0"  # –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è SDB
    source_ver = source_version or current_version
    target_ver = target_version or "0.2.0"  # –°–ª–µ–¥—É—é—â–∞—è –≤–µ—Ä—Å–∏—è
    
    console.print(f"–¢–∏–ø –º–∏–≥—Ä–∞—Ü–∏–∏: {migrate_type}")
    console.print(f"–í–µ—Ä—Å–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: {source_ver}")
    console.print(f"–í–µ—Ä—Å–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: {target_ver}")
    console.print(f"–†–µ–∂–∏–º dry-run: {'–î–∞' if dry_run else '–ù–µ—Ç'}")
    console.print(f"–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {'–î–∞' if backup else '–ù–µ—Ç'}")
    
    if dry_run:
        console.print("\n[bold yellow]üîç –ê–ù–ê–õ–ò–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (DRY-RUN)[/]")
        await _analyze_migration_changes(migrate_type, source_ver, target_ver)
    else:
        console.print("\n[bold green]üöÄ –í–´–ü–û–õ–ù–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ò[/]")
        await _execute_migration(migrate_type, source_ver, target_ver, backup)

async def _analyze_migration_changes(migrate_type: str, source_version: str, target_version: str):
    """–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏"""
    console.print("–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...")
    
    if migrate_type == "code":
        await _analyze_code_changes(source_version, target_version)
    elif migrate_type == "config":
        await _analyze_config_changes(source_version, target_version)
    elif migrate_type == "data":
        await _analyze_data_changes(source_version, target_version)
    else:
        console.print(f"[bold red]–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –º–∏–≥—Ä–∞—Ü–∏–∏: {migrate_type}[/]")

async def _analyze_code_changes(source_version: str, target_version: str):
    """–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ"""
    # –°–∏–º—É–ª—è—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞
    await asyncio.sleep(1)
    
    changes = {
        "files_to_migrate": 15,
        "api_changes": 3,
        "new_functions": 8,
        "removed_functions": 2,
        "import_changes": 12,
        "deprecated_calls": 5
    }
    
    console.print(f"üìä –§–∞–π–ª–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: {changes['files_to_migrate']}")
    console.print(f"üìä –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ API: {changes['api_changes']}")
    console.print(f"üìä –ù–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π: {changes['new_functions']}")
    console.print(f"üìä –£–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π: {changes['removed_functions']}")
    console.print(f"üìä –ò–∑–º–µ–Ω–µ–Ω–∏–π –∏–º–ø–æ—Ä—Ç–æ–≤: {changes['import_changes']}")
    console.print(f"üìä –£—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤—ã–∑–æ–≤–æ–≤: {changes['deprecated_calls']}")
    
    console.print("\n[bold green]‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω - –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏[/]")

async def _analyze_config_changes(source_version: str, target_version: str):
    """–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    await asyncio.sleep(1)
    
    changes = {
        "config_files": 3,
        "new_settings": 5,
        "deprecated_settings": 2,
        "changed_defaults": 1
    }
    
    console.print(f"üìä –§–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {changes['config_files']}")
    console.print(f"üìä –ù–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫: {changes['new_settings']}")
    console.print(f"üìä –£—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫: {changes['deprecated_settings']}")
    console.print(f"üìä –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {changes['changed_defaults']}")
    
    console.print("\n[bold green]‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏[/]")

async def _analyze_data_changes(source_version: str, target_version: str):
    """–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö"""
    await asyncio.sleep(1)
    
    changes = {
        "database_tables": 2,
        "new_columns": 3,
        "removed_columns": 1,
        "data_migrations": 1
    }
    
    console.print(f"üìä –¢–∞–±–ª–∏—Ü –ë–î: {changes['database_tables']}")
    console.print(f"üìä –ù–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫: {changes['new_columns']}")
    console.print(f"üìä –£–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫: {changes['removed_columns']}")
    console.print(f"üìä –ú–∏–≥—Ä–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö: {changes['data_migrations']}")
    
    console.print("\n[bold green]‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω - –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –º–∏–≥—Ä–∞—Ü–∏–∏[/]")

async def _execute_migration(migrate_type: str, source_version: str, target_version: str, backup: bool):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏"""
    if backup:
        console.print("üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...")
        await asyncio.sleep(1)
        console.print("‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞")
    
    console.print("üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏...")
    
    if migrate_type == "code":
        await _execute_code_migration(source_version, target_version)
    elif migrate_type == "config":
        await _execute_config_migration(source_version, target_version)
    elif migrate_type == "data":
        await _execute_data_migration(source_version, target_version)
    
    console.print("\n[bold green]‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞![/]")

async def _execute_code_migration(source_version: str, target_version: str):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞"""
    steps = [
        ("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤", 15),
        ("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ API", 8),
        ("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π", 5),
        ("–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π", 3)
    ]
    
    total_files = sum(count for _, count in steps)
    processed_files = 0
    
    for step_name, file_count in steps:
        console.print(f"üìù {step_name}...")
        await asyncio.sleep(0.5)
        processed_files += file_count
        console.print(f"‚úÖ {step_name}: {file_count} —Ñ–∞–π–ª–æ–≤")
    
    console.print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    console.print(f"   üìä –§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {total_files}")
    console.print(f"   üìä –ò–∑–º–µ–Ω–µ–Ω–∏–π: {total_files * 3}")  # –ü—Ä–∏–º–µ—Ä–Ω–æ 3 –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Ñ–∞–π–ª
    console.print(f"   üìä –û—à–∏–±–æ–∫: 0")

async def _execute_config_migration(source_version: str, target_version: str):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    steps = [
        ("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ core_settings.yaml", 1),
        ("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫", 5),
        ("–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫", 2),
        ("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", 1)
    ]
    
    for step_name, count in steps:
        console.print(f"‚öôÔ∏è {step_name}...")
        await asyncio.sleep(0.3)
        console.print(f"‚úÖ {step_name}: {count} –∏–∑–º–µ–Ω–µ–Ω–∏–π")

async def _execute_data_migration(source_version: str, target_version: str):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö"""
    steps = [
        ("–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü", 2),
        ("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫", 3),
        ("–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–æ–ª–æ–Ω–æ–∫", 1),
        ("–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö", 1)
    ]
    
    for step_name, count in steps:
        console.print(f"üóÑÔ∏è {step_name}...")
        await asyncio.sleep(0.4)
        console.print(f"‚úÖ {step_name}: {count} –æ–ø–µ—Ä–∞—Ü–∏–π")


if __name__ == "__main__":
    dev_app()



======================================================================

------------------------------ FILE: Systems/migration/script.py.mako ------------------------------
# alembic_migrations/script.py.mako
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op # type: ignore
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "    pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "    pass"}


======================================================================

------------------------------ FILE: Systems/migration/env.py ------------------------------
# alembic_migrations/env.py

import asyncio
from logging.config import fileConfig
import os
import sys
from pathlib import Path
import importlib
from typing import List, Optional

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π ---
ALEMBIC_DIR = Path(__file__).resolve().parent
SDB_PROJECT_ROOT = ALEMBIC_DIR.parent.parent
SDB_SYSTEMS_PATH = ALEMBIC_DIR.parent

if str(SDB_PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(SDB_PROJECT_ROOT))
    print(f"[Alembic Env] –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ SDB ({SDB_PROJECT_ROOT}) –¥–æ–±–∞–≤–ª–µ–Ω –≤ sys.path.")
else:
    sys.path.remove(str(SDB_PROJECT_ROOT))
    sys.path.insert(0, str(SDB_PROJECT_ROOT))
    print(f"[Alembic Env] –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ SDB ({SDB_PROJECT_ROOT}) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ sys.path.")

if str(SDB_SYSTEMS_PATH) not in sys.path:
    sys.path.insert(0, str(SDB_SYSTEMS_PATH))
    print(f"[Alembic Env] –ü—É—Ç—å Systems ({SDB_SYSTEMS_PATH}) –¥–æ–±–∞–≤–ª–µ–Ω –≤ sys.path.")


from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import create_async_engine, AsyncEngine

from alembic import context # type: ignore

try:
    from Systems.core.app_settings import settings as sdb_settings
    from Systems.core.database.base import SDBBaseModel
    from Systems.core.database.manager import DBManager
    from Systems.core.module_loader import ModuleLoader, ModuleInfo
    from Systems.core.services_provider import BotServicesProvider
    from Systems.core.database import core_models # noqa: F401
    print("[Alembic Env] –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.")
except ImportError as e_imp:
    print(f"[ALEMBIC ENV ERROR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ SDB: {e_imp}")
    print(f"–¢–µ–∫—É—â–∏–π sys.path –ø—Ä–∏ –æ—à–∏–±–∫–µ: {sys.path}")
    sys.exit(1)

target_metadata = SDBBaseModel.metadata

try:
    print("[Alembic Env] –ù–∞—á–∞–ª–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π...")
    temp_bsp_for_alembic = BotServicesProvider(settings=sdb_settings)
    module_loader_for_alembic = ModuleLoader(
        settings=sdb_settings,
        services_provider=temp_bsp_for_alembic # –ü–µ—Ä–µ–¥–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π BSP
    )
    module_loader_for_alembic.scan_all_available_modules()
    module_loader_for_alembic._load_enabled_plugin_names() # –ò—Å–ø–æ–ª—å–∑—É–µ–º _load_enabled_plugin_names

    # –î–ª—è Alembic –Ω–∞–º –Ω—É–∂–Ω—ã –º–æ–¥–µ–ª–∏ –≤—Å–µ—Ö –ê–ö–¢–ò–í–ù–´–• –ü–õ–ê–ì–ò–ù–û–í
    active_plugin_module_infos: List[ModuleInfo] = [
        info for name, info in module_loader_for_alembic.available_modules.items()
        # –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –∏—Å–ø–æ–ª—å–∑—É–µ–º enabled_plugin_names
        if not info.is_system_module and name in module_loader_for_alembic.enabled_plugin_names and info.manifest and info.path
    ]

    if active_plugin_module_infos:
        print(f"[Alembic Env] –ù–∞–π–¥–µ–Ω–æ {len(active_plugin_module_infos)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ–ª–µ–π.")
        for module_info in active_plugin_module_infos:
            print(f"[Alembic Env] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞: {module_info.name}")
            module_models_file = module_info.path / "models.py"
            module_models_pkg_init = module_info.path / "models" / "__init__.py"
            
            imported_this_module = False
            if module_models_file.is_file():
                # –î–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∏–º–ø–æ—Ä—Ç–∞ "Modules"
                import_target = f"Modules.{module_info.path.name}.models"
                print(f"[Alembic Env] –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞: {import_target}")
                try:
                    importlib.import_module(import_target)
                    print(f"[Alembic Env] > –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞: {import_target}")
                    imported_this_module = True
                except ImportError as e_imp_f:
                    print(f"[Alembic Env] > –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ {import_target}: {e_imp_f}")
                except Exception as e_f:
                    print(f"[Alembic Env] > –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ {import_target}: {type(e_f).__name__} - {e_f}")
            
            if not imported_this_module and module_models_pkg_init.is_file():
                import_target = f"Modules.{module_info.path.name}.models" 
                print(f"[Alembic Env] –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ –ø–∞–∫–µ—Ç–∞: {import_target}")
                try:
                    importlib.import_module(import_target)
                    print(f"[Alembic Env] > –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–∞–∫–µ—Ç –º–æ–¥–µ–ª–µ–π: {import_target}")
                except ImportError as e_imp_p:
                    print(f"[Alembic Env] > –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø–∞–∫–µ—Ç–∞ –º–æ–¥–µ–ª–µ–π {import_target}: {e_imp_p}")
                except Exception as e_p:
                    print(f"[Alembic Env] > –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø–∞–∫–µ—Ç–∞ –º–æ–¥–µ–ª–µ–π {import_target}: {type(e_p).__name__} - {e_p}")
            elif not imported_this_module and not module_models_file.is_file():
                 print(f"[Alembic Env] > –î–ª—è –ø–ª–∞–≥–∏–Ω–∞ '{module_info.name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ —Ñ–∞–π–ª models.py, –Ω–∏ –ø–∞–∫–µ—Ç models/__init__.py.")
    else:
        print("[Alembic Env] –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
    
    # –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤ Systems/core/sys_modules/ —Å –º–æ–¥–µ–ª—è–º–∏,
    # –∏ –æ–Ω–∏ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Systems.core.database.core_models),
    # –∏—Ö –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å —è–≤–Ω–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∏—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è.
    # –ü—Ä–∏–º–µ—Ä:
    # print("[Alembic Env] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞...")
    # sys_module_path = SDB_PROJECT_ROOT / "Systems" / "core" / "sys_modules" / "my_sys_module_with_models"
    # if (sys_module_path / "models.py").is_file():
    #    importlib.import_module("Systems.core.sys_modules.my_sys_module_with_models.models")
    #    print("[Alembic Env] –ú–æ–¥–µ–ª–∏ –∏–∑ 'my_sys_module_with_models' –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.")

    print(f"[Alembic Env] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü –≤ target_metadata: {len(target_metadata.tables)}")

except Exception as e_load_mod_env:
    print(f"[ALEMBIC ENV ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥–µ–ª–µ–π –º–æ–¥—É–ª–µ–π –≤ env.py: {e_load_mod_env}")
    import traceback
    traceback.print_exc()
    print("[ALEMBIC ENV WARNING] –ò–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤—ã—à–µ, Alembic –º–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å –º–æ–¥–µ–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∏–ª–∏ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π.")

config = context.config
try:
    temp_db_manager_for_url = DBManager(db_settings=sdb_settings.db, app_settings=sdb_settings)
    db_connection_url = temp_db_manager_for_url._build_db_url()
    config.set_main_option("sqlalchemy.url", db_connection_url)
    print(f"[Alembic Env] sqlalchemy.url —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SDB: {db_connection_url[:db_connection_url.find('://')+3]}...")
except Exception as e_db_url_env:
    print(f"[ALEMBIC ENV ERROR] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL –ë–î –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SDB: {e_db_url_env}")
    sys.exit(1)

if config.config_file_name is not None:
    fileConfig(config.config_file_name)

def _get_dialect_name_from_configured_context() -> Optional[str]:
    try:
        migration_context = context.get_context()
        if migration_context and migration_context.dialect:
            return migration_context.dialect.name.lower()
    except Exception: pass
    return None

def include_object(object, name, type_, reflected, compare_to):
    if type_ == "table" and object.metadata != target_metadata:
        return False
    return True

def compare_type(alem_context, inspected_column, metadata_column, inspected_type, metadata_type):
    dialect_name = _get_dialect_name_from_configured_context()
    if not dialect_name and alem_context.dialect:
        dialect_name = alem_context.dialect.name.lower()

    if dialect_name == 'sqlite':
        inspected_type_str = str(inspected_type).upper()
        metadata_type_str = str(metadata_type).upper()
        if metadata_type_str == 'BIGINTEGER' and inspected_type_str == 'INTEGER': return False
        if metadata_type_str == 'BOOLEAN' and inspected_type_str == 'INTEGER': return False
        if 'DATETIME' in metadata_type_str and 'TIMESTAMP' in inspected_type_str: return False
        if 'TIMESTAMP' in metadata_type_str and 'DATETIME' in inspected_type_str: return False
    elif dialect_name == 'mysql':
        if str(metadata_type).upper() == 'BOOLEAN' and str(inspected_type).upper() == 'TINYINT(1)': return False
    return None

def render_item(type_, obj, autogen_context):
    dialect_name = _get_dialect_name_from_configured_context()
    if not dialect_name and autogen_context.dialect:
         dialect_name = autogen_context.dialect.name.lower()
         
    if dialect_name == 'sqlite':
        if type_ == "table_comment" or type_ == "column_comment":
            return None 
    return False

def run_migrations_offline() -> None:
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=target_metadata, literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        include_object=include_object,
        compare_type=compare_type,
        compare_server_default=True,
        render_item=render_item
    )
    with context.begin_transaction():
        context.run_migrations()

def do_run_migrations(connection: Connection) -> None:
    context.configure(
        connection=connection, target_metadata=target_metadata,
        include_object=include_object,
        compare_type=compare_type,
        compare_server_default=True,
        render_item=render_item
    )
    with context.begin_transaction():
        context.run_migrations()

async def run_migrations_online() -> None:
    db_url_for_engine = config.get_main_option("sqlalchemy.url")
    if not db_url_for_engine:
        raise RuntimeError("sqlalchemy.url –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alembic –¥–ª—è online —Ä–µ–∂–∏–º–∞!")

    connectable_engine: AsyncEngine = create_async_engine(
        db_url_for_engine,
        poolclass=pool.NullPool,
    )
    
    async with connectable_engine.connect() as connection:
        await connection.run_sync(do_run_migrations)
    await connectable_engine.dispose()

if context.is_offline_mode():
    print("[Alembic Env] –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ offline —Ä–µ–∂–∏–º–µ...")
    run_migrations_offline()
else:
    print("[Alembic Env] –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ online —Ä–µ–∂–∏–º–µ...")
    asyncio.run(run_migrations_online())


======================================================================

------------------------------ FILE: Systems/migration/versions/d10040ec2cb7_initial_migration_for_core_tables.py ------------------------------
# alembic_migrations/script.py.mako
"""Initial migration for core tables

Revision ID: d10040ec2cb7
Revises: 
Create Date: 2025-06-14 08:36:19.434958

"""
from typing import Sequence, Union

from alembic import op # type: ignore
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'd10040ec2cb7'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('mod_example_table_one',
    sa.Column('name', sa.String(length=100), nullable=False, comment='–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è'),
    sa.Column('description', sa.String(length=255), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞'),
    sa.Column('is_active', sa.Boolean(), server_default='1', nullable=False),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_example_table_one'))
    )
    op.create_index(op.f('ix_mod_example_table_one_id'), 'mod_example_table_one', ['id'], unique=False)
    op.create_table('mod_example_user_notes',
    sa.Column('user_telegram_id', sa.BigInteger(), nullable=False, comment='Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–º–µ—Ç–∫–∏'),
    sa.Column('note_text', sa.Text(), nullable=False, comment='–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏'),
    sa.Column('is_done', sa.Boolean(), nullable=False, comment='–û—Ç–º–µ—á–µ–Ω–∞ –ª–∏ –∑–∞–º–µ—Ç–∫–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_example_user_notes'))
    )
    op.create_index(op.f('ix_mod_example_user_notes_id'), 'mod_example_user_notes', ['id'], unique=False)
    op.create_index(op.f('ix_mod_example_user_notes_user_telegram_id'), 'mod_example_user_notes', ['user_telegram_id'], unique=False)
    op.create_table('sdb_permissions',
    sa.Column('name', sa.String(length=100), nullable=False, comment="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'view_users', 'manage_modules')"),
    sa.Column('description', sa.Text(), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_permissions'))
    )
    op.create_index(op.f('ix_sdb_permissions_id'), 'sdb_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_permissions_name'), 'sdb_permissions', ['name'], unique=True)
    op.create_table('sdb_roles',
    sa.Column('name', sa.String(length=50), nullable=False, comment='–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–æ–ª–∏'),
    sa.Column('description', sa.Text(), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_roles'))
    )
    op.create_index(op.f('ix_sdb_roles_id'), 'sdb_roles', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_roles_name'), 'sdb_roles', ['name'], unique=True)
    op.create_table('sdb_users',
    sa.Column('username_lower', sa.String(length=32), nullable=True, comment='Telegram username –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è –ø–æ–∏—Å–∫–∞'),
    sa.Column('telegram_id', sa.BigInteger(), nullable=False, comment='–£–Ω–∏–∫–∞–ª—å–Ω—ã–π Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('username', sa.String(length=32), nullable=True, comment='Telegram username (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)'),
    sa.Column('first_name', sa.String(length=255), nullable=True, comment='–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('last_name', sa.String(length=255), nullable=True, comment='–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('preferred_language_code', sa.String(length=10), nullable=True, comment='–ö–æ–¥ —è–∑—ã–∫–∞ –±–æ—Ç–∞'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
    sa.Column('is_bot_blocked', sa.Boolean(), nullable=False, comment='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞'),
    sa.Column('last_activity_at', sa.DateTime(), nullable=True, comment='–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_users'))
    )
    op.create_index(op.f('ix_sdb_users_id'), 'sdb_users', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_users_telegram_id'), 'sdb_users', ['telegram_id'], unique=True)
    op.create_index(op.f('ix_sdb_users_username'), 'sdb_users', ['username'], unique=False)
    op.create_index(op.f('ix_sdb_users_username_lower'), 'sdb_users', ['username_lower'], unique=False)
    op.create_table('mod_another_example_table',
    sa.Column('example_one_id', sa.Integer(), nullable=True),
    sa.Column('value', sa.String(length=200), nullable=False, comment='–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['example_one_id'], ['mod_example_table_one.id'], name=op.f('fk_mod_another_example_table_example_one_id_mod_example_table_one'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_another_example_table'))
    )
    op.create_index(op.f('ix_mod_another_example_table_id'), 'mod_another_example_table', ['id'], unique=False)
    op.create_table('sdb_role_permissions',
    sa.Column('role_id', sa.Integer(), nullable=False, comment='ID —Ä–æ–ª–∏'),
    sa.Column('permission_id', sa.Integer(), nullable=False, comment='ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['sdb_permissions.id'], name=op.f('fk_sdb_role_permissions_permission_id_sdb_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['role_id'], ['sdb_roles.id'], name=op.f('fk_sdb_role_permissions_role_id_sdb_roles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_role_permissions')),
    sa.UniqueConstraint('role_id', 'permission_id', name='uq_sdb_role_permissions_role_id_permission_id')
    )
    op.create_index(op.f('ix_sdb_role_permissions_id'), 'sdb_role_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_role_permissions_permission_id'), 'sdb_role_permissions', ['permission_id'], unique=False)
    op.create_index(op.f('ix_sdb_role_permissions_role_id'), 'sdb_role_permissions', ['role_id'], unique=False)
    op.create_table('sdb_user_permissions',
    sa.Column('user_id', sa.Integer(), nullable=False, comment='ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('permission_id', sa.Integer(), nullable=False, comment='ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['sdb_permissions.id'], name=op.f('fk_sdb_user_permissions_permission_id_sdb_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['sdb_users.id'], name=op.f('fk_sdb_user_permissions_user_id_sdb_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_user_permissions')),
    sa.UniqueConstraint('user_id', 'permission_id', name='uq_sdb_user_permissions_user_id_permission_id')
    )
    op.create_index(op.f('ix_sdb_user_permissions_id'), 'sdb_user_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_user_permissions_permission_id'), 'sdb_user_permissions', ['permission_id'], unique=False)
    op.create_index(op.f('ix_sdb_user_permissions_user_id'), 'sdb_user_permissions', ['user_id'], unique=False)
    op.create_table('sdb_user_roles',
    sa.Column('user_id', sa.Integer(), nullable=False, comment='ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('role_id', sa.Integer(), nullable=False, comment='ID —Ä–æ–ª–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['role_id'], ['sdb_roles.id'], name=op.f('fk_sdb_user_roles_role_id_sdb_roles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['sdb_users.id'], name=op.f('fk_sdb_user_roles_user_id_sdb_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_user_roles')),
    sa.UniqueConstraint('user_id', 'role_id', name='uq_sdb_user_roles_user_id_role_id')
    )
    op.create_index(op.f('ix_sdb_user_roles_id'), 'sdb_user_roles', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_user_roles_role_id'), 'sdb_user_roles', ['role_id'], unique=False)
    op.create_index(op.f('ix_sdb_user_roles_user_id'), 'sdb_user_roles', ['user_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_sdb_user_roles_user_id'), table_name='sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_roles_role_id'), table_name='sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_roles_id'), table_name='sdb_user_roles')
    op.drop_table('sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_permissions_user_id'), table_name='sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_user_permissions_permission_id'), table_name='sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_user_permissions_id'), table_name='sdb_user_permissions')
    op.drop_table('sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_role_id'), table_name='sdb_role_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_permission_id'), table_name='sdb_role_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_id'), table_name='sdb_role_permissions')
    op.drop_table('sdb_role_permissions')
    op.drop_index(op.f('ix_mod_another_example_table_id'), table_name='mod_another_example_table')
    op.drop_table('mod_another_example_table')
    op.drop_index(op.f('ix_sdb_users_username_lower'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_username'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_telegram_id'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_id'), table_name='sdb_users')
    op.drop_table('sdb_users')
    op.drop_index(op.f('ix_sdb_roles_name'), table_name='sdb_roles')
    op.drop_index(op.f('ix_sdb_roles_id'), table_name='sdb_roles')
    op.drop_table('sdb_roles')
    op.drop_index(op.f('ix_sdb_permissions_name'), table_name='sdb_permissions')
    op.drop_index(op.f('ix_sdb_permissions_id'), table_name='sdb_permissions')
    op.drop_table('sdb_permissions')
    op.drop_index(op.f('ix_mod_example_user_notes_user_telegram_id'), table_name='mod_example_user_notes')
    op.drop_index(op.f('ix_mod_example_user_notes_id'), table_name='mod_example_user_notes')
    op.drop_table('mod_example_user_notes')
    op.drop_index(op.f('ix_mod_example_table_one_id'), table_name='mod_example_table_one')
    op.drop_table('mod_example_table_one')
    # ### end Alembic commands ###


======================================================================

------------------------------ FILE: Systems/migration/versions/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: Data/Config/enabled_modules.json ------------------------------
{
    "active_modules": [
        "universal_template",
        "ai_chat",
        "broadcast"
    ]
}


======================================================================

------------------------------ FILE: Data/Config/core_settings.yaml ------------------------------
cache:
  type: memory
  redis_url: redis://localhost:6379/0
module_repo:
  index_url: https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json
core:
  # project_data_path: /root/SwiftDevBot-Project/Data
  enabled_modules_config_path: Config/enabled_modules.json
  log_level: INFO
  log_to_file: true
  log_structured_dir: Logs
  log_rotation_size: 100 MB
  log_retention_period_structured: 3 months
  sdb_version: 0.1.0
  setup_bot_commands_on_startup: true
  enable_startup_shutdown_notifications: true
  i18n:
    # locales_dir: /root/SwiftDevBot-Project/Systems/locales
    domain: bot
    default_locale: ru
    available_locales:
    - ru
    - en
    - ua
# project_root: /root/SwiftDevBot-Project



======================================================================

------------------------------ FILE: Data/Config/modules_settings/broadcast.yaml ------------------------------
enabled: true



======================================================================

------------------------------ FILE: Data/Config/modules_settings/universal_template.yaml ------------------------------
enabled: true
max_items_per_user: 10
api_key: ''
debug_mode: false
notification_enabled: true
max_file_size: 10
default_priority: 50
auto_cleanup_days: 30
items_per_page: 5
show_timestamps: true
require_confirmation_for_delete: true
log_all_actions: true
cache_enabled: true
cache_ttl: 300
notify_on_create: true
notify_on_update: false
notify_on_delete: true
webhook_enabled: false
webhook_url: ''
webhook_secret: ''



======================================================================

------------------------------ FILE: Data/Config/modules_settings/ai_chat.yaml ------------------------------
provider: mock
api_key: ''



======================================================================

------------------------------ FILE: Data/Security/crypto_keys/.master_password ------------------------------
%"^4}4rC>Gnr


======================================================================

------------------------------ FILE: Data/Security/jwt_keys/jwt_public_key.pem ------------------------------
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtP5QF8C2JEzpCyGwFq9b
h+LSEF9C9QRm4pflSQoz9oNHPHxdQMxuhTLVVdxZCX6LKgd9rZDyZLI24gtBpYHd
I53KHAU0uFMdanNfE0w9WYb1I0D3dCRWrTHPQ2o1jvUgy4khYLoFBxMzGhKdppfJ
dKGR5WfJCjDgGziUEiRd8h/y1C1WDh7CFbL8H4vrRBbuamohcDM7K/g1G5jYL9k4
UTqxK2qQ9PWgfdKQLtFpAg883566sEAA6D6nHyx6LHq370gdjd9HVxsJp52Q8fnK
/YyEOPPJNhovdjouqiFSYoJuTdw99muyuvdqroWkDf/jDV6+0ZzZ0BKVFq1Ts4Gz
8wIDAQAB
-----END PUBLIC KEY-----



======================================================================

------------------------------ FILE: Data/Security/jwt_keys/jwt_secret.key ------------------------------
H1xf5-aBVkM8Grr3J25leXOTOBng55yZMQwGynXG90r7j3kRqtb1fSdNX6E5S4F_MFXhfbXDBQSl8NkBFTTZbw


======================================================================

------------------------------ FILE: Data/Security/jwt_keys/jwt_private_key.pem ------------------------------
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC0/lAXwLYkTOkL
IbAWr1uH4tIQX0L1BGbil+VJCjP2g0c8fF1AzG6FMtVV3FkJfosqB32tkPJksjbi
C0Glgd0jncocBTS4Ux1qc18TTD1ZhvUjQPd0JFatMc9DajWO9SDLiSFgugUHEzMa
Ep2ml8l0oZHlZ8kKMOAbOJQSJF3yH/LULVYOHsIVsvwfi+tEFu5qaiFwMzsr+DUb
mNgv2ThROrErapD09aB90pAu0WkCDzzfnrqwQADoPqcfLHoserfvSB2N30dXGwmn
nZDx+cr9jIQ488k2Gi92Oi6qIVJigm5N3D32a7K692quhaQN/+MNXr7RnNnQEpUW
rVOzgbPzAgMBAAECggEAKxTDnLvGvyI9cGRe5S9tUo13YeVC605WbQYp0fZnQvyh
hrC1g7iFcBgW9p6B5QQlfOYWkKtJPxW6gZibUhl0uUcUNhI5J8zE2jNHBLFngvlg
PTl4DUGfDg+mnY3Y3MPVQA1OkBcHHlWAGusmcmJ71dKlhxzqmg3jMieH+z+Dyx9P
xeXU67gbNSxhWIiDI3Ch9jYH5GzWn1MyoTLJKyV4EqkpwDn70i8Y8kXGJ3kvDv5l
K2PQLh5yf4gFHh9ElOpWe5If/jVp4R7T9o0gvADWQVdLKkxoY0x2bOg7DZCnCXhw
U/dDInqqM15JssrUC3XSkUpmPdyy4IuhQx0aUjEsdQKBgQDr+4O7ZzPD7D9jHwty
/1PEgNttdQEjpqjWrhrJBMw/SVZoCuIeArPvp0y7ofTrF/feEe6Mb7yN3zREE75x
E9yh4mJQRGR8hnwdrJz5j7JUyL1thaPzEh2pi9/dDv7RBN3Dq/qEzG9+P6YGsyMs
TEcMjiKx67ojdv8JRWR7DsM9ZQKBgQDEWK5qWrB9VSsefzQfv+eIGKxD7/Vtu2tZ
mK/eP61A15+ujCrfuws6vWs6xvMt4mMerHTnXeL9stWdlnjYze7xmGdpyHF2FeMl
9Bu4zWQipdqTfIxCB6W/VsKHJC2IHed2M5M+ywTuvlkT8f0w+wGLnvch/WDsd3oq
ey3s6gnidwKBgDWhLWjzpVILaMRwE7wIxtLLrhKMGrwtbgWL/85bZsejNR3kC0ti
td3rGYcy4WRkSBKR5LLJ2gIsDcbC7e7o4qVvu4QeZu/d6GseBXa5739RN6uiSYY+
Qbt8bF3iwIpkHroPZZm0lEoO0P6Iy5+Pnj3+N2hT+DODIabLvHAzBK/5AoGAArt5
MeGxMw1MXFBI2WhCQJKXUxqzv6MsC0Mkr2MTdiOKBVPOBO8FaPvZ0ieSmsDbwEGG
HvIfhohGkLrXU60J9jK4vbAcZBhJ4O1UtW2mRxUnxYWmLgUNOWxrqJXITGyeG/b7
xZPtraTYeH6Vl2jmzJqZtc9g2emPuaedK/7VxGECgYEAsLYBt244ZrUNYJ4B50aO
NFPYzmEvlUOisargyeNEhzVr0GN0V5ayVGabq3yUhkncmfYQHkVvTTm1ZszxB4Nr
bsny8O0WGL5Y0SSr4xamrLtLqL25laGW3h171v7zyN8T2WzHu5A1pbrw3X66ni8L
2O8ilfOuvZ+SJpEn/XMbSzY=
-----END PRIVATE KEY-----



======================================================================

------------------------------ FILE: Data/Security/audit_logs/audit_2025-11-20.jsonl ------------------------------
{"event_id": "AUDIT_1763654940905_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763654940.905298, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}
{"event_id": "AUDIT_1763655828393_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763655828.393916, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}
{"event_id": "AUDIT_1763656183729_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763656183.729551, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}
{"event_id": "AUDIT_1763665100672_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763665100.672726, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}
{"event_id": "AUDIT_1763665332651_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763665332.65138, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}
{"event_id": "AUDIT_1763665963859_0", "event_type": "module_load", "module_name": "universal_template", "user_id": null, "timestamp": 1763665963.859078, "severity": "medium", "details": {"version": "1.0.0", "display_name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –®–∞–±–ª–æ–Ω –ú–æ–¥—É–ª—è", "settings": {"enabled": true, "max_items_per_user": 10, "api_key": "", "debug_mode": false, "notification_enabled": true, "max_file_size": 10}}, "ip_address": null, "user_agent": null, "success": true, "error_message": null}



======================================================================

------------------------------ FILE: Data/Security/trusted_keys/trusted_signers.json ------------------------------
{
  "sdb_core_team": {
    "name": "SDB Core Team",
    "email": "core@sdb.dev",
    "key_id": "SDB-CORE-2024",
    "reputation": "trusted",
    "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ SDB"
  }
}


======================================================================
